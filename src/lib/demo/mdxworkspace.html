<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDxWorkspace Demos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- Global Layout --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        nav {
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }
        nav button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #fff;
        }
        nav button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .demo-container {
            flex-grow: 1;
            display: none; /* Hide by default */
            min-height: 0;
        }
        .demo-container.active {
            display: flex; /* Show active demo */
        }
        
    /* [æ–°å¢] ä¸ºç¼–è¾‘å™¨åŒºåŸŸæ·»åŠ æ ·å¼ï¼Œä½¿å…¶å¡«æ»¡å‰©ä½™ç©ºé—´ */
    .editor-area {
        flex-grow: 1; /* å…³é”®ï¼šå æ®æ‰€æœ‰å‰©ä½™çš„å®½åº¦ */
        display: flex;
        flex-direction: column; /* ä½¿å…¶å†…éƒ¨å…ƒç´ ï¼ˆå¦‚æ ‡é¢˜æ å’Œç¼–è¾‘å™¨ï¼‰å‚ç›´æ’åˆ— */
        min-width: 0; /* é˜²æ­¢å­å…ƒç´ æº¢å‡ºæ—¶ç ´åå¸ƒå±€ */
    }
        /* --- Common Component Styles --- */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
            border-right: 1px solid #e0e0e0;
            background: #fdfdfd;
            padding: 10px;
            overflow-y: auto;
        }
        .mock-editor, .mock-session-ui {
            padding: 15px;
            box-sizing: border-box;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            color: #666;
            height: 100%;
        }

        /* --- Demo 1: Basic Layout --- */
        #demo1-container .main-content {
            flex-grow: 1;
        }

        /* --- Demo 2: Title Bar Layout --- */
        #demo2-container .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #demo2-container .title-bar {
            height: 50px;
            flex-shrink: 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            background-color: #fff;
        }
        #demo2-container .editor-wrapper {
             flex-grow: 1;
        }
        
        /* --- Demo 3 Specific --- */
        #demo3-container .custom-toolbar { height: 40px; flex-shrink: 0; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 10px; gap: 5px; background-color: #f9f9f9; }
        #demo3-container .custom-toolbar button { width: 30px; height: 30px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; }
        #demo3-container #demo3-editor { flex-grow: 1; }
    </style>
</head>
<body>

    <div id="app">
        <nav>
            <button data-demo="1" class="active">Demo 1: Cloze å­¦ä¹ æ¨¡å¼</button>
            <button data-demo="2">Demo 2: å¤–éƒ¨æ ‡é¢˜æ  & è‡ªå®šä¹‰ä¾§è¾¹æ </button>
            <button data-demo="3">Demo 3: è‡ªå®šä¹‰å·¥å…·æ  & å‘½ä»¤</button>
        </nav>
        
        <!-- Demo 1: Basic Layout -->
        <div id="demo1-container" class="demo-container active">
            <div id="demo1-sidebar" class="sidebar"></div>
            <div id="demo1-editor" class="editor-area"></div>
        </div>
        
        <!-- Demo 2: Title Bar Layout -->
        <div id="demo2-container" class="demo-container">
            <div id="demo2-sidebar" class="sidebar"></div>
            <div class="editor-area">
                <div class="title-bar">
                    <h3 id="session-title-display">è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯</h3>
                </div>
                <div id="demo2-editor"></div>
            </div>
        </div>

        <!-- Demo 3: Custom Toolbar Layout -->
        <div id="demo3-container" class="demo-container">
            <div id="demo3-sidebar" class="sidebar"></div>
            <div class="editor-area">
                <div class="custom-toolbar">
                    <button id="custom-bold-btn" title="åŠ ç²— (applyBold)"><i class="fas fa-bold"></i></button>
                    <button id="custom-strikethrough-btn" title="åˆ é™¤çº¿ (applyStrikethrough)"><i class="fas fa-strikethrough"></i></button>
                    <button id="custom-cloze-btn" title="æŒ–ç©º (applyCloze)">[-]</button>
                    <button id="custom-save-btn" title="æ‰‹åŠ¨ä¿å­˜ (save)"><i class="fas fa-save"></i></button>
                </div>
                <div id="demo3-editor"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Container -->
    <div id="mdx-modal-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/immer/dist/immer.umd.production.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.immer) { window.immer.enableMapSet(); }
    });
    </script>

    <script type="module" src="mdxworkspace.js"></script>
    import { MDxWorkspace } from '../workspace/mdx/MDxWorkspace.js';
    import {IndexedDBAdapter} from './demo-indexdbadapter.js';

    let currentWorkspace = null;

    // =========================================================================
    // === [UPDATED] DEMO INITIALIZERS (using new API)
    // =========================================================================

    // [æ–°å¢] Demo 1 çš„ç¤ºä¾‹æ–‡æœ¬ï¼Œç”¨äºå±•ç¤º Cloze åŠŸèƒ½
    const demo1InitialText = `
# Cloze å­¦ä¹ æ¨¡å¼æ¼”ç¤º

æ¬¢è¿æ¥åˆ° MDxWorkspace çš„å­¦ä¹ æ¨¡å¼ï¼æ­¤æ¨¡å¼å·²å¼€å¯ **clozeControl** é€‰é¡¹ã€‚

## å¦‚ä½•ä½¿ç”¨

1.  **ç‚¹å‡»**ä¸‹é¢ --[c1]é¢œè‰²ä¸åŒ-- çš„å¡ç‰‡æ¥æŸ¥çœ‹ç­”æ¡ˆã€‚
2.  ç­”æ¡ˆä¸‹æ–¹ä¼šå‡ºç° **â€œé‡æ¥ã€å›°éš¾ã€è‰¯å¥½ã€ç®€å•â€** æŒ‰é’®ã€‚
3.  æ ¹æ®ä½ çš„è®°å¿†æƒ…å†µé€‰æ‹©ä¸€ä¸ªï¼Œå¡ç‰‡ä¼šè‡ªåŠ¨å…³é—­å¹¶å®‰æ’ä¸‹æ¬¡å¤ä¹ ã€‚
4.  å¦‚æœä½ åœ¨5åˆ†é’Ÿå†…æ²¡æœ‰é€‰æ‹©ï¼Œç³»ç»Ÿä¼šé»˜è®¤æŒ‰ **â€œè‰¯å¥½â€** å¤„ç†ã€‚
5.  å³ä¸‹è§’çš„ **æµ®åŠ¨æŒ‰é’®** å¯ä»¥å¸®ä½ å¿«é€Ÿå±•å¼€/æŠ˜å æ‰€æœ‰å¡ç‰‡ï¼Œæˆ–åœ¨å…³é—­çš„å¡ç‰‡é—´è·³è½¬ã€‚

---

## ç¤ºä¾‹å¡ç‰‡

- è¿™æ˜¯ä¸€ä¸ª --[c2]æ–°åˆ›å»º-- çš„å¡ç‰‡ï¼Œå®ƒçš„ä¸‹åˆ’çº¿æ˜¯è“è‰²çš„ã€‚
- æ³•å›½çš„é¦–éƒ½æ˜¯ --[c3]å·´é»--ã€‚
- è¿™æ˜¯ä¸€å¼ å·²ç»**æˆç†Ÿ**çš„å¡ç‰‡ï¼šå¤ªé˜³ä» --[c4]ä¸œæ–¹-- å‡èµ·ã€‚ä½ ä¼šå‘ç°å®ƒé»˜è®¤å°±æ˜¯æ‰“å¼€çš„ï¼Œå¹¶ä¸”æœ‰è™šçº¿åº•åˆ’çº¿ã€‚
- **åŒå‡»**ä¸Šé¢é‚£å¼ æˆç†Ÿçš„å¡ç‰‡ï¼Œå¯ä»¥**é‡ç½®**å®ƒçš„å­¦ä¹ è¿›åº¦ã€‚

---

## æåŠåŠŸèƒ½

æåŠåŠŸèƒ½ (@mention) åœ¨æ¸²æŸ“æ¨¡å¼ä¸‹åŒæ ·å¯ç”¨ï¼š
- æåŠç”¨æˆ·ï¼š@John Doe
- æåŠæ–‡ä»¶ï¼š@[ç¤ºä¾‹æ–‡ä»¶](mdx://file/some-file-id)
`;
        
    function initDemo1() {
        console.log("Initializing Demo 1: Cloze Learning Mode");
        const workspace = new MDxWorkspace({
            sidebarContainer: document.getElementById('demo1-sidebar'),
            editorContainer: document.getElementById('demo1-editor'),
            
            // --- [REFACTORED] Renamed 'persistence' to 'storage' ---
            storage: {
                namespace: 'demo1-cloze-learning-data' // Unique ID for this demo's data
            },
            
            // [æ–°æ¥å£] ä½¿ç”¨ editor å¯¹è±¡æ¥é…ç½®ç¼–è¾‘å™¨
            editor: {
                // --- æ ¸å¿ƒæ”¹åŠ¨ ---
                clozeControl: true, // 1. å¯ç”¨å†…ç½®çš„ Cloze å­¦ä¹ ç³»ç»Ÿ
                initialText: demo1InitialText, // 2. è®¾ç½®åŒ…å« Cloze çš„åˆå§‹æ–‡æœ¬
                // ---

                mentionProviders: [
                    // é»˜è®¤çš„ Provider ä¼šè‡ªåŠ¨åŠ è½½, è¿™é‡Œæˆ‘ä»¬åªæ·»åŠ è‡ªå®šä¹‰çš„
                    (dependencies) => {
                        return {
                            key: 'user',
                            triggerChar: '@',
                            async getSuggestions(query) {
                                const users = [
                                    { id: 'john', name: 'John Doe' },
                                    { id: 'jane', name: 'Jane Smith' }
                                ];
                                return users
                                    .filter(u => u.name.toLowerCase().includes(query.toLowerCase()))
                                    .map(u => ({ id: u.id, label: `ğŸ§‘ ${u.name}` }));
                            }
                        };
                    }
                ]
            }
        });
        
        workspace.on('ready', () => console.log('Demo 1 Ready!'));
        workspace.start();
        return workspace;
    }
        
    function initDemo2() {
        console.log("Initializing Demo 2: External title bar & custom sidebar");
        const workspace = new MDxWorkspace({
            sidebarContainer: document.getElementById('demo2-sidebar'),
            editorContainer: document.getElementById('demo2-editor'),
            
            // --- [REFACTORED] Renamed 'persistence' to 'storage' ---
            storage: {
                namespace: 'demo2-data-indexeddb',
                adapter: new IndexedDBAdapter({ dbName: 'MDxWorkspaceDemoDB' })
            },
            
            // [æ–°æ¥å£] é…ç½® sidebar
            sidebar: {
                title: 'æˆ‘çš„çŸ¥è¯†åº“',
                contextMenu: {
                    items: (item, defaultItems) => {
                        // æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰èœå•é¡¹
                        const customAction = { id: 'alert-id', label: 'æ˜¾ç¤ºID', iconHTML: '<i class="fas fa-info-circle"></i>' };
                        return [customAction, { type: 'separator' }, ...defaultItems];
                    }
                }
            },

            editor: {
                // éšè—ç¼–è¾‘å™¨å†…ç½®çš„æ ‡é¢˜æ ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤–éƒ¨æœ‰ä¸€ä¸ª
                titleBar: {
                    title: null, // è®¾ä¸ºnullæˆ–''æ¥éšè—
                    toggleSidebarCallback: null,
                    enableToggleEditMode: false
                }
            }
        });

        const titleDisplay = document.getElementById('session-title-display');
        
        workspace.on('sessionSelect', ({ item }) => {
            titleDisplay.textContent = item ? item.metadata.title : 'æ— æ´»åŠ¨ä¼šè¯';
        });

        // [ä¿®æ”¹ & è§£å†³æ–¹æ¡ˆ]
        // ç›´æ¥åœ¨ workspace å®ä¾‹ä¸Šç›‘å¬æ–°çš„ menuItemClicked äº‹ä»¶ã€‚
        // è¿™ç§æ–¹å¼æ›´å®‰å…¨ã€æ›´ç®€æ´ï¼Œæ— éœ€å…³å¿ƒå†…éƒ¨ sessionManager çš„åˆå§‹åŒ–æ—¶æœºã€‚
        workspace.on('menuItemClicked', ({ actionId, item }) => {
            if (actionId === 'alert-id') {
                alert(`é¡¹ç›® "${item.metadata.title}" çš„ ID æ˜¯: ${item.id}`);
            }
        });
        
        workspace.start();
        return workspace;
    }

    function initDemo3() {
        console.log("Initializing Demo 3: Custom toolbar & manual save");
        const workspace = new MDxWorkspace({
            sidebarContainer: document.getElementById('demo3-sidebar'),
            editorContainer: document.getElementById('demo3-editor'),
            
            // --- [REFACTORED] Renamed 'persistence' to 'storage' ---
            storage: {
                namespace: 'demo3-data'
            },
            
            editor: {
                // ç¦ç”¨å†…ç½®å·¥å…·æ 
                showToolbar: false,
                // ç¦ç”¨å†…ç½®çš„ä¿å­˜æŒ‰é’®ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„
                showSaveButton: false 
            }
        });

        workspace.on('ready', () => {
            console.log("Demo 3 workspace is ready. Attaching command buttons.");
            console.log("Available commands:", workspace.commands);
            
            document.getElementById('custom-bold-btn').onclick = () => workspace.commands.applyBold();
            document.getElementById('custom-strikethrough-btn').onclick = () => workspace.commands.applyStrikethrough();
            document.getElementById('custom-cloze-btn').onclick = () => workspace.commands.applyCloze();
            
            // [ä¿®æ”¹ & è§£å†³æ–¹æ¡ˆ]
            // é€šè¿‡æ£€æŸ¥ save() æ–¹æ³•çš„è¿”å›å€¼æ¥å¤„ç†ä¸åŒæƒ…å†µï¼Œä½¿ä»£ç æ›´å¥å£®ã€‚
            document.getElementById('custom-save-btn').onclick = async () => {
                console.log("æ‰‹åŠ¨ä¿å­˜ä¸­...");
                const savedItem = await workspace.save();
                
                if (savedItem) {
                    console.log(`ä¿å­˜å®Œæˆ! Session: "${savedItem.title}"`);
                    alert('ä¿å­˜æˆåŠŸ!');
                } else {
                    console.log("æ²¡æœ‰æ´»åŠ¨ä¼šè¯å¯ä¾›ä¿å­˜ã€‚");
                    alert('æ²¡æœ‰éœ€è¦ä¿å­˜çš„å†…å®¹ã€‚');
                }
            };
        });

        // è¿™ä¸ªäº‹ä»¶ç›‘å¬å™¨ç°åœ¨æ›´å¯é ï¼Œå› ä¸ºå®ƒåªä¼šåœ¨çœŸæ­£æœ‰ session è¢«ä¿å­˜æ—¶è§¦å‘ã€‚
        workspace.on('saved', ({ savedItem }) => {
            // ä»ç„¶å¯ä»¥ä¿ç•™è¿™é‡Œçš„é˜²å¾¡æ€§æ£€æŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚
            if (savedItem) {
                console.log(`å†…å®¹å·²æ‰‹åŠ¨ä¿å­˜åˆ°ä¼šè¯: "${savedItem.title}"`);
            }
        });
        
        workspace.start();
        return workspace;
    }

        const demoInitializers = {
            '1': initDemo1,
            '2': initDemo2,
            '3': initDemo3,
        };
        
        // --- Navigation Logic ---
        const navButtons = document.querySelectorAll('nav button');
        const demoContainers = document.querySelectorAll('.demo-container');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const demoId = button.dataset.demo;
                
                // Clean up previous workspace
                if (currentWorkspace) {
                    currentWorkspace.destroy();
                currentWorkspace = null;
                }

                // Update UI
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                demoContainers.forEach(container => container.classList.remove('active'));
                document.getElementById(`demo${demoId}-container`).classList.add('active');
                
                // Initialize new workspace
                currentWorkspace = demoInitializers[demoId]();
            });
        });

        // Initialize the first demo on page load
        currentWorkspace = initDemo1();

    </script>
</body>
</html>