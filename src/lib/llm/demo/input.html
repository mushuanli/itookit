<!-- ... @llm-kit/demo/input-ui.html ... -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>LLM Fusion Kit - Playground</title>
    <style>
        :root {
            --primary-color: #007bff;
            --border-color: #dee2e6;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --error-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #app { display: flex; width: 100%; height: 100%; }
        .sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar h1 { text-align: center; color: var(--primary-color); margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        .scrollable-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;}
        .message { display: flex; flex-direction: column; margin-bottom: 15px; padding: 10px 15px; border-radius: 8px; max-width: 85%; word-wrap: break-word; }
        .message.user { background-color: var(--primary-color); color: white; align-self: flex-end; }
        .message.assistant { background-color: #fff; border: 1px solid var(--border-color); align-self: flex-start; }
        .message strong { display: block; margin-bottom: 5px; }
        .message img { max-width: 200px; border-radius: 4px; margin-top: 10px; }
        .message div p { margin: 0 0 10px; }
        .message div p:last-child { margin-bottom: 0; }
        .message div pre { background-color: #f1f1f1; padding: 10px; border-radius: 5px; white-space: pre-wrap; overflow-x: auto; }
        .input-area-container { padding: 10px; border-top: 1px solid var(--border-color); background: #fff; flex-shrink: 0; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); background-color: #fff; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; position: relative; color: #666; }
        .tab-button.active { font-weight: 600; color: var(--primary-color); }
        .tab-button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); }
        .tab-content { display: none; flex-grow: 1; min-height: 0; }
        .tab-content.active { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .message.thinking { background-color: #f0f0f0; color: #555; border-left: 3px solid #b0b0b0; font-style: italic; opacity: 0.9; }
        .message.thinking strong::before { content: 'ðŸ§  '; margin-right: 5px; }
        .demo-area { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .demo-area button { padding: 8px 12px; border: 1px solid var(--border-color); background-color: #fff; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .event-log { margin-top: 20px; background-color: #2d2d2d; color: #ccc; padding: 15px; border-radius: 8px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; }
        .event-log div { border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .event-log .event-name { color: #87ceeb; font-weight: bold; }
        .event-log .event-payload { color: #98fb98; }
    </style>
</head>
<body>

    <div id="app">
        <div class="sidebar">
            <h1>LLM Fusion Kit</h1>
            <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: -10px; margin-bottom: 20px;">Live Playground</p>
            
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider">
                    <option value="deepseek" selected>DeepSeek</option>
                    <option value="openai">OpenAI</option>
                    <option value="gemini">Google Gemini</option>
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your API Key here">
            </div>
            <div class="form-group">
                <label for="model">Model</label>
                <input type="text" id="model" value="deepseek-chat">
            </div>
            <div class="form-group">
                <label for="temperature">Temperature</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-button active" data-tab="basic-chat">Basic Chat</button>
                <button class="tab-button" data-tab="theming">Theming & Customization</button>
                <button class="tab-button" data-tab="events">Events & Commands</button>
            </div>

            <!-- TAB CONTENT: BASIC CHAT -->
            <div id="tab-basic-chat" class="tab-content active">
                <div id="conversation" class="scrollable-area"></div>
                <div id="chat-input-container" class="input-area-container"></div>
            </div>

            <!-- TAB CONTENT: THEMING & CUSTOMIZATION -->
            <div id="tab-theming" class="tab-content">
                <div class="demo-area">
                    <h2>Theming & Customization Demo</h2>
                    <p>Use the controls below to dynamically change the theme of the input UI.</p>
                    <div class="form-group">
                        <label for="theme-primary-color">Primary Color</label>
                        <input type="color" id="theme-primary-color" value="#007bff">
                    </div>
                    <div class="form-group">
                        <label for="theme-border-radius">Border Radius (px)</label>
                        <input type="range" id="theme-border-radius" min="0" max="24" value="12">
                    </div>
                    <div class="form-group">
                        <label for="theme-font-family">Font Family</label>
                        <select id="theme-font-family">
                            <option value="inherit">System Default</option>
                            <option value="monospace">Monospace</option>
                            <option value="cursive">Cursive</option>
                        </select>
                    </div>
                    <button id="apply-theme-btn">Apply Theme</button>
                    <button id="reset-theme-btn">Reset Theme</button>
                </div>
                <div id="theming-input-container" class="input-area-container"></div>
            </div>

             <!-- TAB CONTENT: EVENTS & COMMANDS -->
             <div id="tab-events" class="tab-content">
                <div class="demo-area">
                    <h2>Events & Commands Demo</h2>
                    <p>Interact with the input UI below and see the events firing in the log. Try the custom command <code>/time</code>.</p>
                     <div id="event-log-container">
                        <strong>Event Log:</strong>
                        <div id="event-log" class="event-log"></div>
                    </div>
                </div>
                <div id="events-input-container" class="input-area-container"></div>
            </div>
        </div>
    </div>

    <script type="module">
    // --- 1. æ ¸å¿ƒæž¶æž„å¯¼å…¥ ---
    // å¯¼å…¥æ•´ä¸ªåº”ç”¨æž¶æž„çš„æ ¸å¿ƒæ¨¡å—
    import { ConfigManager } from '../../config/ConfigManager.js';
    import { LLMService } from '../core/LLMService.js';
    import { LLMInputUI } from '../input/index.js';
    import { defaultOptions } from '../input/defaults.js';
    // å¯¼å…¥ç”¨äºŽæ¼”ç¤ºçš„APIå¯†é’¥
    import { API_KEY as DEEPSEEK_API_KEY } from '../../demo/config.js';

    // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å­˜åœ¨
    if (!DEEPSEEK_API_KEY || DEEPSEEK_API_KEY.includes('YOUR_')) {
        alert('è¯·åœ¨ demo/config.js æ–‡ä»¶ä¸­æ·»åŠ æ‚¨çš„APIå¯†é’¥ä»¥è¿è¡Œæ­¤æ¼”ç¤ºã€‚');
        throw new Error("æœªé…ç½®APIå¯†é’¥ã€‚");
    }

    // --- 2. åˆå§‹åŒ–æ ¸å¿ƒæœåŠ¡ ---
    // è¿™æ˜¯åº”ç”¨å¯åŠ¨æ—¶åº”è¯¥åšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œç¡®ä¿ConfigManagerå’ŒLLMServiceä½œä¸ºå•ä¾‹è¢«åˆ›å»ºã€‚
    const configManager = ConfigManager.getInstance({
        adapterOptions: { prefix: 'llm_kit_demo_final_' }
    });
    const llmService = LLMService.getInstance();

    // --- 3. ç­‰å¾…åº”ç”¨å°±ç»ªåŽæ‰§è¡Œä¸»é€»è¾‘ ---
    // æˆ‘ä»¬è®¢é˜…'app:ready'äº‹ä»¶ï¼Œä»¥ç¡®ä¿åœ¨ConfigManagerå®Œæˆå…¶å¼‚æ­¥å¼•å¯¼ï¼ˆä¾‹å¦‚ä»ŽlocalStorageåŠ è½½æ•°æ®ï¼‰ä¹‹åŽï¼Œ
    // æ‰å¼€å§‹æ‰§è¡Œä¸Žæ•°æ®ç›¸å…³çš„åº”ç”¨é€»è¾‘ã€‚
    configManager.eventManager.subscribe('app:ready', main);

    async function main() {
        console.log("åº”ç”¨é…ç½®å·²å°±ç»ªï¼Œå¼€å§‹åˆå§‹åŒ–DEMO...");
        
        // --- 4. åŠ¨æ€è®¾ç½®å’Œç®¡ç†é…ç½® ---
        // åœ¨çœŸå®žåº”ç”¨ä¸­ï¼Œè¿™äº›æ•°æ®å¯èƒ½ç”±ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢è¾“å…¥ï¼Œå¹¶è¢«æŒä¹…åŒ–ã€‚
        const sidebar = {
            provider: document.getElementById('provider'),
            apiKey: document.getElementById('apiKey'),
            temperature: document.getElementById('temperature'),
        };
        sidebar.apiKey.value = DEEPSEEK_API_KEY; // è®¾ç½®é»˜è®¤å¯†é’¥

        // é¢„å®šä¹‰ä¸€äº› Agentã€‚è¿™æ˜¯æˆ‘ä»¬åº”ç”¨â€œçŸ¥è¯†â€çš„ä¸€éƒ¨åˆ†ã€‚
        const AGENT_DEFINITIONS = [
            {
                id: 'creative-writer', name: 'Creative Writer', icon: 'âœï¸',
                description: 'æ“…é•¿æ’°å†™æ•…äº‹å’Œåˆ›æ„å†…å®¹ã€‚',
                config: { connectionId: 'conn-deepseek', modelName: 'deepseek-chat', temperature: 0.8 }
            },
            {
                id: 'code-assistant', name: 'Code Assistant', icon: 'ðŸ‘¨â€ðŸ’»',
                description: 'å¸®åŠ©è§£ç­”ç¼–ç¨‹é—®é¢˜å’Œç”Ÿæˆä»£ç ã€‚',
                config: { connectionId: 'conn-deepseek', modelName: 'deepseek-coder', systemPrompt: "ä½ æ˜¯ä¸€ä½ä¸“å®¶çº§ç¨‹åºå‘˜ã€‚é™¤éžè¢«è¦æ±‚è§£é‡Šï¼Œå¦åˆ™åªæä¾›ä»£ç ã€‚" }
            },
            {
                id: 'general-chat', name: 'General Chat', icon: 'ðŸ’¬',
                description: 'ä¸€ä¸ªå¯ä»¥å›žç­”ä»»ä½•é—®é¢˜çš„é€šç”¨åŠ©æ‰‹ã€‚',
                config: { connectionId: 'conn-deepseek', modelName: 'deepseek-chat', temperature: 0.7 }
            }
        ];
        
        // å°† Agent å®šä¹‰åŠ è½½åˆ°é…ç½®ä¸­å¿ƒçš„ LLMRepository ä¸­
        for (const agent of AGENT_DEFINITIONS) {
            try { await configManager.llm.addAgent(agent); } catch (e) { /* å¦‚æžœå·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ */ }
        }

        // æ ¸å¿ƒå‡½æ•°ï¼šæ ¹æ®ä¾§è¾¹æ è¾“å…¥æ›´æ–°/åˆ›å»ºè¿žæŽ¥é…ç½®
        async function updateConnection() {
            const provider = sidebar.provider.value;
            const apiKey = sidebar.apiKey.value;
            if (!apiKey) {
                alert('APIå¯†é’¥æ˜¯å¿…éœ€çš„ï¼');
                return false;
            }
            
            const connection = {
                id: `conn-${provider}`, // ä¸ºæ¯ä¸ªæä¾›å•†åˆ›å»ºä¸€ä¸ªç¨³å®šçš„ID
                name: `${provider.charAt(0).toUpperCase() + provider.slice(1)} Connection`,
                provider: provider,
                apiKey: apiKey,
            };

            try {
                // å°è¯•æ›´æ–°è¿žæŽ¥ã€‚å¦‚æžœä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼Œæˆ‘ä»¬åœ¨catchå—ä¸­å¤„ç†ã€‚
                await configManager.llm.updateConnection(connection.id, connection);
            } catch (error) {
                // å¦‚æžœæ›´æ–°å¤±è´¥ï¼Œè¯´æ˜Žå®ƒå¯èƒ½ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ å®ƒã€‚
                await configManager.llm.addConnection(connection);
            }

            // æ›´æ–°æ‰€æœ‰ Agent å®šä¹‰ï¼Œä½¿å…¶ä½¿ç”¨å½“å‰é€‰æ‹©çš„æä¾›å•†è¿žæŽ¥
            for (const agent of AGENT_DEFINITIONS) {
                agent.config.connectionId = connection.id;
                await configManager.llm.updateAgent(agent.id, agent);
            }

            // å…³é”®ä¸€æ­¥ï¼šæ¸…é™¤LLMServiceçš„ç¼“å­˜ã€‚è¿™ä¼šå¼ºåˆ¶å®ƒåœ¨ä¸‹æ¬¡è¯·æ±‚å®¢æˆ·ç«¯æ—¶ï¼Œ
            // ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ›´æ–°çš„é…ç½®æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯å®žä¾‹ã€‚
            llmService.clearCache();
            console.log(`æä¾›å•† '${provider}' çš„è¿žæŽ¥å·²æ›´æ–°ã€‚`);
            return true;
        }

        // ç›‘å¬ä¾§è¾¹æ å˜åŒ–ï¼Œä»¥ä¾¿å®žæ—¶æ›´æ–°é…ç½®
        sidebar.provider.addEventListener('change', updateConnection);
        sidebar.apiKey.addEventListener('change', updateConnection);

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡åˆå§‹è®¾ç½®
        await updateConnection();

        // --- 5. åˆå§‹åŒ–UIç»„ä»¶ï¼Œå¹¶æ³¨å…¥ä»Žé…ç½®ä¸­å¿ƒèŽ·å–çš„æ•°æ® ---
        const conversationDiv = document.getElementById('conversation');
        let chatHistory = [];

        // ä»Žé…ç½®ä¸­å¿ƒèŽ·å–æ‰€æœ‰å¯ç”¨çš„ Agent åˆ—è¡¨
        const availableAgents = await configManager.llm.getAgents();
        
        const chatUI = new LLMInputUI(document.getElementById('chat-input-container'), {
            agents: availableAgents, // å°†Agentåˆ—è¡¨æ³¨å…¥UIä»¥æ¸²æŸ“é€‰æ‹©å™¨
            initialAgent: availableAgents[0]?.id || '', // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªAgent
            initialText: "å†™ä¸€ä¸ªå…³äºŽç¨‹åºå‘˜å’Œä¸€ä¸ªç¥žå¥‡bugçš„çŸ­ç¯‡æ•…äº‹ã€‚",
            onSubmit: handleChatSubmit,
        });

        async function handleChatSubmit(data) {
            console.log("èŠå¤©å·²æäº¤:", data);
            
            // ç¡®ä¿åœ¨æäº¤æ—¶ï¼Œè¿žæŽ¥ä¿¡æ¯æ˜¯æœ€æ–°çš„
            if (!await updateConnection()) {
                chatUI.stopLoading();
                return;
            }

            // --- [æ ¸å¿ƒé›†æˆç‚¹] ---
            // 1. æ ¹æ®UIè¿”å›žçš„agentIdï¼Œä»ŽConfigManagerèŽ·å–è¯¥Agentçš„å®Œæ•´å®šä¹‰
            const agents = await configManager.llm.getAgents();
            const agentDef = agents.find(a => a.id === data.agent);
            if (!agentDef) {
                alert(`IDä¸º '${data.agent}' çš„Agentæœªæ‰¾åˆ°ï¼`);
                chatUI.stopLoading();
                return;
            }
            
            // 2. ä½¿ç”¨Agentå®šä¹‰ä¸­çš„connectionIdï¼Œé€šè¿‡LLMServiceèŽ·å–ä¸€ä¸ªé…ç½®å¥½çš„å®¢æˆ·ç«¯å®žä¾‹
            const client = await llmService.getClient(agentDef.config.connectionId);
            // ---

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•å’ŒåŽ†å²
            addMessageToLog(conversationDiv, 'user', data.text, data.attachments);
            const userContent = [];
            if (data.text) userContent.push({ type: 'text', text: data.text });
            if (data.attachments.length > 0) {
                 data.attachments.forEach(file => userContent.push({ type: 'image_url', image_url: { url: file }}));
            }
            
            const currentTurnHistory = { role: 'user', content: userContent };
            const messages = data.sendWithoutContext
                ? [currentTurnHistory]
                : [...chatHistory, currentTurnHistory];
                
            // åˆå¹¶ System Prompt (UIä¸­çš„ä¸´æ—¶æç¤º > Agentå®šä¹‰ä¸­çš„é»˜è®¤æç¤º)
            const systemPrompt = data.systemPrompt || agentDef.config.systemPrompt;
            if (systemPrompt) {
                messages.unshift({ role: 'system', content: systemPrompt });
            }
            
            chatUI.clear();

            try {
                const stream = await client.chat.create({
                    messages,
                    model: agentDef.config.modelName, // ä½¿ç”¨Agentå®šä¹‰ä¸­æŒ‡å®šçš„æ¨¡åž‹
                    temperature: parseFloat(sidebar.temperature.value),
                    stream: true,
                    include_thinking: true,
                });

                let fullResponse = '';
                let assistantMsgElement = null;
                let thinkingMsgElement = null;

                for await (const chunk of stream) {
                    const delta = chunk.choices[0]?.delta;
                    if (!delta) continue;

                    if (delta.thinking) {
                        if (!thinkingMsgElement) thinkingMsgElement = addMessageToLog(conversationDiv, 'thinking', '');
                        thinkingMsgElement.querySelector('div').textContent += delta.thinking;
                    }
                    if (delta.content) {
                        thinkingMsgElement = null; // æ€è€ƒç»“æŸ
                        if (!assistantMsgElement) assistantMsgElement = addMessageToLog(conversationDiv, 'assistant', '');
                        fullResponse += delta.content;
                        renderMarkdown(assistantMsgElement.querySelector('div'), fullResponse); 
                    }
                    conversationDiv.scrollTop = conversationDiv.scrollHeight;
                }
                
                if (fullResponse && !data.sendWithoutContext) {
                    // åªæœ‰åœ¨éžâ€œæ— ä¸Šä¸‹æ–‡â€æ¨¡å¼ä¸‹æ‰å°†ç”¨æˆ·å’ŒAIçš„å›žå¤éƒ½åŠ å…¥åŽ†å²è®°å½•
                    chatHistory.push(currentTurnHistory);
                    chatHistory.push({ role: 'assistant', content: fullResponse });
                }

            } catch (error) {
                addMessageToLog(conversationDiv, 'assistant', `é”™è¯¯: ${error.message}`);
            }
        }

        // --- DEMO 2 & 3: å…¶ä»–UIå®žä¾‹çš„åˆå§‹åŒ– ---
        // å®ƒä»¬æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥åˆå§‹åŒ–æ–¹å¼ä¸å˜ï¼Œä½†æˆ‘ä»¬ä¹Ÿç”¨é…ç½®æ•°æ®æ¥åˆå§‹åŒ–å®ƒä»¬çš„Agenté€‰æ‹©å™¨
        const themingUI = new LLMInputUI(document.getElementById('theming-input-container'), {
            agents: availableAgents,
            initialAgent: availableAgents[0]?.id,
            onSubmit: (data) => alert(`ä¸»é¢˜æ¼”ç¤ºå·²æäº¤:\n${JSON.stringify(data, null, 2)}`),
        });

        document.getElementById('apply-theme-btn').addEventListener('click', () => {
            themingUI.setTheme({
                '--llm-primary-color': document.getElementById('theme-primary-color').value,
                '--llm-border-radius': `${document.getElementById('theme-border-radius').value}px`,
                '--llm-font-family': document.getElementById('theme-font-family').value,
            });
        });
        document.getElementById('reset-theme-btn').addEventListener('click', () => themingUI.setTheme(defaultOptions.theme));
        
        const eventLog = document.getElementById('event-log');
        const logEvent = (name, payload) => {
            const entry = document.createElement('div');
            const payloadString = payload ? JSON.stringify(payload) : 'N/A';
            entry.innerHTML = `<span class="event-name">${name}:</span> <span class="event-payload">${payloadString}</span>`;
            eventLog.appendChild(entry);
            eventLog.scrollTop = eventLog.scrollHeight;
        };

        const eventsUI = new LLMInputUI(document.getElementById('events-input-container'), {
            agents: availableAgents,
            initialAgent: availableAgents[0]?.id,
            onSubmit: (data) => logEvent('submit', data),
            on: {
                agentChanged: (agentId) => logEvent('agentChanged', agentId),
                attachmentAdd: (att) => logEvent('attachmentAdd', { id: att.id, name: att.file.name }),
                attachmentRemove: (att) => logEvent('attachmentRemove', { id: att.id, name: att.file.name }),
                commandExecute: (cmd) => logEvent('commandExecute', cmd),
                clear: () => logEvent('clear'),
                themeChange: () => logEvent('themeChange', 'ä¸»é¢˜å¯¹è±¡å·²æ›´æ–°...'),
            }
        });

        eventsUI.registerCommand({
            name: '/time',
            description: 'æ˜¾ç¤ºå½“å‰æ—¶é—´å¹¶æ¸…é™¤è¾“å…¥ã€‚',
            handler() { this._showToast(`å½“å‰æ—¶é—´: ${new Date().toLocaleTimeString()}`); this.clear(); },
            executeOnClick: true,
        });

        // --- UIè¾…åŠ©å‡½æ•°å’ŒTabåˆ‡æ¢é€»è¾‘ (ä¿æŒä¸å˜) ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        }));

        function renderMarkdown(element, markdownText) {
            if (window.marked) element.innerHTML = marked.parse(markdownText || '');
            else element.textContent = markdownText || '';
        }

        function addMessageToLog(container, role, text, attachments = []) {
            const msgDiv = document.createElement('div');
            const displayRole = (role === 'thinking') ? 'æ€è€ƒä¸­' : (role.charAt(0).toUpperCase() + role.slice(1));
            msgDiv.className = `message ${role}`;
            const strong = document.createElement('strong');
            strong.textContent = displayRole;
            const contentDiv = document.createElement('div');
            if (role === 'assistant') renderMarkdown(contentDiv, text || '');
            else contentDiv.textContent = text;
            msgDiv.appendChild(strong);
            msgDiv.appendChild(contentDiv);
            if (attachments.length > 0) {
                attachments.forEach(file => {
                    if (file.type?.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        msgDiv.appendChild(img);
                    }
                });
            }
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            return msgDiv;
        }
    }
    </script>
</body>
</html>
