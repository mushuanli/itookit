<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat UI - æ¶æ„é‡æ„ä¸å“åº”å¼æ¼”ç¤º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* é¡µé¢åŸºç¡€æ ·å¼ */
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .demo-container {
            display: flex;
            height: 100vh;
        }

        /* [æ–°å¢] ä¾§è¾¹æ§åˆ¶é¢æ¿ */
        .demo-controls {
            flex-shrink: 0;
            width: 320px; /* ç¨å¾®åŠ å®½ä»¥å®¹çº³æ›´è¯¦ç»†çš„è¯´æ˜ */
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 25px; /* å¢åŠ é—´è· */
        }
        .demo-controls h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #764ba2;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .demo-controls button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f8f8;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left; /* æ–‡æœ¬å·¦å¯¹é½ */
            display: flex; /* ä½¿ç”¨ flex å¸ƒå±€ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
        }
        .demo-controls button:hover {
            background-color: #e9e9e9;
            border-color: #aaa;
        }
        .demo-controls button.add-btn {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .demo-controls button.del-btn {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .demo-controls p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-top: 5px; /* å‡å°ä¸æŒ‰é’®çš„é—´è· */
            padding-left: 5px;
        }

        .chat-column {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
        }

        .demo-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            flex-shrink: 0;
        }
        .demo-header h1 { margin: 0; font-size: 22px; }
        
        #chat-app-container {
            flex-grow: 1;
            overflow: hidden;
            background-color: #ffffff;
        }
    </style>
</head>
<body>

    <div class="demo-container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="demo-controls">
            <h2>âš™ï¸ æ§åˆ¶ä¸­å¿ƒ</h2>
            <div>
                <h3>æ•°æ®æŒä¹…åŒ– (æ–°)</h3>
                <p>æœ¬æ¼”ç¤ºç°åœ¨ä½¿ç”¨ <code>ModuleRepository</code> å°†ä¼šè¯ä¿å­˜ä¸ºæ–‡ä»¶ã€‚èŠå¤©å†…å®¹ä»¥ <b>JSONL</b> æ ¼å¼å­˜å‚¨åœ¨ LocalStorage ä¸­ï¼Œé”®ä¸º <code>llm_kit_demo_modules_demo_workspace</code>ã€‚</p>
                <p>ä½ å¯ä»¥åœ¨æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹å®ƒã€‚</p>
            </div>
            <div>
                <h3>å“åº”å¼é…ç½®</h3>
                <button id="add-agent-btn" class="add-btn">
                    <i class="fas fa-plus-circle"></i> æ·»åŠ "ç¿»è¯‘åŠ©æ‰‹" Agent
                </button>
                <p>é€šè¿‡ <code>ConfigManager</code> æ·»åŠ ä¸€ä¸ªæ–° Agentï¼ŒèŠå¤©ç•Œé¢å°†å®æ—¶æ›´æ–°ã€‚</p>
            </div>
            <div>
                <button id="del-agent-btn" class="del-btn">
                    <i class="fas fa-trash-alt"></i> åˆ é™¤ "Coder" Agent
                </button>
                <p>é€šè¿‡ <code>ConfigManager</code> åˆ é™¤ä¸€ä¸ª Agentï¼ŒUI å°†è‡ªåŠ¨åŒæ­¥ã€‚</p>
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="chat-column">
            <div class="demo-header">
                <h1>ğŸ¤– LLM Kit - IEditor æ¶æ„æ¼”ç¤º</h1>
            </div>

            <div id="chat-app-container"></div>
        </div>
    </div>

    <script type="module">
        // --- 1. å¯¼å…¥æ ¸å¿ƒæ¨¡å— ---
        import { LLMChatUI } from "../chat/index.js";
        import { ConfigManager } from "../../config/ConfigManager.js";
        import { API_KEY as DEEPSEEK_API_KEY } from "../../demo/config.js";
        // [å·²ç§»é™¤] ä¸å†éœ€è¦ LLMSessionStorageService

        if (!DEEPSEEK_API_KEY || DEEPSEEK_API_KEY.includes('YOUR_')) {
            alert('è¯·åœ¨ demo/config.js ä¸­é…ç½®æ‚¨çš„ API å¯†é’¥ä»¥è¿è¡Œæ­¤æ¼”ç¤ºã€‚');
            throw new Error("API key not configured.");
        }

        // --- 2. å®šä¹‰åˆå§‹çš„å…¨å±€é…ç½®æ•°æ® (ä¿æŒä¸å˜) ---
        const initialConnections = [
            { id: "conn-deepseek", name: "DeepSeek API", provider: "deepseek", apiKey: DEEPSEEK_API_KEY },
            { id: "conn-openai-mock", name: "OpenAI API", provider: "openai", apiKey: "OPENAI_API_KEY_PLACEHOLDER" }
        ];
        const initialAgents = [
            {
                id: "agent-general-chat", name: "é€šç”¨èŠå¤©åŠ©æ‰‹", icon: "ğŸ’¬",
                description: "ä¸€ä¸ªé€šç”¨çš„èŠå¤©åŠ©æ‰‹ï¼Œä½¿ç”¨DeepSeekæ¨¡å‹ã€‚",
                config: { connectionId: "conn-deepseek", modelName: "deepseek-chat", systemPrompt: "You are a helpful assistant." },
                interface: { inputs: [], outputs: [] }
            },
            {
                id: "agent-coder", name: "DeepSeek Coder", icon: "ğŸ’»",
                description: "ä¸€ä¸ªä¸“é—¨ç”¨äºç¼–ç¨‹çš„åŠ©æ‰‹ã€‚",
                config: { connectionId: "conn-deepseek", modelName: "deepseek-coder", systemPrompt: "You are an expert programmer." },
                interface: { inputs: [], outputs: [] }
            }
        ];
        
        // å®šä¹‰å¯ä¾›æ¨¡å‹ä½¿ç”¨çš„å·¥å…·
        const tools = [
            { type: 'function', function: { name: 'get_weather', description: 'è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯', parameters: { type: 'object', properties: { city: { type: 'string' } } } } }
        ];
        
        // --- 3. [æ ¸å¿ƒæ­¥éª¤] åˆå§‹åŒ–åº”ç”¨æ ¸å¿ƒæœåŠ¡ï¼šConfigManager (ä¿æŒä¸å˜) ---
        const configManager = ConfigManager.getInstance({
            adapterOptions: { prefix: 'llm_kit_demo_' }
        });

        // --- 4. [æ ¸å¿ƒé‡æ„] å®šä¹‰æ•°æ®ä»“åº“å’Œä¼šè¯æ–‡ä»¶è·¯å¾„ ---
        const WORKSPACE_ID = 'demo_workspace';
        const SESSION_FILE_PATH = '/main-conversation.jsonl';

        /**
         * [æ–°å¢] è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œæ¨¡æ‹Ÿå®¿ä¸»åº”ç”¨åŠ è½½æˆ–åˆ›å»ºä¼šè¯æ–‡ä»¶çš„é€»è¾‘ã€‚
         * @param {ModuleRepository} repository - è¦æ“ä½œçš„ä»“åº“å®ä¾‹ã€‚
         * @param {string} path - ä¼šè¯æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚
         * @returns {Promise<string>} è¿”å›ä¼šè¯æ–‡ä»¶çš„å†…å®¹ (JSONL å­—ç¬¦ä¸²)ã€‚
         */
        async function loadOrCreateSessionFile(repository, path) {
            console.log(`[Host] æ­£åœ¨å°è¯•åŠ è½½æˆ–åˆ›å»ºä¼šè¯æ–‡ä»¶: ${path}`);
            await repository.load(); // ç¡®ä¿ä»“åº“æ•°æ®å·²ä»æŒä¹…å±‚åŠ è½½
            
            // å°è¯•åœ¨æ ¹ç›®å½•æŸ¥æ‰¾æ–‡ä»¶
            const root = await repository.getModules();
            const existingFile = root.children.find(child => child.path === path);

            if (existingFile) {
                console.log(`[Host] æ–‡ä»¶å·²æ‰¾åˆ°ï¼ŒåŠ è½½å†…å®¹ã€‚`);
                return existingFile.content;
            } else {
                console.log(`[Host] æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»ºæ–°æ–‡ä»¶...`);
                // addModule çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯çˆ¶ç›®å½•è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ–°èŠ‚ç‚¹çš„æ•°æ®
                await repository.addModule('/', {
                    path: path.substring(1), // ç§»é™¤è·¯å¾„å¼€å¤´çš„ '/'
                    type: 'file',
                    content: '' // æ–°æ–‡ä»¶å†…å®¹ä¸ºç©º
                });
                return '';
            }
        }


        // --- 5. å¼‚æ­¥å¼•å¯¼å’Œåˆå§‹åŒ– UI ---
        async function initializeApp() {
            try {
                // ç­‰å¾… ConfigManager åŠ è½½å®Œåˆå§‹æ•°æ®
                await configManager._bootstrap();

                // å°†æˆ‘ä»¬çš„åˆå§‹é…ç½®ä¿å­˜åˆ° ConfigManager
                await configManager.llm.saveConnections(initialConnections);
                await configManager.llm.saveAgents(initialAgents);

                // --- 6. [æ ¸å¿ƒé‡æ„] åˆå§‹åŒ–æ•°æ®å±‚å¹¶åŠ è½½ä¼šè¯ ---
                // a. ä» ConfigManager è·å–ç‰¹å®šå·¥ä½œåŒºçš„ä»“åº“
                const repository = configManager.modules.get(WORKSPACE_ID);
                // b. åŠ è½½ä¼šè¯æ–‡ä»¶å†…å®¹
                const initialContent = await loadOrCreateSessionFile(repository, SESSION_FILE_PATH);

                // --- 7. [æ ¸å¿ƒé‡æ„] åˆå§‹åŒ– LLMChatUI ---
                const container = document.getElementById('chat-app-container');
                
                const chatApp = new LLMChatUI(container, {
                    // æ³¨å…¥ ConfigManagerï¼Œä½¿å…¶å…·æœ‰å“åº”å¼èƒ½åŠ›
                    configManager: configManager,
                    
                    // [å·²ç§»é™¤] ä¸å†éœ€è¦ sessionId å’Œ sessionStorage
                    
                    inputUIConfig: {
                        tools: tools,
                        localization: { placeholder: 'ä¸æ™ºèƒ½ä½“å¯¹è¯...' }
                    },
                    historyUIConfig: {
                        titleBar: { title: "ä¼šè¯çª—å£" }
                    }
                });

                // --- 8. [æ ¸å¿ƒé‡æ„] å°†åŠ è½½çš„å†…å®¹è®¾ç½®åˆ° UI ä¸­ ---
                chatApp.setText(initialContent);

                // --- 9. [æ ¸å¿ƒé‡æ„] ç›‘å¬ UI å˜åŒ–ï¼Œå¹¶ä¿å­˜å›æ•°æ®ä»“åº“ ---
                chatApp.on('change', async () => {
                    console.log('[Host] æ£€æµ‹åˆ° chatUI å†…å®¹å˜åŒ–ï¼Œæ­£åœ¨ä¿å­˜...');
                    // a. ä» UI è·å–æœ€æ–°çš„å†…å®¹ (JSONL å­—ç¬¦ä¸²)
                    const updatedContent = chatApp.getText();
                    // b. å°†å†…å®¹å†™å›æ–‡ä»¶
                    await repository.updateModuleContent(SESSION_FILE_PATH, updatedContent);
                    console.log('[Host] ä¼šè¯å·²æˆåŠŸä¿å­˜åˆ° ModuleRepositoryï¼');
                });
                
                console.log('âœ… Chat UI (IEditor Architecture) åˆå§‹åŒ–å®Œæˆï¼');
                window.chatApp = chatApp; // æ–¹ä¾¿è°ƒè¯•

                // --- 10. ç»‘å®šæµ‹è¯•æŒ‰é’®äº‹ä»¶ (ä¿æŒä¸å˜) ---
                setupTestButtons();

            } catch (error) {
                console.error('åˆå§‹åŒ– Chat UI å¤±è´¥:', error);
                document.getElementById('chat-app-container').innerHTML = `<div style="padding: 20px; color: red;"><strong>åˆå§‹åŒ–å¤±è´¥:</strong> ${error.message}</div>`;
            }
        }

        // --- 7. [æ–°å¢] è®¾ç½®æµ‹è¯•æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨ ---
        function setupTestButtons() {
            const addBtn = document.getElementById('add-agent-btn');
            const delBtn = document.getElementById('del-agent-btn');
            const llmRepo = configManager.llm; // è·å– LLMRepository çš„å¼•ç”¨

            addBtn.onclick = async () => {
                const newAgent = {
                    id: "agent-translator-" + Date.now(), // ä¿è¯IDå”¯ä¸€
                    name: "ç¿»è¯‘åŠ©æ‰‹",
                    icon: "ğŸŒ",
                    description: "ä¸€ä¸ªæ–°å¢çš„ç¿»è¯‘ Agentã€‚",
                    config: { connectionId: "conn-openai-mock", modelName: "gpt-3.5-turbo", systemPrompt: "You are a professional translator." },
                    interface: { inputs: [], outputs: [] }
                };

                console.log("æ­£åœ¨é€šè¿‡ ConfigManager æ·»åŠ æ–° Agent:", newAgent);
                // ç›´æ¥è°ƒç”¨ repository çš„æ–¹æ³•æ¥ä¿®æ”¹å…¨å±€çŠ¶æ€ã€‚
                // è¿™ä¼šè§¦å‘ä¿å­˜åˆ° localStorage å¹¶å‘å¸ƒ "llm:agents:updated" äº‹ä»¶ã€‚
                await llmRepo.addAgent(newAgent);
                alert('å·²æ·»åŠ  "ç¿»è¯‘åŠ©æ‰‹" Agentï¼è¯·æ£€æŸ¥èŠå¤©è¾“å…¥æ¡†å·¦ä¾§å’Œå†å²æ¶ˆæ¯ä¸­çš„ Agent ä¸‹æ‹‰åˆ—è¡¨ã€‚');
            };

            delBtn.onclick = async () => {
                const agentIdToRemove = 'agent-coder';
                console.log(`æ­£åœ¨é€šè¿‡ ConfigManager åˆ é™¤ Agent: ${agentIdToRemove}`);
                
                // è·å–å½“å‰ agents åˆ—è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨
                const currentAgents = await llmRepo.getAgents();
                if (!currentAgents.some(agent => agent.id === agentIdToRemove)) {
                    alert(`Agent "${agentIdToRemove}" å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨ã€‚`);
                    return;
                }
                
                // è°ƒç”¨ repository æ–¹æ³•æ¥åˆ é™¤
                await llmRepo.removeAgent(agentIdToRemove);
                alert(`å·²åˆ é™¤ "${agentIdToRemove}" Agentï¼è¯·è§‚å¯Ÿ UI çš„å˜åŒ–ã€‚`);
            };
        }

        // å¯åŠ¨åº”ç”¨
        initializeApp();

    </script>
</body>
</html>
