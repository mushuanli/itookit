<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat UI - æ¶æ„é‡æ„ä¸å“åº”å¼æ¼”ç¤º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* é¡µé¢åŸºç¡€æ ·å¼ */
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .demo-container {
            display: flex;
            height: 100vh;
        }

        /* [æ–°å¢] ä¾§è¾¹æ§åˆ¶é¢æ¿ */
        .demo-controls {
            flex-shrink: 0;
            width: 280px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .demo-controls h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #764ba2;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .demo-controls button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f8f8;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .demo-controls button:hover {
            background-color: #e9e9e9;
            border-color: #aaa;
        }
        .demo-controls button.add-btn {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .demo-controls button.del-btn {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .demo-controls p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-top: -10px;
        }

        .chat-column {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
        }

        .demo-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            flex-shrink: 0;
        }
        .demo-header h1 { margin: 0; font-size: 22px; }
        
        #chat-app-container {
            flex-grow: 1;
            overflow: hidden;
            background-color: #ffffff;
        }
    </style>
</head>
<body>

    <div class="demo-container">
        <!-- [æ–°å¢] å·¦ä¾§æ§åˆ¶é¢æ¿ï¼Œç”¨äºéªŒè¯å“åº”å¼æ›´æ–° -->
        <div class="demo-controls">
            <h2>âš™ï¸ é…ç½®æ§åˆ¶å™¨</h2>
            <div>
                <button id="add-agent-btn" class="add-btn">
                    <i class="fas fa-plus-circle"></i> æ·»åŠ ä¸€ä¸ªæ–° Agent
                </button>
                <p>ç‚¹å‡»åï¼Œä¼šé€šè¿‡ <code>ConfigManager</code> æ·»åŠ ä¸€ä¸ª"ç¿»è¯‘åŠ©æ‰‹" Agentã€‚è§‚å¯ŸèŠå¤©ç•Œé¢çš„ Agent åˆ—è¡¨æ˜¯å¦ä¼šå®æ—¶æ›´æ–°ã€‚</p>
            </div>
            <div>
                <button id="del-agent-btn" class="del-btn">
                    <i class="fas fa-trash-alt"></i> åˆ é™¤ Coder Agent
                </button>
                <p>ç‚¹å‡»åï¼Œä¼šé€šè¿‡ <code>ConfigManager</code> åˆ é™¤ "DeepSeek Coder"ã€‚è§‚å¯Ÿ Agent åˆ—è¡¨çš„å˜åŒ–ã€‚å¦‚æœå½“å‰æ­£é€‰ä¸­å®ƒï¼ŒUI ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤ Agentã€‚</p>
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="chat-column">
            <div class="demo-header">
                <h1>ğŸ¤– LLM Kit - å“åº”å¼æ¶æ„æ¼”ç¤º</h1>
            </div>

            <div id="chat-app-container"></div>
        </div>
    </div>

    <script type="module">
        // --- 1. å¯¼å…¥æ ¸å¿ƒæ¨¡å— ---
        import { LLMChatUI } from "../chat/index.js";
        import { ConfigManager } from "../../config/ConfigManager.js";
        import { API_KEY as DEEPSEEK_API_KEY } from "../../demo/config.js";

        // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„ Storage Serviceï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå®ƒå¯èƒ½ä¸ IndexedDB æˆ–åç«¯ API äº¤äº’
        import { LLMSessionStorageService } from "../config/services/LLMSessionStorageService.js";

        if (!DEEPSEEK_API_KEY || DEEPSEEK_API_KEY.includes('YOUR_')) {
            alert('è¯·åœ¨ demo/config.js ä¸­é…ç½®æ‚¨çš„ API å¯†é’¥ä»¥è¿è¡Œæ­¤æ¼”ç¤ºã€‚');
            throw new Error("API key not configured.");
        }

        // --- 2. å®šä¹‰åˆå§‹çš„å…¨å±€é…ç½®æ•°æ® ---
        const initialConnections = [
            { id: "conn-deepseek", name: "DeepSeek API", provider: "deepseek", apiKey: DEEPSEEK_API_KEY },
            { id: "conn-openai-mock", name: "OpenAI API", provider: "openai", apiKey: "OPENAI_API_KEY_PLACEHOLDER" }
        ];

        let initialAgents = [
            {
                id: "agent-general-chat", name: "é€šç”¨èŠå¤©åŠ©æ‰‹", icon: "ğŸ’¬",
                description: "ä¸€ä¸ªé€šç”¨çš„èŠå¤©åŠ©æ‰‹ï¼Œä½¿ç”¨DeepSeekæ¨¡å‹ã€‚",
                config: { connectionId: "conn-deepseek", modelName: "deepseek-chat", systemPrompt: "You are a helpful assistant." },
                interface: { inputs: [], outputs: [] }
            },
            {
                id: "agent-coder", name: "DeepSeek Coder", icon: "ğŸ’»",
                description: "ä¸€ä¸ªä¸“é—¨ç”¨äºç¼–ç¨‹çš„åŠ©æ‰‹ã€‚",
                config: { connectionId: "conn-deepseek", modelName: "deepseek-coder", systemPrompt: "You are an expert programmer." },
                interface: { inputs: [], outputs: [] }
            }
        ];
        
        // å®šä¹‰å¯ä¾›æ¨¡å‹ä½¿ç”¨çš„å·¥å…·
        const tools = [
            { type: 'function', function: { name: 'get_weather', description: 'è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯', parameters: { type: 'object', properties: { city: { type: 'string' } } } } }
        ];
        
        // --- 3. [æ ¸å¿ƒæ­¥éª¤] åˆå§‹åŒ–åº”ç”¨æ ¸å¿ƒæœåŠ¡ï¼šConfigManager ---
        // è¿™æ˜¯æ•´ä¸ªåº”ç”¨çš„â€œå•ä¸€å¯ä¿¡æ•°æ®æºâ€ã€‚æ‰€æœ‰UIç»„ä»¶éƒ½å°†ä»è¿™é‡Œè·å–æ•°æ®å¹¶ç›‘å¬å…¶å˜åŒ–ã€‚
        const configManager = ConfigManager.getInstance({
            adapterOptions: { prefix: 'llm_kit_demo_' }
        });

        // --- 4. å¼‚æ­¥å¼•å¯¼å’Œåˆå§‹åŒ– UI ---
        async functioninitializeApp() {
            try {
                // ç­‰å¾… ConfigManager ä» localStorage åŠ è½½å®Œåˆå§‹æ•°æ®
                await configManager._bootstrap();

                // å°†æˆ‘ä»¬çš„åˆå§‹é…ç½®æ•°æ®ä¿å­˜åˆ° ConfigManager ä¸­ã€‚
                // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™äº›æ•°æ®å¯èƒ½æ˜¯ä»æœåŠ¡å™¨è·å–æˆ–ç”±ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢åˆ›å»ºçš„ã€‚
                // ä½¿ç”¨ `save...` æ–¹æ³•ä¼šè¦†ç›–ç°æœ‰æ•°æ®å¹¶è§¦å‘æ›´æ–°äº‹ä»¶ã€‚
                await configManager.llm.saveConnections(initialConnections);
                await configManager.llm.saveAgents(initialAgents);

                // --- 5. åˆå§‹åŒ– LLMChatUI ---
                const container = document.getElementById('chat-app-container');
                const sessionID = 'llm-chat-ui-reactive-demo';
                const sessionStorage = new LLMSessionStorageService();

                const chatApp = new LLMChatUI(container, {
                    // [æ ¸å¿ƒå˜æ›´] æ³¨å…¥ ConfigManager å®ä¾‹
                    configManager: configManager,
                    
                    sessionId: sessionID,
                    sessionStorage: sessionStorage,

                    inputUIConfig: {
                        tools: tools,
                        localization: { placeholder: 'ä¸æ™ºèƒ½ä½“å¯¹è¯...' }
                    },
                    historyUIConfig: {
                        titleBar: { title: "LLM Kit" }
                    }
                });
                
                console.log('âœ… Chat UI (Reactive Architecture) åˆå§‹åŒ–å®Œæˆï¼');
                window.chatApp = chatApp; // æ–¹ä¾¿è°ƒè¯•

                // --- 6. ç»‘å®šæµ‹è¯•æŒ‰é’®äº‹ä»¶ ---
                setupTestButtons();

            } catch (error) {
                console.error('åˆå§‹åŒ– Chat UI å¤±è´¥:', error);
                document.getElementById('chat-app-container').innerHTML = `<div style="padding: 20px; color: red;"><strong>åˆå§‹åŒ–å¤±è´¥:</strong> ${error.message}</div>`;
            }
        }

        // --- 7. [æ–°å¢] è®¾ç½®æµ‹è¯•æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨ ---
        function setupTestButtons() {
            const addBtn = document.getElementById('add-agent-btn');
            const delBtn = document.getElementById('del-agent-btn');
            const llmRepo = configManager.llm; // è·å– LLMRepository çš„å¼•ç”¨

            addBtn.onclick = async () => {
                const newAgent = {
                    id: "agent-translator-" + Date.now(), // ä¿è¯IDå”¯ä¸€
                    name: "ç¿»è¯‘åŠ©æ‰‹",
                    icon: "ğŸŒ",
                    description: "ä¸€ä¸ªæ–°å¢çš„ç¿»è¯‘ Agentã€‚",
                    config: { connectionId: "conn-openai-mock", modelName: "gpt-3.5-turbo", systemPrompt: "You are a professional translator." },
                    interface: { inputs: [], outputs: [] }
                };

                console.log("æ­£åœ¨é€šè¿‡ ConfigManager æ·»åŠ æ–° Agent:", newAgent);
                // ç›´æ¥è°ƒç”¨ repository çš„æ–¹æ³•æ¥ä¿®æ”¹å…¨å±€çŠ¶æ€ã€‚
                // è¿™ä¼šè§¦å‘ä¿å­˜åˆ° localStorage å¹¶å‘å¸ƒ "llm:agents:updated" äº‹ä»¶ã€‚
                await llmRepo.addAgent(newAgent);
                alert('å·²æ·»åŠ  "ç¿»è¯‘åŠ©æ‰‹" Agentï¼è¯·æ£€æŸ¥èŠå¤©è¾“å…¥æ¡†å·¦ä¾§å’Œå†å²æ¶ˆæ¯ä¸­çš„ Agent ä¸‹æ‹‰åˆ—è¡¨ã€‚');
            };

            delBtn.onclick = async () => {
                const agentIdToRemove = 'agent-coder';
                console.log(`æ­£åœ¨é€šè¿‡ ConfigManager åˆ é™¤ Agent: ${agentIdToRemove}`);
                
                // è·å–å½“å‰ agents åˆ—è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨
                const currentAgents = await llmRepo.getAgents();
                if (!currentAgents.some(agent => agent.id === agentIdToRemove)) {
                    alert(`Agent "${agentIdToRemove}" å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨ã€‚`);
                    return;
                }
                
                // è°ƒç”¨ repository æ–¹æ³•æ¥åˆ é™¤
                await llmRepo.removeAgent(agentIdToRemove);
                alert(`å·²åˆ é™¤ "${agentIdToRemove}" Agentï¼è¯·è§‚å¯Ÿ UI çš„å˜åŒ–ã€‚`);
            };
        }

        // å¯åŠ¨åº”ç”¨
        initializeApp();

    </script>
</body>
</html>
