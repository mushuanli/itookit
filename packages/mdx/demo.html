<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDxEditor å®Œæ•´æ¼”ç¤º - VFS & å¤šå®ä¾‹</title>
  
  <!-- [é‡è¦] å¼•å…¥ MDxEditor çš„æ ‡å‡†æ ·å¼è¡¨ -->
  <link rel="stylesheet" href="./dist/style.css">

  <style>
    /* é¡µé¢å…¨å±€æ ·å¼ */
    :root {
      --primary-start: #667eea;
      --primary-end: #764ba2;
      --background-gradient: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--background-gradient);
      padding: 20px;
      min-height: 100vh;
    }

    /* é¡µé¢å¸ƒå±€æ ·å¼ */
    .container { max-width: 1400px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 40px; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header p { font-size: 1.1rem; opacity: 0.9; }
    .demo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .demo-card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; }
    .card-header { background: var(--background-gradient); color: white; padding: 20px; }
    .card-header h2 { font-size: 1.3rem; margin-bottom: 5px; }
    .card-header p { font-size: 0.9rem; opacity: 0.9; }
    .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }

    /* ç¼–è¾‘å™¨å¤–å±‚åŒ…è£¹æ ·å¼ */
    .editor-wrapper { 
      flex: 1; 
      border: 1px solid #e0e0e0; 
      border-radius: 8px; 
      overflow: hidden; 
      min-height: 300px; 
      display: flex; /* ç¡®ä¿å­å…ƒç´ å¯ä»¥æ’‘æ»¡ */
      flex-direction: column; 
    }

    /* 
     * [å·²ç§»é™¤] ç¼–è¾‘å™¨å†…éƒ¨æ ·å¼ã€‚
     * è¿™äº›æ ·å¼ç°åœ¨å®Œå…¨ç”± dist/style.css æä¾›ï¼Œä»¥ç¡®ä¿ä¸€è‡´æ€§å’Œé¿å…å†²çªã€‚
     * ä¾‹å¦‚ .mdx-editor-container, .mdx-editor-edit-mode ç­‰ã€‚
     */
    
    /* é¡µé¢æ§ä»¶æ ·å¼ */
    .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn svg { width: 18px; height: 18px; }
    .btn-primary { background: var(--background-gradient); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-danger { background: #ff4757; color: white; }
    .btn-danger:hover { background: #ff3838; }
    
    /* çŠ¶æ€æ æ ·å¼ */
    .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; font-size: 12px; color: #666; }
    .status-item { display: flex; align-items: center; gap: 5px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge-vfs { background: #10ac84; color: white; }
    .badge-adapter { background: #5f27cd; color: white; }
    .badge-memory { background: #ff9ff3; color: #333; }
    .badge-edit { background: #48dbfb; color: #333; }
    .badge-render { background: #54a0ff; color: white; }

    /* ä¿¡æ¯åŒºåŸŸæ ·å¼ */
    .info-section { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 20px; }
    .info-section h2 { color: var(--primary-start); margin-bottom: 15px; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
    .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary-start); }
    .info-item h3 { color: #333; margin-bottom: 8px; font-size: 1rem; }
    .info-item p { color: #666; font-size: 0.9rem; line-height: 1.5; }
    
    @media (max-width: 768px) { .demo-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ MDxEditor å®Œæ•´æ¼”ç¤º</h1>
      <p>å±•ç¤º VFS é›†æˆã€è‡ªå®šä¹‰é€‚é…å™¨å’Œå†…å­˜å­˜å‚¨çš„å¤šå®ä¾‹éš”ç¦»</p>
    </div>

    <div class="demo-grid">
      <!-- å®ä¾‹ 1: VFS å­˜å‚¨ -->
      <div class="demo-card">
        <div class="card-header">
          <h2>ğŸ“ å®ä¾‹ 1: VFS å­˜å‚¨</h2>
          <p>æ•°æ®å­˜å‚¨åœ¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­</p>
        </div>
        <div class="card-body">
          <div class="editor-wrapper" id="editor-container-1"></div>
          <div class="controls">
            <button class="btn btn-primary" onclick="toggleMode('editor1')"><span>åˆ‡æ¢æ¨¡å¼</span></button>
            <button class="btn btn-secondary" onclick="saveToVFS()"><span>ä¿å­˜åˆ° VFS</span></button>
          </div>
        </div>
        <div class="status-bar">
          <div class="status-item"><span class="badge badge-vfs">VFS</span><span id="status-mode-1"><span class="badge badge-edit">ç¼–è¾‘æ¨¡å¼</span></span></div>
        </div>
      </div>

      <!-- å®ä¾‹ 2: LocalStorage é€‚é…å™¨ -->
      <div class="demo-card">
        <div class="card-header">
          <h2>ğŸ’¾ å®ä¾‹ 2: LocalStorage é€‚é…å™¨</h2>
          <p>ä½¿ç”¨è‡ªå®šä¹‰æŒä¹…åŒ–é€‚é…å™¨</p>
        </div>
        <div class="card-body">
          <div class="editor-wrapper" id="editor-container-2"></div>
          <div class="controls">
            <button class="btn btn-primary" onclick="toggleMode('editor2')"><span>åˆ‡æ¢æ¨¡å¼</span></button>
            <button class="btn btn-danger" onclick="clearAdapter()"><span>æ¸…ç©º Storage</span></button>
          </div>
        </div>
        <div class="status-bar">
          <div class="status-item"><span class="badge badge-adapter">Adapter</span><span id="status-mode-2"><span class="badge badge-edit">ç¼–è¾‘æ¨¡å¼</span></span></div>
        </div>
      </div>

      <!-- å®ä¾‹ 3: çº¯å†…å­˜å­˜å‚¨ -->
      <div class="demo-card">
        <div class="card-header">
          <h2>ğŸ§  å®ä¾‹ 3: çº¯å†…å­˜å­˜å‚¨</h2>
          <p>ä¸´æ—¶ä¼šè¯ï¼Œåˆ·æ–°é¡µé¢åæ•°æ®ä¸¢å¤±</p>
        </div>
        <div class="card-body">
          <div class="editor-wrapper" id="editor-container-3"></div>
          <div class="controls">
            <button class="btn btn-primary" onclick="toggleMode('editor3')"><span>åˆ‡æ¢æ¨¡å¼</span></button>
            <button class="btn btn-danger" onclick="clearMemory('editor3')"><span>æ¸…ç©ºå†…å®¹</span></button>
          </div>
        </div>
        <div class="status-bar">
          <div class="status-item"><span class="badge badge-memory">Memory</span><span id="status-mode-3"><span class="badge badge-edit">ç¼–è¾‘æ¨¡å¼</span></span></div>
        </div>
      </div>
    </div>
    
    <div class="info-section">
      <!-- ... info section content ... -->
    </div>
  </div>

  <script type="module">
    // ä½¿ç”¨ import ä»£æ›¿æ¨¡æ‹Ÿï¼Œéœ€è¦åœ¨æ”¯æŒ ESM çš„ç¯å¢ƒä¸­è¿è¡Œï¼ˆä¾‹å¦‚é€šè¿‡ live-serverï¼‰
    import { createMDxEditor, MathJaxPlugin } from './dist/index.mjs';
  
    import { getVFSManager } from '@itookit/vfs-core';
    import { IPersistenceAdapter } from '@itookit/common';

    // ===================================================================================
    // APPLICATION LOGIC
    // ===================================================================================

    const editors = {};
    let vfsFile = null;
    let adapterForEditor2 = null;

    // --- Initial Content ---
    const content1 = `# VFS å­˜å‚¨ç¤ºä¾‹\n\nè¿™ä¸ªå®ä¾‹ä½¿ç”¨ **@itookit/vfs-core** è¿›è¡Œæ•°æ®æŒä¹…åŒ–ã€‚\n\næ•°å­¦å…¬å¼æ”¯æŒ: $E = mc^2$\n\næ’ä»¶æ•°æ®ï¼ˆå¦‚è¯„è®ºã€é«˜äº®ï¼‰ä¼šå­˜å‚¨åœ¨ VNode metadata ä¸­ã€‚`;
    const content2 = `# LocalStorage é€‚é…å™¨ç¤ºä¾‹\n\nè¿™ä¸ªå®ä¾‹ä½¿ç”¨ **IPersistenceAdapter** æ¥å£ã€‚\n\n- æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨ LocalStorage\n- æ”¯æŒè·¨ä¼šè¯æŒä¹…åŒ–\n- å®Œå…¨ç‹¬ç«‹äºå®ä¾‹ 1\n\n$$ \\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6} $$`;
    const content3 = `# å†…å­˜å­˜å‚¨ç¤ºä¾‹\n\nè¿™ä¸ªå®ä¾‹ä½¿ç”¨ **çº¯å†…å­˜å­˜å‚¨**ã€‚\n\nç‰¹ç‚¹ï¼š\n- ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨å­˜å‚¨\n- å®ä¾‹å®Œå…¨éš”ç¦»\n- åˆ·æ–°é¡µé¢åæ•°æ®ä¸¢å¤±`;

    // --- Custom Adapter ---
    class LocalStorageAdapter extends IPersistenceAdapter {
      constructor(prefix = 'mdx-editor') {
        super();
        this.prefix = prefix;
      }
      async setItem(key, value) { localStorage.setItem(`${this.prefix}:${key}`, JSON.stringify(value)); }
      async getItem(key) {
        const item = localStorage.getItem(`${this.prefix}:${key}`);
        return item ? JSON.parse(item) : null;
      }
      async removeItem(key) { localStorage.removeItem(`${this.prefix}:${key}`); }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. VFS Instance
      const vfsCore = getVFSManager();
      await vfsCore.init({ storage: { dbName: 'MDxEditor_VFS_Demo' } });
      const module = await vfsCore.mount('documents');
      
      const filePath = '/notes/my-note.md';
      const dirPath = '/notes';
      /*
      const existingFileId ;//TODO: = await vfsCore.storage.getNodeIdByPath(module.name, filePath);
      if (existingFileId) {
        vfsFile = await vfsCore.storage.loadVNode(existingFileId);
      } else {
        const dirNodeId = await vfsCore.storage.getNodeIdByPath(module.name, dirPath);
        if (!dirNodeId) {
          await vfsCore.createDirectory(module.name, dirPath);
        }
        vfsFile = await vfsCore.createFile(module.name, filePath, content1);
      }
      
      const editor1 = createMDxEditor({
        vfsCore: vfsCore,
        nodeId: vfsFile.id,
        plugins: ['mathjax'] // æ˜ç¡®æŒ‡å®šæ’ä»¶
      });
      editor1.init(document.getElementById('editor-container-1'), vfsFile.content);
      editors['editor1'] = editor1;
        */

      // 2. Adapter Instance
      adapterForEditor2 = new LocalStorageAdapter('editor2-storage');
      const savedContent = await adapterForEditor2.getItem('content');
      
      const editor2 = createMDxEditor({
        persistenceAdapter: adapterForEditor2,
        plugins: ['mathjax']
      });
      editor2.init(document.getElementById('editor-container-2'), savedContent || content2);
      editors['editor2'] = editor2;

      // 3. Memory Instance
      const editor3 = createMDxEditor({
        plugins: ['mathjax']
      });
      editor3.init(document.getElementById('editor-container-3'), content3);
      editors['editor3'] = editor3;

      console.log('âœ… MDxEditor æ¼”ç¤ºå·²åŠ è½½', { editors, vfsFile });
    });

    // --- Global UI Functions ---
    window.toggleMode = (editorKey) => {
      const editor = editors[editorKey];
      if (!editor) return;
      const newMode = editor.getCurrentMode() === 'edit' ? 'render' : 'edit';
      editor.switchToMode(newMode);

      const statusEl = document.getElementById(`status-mode-${editorKey.slice(-1)}`);
      statusEl.innerHTML = newMode === 'render' 
        ? `<span class="badge badge-render">æ¸²æŸ“æ¨¡å¼</span>` 
        : `<span class="badge badge-edit">ç¼–è¾‘æ¨¡å¼</span>`;
    };

    window.saveToVFS = async () => {
      const editor = editors['editor1'];
      const content = editor.getContent();
      const vfsCore = getVFSManager();
      await vfsCore.write(vfsFile.id, content);
      alert(`âœ… å†…å®¹å·²ä¿å­˜åˆ° VFS èŠ‚ç‚¹: ${vfsFile.id}`);
    };
    
    window.clearAdapter = async () => {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ­¤ç¼–è¾‘å™¨çš„å†…å®¹å’Œ LocalStorage å—ï¼Ÿ')) return;
      const editor = editors['editor2'];
      editor.setContent('');
      if (adapterForEditor2) {
        await adapterForEditor2.removeItem('content');
      }
      alert('ğŸ—‘ï¸ ç¼–è¾‘å™¨å†…å®¹å’Œ LocalStorage å·²æ¸…ç©ºï¼');
    };

    window.clearMemory = (editorKey) => {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ­¤ç¼–è¾‘å™¨çš„å†…å®¹å—ï¼Ÿ')) return;
      editors[editorKey].setContent('');
      alert('ğŸ—‘ï¸ ç¼–è¾‘å™¨å†…å®¹å·²æ¸…ç©ºï¼');
    };
    
    // Save content for adapter-based editor on unload
    window.addEventListener('beforeunload', () => {
      const editor2 = editors['editor2'];
      if (editor2 && adapterForEditor2) {
        adapterForEditor2.setItem('content', editor2.getContent());
      }
    });
  </script>
</body>
</html>