import{e as Rs,p as Ps,M as Ht,C as xt,m as zt,S as Os,E as Q,a as qt,b as Vt,s as Fs,D as Ze,l as Us,h as Bs,c as Hs,d as zs,f as qs,g as Vs,i as js,j as Gs,k as Ws,n as Ks,o as Qs,q as Js,r as Ys,t as Xs,u as Zs,v as se,w as en,x as tn,y as sn,z as nn,A as an,B as on,F as ze,G as rn,H as jt,T as ln,I as cn,J as dn}from"./vendor-DFlgIoMc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();var w=(l=>(l.FILE="file",l.DIRECTORY="directory",l))(w||{}),R=(l=>(l.NODE_CREATED="node:created",l.NODE_UPDATED="node:updated",l.NODE_DELETED="node:deleted",l.NODE_MOVED="node:moved",l.NODE_COPIED="node:copied",l.BATCH_OPERATION="batch:operation",l.PLUGIN_REGISTERED="plugin:registered",l.PLUGIN_INSTALLED="plugin:installed",l.PLUGIN_ACTIVATED="plugin:activated",l.PLUGIN_DEACTIVATED="plugin:deactivated",l.PLUGIN_UNINSTALLED="plugin:uninstalled",l.PLUGIN_ERROR="plugin:error",l))(R||{});const hn="0123456789abcdefghijklmnopqrstuvwxyz";function un(l){let e="";for(let t=0;t<l;t++)e+=hn[Math.floor(Math.random()*36)];return e}function Oe(){return`node_${Date.now().toString(36)}_${un(8)}`}function gn(l){return`content_${l}`}function Ct(l){return typeof l=="string"?new Blob([l]).size:l.byteLength}const Se={create(l){const e=l.nodeId??Oe(),t=Date.now();return{nodeId:e,parentId:l.parentId??null,name:l.name,type:l.type,path:l.path,contentRef:l.type===w.FILE?gn(e):null,size:l.size??0,createdAt:l.createdAt??t,modifiedAt:l.modifiedAt??t,metadata:l.metadata??{}}},clone(l,e){return{...l,...e,metadata:{...l.metadata,...e?.metadata}}},isDirectory(l){return l.type===w.DIRECTORY},isFile(l){return l.type===w.FILE}},pn=/[<>:"|?*\x00-\x1f]/;class mn{normalize(e){if(!e||e===".")return"/";const t=e.split("/").filter(n=>n&&n!=="."),s=[];for(const n of t)n===".."?s.pop():s.push(n);return"/"+s.join("/")}isValid(e){return typeof e!="string"?!1:e==="/"?!0:!e.startsWith("/")||e.includes("//")?!1:!pn.test(e)}basename(e){const t=this.normalize(e);return t==="/"?"":t.slice(t.lastIndexOf("/")+1)}dirname(e){const t=this.normalize(e),s=t.lastIndexOf("/");return s<=0?"/":t.slice(0,s)}join(...e){return this.normalize(e.join("/"))}relative(e,t){const s=this.normalize(e).split("/").filter(Boolean),n=this.normalize(t).split("/").filter(Boolean);let i=0;const a=Math.min(s.length,n.length);for(;i<a&&s[i]===n[i];)i++;const o=s.length-i,r=[...Array(o).fill(".."),...n.slice(i)];return r.length===0?".":r.join("/")}isSubPath(e,t){const s=this.normalize(e),n=this.normalize(t);return s==="/"?!0:n.startsWith(s+"/")}depth(e){const t=this.normalize(e);return t==="/"?0:t.split("/").filter(Boolean).length}}const N=new mn;let Gt=class{handlers=new Map;wildcardHandlers=new Set;on(e,t){let s=this.handlers.get(e);return s||(s=new Set,this.handlers.set(e,s)),s.add(t),()=>this.off(e,t)}onAny(e){return this.wildcardHandlers.add(e),()=>this.wildcardHandlers.delete(e)}off(e,t){this.handlers.get(e)?.delete(t)}emit(e){this.handlers.get(e.type)?.forEach(t=>{this.safeCall(()=>t(e))}),this.wildcardHandlers.forEach(t=>{this.safeCall(()=>t(e.type,e))})}clear(){this.handlers.clear(),this.wildcardHandlers.clear()}safeCall(e){try{e()}catch(t){console.error("[EventBus] Handler error:",t)}}};var T=(l=>(l.UNKNOWN="UNKNOWN",l.INTERNAL_ERROR="INTERNAL_ERROR",l.NOT_FOUND="NOT_FOUND",l.ALREADY_EXISTS="ALREADY_EXISTS",l.INVALID_PATH="INVALID_PATH",l.INVALID_OPERATION="INVALID_OPERATION",l.PERMISSION_DENIED="PERMISSION_DENIED",l.READ_ONLY="READ_ONLY",l.TRANSACTION_FAILED="TRANSACTION_FAILED",l.TRANSACTION_ABORTED="TRANSACTION_ABORTED",l.PLUGIN_NOT_FOUND="PLUGIN_NOT_FOUND",l.PLUGIN_LOAD_ERROR="PLUGIN_LOAD_ERROR",l.DEPENDENCY_ERROR="DEPENDENCY_ERROR",l.STORAGE_ERROR="STORAGE_ERROR",l.CONNECTION_ERROR="CONNECTION_ERROR",l.SYNC_ERROR="SYNC_ERROR",l.CONFLICT_ERROR="CONFLICT_ERROR",l))(T||{});class x extends Error{constructor(e,t,s,n=Date.now()){super(t),this.code=e,this.details=s,this.timestamp=n,this.name="VFSError",Object.setPrototypeOf(this,x.prototype)}toJSON(){return{name:this.name,code:this.code,message:this.message,details:this.details,timestamp:this.timestamp}}static is(e){return e instanceof x}static wrap(e,t,s){if(x.is(e))return e;const n=s??(e instanceof Error?e.message:String(e));return new x(t,n,e)}}class fn{storage;events;pathResolver=N;initialized=!1;constructor(e){this.storage=e.storage,this.events=e.eventBus??new Gt,this.pathResolver=N}async initialize(){this.initialized||(await this.storage.connect(),await this.ensureRootNode(),this.initialized=!0)}async shutdown(){this.initialized&&(await this.storage.disconnect(),this.events.clear(),this.initialized=!1)}get isInitialized(){return this.initialized}async createNode(e){this.ensureInitialized();const{path:t,type:s,content:n,metadata:i={}}=e,a=this.pathResolver.normalize(t);if(!this.pathResolver.isValid(a))throw new x(T.INVALID_PATH,`Invalid path: ${t}`);if(await this.getNodeByPath(a))throw new x(T.ALREADY_EXISTS,`Node exists: ${t}`);const o=this.pathResolver.dirname(a);let r=null;if(a!=="/"){const h=await this.getNodeByPath(o);if(!h)throw new x(T.NOT_FOUND,`Parent not found: ${o}`);if(h.type!==w.DIRECTORY)throw new x(T.INVALID_OPERATION,`Not a directory: ${o}`);r=h.nodeId}const c=Se.create({parentId:r,name:this.pathResolver.basename(a),type:s,path:a,metadata:i}),d=this.storage.beginTransaction(["vnodes","contents"],"readwrite");try{if(await d.getCollection("vnodes").put(c),s===w.FILE&&n!==void 0&&c.contentRef){const h={contentRef:c.contentRef,nodeId:c.nodeId,content:n,size:Ct(n),createdAt:Date.now()};await d.getCollection("contents").put(h),c.size=h.size}return await d.commit(),this.emitEvent(R.NODE_CREATED,c),c}catch(h){throw await d.abort(),this.wrapError(h,"Failed to create node")}}async read(e){this.ensureInitialized();const t=await this.getNode(e);if(!t)throw new x(T.NOT_FOUND,`Node not found: ${e}`);if(t.type!==w.FILE)throw new x(T.INVALID_OPERATION,`Cannot read directory: ${e}`);return t.contentRef?(await this.storage.getCollection("contents").get(t.contentRef))?.content??"":""}async write(e,t){this.ensureInitialized();const s=await this.getNode(e);if(!s)throw new x(T.NOT_FOUND,`Node not found: ${e}`);if(s.type!==w.FILE)throw new x(T.INVALID_OPERATION,`Cannot write to directory: ${e}`);const n=this.storage.beginTransaction(["vnodes","contents"],"readwrite");try{if(s.contentRef){const i={contentRef:s.contentRef,nodeId:s.nodeId,content:t,size:Ct(t),createdAt:Date.now()};await n.getCollection("contents").put(i),s.size=i.size}return s.modifiedAt=Date.now(),await n.getCollection("vnodes").put(s),await n.commit(),this.emitEvent(R.NODE_UPDATED,s),s}catch(i){throw await n.abort(),this.wrapError(i,"Failed to write content")}}async readdir(e){this.ensureInitialized();const t=await this.getNode(e);if(!t)throw new x(T.NOT_FOUND,`Node not found: ${e}`);if(t.type!==w.DIRECTORY)throw new x(T.INVALID_OPERATION,`Not a directory: ${e}`);return this.storage.getCollection("vnodes").getAllByIndex("parentId",e)}async unlink(e,t=!1){this.ensureInitialized();const s=await this.getNode(e);if(!s)return[];const n=await this.collectDescendants(s);if(s.type===w.DIRECTORY&&n.length>1&&!t)throw new x(T.INVALID_OPERATION,`Directory not empty: ${e}`);const i=n.map(o=>o.nodeId),a=this.storage.beginTransaction(["vnodes","contents"],"readwrite");try{const o=a.getCollection("vnodes"),r=a.getCollection("contents");for(const c of n)c.contentRef&&await r.delete(c.contentRef),await o.delete(c.nodeId);return await a.commit(),this.emitEvent(R.NODE_DELETED,s,{deletedIds:i}),i}catch(o){throw await a.abort(),this.wrapError(o,"Failed to delete node")}}async move(e,t){this.ensureInitialized();const s=await this.getNode(e);if(!s)throw new x(T.NOT_FOUND,`Node not found: ${e}`);const n=this.pathResolver.normalize(t);if(!this.pathResolver.isValid(n))throw new x(T.INVALID_PATH,`Invalid path: ${t}`);const i=await this.getNodeByPath(n);if(i&&i.nodeId!==e)throw new x(T.ALREADY_EXISTS,`Node exists: ${t}`);if(this.pathResolver.isSubPath(s.path,n))throw new x(T.INVALID_OPERATION,"Cannot move into descendant");const a=this.pathResolver.dirname(n);let o=null;if(n!=="/"){const d=await this.getNodeByPath(a);if(!d)throw new x(T.NOT_FOUND,`Parent not found: ${a}`);o=d.nodeId}const r=s.path,c=this.storage.beginTransaction(["vnodes"],"readwrite");try{const d=c.getCollection("vnodes");return s.parentId=o,s.name=this.pathResolver.basename(n),s.path=n,s.modifiedAt=Date.now(),await d.put(s),s.type===w.DIRECTORY&&await this.updateDescendantPaths(s,r,n,c),await c.commit(),this.emitEvent(R.NODE_MOVED,s,{oldPath:r,newPath:n}),s}catch(d){throw await c.abort(),this.wrapError(d,"Failed to move node")}}async copy(e,t){this.ensureInitialized();const s=await this.getNode(e);if(!s)throw new x(T.NOT_FOUND,`Node not found: ${e}`);const n=this.pathResolver.normalize(t);if(await this.getNodeByPath(n))throw new x(T.ALREADY_EXISTS,`Node exists: ${t}`);const i=this.pathResolver.dirname(n);let a=null;if(n!=="/"){const r=await this.getNodeByPath(i);if(!r)throw new x(T.NOT_FOUND,`Parent not found: ${i}`);a=r.nodeId}const o=this.storage.beginTransaction(["vnodes","contents"],"readwrite");try{const r=await this.copyNodeRecursive(s,a,n,o);return await o.commit(),this.emitEvent(R.NODE_COPIED,r,{sourceId:e}),r}catch(r){throw await o.abort(),this.wrapError(r,"Failed to copy node")}}async getNode(e){return this.ensureInitialized(),await this.storage.getCollection("vnodes").get(e)??null}async getNodeByPath(e){this.ensureInitialized();const t=this.pathResolver.normalize(e);return await this.storage.getCollection("vnodes").getByIndex("path",t)??null}async resolvePathToId(e){return(await this.getNodeByPath(e))?.nodeId??null}async exists(e){return this.ensureInitialized(),await this.getNodeByPath(e)!==null}async createNodeIfNotExists(e){this.ensureInitialized();const t=this.pathResolver.normalize(e.path),s=await this.getNodeByPath(t);return s?{node:s,created:!1}:{node:await this.createNode(e),created:!0}}async ensureDirectory(e){this.ensureInitialized();const t=this.pathResolver.normalize(e),s=await this.getNodeByPath(t);if(s){if(s.type!==w.DIRECTORY)throw new x(T.INVALID_OPERATION,`Not a directory: ${e}`);return s}const n=this.pathResolver.dirname(t);return n!=="/"&&n!==t&&await this.ensureDirectory(n),this.createNode({path:t,type:w.DIRECTORY})}ensureInitialized(){if(!this.initialized)throw new x(T.INVALID_OPERATION,"VFS not initialized")}async ensureRootNode(){if(!await this.storage.getCollection("vnodes").getByIndex("path","/")){const t=Se.create({nodeId:"root",parentId:null,name:"",type:w.DIRECTORY,path:"/"}),s=this.storage.beginTransaction(["vnodes"],"readwrite");try{await s.getCollection("vnodes").put(t),await s.commit()}catch(n){throw await s.abort(),this.wrapError(n,"Failed to create root node")}}}async collectDescendants(e){const t=[e];if(e.type===w.DIRECTORY){const s=await this.storage.getCollection("vnodes").getAllByIndex("parentId",e.nodeId);for(const n of s)t.push(...await this.collectDescendants(n))}return t}async updateDescendantPaths(e,t,s,n){const i=n.getCollection("vnodes"),a=await i.getAllByIndex("parentId",e.nodeId);for(const o of a)o.path=s+o.path.substring(t.length),o.modifiedAt=Date.now(),await i.put(o),o.type===w.DIRECTORY&&await this.updateDescendantPaths(o,t,s,n)}async copyNodeRecursive(e,t,s,n){const i=Oe(),a=n.getCollection("vnodes"),o=n.getCollection("contents"),r=Se.create({nodeId:i,parentId:t,name:this.pathResolver.basename(s),type:e.type,path:s,size:e.size,metadata:{...e.metadata}});if(await a.put(r),e.type===w.FILE&&e.contentRef&&r.contentRef){const c=await this.storage.getCollection("contents").get(e.contentRef);c&&await o.put({contentRef:r.contentRef,nodeId:i,content:c.content,size:c.size,createdAt:Date.now()})}if(e.type===w.DIRECTORY){const c=await this.storage.getCollection("vnodes").getAllByIndex("parentId",e.nodeId);for(const d of c){const h=this.pathResolver.join(s,d.name);await this.copyNodeRecursive(d,i,h,n)}}return r}emitEvent(e,t,s){this.events.emit({type:e,nodeId:t.nodeId,path:t.path,timestamp:Date.now(),data:s})}wrapError(e,t){return x.wrap(e,T.INTERNAL_ERROR,t)}}const It=[{name:"vnodes",keyPath:"nodeId",indexes:[{name:"path",keyPath:"path",unique:!0},{name:"parentId",keyPath:"parentId"},{name:"type",keyPath:"type"},{name:"name",keyPath:"name"}]},{name:"contents",keyPath:"contentRef",indexes:[{name:"nodeId",keyPath:"nodeId"}]}];class Z{static factories=new Map;static schemas=[...It];static registerAdapter(e,t){this.factories.set(e,t)}static unregisterAdapter(e){return this.factories.delete(e)}static createAdapter(e,t,s=[]){const n=this.factories.get(e);if(!n)throw new Error(`Unknown storage adapter type: ${e}`);const i=[...this.schemas,...s];return console.log(`[StorageManager] Creating ${e} adapter with ${i.length} schemas`),n(t,i)}static getRegisteredTypes(){return Array.from(this.factories.keys())}static registerDefaultSchema(e){const t=this.schemas.findIndex(s=>s.name===e.name);t>=0?this.schemas[t]=e:this.schemas.push(e)}static getDefaultSchemas(){return[...this.schemas]}static resetSchemas(){this.schemas=[...It]}}var ge=(l=>(l.STORAGE="storage",l.MIDDLEWARE="middleware",l.FEATURE="feature",l.ADAPTER="adapter",l))(ge||{}),M=(l=>(l.REGISTERED="registered",l.INSTALLED="installed",l.ACTIVATED="activated",l.DEACTIVATED="deactivated",l.ERROR="error",l))(M||{}),xe=(l=>(l.STORAGE_ADAPTER="storage.adapter",l.MIDDLEWARE="middleware",l.SCHEMA="schema",l.NODE_HANDLER="node.handler",l.SEARCH_PROVIDER="search.provider",l.SYNC_ADAPTER="sync.adapter",l))(xe||{});class yn{constructor(e,t,s){this.pluginGetter=s,this.kernel=e,this.events=e.events,this.pluginId=t,this.log=this.createLogger()}kernel;events;pluginId;log;extensions=new Map;storage=new Map;registerExtension(e,t){let s=this.extensions.get(e);s||(s=[],this.extensions.set(e,s)),s.push(t)}getExtensions(e){return this.extensions.get(e)??[]}registerSchema(e){Z.registerDefaultSchema(e)}getPlugin(e){return this.pluginGetter(e)}getStorage(e){return this.storage.get(e)}setStorage(e,t){this.storage.set(e,t)}dispose(){this.extensions.clear(),this.storage.clear()}createLogger(){const e=`[Plugin:${this.pluginId}]`;return{debug:(t,...s)=>console.debug(e,t,...s),info:(t,...s)=>console.info(e,t,...s),warn:(t,...s)=>console.warn(e,t,...s),error:(t,...s)=>console.error(e,t,...s)}}}let vn=class{constructor(e){this.kernel=e}plugins=new Map;globalExtensions=new Map;register(e){const{id:t}=e.metadata;if(this.plugins.has(t))throw new Error(`Plugin already registered: ${t}`);const s=new yn(this.kernel,t,n=>this.plugins.get(n)?.plugin);this.plugins.set(t,{plugin:e,context:s,state:M.REGISTERED}),this.emitEvent(R.PLUGIN_REGISTERED,e.metadata)}async install(e){const t=this.getEntry(e);if(t.state!==M.REGISTERED)throw new Error(`Plugin ${e} is not in REGISTERED state`);this.checkDependencies(t.plugin.metadata);try{await t.plugin.install(t.context),t.state=M.INSTALLED,this.collectExtensions(t),this.emitEvent(R.PLUGIN_INSTALLED,t.plugin.metadata)}catch(s){throw t.state=M.ERROR,this.emitEvent(R.PLUGIN_ERROR,{pluginId:e,error:s,phase:"install"}),s}}async activate(e){const t=this.getEntry(e);if(t.state!==M.INSTALLED&&t.state!==M.DEACTIVATED)throw new Error(`Plugin ${e} cannot be activated from state: ${t.state}`);for(const s of t.plugin.metadata.dependencies??[]){const n=this.plugins.get(s);n&&n.state!==M.ACTIVATED&&await this.activate(s)}try{await t.plugin.activate(),t.state=M.ACTIVATED,this.emitEvent(R.PLUGIN_ACTIVATED,t.plugin.metadata)}catch(s){throw t.state=M.ERROR,this.emitEvent(R.PLUGIN_ERROR,{pluginId:e,error:s,phase:"activate"}),s}}async deactivate(e){const t=this.getEntry(e);if(t.state===M.ACTIVATED){for(const[s,n]of this.plugins)n.plugin.metadata.dependencies?.includes(e)&&n.state===M.ACTIVATED&&await this.deactivate(s);try{await t.plugin.deactivate(),t.state=M.DEACTIVATED,this.emitEvent(R.PLUGIN_DEACTIVATED,t.plugin.metadata)}catch(s){throw this.emitEvent(R.PLUGIN_ERROR,{pluginId:e,error:s,phase:"deactivate"}),s}}}async uninstall(e){const t=this.plugins.get(e);if(t){t.state===M.ACTIVATED&&await this.deactivate(e);try{await t.plugin.uninstall(),this.removeExtensions(t),t.context.dispose(),this.plugins.delete(e),this.emitEvent(R.PLUGIN_UNINSTALLED,t.plugin.metadata)}catch(s){throw this.emitEvent(R.PLUGIN_ERROR,{pluginId:e,error:s,phase:"uninstall"}),s}}}async activateAll(){const e=this.topologicalSort();for(const t of e){const s=this.plugins.get(t);s.state===M.REGISTERED&&await this.install(t),s.state===M.INSTALLED&&await this.activate(t)}}async uninstallAll(){const e=this.topologicalSort().reverse();for(const t of e)await this.uninstall(t)}getPlugin(e){return this.plugins.get(e)?.plugin}getAllPlugins(){return Array.from(this.plugins.values()).map(e=>e.plugin)}getPluginsByType(e){return this.getAllPlugins().filter(t=>t.metadata.type===e)}getPluginState(e){return this.plugins.get(e)?.state}getExtensions(e){return this.globalExtensions.get(e)??[]}getEntry(e){const t=this.plugins.get(e);if(!t)throw new Error(`Plugin not found: ${e}`);return t}checkDependencies(e){for(const t of e.dependencies??[])if(!this.plugins.has(t))throw new Error(`Missing dependency: ${t} required by ${e.id}`)}collectExtensions(e){for(const t of Object.values(xe)){const s=e.context.getExtensions(t);if(s.length>0){let n=this.globalExtensions.get(t);n||(n=[],this.globalExtensions.set(t,n)),n.push(...s)}}}removeExtensions(e){for(const t of Object.values(xe)){const s=e.context.getExtensions(t),n=this.globalExtensions.get(t);n&&this.globalExtensions.set(t,n.filter(i=>!s.includes(i)))}}topologicalSort(){const e=[],t=new Set,s=new Set,n=i=>{if(t.has(i))return;if(s.has(i))throw new Error(`Circular dependency detected: ${i}`);s.add(i);const a=this.plugins.get(i);if(a)for(const o of a.plugin.metadata.dependencies??[])n(o);s.delete(i),t.add(i),e.push(i)};for(const i of this.plugins.keys())n(i);return e}emitEvent(e,t){this.kernel.events.emit({type:e,nodeId:null,path:null,timestamp:Date.now(),data:t})}};class Wt{constructor(e,t,s){this.dbName=e,this.schemas=new Map(s.map(n=>[n.name,n])),this.targetVersion=t}name="indexeddb";db=null;schemas;targetVersion;get isConnected(){return this.db!==null}async connect(){if(this.db)return;const e=await this.inspectCurrentDatabase(),t=this.findMissingStores(e.stores);let s=this.targetVersion;t.length>0&&e.version>=this.targetVersion&&(s=e.version+1,console.log(`[IndexedDB] Force upgrade to v${s} for new stores: ${t.join(", ")}`)),this.db=await new Promise((n,i)=>{const a=indexedDB.open(this.dbName,s);a.onerror=()=>i(a.error),a.onsuccess=()=>n(a.result),a.onupgradeneeded=o=>{const r=o.target.result,c=o.oldVersion;console.log(`[IndexedDB] Upgrading from v${c} to v${s}`),this.performMigration(r)}}),this.validateStores()}async inspectCurrentDatabase(){return new Promise(e=>{const t=indexedDB.open(this.dbName);t.onsuccess=()=>{const s=t.result,n=Array.from(s.objectStoreNames),i=s.version;s.close(),e({version:i,stores:n})},t.onerror=()=>{e({version:0,stores:[]})}})}findMissingStores(e){const t=new Set(e),s=[];for(const n of this.schemas.keys())t.has(n)||s.push(n);return s}validateStores(){if(!this.db)return;const e=new Set(Array.from(this.db.objectStoreNames)),t=[];for(const s of this.schemas.keys())e.has(s)||t.push(s);t.length>0&&(console.error(`[IndexedDB] Missing stores after connect: ${t.join(", ")}`),console.error(`[IndexedDB] Existing stores: ${Array.from(e).join(", ")}`),console.error(`[IndexedDB] Required schemas: ${Array.from(this.schemas.keys()).join(", ")}`))}async disconnect(){this.db?.close(),this.db=null}async destroy(){await this.disconnect(),await new Promise((e,t)=>{const s=indexedDB.deleteDatabase(this.dbName);s.onsuccess=()=>e(),s.onerror=()=>t(s.error)})}beginTransaction(e,t){if(!this.db)throw new Error("Database not connected");const s=new Set(Array.from(this.db.objectStoreNames)),n=e.filter(a=>!s.has(a));if(n.length>0)throw console.error(`[IndexedDB] Transaction failed - missing stores: ${n.join(", ")}`),console.error(`[IndexedDB] Available stores: ${Array.from(s).join(", ")}`),new Error(`Object stores not found: ${n.join(", ")}`);const i=this.db.transaction(e,t);return new bn(i,this.schemas)}getCollection(e){if(!this.db)throw new Error("Database not connected");const t=this.schemas.get(e);if(!t)throw new Error(`Unknown collection: ${e}`);if(!this.db.objectStoreNames.contains(e))throw new Error(`Object store not found: ${e}. Available: ${Array.from(this.db.objectStoreNames).join(", ")}`);return new wn(this.db,e,t)}performMigration(e){for(const t of this.schemas.values())if(!e.objectStoreNames.contains(t.name)){console.log(`[IndexedDB] Creating store: ${t.name}`);const s=e.createObjectStore(t.name,{keyPath:t.keyPath,autoIncrement:t.autoIncrement});for(const n of t.indexes)s.createIndex(n.name,n.keyPath,{unique:n.unique,multiEntry:n.multiEntry})}}}class bn{constructor(e,t){this.tx=e,this.schemas=t}getCollection(e){if(!this.schemas.get(e))throw new Error(`Unknown collection: ${e}`);return new Sn(this.tx.objectStore(e))}async commit(){}async abort(){try{this.tx.abort()}catch{}}}class wn{constructor(e,t,s){this.db=e,this.name=t}promisify(e){return new Promise((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})}execute(e,t){const s=this.db.transaction(this.name,e);return this.promisify(t(s.objectStore(this.name)))}async get(e){return this.execute("readonly",t=>t.get(e))}async getAll(){return this.execute("readonly",e=>e.getAll())}async put(e){await this.execute("readwrite",t=>t.put(e))}async delete(e){await this.execute("readwrite",t=>t.delete(e))}async clear(){await this.execute("readwrite",e=>e.clear())}async count(){return this.execute("readonly",e=>e.count())}async getByIndex(e,t){return this.execute("readonly",s=>s.index(e).get(t))}async getAllByIndex(e,t){return this.execute("readonly",s=>s.index(e).getAll(t))}async query(e){return new Promise((t,s)=>{const i=this.db.transaction(this.name,"readonly").objectStore(this.name);let a=i;e.index&&(a=i.index(e.index));let o=null;if(e.range){const{lower:u,upper:g,lowerOpen:p,upperOpen:f}=e.range;u!==void 0&&g!==void 0?o=IDBKeyRange.bound(u,g,p,f):u!==void 0?o=IDBKeyRange.lowerBound(u,p):g!==void 0&&(o=IDBKeyRange.upperBound(g,f))}const r=[],c=e.direction==="prev"?"prev":"next";let d=0;const h=a.openCursor(o,c);h.onsuccess=()=>{const u=h.result;if(!u){t(r);return}if(e.offset&&d<e.offset){d++,u.continue();return}const g=u.value;if((!e.filter||e.filter(g))&&r.push(g),e.limit&&r.length>=e.limit){t(r);return}u.continue()},h.onerror=()=>s(h.error)})}}class Sn{constructor(e){this.store=e}get name(){return this.store.name}promisify(e){return new Promise((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})}async get(e){return this.promisify(this.store.get(e))}async getAll(){return this.promisify(this.store.getAll())}async put(e){await this.promisify(this.store.put(e))}async delete(e){await this.promisify(this.store.delete(e))}async clear(){await this.promisify(this.store.clear())}async count(){return this.promisify(this.store.count())}async getByIndex(e,t){return this.promisify(this.store.index(e).get(t))}async getAllByIndex(e,t){return this.promisify(this.store.index(e).getAll(t))}async query(e){return new Promise((t,s)=>{let n=this.store;e.index&&(n=this.store.index(e.index));let i=null;if(e.range){const{lower:d,upper:h,lowerOpen:u,upperOpen:g}=e.range;d!==void 0&&h!==void 0?i=IDBKeyRange.bound(d,h,u,g):d!==void 0?i=IDBKeyRange.lowerBound(d,u):h!==void 0&&(i=IDBKeyRange.upperBound(h,g))}const a=[],o=e.direction==="prev"?"prev":"next";let r=0;const c=n.openCursor(i,o);c.onsuccess=()=>{const d=c.result;if(!d){t(a);return}if(e.offset&&r<e.offset){r++,d.continue();return}const h=d.value;if((!e.filter||e.filter(h))&&a.push(h),e.limit&&a.length>=e.limit){t(a);return}d.continue()},c.onerror=()=>s(c.error)})}}class En{metadata={id:"vfs-storage-indexeddb",name:"IndexedDB Storage",version:"1.0.0",type:ge.STORAGE,description:"IndexedDB storage adapter for browser environments"};_state=M.REGISTERED;context;get state(){return this._state}async install(e){this.context=e;const t=(s,n)=>new Wt(s.dbName??"vfs_database",s.version??1,n);Z.registerAdapter("indexeddb",t),e.registerExtension(xe.STORAGE_ADAPTER,{type:"indexeddb",factory:t}),e.log.info("IndexedDB storage adapter registered")}async activate(){this._state=M.ACTIVATED}async deactivate(){this._state=M.DEACTIVATED}async uninstall(){Z.unregisterAdapter("indexeddb"),this.context?.log.info("IndexedDB storage adapter unregistered")}}class _n{middlewares=new Map;sortedCache=null;register(e){this.middlewares.set(e.name,e),this.sortedCache=null}async unregister(e){const t=this.middlewares.get(e);return t?(await t.dispose?.(),this.middlewares.delete(e),this.sortedCache=null,!0):!1}get(e){return this.middlewares.get(e)}getAll(){return this.sortedCache||(this.sortedCache=Array.from(this.middlewares.values()).sort((e,t)=>t.priority-e.priority)),this.sortedCache}getForNode(e){return this.getAll().filter(t=>!t.canHandle||t.canHandle(e))}async runValidation(e,t){for(const s of this.getForNode(e))await s.onValidate?.(e,t)}async runBeforeWrite(e,t,s){let n=t;for(const i of this.getForNode(e))i.onBeforeWrite&&(n=await i.onBeforeWrite(e,n,s));return n}async runAfterWrite(e,t,s){const n={};for(const i of this.getForNode(e))i.onAfterWrite&&Object.assign(n,await i.onAfterWrite(e,t,s));return n}async runBeforeDelete(e,t){for(const s of this.getForNode(e))await s.onBeforeDelete?.(e,t)}async runAfterDelete(e,t){for(const s of this.getForNode(e))await s.onAfterDelete?.(e,t)}async runAfterMove(e,t,s,n){for(const i of this.getForNode(e))await i.onAfterMove?.(e,t,s,n)}async runAfterCopy(e,t,s){for(const n of this.getForNode(t))await n.onAfterCopy?.(e,t,s)}async runAfterRead(e,t){let s=t;for(const n of this.getForNode(e))n.onAfterRead&&(s=await n.onAfterRead(e,s));return s}async clear(){await Promise.all(this.getAll().map(e=>e.dispose?.())),this.middlewares.clear(),this.sortedCache=null}}class xn{metadata={id:"vfs-middleware",name:"Middleware System",version:"1.0.0",type:ge.FEATURE,description:"Provides middleware pipeline for VFS operations"};_state=M.REGISTERED;context;registry=new _n;get state(){return this._state}getRegistry(){return this.registry}registerMiddleware(e){this.registry.register(e),this.context?.log.info(`Middleware registered: ${e.name}`)}async unregisterMiddleware(e){const t=await this.registry.unregister(e);return t&&this.context?.log.info(`Middleware unregistered: ${e}`),t}async install(e){this.context=e,e.registerExtension(xe.MIDDLEWARE,this.registry),e.log.info("Middleware system installed")}async activate(){this._state=M.ACTIVATED}async deactivate(){this._state=M.DEACTIVATED}async uninstall(){await this.registry.clear(),this.context?.log.info("Middleware system uninstalled")}}class Cn{storage;constructor(e){this.storage=e.storage}async getTag(e){return this.storage.getCollection("tags").get(e)}async getAllTags(e={}){let t=await this.storage.getCollection("tags").getAll();e.includeEmpty||(t=t.filter(i=>i.refCount>0));const s=e.sortBy??"name",n=e.order??"asc";return t.sort((i,a)=>{let o=0;switch(s){case"name":o=i.name.localeCompare(a.name);break;case"refCount":o=i.refCount-a.refCount;break;case"createdAt":o=i.createdAt-a.createdAt;break}return n==="desc"?-o:o}),e.limit&&(t=t.slice(0,e.limit)),t}async upsertTag(e,t){const s=this.storage.beginTransaction(["tags"],"readwrite");try{const n=s.getCollection("tags");let i=await n.get(e);return i?(t?.color!==void 0&&(i.color=t.color),t?.isProtected!==void 0&&(i.isProtected=t.isProtected)):i={name:e,color:t?.color,refCount:0,createdAt:Date.now(),isProtected:t?.isProtected},await n.put(i),await s.commit(),i}catch(n){throw await s.abort(),n}}async deleteTag(e){const t=await this.getTag(e);if(!t)return!1;if(t.isProtected)throw new x(T.PERMISSION_DENIED,`Tag '${e}' is protected`);const s=this.storage.beginTransaction(["tags","node_tags"],"readwrite");try{const n=s.getCollection("node_tags"),i=await n.getAllByIndex("tagName",e);for(const a of i)a.id!==void 0&&await n.delete(a.id);return await s.getCollection("tags").delete(e),await s.commit(),!0}catch(n){throw await s.abort(),n}}async addTagToNode(e,t,s){const n=s??this.storage.beginTransaction(["tags","node_tags"],"readwrite"),i=!s;try{const a=n.getCollection("tags"),o=n.getCollection("node_tags");let r=await a.get(t);r||(r={name:t,refCount:0,createdAt:Date.now()}),(await o.query({filter:d=>{const h=d;return h.nodeId===e&&h.tagName===t},limit:1})).length===0&&(await o.put({nodeId:e,tagName:t}),r.refCount=(r.refCount||0)+1,await a.put(r)),i&&await n.commit()}catch(a){throw i&&await n.abort(),a}}async removeTagFromNode(e,t,s){const n=s??this.storage.beginTransaction(["tags","node_tags"],"readwrite"),i=!s;try{const a=n.getCollection("tags"),o=n.getCollection("node_tags"),r=await o.query({filter:c=>{const d=c;return d.nodeId===e&&d.tagName===t}});for(const c of r)c.id!==void 0&&await o.delete(c.id);if(r.length>0){const c=await a.get(t);c&&(c.refCount=Math.max(0,(c.refCount||0)-1),await a.put(c))}i&&await n.commit()}catch(a){throw i&&await n.abort(),a}}async setNodeTags(e,t,s){const n=s??this.storage.beginTransaction(["tags","node_tags"],"readwrite"),i=!s;try{const a=await this.getNodeTags(e,n),o=new Set(t),r=new Set(a);for(const c of o)r.has(c)||await this.addTagToNode(e,c,n);for(const c of r)o.has(c)||await this.removeTagFromNode(e,c,n);i&&await n.commit()}catch(a){throw i&&await n.abort(),a}}async batchSetTags(e){if(e.length===0)return;const t=this.storage.beginTransaction(["tags","node_tags"],"readwrite");try{for(const{nodeId:s,tags:n}of e)await this.setNodeTags(s,n,t);await t.commit()}catch(s){throw await t.abort(),s}}async getNodeTags(e,t){return(await(t?t.getCollection("node_tags"):this.storage.getCollection("node_tags")).getAllByIndex("nodeId",e)).map(i=>i.tagName)}async getNodeIdsByTag(e){return(await this.storage.getCollection("node_tags").getAllByIndex("tagName",e)).map(s=>s.nodeId)}async cleanupNodeTags(e,t){const s=t.getCollection("node_tags"),n=t.getCollection("tags"),i=await s.getAllByIndex("nodeId",e);for(const a of i){a.id!==void 0&&await s.delete(a.id);const o=await n.get(a.tagName);o&&(o.refCount=Math.max(0,(o.refCount||0)-1),await n.put(o))}}}const In=[{name:"tags",keyPath:"name",indexes:[{name:"refCount",keyPath:"refCount"},{name:"createdAt",keyPath:"createdAt"}]},{name:"node_tags",keyPath:"id",autoIncrement:!0,indexes:[{name:"nodeId",keyPath:"nodeId"},{name:"tagName",keyPath:"tagName"},{name:"nodeId_tagName",keyPath:["nodeId","tagName"],unique:!0}]}];class Tn{metadata={id:"vfs-tags",name:"Tags System",version:"1.0.0",type:ge.FEATURE,description:"Provides tagging functionality for VFS nodes"};_state=M.REGISTERED;context;tagManager;unsubscribers=[];get state(){return this._state}getSchemas(){return In}getTagManager(){if(!this.tagManager)throw new Error("TagsPlugin not activated");return this.tagManager}async install(e){this.context=e,e.log.info("Tags plugin installed")}async activate(){if(!this.context)throw new Error("Plugin not installed");this.tagManager=new Cn(this.context.kernel);const e=this.context.events.on(R.NODE_DELETED,async t=>{if(t.nodeId&&t.data){const s=t.data.deletedIds;s?.length&&await this.cleanupDeletedNodesTags(s)}});this.unsubscribers.push(e),this._state=M.ACTIVATED,this.context.log.info("Tags system activated")}async deactivate(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.tagManager=void 0,this._state=M.DEACTIVATED,this.context?.log.info("Tags system deactivated")}async uninstall(){this.context?.log.info("Tags system uninstalled")}async cleanupDeletedNodesTags(e){if(this.tagManager)try{const s=this.context.kernel.storage.beginTransaction(["tags","node_tags"],"readwrite");for(const n of e)await this.tagManager.cleanupNodeTags(n,s);await s.commit()}catch(t){this.context?.log.error("Failed to cleanup tags for deleted nodes",t)}}}class fe{static DIRECTORY_ASSET_NAME=".assets";static getFileAssetPath(e){const t=N.dirname(e),s=N.basename(e);return N.join(t,`.${s}`)}static getDirectoryAssetPath(e){return N.join(e,this.DIRECTORY_ASSET_NAME)}static getAssetPath(e){return e.type===w.FILE?this.getFileAssetPath(e.path):e.type===w.DIRECTORY?this.getDirectoryAssetPath(e.path):null}static getAssetDirName(e){return e.type===w.DIRECTORY?this.DIRECTORY_ASSET_NAME:`.${e.name}`}static isAssetDirectory(e){return e.type!==w.DIRECTORY?!1:e.metadata?.isAssetDir===!0?!0:e.name===this.DIRECTORY_ASSET_NAME||e.name.startsWith(".")}static isAssetFile(e){return e.metadata?.isAsset===!0}static calculateNewAssetPath(e,t){return t===w.DIRECTORY?this.getDirectoryAssetPath(e):this.getFileAssetPath(e)}static extractOwnerPath(e){const t=N.basename(e),s=N.dirname(e);if(t===this.DIRECTORY_ASSET_NAME)return s;if(t.startsWith(".")){const n=t.substring(1);return N.join(s,n)}return null}}class Mn{constructor(e){this.kernel=e,this.storage=e.storage}storage;async createAssetDirectory(e){const t=await this.kernel.getNode(e);if(!t)throw new x(T.NOT_FOUND,`Owner node not found: ${e}`);const n=t.metadata.assetDirId;if(n){const r=await this.kernel.getNode(n);if(r)return r}const i=fe.getAssetPath(t);if(!i)throw new x(T.INVALID_OPERATION,"Cannot create asset directory for this node type");if(await this.kernel.getNodeByPath(i))throw new x(T.ALREADY_EXISTS,`Asset directory exists: ${i}`);const o=this.storage.beginTransaction(["vnodes"],"readwrite");try{const r=t.type===w.DIRECTORY?t.nodeId:t.parentId,c=Oe(),d={isAssetDir:!0,ownerId:t.nodeId},h=Se.create({nodeId:c,parentId:r,name:fe.getAssetDirName(t),type:w.DIRECTORY,path:i,metadata:d}),u={...t.metadata,assetDirId:c};t.metadata=u,t.modifiedAt=Date.now();const g=o.getCollection("vnodes");return await g.put(h),await g.put(t),await o.commit(),h}catch(r){throw await o.abort(),r}}async getAssetDirectory(e){const t=await this.kernel.getNode(e);if(!t)return null;const n=t.metadata.assetDirId;return n?this.kernel.getNode(n):null}async getAssetOwner(e){const t=await this.kernel.getNode(e);if(!t)return null;const n=t.metadata.ownerId;return n?this.kernel.getNode(n):null}async getAssets(e){const t=await this.getAssetDirectory(e);return t?(await this.kernel.readdir(t.nodeId)).filter(n=>n.type===w.FILE).map(n=>({nodeId:n.nodeId,name:n.name,path:n.path,size:n.size,mimeType:n.metadata?.mimeType,createdAt:n.createdAt,modifiedAt:n.modifiedAt})):[]}async createAsset(e,t,s,n){let i=await this.getAssetDirectory(e);i||(i=await this.createAssetDirectory(e));const a=N.join(i.path,t);return this.kernel.createNode({path:a,type:w.FILE,content:s,metadata:{...n,isAsset:!0,ownerId:e}})}async deleteAsset(e){await this.kernel.unlink(e)}async syncMoveAssetDirectory(e,t,s,n){const a=e.metadata.assetDirId;if(!a)return;const o=n.getCollection("vnodes"),r=await o.get(a);if(!r){const u={...e.metadata};delete u.assetDirId,e.metadata=u,await o.put(e);return}const c=r.path,d=fe.calculateNewAssetPath(s,e.type),h=fe.getAssetDirName(e);e.type===w.FILE?r.parentId=e.parentId:r.parentId=e.nodeId,r.name=h,r.path=d,r.modifiedAt=Date.now(),await o.put(r),await this.updateDescendantPaths(r,c,d,n)}async collectAssetNodes(e,t){const s=[],n=new Set;for(const i of e){const a=i.metadata;if(a.isAssetDir)continue;const o=a.assetDirId;if(!o||n.has(o))continue;const c=await(t?t.getCollection("vnodes"):this.storage.getCollection("vnodes")).get(o);if(c){const d=await this.collectDescendants(c,t);for(const h of d)n.has(h.nodeId)||(s.push(h),n.add(h.nodeId))}}return s}async collectDescendants(e,t){const s=[e];if(e.type===w.DIRECTORY){const i=await(t?t.getCollection("vnodes"):this.storage.getCollection("vnodes")).getAllByIndex("parentId",e.nodeId);for(const a of i)s.push(...await this.collectDescendants(a,t))}return s}async updateDescendantPaths(e,t,s,n){const i=n.getCollection("vnodes"),a=await i.getAllByIndex("parentId",e.nodeId);for(const o of a)o.path.startsWith(t)&&(o.path=s+o.path.substring(t.length),o.modifiedAt=Date.now(),await i.put(o),o.type===w.DIRECTORY&&await this.updateDescendantPaths(o,t,s,n))}async syncCopyAssetDirectory(e,t,s,n){const a=e.metadata.assetDirId;if(!a)return;const o=n.getCollection("vnodes"),r=await o.get(a);if(!r)return;const c=await o.get(t);if(!c)return;const d=fe.calculateNewAssetPath(s,e.type),h=e.type===w.DIRECTORY?t:c.parentId,u=await this.recursiveCopyNode(r,h,d,n),g={...c.metadata,assetDirId:u};c.metadata=g,await o.put(c);const p=await o.get(u);if(p){const f={...p.metadata,ownerId:t,isAssetDir:!0};p.metadata=f,await o.put(p)}}async recursiveCopyNode(e,t,s,n){const i=Oe(),a=n.getCollection("vnodes"),o=n.getCollection("contents"),r={...e.metadata};delete r.assetDirId,delete r.ownerId;const c=Se.create({nodeId:i,parentId:t,name:N.basename(s),type:e.type,path:s,size:e.size,metadata:r});if(await a.put(c),e.type===w.FILE&&e.contentRef&&c.contentRef){const d=await this.storage.getCollection("contents").get(e.contentRef);d&&await o.put({contentRef:c.contentRef,nodeId:i,content:d.content,size:d.size,createdAt:Date.now()})}if(e.type===w.DIRECTORY){const d=await a.getAllByIndex("parentId",e.nodeId);for(const h of d){const u=N.join(s,h.name);await this.recursiveCopyNode(h,i,u,n)}}return i}}class kn{metadata={id:"vfs-assets",name:"Assets Management",version:"1.0.0",type:ge.FEATURE,description:"Provides asset directory management for VFS nodes"};_state=M.REGISTERED;context;assetManager;unsubscribers=[];get state(){return this._state}getAssetManager(){if(!this.assetManager)throw new Error("AssetsPlugin not activated");return this.assetManager}async install(e){this.context=e,e.log.info("Assets plugin installed")}async activate(){if(!this.context)throw new Error("Plugin not installed");this.assetManager=new Mn(this.context.kernel);const e=this.context.events.on(R.NODE_MOVED,async s=>{if(s.nodeId&&s.data){const{oldPath:n,newPath:i}=s.data,a=await this.context.kernel.getNode(s.nodeId);if(a)try{const r=this.context.kernel.storage.beginTransaction(["vnodes","contents"],"readwrite");await this.assetManager.syncMoveAssetDirectory(a,n,i,r),await r.commit()}catch(o){this.context?.log.error("Failed to sync asset directory on move",o)}}});this.unsubscribers.push(e);const t=this.context.events.on(R.NODE_COPIED,async s=>{if(s.nodeId&&s.data){const{sourceId:n}=s.data,i=await this.context.kernel.getNode(n);if(i&&s.path)try{const o=this.context.kernel.storage.beginTransaction(["vnodes","contents"],"readwrite");await this.assetManager.syncCopyAssetDirectory(i,s.nodeId,s.path,o),await o.commit()}catch(a){this.context?.log.error("Failed to sync asset directory on copy",a)}}});this.unsubscribers.push(t),this._state=M.ACTIVATED,this.context.log.info("Assets plugin activated")}async deactivate(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.assetManager=void 0,this._state=M.DEACTIVATED,this.context?.log.info("Assets plugin deactivated")}async uninstall(){this.context?.log.info("Assets plugin uninstalled")}}const qe="/__vfs_meta__/modules.json";class An{constructor(e){this.context=e}modules=new Map;syncableModuleNames=new Set;initialized=!1;async initialize(e=[]){this.initialized||(this.syncableModuleNames=new Set(e),await this.ensureMetaModule(),await this.loadRegistry(),this.initialized=!0)}async mount(e,t={}){if(this.modules.has(e)){const r=this.modules.get(e);return t.syncEnabled!==void 0&&r.syncEnabled!==t.syncEnabled&&(r.syncEnabled=t.syncEnabled,r.modifiedAt=Date.now(),await this.saveRegistry()),r}const s=`/${e}`,n=Date.now(),i=t.syncEnabled??this.syncableModuleNames.has(e);let a=await this.context.kernel.getNodeByPath(s);if(a){console.log(`[ModuleManager] Recovering existing module: ${e}`);const r={name:e,rootNodeId:a.nodeId,description:t.description,isProtected:t.isProtected??!1,syncEnabled:i,createdAt:a.createdAt,metadata:t.metadata,modifiedAt:n};return this.modules.set(e,r),await this.saveRegistry(),r}a=await this.context.kernel.createNode({path:s,type:w.DIRECTORY,metadata:{isModuleRoot:!0,moduleName:e}});const o={name:e,rootNodeId:a.nodeId,description:t.description,isProtected:t.isProtected??!1,syncEnabled:i,createdAt:n,metadata:t.metadata,modifiedAt:n};return this.modules.set(e,o),await this.saveRegistry(),this.context.log.info(`Module mounted: ${e} (sync: ${o.syncEnabled})`),o}async unmount(e){const t=this.modules.get(e);if(!t)throw new Error(`Module not found: ${e}`);if(t.isProtected)throw new Error(`Cannot unmount protected module: ${e}`);await this.context.kernel.unlink(t.rootNodeId,!0),this.modules.delete(e),await this.saveRegistry(),this.context.log.info(`Module unmounted: ${e}`)}async updateModule(e,t){const s=this.modules.get(e);if(!s)throw new Error(`Module not found: ${e}`);return t.description!==void 0&&(s.description=t.description),t.isProtected!==void 0&&(s.isProtected=t.isProtected),t.syncEnabled!==void 0&&(s.syncEnabled=t.syncEnabled),s.modifiedAt=Date.now(),await this.saveRegistry(),this.context.log.info(`Module updated: ${e} (sync: ${s.syncEnabled})`),s}isSyncEnabled(e){const t=this.modules.get(e);return t?t.syncEnabled:this.syncableModuleNames.has(e)}getModule(e){return this.modules.get(e)}getAllModules(){return Array.from(this.modules.values())}getSyncEnabledModules(){return this.getAllModules().filter(e=>e.syncEnabled)}getSyncDisabledModules(){return this.getAllModules().filter(e=>!e.syncEnabled)}getModuleNameFromPath(e){const t=e.split("/").filter(Boolean);return t.length>0?t[0]:null}isPathSyncEnabled(e){const t=this.getModuleNameFromPath(e);return t?this.isSyncEnabled(t):!1}async ensureDefaultModule(e,t=[]){for(const i of t)this.syncableModuleNames.add(i);const s=this.modules.get(e);if(s){const i=t.includes(e);return s.syncEnabled!==i&&(s.syncEnabled=i,s.modifiedAt=Date.now(),await this.saveRegistry(),this.context.log.info(`Module sync status updated: ${e} (sync: ${i})`)),s}const n=t.includes(e);return this.mount(e,{description:"Default module",syncEnabled:n})}async ensureMetaModule(){const e="/__vfs_meta__";await this.context.kernel.getNodeByPath(e)||await this.context.kernel.createNode({path:e,type:w.DIRECTORY,metadata:{isSystemModule:!0}})}async loadRegistry(){try{const e=await this.context.kernel.getNodeByPath(qe);if(e){const t=await this.context.kernel.read(e.nodeId),s=JSON.parse(typeof t=="string"?t:new TextDecoder().decode(t));for(const n of s.modules||[])this.syncableModuleNames.has(n.name)?n.syncEnabled=!0:n.syncEnabled===void 0&&(n.syncEnabled=!1),this.modules.set(n.name,n)}}catch(e){this.context.log.warn("Failed to load modules registry",e)}}async saveRegistry(){const e={version:2,modules:Array.from(this.modules.values())},t=JSON.stringify(e,null,2),s=await this.context.kernel.getNodeByPath(qe);s?await this.context.kernel.write(s.nodeId,t):await this.context.kernel.createNode({path:qe,type:w.FILE,content:t})}}class Ln{metadata={id:"vfs-modules",name:"Module Management",version:"1.0.0",type:ge.FEATURE,description:"Provides module-based namespace management for VFS"};_state=M.REGISTERED;context;moduleManager;get state(){return this._state}getModuleManager(){if(!this.moduleManager)throw new Error("ModulesPlugin not activated");return this.moduleManager}async install(e){this.context=e,e.log.info("Modules plugin installed")}async activate(){if(!this.context)throw new Error("Plugin not installed");this.moduleManager=new An(this.context),await this.moduleManager.initialize(),this._state=M.ACTIVATED,this.context.log.info("Modules plugin activated")}async deactivate(){this.moduleManager=void 0,this._state=M.DEACTIVATED,this.context?.log.info("Modules plugin deactivated")}async uninstall(){this.context?.log.info("Modules plugin uninstalled")}}class ot{constructor(e,t){this.moduleName=e,this.vfs=t}async init(){this.vfs.getModule(this.moduleName)||await this.vfs.mount(this.moduleName)}async loadTree(){const e=this.vfs.getModule(this.moduleName);if(!e)throw new Error(`Module ${this.moduleName} not found`);return(await this.buildTree(e.rootNodeId)).children??[]}async buildTree(e){const t=await this.vfs.getNodeById(e);if(!t)throw new Error(`Node ${e} not found`);const s=this.toEngineNode(t);if(t.type===w.FILE)s.content=await this.vfs.kernel.read(e);else{const i=(await this.vfs.kernel.readdir(e)).filter(a=>!a.metadata?.isAssetDir);s.children=await Promise.all(i.map(a=>this.buildTree(a.nodeId)))}return s}async getChildren(e){return(await this.vfs.kernel.readdir(e)).filter(s=>!s.metadata?.isAssetDir).map(s=>this.toEngineNode(s))}async readContent(e){return this.vfs.kernel.read(e)}async getNode(e){const t=await this.vfs.getNodeById(e);return t?this.toEngineNode(t):null}async search(e){const t=this.vfs.getModule(this.moduleName);if(!t)return[];const s=[],n=e.limit??50;return await this.searchRecursive(t.rootNodeId,e,s,n),s}async searchRecursive(e,t,s,n){if(s.length>=n)return;const i=await this.vfs.getNodeById(e);if(!i||i.metadata?.isAssetDir)return;const a=i.type===w.DIRECTORY?"directory":"file",o=!t.type||a===t.type,r=!t.text||i.name.toLowerCase().includes(t.text.toLowerCase());let c=!0;if(t.tags?.length){const d=await this.vfs.getNodeTags(e);c=t.tags.every(h=>d.includes(h))}if(o&&r&&c&&s.push(this.toEngineNode(i)),i.type===w.DIRECTORY){const d=await this.vfs.kernel.readdir(e);for(const h of d)await this.searchRecursive(h.nodeId,t,s,n)}}async getAllTags(){return(await this.vfs.getAllTags()).map(t=>({name:t.name,color:t.color}))}async createFile(e,t,s="",n){const i=await this.resolveParentPath(t),a=N.join(i,e),o=await this.vfs.createFile(this.moduleName,a,s,n),r=this.toEngineNode(o);return r.content=s,r}async createDirectory(e,t,s){const n=await this.resolveParentPath(t),i=N.join(n,e),a=await this.vfs.createDirectory(this.moduleName,i,s),o=this.toEngineNode(a);return o.children=[],o}async createAsset(e,t,s){const n=await this.vfs.createAsset(e,t,s);return this.toEngineNode(n)}async getAssetDirectoryId(e){return(await this.vfs.getAssetDirectory(e))?.nodeId??null}async getAssets(e){return(await this.vfs.getAssets(e)).map(s=>({id:s.nodeId,parentId:null,name:s.name,type:"file",path:s.path,size:s.size,createdAt:s.createdAt,modifiedAt:s.modifiedAt,metadata:{mimeType:s.mimeType}}))}async writeContent(e,t){await this.vfs.kernel.write(e,t)}async rename(e,t){const s=await this.vfs.getNodeById(e);if(!s)throw new Error(`Node not found: ${e}`);const n=N.dirname(s.path),i=N.join(n,t);await this.vfs.kernel.move(e,i)}async move(e,t){for(const s of e){const n=await this.vfs.getNodeById(s);if(!n||n.metadata?.isAssetDir)continue;let i;if(t){const a=await this.vfs.getNodeById(t);if(!a)continue;i=N.join(a.path,n.name)}else i=`/${this.moduleName}/${n.name}`;await this.vfs.kernel.move(s,i)}}async delete(e){for(const t of e)await this.vfs.kernel.unlink(t,!0)}async updateMetadata(e,t){await this.vfs.updateMetadata(e,t)}async setTags(e,t){await this.vfs.setTags(e,t)}async setTagsBatch(e){await this.vfs.batchSetTags(e.map(t=>({nodeId:t.id,tags:t.tags})))}on(e,t){const s=`/${this.moduleName}`,n=[],i=r=>{if(!r)return!0;if(!r.startsWith(s))return!1;const c=r.slice(s.length);return!c.startsWith("/.")&&!c.includes("/.")},a=[["node:created","node:created"],["node:updated","node:updated"],["node:deleted","node:deleted"],["node:moved","node:moved"]];for(const[r,c]of a){const d=this.vfs.on(r,h=>{i(h.path)&&t({type:c,payload:h})});n.push(d)}const o=this.vfs.onAny((r,c)=>{if(r.toString().includes("batch")){const d=r.toString().replace("nodes:","node:");t({type:d,payload:c.data})}});return n.push(o),()=>n.forEach(r=>r())}async resolvePath(e){let t=e;return e.startsWith("/")&&!e.startsWith(`/${this.moduleName}/`)&&e!==`/${this.moduleName}`&&(t=`/${this.moduleName}${e}`),this.vfs.kernel.resolvePathToId(t)}async pathExists(e){return await this.resolvePath(e)!==null}toEngineNode(e){const t=e.type===w.DIRECTORY?"directory":"file";return{id:e.nodeId,parentId:e.parentId,name:e.name,type:t,path:e.path,size:e.size,createdAt:e.createdAt,modifiedAt:e.modifiedAt,tags:e.metadata?.tags??[],metadata:e.metadata,moduleId:this.extractModuleId(e.path),icon:e.metadata?.icon,assetDirId:e.metadata?.assetDirId}}extractModuleId(e){const t=e.split("/").filter(Boolean);return t.length>0?t[0]:void 0}async resolveParentPath(e){if(!e)return"/";if(e.startsWith("/"))return e;const t=await this.vfs.getNodeById(e);if(!t)throw new Error(`Parent node not found: ${e}`);const s=`/${this.moduleName}`;let n=t.path;return n.startsWith(s)&&(n=n.substring(s.length)),n.startsWith("/")?n:"/"+n}}class Kt{constructor(e,t={},s){this.moduleName=e,this.options=t,this.vfs=s,this.engine=new ot(e,s)}engine;initialized=!1;listeners=new Set;async init(){this.initialized||(await this.engine.init(),await this.onLoad(),this.initialized=!0,this.notify())}get isInitialized(){return this.initialized}async readJson(e){try{const t=await this.vfs.read(this.moduleName,e),s=typeof t=="string"?t:new TextDecoder().decode(t);return JSON.parse(s)}catch(t){return t.message?.toLowerCase().includes("not found")||t.code==="NOT_FOUND"||console.warn(`[${this.constructor.name}] Failed to read ${e}:`,t),null}}async writeJson(e,t){const s=JSON.stringify(t,null,2),n=await this.engine.resolvePath(e);if(n)await this.engine.writeContent(n,s);else{const i=e.lastIndexOf("/"),a=i>0?e.slice(0,i):null,o=e.slice(i+1);a&&a!=="/"&&await this.ensureDirectory(a),await this.engine.createFile(o,a,s)}}async ensureDirectory(e){const t=`/${this.moduleName}${e.startsWith("/")?e:"/"+e}`;await this.vfs.kernel.ensureDirectory(t)}async deleteFile(e){try{const t=await this.engine.resolvePath(e);t&&await this.engine.delete([t])}catch(t){console.warn(`[${this.constructor.name}] Delete failed: ${e}`,t)}}async fileExists(e){return this.engine.pathExists(e)}onChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>{try{e()}catch(t){console.error("Change listener error:",t)}})}async dispose(){this.listeners.clear(),this.initialized=!1}}class rt{constructor(){if(this.constructor===rt)throw new Error("IEditor is an interface and cannot be instantiated directly.")}async pruneAssets(){return null}async getHeadings(){return[]}async getSearchableText(){return this.getText().replace(/^#+\s/gm,"").replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/```[\s\S]*?```/g,"").replace(/`[^`]+`/g,"").trim()}async getSummary(){return null}}class Ue{constructor(){if(this.constructor===Ue)throw new Error("IAutocompleteSource is an interface and cannot be instantiated directly.")}}class Nn extends Ue{triggerChar="@";async getDataForProcess(e){return null}async handleClick(e){console.log(`[IMentionSource:${this.key}] Clicked:`,e.toString())}async getHoverPreview(e){return null}async getContentForTransclusion(e){return null}}class lt{constructor(){if(this.constructor===lt)throw new Error("ISessionUI is an interface and cannot be instantiated directly.")}}function S(l){if(!l)return"";const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return l.replace(/[&<>"']/g,t=>e[t]||t)}function F(){return"node-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}function Ce(){return Math.random().toString(36).substring(2,10)}function Dn(l,e){let t;const s=function(...n){clearTimeout(t);const i=this;t=setTimeout(()=>l.apply(i,n),e)};return s.cancel=()=>clearTimeout(t),s}function Ie(l){const e=l.split(".").pop()?.toLowerCase();return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",bmp:"image/bmp",ico:"image/x-icon",pdf:"application/pdf",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",txt:"text/plain",md:"text/markdown",json:"application/json",js:"text/javascript",ts:"text/typescript",py:"text/x-python",html:"text/html",css:"text/css",xml:"application/xml",yaml:"text/yaml",yml:"text/yaml",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm",zip:"application/zip",gz:"application/gzip",tar:"application/x-tar",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed"}[e||""]||"application/octet-stream"}function $n(l){const e=new Uint8Array(l);let t="";for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(e[s]);return btoa(t)}function Tt(l){const e=atob(l),t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t.buffer}class Rn{id="markdown-analyzer";supportedExtensions;supportedMimeTypes=new Set(["text/markdown","text/plain"]);constructor(e=[".md",".markdown",".mdx",".txt"]){this.supportedExtensions=new Set(e.map(t=>t.startsWith(".")?t:`.${t}`))}supports(e){const t=e.filename.lastIndexOf(".");if(t!==-1){const s=e.filename.substring(t).toLowerCase();if(this.supportedExtensions.has(s))return!0}return!!(e.mimeType&&this.supportedMimeTypes.has(e.mimeType))}async analyze(e,t){const s=typeof e=="string"?e:new TextDecoder().decode(e),n=new Set;return this.extractAssetProtocolRefs(s,n),this.extractSidecarRefs(s,t.filePath,n),this.extractRelativePathRefs(s,n),{references:Array.from(n)}}extractAssetProtocolRefs(e,t){const s=/@asset\/([^\s)"']+)/g;let n;for(;(n=s.exec(e))!==null;){const i=this.extractFilename(n[1]);i&&t.add(i)}}extractSidecarRefs(e,t,s){const n=t.split("/").pop();if(!n)return;const a=`.${n}`.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=[new RegExp(`\\]\\(\\s*${a}\\/([^)\\s]+)`,"g"),new RegExp(`(?:src|href)=["']${a}\\/([^"']+)["']`,"g")];for(const r of o){let c;for(;(c=r.exec(e))!==null;)try{const d=decodeURIComponent(c[1]),h=this.extractFilename(d);h&&s.add(h)}catch{const d=this.extractFilename(c[1]);d&&s.add(d)}}}extractRelativePathRefs(e,t){const s=/\]\(\s*(?:\.\/)?([^)\s"']+)\s*(?:"[^"]*")?\s*\)/g;let n;for(;(n=s.exec(e))!==null;){const a=n[1];if(this.shouldSkipPath(a))continue;const o=this.extractFilename(a);o&&t.add(o)}const i=/(?:src|href)=["'](?:\.\/)?([^"']+)["']/g;for(;(n=i.exec(e))!==null;){const a=n[1];if(this.shouldSkipPath(a))continue;const o=this.extractFilename(a);o&&t.add(o)}}shouldSkipPath(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("javascript:")||e.startsWith("#")||e.startsWith("/")}extractFilename(e){if(!e)return null;const s=e.split("?")[0].split("#")[0].split("/").pop();return!s||s==="."||s===".."?null:s}}function ct(l){return typeof l!="string"?"":l.toLowerCase().trim().replace(/[\s\-_]+/g,"-").replace(/[^\w\u4e00-\u9fa5-]/g,"").replace(/^-+|-+$/g,"")}function Te(l){if(!l)return null;const e=l.trim();if(!e.startsWith("{")&&!e.startsWith("[")||e.startsWith("{")&&!e.endsWith("}")||e.startsWith("[")&&!e.endsWith("]"))return null;try{return JSON.parse(e)}catch{return null}}function Be(l){const e=l.split(`
`),t=[];let s=!1,n="",i=0;for(const o of e){const r=o.match(/^(`{3,}|~{3,})/);if(r){const c=r[1].charAt(0),d=r[1].length;s?c===n&&d>=i&&o.trim()===r[1]&&(s=!1,n="",i=0):(s=!0,n=c,i=d);continue}s||t.push(o)}const a=t.join(`
`).replace(/`[^`\n]+`/g,"");return{allLines:e,linesOutsideCode:t,textOutsideCode:a}}function Qt(l,e={}){const{nested:t=!1}=e,{linesOutsideCode:s}=Be(l),n=[],i=new Map,a=[];for(const o of s){const r=o.match(/^(#{1,6})\s+(.+)/);if(!r)continue;const c=parseInt(r[1].length.toString()),d=r[2].trim();if(!d)continue;const u=`heading-${ct(d)}`,g=i.get(u)||0;i.set(u,g+1);const p=g>0?`${u}-${g}`:u,f={level:c,text:d,id:p,children:[]};if(t){for(;a.length>0&&a[a.length-1].level>=c;)a.pop();a.length===0?n.push(f):a[a.length-1].children.push(f),a.push(f)}else n.push(f)}return n}function Jt(l,e={}){const{textOutsideCode:t}=Be(l);let s=0,n=0;const i=/(?:^|[\s|])(?:[-+*]|\d+\.)?\s*\[([ xX])\]/gm,a=[...t.matchAll(i)];s+=a.length,n+=a.filter(c=>c[1].toLowerCase()==="x").length;const o=/<input[^>]+type=["']checkbox["'][^>]*>/gi,r=[...t.matchAll(o)];s+=r.length;for(const c of r)/\bchecked\b/i.test(c[0])&&n++;return{total:s,completed:n}}function Yt(l,e=150){const t=Te(l);if(t&&typeof t=="object"){const n=t;if(typeof n.description=="string")return n.description;if(typeof n.summary=="string")return n.summary;if(Array.isArray(n.pairs)&&n.pairs.length>0){const i=n.pairs[0];if(typeof i.human=="string")return i.human}return null}const{linesOutsideCode:s}=Be(l);for(const n of s){const i=n.trim();if(!i||/^#{1,6}\s/.test(i)||/^[-*_]{3,}$/.test(i)||i==="---")continue;const a=i.replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/!\[.*?\]\(.*?\)/g,"").replace(/[*_~`]/g,"").trim();if(a)return a.length>e?a.substring(0,e)+"":a}return null}function Xt(l){const e=Te(l);if(e&&typeof e=="object"){const s=e,n=[];if(typeof s.name=="string"&&n.push(s.name),typeof s.title=="string"&&n.push(s.title),typeof s.description=="string"&&n.push(s.description),typeof s.summary=="string"&&n.push(s.summary),Array.isArray(s.pairs))for(const i of s.pairs)typeof i.human=="string"&&n.push(i.human),typeof i.ai=="string"&&n.push(i.ai);return n.join(`
`)}const{linesOutsideCode:t}=Be(l);return t.join(`
`).replace(/^#{1,6}\s+/gm,"").replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/!\[.*?\]\(.*?\)/g,"").replace(/`[^`\n]+`/g,"").replace(/[*_~]+/g,"").replace(/^\s*[-+*]\s+/gm,"").replace(/^\s*\d+\.\s+/gm,"").replace(/^\s*>\s+/gm,"").replace(/\|/g," ").replace(/\s+/g," ").trim()}function Pn(l){const e=l.match(/--/g)||[];return Math.floor(e.length/2)}function On(l){return(l.match(/```mermaid/gi)||[]).length}const Fn={extractHeadings:!0,extractSummary:!0,extractTasks:!0,extractSearchable:!0,summaryMaxLength:150,debug:!1};function Un(l,e={}){const t={...Fn,...e};if(!l||typeof l!="string")return{headings:[],summary:null,searchableText:"",taskCounts:null,clozeCount:0,mermaidCount:0};const s={headings:[],summary:null,searchableText:"",taskCounts:null,clozeCount:0,mermaidCount:0};if(t.extractHeadings&&(s.headings=Qt(l,{nested:!0})),t.extractSummary&&(s.summary=Yt(l,t.summaryMaxLength)),t.extractSearchable&&(s.searchableText=Xt(l)),t.extractTasks){const n=Jt(l,{});n.total>0&&(s.taskCounts=n)}return s.clozeCount=Pn(l),s.mermaidCount=On(l),s}function Bn(l){if(Array.isArray(l))return`[List: ${l.length} items]`;if(typeof l!="object"||l===null)return String(l);const e=Object.keys(l),t=[],s=["title","name","description","desc","summary","type","id","status"],n=e.sort((i,a)=>{const o=s.indexOf(i),r=s.indexOf(a);return o>-1&&r>-1?o-r:o>-1?-1:r>-1?1:i.localeCompare(a)});for(const i of n){if(t.length>=4)break;const a=l[i];typeof a=="string"?t.push(`${i}: ${a.length>30?a.substring(0,30)+"...":a}`):typeof a=="number"||typeof a=="boolean"?t.push(`${i}: ${a}`):Array.isArray(a)?t.push(`${i}: [${a.length}]`):a===null&&t.push(`${i}: null`)}return t.length>0?t.join(" | "):"{ ... }"}class pe{constructor(e,t,s){this.service=t,this.options=s,this.container=e}listeners=[];container;hostContext;async init(e,t){if(this.container=e,this.container.classList.add("settings-root"),this.options.hostContext&&(this.hostContext=this.options.hostContext),this.service&&typeof this.service.onChange=="function"){const s=this.service.onChange(()=>this.render()),n=this.destroy;this.destroy=async()=>{s(),await n.call(this)}}await this.render()}toggleSidebar(){this.hostContext?.toggleSidebar()}focus(){}addEventListener(e,t,s){e&&(e.addEventListener(t,s),this.listeners.push({el:e,type:t,handler:s}))}clearListeners(){this.listeners.forEach(e=>e.el.removeEventListener(e.type,e.handler)),this.listeners=[]}async destroy(){this.clearListeners(),this.container.innerHTML=""}getText(){return""}setText(e){}getMode(){return"render"}async switchToMode(e){}setTitle(e){}setReadOnly(e){}isDirty(){return!1}setDirty(e){}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return""}async getSummary(){return null}async navigateTo(e){}async search(e){return[]}gotoMatch(e){}clearSearch(){}async pruneAssets(){return null}on(e,t){return()=>{}}}class O{constructor(e,t,s={}){this.title=e,this.contentHTML=t,this.options=s,this.options={confirmText:"",cancelText:"",type:"default",...s}}element=null;show(){const e=document.createElement("div");e.className="settings-modal-overlay",e.innerHTML=`
            <div class="settings-modal">
                <div class="settings-modal__header">
                    <h3>${this.title}</h3>
                    <button class="settings-modal-close" aria-label="Close">&times;</button>
                </div>
                <div class="settings-modal__body">${this.contentHTML}</div>
                <div class="settings-modal__footer">
                    <button class="settings-btn settings-btn--secondary settings-modal-cancel">${this.options.cancelText}</button>
                    <button class="settings-btn ${this.options.type==="danger"?"settings-btn--danger":"settings-btn--primary"} settings-modal-confirm">${this.options.confirmText}</button>
                </div>
            </div>
        `,document.body.appendChild(e),this.element=e;const t=()=>this.hide();e.querySelector(".settings-modal-close")?.addEventListener("click",t),e.querySelector(".settings-modal-cancel")?.addEventListener("click",t),e.querySelector(".settings-modal-confirm")?.addEventListener("click",async()=>{this.options.onConfirm&&await this.options.onConfirm()===!1||this.hide()}),e.addEventListener("click",s=>{s.target===e&&t()}),requestAnimationFrame(()=>e.classList.add("show"))}hide(){this.element&&(this.element.classList.remove("show"),setTimeout(()=>{this.element?.remove(),this.options.onCancel?.()},300))}static confirm(e,t,s){new O(e,`<p>${t}</p>`,{type:"danger",confirmText:"",onConfirm:s}).show()}}class m{static show(e,t="info",s=3e3){const n=document.createElement("div");n.className=`settings-toast settings-toast--${t}`;const i={success:'<i class="fas fa-check-circle"></i>',error:'<i class="fas fa-times-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',info:'<i class="fas fa-info-circle"></i>'};n.innerHTML=`
            <span class="settings-toast__icon">${i[t]}</span>
            <span class="settings-toast__message">${e}</span>
        `;let a=document.querySelector(".settings-toast-container");a||(a=document.createElement("div"),a.className="settings-toast-container",document.body.appendChild(a)),a.appendChild(n),requestAnimationFrame(()=>n.classList.add("show")),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},s)}static success(e){this.show(e,"success")}static error(e){this.show(e,"error")}static warning(e){this.show(e,"warning")}static info(e){this.show(e,"info")}}async function Zt(l){return new Promise(e=>{let t=!1;new O("Confirmation",`<p>${S(l)}</p>`,{type:"danger",confirmText:"Delete",cancelText:"Cancel",onConfirm:()=>(t||(t=!0,e(!0)),!0),onCancel:()=>(t||(t=!0,e(!1)),!0)}).show()})}const Hn={OPEN_AGENT_CONFIG:"app:navigate:agent-config",OPEN_CONNECTION_SETTINGS:"app:navigate:connection-settings",OPEN_MCP_SETTINGS:"app:navigate:mcp-settings",CREATE_CHAT_SESSION:"app:navigate:create-chat",NAVIGATE:"app:navigate"},es="chats",dt="agents",zn=["interval","repetition","efactor","ease","due","dueDate","lastReview","nextReview","reviewCount","lapses","stability","difficulty","state","scheduledDays"],qn=["At","Time","Date"];class Vn{srsFields;timestampPatterns;constructor(e={}){this.srsFields=new Set(e.srsFields??zn),this.timestampPatterns=e.timestampFields??qn}merge(e,t){const s={...e};for(const[n,i]of Object.entries(t)){const a=e[n];s[n]=this.mergeValue(n,a,i)}return s}mergeValue(e,t,s){return this.isSRSField(e)?this.mergeSRSValue(e,t,s):this.isTimestampField(e)?this.mergeTimestamp(t,s):Array.isArray(t)&&Array.isArray(s)?[...new Set([...t,...s])]:this.isPlainObject(t)&&this.isPlainObject(s)?this.merge(t,s):s}isSRSField(e){return this.srsFields.has(e)||e.startsWith("srs")||e.startsWith("fsrs")}isTimestampField(e){return["createdAt","modifiedAt","updatedAt","lastAccess","lastModified","timestamp"].includes(e)?!0:this.timestampPatterns.some(s=>e.endsWith(s))}mergeSRSValue(e,t,s){if(["reviewCount","repetition","lapses"].includes(e))return Math.max(typeof t=="number"?t:0,typeof s=="number"?s:0);if(["due","dueDate","nextReview","lastReview"].includes(e)){const n=this.toTimestamp(t),i=this.toTimestamp(s);return n>i?t:s}return s}mergeTimestamp(e,t){const s=this.toTimestamp(e),n=this.toTimestamp(t);return Math.max(s,n)}toTimestamp(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Date.parse(e);return isNaN(t)?0:t}return e instanceof Date?e.getTime():0}isPlainObject(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}}const jn=new Vn;class Gn{constructor(e){this.instance=e}get kernel(){return this.instance.kernel}get events(){return this.instance.events}getPlugin(e){return this.instance.getPlugin(e)}get modules(){return this.getPlugin("vfs-modules")}async mount(e,t){const s=this.modules?.getModuleManager();if(!s)throw new Error("Modules plugin not available");return s.mount(e,t)}async unmount(e){const t=this.modules?.getModuleManager();if(!t)throw new Error("Modules plugin not available");return t.unmount(e)}getModule(e){return this.modules?.getModuleManager().getModule(e)}getAllModules(){return this.modules?.getModuleManager().getAllModules()??[]}async createFile(e,t,s="",n){return this.kernel.createNode({path:this.toSystemPath(e,t),type:w.FILE,content:s,metadata:n})}async createDirectory(e,t,s){return this.kernel.createNode({path:this.toSystemPath(e,t),type:w.DIRECTORY,metadata:s})}async read(e,t){const s=await this.resolvePath(e,t);if(!s)throw new Error(`File not found: ${t}`);return this.kernel.read(s)}async write(e,t,s){const n=await this.resolvePath(e,t);if(!n)throw new Error(`File not found: ${t}`);return this.kernel.write(n,s)}async readdir(e,t){const s=await this.resolvePath(e,t);if(!s)throw new Error(`Directory not found: ${t}`);return this.kernel.readdir(s)}async delete(e,t,s=!1){const n=await this.resolvePath(e,t);return n?this.kernel.unlink(n,s):[]}async move(e,t,s){const n=await this.resolvePath(e,t);if(!n)throw new Error(`Node not found: ${t}`);return this.kernel.move(n,this.toSystemPath(e,s))}async copy(e,t,s){const n=await this.resolvePath(e,t);if(!n)throw new Error(`Source not found: ${t}`);return this.kernel.copy(n,this.toSystemPath(e,s))}async rename(e,t,s){const n=await this.resolvePath(e,t);if(!n)throw new Error(`Node not found: ${t}`);const i=await this.kernel.getNode(n);if(!i)throw new Error(`Node not found: ${t}`);const a=N.dirname(i.path);return this.kernel.move(n,N.join(a,s))}async getNode(e,t){return this.kernel.getNodeByPath(this.toSystemPath(e,t))}async getNodeById(e){return this.kernel.getNode(e)}async updateMetadata(e,t){const s=await this.kernel.getNode(e);if(!s)throw new Error(`Node not found: ${e}`);s.metadata={...s.metadata,...t},s.modifiedAt=Date.now();const n=this.kernel.storage.beginTransaction(["vnodes"],"readwrite");return await n.getCollection("vnodes").put(s),await n.commit(),s}get tags(){return this.getPlugin("vfs-tags")}async getAllTags(){return this.tags?.getTagManager().getAllTags()??[]}async addTag(e,t){const s=this.tags?.getTagManager();if(!s)throw new Error("Tags plugin not available");await s.addTagToNode(e,t)}async removeTag(e,t){const s=this.tags?.getTagManager();if(!s)throw new Error("Tags plugin not available");await s.removeTagFromNode(e,t)}async setTags(e,t){const s=this.tags?.getTagManager();if(!s)throw new Error("Tags plugin not available");await s.setNodeTags(e,t)}async batchSetTags(e){const t=this.tags?.getTagManager();if(!t)throw new Error("Tags plugin not available");await t.batchSetTags(e)}async getNodeTags(e){return this.tags?.getTagManager().getNodeTags(e)??[]}async findByTag(e){return this.tags?.getTagManager().getNodeIdsByTag(e)??[]}async updateTagDefinition(e,t){const s=this.tags?.getTagManager();if(!s)throw new Error("Tags plugin not available");await s.upsertTag(e,t)}get assets(){return this.getPlugin("vfs-assets")}async createAssetDirectory(e){const t=this.assets?.getAssetManager();if(!t)throw new Error("Assets plugin not available");return t.createAssetDirectory(e)}async getAssetDirectory(e){return this.assets?.getAssetManager().getAssetDirectory(e)??null}async createAsset(e,t,s,n){const i=this.assets?.getAssetManager();if(!i)throw new Error("Assets plugin not available");return i.createAsset(e,t,s,n)}async getAssets(e){return this.assets?.getAssetManager().getAssets(e)??[]}get middleware(){return this.getPlugin("vfs-middleware")}registerMiddleware(e){const t=this.middleware;if(!t)throw new Error("Middleware plugin not available");t.registerMiddleware(e)}async unregisterMiddleware(e){return this.middleware?.unregisterMiddleware(e)??!1}on(e,t){return this.events.on(e,t)}onAny(e){return this.events.onAny(e)}async exportModule(e){const t=this.getModule(e);if(!t)throw new Error(`Module not found: ${e}`);const s=await this.kernel.getNode(t.rootNodeId);if(!s)throw new Error("Root node not found");return{module:t,tree:await this.exportTree(s),exportedAt:Date.now(),version:2}}async createBackup(){const e={version:1,timestamp:Date.now(),modules:[]};for(const t of this.getAllModules())if(!(t.isProtected&&t.name==="__vfs_meta__"))try{const s=await this.exportModule(t.name);e.modules.push(s)}catch(s){console.warn(`Skipping module ${t.name}:`,s)}return JSON.stringify(e,null,2)}async importModule(e,t={}){const{conflictStrategy:s="rename-old",mergeMetadata:n=!0,metadataMerger:i=jn}=t,a=e.module;this.getModule(a.name)?console.log(`[VFS] Module ${a.name} already exists, performing incremental import`):await this.mount(a.name,{description:a.description,isProtected:a.isProtected}),await this.importTreeIncremental(a.name,"/",e.tree,{conflictStrategy:s,mergeMetadata:n,metadataMerger:i})}async restoreBackup(e,t={}){const s=JSON.parse(e);for(const n of s.modules)try{await this.importModule(n,t)}catch(i){console.error(`Failed to restore ${n?.module?.name}:`,i)}}isModuleSyncEnabled(e){const t=this.modules?.getModuleManager();return t?t.isSyncEnabled(e):!0}getSyncEnabledModules(){return this.modules?.getModuleManager().getSyncEnabledModules()??[]}getSyncDisabledModules(){return this.modules?.getModuleManager().getSyncDisabledModules()??[]}async shutdown(){await this.instance.shutdown()}toSystemPath(e,t){const s=N.normalize(t);return s==="/"?`/${e}`:`/${e}${s}`}async resolvePath(e,t){return this.kernel.resolvePathToId(this.toSystemPath(e,t))}async exportTree(e){const t={name:e.name,type:e.type,metadata:e.metadata};if(this.isAssetDirectory(e.name,e.path)&&(t.isAssetDirectory=!0),e.type===w.FILE){const s=await this.kernel.read(e.nodeId);s instanceof ArrayBuffer?(t.content=$n(s),t.contentEncoding="base64"):t.content=s}else{const s=await this.kernel.readdir(e.nodeId);t.children=await Promise.all(s.map(n=>this.exportTree(n)))}return this.tags&&(t.tags=await this.tags.getTagManager().getNodeTags(e.nodeId)),t}async importTreeIncremental(e,t,s,n){if(s.name==="/"||t==="/"&&s.name===e){for(const c of s.children??[])await this.importTreeIncremental(e,"/",c,n);return}const i=t==="/"?`/${s.name}`:`${t}/${s.name}`,a=await this.getNode(e,i),o=this.isAssetDirectory(s.name,i);let r;if(a?r=await this.handleConflict(e,i,a,s,{...n,isAsset:o}):r=await this.createNodeFromData(e,i,s),s.type===w.DIRECTORY&&s.children)for(const c of s.children)await this.importTreeIncremental(e,i,c,n);if(s.tags?.length&&this.tags){const c=await this.tags.getTagManager().getNodeTags(r.nodeId),d=[...new Set([...c,...s.tags])];await this.tags.getTagManager().setNodeTags(r.nodeId,d)}}async handleConflict(e,t,s,n,i){const{conflictStrategy:a,mergeMetadata:o,metadataMerger:r,isAsset:c}=i;if(c&&s.type===w.DIRECTORY)return s;if(s.type===w.DIRECTORY&&n.type===w.DIRECTORY){if(o&&n.metadata){const d=r.merge(s.metadata,n.metadata);return await this.updateMetadata(s.nodeId,d),{...s,metadata:d}}return s}if(s.type!==n.type)return console.warn(`[VFS] Type mismatch at ${t}: existing=${s.type}, incoming=${n.type}`),this.handleRenameOld(e,t,s,n);switch(a){case"skip":return console.log(`[VFS] Skipping existing file: ${t}`),s;case"overwrite":return this.handleOverwrite(e,t,s,n,o,r);case"rename-old":return this.handleRenameOld(e,t,s,n);case"merge":if(n.metadata){const d=r.merge(s.metadata,n.metadata);await this.updateMetadata(s.nodeId,d)}return await this.getNode(e,t);default:return this.handleRenameOld(e,t,s,n)}}async handleOverwrite(e,t,s,n,i,a){console.log(`[VFS] Overwriting existing file: ${t}`);let o=n.content??"";if(n.contentEncoding==="base64"&&typeof o=="string"&&(o=Tt(o)),await this.write(e,t,o),n.metadata){const r=i?a.merge(s.metadata,n.metadata):n.metadata;await this.updateMetadata(s.nodeId,r)}return await this.getNode(e,t)}async handleRenameOld(e,t,s,n){const i=await this.generateOldPath(e,t);console.log(`[VFS] Renaming existing ${t} to ${i}`);const a=N.dirname(s.path),o=N.basename(i);return await this.kernel.move(s.nodeId,N.join(a,o)),this.createNodeFromData(e,t,n)}async createNodeFromData(e,t,s){if(s.type===w.FILE){let n=s.content??"";return s.contentEncoding==="base64"&&typeof n=="string"&&(n=Tt(n)),this.createFile(e,t,n,s.metadata)}return this.createDirectory(e,t,s.metadata)}async generateOldPath(e,t){const s=N.dirname(t),n=N.basename(t),i=n.lastIndexOf("."),a=i>0?n.substring(0,i):n,o=i>0?n.substring(i):"";let r="-old",c=1,d=`${s==="/"?"":s}/${a}${r}${o}`;for(;await this.getNode(e,d);)r=`-old-${c++}`,d=`${s==="/"?"":s}/${a}${r}${o}`;return d}isAssetDirectory(e,t){return[/\.assets$/,/_assets$/,/^assets$/,/\/assets\//].some(n=>n.test(e)||n.test(t))}}async function Wn(l){const e=l.plugins??[];if(l.extraSchemas)for(const c of l.extraSchemas)Z.registerDefaultSchema(c);for(const c of e)if(typeof c.getSchemas=="function"){const d=c.getSchemas();for(const h of d)Z.registerDefaultSchema(h)}const t=Z.getDefaultSchemas(),s=l.storage.config.version||1,n=Math.max(t.length,s);console.log(`[VFS] Schema count: ${t.length}, DB version: ${n}`);const i=Z.createAdapter(l.storage.type,{...l.storage.config,version:n}),a=new Gt,o=new fn({storage:i,eventBus:a});await o.initialize();const r=new vn(o);for(const c of e)r.register(c);return await r.activateAll(),{kernel:o,plugins:r,events:a,getPlugin:c=>r.getPlugin(c),shutdown:async()=>{await r.uninstallAll(),await o.shutdown()}}}async function Kn(l){const{dbName:e="vfs_database",dbVersion:t=1,defaultModule:s="default",enableTags:n=!0,enableAssets:i=!0,extraPlugins:a=[],syncableModules:o=[]}=l,r=[new En,new xn,new Ln];n&&r.push(new Tn),i&&r.push(new kn),a.length&&r.push(...a);const c=await Wn({storage:{type:"indexeddb",config:{dbName:e,version:t}},plugins:r}),d=c.getPlugin("vfs-modules");return d&&await d.getModuleManager().ensureDefaultModule(s,o),c}async function Qn(l){const e=await Kn(l);return new Gn(e)}class Jn{channels=new Map;publish(e,t){this.channels.get(e)?.forEach(s=>{try{s({channel:e,data:t,timestamp:Date.now()})}catch(n){console.error(n)}})}subscribe(e,t){return this.channels.has(e)||this.channels.set(e,new Set),this.channels.get(e).add(t),()=>{const s=this.channels.get(e);s?.delete(t),s?.size||this.channels.delete(e)}}clearAll=()=>this.channels.clear()}const Ee=l=>l.startsWith(".")||l.startsWith("__"),Yn=l=>l.moduleId&&Ee(l.moduleId)||l.path?.split("/").some(Ee)||Ee(l.name),Xn=l=>{const e=l.lastIndexOf(".");return e>0?l.slice(0,e):l},_e=l=>{const e=l.lastIndexOf(".");return e>0?l.slice(e).toLowerCase():""},Zn=l=>{if(!l)return"";try{const e=Math.floor((Date.now()-new Date(l).getTime())/1e3);return e<60?"":e<3600?`${Math.floor(e/60)}`:e<86400?`${Math.floor(e/3600)}`:`${Math.floor(e/86400)}`}catch{return""}},ue=(l,e)=>{for(const t of l){if(t.id===e)return t;const s=t.children&&ue(t.children,e);if(s)return s}},ht=(l,e)=>{l.forEach(t=>{e(t),t.children&&ht(t.children,e)})},ke=l=>l instanceof Set?l:new Set(Array.isArray(l)?l:[]),ei=l=>l instanceof Map?l:new Map(Array.isArray(l)?l:[]);Rs();const Ae=l=>{const e=new Map;return ht(l,t=>{t.metadata.tags?.forEach(s=>{e.has(s)||e.set(s,{name:s,color:null,itemIds:new Set}),e.get(s).itemIds.add(t.id)})}),e},ti={sortBy:"title",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0},si=(l={})=>({items:l.items||[],activeId:l.activeId??null,expandedFolderIds:ke(l.expandedFolderIds),expandedOutlineIds:ke(l.expandedOutlineIds),expandedOutlineH1Ids:ke(l.expandedOutlineH1Ids),selectedItemIds:ke(l.selectedItemIds),creatingItem:l.creatingItem||null,moveOperation:l.moveOperation||null,tags:ei(l.tags),searchQuery:l.searchQuery||"",uiSettings:{...ti,...l.uiSettings},isSidebarCollapsed:l.isSidebarCollapsed??!1,readOnly:l.readOnly??!1,status:l.status||"idle",error:l.error||null,_forceUpdateTimestamp:l._forceUpdateTimestamp});class ni{state;listeners=new Set;constructor(e={}){this.state=si(e)}dispatch(e){const t=this.state;this.state=this.reduce(this.state,e),t!==this.state&&this.listeners.forEach(s=>s(this.state))}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getState=()=>this.state;reduce=Ps((e,{type:t,payload:s})=>{({STATE_LOAD_SUCCESS:()=>{Object.assign(e,{items:s.items,tags:s.tags,status:"success",error:null}),e.activeId&&(e._forceUpdateTimestamp=Date.now())},ITEMS_LOAD_START:()=>{e.status="loading",e.error=null},ITEMS_LOAD_ERROR:()=>{e.status="error",e.error=s.error},CREATE_ITEM_START:()=>{e.creatingItem=s,e.selectedItemIds.clear(),s.parentId&&e.expandedFolderIds.add(s.parentId)},CREATE_ITEM_END:()=>{e.creatingItem=null},ITEM_DELETE_SUCCESS:()=>this.handleDelete(e,new Set(s.itemIds)),ITEM_SELECTION_REPLACE:()=>{e.selectedItemIds=new Set(s.ids||[])},ITEM_SELECTION_UPDATE:()=>this.handleSelectionUpdate(e,s),ITEM_SELECTION_CLEAR:()=>{e.selectedItemIds.clear()},ITEM_METADATA_UPDATE:()=>this.updateNodeMeta(e.items,s.itemId,s.metadata),ITEM_UPDATE_SUCCESS:()=>{this.updateNode(e.items,s.itemId,s.updates),e.tags=Ae(e.items)},ITEMS_BATCH_UPDATE_SUCCESS:()=>{s.updates?.forEach(i=>this.updateNode(e.items,i.itemId,i.data)),e.tags=Ae(e.items)},SESSION_CREATE_SUCCESS:()=>this.handleCreate(e,s),FOLDER_CREATE_SUCCESS:()=>this.handleCreate(e,s),MOVE_OPERATION_START:()=>{e.moveOperation={isMoving:!0,itemIds:s.itemIds}},MOVE_OPERATION_END:()=>{e.moveOperation=null},FOLDER_TOGGLE:()=>this.toggleSet(e.expandedFolderIds,s.folderId),OUTLINE_TOGGLE:()=>this.toggleSet(e.expandedOutlineIds,s.itemId),OUTLINE_H1_TOGGLE:()=>this.toggleSet(e.expandedOutlineH1Ids,s.elementId),SESSION_SELECT:()=>this.handleSessionSelect(e,s.sessionId),SETTINGS_UPDATE:()=>{Object.assign(e.uiSettings,s.settings)},SIDEBAR_TOGGLE:()=>{e.isSidebarCollapsed=!e.isSidebarCollapsed},SEARCH_QUERY_UPDATE:()=>{e.searchQuery=s.query||""}})[t]?.()});toggleSet(e,t){e.has(t)?e.delete(t):e.add(t)}handleDelete(e,t){const s=n=>n.filter(i=>t.has(i.id)?!1:(i.children&&(i.children=s(i.children)),!0));e.items=s(e.items),t.forEach(n=>{e.activeId===n&&(e.activeId=null),e.selectedItemIds.delete(n)}),e.tags=Ae(e.items)}handleSelectionUpdate(e,{ids:t,mode:s}){t?.length&&(s==="toggle"?t.forEach(n=>e.selectedItemIds.has(n)?e.selectedItemIds.delete(n):e.selectedItemIds.add(n)):s==="replace"&&(e.selectedItemIds=new Set(t)))}handleCreate(e,t){const s=t.metadata.parentId,n=s?ue(e.items,s):null;n?.type==="directory"?((n.children??=[]).unshift(t),e.expandedFolderIds.add(s)):e.items.unshift(t),t.type==="file"&&(e.activeId=t.id,e.selectedItemIds=new Set([t.id])),e.creatingItem=null,e.tags=Ae(e.items)}handleSessionSelect(e,t){if(t){if(ue(e.items,t)?.type==="file"){const n=e.activeId;e.activeId=t,e.creatingItem=null,e.selectedItemIds=new Set([t]),n===t?e._forceUpdateTimestamp=Date.now():n&&e.expandedOutlineIds.delete(n)}}else e.activeId&&e.expandedOutlineIds.delete(e.activeId),e.activeId=null}updateNode(e,t,s){for(let n=0;n<e.length;n++){if(e[n].id===t)return e[n]=s,!0;if(e[n].children&&this.updateNode(e[n].children,t,s))return!0}return!1}updateNodeMeta(e,t,s){for(const n of e){if(n.id===t)return n.metadata={...n.metadata,...s},!0;if(n.children&&this.updateNodeMeta(n.children,t,s))return!0}return!1}}const ii=/\.[a-zA-Z0-9]{1,10}$/;class ai{engine;newFileContent;defaultExtension;constructor({engine:e,newFileContent:t="",defaultExtension:s=".md"}){if(console.log("VFSService option:",s),!e)throw new Error("VFSService requires an ISessionEngine.");this.engine=e,this.newFileContent=t,this.defaultExtension=s.startsWith(".")?s:`.${s}`}ensureExtension=e=>ii.test(e)?e:`${e}${this.defaultExtension}`;createFile=async({title:e="Untitled",parentId:t=null,content:s=this.newFileContent}={})=>this.engine.createFile(this.ensureExtension(e),t,s);createFiles=async({parentId:e=null,files:t})=>{if(!t?.length)return[];const s=t.map(n=>({...n,title:this.ensureExtension(n.title)}));return this.engine.createFiles?this.engine.createFiles(s,e):Promise.all(s.map(n=>this.engine.createFile(n.title,e,n.content)))};createDirectory=({title:e="New Directory",parentId:t=null}={})=>this.engine.createDirectory(e,t);renameItem=(e,t)=>this.engine.rename(e,t);deleteItems=e=>this.engine.delete(e);moveItems=({itemIds:e,targetId:t})=>this.engine.move(e,t);updateMultipleItemsTags=async({itemIds:e,tags:t})=>{this.engine.setTagsBatch?await this.engine.setTagsBatch(e.map(s=>({id:s,tags:t}))):await Promise.all(e.map(s=>this.engine.setTags(s,t)))};findItemById=e=>this.engine.getNode(e);updateItemMetadata=(e,t)=>this.engine.updateMetadata(e,t);getAllFolders=()=>this.engine.search({type:"directory"});getAllFiles=()=>this.engine.search({type:"file"})}const Ve={".md":"",".txt":"",".js":"",".ts":"",".json":"",".html":"",".css":"",".png":"",".jpg":"",".jpeg":"",".gif":"",".svg":"",folder:"",default:""};class oi{extensionMap=new Map;defaultFactory;customResolver;constructor(e,t){this.defaultFactory=e,this.customResolver=t}register(e){e.extensions.forEach(t=>{this.extensionMap.set(t.toLowerCase(),{...e})})}getIcon(e,t=!1){if(t)return Ve.folder;const s=_e(e);return this.extensionMap.get(s)?.icon||Ve[s]||Ve.default}resolveEditorFactory(e){if(this.customResolver){const s=this.customResolver(e);if(s)return s}const t=(e.metadata.custom?._extension||_e(e.metadata.path||e.metadata.title||"")).toLowerCase();return this.extensionMap.get(t)?.editorFactory||this.defaultFactory}resolveContentParser(e){return this.extensionMap.get(_e(e))?.contentParser}}class ri extends Ue{constructor(e){super(),this.engine=e}async getSuggestions(e){if(!this.engine.getAllTags)return[];try{const t=await this.engine.getAllTags(),s=e.toLowerCase();return t.filter(n=>!e||n.name.toLowerCase().includes(s)).sort((n,i)=>(i.refCount||0)-(n.refCount||0)||n.name.localeCompare(i.name)).map(n=>({id:n.name,label:n.name,type:"tag",color:n.color,extra:{count:n.refCount}}))}catch(t){return console.error("Failed to fetch tags",t),[]}}}class li{constructor(e,t){this.container=e,this.params=t,this.items=new Set(t.initialItems)}items;suggestions=[];activeIndex=-1;pillsEl;inputEl;suggestionsEl;init(){this.render(),this.bindEvents(),this.items.forEach(e=>this.addPill(e)),this.inputEl.focus()}bindEvents(){this.container.addEventListener("keydown",this.handleKeyDown),this.inputEl.addEventListener("input",this.handleInput),this.container.addEventListener("click",this.handleClick)}handleClick=e=>{const t=e.target;if(t.closest(".mdx-tag-editor__remove-btn")){e.stopPropagation();const i=t.closest(".mdx-tag-editor__pill");i?.dataset.item&&this.removeItem(i.dataset.item);return}const s=t.closest(".mdx-tag-editor__suggestion");if(s?.dataset.item){e.stopPropagation(),this.addItem(s.dataset.item),this.clearSuggestions(),this.inputEl.value="";return}const n=t.closest(".mdx-tag-editor__btn")?.dataset.action;n==="save"?this.params.onSave(this.getItems()):n==="cancel"&&this.params.onCancel()};handleInput=async()=>{const e=this.inputEl.value;this.suggestions=e?(await this.params.suggestionProvider.getSuggestions(e)).filter(t=>!this.items.has(t.label)):[],this.activeIndex=-1,this.renderSuggestions()};handleKeyDown=e=>{if(e.target!==this.inputEl)return;const t=this.suggestions.length;switch(e.key){case"Enter":case",":e.preventDefault(),t&&this.activeIndex>-1?this.addItem(this.suggestions[this.activeIndex].label):this.inputEl.value.trim()&&this.addItem(this.inputEl.value.trim()),this.inputEl.value="",this.clearSuggestions();break;case"Backspace":!this.inputEl.value&&this.items.size&&this.removeItem([...this.items].pop());break;case"ArrowDown":t&&(e.preventDefault(),this.activeIndex=(this.activeIndex+1)%t,this.renderSuggestions());break;case"ArrowUp":t&&(e.preventDefault(),this.activeIndex=(this.activeIndex-1+t)%t,this.renderSuggestions());break;case"Escape":e.preventDefault(),this.suggestions.length?this.clearSuggestions():this.params.onCancel();break}};addItem(e){const t=e.trim();if(!t||this.items.has(t)){this.inputEl.value="";return}this.items.add(t),this.addPill(t),this.inputEl.focus()}removeItem(e){this.items.delete(e),this.pillsEl.querySelector(`[data-item="${S(e)}"]`)?.remove(),this.inputEl.focus()}addPill(e){const t=document.createElement("li");t.className="mdx-tag-editor__pill",t.dataset.item=e,t.innerHTML=`<span>${S(e)}</span><button type="button" class="mdx-tag-editor__remove-btn">&times;</button>`,this.pillsEl.insertBefore(t,this.pillsEl.querySelector(".mdx-tag-editor__input-wrapper"))}clearSuggestions(){this.suggestions=[],this.activeIndex=-1,this.renderSuggestions()}renderSuggestions(){if(!this.suggestions.length){this.suggestionsEl.style.display="none";return}this.suggestionsEl.innerHTML=this.suggestions.map((e,t)=>`<li class="mdx-tag-editor__suggestion ${t===this.activeIndex?"is-active":""}" data-item="${S(e.label)}">${S(e.label)}</li>`).join(""),this.suggestionsEl.style.display="block"}render(){this.container.innerHTML=`
      <ul class="mdx-tag-editor__pills">
        <li class="mdx-tag-editor__input-wrapper">
          <input type="text" class="mdx-tag-editor__input" placeholder="Add tag..." autocomplete="off">
        </li>
      </ul>
      <ul class="mdx-tag-editor__suggestions"></ul>
      <div class="mdx-tag-editor__footer">
        <button type="button" class="mdx-tag-editor__btn mdx-tag-editor__btn--primary" data-action="save">Save</button>
        <button type="button" class="mdx-tag-editor__btn" data-action="cancel">Cancel</button>
      </div>`,this.pillsEl=this.container.querySelector(".mdx-tag-editor__pills"),this.inputEl=this.container.querySelector(".mdx-tag-editor__input"),this.suggestionsEl=this.container.querySelector(".mdx-tag-editor__suggestions")}getItems(){const e=this.inputEl?.value.trim();return e&&!this.items.has(e)&&this.items.add(e),[...this.items]}}class ut{container;store;coordinator;state={};unsub=null;constructor({container:e,store:t,coordinator:s}){this.container=e,this.store=t,this.coordinator=s}init(){this.unsub=this.store.subscribe(this.update),this.update(this.store.getState()),this.bindEvents()}update=e=>{const t=this.transformState(e);Object.keys(t).some(n=>this.state[n]!==t[n])&&(this.state=t,this.render())};bindEvents(){}destroy(){this.unsub?.(),this.unsub=null,this.container.innerHTML=""}}class ci{constructor(e,t="File"){this.searchFilter=e,this.createFileLabel=t}transform(e){const{items:t,searchQuery:s,uiSettings:n,expandedFolderIds:i,expandedOutlineIds:a,selectedItemIds:o,activeId:r,creatingItem:c,status:d,readOnly:h}=e,u=this.parseSearchQuery(s),g=this.filterAndSortItems(t,u,n,h),p=this.getVisibleItemIds(g,new Set([...i,...t.map(v=>v.id)])),f=this.calculateSelectionStatus(o,p,h);return{items:g,textSearchQueries:u.textQueries,searchQuery:s,activeId:r,expandedFolderIds:i,expandedOutlineIds:a,uiSettings:n,status:d,selectedItemIds:o,creatingItem:c,selectionStatus:f,visibleItemIds:p,readOnly:h,createFileLabel:this.createFileLabel}}parseSearchQuery(e){const t=e.trim().toLowerCase();if(!t)return{textQueries:[],tagQueries:[],typeQueries:[]};const s=t.split(/\s+/).filter(Boolean),n=[],i=[],a=[];for(const o of s)if(o.startsWith("tag:"))i.push(o.substring(4));else if(o.startsWith("type:")){const r=o.substring(5);(r==="file"||r==="dir")&&a.push(r)}else n.push(o);return{textQueries:n,tagQueries:i,typeQueries:a}}filterAndSortItems(e,t,s,n){let i=JSON.parse(JSON.stringify(e));return(t.textQueries.length>0||t.tagQueries.length>0||t.typeQueries.length>0)&&(i=this.filterRecursively(i,t)),n||this.sortRecursively(i,s),i}filterRecursively(e,t){return e.map(s=>{if(s.type==="directory"){const n=this.filterRecursively(s.children||[],t);return this.itemMatches(s,t)||n.length>0?{...s,children:n}:null}return this.itemMatches(s,t)?s:null}).filter(s=>s!==null)}itemMatches(e,t){const{textQueries:s,tagQueries:n,typeQueries:i}=t;if(i.length>0){const a=e.type==="directory"?"dir":"file";if(!i.includes(a))return!1}if(n.length>0){const a=(e.metadata?.tags||[]).map(o=>o.toLowerCase());if(!n.every(o=>a.includes(o)))return!1}if(s.length>0)if(this.searchFilter){if(!this.searchFilter(e,s))return!1}else{const a=[e.metadata?.title||"",e.content?.summary||"",e.content?.searchableText||""].join(" ").toLowerCase();if(!s.every(o=>a.includes(o)))return!1}return!0}sortRecursively(e,t){if(e){e.sort((s,n)=>{const i=s.metadata?.custom?.isPinned||!1,a=n.metadata?.custom?.isPinned||!1;if(i!==a)return i?-1:1;if(t.sortBy==="title")return(s.metadata?.title||"").localeCompare(n.metadata?.title||"","zh-CN");const o=new Date(s.metadata?.lastModified||0).getTime();return new Date(n.metadata?.lastModified||0).getTime()-o});for(const s of e)s.type==="directory"&&s.children&&this.sortRecursively(s.children,t)}}getVisibleItemIds(e,t){const s=[],n=i=>{for(const a of i)s.push(a.id),a.type==="directory"&&a.children&&t.has(a.id)&&n(a.children)};return n(e),s}calculateSelectionStatus(e,t,s){const n=e.size;return s||n<=1||t.length===0?"none":t.every(a=>e.has(a))&&n===t.length?"all":"partial"}}class di{constructor(e){this.store=e}lastClickedItemId=null;handleItemSelection(e,t,s,n){if(n&&(t.metaKey||t.ctrlKey||t.shiftKey))return;let i="replace",a=[e];if(t.metaKey||t.ctrlKey)i="toggle";else if(t.shiftKey&&this.lastClickedItemId){const o=s.indexOf(this.lastClickedItemId),r=s.indexOf(e);o!==-1&&r!==-1&&(a=s.slice(Math.min(o,r),Math.max(o,r)+1))}this.store.dispatch({type:"ITEM_SELECTION_UPDATE",payload:{ids:a,mode:i}}),this.lastClickedItemId=e}handleSelectAllToggle(e,t){e==="all"?this.store.dispatch({type:"ITEM_SELECTION_CLEAR"}):this.store.dispatch({type:"ITEM_SELECTION_REPLACE",payload:{ids:t}})}toggleSelection(e){this.store.dispatch({type:"ITEM_SELECTION_UPDATE",payload:{ids:[e],mode:"toggle"}}),this.lastClickedItemId=e}clearSelection(){this.store.dispatch({type:"ITEM_SELECTION_CLEAR"})}getFolderSelectionState(e,t){const s=t.has(e.id),n=this.getDescendantIds(e);if(n.length===0)return s?"all":"none";const i=n.filter(a=>t.has(a)).length;return s&&i===n.length?"all":s||i>0?"partial":"none"}getDescendantIds(e){const t=[],s=n=>{if(n.type==="directory"&&n.children)for(const i of n.children)t.push(i.id),s(i)};return s(e),t}}class hi{constructor(e,t,s,n,i){this.instanceId=e,this.coordinator=t,this.container=s,this.getExpandedFolderIds=n,this.getSelectedItemIds=i}folderExpandTimer=null;handleDragStart=e=>{const t=e.target.closest("[data-item-id]");if(!t||!e.dataTransfer)return;const s=t.dataset.itemId,n=this.getSelectedItemIds(),i=n.has(s)&&n.size>1?[...n]:[s],a={sourceInstanceId:this.instanceId,itemIds:i};e.dataTransfer.setData("application/json",JSON.stringify(a)),e.dataTransfer.effectAllowed="move",setTimeout(()=>{i.forEach(o=>{this.container.querySelector(`[data-item-id="${o}"]`)?.classList.add("is-dragging")})},0)};handleDragOver=e=>{e.preventDefault(),this.clearDropIndicators();const t=e.target.closest("[data-item-id]");if(!t||!e.dataTransfer)return;try{const n=e.dataTransfer.getData("application/json");if(n&&JSON.parse(n).itemIds?.includes(t.dataset.itemId))return}catch{}const s=t.getBoundingClientRect();if(t.dataset.itemType==="directory")t.classList.add("drop-target-folder");else{const n=e.clientY<s.top+s.height/2;t.classList.add(n?"drop-target-above":"drop-target-below")}this.scheduleAutoExpand(e.target)};handleDragLeave=e=>{this.cancelAutoExpand();const t=e.relatedTarget,s=e.currentTarget;(!t||!s.contains(t))&&this.clearDropIndicators()};handleDrop=e=>{e.preventDefault(),this.cancelAutoExpand();try{if(!e.dataTransfer)throw new Error("No dataTransfer object");const t=e.dataTransfer.getData("application/json"),s=JSON.parse(t);if(!s.sourceInstanceId||s.sourceInstanceId!==this.instanceId){console.warn("[DragDropHandler] Cross-instance drag-and-drop ignored"),this.clearDropIndicators();return}const n=this.container.querySelector(".drop-target-above, .drop-target-below, .drop-target-folder");if(n&&s.itemIds?.length>0&&n.dataset.itemId){const i=n.dataset.itemId;let a;n.classList.contains("drop-target-above")?a="before":n.classList.contains("drop-target-below")?a="after":a="into",this.coordinator.publish("ITEMS_MOVE_REQUESTED",{itemIds:s.itemIds,targetId:i,position:a})}}catch(t){console.error("[DragDropHandler] Failed to parse dragged data",t)}this.clearDropIndicators()};handleDragEnd=()=>{this.container.querySelectorAll(".is-dragging").forEach(e=>e.classList.remove("is-dragging")),this.clearDropIndicators()};scheduleAutoExpand(e){this.cancelAutoExpand();const t=e.closest(".vfs-directory-item");if(!t?.dataset.itemId)return;const s=t.dataset.itemId;this.getExpandedFolderIds().has(s)||(this.folderExpandTimer=window.setTimeout(()=>{this.coordinator.publish("FOLDER_TOGGLE_REQUESTED",{folderId:s})},750))}cancelAutoExpand(){this.folderExpandTimer&&(clearTimeout(this.folderExpandTimer),this.folderExpandTimer=null)}clearDropIndicators(){this.container.querySelectorAll(".drop-target-above, .drop-target-below, .drop-target-folder").forEach(e=>{e.classList.remove("drop-target-above","drop-target-below","drop-target-folder")})}destroy(){this.cancelAutoExpand()}}const ui=l=>{const e=l.type==="directory";return`
    <div class="vfs-node-list__item-creator" data-type="${l.type}">
      <span class="vfs-node-list__item-creator-icon">${e?"":""}</span>
      <input type="text" class="vfs-node-list__item-creator-input" placeholder="${e?"...":"..."}" data-action="create-input" />
    </div>`},gi=l=>l?.length?`<div class="vfs-context-menu"><ul>${l.map(e=>e.type==="separator"?'<li class="vfs-context-menu__separator"></li>':`<li><button data-action="${S(e.id)}">${e.iconHTML||""}<span>${S(e.label)}</span></button></li>`).join("")}</ul></div>`:"",pi=({selectionStatus:l,selectedCount:e,isReadOnly:t})=>t||e<=1?"":`
    <div class="vfs-node-list__bulk-bar">
      <div class="vfs-node-list__bulk-bar-info">
        ${`<input type="checkbox" class="vfs-node-list__footer-checkbox" data-action="toggle-select-all" 
    title="${l==="all"?"":""}" ${l==="all"?"checked":""}>`}
        <span> ${e} </span>
        <button data-action="deselect-all" class="vfs-node-list__bulk-bar-btn--text" title=""></button>
      </div>
      <div class="vfs-node-list__bulk-bar-actions">
        <button class="vfs-node-list__bulk-bar-btn" data-action="bulk-move" title="..."><i class="fas fa-share-square"></i></button>
        <button class="vfs-node-list__bulk-bar-btn vfs-node-list__bulk-bar-btn--danger" data-action="bulk-delete" title=""><i class="fas fa-trash"></i></button>
      </div>
    </div>`,Mt=l=>{const e=(s,n,i)=>`<button data-value="${n}" class="vfs-settings-popover__option-btn ${l[s]===n?"is-active":""}">${i}</button>`,t=(s,n)=>{const i=`show${s.charAt(0).toUpperCase()+s.slice(1)}`;return`<label class="vfs-settings-popover__checkbox-label"><input type="checkbox" data-key="${s}" ${l[i]?"checked":""}> ${n}</label>`};return`
    <div class="vfs-settings-popover">
      <div class="vfs-settings-popover__title"></div>
      <div class="vfs-settings-popover__group" data-setting="sortBy">${e("sortBy","lastModified","")}${e("sortBy","title","")}</div>
      <div class="vfs-settings-popover__title"></div>
      <div class="vfs-settings-popover__group" data-setting="density">${e("density","comfortable","")}${e("density","compact","")}</div>
      <div class="vfs-settings-popover__title"></div>
      <div class="vfs-settings-popover__checkbox-group" data-setting="show">${t("summary","")}${t("tags","")}${t("badges","")}</div>
    </div>`};class mi{constructor(e,t,s,n,i="File"){this.store=e,this.coordinator=t,this.contextMenuConfig=s,this.callbacks=n,this.createFileLabel=i}menuEl=null;show(e,t){e.preventDefault(),e.stopPropagation(),this.hide();const s=t.dataset.itemId,n=this.store.getState(),{selectedItemIds:i}=n,a=i.has(s);let o,r=null;if(i.size>1&&a)o=this.getBulkContextMenuItems(i.size);else{if(a||this.store.dispatch({type:"ITEM_SELECTION_REPLACE",payload:{ids:[s]}}),r=this.callbacks.findItemById(s),!r)return;o=this.buildContextMenuItems(r)}o?.length&&this.createMenu(o,e.clientX,e.clientY,r)}hide(){this.menuEl&&(this.menuEl.remove(),this.menuEl=null)}createMenu(e,t,s,n){const i=document.createElement("div");i.innerHTML=gi(e),this.menuEl=i.firstElementChild,this.menuEl.style.top=`${s}px`,this.menuEl.style.left=`${t}px`,this.menuEl.addEventListener("click",a=>{const o=a.target.closest("button[data-action]");if(!o)return;const r=o.dataset.action;this.handleAction(r,n,{x:t,y:s}),this.hide()}),document.body.appendChild(this.menuEl)}handleAction(e,t,s){const n=this.store.getState();if(e==="bulk-delete"){confirm(` ${n.selectedItemIds.size} ?`)&&this.coordinator.publish("BULK_ACTION_REQUESTED",{action:"delete"});return}if(e==="bulk-move"){this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[...n.selectedItemIds]});return}if(e==="bulk-edit-tags"){const a=[...n.selectedItemIds],o=new Set;a.forEach(r=>{this.callbacks.findItemById(r)?.metadata.tags?.forEach(d=>o.add(d))}),this.callbacks.showTagEditor({initialTags:[...o],onSave:r=>{this.coordinator.publish("ITEM_TAGS_UPDATE_REQUESTED",{itemIds:a,tags:r})},onCancel:()=>{},position:s});return}if(!t)return;if(e==="edit-tags"){this.callbacks.showTagEditor({initialTags:t.metadata.tags||[],onSave:a=>{this.coordinator.publish("ITEM_TAGS_UPDATE_REQUESTED",{itemIds:[t.id],tags:a})},onCancel:()=>{},position:s});return}if(new Set(["rename","delete","moveTo","create-in-folder-session","create-in-folder-folder"]).has(e))if(e.startsWith("create-in-folder-")){const a=e.split("-")[3];this.coordinator.publish("CREATE_ITEM_REQUESTED",{type:a,parentId:t.id})}else e==="moveTo"?this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[t.id]}):this.coordinator.publish("ITEM_ACTION_REQUESTED",{action:e,itemId:t.id});else this.coordinator.publish("CUSTOM_MENU_ACTION_REQUESTED",{action:e,item:t})}getDefaultContextMenuItems(e){const t=[],s=this.createFileLabel;return e.type==="directory"&&t.push({id:"create-in-folder-session",label:` ${S(s)}`,iconHTML:'<i class="fas fa-file-alt"></i>'},{id:"create-in-folder-folder",label:"",iconHTML:'<i class="fas fa-folder-plus"></i>'},{type:"separator"}),t.push({id:"rename",label:"",iconHTML:'<i class="fas fa-pencil-alt"></i>'},{id:"edit-tags",label:"...",iconHTML:'<i class="fas fa-tags"></i>'},{id:"moveTo",label:"...",iconHTML:'<i class="fas fa-share-square"></i>'},{type:"separator"},{id:"delete",label:"",iconHTML:'<i class="fas fa-trash-alt"></i>'}),t}getBulkContextMenuItems(e){return[{id:"bulk-edit-tags",label:` ${e} ...`,iconHTML:'<i class="fas fa-tags"></i>'},{id:"bulk-move",label:` ${e} ...`,iconHTML:'<i class="fas fa-share-square"></i>'},{type:"separator"},{id:"bulk-delete",label:` ${e} `,iconHTML:'<i class="fas fa-trash-alt"></i>'}]}buildContextMenuItems(e){const t=this.getDefaultContextMenuItems(e);if(this.contextMenuConfig?.items)try{return this.contextMenuConfig.items(e,t).filter(s=>s.type==="separator"?!0:!(s.hidden&&s.hidden(e)))}catch(s){console.error("Error executing custom contextMenu.items:",s)}return t}}class fi{constructor(e,t){this.store=e,this.coordinator=t}confirmDeleteId=null;getConfirmDeleteId(){return this.confirmDeleteId}setConfirmDeleteId(e){this.confirmDeleteId=e}handleItemClick(e,t,s,n){const i=t.dataset.itemId,a=t.dataset.itemType,o=e.target.closest("[data-action]"),r=o?.dataset.action;if(this.confirmDeleteId&&r!=="delete-init"&&r!=="delete-direct"&&(this.confirmDeleteId=null,n()),r==="delete-init")return e.stopPropagation(),this.confirmDeleteId=i,n(),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="delete-direct")return e.stopPropagation(),this.confirmDeleteId=null,this.coordinator.publish("ITEM_ACTION_REQUESTED",{action:"delete-direct",itemId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(this.confirmDeleteId===i&&(this.confirmDeleteId=null,n()),r==="toggle-folder")return this.coordinator.publish("FOLDER_TOGGLE_REQUESTED",{folderId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="toggle-outline")return this.coordinator.publish("OUTLINE_TOGGLE_REQUESTED",{itemId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="navigate-to-heading"&&o?.dataset.elementId)return e.preventDefault(),this.coordinator.publish("NAVIGATE_TO_HEADING_REQUESTED",{elementId:o.dataset.elementId}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="toggle-selection")return s?{handled:!0,shouldSelect:!1,shouldNavigate:!1}:(e.stopPropagation(),{handled:!1,shouldSelect:!0,shouldNavigate:!1});const c=e.metaKey||e.ctrlKey||e.shiftKey;return{handled:!1,shouldSelect:r!=="select-only"&&!s,shouldNavigate:r!=="select-only"&&!c&&(a==="file"||a==="directory")}}handleEmptyAreaClick(e,t,s){e||t>0&&(this.store.dispatch({type:"ITEM_SELECTION_CLEAR"}),this.confirmDeleteId&&(this.confirmDeleteId=null,s()))}getTargetParentId(e,t){if(e.size===0)return null;const s=e.values().next().value;if(!s)return null;const n=t(s);if(!n)return null;const a=(n.metadata?.path||"").split("/").some(c=>c.startsWith(".")),o=n.metadata?.title?.startsWith(".");if(a||o)return n.metadata?.parentId||null;const r=n.type==="directory"?n.id:n.metadata?.parentId||null;return r&&!t(r)?null:r}}class yi{constructor(e,t){this.coordinator=e,this.containerEl=t}element=null;toggle(e){this.element?this.hide():this.show(e)}show(e){if(this.element)return;const t=document.createElement("div");t.innerHTML=Mt(e),this.element=t.firstElementChild,this.element.addEventListener("click",this.handleChange),this.element.addEventListener("change",this.handleChange),this.containerEl.appendChild(this.element)}hide(){this.element&&(this.element.removeEventListener("click",this.handleChange),this.element.removeEventListener("change",this.handleChange),this.element.remove(),this.element=null)}isVisible(){return this.element!==null}handleChange=e=>{const t=e.target,s=t.closest("[data-value]"),n=t.closest('input[type="checkbox"]'),i={};if(s){const a=s.closest("[data-setting]");if(a?.dataset.setting){const o=a.dataset.setting;i[o]=s.dataset.value}}else if(n?.dataset.key){const a=n.dataset.key,o=`show${a.charAt(0).toUpperCase()+a.slice(1)}`;i[o]=n.checked}else return;if(this.coordinator.publish("SETTINGS_CHANGE_REQUESTED",{settings:i}),this.element){const o={...this.getCurrentSettingsFromUI(),...i},r=document.createElement("div");r.innerHTML=Mt(o);const c=r.firstElementChild;this.element.innerHTML=c.innerHTML}};getCurrentSettingsFromUI(){const e={sortBy:"lastModified",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0};if(this.element){const t=this.element.querySelector('[data-setting="sortBy"] .is-active');t&&(e.sortBy=t.dataset.value);const s=this.element.querySelector('[data-setting="density"] .is-active');s&&(e.density=s.dataset.value);const n=this.element.querySelector('[data-key="summary"]');n&&(e.showSummary=n.checked);const i=this.element.querySelector('[data-key="tags"]');i&&(e.showTags=i.checked);const a=this.element.querySelector('[data-key="badges"]');a&&(e.showBadges=a.checked)}return e}destroy(){this.hide()}}class vi{constructor(e){this.tagEditorFactory=e}element=null;show(e){this.hide(),this.element=document.createElement("div"),this.element.className="vfs-tag-editor vfs-tag-editor--popover",document.body.appendChild(this.element),this.element.style.left=`${e.position.x}px`,this.element.style.top=`${e.position.y}px`;try{this.tagEditorFactory({container:this.element,initialTags:e.initialTags,onSave:t=>{e.onSave(t),this.hide()},onCancel:()=>{e.onCancel(),this.hide()}})}catch(t){console.error("[TagEditorPopover] Factory execution failed:",t),this.hide()}}hide(){this.element&&(this.element.remove(),this.element=null)}isVisible(){return this.element!==null}containsElement(e){return this.element?.contains(e)??!1}destroy(){this.hide()}}class bi{constructor(e,t){this.element=e,this.callbacks=t,e.addEventListener("click",s=>{const n=s.target.closest("[data-action]")?.getAttribute("data-action");if(!n||s.target.disabled)return;({"toggle-select-all":this.callbacks.onSelectAllToggle,"bulk-delete":this.callbacks.onBulkDelete,"bulk-move":this.callbacks.onBulkMove,settings:this.callbacks.onSettingsClick,"deselect-all":this.callbacks.onDeselectAll})[n]?.()})}render(e){this.element.innerHTML=pi(e);const t=this.element.querySelector(".vfs-node-list__footer-checkbox");t&&(t.indeterminate=e.selectionStatus==="partial")}}class ts{element;item;isReadOnly;constructor(e,t){this.item=e,this.isReadOnly=t,this.element=document.createElement("div"),t||(this.element.draggable=!0)}updateItem(e){const t=this.shouldRerender(this.item,e);this.item=e,t&&this.render()}destroy(){this.element.remove()}replaceElement(e){const t=document.createElement("div");t.innerHTML=e;const s=t.firstElementChild;this.element.parentNode?.replaceChild(s,this.element),this.element=s}shouldRerender(e,t){return JSON.stringify(e.metadata.tags)!==JSON.stringify(t.metadata.tags)||e.metadata.title!==t.metadata.title||JSON.stringify(e.metadata.custom?.taskCount)!==JSON.stringify(t.metadata.custom?.taskCount)}}const et=(l,e)=>{const t=e.map(n=>n.trim()).filter(Boolean);if(!t.length||!l)return S(l||"");const s=new RegExp(`(${t.map(n=>n.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"gi");return S(l).replace(s,'<mark class="vfs-search-highlight">$1</mark>')},wi=l=>{if(!l?.length)return"";const e=t=>t.map(s=>{const n=s.children.length>0;return`
    <li class="vfs-node-item__outline-item vfs-node-item__outline-item--level-${s.level}">
      <a href="javascript:void(0)" data-action="navigate-to-heading" data-element-id="${S(s.id)}">
        <span class="vfs-node-item__outline-text">${S(s.text)}</span>
      </a>
      ${n?`<ul class="vfs-node-item__outline-list">${e(s.children)}</ul>`:""}
    </li>`}).join("");return`<ul class="vfs-node-item__outline-list">${e(l)}</ul>`},Si=(l,e,t=!1)=>{const{id:s,metadata:n,content:i,headings:a=[],icon:o}=l,{title:r,lastModified:c,tags:d=[],custom:h={}}=n,{isActive:u,isSelected:g,isOutlineExpanded:p,isSelectionMode:f,isConfirmingDelete:v,searchQueries:b,uiSettings:I}=e,{isPinned:U=!1,hasUnreadUpdate:q=!1}=h,B=i?.summary||"";let D="";t||(D=`<button class="${v?"vfs-node-item__action-btn vfs-node-item__delete-btn is-confirming":"vfs-node-item__action-btn vfs-node-item__delete-btn"}" data-action="${v?"delete-direct":"delete-init"}" title="${v?"":""}">${v?'<i class="fas fa-trash"></i>':""}</button>`);const H=a?.length>0,y=H?`
    <button class="vfs-node-item__action-btn vfs-node-item__outline-toggle" data-action="toggle-outline" title="/">
      <span class="vfs-node-item__outline-toggle-icon ${p?"is-expanded":""}"></span>
    </button>`:"",_=!t&&f?`<div class="vfs-node-item__checkbox-wrapper"><input type="checkbox" class="vfs-node-item__checkbox" data-item-id="${s}" ${g?"checked":""} data-action="toggle-selection"></div>`:"",E=I.showBadges&&h.taskCount&&h.taskCount.total>0?`<span class="vfs-badge"> ${h.taskCount.completed}/${h.taskCount.total}</span>`:"",z=I.showTags&&d.length>0?d.map(_t=>`<span class="vfs-tag-pill">${S(_t)}</span>`).join(""):"",V=I.showSummary&&B?`<span class="vfs-node-item__summary">${et(B,b)}</span>`:"",A=H&&p?`<div class="vfs-node-item__outline is-expanded">${wi(a)}</div>`:"";let j=o||"";U&&(j="");const te=D||y?`
    <div class="vfs-node-item__actions">
      ${D}
      ${y}
    </div>`:"";return`
    <div class="vfs-node-item" data-item-id="${s}" data-item-type="file">
      <div class="vfs-node-item__main-row ${f?"is-selection-mode":""}">
        ${_}
        <div class="vfs-node-item__content ${u?"is-active":""} ${g?"is-selected":""}" data-action="select-and-open">
          <span class="vfs-node-item__icon" data-action="select-only" title="">${j}</span>
          
          <div class="vfs-node-item__body">
            <div class="vfs-node-item__row-primary">
              <span class="vfs-node-item__title">${et(r,b)}</span>
              ${q?'<span class="vfs-node-item__indicator"></span>':""}
            </div>
            
            <div class="vfs-node-item__row-secondary">
              <div class="vfs-node-item__secondary-left">
                ${V}
                ${z?`<div class="vfs-node-item__tags">${z}</div>`:""}
              </div>
              <div class="vfs-node-item__secondary-right">
                <span class="vfs-node-item__timestamp" title="${new Date(c).toLocaleString()}">${Zn(c)}</span>
                ${E}
              </div>
            </div>
          </div>
          
          ${te}
        </div>
      </div>
      ${A}
    </div>`},Ei=(l,e,t=!1)=>{const{id:s,metadata:n,icon:i}=l,{title:a,tags:o=[]}=n,{isExpanded:r,dirSelectionState:c,isSelected:d,isSelectionMode:h,searchQueries:u}=e,g=!t&&h?`<div class="vfs-node-item__checkbox-wrapper"><input type="checkbox" class="vfs-node-item__checkbox" data-item-id="${s}" ${c==="all"?"checked":""} ${c==="partial"?'data-indeterminate="true"':""} data-action="toggle-selection"></div>`:"",p=o.length?`<div class="vfs-directory-item__tags">${o.map(f=>`<span class="vfs-tag-pill">${S(f)}</span>`).join("")}</div>`:"";return`
    <div class="vfs-node-item vfs-directory-item" data-item-id="${s}" data-item-type="directory">
      <div class="vfs-node-item__main-row ${h?"is-selection-mode":""}">
        ${g}
        <div class="vfs-directory-item__header ${d?"is-selected":""}" data-action="select-item">
          <span class="vfs-directory-item__toggle ${r?"is-expanded":""}" data-action="toggle-folder"></span>
          <span class="vfs-directory-item__icon">${i||""}</span>
          <div class="vfs-directory-item__title-container">
            <span class="vfs-directory-item__title">${et(a,u)}</span>
            ${p}
          </div>
        </div>
      </div>
      <div class="vfs-directory-item__children" style="${r?"":"display:none;"}"></div>
    </div>`};class _i extends ts{props;constructor(e,t,s){super(e,t),this.props=s,this.render()}update(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props=e,this.render())}render(){this.replaceElement(Si(this.item,this.props,this.isReadOnly))}}class xi extends ts{childrenContainer;props;constructor(e,t,s){super(e,t),this.props=s,this.render()}update(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props=e,this.render())}render(){const e=this.childrenContainer;if(this.replaceElement(Ei(this.item,this.props,this.isReadOnly)),this.childrenContainer=this.element.querySelector(".vfs-directory-item__children"),e)for(;e.firstChild;)this.childrenContainer.appendChild(e.firstChild)}}class Ci{constructor(e){this.selectionHandler=e}itemInstances=new Map;renderItems(e,t,s){const n=new Map,i=document.createDocumentFragment();this.traverseAndRender(t.items,i,null,t,s,n),e.innerHTML="",e.appendChild(i),this.itemInstances.forEach((a,o)=>{n.has(o)||a.destroy()}),this.itemInstances=n}traverseAndRender(e,t,s,n,i,a){if(!n.readOnly&&n.creatingItem?.parentId===s){const o=document.createElement("div");o.innerHTML=ui(n.creatingItem),t.appendChild(o.firstElementChild)}if(e.length===0&&s!==null){n.creatingItem?.parentId!==s&&(t.innerHTML='<div class="vfs-directory-item__empty-placeholder">()</div>');return}for(const o of e){let r=this.itemInstances.get(o.id);if(r)r.updateItem(o);else if(o.type==="file"){const c=this.getFileItemProps(o,n,i.confirmDeleteId);r=new _i(o,n.readOnly,c)}else{const c=this.getDirectoryItemProps(o,n);r=new xi(o,n.readOnly,c)}if(o.type==="file"){const c=this.getFileItemProps(o,n,i.confirmDeleteId);r.update(c)}else{const c=this.getDirectoryItemProps(o,n);r.update(c)}if(t.appendChild(r.element),a.set(o.id,r),o.type==="directory"&&o.children&&(n.expandedFolderIds.has(o.id)||!!n.searchQuery)){const d=r.childrenContainer;d.innerHTML="",this.traverseAndRender(o.children,d,o.id,n,i,a)}}}getFileItemProps(e,t,s){return{isActive:e.id===t.activeId,isSelected:t.selectedItemIds.has(e.id),isSelectionMode:!t.readOnly&&t.selectedItemIds.size>1,isOutlineExpanded:t.expandedOutlineIds.has(e.id),searchQueries:t.textSearchQueries,uiSettings:t.uiSettings,isConfirmingDelete:s===e.id}}getDirectoryItemProps(e,t){return{isExpanded:t.expandedFolderIds.has(e.id)||!!t.searchQuery,dirSelectionState:this.selectionHandler.getFolderSelectionState(e,t.selectedItemIds),isSelected:t.selectedItemIds.has(e.id),isSelectionMode:!t.readOnly&&t.selectedItemIds.size>1,searchQueries:t.textSearchQueries}}destroy(){this.itemInstances.forEach(e=>e.destroy()),this.itemInstances.clear()}}class Ii extends ut{stateTransformer;selectionHandler;dragDropHandler;contextMenuHandler;itemActionHandler;settingsPopover;tagEditorPopover;bodyEl;searchEl;mainContainerEl;titleEl;newControlsEl;footerEl;footer;renderer;currentCreateFileLabel;constructor(e){super(e),this.currentCreateFileLabel=e.createFileLabel||"File",this.stateTransformer=new ci(e.searchFilter,this.currentCreateFileLabel),this.buildInitialHTML(e),this.bodyEl=this.container.querySelector(".vfs-node-list__body"),this.searchEl=this.container.querySelector(".vfs-node-list__search"),this.mainContainerEl=this.container.querySelector(".vfs-node-list"),this.titleEl=this.container.querySelector('[data-ref="title"]'),this.newControlsEl=this.container.querySelector('[data-ref="new-controls"]'),this.footerEl=this.container.querySelector(".vfs-node-list__footer"),this.selectionHandler=new di(this.store),this.dragDropHandler=new hi(e.instanceId,this.coordinator,this.bodyEl,()=>this.state.expandedFolderIds,()=>this.state.selectedItemIds),this.itemActionHandler=new fi(this.store,this.coordinator),this.tagEditorPopover=new vi(e.tagEditorFactory),this.contextMenuHandler=new mi(this.store,this.coordinator,e.contextMenu,{showTagEditor:t=>this.tagEditorPopover.show(t),findItemById:t=>this.findItemById(t)},this.currentCreateFileLabel),this.settingsPopover=new yi(this.coordinator,this.mainContainerEl),this.footer=new bi(this.footerEl,{onSelectAllToggle:()=>this.selectionHandler.handleSelectAllToggle(this.state.selectionStatus,this.state.visibleItemIds),onDeselectAll:()=>this.selectionHandler.clearSelection(),onBulkDelete:()=>this.handleBulkDelete(),onBulkMove:()=>this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[...this.state.selectedItemIds]}),onSettingsClick:()=>this.settingsPopover.toggle(this.state.uiSettings)}),this.renderer=new Ci(this.selectionHandler),e.title&&this.setTitle(e.title)}setTitle(e){this.titleEl&&(this.titleEl.textContent=e)}transformState(e){return this.stateTransformer.transform(e)}bindEvents(){this.searchEl.addEventListener("input",Dn(e=>{this.coordinator.publish("SEARCH_QUERY_CHANGED",{query:e.target.value})},300)),this.newControlsEl.addEventListener("click",this.handleNewControlsClick),document.addEventListener("click",this.handleGlobalClick,!0),this.bodyEl.addEventListener("click",this.handleItemClick),this.state.readOnly||(this.bodyEl.addEventListener("contextmenu",this.handleContextMenu),this.bodyEl.addEventListener("keydown",this.handleKeyDown),this.bodyEl.addEventListener("blur",this.handleBlur,!0),this.bodyEl.addEventListener("dragstart",this.dragDropHandler.handleDragStart),this.bodyEl.addEventListener("dragover",this.dragDropHandler.handleDragOver),this.bodyEl.addEventListener("dragleave",this.dragDropHandler.handleDragLeave),this.bodyEl.addEventListener("drop",this.dragDropHandler.handleDrop),this.bodyEl.addEventListener("dragend",this.dragDropHandler.handleDragEnd))}handleNewControlsClick=e=>{const s=e.target.closest("[data-action]");if(!s)return;const n=s.dataset.action,i=this.itemActionHandler.getTargetParentId(this.state.selectedItemIds,a=>this.findItemById(a));if(n==="import")this.coordinator.publish("PUBLIC_IMPORT_REQUESTED",{parentId:i});else if(n==="create-file"||n==="create-directory"){const a=n.split("-")[1];this.coordinator.publish("CREATE_ITEM_REQUESTED",{type:a,parentId:i})}};handleItemClick=e=>{const t=e.target,s=t.closest("[data-item-id]");if(!s){if(t.closest("input")||t.closest(".vfs-node-list__item-creator"))return;this.itemActionHandler.handleEmptyAreaClick(this.state.readOnly,this.state.selectedItemIds.size,()=>this.render());return}const n=s.dataset.itemId,i=s.dataset.itemType,a=this.itemActionHandler.handleItemClick(e,s,this.state.readOnly,()=>this.render());if(a.handled){a.shouldSelect&&this.selectionHandler.toggleSelection(n);return}a.shouldSelect&&this.selectionHandler.handleItemSelection(n,e,this.state.visibleItemIds,this.state.readOnly),a.shouldNavigate&&(i==="file"?this.coordinator.publish("SESSION_SELECT_REQUESTED",{sessionId:n}):i==="directory"&&this.coordinator.publish("SESSION_SELECT_REQUESTED",{sessionId:null}))};handleContextMenu=e=>{const s=e.target.closest("[data-item-id]");s&&(this.tagEditorPopover.hide(),this.contextMenuHandler.show(e,s))};handleKeyDown=e=>{const t=e.target;t.dataset.action==="create-input"&&(e.key==="Enter"?(e.preventDefault(),this.commitItemCreation(t)):e.key==="Escape"&&this.store.dispatch({type:"CREATE_ITEM_END"}))};handleBlur=e=>{const t=e.target;t.dataset.action==="create-input"&&this.commitItemCreation(t)};handleGlobalClick=e=>{const t=e.target;this.settingsPopover.isVisible()&&!t.closest('.vfs-settings-popover, [data-action="settings"]')&&this.settingsPopover.hide(),t.closest(".vfs-context-menu")||this.contextMenuHandler.hide(),this.tagEditorPopover.isVisible()&&!this.tagEditorPopover.containsElement(t)&&this.tagEditorPopover.hide();const s=this.itemActionHandler.getConfirmDeleteId();s&&!t.closest(`[data-item-id="${s}"]`)&&(this.itemActionHandler.setConfirmDeleteId(null),this.render())};handleBulkDelete(){this.coordinator.publish("BULK_ACTION_REQUESTED",{action:"delete"})}findItemById(e){const t=(s,n)=>{for(const i of s){if(i.id===n)return i;if(i.type==="directory"&&i.children){const a=t(i.children,n);if(a)return a}}return null};return t(this.state.items,e)}commitItemCreation(e){if(!this.state.creatingItem)return;const t=e.value.trim(),{type:s,parentId:n}=this.state.creatingItem;this.store.dispatch({type:"CREATE_ITEM_END"}),t&&this.coordinator.publish("CREATE_ITEM_CONFIRMED",{type:s,title:t,parentId:n})}buildInitialHTML(e){const t=e.searchPlaceholder||" (tag:xx type:file|dir)...";this.container.innerHTML=`
      <div class="vfs-node-list">
        <div class="vfs-node-list__title-bar">
          <h2 class="vfs-node-list__title" data-ref="title">${S(e.title||"")}</h2>
        </div>
        <div class="vfs-node-list__header">
          <input type="search" class="vfs-node-list__search" placeholder="${S(t)}" />
          <div class="vfs-node-list__new-controls" data-ref="new-controls">
            <button class="vfs-node-list__new-btn" data-action="create-file" title=" ${S(this.currentCreateFileLabel)}">
              <span>+</span><span class="btn-label">${S(this.currentCreateFileLabel)}</span>
            </button>
            <button class="vfs-node-list__new-btn vfs-node-list__new-btn--folder" data-action="create-directory" title=""><span>+</span></button>
            <button class="vfs-node-list__new-btn vfs-node-list__new-btn--icon" data-action="import" title=""><i class="fas fa-upload"></i></button>
          </div>
        </div>
        <div class="vfs-node-list__body"></div>
        <div class="vfs-node-list__footer"></div>
      </div>
    `}updateCreateFileButton(){const e=this.newControlsEl.querySelector('[data-action="create-file"] .btn-label'),t=this.newControlsEl.querySelector('[data-action="create-file"]');e&&(e.textContent=this.currentCreateFileLabel),t&&(t.title=` ${this.currentCreateFileLabel}`)}render(){this.mainContainerEl.classList.toggle("vfs-node-list--density-compact",this.state.uiSettings.density==="compact");const e=!this.state.readOnly&&this.state.selectedItemIds.size>1;this.mainContainerEl.classList.toggle("vfs-node-list--bulk-mode",e),this.newControlsEl.style.display=this.state.readOnly?"none":"";const t=!this.state.readOnly&&this.state.selectedItemIds.size>1;this.footerEl.style.display=t?"":"none",this.state.createFileLabel!==this.currentCreateFileLabel&&(this.currentCreateFileLabel=this.state.createFileLabel,this.updateCreateFileButton()),this.footer.render({selectionStatus:this.state.selectionStatus,selectedCount:this.state.selectedItemIds.size,isReadOnly:this.state.readOnly}),this.state.status==="loading"?this.bodyEl.innerHTML='<div class="vfs-node-list__placeholder">...</div>':this.state.status==="error"?this.bodyEl.innerHTML='<div class="vfs-node-list__placeholder"></div>':this.renderer.renderItems(this.bodyEl,this.state,{confirmDeleteId:this.itemActionHandler.getConfirmDeleteId(),findItemById:n=>this.findItemById(n)});const s=this.bodyEl.querySelector(".vfs-node-list__item-creator-input");s&&s.focus()}destroy(){super.destroy(),document.removeEventListener("click",this.handleGlobalClick,!0),this.dragDropHandler.destroy(),this.settingsPopover.destroy(),this.tagEditorPopover.destroy(),this.contextMenuHandler.hide(),this.renderer.destroy()}}class Ti extends ut{constructor(e){super(e),this.container.classList.add("vfs-file-outline")}transformState(e){const{activeId:t,items:s,expandedOutlineH1Ids:n=new Set}=e;let i=[];if(t){const a=ue(s,t);a?.type==="file"&&(i=a.headings||[])}return{headings:i,expandedH1Ids:n}}bindEvents(){this.container.addEventListener("click",e=>{const t=e.target.closest("[data-action]"),s=e.target.closest("li[data-element-id]");if(!t||!s)return;const n=s.dataset.elementId;if(!n)return;e.preventDefault();const i=t.dataset.action;i==="toggle-expand"?this.coordinator.publish("OUTLINE_H1_TOGGLE_REQUESTED",{elementId:n}):i==="navigate"&&this.coordinator.publish("NAVIGATE_TO_HEADING_REQUESTED",{elementId:n})})}render(){const{headings:e,expandedH1Ids:t}=this.state;if(!e?.length){this.container.innerHTML=`
        <h3 class="vfs-file-outline__title"></h3>
        <div class="vfs-file-outline__placeholder"></div>`;return}const s=n=>{const i=(n.children?.length??0)>0,a=t.has(n.id),o=n.level===1&&i?`<span class="vfs-file-outline__toggle ${a?"is-expanded":""}" data-action="toggle-expand"></span>`:'<span class="vfs-file-outline__toggle is-placeholder"></span>',r=n.level===1&&i&&a?`<ul class="vfs-file-outline__list">${n.children.map(s).join("")}</ul>`:"";return`
        <li class="vfs-file-outline__item vfs-file-outline__item--level-${n.level}" data-element-id="${n.id}">
          <a href="#${n.id}" class="vfs-file-outline__link" data-action="navigate">
            ${o}
            <span class="vfs-file-outline__text">${n.text}</span>
          </a>
          ${r}
        </li>`};this.container.innerHTML=`
      <h3 class="vfs-file-outline__title"></h3>
      <ul class="vfs-file-outline__list">${e.map(s).join("")}</ul>`}}class Mi extends ut{selectedTargetId=null;constructor(e){super(e),this.container.classList.add("vfs-move-modal-overlay")}transformState(e){const t=s=>s.filter(n=>n.type==="directory").map(n=>({...n,children:n.children?t(n.children):[]}));return{operation:e.moveOperation,availableTargets:e.moveOperation?t(e.items):[]}}bindEvents(){this.container.addEventListener("click",e=>{const t=e.target,s=t.closest("[data-action]")?.dataset.action,n=t.closest("[data-folder-id]")?.dataset.folderId;s==="confirm-move"&&this.selectedTargetId&&this.state.operation?(this.coordinator.publish("ITEMS_MOVE_REQUESTED",{itemIds:this.state.operation.itemIds,targetId:this.selectedTargetId==="root"?null:this.selectedTargetId,position:"into"}),this.coordinator.publish("MOVE_OPERATION_END_REQUESTED",{})):s==="cancel-move"||t===this.container?this.coordinator.publish("MOVE_OPERATION_END_REQUESTED",{}):n&&(this.selectedTargetId=n,this.render())})}render(){if(!this.state.operation?.isMoving){this.container.style.display="none",this.selectedTargetId=null;return}this.container.style.display="flex";const e=(t,s=0)=>t.map(n=>`
        <div class="vfs-move-modal__folder-wrapper">
          <div class="vfs-move-modal__folder" style="--level:${s};" data-folder-id="${n.id}">
            <span class="vfs-move-modal__folder-toggle">${n.children?.length?"":""}</span>
            <span class="vfs-move-modal__folder-icon"></span>
            <span class="vfs-move-modal__folder-title ${n.id===this.selectedTargetId?"is-selected":""}">${n.metadata.title}</span>
          </div>
          ${n.children?.length?`<div class="vfs-move-modal__folder-children">${e(n.children,s+1)}</div>`:""}
        </div>`).join("");this.container.innerHTML=`
      <div class="vfs-move-modal">
        <div class="vfs-move-modal__header"> ${this.state.operation.itemIds.length} ...</div>
        <div class="vfs-move-modal__body">
          <div class="vfs-move-modal__folder" data-folder-id="root">
            <span class="vfs-move-modal__folder-icon"></span>
            <span class="vfs-move-modal__folder-title ${this.selectedTargetId==="root"?"is-selected":""}"></span>
          </div>
          ${e(this.state.availableTargets)}
        </div>
        <div class="vfs-move-modal__footer">
          <button class="vfs-move-modal__btn" data-action="cancel-move"></button>
          <button class="vfs-move-modal__btn vfs-move-modal__btn--primary" data-action="confirm-move" ${this.selectedTargetId?"":"disabled"}></button>
        </div>
      </div>`}}function tt(l){const e={summary:"",searchableText:"",headings:[],metadata:{}};if(typeof l!="string"||!l)return e;const t=Te(l);if(t)return{summary:Bn(t),searchableText:l,headings:[],metadata:{}};const s=Un(l,{extractHeadings:!0,extractSummary:!0,extractSearchable:!0,extractTasks:!0}),n={};return s.taskCounts&&(n.taskCount=s.taskCounts),s.clozeCount>0&&(n.clozeCount=s.clozeCount),s.mermaidCount>0&&(n.mermaidCount=s.mermaidCount),{summary:s.summary||"",searchableText:s.searchableText,headings:s.headings,metadata:n}}const ss=(l,e,t)=>{const s=l.type==="directory";let n={summary:"",searchableText:"",headings:[],metadata:{}};if(!s&&l.content){const o=typeof l.content=="string"?l.content:"",r=t?.(l.name);n=r?{...tt(o),...r(o,_e(l.name))}:tt(o)}const i=l.metadata?.title||(s?l.name:Xn(l.name)),a=l.icon||e?.(l.name,s)||(s?"":"");return{id:l.id,type:s?"directory":"file",version:"1.0",icon:a,metadata:{title:i,tags:l.tags||[],createdAt:new Date(l.createdAt).toISOString(),lastModified:new Date(l.modifiedAt).toISOString(),parentId:l.parentId,path:l.path,moduleId:l.moduleId,custom:{...l.metadata||{},...n.metadata,_originalName:l.name,_extension:!s&&l.name.includes(".")?_e(l.name):""}},content:s?void 0:{format:l.metadata?.contentType||"text/markdown",summary:n.summary,searchableText:n.searchableText,data:l.content},headings:n.headings,children:s&&l.children?ns(l.children,e,t):void 0}},ns=(l,e,t)=>l?.filter(s=>!Ee(s.name)).map(s=>ss(s,e,t))||[],ki={sessionSelected:"PUBLIC_SESSION_SELECTED",navigateToHeading:"PUBLIC_NAVIGATE_TO_HEADING",importRequested:"PUBLIC_IMPORT_REQUESTED",sidebarStateChanged:"PUBLIC_SIDEBAR_STATE_CHANGED",menuItemClicked:"PUBLIC_MENU_ITEM_CLICKED",stateChanged:"PUBLIC_STATE_CHANGED"},Ai={sortBy:"title",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0};class Li extends lt{coordinator;store;fileTypeRegistry;instanceId;options;engine;_vfsService;nodeList;fileOutline;moveToModal;instanceModalContainer;engineUnsubscribe=null;lastActiveId=null;lastSidebarState=!1;lastForceTimestamp;lastSessionSelectWasUserAction=!1;queues={update:new Set,delete:new Set,create:new Set};timers={update:null,delete:null,create:null};constructor(e,t){if(super(),!e.sessionListContainer)throw new Error("VFSUIManager requires 'sessionListContainer'.");this.options=e,this.engine=t,this.instanceId=Ce(),this.fileTypeRegistry=new oi(e.defaultEditorFactory,e.customEditorResolver),e.fileTypes?.forEach(n=>this.fileTypeRegistry.register(n)),this.coordinator=new Jn;const s=this.loadUiState();this.store=new ni({...e.initialState,...s,uiSettings:{...Ai,...e.defaultUiSettings,...s.uiSettings,...e.initialState?.uiSettings},isSidebarCollapsed:e.initialSidebarCollapsed,readOnly:e.readOnly||!1}),this.lastActiveId=this.store.getState().activeId,this.lastSidebarState=this.store.getState().isSidebarCollapsed,this._vfsService=new ai({engine:this.engine,defaultExtension:e.defaultExtension,newFileContent:e.newSessionContent}),this.initializeComponents(),this.connectUIEvents(),e.readOnly||this.connectEngineEvents(),this.store.subscribe(()=>this.saveUiState())}initializeComponents(){const e=new ri(this.engine),t=this.options.components?.tagEditor?n=>{const i=new this.options.components.tagEditor({container:n.container,initialItems:n.initialTags,suggestionProvider:e,onSave:n.onSave,onCancel:n.onCancel});return i.init?.(),i}:n=>{const i=new li(n.container,{container:n.container,initialItems:n.initialTags,suggestionProvider:e,onSave:n.onSave,onCancel:n.onCancel});return i.init(),i};this.nodeList=new Ii({container:this.options.sessionListContainer,store:this.store,coordinator:this.coordinator,contextMenu:this.options.contextMenu,tagEditorFactory:t,searchPlaceholder:this.options.searchPlaceholder||"Search (tag:xx type:file|dir)...",createFileLabel:this.options.createFileLabel,title:this.options.title,searchFilter:this.options.searchFilter,instanceId:this.instanceId}),this.options.documentOutlineContainer&&(this.fileOutline=new Ti({container:this.options.documentOutlineContainer,store:this.store,coordinator:this.coordinator}));let s=document.getElementById("vfs-modal-container");s||(s=document.createElement("div"),s.id="vfs-modal-container",Object.assign(s.style,{position:"absolute",top:"0",left:"0",width:"0",height:"0",zIndex:"9999"}),document.body.appendChild(s)),this.instanceModalContainer=document.createElement("div"),this.instanceModalContainer.className=`vfs-modal-wrapper-${this.instanceId}`,s.appendChild(this.instanceModalContainer),this.moveToModal=new Mi({container:this.instanceModalContainer,store:this.store,coordinator:this.coordinator}),this.options.title&&this.nodeList.setTitle(this.options.title)}get sessionService(){return this._vfsService}resolveEditorFactory(e){return this.fileTypeRegistry.resolveEditorFactory(e)}async start(){if(this.nodeList.init(),this.fileOutline?.init(),this.moveToModal.init(),this.options.readOnly&&this.options.initialState?.items)return this.getActiveSession();if(await this.loadData(),!this.store.getState().items.length&&!this.options.readOnly&&this.options.defaultFileName)try{await this._vfsService.createFile({title:this.options.defaultFileName,content:this.options.defaultFileContent||`# Welcome

Select a file to start.`,parentId:null})}catch(s){console.error("[VFSUIManager] Failed to create default file:",s)}let t=this.getActiveSession();if(!t){const s=i=>{for(const a of i){if(a.type==="file")return a;const o=a.children&&s(a.children);if(o)return o}return null},n=s(this.store.getState().items);n&&(this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:n.id}}),t=this.getActiveSession())}return t}getActiveSession(){const{activeId:e,items:t}=this.store.getState();return e?ue(t,e):void 0}updateSessionContent=(e,t)=>this.engine.writeContent(e,t);toggleSidebar(){this.store.dispatch({type:"SIDEBAR_TOGGLE"})}setTitle(e){this.nodeList.setTitle(e)}on(e,t){const s=ki[e];return s?this.coordinator.subscribe(s,n=>t(n.data)):()=>{}}destroy(){this.nodeList.destroy(),this.fileOutline?.destroy(),this.moveToModal.destroy(),this.instanceModalContainer?.remove(),this.coordinator.clearAll(),this.engineUnsubscribe?.()}get uiStorageKey(){return`vfs_ui_state_${this.options.scopeId||this.engine.moduleName||"default"}`}loadUiState(){try{const e=localStorage.getItem(this.uiStorageKey);return e?JSON.parse(e):{}}catch{return{}}}saveUiState(){const e=this.store.getState();try{localStorage.setItem(this.uiStorageKey,JSON.stringify({activeId:e.activeId,expandedFolderIds:[...e.expandedFolderIds],selectedItemIds:[...e.selectedItemIds],uiSettings:e.uiSettings,isSidebarCollapsed:e.isSidebarCollapsed}))}catch(t){console.error("Failed to save UI state:",t)}}async loadData(){try{this.store.dispatch({type:"ITEMS_LOAD_START"});const e=await this.engine.loadTree(),n=ns(e,(a,o)=>this.fileTypeRegistry.getIcon(a,o),a=>this.fileTypeRegistry.resolveContentParser(a)),i=this.buildTagsMap(n);this.store.dispatch({type:"STATE_LOAD_SUCCESS",payload:{items:n,tags:i}})}catch(e){console.error("[VFSUIManager] Failed to load data:",e),this.store.dispatch({type:"ITEMS_LOAD_ERROR",payload:{error:e}})}}buildTagsMap(e){const t=new Map;return ht(e,s=>{s.metadata.tags?.forEach(n=>{t.has(n)||t.set(n,{name:n,color:null,itemIds:new Set}),t.get(n).itemIds.add(s.id)})}),t}connectEngineEvents(){const e=(r,c)=>this.fileTypeRegistry.getIcon(r,c),t=r=>this.fileTypeRegistry.resolveContentParser(r),s=async(r,c)=>{if(!r.size)return;const d=[...r];if(r.clear(),this.timers[c]=null,c==="delete"){this.store.dispatch({type:"ITEM_DELETE_SUCCESS",payload:{itemIds:d}});return}const u=(await Promise.all(d.map(async g=>{try{const p=await this.engine.getNode(g);return!p||Ee(p.name)?(c==="update"&&this.store.dispatch({type:"ITEM_DELETE_SUCCESS",payload:{itemIds:[g]}}),null):(p.type==="file"?p.content=await this.engine.readContent(g):p.children=[],ss(p,e,t))}catch{return null}}))).filter(Boolean);c==="update"?this.store.dispatch({type:"ITEMS_BATCH_UPDATE_SUCCESS",payload:{updates:u.map(g=>({itemId:g.id,data:g}))}}):u.forEach(g=>{this.store.dispatch({type:g.type==="directory"?"FOLDER_CREATE_SUCCESS":"SESSION_CREATE_SUCCESS",payload:g})})},n=(r,c,d)=>{this.timers[c]||(this.timers[c]=setTimeout(()=>s(r,c),d))},i=r=>{const{type:c,payload:d}=r;switch(c){case"node:created":{const h=d;h.nodeId&&(this.queues.create.add(h.nodeId),n(this.queues.create,"create",50));break}case"node:deleted":{const h=d;(h.data?.removedIds||(h.nodeId?[h.nodeId]:[])).filter(Boolean).forEach(g=>this.queues.delete.add(g)),n(this.queues.delete,"delete",20);break}case"node:batch_deleted":{(d.removedIds||[]).forEach(g=>this.queues.delete.add(g)),n(this.queues.delete,"delete",20);break}case"node:updated":{const h=d;h.nodeId&&(this.queues.update.add(h.nodeId),n(this.queues.update,"update",50));break}case"node:batch_updated":{d.updatedNodeIds?.forEach(u=>this.queues.update.add(u)),n(this.queues.update,"update",50);break}case"node:moved":case"node:batch_moved":{this.loadData(),this.store.dispatch({type:"MOVE_OPERATION_END"});break}}},o=["node:created","node:updated","node:deleted","node:moved","node:batch_updated","node:batch_moved","node:batch_deleted"].map(r=>this.engine.on(r,i));this.engineUnsubscribe=()=>o.forEach(r=>r())}connectUIEvents(){this.store.subscribe(t=>{const s=this.getActiveSession(),n=t.activeId!==this.lastActiveId,i=t._forceUpdateTimestamp!==this.lastForceTimestamp;(n||this.lastSessionSelectWasUserAction||i)&&(this.lastActiveId=t.activeId,i&&(this.lastForceTimestamp=t._forceUpdateTimestamp),this.coordinator.publish("PUBLIC_SESSION_SELECTED",{item:s}),this.lastSessionSelectWasUserAction=!1),t.isSidebarCollapsed!==this.lastSidebarState&&(this.lastSidebarState=t.isSidebarCollapsed,this.coordinator.publish("PUBLIC_SIDEBAR_STATE_CHANGED",{isCollapsed:t.isSidebarCollapsed})),this.coordinator.publish("PUBLIC_STATE_CHANGED",{state:t})}),Object.entries({PUBLIC_IMPORT_REQUESTED:async({parentId:t})=>{const s=Object.assign(document.createElement("input"),{type:"file",multiple:!0,accept:"*/*",style:"display:none"});s.onchange=async n=>{const i=n.target.files;if(i?.length)try{const a=await Promise.all([...i].map(async r=>({title:r.name,content:await this.readFileContent(r)}))),o=await this._vfsService.createFiles({parentId:t,files:a});await this.loadData(),o.length&&o[0].type==="file"&&setTimeout(()=>this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:o[0].id}}),50)}catch(a){console.error("[VFSUIManager] Import failed:",a),alert(": "+a.message)}finally{s.remove()}},document.body.appendChild(s),s.click()},CREATE_ITEM_CONFIRMED:async({type:t,title:s,parentId:n})=>{try{t==="file"?await this._vfsService.createFile({title:s,parentId:n,content:this.options.newSessionContent||""}):await this._vfsService.createDirectory({title:s,parentId:n})}catch(i){console.error(`[VFSUIManager] Failed to create ${t}:`,i),alert(`: ${i.message}`),this.store.dispatch({type:"CREATE_ITEM_START",payload:{type:t,parentId:n}})}},ITEM_ACTION_REQUESTED:async({action:t,itemId:s})=>{const n=ue(this.store.getState().items,s);if(t==="delete"||t==="delete-direct"){if(t==="delete"&&!confirm(` "${n?.metadata.title||"this item"}"?`))return;await this._vfsService.deleteItems([s])}else if(t==="rename"){const i=n?.metadata.title||"",a=prompt(":",i);if(a?.trim()&&a.trim()!==i){let o=a.trim();if(n?.type==="file"&&!/\.[a-zA-Z0-9]{1,10}$/.test(o)){const r=n.metadata.custom?._extension||"";r&&(o+=r)}try{await this._vfsService.renameItem(s,o)}catch(r){alert(`: ${r.message}`)}}}},BULK_ACTION_REQUESTED:async({action:t})=>{const s=[...this.store.getState().selectedItemIds];t==="delete"&&confirm(` ${s.length} ?`)&&await this._vfsService.deleteItems(s)},ITEMS_MOVE_REQUESTED:t=>this._vfsService.moveItems(t),ITEM_TAGS_UPDATE_REQUESTED:t=>this._vfsService.updateMultipleItemsTags(t),SESSION_SELECT_REQUESTED:({sessionId:t})=>{this.lastSessionSelectWasUserAction=!0,this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:t}})},CREATE_ITEM_REQUESTED:t=>this.store.dispatch({type:"CREATE_ITEM_START",payload:t}),MOVE_OPERATION_START_REQUESTED:t=>this.store.dispatch({type:"MOVE_OPERATION_START",payload:t}),MOVE_OPERATION_END_REQUESTED:()=>this.store.dispatch({type:"MOVE_OPERATION_END"}),FOLDER_TOGGLE_REQUESTED:({folderId:t})=>this.store.dispatch({type:"FOLDER_TOGGLE",payload:{folderId:t}}),SETTINGS_CHANGE_REQUESTED:({settings:t})=>this.store.dispatch({type:"SETTINGS_UPDATE",payload:{settings:t}}),OUTLINE_TOGGLE_REQUESTED:t=>this.store.dispatch({type:"OUTLINE_TOGGLE",payload:t}),OUTLINE_H1_TOGGLE_REQUESTED:t=>this.store.dispatch({type:"OUTLINE_H1_TOGGLE",payload:t}),SEARCH_QUERY_CHANGED:({query:t})=>this.store.dispatch({type:"SEARCH_QUERY_UPDATE",payload:{query:t}}),NAVIGATE_TO_HEADING_REQUESTED:t=>this.coordinator.publish("PUBLIC_NAVIGATE_TO_HEADING",t),CUSTOM_MENU_ACTION_REQUESTED:({action:t,item:s})=>this.coordinator.publish("PUBLIC_MENU_ITEM_CLICKED",{actionId:t,item:s})}).forEach(([t,s])=>{this.coordinator.subscribe(t,n=>s(n.data))})}async readFileContent(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>s(new Error(`: ${e.name}`));const i=[".md",".txt",".json",".html",".css",".js",".ts"];e.type.startsWith("text/")||i.some(o=>e.name.endsWith(o))?n.readAsText(e):n.readAsArrayBuffer(e)})}}class Ni extends Nn{engine;searchScope;constructor({engine:e,scope:t=!0}){if(super(),!e)throw new Error(`${this.constructor.name} requires an ISessionEngine instance.`);this.engine=e,this.searchScope=Array.isArray(t)?t:t?["*"]:void 0}filterResults=e=>e.filter(t=>!Yn(t));parseUri(e){if(!e)return null;try{return new URL(e).pathname?.substring(1)||null}catch{return null}}}class Di extends Ni{key="file";triggerChar="@";async getSuggestions(e){try{const t=await this.engine.search({type:"file",text:e,limit:20,scope:this.searchScope});return this.filterResults(t).map(s=>({id:s.id,label:this.formatLabel(s),title:s.name,type:"file",path:s.path,module:s.moduleId}))}catch(t){return console.error("[FileMentionSource] Error:",t),[]}}formatLabel(e){const t=e.path.substring(0,e.path.lastIndexOf("/"))||"/",s=t==="/"?"":` ${t}`,n=e.moduleId?`[${e.moduleId}]`:"";return`${e.icon||""} ${e.name} (${n}${s})`}async getHoverPreview(e){const t=this.parseUri(e);if(!t)return null;try{const[s,n]=await Promise.all([this.engine.getNode(t),this.engine.readContent(t)]);if(!s)return null;const i=typeof n=="string"?n:new TextDecoder().decode(n),a=i.substring(0,150).replace(/[\r\n]+/g," ").replace(/([#*`])/g,"")+(i.length>150?"...":""),o=new Date(s.modifiedAt).toLocaleDateString(),r=s.moduleId?`<span style="background:#eee;padding:2px 4px;border-radius:3px;font-size:0.8em;margin-right:5px;">${s.moduleId}</span>`:"";return{title:s.name,icon:s.icon||"",contentHTML:`
          <div class="vfs-hover-preview" style="font-size:0.9em;line-height:1.4;">
            <div style="margin-bottom:6px;color:#666;font-size:0.85em;display:flex;align-items:center;">
              ${r}<span style="font-family:monospace;">${s.path}</span>
            </div>
            <div style="margin-bottom:8px;color:#333;">${S(a)}</div>
            <div style="color:#999;font-size:0.8em;border-top:1px solid #eee;padding-top:4px;">Updated: ${o}</div>
          </div>`}}catch(s){return console.error("[FileMentionSource] getHoverPreview error:",s),null}}async getDataForProcess(e){const t=e?.pathname?.substring(1);if(!t)return null;try{const s=await this.engine.getNode(t);if(!s)return null;const n=await this.engine.readContent(t);return{id:s.id,title:s.name,content:n,tags:s.tags,module:s.moduleId,path:s.path,createdAt:new Date(s.createdAt),modifiedAt:new Date(s.modifiedAt),...s.metadata}}catch(s){return console.warn("[FileMentionSource] Process data fetch failed:",s),null}}}function $i(l,e,t,s,n={}){const{onEditorCreated:i,saveDebounceMs:a=500,...o}=n;let r=null,c=null,d=[],h=null,u=0,g=null,p=!1;const f=(y,_)=>{l.store?.dispatch({type:"ITEM_METADATA_UPDATE",payload:{itemId:y,metadata:_}})},v=()=>{if(!r||!c)return;const y=Jt(r.getText()),_=g||c.metadata.custom.taskCount||{total:0,completed:0};(y.total!==_.total||y.completed!==_.completed)&&(g=y,p=!0,f(c.id,{custom:{...c.metadata.custom,taskCount:y}}))},b=async()=>{if(!(!r||!c)&&(h&&(clearTimeout(h),h=null),!(!r.isDirty?.()&&!p)))try{if(l.store?.getState()?.items.some(function E(z){return z.id===c.id||!!z.children?.some(E)})){const E=r.getText();await e.writeContent(c.id,E);const{metadata:z,summary:V}=tt(E);await e.updateMetadata(c.id,{taskCount:z.taskCount,clozeCount:z.clozeCount,mermaidCount:z.mermaidCount,_summary:V}),r.setDirty?.(!1),p=!1}}catch(y){console.error("[EditorConnector] Save failed:",y)}},I=()=>{h&&clearTimeout(h),h=setTimeout(b,a)},U=async()=>{u++,r&&(await b(),d.forEach(y=>y()),d=[],await r.destroy(),r=null,c=null,g=null,p=!1,i?.(null))},q=()=>{const y=o.hostContext;return{toggleSidebar:()=>l.toggleSidebar(),saveContent:(_,E)=>e.writeContent(_,E),navigate:async _=>{y?.navigate?await y.navigate(_):console.warn("[EditorConnector] No navigation handler.",_)}}},B=async({item:y})=>{await U();const _=u;if(t.innerHTML="",!y||y.type!=="file"){t.innerHTML='<div class="editor-placeholder">Select a file...</div>';return}setTimeout(async()=>{if(_===u)try{const E=l.resolveEditorFactory?.(y)||s;if(!E)throw new Error("No suitable editor factory found.");const z={...o,initialContent:y.content?.data||"",title:y.metadata.title,nodeId:y.id,language:y.metadata.custom?._extension||"",sessionEngine:e,hostContext:q()},V=await E(t,z);if(_!==u){V?.destroy();return}if(r=V,c=y,g=y.metadata.custom.taskCount||null,p=!1,r){const A=(j,Et)=>{try{const te=r.on(j,Et);typeof te=="function"&&d.push(te)}catch(te){console.warn(`[EditorConnector] Failed to bind event '${j}':`,te)}};A("blur",I),A("modeChanged",j=>j?.mode==="render"&&b()),A("interactiveChange",()=>{v(),I()}),A("optimisticUpdate",v)}i?.(r)}catch(E){_===u&&(console.error("[EditorConnector] Create failed:",E),t.innerHTML=`<div class="editor-placeholder editor-placeholder--error">Error: ${E.message}</div>`)}},0)},D=l.on("navigateToHeading",async({elementId:y})=>{r?.navigateTo({elementId:y})}),H=l.on("sessionSelected",B);return B({item:l.getActiveSession()}),()=>{H(),D(),U().catch(console.error)}}const Ri=(l,e)=>new Li(l,e);class Pi{services=new Map;provide(e,t){this.services.set(e,t)}inject(e){return this.services.get(e)}has(e){return this.services.has(e)}remove(e){this.services.delete(e)}clear(){this.services.clear()}}class Oi{constructor(e,t,s){this.engine=e,this.nodeId=t,this.pluginNamespace=s}pendingUpdates=new Map;flushTimer=null;flushPromise=null;getMetaKey(){return`_mdx_plugin_${this.pluginNamespace}`}async get(e){if(this.pendingUpdates.has(e))return this.pendingUpdates.get(e);try{const t=await this.engine.getNode(this.nodeId);if(!t)return;const s=this.getMetaKey();return t.metadata?.[s]?.[e]}catch(t){console.warn(`EngineMetadataStore: Failed to get key "${e}"`,t);return}}async set(e,t){this.pendingUpdates.set(e,t),this.scheduleFlush()}async remove(e){this.pendingUpdates.set(e,void 0),this.scheduleFlush()}scheduleFlush(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=window.setTimeout(()=>this.flush(),100)}async flush(){this.pendingUpdates.size!==0&&(this.flushPromise&&await this.flushPromise,this.flushPromise=(async()=>{try{const e=await this.engine.getNode(this.nodeId);if(!e)throw new Error(`Node ${this.nodeId} not found`);const t=this.getMetaKey(),s=e.metadata||{},n={...s[t]||{}};this.pendingUpdates.forEach((a,o)=>{a===void 0?delete n[o]:n[o]=a});const i={...s,[t]:n};await this.engine.updateMetadata(this.nodeId,i),this.pendingUpdates.clear()}catch(e){throw console.error("EngineMetadataStore: Flush failed",e),e}finally{this.flushTimer=null,this.flushPromise=null}})(),await this.flushPromise)}}class Fi{constructor(e,t){this.adapter=e,this.prefix=t}makeKey(e){return`${this.prefix}:${e}`}async get(e){return this.adapter.getItem(this.makeKey(e))}async set(e,t){return this.adapter.setItem(this.makeKey(e),t)}async remove(e){return this.adapter.removeItem(this.makeKey(e))}}class Ui{data=new Map;async get(e){return this.data.get(e)}async set(e,t){this.data.set(e,t)}async remove(e){this.data.delete(e)}async clear(){this.data.clear()}}let Bi=class{plugins=new Map;hooks=new Map;eventBus=new Map;serviceContainer;sessionEngine=null;currentNodeId=null;ownerNodeId=null;dataAdapter=null;coreInstance;instanceId;editorInstance=null;instanceStores=new Map;codemirrorExtensions=[];commands=new Map;toolbarButtons=[];titleBarButtons=[];storeCache=new Map;constructor(e){this.coreInstance=e,this.serviceContainer=new Pi,this.instanceId=`mdx-${Date.now()}-${Math.random().toString(36).substring(2,11)}`}setContext(e,t,s){e&&(this.currentNodeId=e),s&&(this.sessionEngine=s),this.ownerNodeId=t||e||null,this.storeCache.clear()}setDataAdapter(e){this.dataAdapter=e,this.storeCache.clear()}createContextFor(e){const t=new Map,s=new Map;return{pluginManager:this,registerSyntaxExtension:n=>{this.coreInstance.markedExtensions||(this.coreInstance.markedExtensions=[]),this.coreInstance.markedExtensions.push(n)},registerCodeMirrorExtension:n=>{Array.isArray(n)?this.codemirrorExtensions.push(...n):this.codemirrorExtensions.push(n)},registerCommand:(n,i)=>{this.commands.set(n,i)},registerToolbarButton:n=>{this.toolbarButtons.push(n)},registerTitleBarButton:n=>{this.titleBarButtons.push(n)},findAndSelectText:n=>{const i=this.editorInstance||this.coreInstance;i&&typeof i.findAndSelectText=="function"?i.findAndSelectText(n):console.warn("findAndSelectText is not available in this context")},switchToMode:n=>{const i=this.editorInstance||this.coreInstance;i&&typeof i.switchToMode=="function"?i.switchToMode(n):console.warn("switchToMode is not available in this context")},on:(n,i)=>{const a=Symbol(`${e.name}:${n}`);return this.hooks.has(n)||this.hooks.set(n,new Map),this.hooks.get(n).set(a,i),t.set(n,a),()=>{this.hooks.get(n)?.delete(a)}},provide:(n,i)=>{const a=typeof n=="symbol"?n:Symbol.for(`${this.instanceId}:${e.name}:${String(n)}`);this.serviceContainer.provide(a,i)},inject:n=>{const i=typeof n=="symbol"?n:Symbol.for(`${this.instanceId}:${e.name}:${String(n)}`);return this.serviceContainer.inject(i)},emit:(n,i)=>{this.emit(n,i)},listen:(n,i)=>{const a=Symbol(`${e.name}:${n}`);return this.eventBus.has(n)||this.eventBus.set(n,new Map),this.eventBus.get(n).set(a,i),s.set(n,a),()=>{this.eventBus.get(n)?.delete(a)}},getScopedStore:()=>this._createStore(e.name),getSessionEngine:()=>this.sessionEngine,getCurrentNodeId:()=>this.currentNodeId,getOwnerNodeId:()=>this.ownerNodeId,_cleanup:()=>{t.forEach((n,i)=>this.hooks.get(i)?.delete(n)),s.forEach((n,i)=>this.eventBus.get(i)?.delete(n)),t.clear(),s.clear()}}}_createStore(e){const t=this.storeCache.get(e);if(t)return t;const s=`${this.instanceId}:${e}`;let n;return this.sessionEngine&&this.currentNodeId?n=new Oi(this.sessionEngine,this.currentNodeId,e):this.dataAdapter?n=new Fi(this.dataAdapter,s):(this.instanceStores.has(e)||this.instanceStores.set(e,new Ui),n=this.instanceStores.get(e)),this.storeCache.set(e,n),n}register(e){if(this.plugins.has(e.name))return;const t=this.createContextFor(e);this.plugins.set(e.name,{plugin:e,context:t}),e.install(t)}unregister(e){const t=this.plugins.get(e);if(!t)return;const{plugin:s,context:n}=t;s.destroy?.(),n._cleanup?.(),this.instanceStores.get(e)?.clear?.(),this.instanceStores.delete(e),this.plugins.delete(e)}executeTransformHook(e,t){const s=this.hooks.get(e);if(!s)return t;let n=t;for(const i of s.values()){const a=i(n);a!==void 0&&(n=a)}return n}executeActionHook(e,t){this.hooks.get(e)?.forEach(n=>n(t))}async executeHookAsync(e,t){const s=this.hooks.get(e);if(s)for(const n of s.values())await n(t)}emit(e,t){this.eventBus.get(e)?.forEach(n=>{try{n(t)}catch(i){console.error(`[PluginManager] Event callback error for "${e}":`,i)}})}listen(e,t){const s=Symbol(`external-listener:${e}`);return this.eventBus.has(e)||this.eventBus.set(e,new Map),this.eventBus.get(e).set(s,t),()=>{this.eventBus.get(e)?.delete(s)}}getCommand(e){return this.commands.get(e)}getCommands(){return this.commands}getToolbarButtons(){return this.toolbarButtons}getTitleBarButtons(){return this.titleBarButtons}setNodeId(e){this.ownerNodeId===this.currentNodeId&&(this.ownerNodeId=null),this.currentNodeId=e,this.ownerNodeId||(this.ownerNodeId=e),this.storeCache.clear()}setSessionEngine(e){this.sessionEngine=e,this.storeCache.clear()}destroy(){Array.from(this.plugins.keys()).forEach(e=>this.unregister(e)),this.hooks.clear(),this.eventBus.clear(),this.serviceContainer.clear(),this.instanceStores.clear(),this.storeCache.clear(),this.codemirrorExtensions=[],this.commands.clear(),this.toolbarButtons=[],this.titleBarButtons=[]}getInstanceId(){return this.instanceId}};class is{pluginManager;renderRoot=null;searchMarkClass;markedExtensions=[];instanceId;searchRegexCache=new Map;MAX_REGEX_CACHE_SIZE=30;constructor(e={}){this.searchMarkClass=e.searchMarkClass||"mdx-editor-search-highlight",this.instanceId=`renderer-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,this.pluginManager=new Bi(this);const t=e.sessionEngine,s=e.nodeId,n=e.ownerNodeId??e.nodeId;this.pluginManager.setContext(s,n,t),e.persistenceAdapter&&this.pluginManager.setDataAdapter(e.persistenceAdapter)}use(e,...t){const s=new e(...t);return this.pluginManager.register(s),this}usePlugin(e){return this.pluginManager.register(e),this}getInstanceId(){return this.instanceId}setEditorInstance(e){this.pluginManager.editorInstance=e}configureMarked(e,t){const s={heading(n,i){const o=`heading-${ct(n)}`;return`<h${i} id="${o}">${n}</h${i}>`}};e.use({renderer:s}),this.markedExtensions.length>0&&e.use(...this.markedExtensions),t.markedOptions&&e.use(t.markedOptions)}async render(e,t,s={}){this.renderRoot=e,e.classList.add("mdx-editor-renderer");const n=this.pluginManager.executeTransformHook("beforeParse",{markdown:t,options:s}),i=new Ht;this.configureMarked(i,s);let a=await i.parse(n.markdown);const o=this.pluginManager.executeTransformHook("afterRender",{html:a,options:s});e.innerHTML=o.html,await this.pluginManager.executeHookAsync("domUpdated",{element:e,options:s,renderer:this})}getSearchRegex(e){let t=this.searchRegexCache.get(e);if(!t){const s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(t=new RegExp(s,"gi"),this.searchRegexCache.size>=this.MAX_REGEX_CACHE_SIZE){const n=this.searchRegexCache.keys().next().value;n&&this.searchRegexCache.delete(n)}this.searchRegexCache.set(e,t)}return t.lastIndex=0,t}search(e){if(!this.renderRoot||!e)return[];this.clearSearch();const t=[],s=this.getSearchRegex(e),n=document.createTreeWalker(this.renderRoot,NodeFilter.SHOW_TEXT,null),i=[];let a;for(;a=n.nextNode();){const o=a,r=o.textContent||"",c=o.parentElement;if(!c)continue;s.lastIndex=0;const d=Array.from(r.matchAll(s));d.length>0&&i.push({node:o,parent:c,matches:d})}for(const{node:o,parent:r,matches:c}of i){const d=o.textContent||"",h=document.createDocumentFragment();let u=0;for(const p of c){const f=p.index;f>u&&h.appendChild(document.createTextNode(d.substring(u,f)));const v=document.createElement("mark");v.textContent=p[0],h.appendChild(v),u=f+p[0].length}u<d.length&&h.appendChild(document.createTextNode(d.substring(u)));const g=document.createElement("span");g.className=this.searchMarkClass,g.appendChild(h),r.replaceChild(g,o),t.push(g)}return t}gotoMatch(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add(`${this.searchMarkClass}--active`)}clearSearch(){if(!this.renderRoot)return;const e=this.renderRoot.querySelectorAll(`.${this.searchMarkClass}`);if(e.length===0)return;const t=new Set;e.forEach(s=>{const n=s.parentElement;if(n){t.add(n);const i=s.textContent||"",a=document.createTextNode(i);n.replaceChild(a,s)}}),t.forEach(s=>{s.normalize()})}getPluginManager(){return this.pluginManager}destroy(){this.clearSearch(),this.pluginManager.destroy(),this.searchRegexCache.clear(),this.renderRoot&&this.renderRoot.classList.remove("mdx-editor-renderer"),this.renderRoot=null,this.markedExtensions=[]}}const Hi=`
/* ============================================
   ROOT & TYPOGRAPHY
   ============================================ */

.mdx-print {
    font-family: 
        -apple-system, 
        BlinkMacSystemFont, 
        "Segoe UI", 
        Roboto, 
        "Helvetica Neue", 
        Arial, 
        /*   */
        "PingFang SC",           /* macOS  */
        "Hiragino Sans GB",      /* macOS  */
        "Microsoft YaHei",       /* Windows  */
        "WenQuanYi Micro Hei",   /* Linux  */
        "Noto Sans SC",          /* Google  */
        sans-serif,
        "Apple Color Emoji", 
        "Segoe UI Emoji", 
        "Segoe UI Symbol";
    font-size: 14px;
    line-height: 1.8;  /*   */
    color: #24292f;
    background: #ffffff;
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    
    /*   */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

.mdx-print * {
    box-sizing: border-box;
}

/* ============================================
   HEADER
   ============================================ */

.mdx-print-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e0e0e0;
}

.mdx-print-header__title {
    margin: 0;
    font-size: 1.75em;
    font-weight: 600;
    color: #24292f;
}

.mdx-print-header__meta {
    margin: 8px 0 0;
    font-size: 0.875em;
    color: #656d76;
}

.mdx-print-header__meta-item {
    display: inline;
}

.mdx-print-header__meta-item:not(:last-child)::after {
    content: "  ";
    color: #d0d7de;
}

/* ============================================
   HEADINGS
   ============================================ */

.mdx-print h1,
.mdx-print h2,
.mdx-print h3,
.mdx-print h4,
.mdx-print h5,
.mdx-print h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}

.mdx-print h1 {
    font-size: 2em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #d8dee4;
}

.mdx-print h2 {
    font-size: 1.5em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #d8dee4;
}

.mdx-print h3 { font-size: 1.25em; }
.mdx-print h4 { font-size: 1em; }
.mdx-print h5 { font-size: 0.875em; }
.mdx-print h6 { font-size: 0.85em; color: #656d76; }

/* ============================================
   PARAGRAPHS & INLINE ELEMENTS
   ============================================ */

.mdx-print p { margin: 0 0 16px; }
.mdx-print strong { font-weight: 600; }
.mdx-print em { font-style: italic; }

.mdx-print a {
    color: #0969da;
    text-decoration: none;
}

.mdx-print mark {
    background-color: #fff8c5;
    padding: 0.1em 0.2em;
    border-radius: 2px;
}

.mdx-print del {
    text-decoration: line-through;
    color: #656d76;
}

/* ============================================
   LISTS
   ============================================ */

.mdx-print ul,
.mdx-print ol {
    margin: 0 0 16px;
    padding-left: 2em;
}

.mdx-print li { margin: 0.25em 0; }
.mdx-print li > p { margin: 0; }

/* ============================================
   CODE
   ============================================ */

.mdx-print code {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.875em;
    background-color: rgba(175, 184, 193, 0.2);
    border-radius: 6px;
    padding: 0.2em 0.4em;
}

.mdx-print pre {
    margin: 0 0 16px;
    padding: 16px;
    overflow-x: auto;
    font-size: 0.875em;
    line-height: 1.45;
    background-color: #f6f8fa;
    border: 1px solid #d0d7de;
    border-radius: 6px;
}

.mdx-print pre code {
    background: transparent;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
}

/* ============================================
   TABLE
   ============================================ */

.mdx-print table {
    border-collapse: collapse;
    width: 100%;
    margin: 0 0 16px;
}

.mdx-print th,
.mdx-print td {
    padding: 6px 13px;
    border: 1px solid #d0d7de;
    text-align: left;
}

.mdx-print th {
    font-weight: 600;
    background-color: #f6f8fa;
}

.mdx-print tr:nth-child(2n) {
    background-color: #f6f8fa;
}

/* ============================================
   BLOCKQUOTE
   ============================================ */

.mdx-print blockquote {
    margin: 0 0 16px;
    padding: 0 1em;
    color: #656d76;
    border-left: 0.25em solid #d0d7de;
}

/* ============================================
   HORIZONTAL RULE
   ============================================ */

.mdx-print hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #d0d7de;
    border: 0;
}

/* ============================================
   IMAGES
   ============================================ */

.mdx-print img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 16px 0;
}

/* ============================================
   CALLOUT / ADMONITION
   ============================================ */

.mdx-print-callout {
    margin: 16px 0;
    padding: 16px;
    border-radius: 6px;
    border-left: 4px solid;
}

.mdx-print-callout--note {
    border-left-color: #0969da;
    background-color: #ddf4ff;
}

.mdx-print-callout--warning {
    border-left-color: #9a6700;
    background-color: #fff8c5;
}

.mdx-print-callout--danger {
    border-left-color: #cf222e;
    background-color: #ffebe9;
}

.mdx-print-callout--tip {
    border-left-color: #1a7f37;
    background-color: #dafbe1;
}

/* ============================================
   LLM CONVERSATION - MESSAGE
   ============================================ */

.mdx-print-message {
    margin: 16px 0;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid;
}

.mdx-print-message__header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.mdx-print-message__avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    margin-right: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.mdx-print-message__role {
    font-size: 0.8125em;
    font-weight: 600;
    text-transform: uppercase;
}

.mdx-print-message--user {
    background-color: #ddf4ff;
    border-color: #54aeff;
    margin-left: 10%;
}

.mdx-print-message--user .mdx-print-message__avatar {
    background-color: #0969da;
    color: #ffffff;
}

.mdx-print-message--assistant {
    background-color: #f6f8fa;
    border-color: #d0d7de;
    margin-right: 10%;
}

.mdx-print-message--assistant .mdx-print-message__avatar {
    background-color: #8250df;
    color: #ffffff;
}

.mdx-print-message--system {
    background-color: #fff8c5;
    border-color: #d4a72c;
    font-style: italic;
}

/* ============================================
   LLM CONVERSATION - SESSION DIVIDER
   ============================================ */

.mdx-print-session {
    position: relative;
    margin: 32px 0;
    text-align: center;
}

.mdx-print-session__line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    border-top: 2px dashed #d0d7de;
}

.mdx-print-session__label {
    position: relative;
    display: inline-block;
    padding: 4px 16px;
    background-color: #ffffff;
    font-size: 0.75em;
    font-weight: 500;
    color: #656d76;
    text-transform: uppercase;
}

/* ============================================
   PRINT-SPECIFIC STYLES
   ============================================ */

@media print {
    .mdx-print {
        max-width: none;
        padding: 0;
        font-size: 12pt;
    }

    .mdx-print,
    .mdx-print * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .mdx-print a {
        color: inherit;
        text-decoration: underline;
    }

    .mdx-print a[href]::after {
        content: none !important;
    }

    .mdx-print h1,
    .mdx-print h2,
    .mdx-print h3 {
        page-break-after: avoid;
        break-after: avoid;
    }

    .mdx-print pre,
    .mdx-print blockquote,
    .mdx-print table,
    .mdx-print img,
    .mdx-print-message {
        page-break-inside: avoid;
        break-inside: avoid;
    }

    .mdx-print p,
    .mdx-print li {
        orphans: 3;
        widows: 3;
    }

    .mdx-print-message--user,
    .mdx-print-message--assistant {
        margin-left: 0;
        margin-right: 0;
    }
}

@page {
    margin: 20mm 15mm;
    size: A4;
}

/* ============================================
   UTILITY CLASSES
   ============================================ */

.mdx-print--compact {
    font-size: 12px;
    line-height: 1.5;
}

.mdx-print--no-header .mdx-print-header {
    display: none;
}
`;class as{renderer=null;sessionEngine;nodeId;constructor(e,t){this.sessionEngine=e,this.nodeId=t}getRenderer(){return this.renderer||(this.renderer=new is({sessionEngine:this.sessionEngine,nodeId:this.nodeId})),this.renderer}getStyles(e){let t=Hi;if(e.pageSize&&e.pageSize!=="A4"&&(t+=`
@page { size: ${e.pageSize}; }`),e.styles){const s=Array.isArray(e.styles)?e.styles.join(`
`):e.styles;t+=`
/* Custom Styles */
`+s}return t}buildHeader(e){if(!e.showHeader)return"";const t=e.title||"Untitled Document",s=e.headerMeta||{};let n="";return s.author&&(n+=`<span class="mdx-print-header__meta-item">${this.escapeHtml(s.author)}</span>`),s.date?n+=`<span class="mdx-print-header__meta-item">${this.escapeHtml(s.date)}</span>`:n+=`<span class="mdx-print-header__meta-item">${new Date().toLocaleDateString()}</span>`,s.version&&(n+=`<span class="mdx-print-header__meta-item">v${this.escapeHtml(s.version)}</span>`),`
            <header class="mdx-print-header">
                <h1 class="mdx-print-header__title">${this.escapeHtml(t)}</h1>
                ${n?`<div class="mdx-print-header__meta">${n}</div>`:""}
            </header>
        `}async renderForPrint(e,t={}){const s=this.getRenderer(),n=document.createElement("div");n.style.cssText="position:absolute;left:-9999px;visibility:hidden;",document.body.appendChild(n);try{await s.render(n,e);let i=n.innerHTML;return t.beforePrint&&(i=t.beforePrint(i)),i}finally{document.body.removeChild(n)}}async print(e,t={}){const s=await this.renderForPrint(e,t);await this.printFromHtml(s,t)}async printFromHtml(e,t={}){const s=t.title||"Print",n=this.getStyles(t),i=this.buildHeader(t),a=t.variant==="compact"?"mdx-print--compact":"",o=t.showHeader===!1?"mdx-print--no-header":"",r=window.open("","_blank");if(!r)throw new Error("Failed to open print window. Please check popup blocker settings.");const c=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.escapeHtml(s)}</title>
    <style>${n}</style>
</head>
<body>
    <article class="mdx-print ${a} ${o}">
        ${i}
        <main class="mdx-print-content">
            ${e}
        </main>
    </article>
</body>
</html>`;r.document.write(c),r.document.close(),await this.waitForResources(r),r.focus(),r.print(),t.autoClose&&setTimeout(()=>r.close(),1e3)}waitForResources(e){return new Promise(t=>{e.document.readyState==="complete"?setTimeout(t,500):e.addEventListener("load",()=>setTimeout(t,500))})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){this.renderer&&(this.renderer.destroy(),this.renderer=null)}}class gt extends as{static LLM_STYLES=`
        .mdx-print-message { page-break-inside: avoid; }
        .mdx-print-message + .mdx-print-message { margin-top: 12px; }
    `;async renderForPrint(e,t={}){const s=this.preprocessConversation(e);return super.renderForPrint(s,{...t,styles:[gt.LLM_STYLES,...Array.isArray(t.styles)?t.styles:t.styles?[t.styles]:[]]})}preprocessConversation(e){const t=e.split(`
`),s=[];let n=null,i=[];const a=()=>{if(n&&i.length>0){const o=i.join(`
`).trim();if(o){const r=this.getRoleIcon(n),c=this.getRoleLabel(n);s.push(`<div class="mdx-print-message mdx-print-message--${n}">`),s.push('  <div class="mdx-print-message__header">'),s.push(`    <span class="mdx-print-message__avatar">${r}</span>`),s.push(`    <span class="mdx-print-message__role">${c}</span>`),s.push("  </div>"),s.push(`  <div class="mdx-print-message__content">

${o}

</div>`),s.push("</div>")}i=[]}};for(const o of t){const r=o.match(/^##\s*User\s*$/i)||o.match(/^>\s*\*\*User\*\*/i),c=o.match(/^##\s*Assistant\s*$/i)||o.match(/^>\s*\*\*Assistant\*\*/i),d=o.match(/^##\s*System\s*$/i)||o.match(/^>\s*\*\*System\*\*/i),h=o.match(/^---+$/);r?(a(),n="user"):c?(a(),n="assistant"):d?(a(),n="system"):h?(a(),n=null,s.push('<div class="mdx-print-session">'),s.push('  <div class="mdx-print-session__line"></div>'),s.push('  <span class="mdx-print-session__label">New Session</span>'),s.push("</div>")):n?i.push(o):s.push(o)}return a(),s.join(`
`)}getRoleIcon(e){switch(e){case"user":return"";case"assistant":return"";case"system":return"";default:return""}}getRoleLabel(e){switch(e){case"user":return"User";case"assistant":return"Assistant";case"system":return"System";default:return e}}}const os=Vt.define(),$e=Vt.define(),zi=Ze.mark({class:"cm-heading-navigation-highlight",attributes:{"data-highlight-type":"navigation"}}),qi=Os.define({create(){return Ze.none},update(l,e){l=l.map(e.changes);for(const t of e.effects)if(t.is(os)){const{from:s,to:n}=t.value;l=l.update({add:[zi.range(s,n)]})}else t.is($e)&&(l=Ze.none);return l},provide:l=>Q.decorations.from(l)});class Vi extends rt{renderer;editorView=null;_container=null;editorContainer=null;renderContainer=null;currentMode;config;cleanupListeners=[];eventEmitter=new Map;readOnlyCompartment=new xt;searchCompartment=new xt;isDestroying=!1;_isDirty=!1;printService=null;currentSavePromise=null;renderDebounceTimer=null;headingsCache=null;docVersion=0;headingPositionsCache=null;highlightClearTimer=null;searchRegexCache=new Map;MAX_REGEX_CACHE_SIZE=50;pendingRenderResolvers=[];pendingEmits=new Map;emitScheduled=!1;HIGH_FREQUENCY_EVENTS=["change"];constructor(e={}){super(),this.config=e,this.config.ownerNodeId=e.ownerNodeId??e.nodeId,this.currentMode=e.initialMode||"edit",this.renderer=new is({searchMarkClass:e.searchMarkClass,nodeId:e.nodeId,ownerNodeId:this.config.ownerNodeId,persistenceAdapter:e.persistenceAdapter,sessionEngine:e.sessionEngine}),this.renderer.setEditorInstance(this)}async init(e,t=""){this._container=e,this.createContainers(e),this._isDirty=!1,await Promise.resolve(),this.initCodeMirror(t);const s=this.config.initialMode||"edit";this.currentMode=s;const n=s==="edit";this._container.classList.toggle("is-edit-mode",n),this._container.classList.toggle("is-render-mode",!n),this.editorContainer.style.display=n?"flex":"none",this.renderContainer.style.display=n?"none":"block",n||await this.renderContent(),this.listenToPluginEvents(),this.renderer.getPluginManager().executeActionHook("editorPostInit",{editor:this,pluginManager:this.renderer.getPluginManager()}),this.config.title&&this.setTitle(this.config.title),this.emit("ready")}use(e){return this.renderer.usePlugin(e),this}getPrintService(){return this.printService||(this.printService=new as(this.config.sessionEngine,this.config.nodeId)),this.printService}async print(e){this.currentMode==="edit"&&this.renderContainer&&await this.renderContent();const t=this.renderContainer?.innerHTML||"";if(!t.trim()){console.warn("[MDxEditor] No content to print");return}await this.getPrintService().printFromHtml(t,{title:this.config.title,showHeader:!0,...e})}async getHtmlForPrint(e){const t=this.getText();return await this.getPrintService().renderForPrint(t,{title:this.config.title,...e})}createContainers(e){e.innerHTML="",e.className="mdx-editor-root-container mdx-editor-container";const t=document.createDocumentFragment();this.editorContainer=document.createElement("div"),this.editorContainer.className="mdx-editor-container__edit-mode",t.appendChild(this.editorContainer),this.renderContainer=document.createElement("div"),this.renderContainer.className="mdx-editor-container__render-mode",this.renderContainer.tabIndex=-1,t.appendChild(this.renderContainer),e.appendChild(t)}initCodeMirror(e){if(!this.editorContainer)return;const t=[...this.renderer.getPluginManager().codemirrorExtensions,zt(),this.readOnlyCompartment.of(Q.editable.of(!0)),this.searchCompartment.of([]),qi,Q.domEventHandlers({blur:(s,n)=>{this.emit("blur")},focus:(s,n)=>{this.emit("focus")}}),Q.updateListener.of(s=>{s.docChanged&&(this.docVersion++,this.emit("change"),s.transactions.some(n=>n.isUserEvent("input")||n.isUserEvent("delete")||n.isUserEvent("paste")||n.isUserEvent("drop"))&&(this.setDirty(!0),this.emit("interactiveChange")))})];this.editorView=new Q({state:qt.create({doc:e,extensions:t}),parent:this.editorContainer})}listenToPluginEvents(){const e=this.renderer.getPluginManager().listen("taskToggled",t=>{t.wasUpdated&&t.updatedMarkdown!==this.getText()&&(this.setText(t.updatedMarkdown),this.setDirty(!0),this.emit("interactiveChange"),this.emit("optimisticUpdate"))});this.cleanupListeners.push(e)}async switchToMode(e,t=!1){if(this.currentMode===e&&!t||!this._container||!this.editorContainer||!this.renderContainer)return;this.currentMode==="edit"&&e==="render"&&this.isDirty()&&await this.save(),this.currentMode=e;const s=e==="edit";this._container.classList.toggle("is-edit-mode",s),this._container.classList.toggle("is-render-mode",!s),this.editorContainer.style.display=s?"flex":"none",this.renderContainer.style.display=s?"none":"block",!s&&!t&&await this.renderContent(),this.renderer.getPluginManager().emit("modeChanged",{mode:e}),this.emit("modeChanged",{mode:e})}async renderContent(){this.renderContainer&&await this.renderer.render(this.renderContainer,this.getText())}get commands(){const e=this.renderer.getPluginManager().getCommands(),t={};return e.forEach((s,n)=>{t[n]=s}),Object.freeze(t)}getText(){return this.editorView?this.editorView.state.doc.toString():""}setText(e){this.editorView&&e!==this.getText()&&(this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e}}),this.setDirty(!1),this.currentMode==="render"&&this.renderContent().catch(console.error))}async setStreamingText(e){if(this.editorView&&e!==this.getText()&&(this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e}}),this.setDirty(!1)),this.currentMode==="render")return new Promise(t=>{this.pendingRenderResolvers.push(t),this.renderDebounceTimer||(this.renderDebounceTimer=window.setTimeout(async()=>{this.renderDebounceTimer=null;try{await this.renderContent()}catch(n){console.error("[MDxEditor] Streaming render failed:",n)}const s=this.pendingRenderResolvers;this.pendingRenderResolvers=[],s.forEach(n=>n())},16))})}getMode(){return this.currentMode}isDirty(){return this._isDirty}setDirty(e){this._isDirty=e}async save(){const e=this.config.onSave;if(e){if(this.currentSavePromise)return this.currentSavePromise;if(this.isDirty())return this.currentSavePromise=(async()=>{try{const t=this.getText();await e(t),this.setDirty(!1),this.emit("saved")}catch(t){console.error("[MDxEditor] Save failed:",t),this.emit("saveError",t)}finally{this.currentSavePromise=null}})(),this.currentSavePromise}}async getHeadings(){if(this.headingsCache&&this.headingsCache.version===this.docVersion)return this.headingsCache.headings;const e=this.getText();if(Te(e))return this.headingsCache={version:this.docVersion,headings:[]},[];const t=Qt(e,{nested:!1});return this.headingsCache={version:this.docVersion,headings:t},t}getHeadingPositions(){if(this.headingPositionsCache&&this.headingPositionsCache.version===this.docVersion)return this.headingPositionsCache.positions;const e=this.getText(),t=new Map;if(Te(e))return this.headingPositionsCache={version:this.docVersion,positions:t},t;const s=e.split(`
`);let n=0,i=!1;const a=new Map;for(const o of s){const r=n,c=n+o.length,d=o.trim();if(d.startsWith("```")||d.startsWith("~~~")){i=!i,n=c+1;continue}if(!i){const h=o.match(/^(#{1,6})\s+(.+)$/);if(h){const u=h[1].length,g=h[2].trim(),p=ct(g),f=a.get(p)||0;a.set(p,f+1);const b=`heading-${f===0?p:`${p}-${f}`}`;t.set(b,{from:r,to:c,level:u,text:g})}}n=c+1}return this.headingPositionsCache={version:this.docVersion,positions:t},t}async getSearchableText(){return Xt(this.getText())}async getSummary(){return Yt(this.getText())}setTitle(e){this.renderer.getPluginManager().emit("setTitle",{title:e})}async navigateTo(e,t){const{elementId:s}=e,n=t?.smooth??!0;this.currentMode==="render"&&this.renderContainer?await this.navigateInRenderer(s,n):this.currentMode==="edit"&&this.editorView?await this.navigateInEditor(s):console.warn("[MDxEditor] Navigation unavailable: editor not initialized or in unknown mode")}async navigateInRenderer(e,t){if(this.renderContainer)try{const s=this.renderContainer.querySelector(`#${CSS.escape(e)}`);s?(s.scrollIntoView({behavior:t?"smooth":"instant",block:"center"}),s.classList.add("highlight-pulse"),setTimeout(()=>s.classList.remove("highlight-pulse"),1500)):console.warn(`[MDxEditor] Target element not found in renderer: #${e}`)}catch(s){console.error("[MDxEditor] Navigation error in renderer:",s)}}async navigateInEditor(e){if(!this.editorView)return;const t=this.getHeadingPositions();let s=t.get(e);if(!s){const a=e.replace(/-\d+$/,"");for(const[o,r]of t)if(o===a||o.startsWith(a+"-")){s=r;break}}if(!s){console.warn(`[MDxEditor] Heading not found in editor: ${e}`);return}const{from:n,to:i}=s;this.highlightClearTimer&&(clearTimeout(this.highlightClearTimer),this.highlightClearTimer=null),this.editorView.dispatch({effects:$e.of(null)}),await new Promise(a=>{requestAnimationFrame(()=>{if(!this.editorView||this.isDestroying){a();return}this.editorView.dispatch({selection:{anchor:n},effects:Q.scrollIntoView(n,{y:"center",yMargin:100})}),a()})}),await new Promise(a=>{requestAnimationFrame(()=>{if(!this.editorView||this.isDestroying){a();return}this.editorView.dispatch({effects:os.of({from:n,to:i})}),a()})}),this.editorView.focus(),this.highlightClearTimer=window.setTimeout(()=>{this.editorView&&!this.isDestroying&&this.editorView.dispatch({effects:$e.of(null)}),this.highlightClearTimer=null},2e3)}clearNavigationHighlight(){this.highlightClearTimer&&(clearTimeout(this.highlightClearTimer),this.highlightClearTimer=null),this.editorView&&this.editorView.dispatch({effects:$e.of(null)})}setReadOnly(e){this.editorView&&this.editorView.dispatch({effects:this.readOnlyCompartment.reconfigure(Q.editable.of(!e))})}focus(){this.currentMode==="edit"&&this.editorView?this.editorView.focus():this.renderContainer&&this.renderContainer.focus()}getSearchRegex(e){let t=this.searchRegexCache.get(e);if(!t){const s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(t=new RegExp(s,"gi"),this.searchRegexCache.size>=this.MAX_REGEX_CACHE_SIZE){const n=this.searchRegexCache.keys().next().value;n&&this.searchRegexCache.delete(n)}this.searchRegexCache.set(e,t)}return t.lastIndex=0,t}async search(e){if(this.clearSearch(),!e)return[];if(this.currentMode==="edit"&&this.editorView){this.editorView.dispatch({effects:this.searchCompartment.reconfigure(Fs({top:!0}))});const t=[],s=this.editorView.state.doc.toString(),n=this.getSearchRegex(e);let i;for(;(i=n.exec(s))!==null;){const a=i.index,o=a+i[0].length;t.push({source:"editor",text:i[0],context:this.editorView.state.doc.lineAt(a).text,details:{from:a,to:o}})}return t}else return this.renderer.search(e).map(s=>({source:"renderer",text:s.textContent||"",context:s.parentElement?.textContent?.substring(0,100)||"",details:{element:s}}))}gotoMatch(e){e.source==="editor"&&this.editorView&&e.details.from!==void 0?(this.editorView.dispatch({selection:{anchor:e.details.from,head:e.details.to},scrollIntoView:!0}),this.editorView.focus()):e.source==="renderer"&&e.details.element&&this.renderer.gotoMatch(e.details.element)}clearSearch(){this.currentMode==="edit"&&this.editorView?this.editorView.dispatch({effects:this.searchCompartment.reconfigure([])}):this.renderer.clearSearch()}async pruneAssets(){const e=this.renderer.getPluginManager().getCommand("pruneAssets");if(e)try{return await e(this)}catch(t){return console.error("[MDxEditor] Prune assets failed:",t),0}return console.warn("[MDxEditor] Prune capability not available (AssetResolverPlugin missing?)"),null}on(e,t){return this.eventEmitter.has(e)||this.eventEmitter.set(e,new Set),this.eventEmitter.get(e).add(t),()=>{this.eventEmitter.get(e)?.delete(t)}}emit(e,t){const s=this.eventEmitter.get(e);!s||s.size===0||(this.HIGH_FREQUENCY_EVENTS.includes(e)?(this.pendingEmits.set(e,t),this.emitScheduled||(this.emitScheduled=!0,queueMicrotask(()=>{this.emitScheduled=!1,this.pendingEmits.forEach((n,i)=>{this.eventEmitter.get(i)?.forEach(a=>{try{a(n)}catch(o){console.error(`[MDxEditor] Event callback error for "${i}":`,o)}})}),this.pendingEmits.clear()}))):s.forEach(n=>{try{n(t)}catch(i){console.error(`[MDxEditor] Event callback error for "${e}":`,i)}}))}async destroy(){if(!this.isDestroying){if(this.isDestroying=!0,this.highlightClearTimer&&(clearTimeout(this.highlightClearTimer),this.highlightClearTimer=null),this.renderDebounceTimer&&(clearTimeout(this.renderDebounceTimer),this.renderDebounceTimer=null),this.pendingRenderResolvers.forEach(e=>e()),this.pendingRenderResolvers=[],this.currentSavePromise)try{await this.currentSavePromise}catch(e){console.warn("[MDxEditor] Pending save failed during destroy:",e)}this._isDirty&&await this.save(),this.printService&&(this.printService.destroy?.(),this.printService=null),this.editorView?.destroy(),this.renderer.destroy(),this.cleanupListeners.forEach(e=>e()),this.cleanupListeners=[],this.eventEmitter.clear(),this.searchRegexCache.clear(),this.pendingEmits.clear(),this.headingsCache=null,this.headingPositionsCache=null,this._container&&(this._container.innerHTML=""),this._container=null,this.editorContainer=null,this.renderContainer=null,this.isDestroying=!1}}getRenderer(){return this.renderer}getEditorView(){return this.editorView}get container(){return this._container}getRenderContainer(){return this.renderContainer}}class rs{name="editor:core";options;cleanupFns=[];constructor(e={}){this.options={enableLineNumbers:e.enableLineNumbers??!1,enableHistory:e.enableHistory??!0,enableFolding:e.enableFolding??!0,enableAutocompletion:e.enableAutocompletion??!0,enableBracketMatching:e.enableBracketMatching??!0,enableCloseBrackets:e.enableCloseBrackets??!0,enableMultipleSelections:e.enableMultipleSelections??!0,enableRectangularSelection:e.enableRectangularSelection??!0,enableSelectionMatches:e.enableSelectionMatches??!0,additionalExtensions:e.additionalExtensions??[]}}buildCoreExtensions(){const e=[];this.options.enableLineNumbers&&e.push(Us(),Bs()),e.push(Hs()),this.options.enableHistory&&e.push(zs()),this.options.enableFolding&&e.push(qs()),e.push(Vs(),js(),Gs()),this.options.enableMultipleSelections&&e.push(qt.allowMultipleSelections.of(!0)),e.push(Ws()),e.push(Ks(rn,{fallback:!0})),this.options.enableBracketMatching&&e.push(Qs()),this.options.enableCloseBrackets&&e.push(Js()),this.options.enableRectangularSelection&&e.push(Ys(),Xs()),this.options.enableSelectionMatches&&e.push(Zs());const t=[se.of(en),se.of(tn)];return this.options.enableHistory&&t.push(se.of(sn)),this.options.enableFolding&&t.push(se.of(nn)),this.options.enableCloseBrackets&&t.push(se.of(an)),t.push(se.of(on)),e.push(...t),e.push(zt()),e.push(Q.baseTheme({})),this.options.additionalExtensions.length>0&&e.push(...this.options.additionalExtensions),e}install(e){const t=this.buildCoreExtensions();e.registerCodeMirrorExtension?.(t),this.options.enableAutocompletion&&queueMicrotask(()=>{const n=e.pluginManager;n?this.registerAutocompletion(e,n):e.registerCodeMirrorExtension?.(ze())});const s=e.on("editorPostInit",this.onEditorInitialized.bind(this));s&&this.cleanupFns.push(s)}onEditorInitialized(e){}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}registerAutocompletion(e,t){const s=t._autocompleteSources||[];if(s.length===0){e.registerCodeMirrorExtension?.(ze());return}const n=this.createUnifiedCompletionSource(s),i=ze({override:[n],activateOnTyping:!0,defaultKeymap:!0,optionClass:()=>"",activateOnTypingDelay:0});e.registerCodeMirrorExtension?.(i)}createUnifiedCompletionSource(e){const t=new Map;for(const n of e){const i=t.get(n.triggerChar)||[];i.push(n),t.set(n.triggerChar,i)}const s=new Set(t.keys());return async n=>{const{state:i,pos:a}=n,r=i.doc.lineAt(a).from,c=i.sliceDoc(r,a);let d=!1;for(const h of s)if(c.includes(h)){d=!0;break}if(!d)return null;for(const h of e){const{triggerChar:u,provider:g,applyTemplate:p,minQueryLength:f=0}=h,v=this.matchTriggerInLine(c,u);if(!v)continue;const{localStart:b,query:I}=v;if(I.length<f)continue;const U=await g.getSuggestions(I);if(U.length===0)continue;const q=r+b,B=U.map(D=>{const H={label:D.label,type:D.type,apply:(y,_,E,z)=>{const V=p(D);y.dispatch({changes:{from:q,to:z,insert:V},selection:{anchor:q+V.length}})}};return D.detail&&(H.detail=D.detail),D.info&&(H.info=D.info),H});return{from:q,options:B,validFor:this.createValidForRegex(u),filter:!1}}return null}}matchTriggerInLine(e,t){const s=e.lastIndexOf(t);if(s===-1)return null;const n=e[s-1];if(n&&!/\s/.test(n)&&s>0)return null;const i=e.slice(s+t.length);return/\s/.test(i)?null:{localStart:s,query:i}}createValidForRegex(e){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`^${t}[\\w\\u4e00-\\u9fa5-]*$`)}}class ji{name="feature:foldable";options;cleanupFns=[];contextStates=new WeakMap;constructor(e={}){this.options={defaultOpen:e.defaultOpen!==!1,className:e.className||"mdx-editor-foldable",enableTaskCheckbox:!1}}getContextState(e){return this.contextStates.has(e)||this.contextStates.set(e,{storedBlocks:new Map,placeholderId:0,originalMarkdown:""}),this.contextStates.get(e)}generatePlaceholder(e){return`<!-- FOLDABLE_BLOCK_${e.placeholderId++} -->`}dedentContent(e){return e.split(`
`).map(t=>t.replace(/^[ \t]{0,4}/,"")).join(`
`).trim()}createBeforeParseHook(e){return({markdown:t,options:s})=>{const n=this.getContextState(e);n.storedBlocks.clear(),n.placeholderId=0,n.originalMarkdown=t;const i=/^::>\s*(?:\[([ xX])]\s*)?(.*)\n?((?:^[ \t]{4,}.*\n?|^\s*\n)*)/gm;return{markdown:t.replace(i,(o,r,c,d,h)=>{const u=this.generatePlaceholder(n),g=o.indexOf(`
`),p=h+(g>=0?g+1:o.length),f=h+o.length;return n.storedBlocks.set(u,{checkmark:r||void 0,label:c.trim(),contentStart:p,contentEnd:f}),`

${u}

`}),options:s}}}createAfterRenderHook(e){return({html:t,options:s})=>{const n=this.getContextState(e);if(n.storedBlocks.size===0)return{html:t,options:s};const i=new Ht;let a=t;for(const[o,r]of n.storedBlocks){const c=n.originalMarkdown.substring(r.contentStart,r.contentEnd),d=this.dedentContent(c),h=i.parse(d);let u=S(r.label);if(this.options.enableTaskCheckbox&&r.checkmark){const v=r.checkmark.toLowerCase()==="x";u=`${`<input type="checkbox" class="${this.options.className}__task-checkbox" ${v?"checked":""}>`} ${u}`}const g=`<details class="${this.options.className}" ${this.options.defaultOpen?"open":""}>
  <summary class="${this.options.className}__summary">${u}</summary>
  <div class="${this.options.className}__content">
    ${h}
  </div>
</details>`,p=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`<p>${p}</p>|${p}`,"g");a=a.replace(f,g)}return n.originalMarkdown="",{html:a,options:s}}}install(e){const t=e.on("beforeParse",this.createBeforeParseHook(e));t&&this.cleanupFns.push(t);const s=e.on("afterRender",this.createAfterRenderHook(e));s&&this.cleanupFns.push(s);const n=e.on("domUpdated",({element:i})=>{this.setupInteractions(i)});n&&this.cleanupFns.push(n)}setupInteractions(e){e.querySelectorAll(`.${this.options.className}__task-checkbox`).forEach(s=>{const n=s._foldableClickHandler;n&&s.removeEventListener("click",n);const i=a=>{a.stopPropagation()};s.addEventListener("click",i),s._foldableClickHandler=i})}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class le{static instance=null;isLoaded=!1;loadPromise=null;config;cdnUrl="";instanceCount=0;renderQueue=new Set;renderTimer=null;constructor(){}static getInstance(){return le.instance||(le.instance=new le),le.instance}registerInstance(e,t){this.instanceCount++,this.instanceCount===1?(this.config=e,this.cdnUrl=t):JSON.stringify(this.config)!==JSON.stringify(e)&&console.warn("MathJax config differs between instances. Using first config.")}unregisterInstance(){this.instanceCount--,this.instanceCount===0&&this.cleanup()}async load(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=new Promise((e,t)=>{if(window.MathJax?.typesetPromise){this.isLoaded=!0,e();return}window.MathJax=this.config;const s=document.createElement("script");s.src=this.cdnUrl,s.async=!0,s.id="mathjax-script",s.onload=()=>{this.isLoaded=!0,e()},s.onerror=()=>{this.loadPromise=null,t(new Error("Failed to load MathJax"))},document.head.appendChild(s)}),this.loadPromise)}queueRender(e){this.renderQueue.add(e),this.renderTimer&&clearTimeout(this.renderTimer),this.renderTimer=window.setTimeout(()=>{this.flushRenderQueue()},50)}async flushRenderQueue(){if(this.renderQueue.size!==0)try{if(await this.load(),window.MathJax?.startup?.promise&&await window.MathJax.startup.promise,window.MathJax?.typesetPromise){const e=Array.from(this.renderQueue);await window.MathJax.typesetPromise(e)}}catch(e){console.error("MathJax render error:",e)}finally{this.renderQueue.clear(),this.renderTimer=null}}async renderNow(e){try{await this.load(),window.MathJax?.startup?.promise&&await window.MathJax.startup.promise,window.MathJax?.typesetPromise&&await window.MathJax.typesetPromise([e])}catch(t){console.error("MathJax render error:",t)}}cleanup(){this.renderTimer&&(clearTimeout(this.renderTimer),this.renderTimer=null),this.renderQueue.clear()}}class Gi{name="feature:mathjax";options;manager;cleanupFns=[];constructor(e={}){this.options={cdnUrl:e.cdnUrl||"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js",config:{tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},...e.config},autoLoad:e.autoLoad!==!1},this.manager=le.getInstance(),this.manager.registerInstance(this.options.config,this.options.cdnUrl)}createSyntaxExtension(){return{extensions:[{name:"math-display",level:"block",start:e=>e.match(/^\$\$/)?.index,tokenizer:e=>{const t=e.match(/^\$\$([\s\S]+?)\$\$/);if(t)return{type:"math-display",raw:t[0],text:t[1].trim()}},renderer:e=>`\\[${e.text}\\]`},{name:"math-inline",level:"inline",start:e=>e.match(/\$/)?.index,tokenizer:e=>{const t=e.match(/^\$([^\$\n]+?)\$/);if(t)return{type:"math-inline",raw:t[0],text:t[1].trim()}},renderer:e=>`\\(${e.text}\\)`}]}}install(e){e.registerSyntaxExtension(this.createSyntaxExtension()),this.options.autoLoad&&this.manager.load().catch(s=>{console.error("MathJax load error:",s)});const t=e.on("domUpdated",({element:s})=>{this.manager.queueRender(s)});t&&this.cleanupFns.push(t)}async typeset(e){await this.manager.renderNow(e)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.manager.unregisterInstance()}}function Le(l){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return l.replace(/[&<>"']/g,t=>e[t])}class Wi{name="feature:media";options;cleanupFns=[];constructor(e={}){this.options={videoClassName:e.videoClassName||"mdx-editor-video",fileClassName:e.fileClassName||"mdx-editor-file",embedClassName:e.embedClassName||"mdx-editor-embed",videoControls:e.videoControls!==!1,videoAutoplay:e.videoAutoplay===!0,fileIconClass:e.fileIconClass||"fas fa-paperclip"}}install(e){const t=e.on("afterRender",this.handleAfterRender.bind(this));t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}handleAfterRender({html:e,options:t}){const s=/<img\s+[^>]*src="([^"]+)"[^>]*alt="((?:video|file)\[[^\]]*\]|embed)"[^>]*\/?>/gi;return{html:e.replace(s,(i,a,o)=>{if(o==="embed")return this.renderEmbed(a);const r=o.match(/^(video|file)\[(.*?)\]$/);if(r){const c=r[1],d=this.decodeHTML(r[2]);if(c==="video")return this.renderVideo(a,d);if(c==="file")return this.renderFile(a,d)}return i}),options:t}}renderVideo(e,t){const s=Le(e),n=Le(t),i=this.options.videoControls?"controls":"",a=this.options.videoAutoplay?"autoplay":"";return`
      <div class="${this.options.videoClassName}">
        <video class="${this.options.videoClassName}__player" src="${s}" title="${n}" ${i} ${a}>
           HTML5 
        </video>
        ${n?`<div class="${this.options.videoClassName}__title">${n}</div>`:""}
      </div>`}renderFile(e,t){const s=Le(e),n=Le(t);return`
      <a href="${s}" download="${n}" class="${this.options.fileClassName}" title=" ${n}" target="_blank" rel="noopener noreferrer">
        <i class="${this.options.fileIconClass}"></i>
        <span class="${this.options.fileClassName}__name">${n}</span>
      </a>`}renderEmbed(e){let t="",s="";const n=e.toLowerCase();if(n.endsWith(".pdf"))return s="mdx-embed-pdf",`
        <div class="${this.options.embedClassName} ${s}">
          <iframe src="${e}" frameborder="0" title="PDF Preview">
            <p> PDF <a href="${e}" target="_blank"></a></p>
          </iframe>
        </div>`;if(/\.(doc|docx|xls|xlsx|ppt|pptx)$/.test(n)){const i=decodeURIComponent(e.split("/").pop()||"Document");return this.renderFile(e,i)}else e.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/)?t=`https://www.youtube.com/embed/${RegExp.$1}`:e.match(/bilibili\.com\/video\/(BV[\w]+)/)&&(t=`https://player.bilibili.com/player.html?bvid=${RegExp.$1}&high_quality=1`);return t?`
        <div class="${this.options.embedClassName} ${s}">
          <iframe src="${t}" frameborder="0" allowfullscreen scrolling="no"></iframe>
        </div>`:`
      <a href="${e}" target="_blank" class="${this.options.fileClassName} mdx-embed-fallback">
        <i class="fas fa-external-link-alt"></i>
        <span class="${this.options.fileClassName}__name">: ${e}</span>
      </a>`}decodeHTML(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}}class ce{static instance=null;isLoaded=!1;loadPromise=null;config;cdnUrl="";instanceCount=0;renderQueues=new Map;renderTimers=new Map;constructor(){}static getInstance(){return ce.instance||(ce.instance=new ce),ce.instance}registerInstance(e,t){this.instanceCount++,this.instanceCount===1?(this.config=e,this.cdnUrl=t):JSON.stringify(this.config)!==JSON.stringify(e)&&console.warn("Mermaid config differs between instances. Using first config.")}unregisterInstance(e){this.renderQueues.delete(e);const t=this.renderTimers.get(e);t&&(clearTimeout(t),this.renderTimers.delete(e)),this.instanceCount--,this.instanceCount===0&&this.cleanup()}async load(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=new Promise(async(e,t)=>{if(window.mermaid?.run){this.isLoaded=!0,e();return}try{const s=await import(this.cdnUrl);s.default&&(window.mermaid=s.default),window.mermaid?(window.mermaid.initialize(this.config),this.isLoaded=!0,e()):t(new Error("Mermaid module failed to load"))}catch(s){this.loadPromise=null,t(s)}}),this.loadPromise)}queueRender(e,t){this.renderQueues.has(e)||this.renderQueues.set(e,new Set);const s=this.renderQueues.get(e);t.forEach(a=>s.add(a));const n=this.renderTimers.get(e);n&&clearTimeout(n);const i=window.setTimeout(()=>{this.flushRenderQueue(e)},100);this.renderTimers.set(e,i)}async flushRenderQueue(e){const t=this.renderQueues.get(e);if(!(!t||t.size===0))try{if(await this.load(),window.mermaid?.run){const n=Array.from(t).filter(r=>document.contains(r));if(n.length===0){t.clear();return}const i=`data-mermaid-instance-${e}`;n.forEach((r,c)=>{r.setAttribute(i,String(c))});const a=n.map((r,c)=>`[${i}="${c}"]`).join(","),o=document.querySelectorAll(a);await window.mermaid.run({nodes:o}),n.forEach(r=>{r.removeAttribute(i)})}}catch(s){console.error(`Mermaid render error for instance ${e}:`,s)}finally{t.clear(),this.renderTimers.delete(e)}}cleanup(){this.renderTimers.forEach(e=>clearTimeout(e)),this.renderTimers.clear(),this.renderQueues.clear()}}class Ki{name="feature:mermaid";options;manager;cleanupFns=[];instanceId;constructor(e={}){this.options={cdnUrl:e.cdnUrl||"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs",theme:e.theme||"default",mermaidConfig:{startOnLoad:!1,theme:e.theme||"default",...e.mermaidConfig},autoLoad:e.autoLoad!==!1},this.instanceId=`${Date.now()}-${Math.random().toString(36).substring(2,11)}`,this.manager=ce.getInstance(),this.manager.registerInstance(this.options.mermaidConfig,this.options.cdnUrl)}install(e){this.options.autoLoad&&this.manager.load().catch(s=>{console.error("Mermaid load error:",s)});const t=e.on("domUpdated",async({element:s})=>{try{const n=s.querySelectorAll("pre code.language-mermaid");n.length>0&&this.manager.queueRender(this.instanceId,n)}catch(n){console.error("Mermaid plugin error:",n)}});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.manager.unregisterInstance(this.instanceId)}}const Qi={note:"Note",abstract:"Abstract",info:"Info",todo:"Todo",tip:"Tip",success:"Success",question:"Question",warning:"Warning",failure:"Failure",danger:"Danger",bug:"Bug",example:"Example",quote:"Quote"};class Ji{name="syntax:callout";constructor(){}install(e){e.registerSyntaxExtension(this.getMarkedExtension())}getMarkedExtension(){return{walkTokens:e=>{if(e.type!=="blockquote")return;const t=e.tokens?.[0];if(!t||t.type!=="paragraph")return;const n=(t.text||"").match(/^\[!(\w+)\]([^\n]*)/i);if(n){const i=n[1].toLowerCase(),a=n[2].trim()||Qi[i]||i.charAt(0).toUpperCase()+i.slice(1);e.type="callout",e.calloutType=i,e.calloutTitle=a;const r=t.text.replace(/^\[!(\w+)\][^\n]*/i,"").trim();t.text=r,!r&&e.tokens.length>1?e.tokens.shift():r||(t.text="")}},extensions:[{name:"callout",level:"block",renderer(e){const t=`mdx-callout-${e.calloutType}`,s=this.parser.parse(e.tokens);return`
            <div class="mdx-callout ${t}">
              <div class="mdx-callout-title">
                <span class="mdx-callout-icon"></span>
                <span class="mdx-callout-text">${e.calloutTitle}</span>
              </div>
              <div class="mdx-callout-content">
                ${s}
              </div>
            </div>
          `}}]}}}class Yi{name="feature:plantuml";options;cleanupFns=[];constructor(e={}){this.options={serverUrl:e.serverUrl?.replace(/\/$/,"")||"https://www.plantuml.com/plantuml",format:e.format||"svg"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processPlantUML(s)});this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processPlantUML(e){e.querySelectorAll("pre code.language-plantuml, pre code.language-puml").forEach(s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"";if(!i.trim())return;const a=this.encodePlantUML(i.trim()),o=`${this.options.serverUrl}/${this.options.format}/~h${a}`,r=document.createElement("div");r.className="mdx-plantuml-container";const c=document.createElement("img");c.src=o,c.alt="PlantUML Diagram",c.loading="lazy",c.onerror=()=>{r.innerHTML='<div class="mdx-plantuml-error">PlantUML load failed</div>',r.appendChild(n)},r.appendChild(c),n.replaceWith(r)})}encodePlantUML(e){let t="";const s=new TextEncoder().encode(e);for(let n=0;n<s.length;n++)t+=s[n].toString(16).padStart(2,"0");return t}}function me(l,e){const{state:t,dispatch:s}=l,{from:n,to:i}=t.selection.main,a=t.sliceDoc(n,i),o=t.sliceDoc(Math.max(0,n-e.length),n),r=t.sliceDoc(i,Math.min(t.doc.length,i+e.length));return s(o===e&&r===e?{changes:[{from:n-e.length,to:n,insert:""},{from:i,to:i+e.length,insert:""}]}:{changes:{from:n,to:i,insert:`${e}${a}${e}`},selection:{anchor:n+e.length,head:i+e.length}}),l.focus(),!0}const ls=l=>me(l,"**"),cs=l=>me(l,"*"),ds=l=>me(l,"~~"),hs=l=>me(l,"`"),us=l=>me(l,"==");function gs(l){const{from:e,to:t}=l.state.selection.main,s=l.state.doc,n=s.toString(),i=/--.*?--/gd,a=[];for(const u of n.matchAll(i)){const g=u.indices?.[0];g&&a.push({start:g[0],end:g[1],content:u[0]})}for(const{start:u,end:g,content:p}of a)if(e>=u+2&&t<=g-2){const f=p.substring(2,p.length-2).replace(/(\s*\[[^\]]*\]\s*)?(\^\^.*?\^\^)?$/,"");return l.dispatch({changes:{from:u,to:g,insert:f},selection:{anchor:u,head:u+f.length}}),l.focus(),!0}let o=e,r=t;for(const{start:u,end:g}of a)(o>=u&&o<=g||r>=u&&r<=g||o<=u&&r>=g||s.sliceString(g,o).trim()===""&&g<=o||s.sliceString(r,u).trim()===""&&r<=u)&&(o=Math.min(o,u),r=Math.max(r,g));const c=s.sliceString(o,r).replace(/--/g,"");if(!c.trim())return l.focus(),!0;const h=`--[${`c${Date.now()}`}] ${c.trim()}--`;return l.dispatch({changes:{from:o,to:r,insert:h},selection:{anchor:o+2,head:o+h.length-2}}),l.focus(),!0}function ps(l){const{state:e}=l,{from:t,to:s}=e.selection.main;if(t===s)return alert(" Cloze "),!1;const n=e.doc.sliceString(t,s),i=prompt(":",n);if(i===null)return!1;const a=`--${n}--^^audio:${i.trim()}^^`;return l.dispatch({changes:{from:t,to:s,insert:a}}),l.focus(),!0}function st(l){return l.dispatch({changes:{from:l.state.selection.main.from,insert:""}}),l.focus(),!0}function He(l,e){const{state:t}=l,{from:s,to:n}=t.selection.main,i=t.doc.lineAt(s),a=t.doc.lineAt(n),o=[],r=[];let c=!0;for(let d=i.number;d<=a.number;d++){const h=t.doc.line(d),u=h.length>0&&h.text.trimStart().startsWith(e);r.push({line:h,hasPrefix:u}),h.length>0&&!u&&(c=!1)}for(const{line:d,hasPrefix:h}of r)if(c){if(d.text.includes(e)){const u=d.text.indexOf(e);o.push({from:d.from+u,to:d.from+u+e.length,insert:""})}}else d.length>0&&!h&&o.push({from:d.from,insert:e});return o.length>0&&l.dispatch({changes:o}),l.focus(),!0}const ms=l=>He(l,"- "),fs=l=>He(l,"1. "),ys=l=>He(l,"- [ ] "),vs=l=>He(l,"> "),bs=l=>{const{from:e}=l.state.selection.main,t=l.state.doc.lineAt(e),s=t.text;let n;return s.startsWith("## ")?n={from:t.from,to:t.from+3,insert:"### "}:s.startsWith("### ")?n={from:t.from,to:t.from+4,insert:""}:n={from:t.from,insert:"## "},l.dispatch({changes:[n]}),l.focus(),!0};function ws(l){const{from:e}=l.state.selection.main,t=l.state.doc.lineAt(e),s=t.to,n=t.length>0?`

---
`:`
---
`;return l.dispatch({changes:{from:s,insert:n},selection:jt.cursor(s+n.length)}),l.focus(),!0}function Ss(l){const e=prompt("","3"),t=prompt("","3");if(!e||!t)return!1;const s=parseInt(e,10),n=parseInt(t,10);if(isNaN(s)||isNaN(n)||s<1||n<1)return alert(""),!1;const i=Array(n).fill("").join(" | "),a=Array(n).fill("---").join(" | "),o=Array(n).fill("").join(" | "),c=["",`| ${i} |`,`| ${a} |`,...Array(s-1).fill(`| ${o} |`),""].join(`
`);return l.dispatch({changes:{from:l.state.selection.main.from,insert:c}}),l.focus(),!0}function Es(l){const e=prompt(" ():",""),{state:t}=l,{from:s,to:n}=t.selection.main,i=t.sliceDoc(s,n)||"",a=`\`\`\`${e||""}
${i}
\`\`\``;return l.dispatch({changes:{from:s,to:n,insert:a},selection:jt.cursor(s+4+(e?.length||0))}),l.focus(),!0}function _s(l){const e=prompt(" URL:","https://");if(!e)return!1;const{state:t}=l,{from:s,to:n}=t.selection.main,a=t.sliceDoc(s,n)||"",o=`[${a}](${e})`;return l.dispatch({changes:{from:s,to:n,insert:o},selection:{anchor:s+1,head:s+1+a.length}}),l.focus(),!0}function xs(l){const e=prompt(" URL:","https://");if(!e)return!1;const{state:t}=l,{from:s,to:n}=t.selection.main,a=`![${t.sliceDoc(s,n)||""}](${e})`;return l.dispatch({changes:{from:s,to:n,insert:a}}),l.focus(),!0}function Xi(l,e){if(typeof e!="function")return console.warn("AI callback is not a function."),!1;const{from:t,to:s}=l.state.selection.main,n=l.state.doc.sliceString(t,s),i=n.length>0?n:l.state.doc.toString();return e(i),l.focus(),!0}function Zi(l,e){if(typeof e!="function")return console.warn("Save callback is not a function."),!1;const t=l.state.doc.toString();return e(t),l.focus(),!0}async function ea(l){let e=document.getElementById("mdx-print-container");e||(e=document.createElement("div"),e.id="mdx-print-container",e.className="rich-content-area",document.body.appendChild(e));try{if(l.getMode()==="render"){const t=l.getRenderContainer();t&&(e.innerHTML=t.innerHTML)}else{const t=l.getText();await l.getRenderer().render(e,t,{areAllClozesVisible:!0})}document.body.classList.add("mdx-printing"),window.print()}catch(t){return console.error("Printing failed:",t),!1}finally{if(document.body.classList.remove("mdx-printing"),e&&(e.innerHTML=""),l.getMode()==="edit"){const t=l.getEditorView();t&&t.focus()}}return!0}const ta=Object.freeze(Object.defineProperty({__proto__:null,applyAudioCloze:ps,applyBold:ls,applyCloze:gs,applyCodeBlock:Es,applyHighlight:us,applyInlineCode:hs,applyItalic:cs,applyLink:_s,applyMarkdownFormatting:me,applyStrikethrough:ds,handleAIAction:Xi,handlePrintAction:ea,handleSaveAction:Zi,insertHorizontalRule:ws,insertImage:xs,insertLinebreak:st,insertTable:Ss,toggleBlockquote:vs,toggleHeading:bs,toggleOrderedList:fs,toggleTaskList:ys,toggleUnorderedList:ms},Symbol.toStringTag,{value:"Module"})),Cs=Symbol("ClozeAPI");class sa{name="feature:cloze";options;cleanupFns=[];contextStates=new WeakMap;delegationHandlers=new WeakMap;constructor(e={}){this.options={className:e.className||"mdx-cloze",audioIconClass:e.audioIconClass||"fas fa-volume-up"}}getContextState(e){return this.contextStates.has(e)||this.contextStates.set(e,{clozeCounter:0}),this.contextStates.get(e)}createBeforeParseHook(e){return t=>(this.getContextState(e).clozeCounter=0,t)}createSyntaxExtension(e){return{extensions:[{name:"cloze:cloze",level:"inline",start:t=>t.match(/--/)?.index,tokenizer:t=>{const s=this.getContextState(e),n=t.match(/^--(?:\[([^\]]+)\]\s*)?([\s\S]+?)--(?:\^\^audio:([^^]+)\^\^)?/);if(n)return{type:"cloze:cloze",raw:n[0],locator:n[1]||`auto-${s.clozeCounter++}`,content:n[2].trim(),audio:n[3]?.trim()}},renderer:t=>{const s=t.audio?`<span class="${this.options.className}__audio" data-audio-text="${this.escapeHtml(t.audio)}"><i class="${this.options.audioIconClass}"></i></span>`:"",n=this.escapeHtml(t.content),i=t.content.replace(//g,"<br/>");return`<span class="${this.options.className} hidden" data-cloze-locator="${t.locator}" data-cloze-content="${n}">
              <span class="${this.options.className}__content">${i}</span><span class="${this.options.className}__placeholder">[...]</span>
              ${s}
            </span>`}}]}}escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}install(e){const t=e.on("beforeParse",this.createBeforeParseHook(e));if(t&&this.cleanupFns.push(t),e.registerSyntaxExtension(this.createSyntaxExtension(e)),e.provide(Cs,()=>({toggleAll:(n,i)=>{(i||document).querySelectorAll(`.${this.options.className}`).forEach(r=>{n?r.classList.remove("hidden"):r.classList.add("hidden")})}})),!e.registerCommand||!e.registerToolbarButton)console.warn("ClozePlugin: Command registration is not available in this context.");else{const{registerCommand:n,registerToolbarButton:i}=e;i({id:`sep-cloze-${Date.now()}`,type:"separator"}),n("applyCloze",a=>a?gs(a):!1),i({id:"cloze",title:" (--text--)",icon:'<i class="fas fa-highlighter"></i>',command:"applyCloze"}),n("applyAudioCloze",a=>a?ps(a):!1),i({id:"audioCloze",title:"",icon:'<i class="fas fa-volume-up"></i>',command:"applyAudioCloze"}),n("insertLinebreak",a=>ta&&st?st(a):!1),i({id:"linebreak",title:" ()",icon:'<i class="fas fa-paragraph"></i>',command:"insertLinebreak"})}const s=e.on("domUpdated",({element:n})=>{this.setupEventDelegation(n,e)});s&&this.cleanupFns.push(s)}setupEventDelegation(e,t){const s=this.delegationHandlers.get(e);s&&e.removeEventListener("click",s);const n=i=>{const a=i.target,o=a.closest(`.${this.options.className}__audio`);if(o){const d=o.getAttribute("data-audio-text");if(d&&"speechSynthesis"in window){i.stopPropagation();const h=new SpeechSynthesisUtterance(d);speechSynthesis.speak(h)}return}const r=a.closest(`.${this.options.className}`);if(!r)return;i.stopPropagation();const c=r.classList.contains("hidden");r.classList.toggle("hidden"),c&&t.emit("clozeRevealed",{element:r,clozeId:r.dataset.clozeLocator,content:r.dataset.clozeContent,hide:()=>r.classList.add("hidden"),show:()=>r.classList.remove("hidden")})};e.addEventListener("click",n),this.delegationHandlers.set(e,n)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class pt{name="cloze:cloze-controls";options;cleanupFns=[];panel=null;container=null;currentIndex=0;isAllOpen=!1;isExpanded=!0;manuallyOpenedClozes=new Set;static MAX_TRACKED_CLOZES=1e3;constructor(e={}){this.options={className:e.className||"mdx-cloze-controls"}}install(e){const t=e.inject(Cs);if(!t){console.warn("ClozeControlsPlugin requires ClozePlugin to be installed.");return}const s=e.listen("clozeRevealed",i=>{const a=i.element.getAttribute("data-cloze-locator");a&&this.trackOpenedCloze(a)});s&&this.cleanupFns.push(s);const n=e.on("domUpdated",({element:i})=>{this.container=i,this.createPanel(e,t),this.updateAllClozeContent(),this.restoreOpenStates(t,e)});n&&this.cleanupFns.push(n)}trackOpenedCloze(e){if(this.manuallyOpenedClozes.delete(e),this.manuallyOpenedClozes.add(e),this.manuallyOpenedClozes.size>pt.MAX_TRACKED_CLOZES){const t=this.manuallyOpenedClozes.values().next().value;t&&this.manuallyOpenedClozes.delete(t)}}restoreOpenStates(e,t){this.container&&(this.isAllOpen?(this.container.classList.add("is-global-override"),e().toggleAll(!0,this.container),setTimeout(()=>{t.emit("clozeBatchGradeToggle",{container:this.container})},50)):this.container.querySelectorAll(".mdx-cloze").forEach(n=>{const i=n.getAttribute("data-cloze-locator");i&&this.manuallyOpenedClozes.has(i)&&n.classList.remove("hidden")}))}createPanel(e,t){if(this.panel&&this.container&&!this.container.contains(this.panel)&&(this.panel.remove(),this.panel=null),this.panel)return;this.panel=document.createElement("div"),this.panel.className=this.options.className;const s=this.isAllOpen?"fa-eye-slash":"fa-eye",n=this.isExpanded?"fa-compress-alt":"fa-expand-alt";this.panel.innerHTML=`
      <div class="${this.options.className}__menu">
        <button class="${this.options.className}__btn" data-action="prev" title=""><i class="fas fa-arrow-up"></i></button>
        <button class="${this.options.className}__btn" data-action="next" title=""><i class="fas fa-arrow-down"></i></button>
        <button class="${this.options.className}__btn" data-action="toggle-expand" title="/"><i class="fas ${n}"></i></button>
        <button class="${this.options.className}__btn" data-action="reverse" title=""><i class="fas fa-retweet"></i></button>
        <button class="${this.options.className}__btn" data-action="toggle-visible" title="/"><i class="fas ${s}"></i></button>
      </div>
      <div class="${this.options.className}__toggle"><i class="fas fa-tools"></i></div>
    `,this.panel.addEventListener("click",i=>{const a=i.target.closest("button");if(!a||!this.container)return;const o=a.getAttribute("data-action"),r=a.querySelector("i");switch(o){case"prev":this.navigate(-1);break;case"next":this.navigate(1);break;case"toggle-expand":this.isExpanded=!this.isExpanded,r&&(r.className=this.isExpanded?"fas fa-compress-alt":"fas fa-expand-alt"),this.updateAllClozeContent();break;case"toggle-visible":this.isAllOpen=!this.isAllOpen,this.isAllOpen?(this.container.classList.add("is-global-override"),t().toggleAll(!0,this.container),e.emit("clozeBatchGradeToggle",{container:this.container})):(this.container.classList.remove("is-global-override"),t().toggleAll(!1,this.container),this.manuallyOpenedClozes.clear()),r&&(r.className=this.isAllOpen?"fas fa-eye-slash":"fas fa-eye");break;case"reverse":this.container.classList.add("is-global-override"),this.container.querySelectorAll(".mdx-cloze").forEach(d=>{const h=d.classList.contains("hidden");d.classList.toggle("hidden");const u=d.getAttribute("data-cloze-locator");u&&(h?this.manuallyOpenedClozes.add(u):this.manuallyOpenedClozes.delete(u))}),e.emit("clozeBatchGradeToggle",{container:this.container});break}}),this.container?.appendChild(this.panel)}updateAllClozeContent(){if(!this.container)return;const e=this.container.querySelectorAll(".mdx-cloze__content");if(e.length===0)return;const t=[];e.forEach(s=>{const n=s.parentElement;if(!n)return;const i=n.getAttribute("data-cloze-content")||"";let a;if(this.isExpanded)a=i.replace(//g,"<br/>");else{let o=i.replace(//g," ");o.length>100&&(o=o.substring(0,100)+"..."),a=S(o)}t.push({span:s,html:a})}),t.forEach(({span:s,html:n})=>{this.isExpanded?s.innerHTML=n:s.textContent=n})}navigate(e){if(!this.container)return;const t=Array.from(this.container.querySelectorAll(".mdx-cloze.hidden"));if(t.length===0)return;this.currentIndex=(this.currentIndex+e+t.length)%t.length;const s=t[this.currentIndex];s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("mdx-cloze--highlight"),setTimeout(()=>s.classList.remove("mdx-cloze--highlight"),1e3)}destroy(){this.panel&&this.panel.remove(),this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.panel=null,this.container=null,this.manuallyOpenedClozes.clear()}}class na{name="cloze:memory";options;cleanupFns=[];clozeStatesCache=new WeakMap;storeRef=null;syncedContexts=new WeakSet;syncPromise=null;constructor(e={}){this.options={gradingTimeout:e.gradingTimeout||3e5,className:e.className||"mdx-memory",coolingPeriod:e.coolingPeriod||6e4,dangerThresholdDays:e.dangerThresholdDays||7,debug:e.debug??!1,hideBeforeDueHours:e.hideBeforeDueHours??12}}log(e,...t){this.options.debug}getCache(e){return this.clozeStatesCache.has(e)||this.clozeStatesCache.set(e,new Map),this.clozeStatesCache.get(e)}install(e){this.storeRef=e.getScopedStore();const t=e.listen("clozeRevealed",i=>{if(i.element.dataset.stateClass==="is-cooling"){this.log("Card is cooling, skip grading panel",i.clozeId);return}const r=i.element.closest(".is-global-override")?0:this.options.gradingTimeout;this.showGradingPanel(i.element,e,r)});t&&this.cleanupFns.push(t);const s=e.listen("clozeBatchGradeToggle",i=>{this.showBatchGrading(e,i.container)});s&&this.cleanupFns.push(s);const n=e.on("domUpdated",async({element:i})=>{this.log("DOM updated, checking sync status..."),this.syncedContexts.has(e)||(this.syncPromise||(this.syncPromise=this.syncWithStore(e).finally(()=>{this.syncPromise=null})),await this.syncPromise,this.syncedContexts.add(e)),this.applyVisualsAndState(i,e)});n&&this.cleanupFns.push(n)}async forceResync(e){this.syncedContexts.delete(e),await this.syncWithStore(e),this.syncedContexts.add(e)}async syncWithStore(e){const t=e.getSessionEngine?.(),s=e.getCurrentNodeId(),n=this.getCache(e);if(n.clear(),this.log(`Syncing store. FileID: ${s||"N/A"}, Engine Available: ${!!t}`),t&&t.getSRSStatus&&s)try{const i=await t.getSRSStatus(s),a=Object.keys(i).length;this.log(`Loaded ${a} items from Engine VFS.`);for(const[o,r]of Object.entries(i))n.set(o,{dueAt:new Date(r.dueAt).toISOString(),lastReviewedAt:new Date(r.lastReviewedAt).toISOString(),lastGrade:0,reviewCount:r.reviewCount,interval:r.interval,easeFactor:r.ease});return}catch(i){console.warn("[MemoryPlugin] Failed to sync from Engine, falling back to Metadata store.",i)}else this.log("Skipping Engine sync (Conditions not met). Fallback to metadata?");if(this.storeRef)try{const i=await this.storeRef.get("_mdx_srs"),a=i?Object.keys(i).length:0;if(this.log(`Loaded ${a} items from Metadata Store (Fallback).`),i)for(const[o,r]of Object.entries(i))n.set(o,r)}catch(i){console.warn("[MemoryPlugin] Metadata sync error:",i)}}async saveCardState(e,t,s){const n=e.getSessionEngine?.(),i=e.getCurrentNodeId();if(this.log(`Saving card ${t} to FileID: ${i}`),n&&n.updateSRSStatus&&i)try{const a={dueAt:s.dueAt?new Date(s.dueAt).getTime():Date.now(),lastReviewedAt:s.lastReviewedAt?new Date(s.lastReviewedAt).getTime():Date.now(),interval:s.interval,ease:s.easeFactor,reviewCount:s.reviewCount};await n.updateSRSStatus(i,t,a),this.log("Saved successfully to Engine VFS.");return}catch(a){console.error("[MemoryPlugin] Failed to save to Engine:",a)}if(this.storeRef)try{const a=this.getCache(e),o={};a.forEach((r,c)=>{o[c]=r}),await this.storeRef.set("_mdx_srs",o),this.log("Saved successfully to Metadata Store (Fallback).")}catch(a){console.error("[MemoryPlugin] Metadata save error:",a)}}determineStateClass(e){if(!e||e.reviewCount===0)return"is-new";const t=new Date,s=e.dueAt?new Date(e.dueAt):t,n=e.lastReviewedAt?new Date(e.lastReviewedAt):null;if(e.interval*24*60*60*1e3<this.options.coolingPeriod*2&&n&&s>t&&t.getTime()-n.getTime()<this.options.coolingPeriod)return"is-cooling";const i=s.getTime()-t.getTime(),a=this.options.hideBeforeDueHours*60*60*1e3;return i>a?"is-cleared":e.interval<1?"is-learning":-i/(24*60*60*1e3)>=this.options.dangerThresholdDays?"is-danger":"is-due"}applyVisualsAndState(e,t){const s=e.classList.contains("is-global-override")||!!e.closest(".is-global-override"),n=this.getCache(t),i=e.querySelectorAll(".mdx-cloze");let a=0;i.forEach(o=>{const r=o.getAttribute("data-cloze-locator");if(!r)return;const c=n.get(r);c&&a++;const d=this.determineStateClass(c);o.classList.remove("is-new","is-cooling","is-learning","is-due","is-danger","is-cleared"),o.classList.add(d),o.dataset.stateClass=d,s||(d==="is-cleared"||d==="is-cooling"?o.classList.remove("hidden"):o.classList.add("hidden"))}),this.log(`Applied visuals. Found ${i.length} clozes in DOM. Matched ${a} from Store.`)}showGradingPanel(e,t,s=0){const n=e.querySelector(`.${this.options.className}__panel`);n&&n.remove();const i=document.createElement("div");i.className=`${this.options.className}__panel`,i.addEventListener("click",o=>o.stopPropagation()),i.innerHTML=`
      <button data-grade="1" title=" (1)">Again</button>
      <button data-grade="2" title=" (10)">Hard</button>
      <button data-grade="3" title=" ()">Good</button>
      <button data-grade="4" title=" (4)">Easy</button>
    `;let a=null;s>0&&(a=setTimeout(()=>i.remove(),s)),i.addEventListener("click",async o=>{const r=o.target.closest("button");if(!r)return;a&&clearTimeout(a);const c=parseInt(r.getAttribute("data-grade")||"3",10);i.remove(),await this.gradeCard(e,c,t)}),e.appendChild(i)}showBatchGrading(e,t){(t||document).querySelectorAll(".mdx-cloze:not(.hidden):not(.is-cooling)").forEach(i=>{this.showGradingPanel(i,e,0)})}calculateNextReview(e,t){const s=new Date,n=e?{...e}:{dueAt:null,lastReviewedAt:null,lastGrade:null,reviewCount:0,interval:0,easeFactor:2.5},i=1/1440,a=10/1440;let o;if(t===1)n.easeFactor=Math.max(1.3,n.easeFactor-.2),o=i;else if(n.interval<1)switch(t){case 2:o=i*5;break;case 3:o=n.interval>=a*.9?1:a;break;case 4:o=4;break;default:o=i}else switch(t){case 2:n.easeFactor=Math.max(1.3,n.easeFactor-.15),o=n.interval*1.2;break;case 3:o=n.interval*n.easeFactor;break;case 4:n.easeFactor+=.15,o=n.interval*n.easeFactor*1.3;break;default:o=1}return n.lastReviewedAt=s.toISOString(),n.lastGrade=t,n.reviewCount++,n.interval=o,n.dueAt=new Date(s.getTime()+o*24*60*60*1e3).toISOString(),n}async gradeCard(e,t,s){const n=e.getAttribute("data-cloze-locator");if(n)try{const i=this.getCache(s),a=i.get(n),o=this.calculateNextReview(a,t);i.set(n,o),await this.saveCardState(s,n,o),e.classList.remove("is-new","is-cooling","is-learning","is-due","is-danger","is-cleared");const r=this.determineStateClass(o);e.classList.add(r),e.dataset.stateClass=r,(r==="is-cleared"||r==="is-cooling")&&e.classList.remove("hidden"),this.log(`Graded "${n}" with ${t}. State: ${r}`)}catch(i){console.error("[MemoryPlugin] grading error:",i)}}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.storeRef=null,this.syncPromise=null}}class ia{name="interaction:clipboard";options;turndownService;constructor(e={}){this.options={enableHtmlToMarkdown:e.enableHtmlToMarkdown??!0,enableImagePaste:e.enableImagePaste??!0,turndownOptions:e.turndownOptions??{}},this.turndownService=new ln({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-",...this.options.turndownOptions}),this.turndownService.use(cn),this.turndownService.addRule("images",{filter:"img",replacement:(t,s)=>{const n=s,i=n.alt||"",a=n.src||"",o=n.title?` "${n.title}"`:"";return a.startsWith("data:")?`![${i}](${a})<!-- base64-image -->`:a.startsWith("http")?`![${i}](${a}${o})`:`![${i}](${a}${o})`}})}install(e){const t=Q.domEventHandlers({paste:(s,n)=>this.handlePaste(s,n)});e.registerCodeMirrorExtension?.(t)}handlePaste(e,t){const s=e.clipboardData;if(!s||this.options.enableImagePaste&&s.files.length>0&&Array.from(s.files).filter(i=>i.type.startsWith("image/")).length>0)return!1;if(this.options.enableHtmlToMarkdown){const n=s.getData("text/html");if(n&&this.isRichContent(n)){e.preventDefault();const i=this.convertHtmlToMarkdown(n);return this.insertText(t,i),!0}}return!1}isRichContent(e){const n=new DOMParser().parseFromString(e,"text/html").body,i=["h1","h2","h3","h4","h5","h6","p","br","strong","b","em","i","u","s","del","a","img","ul","ol","li","table","thead","tbody","tr","th","td","pre","code","blockquote","hr"];for(const r of i)if(n.querySelector(r))return!0;return(n.textContent||"").includes(`
`)||n.querySelectorAll("div, span").length>1}convertHtmlToMarkdown(e){try{const t=this.preprocessHtml(e);let s=this.turndownService.turndown(t);return s=this.postprocessMarkdown(s),s}catch(t){return console.error("[ClipboardPlugin] HTML to Markdown conversion failed:",t),new DOMParser().parseFromString(e,"text/html").body.textContent||""}}preprocessHtml(e){const s=new DOMParser().parseFromString(e,"text/html");return s.querySelectorAll("script, style, meta, link").forEach(n=>n.remove()),s.querySelectorAll("[style]").forEach(n=>n.removeAttribute("style")),s.body.innerHTML}postprocessMarkdown(e){return e.replace(/\n{3,}/g,`

`).replace(/[ \t]+$/gm,"").replace(/([^\n])\n```/g,"$1\n\n```").replace(/```\n([^\n])/g,"```\n\n$1").trim()}insertText(e,t){const{from:s,to:n}=e.state.selection.main;e.dispatch({changes:{from:s,to:n,insert:t},selection:{anchor:s+t.length}})}destroy(){}}const kt={maxSize:10*1024*1024,accept:["image/*","application/pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".md",".json",".svg"]};function aa(l,e){if(l.startsWith(".")||e?.excludePattern&&e.excludePattern.test(l))return!1;if(e?.extensions&&e.extensions.length>0){const t="."+l.split(".").pop()?.toLowerCase();return e.extensions.includes(t)}return!0}function Is(l){return`@asset/${l}`}function Re(l){let e=l;return e.startsWith("@asset/")?e=e.slice(7):e.startsWith("./")&&(e=e.slice(2)),e.split("?")[0].split("#")[0].split("/").pop()||e}function oa(l){return{maxSize:l.uploadLimit?.maxSize??kt.maxSize,accept:l.uploadLimit?.accept??[...kt.accept]}}function ra(l,e){if(l.size>e.maxSize)return{valid:!1,error:` (${(e.maxSize/1048576).toFixed(1)}MB)`};const t=l.name.toLowerCase(),s=l.type.toLowerCase();return!e.accept||e.accept.length===0?{valid:!0}:e.accept.some(i=>{const a=i.toLowerCase().trim();if(a.startsWith("."))return t.endsWith(a);if(a.endsWith("/*")){const o=a.slice(0,-2);return s.startsWith(o)}else return s===a})?{valid:!0}:{valid:!1,error:""}}class la{name="interaction:upload";context;uploadLimits;fileInput=null;currentEditor=null;constructor(e={}){this.uploadLimits=oa(e)}install(e){this.context=e,this.initHiddenInput(),e.registerToolbarButton?.({id:"upload-action",title:"",icon:`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>`,onClick:({editor:s})=>{this.currentEditor=s,this.fileInput?.click()}});const t=Q.domEventHandlers({paste:(s,n)=>{const i=s.clipboardData?.files;return i&&i.length>0?(s.preventDefault(),this.processFiles(i,n).catch(a=>console.error(a)),!0):!1},drop:(s,n)=>{const i=s.dataTransfer?.files;return i&&i.length>0?(s.preventDefault(),this.processFiles(i,n).catch(a=>console.error(a)),!0):!1}});e.registerCodeMirrorExtension?.(t)}initHiddenInput(){this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.multiple=!0,this.fileInput.style.display="none",this.uploadLimits.accept.length>0&&(this.fileInput.accept=this.uploadLimits.accept.join(",")),document.body.appendChild(this.fileInput),this.fileInput.addEventListener("change",async()=>{const e=this.fileInput?.files;if(!e||e.length===0)return;const t=this.currentEditor?.getEditorView();t?(t.focus(),await this.processFiles(e,t)):m.error(""),this.fileInput&&(this.fileInput.value="")})}async processFiles(e,t){const s=this.context.getSessionEngine?.(),n=this.context.getOwnerNodeId?.();if(!s){console.warn("[UploadPlugin] No engine available."),m.error("");return}if(!n){console.warn("[UploadPlugin] No ownerNodeId defined."),m.error("");return}const i=`upload-${Date.now().toString(36)}`,a=`![Uploading ${e.length} files... #${i}]()`,{from:o}=t.state.selection.main;t.dispatch({changes:{from:o,insert:a}});try{const r=[],c=[];for(let u=0;u<e.length;u++){const g=e[u],p=ra(g,this.uploadLimits);if(!p.valid){const U=` ${g.name}: ${p.error}`;c.push(U),console.warn(U);continue}const f=this.generateSafeFilename(g.name),v=await g.arrayBuffer(),b=await s.createAsset(n,f,v),I=Is(b.name);r.push(this.generateMarkdown(g,I))}c.length>0&&m.error(`:
${c.slice(0,3).join(`
`)}${c.length>3?"...":""}`);const h=t.state.doc.toString().indexOf(a);if(h>=0){const u=r.length>0?`
`+r.join(`
`)+`
`:"";t.dispatch({changes:{from:h,to:h+a.length,insert:u},selection:{anchor:h+u.length}}),r.length>0&&m.success(` ${r.length} `)}}catch(r){console.error("[UploadPlugin] Upload failed:",r),m.error("");const d=t.state.doc.toString().indexOf(a);d>=0&&t.dispatch({changes:{from:d,to:d+a.length,insert:""}})}}generateSafeFilename(e){return e.replace(/[^a-zA-Z0-9._-]/g,"_")}generateMarkdown(e,t){return e.type.startsWith("image/")?`![${e.name}](${t})`:e.type==="application/pdf"?`![${e.name}](${t})`:`[${e.name}](${t})`}destroy(){this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.fileInput=null,this.currentEditor=null}}class ca{name="interaction:table";options;cleanupFns=[];tableStateMap=new WeakMap;constructor(e={}){this.options={enableSorting:e.enableSorting??!0,enableFiltering:e.enableFiltering??!1,containerClass:e.containerClass??"mdx-table-container"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processTables(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processTables(e){e.querySelectorAll("table").forEach(s=>{if(!s.parentElement?.classList.contains(this.options.containerClass)){const o=document.createElement("div");o.className=this.options.containerClass,s.parentNode?.insertBefore(o,s),o.appendChild(s)}const n=s.querySelector("tbody");if(!n)return;const i=Array.from(n.querySelectorAll("tr"));this.tableStateMap.set(s,{originalRows:i,currentSort:null});const a=s.querySelector("thead");a&&(this.options.enableSorting&&this.initSorting(s,a,n),this.options.enableFiltering&&this.initFiltering(s,a,n))})}initSorting(e,t,s){const n=t.querySelectorAll("th");n.forEach((i,a)=>{i.classList.add("mdx-sortable-header"),i.setAttribute("title","Click to sort");const o=()=>{this.handleSort(e,s,i,a,n)};i.addEventListener("click",o)})}handleSort(e,t,s,n,i){const a=this.tableStateMap.get(e);if(!a)return;let o="asc";if(a.currentSort?.colIndex===n&&a.currentSort.direction==="asc"?o="desc":a.currentSort?.colIndex===n&&a.currentSort.direction==="desc"&&(o="none"),i.forEach(r=>{r.classList.remove("sort-asc","sort-desc"),r.removeAttribute("data-sort")}),o==="none")a.currentSort=null,this.renderRows(t,a.originalRows);else{s.classList.add(`sort-${o}`),s.setAttribute("data-sort",o),a.currentSort={colIndex:n,direction:o};const r=Array.from(t.querySelectorAll("tr"));r.sort((c,d)=>{const h=c.children[n]?.textContent?.trim()||"",u=d.children[n]?.textContent?.trim()||"";return this.compareCells(h,u,o)}),this.renderRows(t,r)}}compareCells(e,t,s){const n=parseFloat(e.replace(/[^0-9.-]/g,"")),i=parseFloat(t.replace(/[^0-9.-]/g,""));let a=0;const o=!isNaN(n)&&/^\d/.test(e),r=!isNaN(i)&&/^\d/.test(t);return o&&r?a=n-i:a=e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"}),s==="asc"?a:-a}initFiltering(e,t,s){const n=document.createElement("tr");n.className="mdx-table-filter-row";const i=t.rows[0].cells.length;for(let a=0;a<i;a++){const o=document.createElement("th"),r=document.createElement("input");r.type="text",r.placeholder="Filter...",r.className="mdx-table-filter-input",r.addEventListener("input",()=>{this.handleFilter(e,s,n)}),r.addEventListener("click",c=>c.stopPropagation()),o.appendChild(r),n.appendChild(o)}t.appendChild(n)}handleFilter(e,t,s){const n=this.tableStateMap.get(e);if(!n)return;const a=Array.from(s.querySelectorAll("input")).map(r=>r.value.toLowerCase());if(!a.some(r=>r!=="")){n.originalRows.forEach(r=>r.style.display="");return}n.originalRows.forEach(r=>{let c=!0;const d=r.cells;for(let h=0;h<a.length;h++){const u=a[h];if(!u)continue;if(!(d[h]?.textContent?.toLowerCase()||"").includes(u)){c=!1;break}}r.style.display=c?"":"none"})}renderRows(e,t){const s=document.createDocumentFragment();t.forEach(n=>s.appendChild(n)),e.appendChild(s)}}class da{name="interaction:task-list";options;cleanupFns=[];store=null;currentMarkdown="";taskLocations=[];renderTaskCounter=0;constructor(e={}){this.options={checkboxSelector:e.checkboxSelector||'input[type="checkbox"].mdx-task-item',autoUpdateMarkdown:e.autoUpdateMarkdown!==!1,beforeTaskToggle:e.beforeTaskToggle||(()=>!0),onTaskToggled:e.onTaskToggled||(()=>{})}}createMarkedExtension(){const e=this;return{hooks:{preprocess(t){return e.renderTaskCounter=0,t}},renderer:{listitem(t){const s=/^\[([ xX])\]/,n=t.match(s);if(n){const i=n[1]!==" ",a=e.renderTaskCounter++,o=`<input type="checkbox" class="mdx-task-item" ${i?"checked":""} data-task-index="${a}">`,r=t.substring(n[0].length);return`<li class="task-list-item">${o}${r}</li>
`}if(t.startsWith("<input")){const a=`<input class="mdx-task-item" data-task-index="${e.renderTaskCounter++}"`;return`<li class="task-list-item">${t.replace("<input",a)}</li>
`}return`<li>${t}</li>
`},tablecell(t,s){const n=s.header?"th":"td",i=s.align?`<${n} align="${s.align}">`:`<${n}>`,a=t.replace(/\[([ xX])\]/gi,(o,r)=>{const c=r.toLowerCase()==="x",d=e.renderTaskCounter++;return`<input type="checkbox" class="mdx-task-item mdx-table-task" ${c?"checked":""} data-task-index="${d}">`});return`${i}${a}</${n}>
`}}}}parseTaskLocations(e){this.taskLocations=[],e.split(`
`).forEach((s,n)=>{const i=n+1;if(/^\s*[-*+]\s+\[[ xX]\]/.test(s))this.taskLocations.push({lineNumber:i,indexInLine:0,isTableTask:!1});else if(s.includes("|")&&/\[[ xX]\]/.test(s)){const a=s.match(/\[[ xX]\]/g);a&&a.forEach((o,r)=>{this.taskLocations.push({lineNumber:i,indexInLine:r,isTableTask:!0})})}})}createClickHandler(e){return async t=>{const s=t.target;if(!s.matches(this.options.checkboxSelector)){s.tagName==="INPUT"&&s.type==="checkbox"&&console.warn("[TaskListPlugin] Checkbox clicked but selector mismatch.",{expected:this.options.checkboxSelector,actualClass:s.className});return}const n=s,i=n.getAttribute("data-task-index");if(i===null){console.error("[TaskListPlugin] Checkbox missing data-task-index attribute.");return}const a=parseInt(i,10),o=this.taskLocations[a];if(!o){console.error("[TaskListPlugin] Task location NOT found for index:",a,"Total locations:",this.taskLocations.length);return}let r="";o.isTableTask?r=n.parentElement?.textContent?.trim()||"":r=n.closest(".task-list-item")?.textContent?.trim()||"";const c={taskText:r,isChecked:n.checked,element:n,lineNumber:o.lineNumber,isTableTask:o.isTableTask};if(!await this.options.beforeTaskToggle(c)){t.preventDefault(),n.checked=!n.checked;return}const h={...c,originalMarkdown:this.currentMarkdown,updatedMarkdown:this.currentMarkdown,wasUpdated:!1};if(this.options.autoUpdateMarkdown){const u=this.updateMarkdown(o,c.isChecked);u?(h.updatedMarkdown=u,h.wasUpdated=!0,this.currentMarkdown=u,await this.store?.set("currentMarkdown",u)):console.warn("[TaskListPlugin] updateMarkdown returned null.")}e.emit("taskToggled",h),await this.options.onTaskToggled(h)}}updateMarkdown(e,t){const s=this.currentMarkdown,n=t?"[x]":"[ ]";let i=0,a=0,o=1;for(let d=0;d<s.length;d++){if(o===e.lineNumber){i=d,a=s.indexOf(`
`,d),a===-1&&(a=s.length);break}s[d]===`
`&&o++}if(o!==e.lineNumber)return console.warn("[TaskListPlugin] Line number out of bounds:",e.lineNumber),null;const r=s.substring(i,a);let c;if(e.isTableTask){let d=0;c=r.replace(/\[[ xX]\]/gi,h=>d===e.indexInLine?(d++,n):(d++,h))}else c=r.replace(/^(\s*[-*+]\s+)\[[ xX]\]/,`$1${n}`);return s.substring(0,i)+c+s.substring(a)}install(e){e.registerSyntaxExtension(this.createMarkedExtension()),this.store=e.getScopedStore(),this.store.get("currentMarkdown").then(n=>{n&&(this.currentMarkdown=n)});const t=e.on("beforeParse",({markdown:n})=>(this.currentMarkdown=n,this.parseTaskLocations(n),{markdown:n}));t&&this.cleanupFns.push(t);const s=e.on("domUpdated",({element:n})=>{const i=n._taskListClickHandler;i&&n.removeEventListener("click",i);const a=this.createClickHandler(e);n.addEventListener("click",a),n._taskListClickHandler=a});s&&this.cleanupFns.push(s)}setMarkdown(e){this.currentMarkdown=e,this.parseTaskLocations(e),this.store?.set("currentMarkdown",e)}getMarkdown(){return this.currentMarkdown}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class ha{name="interaction:codeblock-controls";options;cleanupFns=[];buttonHandlers=new WeakMap;processedBlocks=new WeakSet;constructor(e={}){this.options={collapseThreshold:e.collapseThreshold??250,collapsedHeight:e.collapsedHeight??250,classPrefix:e.classPrefix||"mdx-code-block",enableCopy:e.enableCopy!==!1,enableDownload:e.enableDownload!==!1,enableCollapse:e.enableCollapse!==!1,defaultCollapsed:e.defaultCollapsed!==!1,expandText:e.expandText||"",streamingMode:e.streamingMode??!1,streamingMinLines:e.streamingMinLines??5,icons:{copy:e.icons?.copy||"",copied:e.icons?.copied||"",download:e.icons?.download||"",collapse:e.icons?.collapse||"",expand:e.icons?.expand||""}}}_createButton(e,t,s,n){const i=document.createElement("button");i.className=`${this.options.classPrefix}-controls__button`,i.setAttribute("aria-label",t),i.title=t,i.innerHTML=e,i.type="button";const a=o=>{o.preventDefault(),o.stopPropagation(),s(i,n)};return i.addEventListener("click",a),this.buttonHandlers.set(i,()=>{i.removeEventListener("click",a)}),this.cleanupFns.push(()=>{const o=this.buttonHandlers.get(i);o&&(o(),this.buttonHandlers.delete(i))}),i}_createCopyButton(e){return this._createButton(this.options.icons.copy,"Copy code",async t=>{const s=e.textContent||"";try{await navigator.clipboard.writeText(s);const n=t.innerHTML,i=t.title;t.innerHTML=this.options.icons.copied,t.title="Copied!",t.classList.add(`${this.options.classPrefix}-controls__button--success`),setTimeout(()=>{t.innerHTML=n,t.title=i,t.classList.remove(`${this.options.classPrefix}-controls__button--success`)},1500)}catch(n){console.error("Failed to copy code:",n),t.innerHTML="",t.title="Copy failed",this._fallbackCopy(s)}},e)}_fallbackCopy(e){const t=document.createElement("textarea");t.value=e,t.style.cssText="position:fixed;opacity:0;pointer-events:none;",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(s){console.error("Fallback copy failed:",s)}finally{document.body.removeChild(t)}}_createDownloadButton(e){return this._createButton(this.options.icons.download,"Download code",()=>{const t=e.textContent||"",s=e.querySelector("code"),n=s?Array.from(s.classList).find(d=>d.startsWith("language-")):null,a=`code.${n?n.replace("language-",""):"txt"}`,o=new Blob([t],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(o),c=document.createElement("a");c.href=r,c.download=a,c.style.display="none",document.body.appendChild(c),c.click(),requestAnimationFrame(()=>{document.body.removeChild(c),URL.revokeObjectURL(r)})},e)}_shouldShowCollapseButton(e){return this.options.streamingMode?(e.textContent||"").split(`
`).length>=this.options.streamingMinLines:e.scrollHeight>this.options.collapseThreshold}_createCollapseControls(e,t){if(!this._shouldShowCollapseButton(t))return null;const s=this._createButton("","",a=>{this._toggleCollapse(e,a,t)},t);s.classList.add(`${this.options.classPrefix}-controls__button--collapse`);const n=document.createElement("div");n.className=`${this.options.classPrefix}-expand-trigger`,n.innerHTML=`<span>${this.options.icons.expand} ${this.options.expandText}</span>`;const i=()=>{this._toggleCollapse(e,s,t)};return n.addEventListener("click",i),this.cleanupFns.push(()=>n.removeEventListener("click",i)),this.options.defaultCollapsed?(e.classList.add(`${this.options.classPrefix}-wrapper--collapsed`),this._updateCollapseState(e,s,t,!1)):this._updateCollapseState(e,s,t,!0),{button:s,trigger:n}}_updateCollapseState(e,t,s,n){t.innerHTML=n?this.options.icons.collapse:this.options.icons.expand,t.title=n?"Collapse code":"Expand code",t.setAttribute("aria-expanded",String(n)),this.options.streamingMode?n?(s.style.maxHeight="none",e.classList.remove(`${this.options.classPrefix}-wrapper--height-limited`)):(s.style.maxHeight=`${this.options.collapsedHeight}px`,e.classList.add(`${this.options.classPrefix}-wrapper--height-limited`)):n?s.style.maxHeight=`${s.scrollHeight+50}px`:s.style.maxHeight=`${this.options.collapsedHeight}px`}_toggleCollapse(e,t,s){const n=!e.classList.toggle(`${this.options.classPrefix}-wrapper--collapsed`);this._updateCollapseState(e,t,s,n)}enhanceCodeBlock(e){if(e.hasAttribute("data-enhanced")){this.options.streamingMode&&this._updateExistingBlock(e);return}e.setAttribute("data-enhanced","true");const t=document.createElement("div");t.className=`${this.options.classPrefix}-wrapper`,e.parentNode?.insertBefore(t,e),t.appendChild(e);const s=document.createElement("div");s.className=`${this.options.classPrefix}-controls`;const n=document.createElement("div");n.className=`${this.options.classPrefix}-controls__right`;const i=document.createDocumentFragment();if(this.options.enableDownload&&i.appendChild(this._createDownloadButton(e)),this.options.enableCopy&&i.appendChild(this._createCopyButton(e)),this.options.enableCollapse){const a=this._createCollapseControls(t,e);a&&(i.appendChild(a.button),t.appendChild(a.trigger),t.setAttribute("data-has-collapse","true"))}i.childNodes.length>0&&(n.appendChild(i),s.appendChild(n),t.prepend(s)),this.processedBlocks.add(t)}_updateExistingBlock(e){const t=e.closest(`.${this.options.classPrefix}-wrapper`);if(t&&!t.hasAttribute("data-has-collapse")&&this._shouldShowCollapseButton(e)&&this.options.enableCollapse){const s=this._createCollapseControls(t,e);if(s){const n=t.querySelector(`.${this.options.classPrefix}-controls__right`);n&&n.appendChild(s.button),t.appendChild(s.trigger),t.setAttribute("data-has-collapse","true")}}}enhanceCodeBlocks(e){const t=this.options.streamingMode?"pre":"pre:not([data-enhanced])",s=e.querySelectorAll(t);if(s.length===0)return;if(this.options.streamingMode||s.length<=5){s.forEach(o=>this.enhanceCodeBlock(o));return}let n=0;const i=5,a=()=>{const o=Math.min(n+i,s.length);for(;n<o;n++)this.enhanceCodeBlock(s[n]);n<s.length&&requestAnimationFrame(a)};requestAnimationFrame(a)}install(e){const t=e.on("domUpdated",({element:s})=>{this.enhanceCodeBlocks(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class ua{name="ui:toolbar";options;toolbarElement=null;cleanupFns=[];constructor(e={}){this.options={className:e.className||"mdx-editor-toolbar"}}install(e){const t=e.on("editorPostInit",s=>{this.buildToolbar(e,s)});t&&this.cleanupFns.push(t)}buildToolbar(e,t){const{editor:s,pluginManager:n}=t,i=s.container;if(!i){console.warn("ToolbarPlugin: Container not found.");return}let a=i.querySelector(`.${this.options.className}`);a||(a=document.createElement("div"),a.className=this.options.className,i.insertBefore(a,i.firstChild)),this.toolbarElement=a;const o=n.getToolbarButtons();a.innerHTML="";const r=o.filter(u=>!u.location||u.location==="main"),c=o.filter(u=>u.location==="mode-switcher"),d=document.createElement("div");d.className=`${this.options.className}__main`,d.addEventListener("click",u=>{const g=u.target.closest("button");if(!g)return;const p=g.getAttribute("data-command");if(p){const f=n.getCommand(p),v=s.getEditorView();f&&v&&f(v)}}),a.appendChild(d);const h=document.createDocumentFragment();for(const u of r){const g=this.createButton(u);h.appendChild(g)}if(d.appendChild(h),c.length>0){const u=document.createElement("div");u.className=`${this.options.className}__mode-switcher`,u.addEventListener("click",p=>{const f=p.target.closest("button");if(!f)return;const v=f.getAttribute("data-command");if(v){const b=n.getCommand(v),I=s.getEditorView();b&&I&&b(I)}}),a.appendChild(u);const g=document.createDocumentFragment();for(const p of c){const f=this.createButton(p);g.appendChild(f)}u.appendChild(g)}}createButton(e){if(e.type==="separator"){const s=document.createElement("div");return s.className=`${this.options.className}__separator`,s}const t=document.createElement("button");return t.className=`${this.options.className}__button`,t.title=e.title||e.id,t.setAttribute("data-command",e.command||e.id),typeof e.icon=="string"?t.innerHTML=e.icon:e.icon instanceof HTMLElement&&t.appendChild(e.icon.cloneNode(!0)),t}destroy(){this.toolbarElement&&this.toolbarElement.remove(),this.toolbarElement=null,this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}const ga={bold:"<strong>B</strong>",italic:"<em>I</em>",strikethrough:"<s>S</s>",inlineCode:"<code>`</code>",highlight:"<mark>H</mark>",heading:"<span>H#</span>",unorderedList:"<span></span>",orderedList:"<span>1.</span>",taskList:"<span></span>",blockquote:"<span></span>",codeBlock:"<span>{ }</span>",link:"<span></span>",image:"<span></span>",table:"<span></span>",horizontalRule:"<span></span>"},At={bold:{name:"applyBold",fn:ls},italic:{name:"applyItalic",fn:cs},strikethrough:{name:"applyStrikethrough",fn:ds},inlineCode:{name:"applyInlineCode",fn:hs},highlight:{name:"applyHighlight",fn:us},heading:{name:"toggleHeading",fn:bs},unorderedList:{name:"toggleUnorderedList",fn:ms},orderedList:{name:"toggleOrderedList",fn:fs},taskList:{name:"toggleTaskList",fn:ys},blockquote:{name:"toggleBlockquote",fn:vs},codeBlock:{name:"applyCodeBlock",fn:Es},link:{name:"applyLink",fn:_s},image:{name:"insertImage",fn:xs},table:{name:"insertTable",fn:Ss},horizontalRule:{name:"insertHorizontalRule",fn:ws}},pa={bold:"",italic:"",strikethrough:"",inlineCode:"",highlight:"",heading:"",unorderedList:"",orderedList:"",taskList:"",blockquote:"",codeBlock:"",link:"",image:"",table:"",horizontalRule:""},ma=["heading","bold","italic","strikethrough","highlight","inlineCode","separator","unorderedList","orderedList","taskList","separator","blockquote","codeBlock","horizontalRule","separator","link","image","table"];class fa{name="ui:formatting";options;constructor(e={}){this.options={enabledFormats:e.enabledFormats||"all",customIcons:e.customIcons||{}}}install(e){if(!e.registerCommand||!e.registerToolbarButton){console.warn("FormattingPlugin requires editor context with command registration support");return}const{registerCommand:t,registerToolbarButton:s}=e,n=this.getEnabledFormats();for(let i=0;i<n.length;i++){const a=n[i];if(a==="separator"){s({id:`sep-${i}`,type:"separator"});continue}const o=At[a];o&&t(o.name,c=>o.fn(c));const r=this.getButtonConfig(a);r&&s(r)}}getEnabledFormats(){return this.options.enabledFormats==="all"?[...ma]:this.options.enabledFormats||[]}getButtonConfig(e){const t=this.options.customIcons?.[e]||ga[e],s=At[e],n=pa[e];return!t||!s?null:{id:`format-${e}`,title:n,icon:t,command:s.name,location:"main"}}destroy(){}}class ya{name="core:titlebar";options;cleanupFns=[];toggleModeBtn=null;titleEl=null;constructor(e={}){this.options=e}install(e){const t=e.listen("setTitle",({title:a})=>{this.titleEl&&(this.titleEl.textContent=a)});t&&this.cleanupFns.push(t);const s=e.on("editorPostInit",a=>{this.registerButtons(e,a)});s&&this.cleanupFns.push(s);const n=e.on("editorPostInit",a=>{this.renderTitleBar(e,a)});n&&this.cleanupFns.push(n);const i=e.on("modeChanged",({mode:a})=>{this.updateModeButton(a)});i&&this.cleanupFns.push(i)}registerButtons(e,t){const{editor:s}=t;this.options.onSidebarToggle&&e.registerTitleBarButton?.({id:"toggle-sidebar",title:"",icon:'<i class="fas fa-bars"></i>',location:"left",onClick:()=>this.options.onSidebarToggle?.(s)}),this.options.enableToggleEditMode&&(e.registerCommand?.("toggleEditMode",i=>{const o=i.getMode()==="edit"?"render":"edit";i.switchToMode(o)}),e.registerTitleBarButton?.({id:"toggle-edit-mode",title:"",icon:'<i class="fas fa-book-open"></i>',command:"toggleEditMode",location:"left"})),this.options.aiCallback&&(e.registerCommand?.("triggerAI",async i=>{await this.options.aiCallback?.(i)}),e.registerTitleBarButton?.({id:"ai-action",title:"AI ",icon:'<i class="fas fa-magic"></i>',command:"triggerAI",location:"right"})),this.options.saveCallback&&(e.registerCommand?.("triggerSave",async i=>{await this.options.saveCallback?.(i)}),e.registerTitleBarButton?.({id:"save-action",title:"",icon:'<i class="fas fa-save"></i>',command:"triggerSave",location:"right"}));const n=this.options.printCallback||this.defaultPrintHandler;e.registerCommand?.("handlePrintAction",n),e.registerTitleBarButton?.({id:"print-action",title:"",icon:'<i class="fas fa-print"></i>',command:"handlePrintAction",location:"right"})}renderTitleBar(e,t){const{editor:s,pluginManager:n}=t,i=s.container;if(!i)return;let a=i.querySelector(".mdx-editor-titlebar");a||(a=document.createElement("div"),a.className="mdx-editor-titlebar",i.insertBefore(a,i.firstChild));const o=document.createElement("div");o.className="mdx-editor-titlebar__left";const r=document.createElement("div");r.className="mdx-editor-titlebar__center",this.titleEl=document.createElement("span"),this.titleEl.className="mdx-editor-titlebar__title",this.titleEl.textContent=s.config.title||"",r.appendChild(this.titleEl);const c=document.createElement("div");c.className="mdx-editor-titlebar__right";const d=document.createDocumentFragment(),h=document.createDocumentFragment(),u=n.getTitleBarButtons();u.forEach(g=>{const p=document.createElement("button");p.className="mdx-editor-titlebar__button",p.title=g.title||g.id,p.setAttribute("data-button-id",g.id),typeof g.icon=="string"?p.innerHTML=g.icon:g.icon instanceof HTMLElement&&p.appendChild(g.icon.cloneNode(!0)),p.onclick=()=>{if(g.onClick)g.onClick({editor:s,context:e,pluginManager:n});else if(g.command){const f=n.getCommand(g.command);f&&f(s)}},g.location==="right"?h.appendChild(p):d.appendChild(p),g.id==="toggle-edit-mode"&&(this.toggleModeBtn=p)}),o.appendChild(d),c.appendChild(h),a.innerHTML="",a.appendChild(o),a.appendChild(r),a.appendChild(c),u.length===0&&!this.titleEl.textContent?a.style.display="none":a.style.display=""}updateModeButton(e){this.toggleModeBtn&&(e==="edit"?(this.toggleModeBtn.title="",this.toggleModeBtn.innerHTML='<i class="fas fa-book-open"></i>'):(this.toggleModeBtn.title="",this.toggleModeBtn.innerHTML='<i class="fas fa-edit"></i>'))}defaultPrintHandler(e){e.print({title:e.config.title||"Document",showHeader:!0,headerMeta:{date:new Date().toLocaleDateString()}}).catch(t=>{console.error("[TitleBarPlugin] Print failed:",t)})}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.toggleModeBtn=null,this.titleEl=null}}class Ts{constructor(e,t,s={}){this.engine=e,this.editor=t,this.options=s}objectUrls=[];overlay=null;listContainer;statsEl;cleanBtn;currentAssetDirId="";async show(e){this.currentAssetDirId=e,this.createModalStructure(),this.overlay&&document.body.appendChild(this.overlay);try{await this.refreshAssetList()}catch(t){console.error("[AssetManager] Load failed:",t),m.error(""),this.close()}}close(){this.overlay?.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.objectUrls.forEach(e=>URL.revokeObjectURL(e)),this.objectUrls=[]}async refreshAssetList(){if(!this.listContainer)return;this.listContainer.innerHTML='<div class="mdx-empty-state">...</div>';let e=[];try{e=await this.engine.getChildren(this.currentAssetDirId)}catch(o){console.error("[AssetManager] Failed to get children:",o),this.listContainer.innerHTML='<div class="mdx-empty-state"></div>';return}const t=e.filter(o=>o.type!=="file"?!1:aa(o.name,this.options.viewFilter));if(t.length===0){this.listContainer.innerHTML='<div class="mdx-empty-state"></div>',this.updateToolbar(0,0,()=>{});return}const s=this.editor.getText(),n=this.extractReferencedFilenames(s),i=t.map(o=>({node:o,isUsed:n.has(o.name)}));await this.loadPreviews(i),this.renderList(i);const a=i.filter(o=>!o.isUsed).length;this.updateToolbar(i.length,a,()=>{this.handleBatchDelete(i.filter(o=>!o.isUsed))})}extractReferencedFilenames(e){const t=new Set,s=/@asset\/([^\s)"']+)/g;let n;for(;(n=s.exec(e))!==null;){const o=Re(n[1]);o&&t.add(o)}const i=/\]\(\s*([^)\s]+)\s*(?:"[^"]*")?\s*\)/g;for(;(n=i.exec(e))!==null;){const o=n[1];if(this.shouldSkipPath(o))continue;const r=Re(o);r&&!r.startsWith("#")&&t.add(r)}const a=/(?:src|href)=["']([^"']+)["']/g;for(;(n=a.exec(e))!==null;){const o=n[1];if(this.shouldSkipPath(o))continue;const r=Re(o);r&&t.add(r)}return t}shouldSkipPath(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("javascript:")||e.startsWith("#")}async loadPreviews(e){const t=e.map(async s=>{if(this.isPreviewableImage(s.node.name))try{const n=await this.engine.readContent(s.node.id);if(!n)return;const i=Ie(s.node.name),a=new Blob([n],{type:i}),o=URL.createObjectURL(a);this.objectUrls.push(o),s.url=o}catch{console.warn("[AssetManager] Preview load failed:",s.node.name)}});await Promise.all(t)}updateToolbar(e,t,s){!this.statsEl||!this.cleanBtn||(this.statsEl.textContent=` ${e} ${t} `,t>0?(this.cleanBtn.style.display="inline-block",this.cleanBtn.textContent=` ${t} `,this.cleanBtn.onclick=s):this.cleanBtn.style.display="none")}renderList(e){if(!this.listContainer)return;this.listContainer.innerHTML="",e.sort((s,n)=>s.isUsed!==n.isUsed?s.isUsed?1:-1:n.node.createdAt-s.node.createdAt);const t=document.createDocumentFragment();e.forEach(s=>{const n=this.createAssetItem(s);t.appendChild(n)}),this.listContainer.appendChild(t)}createAssetItem(e){const t=document.createElement("li");t.className="mdx-asset-item";const s=document.createElement("img");s.className="mdx-asset-thumb",s.src=e.url||this.getFileIcon(e.node.name),s.alt=e.node.name;const n=document.createElement("div");n.className="mdx-asset-info";const i=new Date(e.node.createdAt).toLocaleDateString(),a=this.formatFileSize(e.node.size||0);n.innerHTML=`
            <div class="mdx-asset-name" title="${e.node.name}">${e.node.name}</div>
            <div class="mdx-asset-meta">
                <span class="mdx-asset-badge ${e.isUsed?"used":"unused"}">
                    ${e.isUsed?"":""}
                </span>
                <span>${a}</span>
                <span>${i}</span>
            </div>
        `;const o=this.createActionButtons(e);return t.append(s,n,o),t}createActionButtons(e){const t=document.createElement("div");t.className="mdx-asset-actions";const s=this.createButton("","primary",()=>{const a=Is(e.node.name),o=this.isPreviewableImage(e.node.name)?`![${e.node.name}](${a})`:`[${e.node.name}](${a})`;this.insertText(o),this.close()}),n=this.createButton("","default",()=>{this.handleDownload(e.node)}),i=this.createButton("","danger",async()=>{if(!(e.isUsed&&!confirm(` "${e.node.name}" 

`)))try{await this.engine.delete([e.node.id]),m.success(""),await this.refreshAssetList()}catch(a){console.error("[AssetManager] Delete failed:",a),m.error("")}});return t.append(s,n,i),t}createButton(e,t,s){const n=document.createElement("button");return n.className=`mdx-btn mdx-btn--${t}`,n.textContent=e,n.onclick=s,n}async handleDownload(e){try{const t=await this.engine.readContent(e.id);if(!t){m.error("");return}const s=Ie(e.name),n=new Blob([t],{type:s}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=e.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),m.success("")}catch(t){console.error("[AssetManager] Download failed:",t),m.error("")}}async handleBatchDelete(e){if(!(e.length===0||!confirm(` ${e.length} `)))try{await this.engine.delete(e.map(s=>s.node.id)),m.success(` ${e.length} `),await this.refreshAssetList()}catch(s){console.error("[AssetManager] Batch delete failed:",s),m.error("")}}insertText(e){const t=this.editor.getEditorView();if(!t)return;const s=t.state.selection.main;t.dispatch({changes:{from:s.from,to:s.to,insert:e}}),this.editor.focus(),m.success("")}createModalStructure(){const e=document.createElement("div");e.className="mdx-asset-modal-overlay";const t=document.createElement("div");t.className="mdx-asset-modal",t.innerHTML=`
            <div class="mdx-asset-header">
                <h3></h3>
                <button class="mdx-asset-close" aria-label="">&times;</button>
            </div>
            <div class="mdx-asset-toolbar">
                <span class="mdx-stats"></span>
                <button class="mdx-btn mdx-btn--danger mdx-clean-btn" style="display:none"></button>
            </div>
            <ul class="mdx-asset-list"></ul>
        `,e.appendChild(t),this.overlay=e,this.listContainer=t.querySelector(".mdx-asset-list"),this.statsEl=t.querySelector(".mdx-stats"),this.cleanBtn=t.querySelector(".mdx-clean-btn"),t.querySelector(".mdx-asset-close").addEventListener("click",()=>this.close()),e.addEventListener("click",i=>{i.target===e&&this.close()});const n=i=>{i.key==="Escape"&&(this.close(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n)}isPreviewableImage(e){return/\.(png|jpg|jpeg|gif|webp|svg|bmp|ico)$/i.test(e)}getFileIcon(e){const t=e.split(".").pop()?.toLowerCase()||"";return{pdf:this.createSvgIcon("","#e74c3c"),doc:this.createSvgIcon("","#2980b9"),docx:this.createSvgIcon("","#2980b9"),xls:this.createSvgIcon("","#27ae60"),xlsx:this.createSvgIcon("","#27ae60"),ppt:this.createSvgIcon("","#e67e22"),pptx:this.createSvgIcon("","#e67e22"),zip:this.createSvgIcon("","#9b59b6"),rar:this.createSvgIcon("","#9b59b6"),mp4:this.createSvgIcon("","#1abc9c"),webm:this.createSvgIcon("","#1abc9c"),mp3:this.createSvgIcon("","#e91e63"),wav:this.createSvgIcon("","#e91e63")}[t]||this.createSvgIcon("","#95a5a6")}createSvgIcon(e,t){const s=`
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                <rect width="48" height="48" fill="#f5f5f5" rx="4"/>
                <text x="24" y="32" font-size="24" text-anchor="middle">${e}</text>
            </svg>
        `;return`data:image/svg+xml;base64,${btoa(s)}`}formatFileSize(e){if(e===0)return"0 B";const t=["B","KB","MB","GB"],s=1024,n=Math.floor(Math.log(e)/Math.log(s));return`${(e/Math.pow(s,n)).toFixed(n>0?1:0)} ${t[n]}`}}class va{name="ui:asset-manager";options;currentUI=null;constructor(e={}){this.options=e}install(e){e.registerTitleBarButton?.({id:"asset-manager",title:"",icon:`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
            </svg>`,location:"right",onClick:async({editor:t})=>{await this.openAssetManager(e,t)}}),e.registerCommand?.("openAssetManager",async()=>{const s=e.pluginManager.editorInstance;s&&await this.openAssetManager(e,s)})}async openAssetManager(e,t){const s=e.getSessionEngine?.(),n=e.getOwnerNodeId?.();if(!s){m.error("");return}if(!n){m.info("");return}const i=await s.getAssetDirectoryId(n);if(!i){m.info("");return}this.currentUI&&this.currentUI.close(),this.currentUI=new Ts(s,t,this.options),await this.currentUI.show(i)}destroy(){this.currentUI?.close(),this.currentUI=null}}const ba=new Set(["P","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE","PRE","DIV"]);class wa{name="interaction:source-sync";cleanupFns=[];isMac=typeof navigator<"u"&&navigator.platform.toUpperCase().indexOf("MAC")>=0;install(e){const t=e.on("domUpdated",({element:s})=>{this.attachDoubleClickHandler(s,e)});t&&this.cleanupFns.push(t)}attachDoubleClickHandler(e,t){if(e.dataset.sourceSyncBound)return;e.dataset.sourceSyncBound="true";const s=n=>{if(!(this.isMac?n.metaKey:n.ctrlKey))return;const a=n.target,o=this.extractText(a);o&&t.findAndSelectText&&t.switchToMode&&(t.findAndSelectText(o),t.switchToMode("edit"))};e.addEventListener("dblclick",s),this.cleanupFns.push(()=>{e.removeEventListener("dblclick",s),delete e.dataset.sourceSyncBound})}extractText(e){const t=e.closest(".cloze");if(t){const a=t.getAttribute("data-cloze-content");if(a)return a}const n=window.getSelection()?.toString().trim();if(n)return n;const i=this.findBlockParent(e);return i&&i.textContent?.trim()||null}findBlockParent(e){let t=e;for(;t&&t!==document.body;){if(ba.has(t.tagName))return t;t=t.parentElement}return null}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class Ms{name="autocomplete:core";options;constructor(e){this.options=e}install(e){const t=e.pluginManager;if(!t){console.warn("AutocompletePlugin: PluginManager not available");return}t._autocompleteSources||(t._autocompleteSources=[]);const s=t._autocompleteSources;for(const n of this.options.sources)s.push(n)}}class Sa{getTags;cache=null;constructor(e){this.getTags=e.getTags}async getSuggestions(e){if(this.cache&&this.cache.query===e)return this.cache.results;const t=await this.getTags(),s=e.toLowerCase(),n=t.filter(i=>i.toLowerCase().includes(s)).map(i=>({label:i,type:"keyword",detail:"tag"}));return this.cache={query:e,results:n},n}clearCache(){this.cache=null}}class Ea{name="autocomplete:tag";autocompletePlugin;constructor(e){const t=e.triggerChar||"#",s=new Sa({getTags:e.getTags});this.autocompletePlugin=new Ms({sources:[{triggerChar:t,provider:s,applyTemplate:n=>`${t}${n.label} `}]})}install(e){this.autocompletePlugin.install(e)}}class _a{name="autocomplete:mention";options;autocompletePlugin;hoverCard=null;cleanupFns=[];providerMap=new Map;hoverDebounceTimer=null;constructor(e){this.options={providers:e.providers||[],enableHoverPreview:e.enableHoverPreview!==!1,enableClickHandler:e.enableClickHandler!==!1,enableTransclusion:e.enableTransclusion!==!1,onMentionClick:e.onMentionClick||(()=>{})};for(const n of this.options.providers)this.providerMap.set(n.key,n);const t=new Map;this.options.providers&&this.options.providers.length>0&&this.options.providers.forEach(n=>{t.has(n.triggerChar)||t.set(n.triggerChar,[]),t.get(n.triggerChar).push(n)});const s=Array.from(t.entries()).map(([n,i])=>({triggerChar:n,provider:{getSuggestions:async a=>{const o=i.map(async c=>{try{return(await c.getSuggestions(a)).map(h=>({...h,_providerKey:c.key,detail:h.type?this.formatType(h.type):this.formatType(c.key),section:this.getSectionName(h.type||c.key)}))}catch(d){return console.warn(`[MentionPlugin] Provider ${c.key} failed:`,d),[]}});return(await Promise.all(o)).flat()},getHoverPreview:async a=>{const o=a,r=o._providerKey,c=this.providerMap.get(r);if(c?.getHoverPreview){const d=`mdx://${r}/${o.id}`;return c.getHoverPreview(d)}return null}},applyTemplate:a=>{const o=a,r=o._providerKey||i[0].key;return`[${o.title||o.label}](mdx://${r}/${o.id}) `}}));this.autocompletePlugin=new Ms({sources:s})}formatType(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}getSectionName(e){const t=e.toLowerCase();return t.includes("dir")||t.includes("folder")?"Folders":t.includes("file")||t.includes("doc")?"Files":t.includes("user")||t.includes("contact")?"People":"Others"}createMarkedExtension(){return{extensions:[{name:"mdxLink",level:"inline",start:e=>e.indexOf("]("),tokenizer:e=>{const t=e.match(/^\[([^\]]+)\]\(mdx:\/\/([^/]+)\/([^)]+)\)/);if(t)return{type:"mdxLink",raw:t[0],text:t[1],provider:t[2],id:t[3]}},renderer:e=>{const t=`mdx://${e.provider}/${e.id}`;return`<a href="${t}" class="mdx-mention" data-mdx-uri="${t}" data-provider="${e.provider}" data-id="${e.id}">${e.text}</a>`}},this.options.enableTransclusion?{name:"mdxTransclusion",level:"block",start:e=>e.match(/!@/)?.index,tokenizer(e){const s=/^!@(\w+):(\S+)(?:\n|$)/.exec(e);if(s){const[n,i,a]=s;return{type:"mdxTransclusion",raw:n,providerKey:i,id:a}}},renderer(e){return`<div class="mdx-transclusion" data-provider-key="${e.providerKey}" data-id="${e.id}">Loading...</div>`}}:void 0].filter(Boolean)}}getOrCreateHoverCard(){if(!this.hoverCard){const e=document.createElement("div");e.className="mdx-mention-hover-card",e.style.cssText=`
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 320px;
        display: none;
        overflow: hidden;
        font-family: sans-serif;
      `,document.body.appendChild(e),this.hoverCard=e}return this.hoverCard}showHoverPreview(e,t,s){if(!this.options.enableHoverPreview||!t.getHoverPreview)return;const n=t.getHoverPreview.bind(t);this.hoverDebounceTimer&&clearTimeout(this.hoverDebounceTimer),this.hoverDebounceTimer=window.setTimeout(async()=>{try{const i=`mdx://${t.key}/${s}`,a=await n(i);if(!a)return;const o=this.getOrCreateHoverCard();o.innerHTML=`
          <div class="mdx-mention-hover-card__header" style="padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #eee; font-weight: 600;">
            ${a.icon||""} ${a.title}
          </div>
          <div class="mdx-mention-hover-card__content" style="padding: 12px;">
            ${a.contentHTML}
          </div>
        `;const r=e.getBoundingClientRect();let c=r.bottom+5;const d=o.offsetHeight||200;c+d>window.innerHeight&&(c=r.top-d-5);let h=r.left;const u=o.offsetWidth||320;h+u>window.innerWidth&&(h=window.innerWidth-u-10),h<10&&(h=10),o.style.left=`${h}px`,o.style.top=`${c}px`,o.style.display="block"}catch(i){console.error("[MentionPlugin] Failed to load hover preview:",i)}},150)}hideHoverPreview(){this.hoverDebounceTimer&&(clearTimeout(this.hoverDebounceTimer),this.hoverDebounceTimer=null),this.hoverCard&&(this.hoverCard.style.display="none")}async processTransclusions(e){if(!this.options.enableTransclusion)return;const t=e.querySelectorAll(".mdx-transclusion:not([data-transclusion-processed])");if(t.length===0)return;const s=3,n=Array.from(t),i=async a=>{a.setAttribute("data-transclusion-processed","true");const o=a.dataset.providerKey,r=a.dataset.id;if(!o||!r)return;const c=this.providerMap.get(o);if(c?.getFullContent)try{const d=await c.getFullContent(r);a.innerHTML=d,a.classList.add("mdx-transclusion--loaded"),this.bindMentionInteractions(a),await this.processTransclusions(a)}catch(d){console.error(`[MentionPlugin] Transclusion failed for ${o}:${r}:`,d),a.textContent="Failed to load content",a.classList.add("mdx-transclusion--error")}};for(let a=0;a<n.length;a+=s){const o=n.slice(a,a+s);await Promise.all(o.map(i))}}bindMentionInteractions(e){if(this.options.enableClickHandler&&!e.dataset.mentionClickBound){e.dataset.mentionClickBound="true";const t=s=>{const n=s.target.closest(".mdx-mention");if(!n)return;s.preventDefault();const i=n.dataset.provider,a=n.dataset.id;i&&a&&this.options.onMentionClick(i,a)};e.addEventListener("click",t),this.cleanupFns.push(()=>{e.removeEventListener("click",t)})}if(this.options.enableHoverPreview&&!e.dataset.mentionHoverBound){e.dataset.mentionHoverBound="true";const t=n=>{const i=n.target.closest(".mdx-mention");if(!i)return;const a=i.dataset.provider,o=i.dataset.id;if(a&&o){const r=this.providerMap.get(a);r&&this.showHoverPreview(i,r,o)}},s=n=>{n.target.closest(".mdx-mention")&&this.hideHoverPreview()};e.addEventListener("mouseenter",t,!0),e.addEventListener("mouseleave",s,!0),this.cleanupFns.push(()=>{e.removeEventListener("mouseenter",t,!0),e.removeEventListener("mouseleave",s,!0)})}}install(e){this.autocompletePlugin.install(e),e.registerSyntaxExtension(this.createMarkedExtension());const t=e.on("domUpdated",async({element:s})=>{this.bindMentionInteractions(s),await this.processTransclusions(s)});t&&this.cleanupFns.push(t)}destroy(){this.hoverDebounceTimer&&(clearTimeout(this.hoverDebounceTimer),this.hoverDebounceTimer=null),this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.hoverCard&&(this.hoverCard.remove(),this.hoverCard=null),this.providerMap.clear()}}class xa{name="feature:svg";options;cleanupFns=[];constructor(e={}){this.options={sanitize:e.sanitize??!0,containerClass:e.containerClass??"mdx-svg-container"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processSvgCodeBlocks(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processSvgCodeBlocks(e){e.querySelectorAll("pre code.language-svg").forEach(s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"",a=this.options.sanitize?this.sanitizeSvg(i):i,o=document.createElement("div");o.className=this.options.containerClass,o.style.display="inline-block",o.style.maxWidth="100%",this.isValidSvg(a)?(o.innerHTML=a,n.replaceWith(o)):console.warn("[SvgPlugin] Invalid or unsafe SVG content detected.")})}sanitizeSvg(e){let t=e;return t=t.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim,""),t=t.replace(/\s(on\w+)="[^"]*"/gim,""),t=t.replace(/\s(on\w+)='[^']*'/gim,""),t=t.replace(/href=["']javascript:[^"']*["']/gim,'href="#"'),t}isValidSvg(e){const t=e.trim();return t.startsWith("<svg")&&t.endsWith("</svg>")}}class Ca{name="feature:vega";options;cleanupFns=[];isLoaded=!1;loadPromise=null;constructor(e={}){this.options={embedCdnUrl:e.embedCdnUrl||"https://cdn.jsdelivr.net/npm/vega-embed@6",vegaCdnUrl:e.vegaCdnUrl||"https://cdn.jsdelivr.net/npm/vega@5",vegaLiteCdnUrl:e.vegaLiteCdnUrl||"https://cdn.jsdelivr.net/npm/vega-lite@5",theme:e.theme||"quartz",actions:e.actions??!1}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processVegaBlocks(s)});this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}async loadDependencies(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=(async()=>{window.vega||await import(this.options.vegaCdnUrl),window.vegaLite||await import(this.options.vegaLiteCdnUrl),window.vegaEmbed||await import(this.options.embedCdnUrl),this.isLoaded=!0})(),this.loadPromise)}async processVegaBlocks(e){const t=e.querySelectorAll("pre code.language-vega, pre code.language-vega-lite");if(t.length!==0){try{await this.loadDependencies()}catch(s){console.error("[VegaPlugin] Failed to load dependencies",s);return}await Promise.all(Array.from(t).map(async s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"",a=s.classList.contains("language-vega-lite"),o=document.createElement("div");o.className="mdx-vega-container";try{const r=JSON.parse(i);n.replaceWith(o),window.vegaEmbed&&await window.vegaEmbed(o,r,{mode:a?"vega-lite":"vega",theme:this.options.theme,actions:this.options.actions,renderer:"svg"})}catch(r){console.warn("[VegaPlugin] Render error:",r),o.innerHTML=`
          <div class="mdx-vega-error">
            <strong>Vega JSON Error:</strong> ${r.message}
          </div>
        `,o.appendChild(n.cloneNode(!0)),n.replaceWith(o)}}))}}}class Ia{name="core:asset-resolver";priority=95;createdUrls=new Set;assetCache=null;CACHE_TTL=5e3;constructor(e={}){}install(e){e.on("domUpdated",async t=>{await this.resolveAssets(t.element,e)}),e.registerCommand?.("pruneAssets",async()=>await this.pruneUnusedAssets(e))}async resolveAssets(e,t){const s=t.getSessionEngine?.(),n=t.getOwnerNodeId?.();if(!s||!n)return;let i=null;try{i=await s.getAssetDirectoryId(n)}catch(c){console.debug("[AssetResolver] Failed to get asset dir ID:",c);return}if(!i)return;const a=await this.getAssetsMap(s,i);if(a.size===0)return;const o=e.querySelectorAll("[src], [href]"),r=[];for(const c of o){const d=c.hasAttribute("src")?"src":"href",h=c.getAttribute(d);if(!h||c.hasAttribute("data-original-src")||!h.startsWith("@asset/"))continue;const u=Re(h),g=a.get(u);g&&r.push(this.resolveElement(c,d,h,g,s))}await Promise.all(r)}async resolveElement(e,t,s,n,i){try{const a=await i.readContent(n.id);if(!a)return;const o=Ie(n.name),r=new Blob([a],{type:o}),c=URL.createObjectURL(r);this.createdUrls.add(c),e.setAttribute(t,c),e.setAttribute("data-original-src",s),e.setAttribute("data-asset-id",n.id),e.tagName==="IMG"&&e.removeAttribute("srcset")}catch{console.warn("[AssetResolver] Resolve error:",n.name)}}async getAssetsMap(e,t){const s=Date.now();if(this.assetCache&&this.assetCache.dirId===t&&s-this.assetCache.timestamp<this.CACHE_TTL)return this.assetCache.assets;try{const n=await e.getChildren(t),i=new Map;for(const a of n)a.type==="file"&&i.set(a.name,a);return this.assetCache={dirId:t,assets:i,timestamp:s},i}catch{return new Map}}async pruneUnusedAssets(e){const t=e.getSessionEngine?.(),s=e.getOwnerNodeId?.();if(!t||!s)return 0;const n=await t.getAssetDirectoryId(s);if(!n)return 0;const a=e.pluginManager.editorInstance;if(!a)return 0;const o=a.getText(),r=new Set,c=/@asset\/([^\s)"']+)/g;let d;for(;(d=c.exec(o))!==null;)r.add(d[1]);const h=await this.getAssetsMap(t,n),u=[];for(const[g,p]of h)r.has(g)||u.push(p.id);return u.length>0&&(await t.delete(u),this.assetCache=null),u.length}destroy(){this.createdUrls.forEach(e=>URL.revokeObjectURL(e)),this.createdUrls.clear(),this.assetCache=null}}class Ta{name="interaction:auto-save";options;timer=null;cleanupFns=[];constructor(e={}){this.options={delay:e.delay??2e3,saveOnBlur:e.saveOnBlur??!0}}install(e){const t=e.on("editorPostInit",({editor:s})=>{this.setupListeners(s,e)});t&&this.cleanupFns.push(t)}setupListeners(e,t){const s=e.on("interactiveChange",()=>{this.triggerDebouncedSave(e)});if(this.cleanupFns.push(s),this.options.saveOnBlur){const a=e.on("blur",()=>{this.triggerImmediateSave(e)});this.cleanupFns.push(a)}const n=()=>{document.visibilityState==="hidden"&&this.triggerImmediateSave(e)};document.addEventListener("visibilitychange",n),this.cleanupFns.push(()=>document.removeEventListener("visibilitychange",n));const i=()=>{e.isDirty()&&this.triggerImmediateSave(e)};window.addEventListener("beforeunload",i),this.cleanupFns.push(()=>window.removeEventListener("beforeunload",i)),t.registerCommand?.("save",()=>this.triggerImmediateSave(e))}triggerDebouncedSave(e){this.options.delay<=0||(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{e.save()},this.options.delay))}triggerImmediateSave(e){this.timer&&clearTimeout(this.timer),e.save()}destroy(){this.timer&&clearTimeout(this.timer),this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}const he=new Map;function L(l,e,t={}){he.has(l),he.set(l,{constructor:e,priority:t.priority??100,dependencies:t.dependencies??[]})}L("editor:core",rs,{priority:1});L("core:titlebar",ya,{priority:2});L("interaction:source-sync",wa,{priority:60});L("ui:toolbar",ua,{priority:2});L("ui:formatting",fa,{priority:3,dependencies:["ui:toolbar"]});L("callout",Ji,{priority:4});L("mathjax",Gi,{priority:5});L("folder",ji,{priority:6});L("media",Wi,{priority:7});L("mermaid",Ki,{priority:8});L("svg",xa,{priority:9});L("cloze:cloze",sa,{priority:10});L("cloze:cloze-controls",pt,{priority:20,dependencies:["cloze:cloze"]});L("cloze:memory",na,{priority:20,dependencies:["cloze:cloze"]});L("interaction:table",ca,{priority:50});L("task-list",da,{priority:51});L("codeblock-controls",ha,{priority:52});L("autocomplete:tag",Ea,{priority:53});L("autocomplete:mention",_a,{priority:54});L("interaction:clipboard",ia,{priority:55});L("interaction:upload",la,{priority:60});L("plantuml",Yi,{priority:70});L("vega",Ca,{priority:71});L("interaction:auto-save",Ta,{priority:90});L("ui:asset-manager",va,{priority:90,dependencies:["core:titlebar"]});L("core:asset-resolver",Ia,{priority:95});const Lt=["core:asset-resolver","interaction:auto-save","interaction:clipboard","interaction:upload","ui:toolbar","ui:formatting","interaction:source-sync","interaction:table","folder","mathjax","media","callout","mermaid","svg","codeblock-controls","task-list"],Ma="-all";function ye(l){return typeof l=="string"?l:Array.isArray(l)?l[0]:typeof l=="object"&&"name"in l&&!("install"in l)||typeof l=="object"&&"install"in l?l.name:""}function ka(l){const e=[],t=new Map,s=new Map,n=new Map;for(const r of l)t.set(r,0),s.set(r,[]),n.set(r,he.get(r)?.priority??100);for(const r of l){const c=he.get(r);if(c)for(const d of c.dependencies)l.includes(d)?(s.get(d).push(r),t.set(r,(t.get(r)||0)+1)):console.warn(`Plugin "${r}" has a dependency "${d}" which is not in the current loading list. This dependency will be ignored.`)}const i=(r,c)=>{const d=n.get(c);let h=0,u=r.length;for(;h<u;){const g=h+u>>>1;n.get(r[g])<=d?h=g+1:u=g}r.splice(h,0,c)},a=[];for(const r of l)t.get(r)===0&&i(a,r);const o=r=>he.get(r)?.priority??100;for(;a.length>0;){a.sort((c,d)=>o(c)-o(d));const r=a.shift();e.push(r);for(const c of s.get(r)||[]){const d=(t.get(c)||1)-1;t.set(c,d),d===0&&i(a,c)}}if(e.length!==l.length){const r=l.filter(c=>!e.includes(c));console.warn(`Circular or missing dependency for: ${r.join(", ")}`),r.sort((c,d)=>(n.get(c)||100)-(n.get(d)||100)),e.push(...r)}return e}async function mt(l,e={}){const t=e.plugins||[],s=e.defaultPluginOptions?.["core:titlebar"]||{},i=(t.some(v=>ye(v)==="core:titlebar")||Lt.includes("core:titlebar"))&&s.enableAssetManager!==!1,a=t.some(v=>ye(v)==="ui:asset-manager");i&&!a&&t.push("ui:asset-manager"),e.plugins=t;let o=e.onSave;if(!o&&e.hostContext&&e.nodeId&&(o=async v=>{await e.hostContext.saveContent(e.nodeId,v)}),e.onSave=o,e.defaultPluginOptions=e.defaultPluginOptions||{},e.hostContext){const v=e.defaultPluginOptions["core:titlebar"]||{};e.defaultPluginOptions["core:titlebar"]={...v,onSidebarToggle:v.onSidebarToggle||(b=>e.hostContext?.toggleSidebar()),saveCallback:async b=>{await b.save()}}}const r=new Vi(e),c=e.defaultPluginOptions?.["editor:core"]||{},d=new rs(c);r.use(d);let h=Lt;t.length>0&&ye(t[0])===Ma&&(h=[],t.shift());const u=new Set,g=new Map;for(const v of h){const b=ye(v);b&&!b.startsWith("-")&&g.set(b,v)}for(const v of t){const b=ye(v);if(!b){console.warn("Invalid plugin configuration:",v);continue}b.startsWith("-")?u.add(b.substring(1)):(g.set(b,v),b==="cloze:cloze"&&(g.has("cloze:cloze-controls")||g.set("cloze:cloze-controls","cloze:cloze-controls"),g.has("cloze:memory")||g.set("cloze:memory","cloze:memory")))}for(const v of u)g.delete(v);const p=Array.from(g.keys()),f=ka(p);for(const v of f){const b=g.get(v);try{let I=null;if(typeof b=="object"&&"install"in b)I=b;else{const U=he.get(v);if(!U){console.warn(`Plugin "${v}" not found in registry.`);continue}const q=U.constructor;let B={};if(typeof b=="string")B=e.defaultPluginOptions?.[v]||{};else if(Array.isArray(b)){const[,D]=b;B={...e.defaultPluginOptions?.[v]||{},...D}}else if(typeof b=="object"&&"name"in b){const{options:D={}}=b;B={...e.defaultPluginOptions?.[v]||{},...D}}I=new q(B)}I&&r.use(I)}catch(I){console.error(`Failed to instantiate plugin "${v}":`,b,I)}}return await r.init(l,e.initialContent||""),r}const Aa=async(l,e)=>{const t={...e,plugins:["core:titlebar","interaction:auto-save",...e.plugins||[]],initialMode:"render",defaultPluginOptions:{...e.defaultPluginOptions,"core:titlebar":{title:e.title||"Untitled",enableToggleEditMode:!0,...e.defaultPluginOptions?.["core:titlebar"]||{}}}};return await mt(l,t)};class Fe{providerRegistry=new Map;static MENTION_REGEX=/@(\w+):(\S+)|\[[^\]]+\]\(mdx:\/\/(\w+)\/([^)]+)\)/g;constructor(e=[]){e.forEach(t=>this.register(t))}register(e){if(!e||!e.key){const t=e?e.constructor.name:"undefined";throw new Error(`[MDxProcessor] Mention provider instance (${t}) is invalid or missing the required 'key' property.`)}this.providerRegistry.set(e.key,e)}async process(e,t){let s={},n=e;try{if(e.trimStart().startsWith("---")){const r=dn(e);s=r.attributes,n=r.body}}catch{n=e}const i={...s},a=this._findAllMentions(n);await this._resolveMentionData(a);const o=this._applyTransformations(n,a,t,i);return{originalContent:e,transformedContent:o,mentions:a.sort((r,c)=>r.index-c.index),metadata:i}}_findAllMentions(e){Fe.MENTION_REGEX.lastIndex=0;const t=[];for(const s of e.matchAll(Fe.MENTION_REGEX)){const n=!!s[1],i=n?s[1]:s[3],a=n?s[2]:s[4];t.push({raw:s[0],type:i,id:a,uri:`mdx://${i}/${a}`,index:s.index,data:null})}return t}async _resolveMentionData(e){const t=new Map;for(const n of e){const i=t.get(n.type)||[];i.push(n),t.set(n.type,i)}const s=[];for(const[n,i]of t){const a=this.providerRegistry.get(n);if(a?.getDataForProcess)for(const o of i)s.push((async()=>{try{o.data=await a.getDataForProcess(new URL(o.uri))}catch(r){console.error(`[MDxProcessor] Provider "${n}" failed for "${o.uri}":`,r),o.data=null}})())}await Promise.all(s)}_applyTransformations(e,t,s,n){if(t.length===0)return e.trim();const i=[...t].sort((r,c)=>c.index-r.index),a=[];let o=e.length;for(const r of i){const c=s.rules[r.type]||s.rules["*"];if(!c)continue;c.collectMetadata&&r.id&&(n[r.type]||(n[r.type]=[]),n[r.type].includes(r.id)||n[r.type].push(r.id));let d;switch(c.action){case"replace":d=c.getReplacementContent?c.getReplacementContent(r.data,r):r.raw;break;case"keep":d=r.raw;break;case"remove":d="";break;default:d=r.raw}const h=r.index+r.raw.length;h<o&&a.unshift(e.slice(h,o)),a.unshift(d),o=r.index}return o>0&&a.unshift(e.slice(0,o)),a.join("").trim()}}class La{constructor(e,t=["*"]){this.engine=e;const s=new Di({engine:this.engine});this.processor=new Fe([s])}processor;isProcessing=!1;debounceTimers=new Map;unsubscribe=null;start(){console.log(" [BackgroundBrain] Started."),this.unsubscribe=this.engine.on("node:updated",this.handleNodeUpdate)}stop(){this.unsubscribe?.(),this.debounceTimers.forEach(clearTimeout),this.debounceTimers.clear(),console.log(" [BackgroundBrain] Stopped.")}handleNodeUpdate=e=>{const t=e.payload;if(!t||!t.nodeId||t.data?.metadataOnly)return;const s=t.nodeId;this.debounceTimers.has(s)&&clearTimeout(this.debounceTimers.get(s)),this.debounceTimers.set(s,setTimeout(async()=>{this.debounceTimers.delete(s),await this.processNode(s)},2e3))};async processNode(e){if(!this.isProcessing)try{const t=await this.engine.getNode(e);if(!t||t.type!=="file")return;const s=t.metadata?._ai_last_scan,n=t.modifiedAt;if(typeof s=="number"&&s>=n)return;this.isProcessing=!0;const i=await this.engine.readContent(e);if(typeof i!="string")return;const a=await this.processor.process(i,{rules:{user:{action:"keep",collectMetadata:!0},tag:{action:"keep",collectMetadata:!0},file:{action:"keep",collectMetadata:!0},"*":{action:"keep"}}}),o={...t.metadata||{},...a.metadata,_ai_last_scan:Date.now(),_ai_processed:!0};await this.engine.updateMetadata(e,o),console.log(` [BackgroundBrain] Processed ${e}`)}catch(t){console.error("[BackgroundBrain] Error:",t)}finally{this.isProcessing=!1}}}class Na{constructor(e){this.container=e,this.container.innerHTML="",this.container.classList.add("mm-layout"),this.sidebarContainer=document.createElement("div"),this.sidebarContainer.className="mm-sidebar",this.editorContainer=document.createElement("div"),this.editorContainer.className="mm-editor-area",this.container.appendChild(this.sidebarContainer),this.container.appendChild(this.editorContainer)}sidebarContainer;editorContainer;toggleSidebar(e){e?this.sidebarContainer.classList.add("is-collapsed"):this.sidebarContainer.classList.remove("is-collapsed"),setTimeout(()=>{window.dispatchEvent(new Event("resize"))},310)}destroy(){this.container.innerHTML="",this.container.classList.remove("mm-layout")}}class Da{constructor(e){if(this.config=e,this.layout=new Na(e.container),e.customEngine)this.engine=e.customEngine;else if(e.vfs&&e.moduleName)this.engine=new ot(e.moduleName,e.vfs);else throw new Error("MemoryManager requires either 'customEngine' or both 'vfs' and 'moduleName' in config");this.baseEditorFactory=e.editorFactory||mt;const t=e.scopeId||e.moduleName||"default";this.vfsUI=Ri({...e.uiOptions,scopeId:t,sessionListContainer:this.layout.sidebarContainer,defaultFileName:e.defaultContentConfig?.fileName,defaultFileContent:e.defaultContentConfig?.content,defaultEditorFactory:this.enhancedEditorFactory,fileTypes:e.fileTypes,customEditorResolver:e.customEditorResolver},this.engine),e.aiConfig?.enabled&&(this.brain=new La(this.engine,e.aiConfig.activeRules),this.brain.start());const s={toggleSidebar:n=>{this.vfsUI.toggleSidebar()},saveContent:async(n,i)=>{await this.engine.writeContent(n,i)},navigate:async n=>{console.log(`[MemoryManager:${this.config.scopeId}] Handling navigation:`,n),this.config.onNavigate?await this.config.onNavigate(n):console.warn("[MemoryManager] onNavigate callback is missing in config.")}};this.lifecycleUnsubscribe=$i(this.vfsUI,this.engine,this.layout.editorContainer,this.enhancedEditorFactory,{hostContext:s,...e.editorConfig}),this.bindLayoutEvents(),this.bindInternalEvents()}vfsUI;engine;brain;layout;lifecycleUnsubscribe;baseEditorFactory;enhancedEditorFactory=async(e,t)=>{const{editorConfig:s}=this.config,n={...s,...t,plugins:[...s?.plugins||[],...t?.plugins||[]],defaultPluginOptions:{...s?.defaultPluginOptions||{},...t?.defaultPluginOptions||{}},sessionEngine:this.engine};return this.baseEditorFactory(e,n)};bindLayoutEvents(){const e=this.vfsUI.on("sidebarStateChanged",({isCollapsed:s})=>{this.layout.toggleSidebar(s)}),t=this.destroy.bind(this);this.destroy=()=>{e(),t()}}bindInternalEvents(){this.vfsUI.on("sessionSelected",e=>{const t=e.item?.id??null;this.config.onSessionChange&&this.config.onSessionChange(t)})}async start(){await this.engine.init(),await this.vfsUI.start(),this.config.moduleName}async openFile(e){await this.vfsUI.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:e}})}getActiveSessionId(){return this.vfsUI.getActiveSession()?.id??null}destroy(){this.lifecycleUnsubscribe(),this.vfsUI.destroy(),this.brain?.stop(),this.layout.destroy()}}const Me=[{elementId:"settings-workspace",moduleName:"settings_root",syncEnabled:!1,type:"settings",title:"Settings",supportedFileTypes:[],readOnly:!0,aiEnabled:!1,initialSidebarCollapsed:!1},{elementId:"agent-workspace",moduleName:dt,syncEnabled:!0,type:"agent",title:"Agents",supportedFileTypes:["agent"],plugins:["core:titlebar"],mentionScope:["agents","prompts","projects"],aiEnabled:!1},{elementId:"anki-workspace",moduleName:"anki",syncEnabled:!0,type:"standard",title:"Anki Memory Cards",supportedFileTypes:["anki","markdown"],plugins:["cloze:cloze","cloze:cloze-controls","autocomplete:mention","autocomplete:tag"],mentionScope:["*"],aiEnabled:!0},{elementId:"prompt-workspace",moduleName:"prompts",syncEnabled:!0,type:"standard",title:"Prompt Library",supportedFileTypes:["prompt"],aiEnabled:!0},{elementId:"project-workspace",moduleName:"projects",syncEnabled:!0,type:"standard",title:"Projects",supportedFileTypes:["project"],aiEnabled:!0},{elementId:"email-workspace",moduleName:"emails",syncEnabled:!0,type:"standard",title:"Email Drafts",supportedFileTypes:["email"],aiEnabled:!0},{elementId:"private-workspace",moduleName:"private",syncEnabled:!1,isProtected:!0,type:"standard",title:"Private Notes",supportedFileTypes:["private"],mentionScope:[],aiEnabled:!0},{elementId:"llm-workspace",moduleName:es,syncEnabled:!0,type:"chat",title:"AI Sessions",supportedFileTypes:["chat"],mentionScope:["*"],plugins:[],aiEnabled:!1}];let Ne=null;function $a(){return Me.filter(l=>l.syncEnabled).map(l=>l.moduleName)}async function Ra(){if(Ne)return Ne;console.log("Initializing VFS..."),Z.registerAdapter("indexeddb",(t,s)=>new Wt(t.dbName??"vfs_database",t.version??1,s));const l=$a();console.log("Syncable modules:",l);const e=await Qn({dbName:"MindOS",dbVersion:7,defaultModule:Me[0]?.moduleName||"default",enableTags:!0,enableAssets:!0,syncableModules:l});for(const t of Me)if(!e.getModule(t.moduleName))try{await e.mount(t.moduleName,{description:t.title,isProtected:t.isProtected,syncEnabled:t.syncEnabled}),console.log(`Mounted module: ${t.moduleName} (Protected: ${!!t.isProtected})`)}catch(n){console.error(`Failed to mount ${t.moduleName}`,n)}return Ne=e,Ne}const K="__config",Nt=["__config","__vfs_meta__","settings_ui",dt],Dt="snapshot_",ne={tags:"/tags.json",contacts:"/contacts.json",sync:"/sync_config.json"};class Pa{vfs;dbName;state={tags:[],contacts:[]};syncConfig={serverUrl:"",username:"",strategy:"manual",autoSync:!1};syncStatus={state:"idle",lastSyncTime:null};listeners=new Set;initialized=!1;syncTimer=null;eventUnsubscribers=[];constructor(e,t="MindOS"){this.vfs=e,this.dbName=t}async init(){if(!this.initialized){if(!this.vfs.getModule(K))try{await this.vfs.mount(K,{description:"Settings Persistence"})}catch(e){if(!this.isAlreadyExistsError(e))throw e}await Promise.all([this.loadEntity("contacts"),this.syncTags(),this.loadSyncConfig()]),this.bindVFSEvents(),this.initialized=!0,this.notify()}}isAlreadyExistsError(e){return e instanceof x?e.code===T.ALREADY_EXISTS:e.code===T.ALREADY_EXISTS||e.message?.includes("exists")}isNotFoundError(e){return e instanceof x?e.code===T.NOT_FOUND:e.code===T.NOT_FOUND||e.message?.toLowerCase().includes("not found")}bindVFSEvents(){const e=[R.NODE_CREATED,R.NODE_UPDATED,R.NODE_DELETED],t=s=>{s.path&&s.path.startsWith(`/${K}`)||(this.syncTimer&&clearTimeout(this.syncTimer),this.syncTimer=setTimeout(()=>{this.syncTags().then(()=>this.notify()),this.syncConfig.autoSync&&this.syncStatus.state!=="syncing"&&this.syncConfig.serverUrl&&(console.log("[AutoSync] Triggered"),this.triggerSync().catch(n=>console.error("AutoSync failed",n)))},2e3))};e.forEach(s=>{const n=this.vfs.on(s,t);this.eventUnsubscribers.push(n)})}async loadEntity(e){const t=ne[e];try{const s=await this.vfs.read(K,t),n=typeof s=="string"?s:new TextDecoder().decode(s);this.state[e]=JSON.parse(n)}catch(s){this.isNotFoundError(s)?this.state[e]=[]:console.error(`Failed to load ${e}`,s)}}async saveEntity(e){const t=ne[e],s=JSON.stringify(this.state[e],null,2);try{await this.vfs.write(K,t,s)}catch(n){if(this.isNotFoundError(n))await this.vfs.createFile(K,t,s);else throw n}e!=="tags"&&this.notify()}getContacts(){return[...this.state.contacts]}async saveContact(e){this.updateOrAdd(this.state.contacts,e),await this.saveEntity("contacts")}async deleteContact(e){this.state.contacts=this.state.contacts.filter(t=>t.id!==e),await this.saveEntity("contacts"),this.notify()}getTags(){return[...this.state.tags]}async syncTags(){try{let e=[];try{const a=await this.vfs.read(K,ne.tags),o=typeof a=="string"?a:new TextDecoder().decode(a);e=JSON.parse(o)}catch{}const s=(await this.vfs.getAllTags()).map(a=>{const o=e.find(r=>r.name===a.name);return{id:a.name,name:a.name,color:a.color||o?.color||"#3b82f6",description:o?.description||"",count:a.refCount||0}}),n=JSON.stringify(this.state.tags);this.state.tags=s;const i=JSON.stringify(this.state.tags);this.saveEntity("tags").catch(a=>console.error("Failed to save merged tags",a)),n!==i&&this.initialized&&this.notify()}catch(e){console.error("[SettingsService] Failed to sync tags:",e)}}async saveTag(e){await this.vfs.updateTagDefinition(e.name,{color:e.color}),this.updateOrAdd(this.state.tags,e),await this.saveEntity("tags")}async deleteTag(e){const t=this.state.tags.find(s=>s.id===e);if(t){try{const s=await this.vfs.findByTag(t.name);for(const n of s)await this.vfs.removeTag(n,t.name)}catch(s){console.warn("Failed to cleanup tag from nodes",s)}this.state.tags=this.state.tags.filter(s=>s.id!==e),await this.saveEntity("tags"),this.notify()}}async getSyncConfig(){return{...this.syncConfig}}async getSyncStatus(){return{...this.syncStatus}}async loadSyncConfig(){try{const e=await this.vfs.read(K,ne.sync),t=typeof e=="string"?e:new TextDecoder().decode(e),s=JSON.parse(t);this.syncConfig={...this.syncConfig,...s}}catch{}}async saveSyncConfig(e){this.syncConfig=e;const t=JSON.stringify(e,null,2);try{await this.vfs.write(K,ne.sync,t)}catch(s){this.isNotFoundError(s)&&await this.vfs.createFile(K,ne.sync,t)}}async testConnection(e,t,s){try{return(await fetch(`${e}/api/sync/check`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify([])})).ok}catch(n){return console.error(n),!1}}async triggerSync(e="standard"){if(!this.syncConfig.serverUrl)throw new Error("No server URL");const t=this.syncConfig.token;if(!t)throw new Error("No Access Token configured");try{this.syncStatus={state:"syncing",lastSyncTime:this.syncStatus.lastSyncTime},this.notify();const s=await this.indexAllLocalFiles();let n=[],i=[];if(e==="force_push")console.log("[Sync] Force Push Mode: Uploading all local files..."),n=s.map(a=>a.path),i=[];else if(e==="force_pull"){console.log("[Sync] Force Pull Mode: Downloading all server files...");const a=await this.checkDiff([],t);n=[],i=a.files_to_download}else{console.log("[Sync] Standard Mode: Checking diff...");const a=await this.checkDiff(s,t);this.syncConfig.strategy!=="pull"&&(n=a.files_to_upload),this.syncConfig.strategy!=="push"&&(i=a.files_to_download)}console.log(`[Sync] Plan: Upload ${n.length}, Download ${i.length}`);for(const a of n)await this.uploadFile(a,t);for(const a of i)await this.downloadFile(a,t);this.syncStatus={state:"success",lastSyncTime:Date.now()}}catch(s){throw console.error("Sync Error",s),this.syncStatus={state:"error",lastSyncTime:this.syncStatus.lastSyncTime,errorMessage:s.message},s}finally{this.notify()}}async checkDiff(e,t){const s=await fetch(`${this.syncConfig.serverUrl}/api/sync/check`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(!s.ok)throw new Error("Sync check failed (Invalid Token or Server Error)");return await s.json()}async indexAllLocalFiles(){const e=[],t=this.vfs.getAllModules().filter(s=>!Nt.includes(s.name));for(const s of t){const n=this.vfs.getModule(s.name);if(n&&n.rootNodeId){const i=await this.vfs.kernel.getNode(n.rootNodeId);i&&await this._traverseAndIndex(s.name,i,e)}}return e}async _traverseAndIndex(e,t,s){if(t.type===w.FILE){const n=await this.vfs.kernel.read(t.nodeId);let i;typeof n=="string"?i=new TextEncoder().encode(n).buffer:i=n;const a=await this.computeSHA256(i);s.push({path:t.path,hash:a,mtime:t.modifiedAt,is_deleted:!1})}else if(t.type===w.DIRECTORY){const n=await this.vfs.kernel.readdir(t.nodeId);for(const i of n)await this._traverseAndIndex(e,i,s)}}async uploadFile(e,t){try{const s=await this.vfs.kernel.resolvePathToId(e);if(s){const n=await this.vfs.kernel.read(s),i=new Blob([n]),a=new FormData;a.append(e,i),await fetch(`${this.syncConfig.serverUrl}/api/sync/upload`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:a})}}catch(s){console.warn(`Failed to upload ${e}`,s)}}async downloadFile(e,t){try{const s=await fetch(`${this.syncConfig.serverUrl}/api/sync/download`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({path:e.path})});if(!s.ok)throw new Error("Download failed");const n=await s.arrayBuffer(),i=e.path.split("/").filter(Boolean),a=i[0],o="/"+i.slice(1).join("/");if(this.vfs.getModule(a)){try{await this.vfs.write(a,o,n)}catch(c){if(this.isNotFoundError(c))await this.ensureParentDirectories(a,o),await this.vfs.createFile(a,o,n);else throw c}const r=await this.vfs.getNode(a,o);r&&await this.vfs.updateMetadata(r.nodeId,{syncedAt:e.mtime})}}catch(s){console.error(`Failed to download ${e.path}`,s)}}async ensureParentDirectories(e,t){const s=t.split("/").filter(Boolean);s.pop();let n="";for(const i of s)if(n+="/"+i,!await this.vfs.getNode(e,n))try{await this.vfs.createDirectory(e,n)}catch(o){if(!this.isAlreadyExistsError(o))throw o}}async computeSHA256(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}async exportMixedData(e,t){const s={version:2,timestamp:Date.now(),type:"mixed_backup",settings:{},modules:[]};e.includes("tags")&&(s.settings.tags=this.state.tags),e.includes("contacts")&&(s.settings.contacts=this.state.contacts);for(const n of t)try{const i=await this.vfs.exportModule(n);s.modules.push(i)}catch(i){console.warn(`Failed to export module ${n}`,i)}return s}async importMixedData(e,t,s,n={}){const i=[];e.settings&&(t.includes("tags")&&e.settings.tags&&(this.state.tags=e.settings.tags,i.push(this.saveEntity("tags"))),t.includes("contacts")&&e.settings.contacts&&(this.state.contacts=e.settings.contacts,i.push(this.saveEntity("contacts"))));const a=e.modules||[];if(Array.isArray(a)){const o=a.filter(r=>r.module&&s.includes(r.module.name));for(const r of o)try{await this.vfs.importModule(r)}catch(c){console.error(`Failed to import module ${r?.module?.name}`,c)}}i.length>0&&await Promise.all(i),await this.syncTags(),this.notify()}async listLocalSnapshots(){if(!window.indexedDB.databases)return[];const e=await window.indexedDB.databases(),t=[];for(const s of e)if(s.name&&s.name.startsWith(Dt)){const n=s.name.split("_"),i=parseInt(n[1]);isNaN(i)||t.push({name:s.name,displayName:new Date(i).toLocaleString(),createdAt:i,size:0,description:""})}return t.sort((s,n)=>n.createdAt-s.createdAt)}async createSnapshot(){const e=`${Dt}${Date.now()}`;await this.copyDatabase(this.dbName,e)}async restoreSnapshot(e){await this.vfs.shutdown(),await this.copyDatabase(e,this.dbName)}async deleteSnapshot(e){return new Promise((t,s)=>{const n=window.indexedDB.deleteDatabase(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error),n.onblocked=()=>console.warn(`Delete ${e} blocked`)})}async copyDatabase(e,t){return new Promise((s,n)=>{const i=indexedDB.open(e);i.onerror=()=>n(i.error),i.onsuccess=()=>{const a=i.result,o=Array.from(a.objectStoreNames),r=indexedDB.deleteDatabase(t);r.onsuccess=r.onerror=()=>{const c=indexedDB.open(t,a.version);c.onupgradeneeded=d=>{const h=d.target.result;for(const u of o){const g=a.transaction(u,"readonly").objectStore(u),p=h.createObjectStore(u,{keyPath:g.keyPath,autoIncrement:g.autoIncrement});for(const f of Array.from(g.indexNames)){const v=g.index(f);p.createIndex(f,v.keyPath,{unique:v.unique,multiEntry:v.multiEntry})}}},c.onsuccess=async()=>{const d=c.result;try{for(const h of o)await this.copyStoreData(a,d,h);a.close(),d.close(),s()}catch(h){a.close(),d.close(),n(h)}},c.onerror=()=>{a.close(),n(c.error)}}}})}copyStoreData(e,t,s){return new Promise((n,i)=>{const r=e.transaction(s,"readonly").objectStore(s).getAll();r.onsuccess=()=>{const c=r.result,h=t.transaction(s,"readwrite").objectStore(s);let u=0;const g=c.length;if(g===0){n();return}for(const p of c){const f=h.put(p);f.onsuccess=()=>{u++,u===g&&n()},f.onerror=()=>i(f.error)}},r.onerror=()=>i(r.error)})}async createFullBackup(){return this.vfs.createBackup()}async restoreFullBackup(e){await this.vfs.restoreBackup(e),this.initialized=!1,await this.init()}async factoryReset(){await this.vfs.shutdown(),await new Promise((e,t)=>{const s=indexedDB.deleteDatabase(this.dbName);s.onsuccess=()=>e(),s.onerror=()=>t(s.error),s.onblocked=()=>{console.warn("Factory reset blocked, forcing..."),e()}}),this.state={tags:[],contacts:[]},this.syncConfig={serverUrl:"",username:"",strategy:"manual",autoSync:!1},this.syncStatus={state:"idle",lastSyncTime:null},this.initialized=!1}updateOrAdd(e,t){const s=e.findIndex(n=>n.id===t.id);s>=0?e[s]=t:e.push(t),this.notify()}onChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>{try{e()}catch(t){console.error("[SettingsService] Listener error:",t)}})}getAvailableSettingsKeys(){return["tags","contacts"]}getAvailableWorkspaces(){return this.vfs.getAllModules().filter(e=>!Nt.includes(e.name)).map(e=>({name:e.name,description:e.description}))}async dispose(){this.eventUnsubscribers.forEach(e=>e()),this.eventUnsubscribers=[],this.syncTimer&&(clearTimeout(this.syncTimer),this.syncTimer=null),this.listeners.clear(),this.initialized=!1}}const je={storage:{name:"Storage",icon:""},tags:{name:"Tags",icon:""},contacts:{name:"Contacts",icon:""},connections:{name:"Connections",icon:""},"mcp-servers":{name:"MCP Servers",icon:""},about:{name:"About",icon:""}};class Oa{constructor(e){this.service=e}moduleName="settings_root";listeners=new Map;async init(){}async loadTree(){return await this.service.init(),Object.entries(je).map(([e,t])=>({id:e,parentId:null,name:t.name,type:"file",icon:t.icon,content:"",size:0,createdAt:Date.now(),modifiedAt:Date.now(),path:`/${t.name}`,moduleId:"settings_ui"}))}async getChildren(e){return[]}async readContent(e){return e}async search(e){if(!e.text)return[];const t=e.text.toLowerCase();return Object.entries(je).filter(([s,n])=>n.name.toLowerCase().includes(t)).map(([s,n])=>({id:s,parentId:null,name:n.name,type:"file",path:`/${n.name}`,size:0,createdAt:Date.now(),modifiedAt:Date.now()}))}async getNode(e){const t=je[e];return t?{id:e,parentId:null,name:t.name,type:"file",icon:t.icon,path:`/${t.name}`,size:0,createdAt:Date.now(),modifiedAt:Date.now()}:null}async writeContent(e,t){console.warn("Direct write to SettingsEngine ignored. Use SettingsService.")}async updateMetadata(e,t){}async createFile(e,t,s){throw new Error("Cannot create new settings pages.")}async createDirectory(e,t){throw new Error("Cannot create directories in settings.")}async createAsset(e,t,s){throw new Error("Assets are not supported in settings engine.")}async getAssetDirectoryId(e){return null}async rename(e,t){throw new Error("Cannot rename settings.")}async move(e,t){throw new Error("Cannot move settings.")}async delete(e){throw new Error("Cannot delete settings.")}async setTags(e,t){}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e).delete(t)}}class Fa{container;panel=null;isVisible=!1;items=[];currentIndex=-1;options;isSelectionMode=!1;selectedIds=new Set;keydownHandler=null;constructor(e,t){this.container=e,this.options=t}updateItems(e,t){this.items=e.map((n,i)=>({id:n.id,role:n.role,preview:this.getPreview(n.content||n.executionRoot?.data.output||"",30),isCollapsed:t[n.id]??!1,index:i,timestamp:n.timestamp,agentName:n.executionRoot?.name}));const s=new Set(this.items.map(n=>n.id));this.selectedIds=new Set([...this.selectedIds].filter(n=>s.has(n))),this.isVisible&&this.render()}setCurrentChat(e){const t=this.items.findIndex(s=>s.id===e);t!==-1&&(this.currentIndex=t,this.isVisible&&this.updateHighlight())}toggle(){this.isVisible?this.hide():this.show()}show(){this.isVisible||(this.isVisible=!0,this.render(),this.bindKeyboard())}hide(){this.isVisible&&(this.isVisible=!1,this.isSelectionMode=!1,this.selectedIds.clear(),this.unbindKeyboard(),this.panel&&(this.panel.classList.add("llm-nav-panel--hiding"),setTimeout(()=>{this.panel?.remove(),this.panel=null},200)))}render(){this.panel?.remove(),this.panel=document.createElement("div"),this.panel.className="llm-nav-panel",this.isSelectionMode&&this.panel.classList.add("llm-nav-panel--selection-mode");const e=this.items.filter(i=>i.role==="user"),t=e.length,s=this.currentIndex>=0?e.findIndex(i=>i.index<=this.currentIndex):-1,n=this.isSelectionMode?`
        <button class="llm-nav-panel__action-btn" data-action="batch-toggle" ${this.selectedIds.size===0?"disabled":""}>
             Toggle (${this.selectedIds.size})
        </button>
        <div style="flex:1"></div> <!-- Spacer -->
        <button class="llm-nav-panel__action-btn llm-nav-panel__action-btn--danger" data-action="batch-delete" ${this.selectedIds.size===0?"disabled":""}>
             Delete
        </button>
        <button class="llm-nav-panel__action-btn" data-action="batch-copy" ${this.selectedIds.size===0?"disabled":""}>
             Copy
        </button>
        <button class="llm-nav-panel__action-btn" data-action="cancel-selection">
            Done
        </button>
            `:`
                <button class="llm-nav-panel__action-btn" data-action="toggle-current" title="Toggle Current Fold">
                     Toggle Fold
                </button>
                <button class="llm-nav-panel__action-btn" data-action="copy-current" title="Copy Current">
                     Copy
                </button>
                <button class="llm-nav-panel__action-btn" data-action="enter-selection" title="Manage Messages">
                     Select
                </button>
            `;this.panel.innerHTML=`
            <div class="llm-nav-panel__header">
                <span class="llm-nav-panel__title">${this.isSelectionMode?"Select Messages":"Chat Navigator"}</span>
                <span class="llm-nav-panel__counter">${s+1} / ${t}</span>
                <button class="llm-nav-panel__close" title="Close (Esc)"></button>
            </div>
            
            <div class="llm-nav-panel__toolbar">
                <button class="llm-nav-panel__btn" data-action="fold-all" title="Fold All">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 14 10 14 10 20"></polyline>
                        <polyline points="20 10 14 10 14 4"></polyline>
                    </svg>
                </button>
                <button class="llm-nav-panel__btn" data-action="unfold-all" title="Unfold All">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <polyline points="9 21 3 21 3 15"></polyline>
                    </svg>
                </button>
                <div class="llm-nav-panel__sep"></div>
                ${this.isSelectionMode?`
                    <button class="llm-nav-panel__btn" data-action="select-all" title="Select All">All</button>
                `:`
                    <button class="llm-nav-panel__btn" data-action="prev" title="Previous User Chat ()"></button>
                    <button class="llm-nav-panel__btn" data-action="next" title="Next User Chat ()"></button>
                `}
            </div>
            
            <div class="llm-nav-panel__list">
                ${this.renderList()}
            </div>
            
            <div class="llm-nav-panel__actions">
                ${n}
            </div>
        `,this.container.appendChild(this.panel),this.bindEvents(),this.updateHighlight(),requestAnimationFrame(()=>{this.panel?.classList.add("llm-nav-panel--visible")})}renderList(){return this.items.length===0?'<div class="llm-nav-panel__empty">No messages yet</div>':this.items.map((e,t)=>{const s=e.role==="user"?"":"",n=e.isCollapsed?"":"",i=t===this.currentIndex?"llm-nav-item--active":"",a=e.isCollapsed?"llm-nav-item--collapsed":"",o=this.selectedIds.has(e.id),r=this.formatTime(e.timestamp),c=e.role==="user"?"You":e.agentName||"Assistant",d=this.isSelectionMode?`<div class="llm-nav-item__checkbox ${o?"checked":""}"></div>`:"";return`
                <div class="llm-nav-item ${i} ${a} ${o?"selected":""}" 
                     data-id="${e.id}" 
                     data-index="${t}">
                    ${d}
                    <span class="llm-nav-item__fold">${n}</span>
                    <span class="llm-nav-item__icon">${s}</span>
                    <div class="llm-nav-item__content">
                        <div class="llm-nav-item__header">
                            <span class="llm-nav-item__title">${S(c)}</span>
                            <span class="llm-nav-item__time">${r}</span>
                        </div>
                        <div class="llm-nav-item__preview">${S(e.preview)}</div>
                    </div>
                    <span class="llm-nav-item__index">#${t+1}</span>
                </div>
            `}).join("")}formatTime(e){const t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}bindEvents(){this.panel&&(this.panel.querySelector(".llm-nav-panel__close")?.addEventListener("click",()=>this.hide()),this.panel.querySelectorAll(".llm-nav-panel__btn, .llm-nav-panel__action-btn").forEach(e=>{e.addEventListener("click",t=>{const s=t.currentTarget.dataset.action;this.handleAction(s)})}),this.panel.querySelectorAll(".llm-nav-item").forEach(e=>{e.addEventListener("click",t=>{const s=t.target,n=e.dataset.id,i=parseInt(e.dataset.index);this.isSelectionMode?s.classList.contains("llm-nav-item__fold")?(this.options.onToggleFold(n),this.updateItemUI(i)):this.toggleSelection(n):s.classList.contains("llm-nav-item__fold")?(this.options.onToggleFold(n),this.updateItemUI(i)):(this.currentIndex=i,this.updateHighlight(),this.options.onNavigate(n))})}))}handleAction(e){switch(e){case"fold-all":this.options.onFoldAll(),this.items.forEach(t=>t.isCollapsed=!0),this.render();break;case"unfold-all":this.options.onUnfoldAll(),this.items.forEach(t=>t.isCollapsed=!1),this.render();break;case"prev":this.navigatePrev();break;case"next":this.navigateNext();break;case"toggle-current":if(this.currentIndex>=0){const t=this.items[this.currentIndex].id;this.options.onToggleFold(t),this.updateItemUI(this.currentIndex)}break;case"copy-current":this.currentIndex>=0&&this.options.onCopy(this.items[this.currentIndex].id);break;case"enter-selection":this.isSelectionMode=!0,this.render();break;case"cancel-selection":this.isSelectionMode=!1,this.selectedIds.clear(),this.render();break;case"select-all":this.selectedIds.size===this.items.length?this.selectedIds.clear():this.items.forEach(t=>this.selectedIds.add(t.id)),this.render();break;case"batch-toggle":this.selectedIds.forEach(t=>{this.options.onToggleFold(t);const s=this.items.find(n=>n.id===t);s&&(s.isCollapsed=!s.isCollapsed)}),this.render();break;case"batch-delete":this.options.onBatchDelete?.(Array.from(this.selectedIds)),this.isSelectionMode=!1,this.selectedIds.clear();break;case"batch-copy":this.options.onBatchCopy?.(Array.from(this.selectedIds)),this.selectedIds.clear(),this.render();break}}toggleSelection(e){this.selectedIds.has(e)?this.selectedIds.delete(e):this.selectedIds.add(e),this.render()}updateItemUI(e){const t=this.items[e];t.isCollapsed=!t.isCollapsed,this.render()}bindKeyboard(){this.keydownHandler=e=>{if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key){case"Escape":e.preventDefault(),this.hide();break;case"ArrowUp":e.preventDefault(),this.navigatePrev();break;case"ArrowDown":e.preventDefault(),this.navigateNext();break;case"Enter":e.preventDefault(),!this.isSelectionMode&&this.currentIndex>=0&&this.options.onNavigate(this.items[this.currentIndex].id);break}},document.addEventListener("keydown",this.keydownHandler)}unbindKeyboard(){this.keydownHandler&&(document.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}navigatePrev(){for(let e=this.currentIndex-1;e>=0;e--)if(this.items[e].role==="user"){this.currentIndex=e,this.updateHighlight(),this.options.onNavigate(this.items[e].id),this.scrollItemIntoView(e);break}}navigateNext(){for(let e=this.currentIndex+1;e<this.items.length;e++)if(this.items[e].role==="user"){this.currentIndex=e,this.updateHighlight(),this.options.onNavigate(this.items[e].id),this.scrollItemIntoView(e);break}}updateHighlight(){if(!this.panel)return;this.panel.querySelectorAll(".llm-nav-item").forEach((n,i)=>{i===this.currentIndex?n.classList.add("llm-nav-item--active"):n.classList.remove("llm-nav-item--active")});const e=this.items.filter(n=>n.role==="user"),t=this.currentIndex>=0?e.findIndex(n=>n.index<=this.currentIndex):-1,s=this.panel.querySelector(".llm-nav-panel__counter");s&&(s.textContent=`${t+1} / ${e.length}`)}scrollItemIntoView(e){this.panel?.querySelector(`[data-index="${e}"]`)?.scrollIntoView({block:"nearest",behavior:"smooth"})}getPreview(e,t){if(!e)return"(empty)";let s=e.replace(/[\r\n]+/g," ").replace(/[*#`_~[\]()]/g,"").trim();return s.length>t?s.substring(0,t)+"...":s}destroy(){this.hide(),this.items=[]}}class Pe{static formatTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}static renderUserBubble(e,t,s=!1){const n=s?"is-collapsed":"",i=this.formatTime(e.timestamp),a=e.siblingIndex??0,o=e.siblingCount??1,c=o>1?`
            <button class="llm-icon-btn" data-action="prev-sibling" title="Previous" ${a===0?"disabled":""}></button>
            <span class="llm-ui-branch-indicator">${a+1}/${o}</span>
            <button class="llm-icon-btn" data-action="next-sibling" title="Next" ${a===o-1?"disabled":""}></button>
            <div class="llm-ui-sep" style="width:1px;background:rgba(255,255,255,0.2);margin:0 4px;"></div>
        `:"";return`
            <div class="llm-ui-bubble llm-ui-bubble--user ${n}">
                <div class="llm-ui-bubble__header">
                    <div class="llm-ui-avatar"></div>
                    
                    <div class="llm-ui-header-preview">${S(t)}</div>
                    <div class="llm-ui-time">${i}</div>

                    <!--  margin-left: auto  actions  -->
                    <div class="llm-ui-actions" style="margin-left: auto; display: flex; gap: 4px;">
                         ${c}
                         
                         <button class="llm-icon-btn" data-action="delete" title="Delete"></button>
                         <button class="llm-icon-btn" data-action="resend" title="Resend"></button>
                         <button class="llm-icon-btn" data-action="edit" title="Edit"></button>
                         <button class="llm-icon-btn" data-action="copy" title="Copy"></button>
                         <button class="llm-icon-btn" data-action="collapse" title="Toggle">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                ${s?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>'}
                            </svg>
                         </button>
                    </div>
                </div>
                <div class="llm-ui-bubble__content">
                    <!--  []  <div class="llm-ui-files">...</div> -->
                    
                    <div class="llm-ui-mount-point" id="user-mount-${e.id}"></div>
                    
                    <div class="llm-ui-edit-actions" style="display:none;">
                        <button class="llm-btn llm-btn--primary" data-action="confirm-edit">Save & Run</button>
                        <button class="llm-btn" data-action="save-only">Save Only</button>
                        <button class="llm-btn" data-action="cancel-edit">Cancel</button>
                    </div>
                </div>
            </div>
        `}static renderAgentHeader(e,t,s,n=!1){const i=this.formatTime(e.startTime),a=e.data.metaInfo?.siblingIndex??0,o=e.data.metaInfo?.siblingCount??1,c=o>1?`
            <button class="llm-icon-btn" data-action="prev-sibling" title="Previous" ${a===0?"disabled":""}></button>
            <span class="llm-ui-branch-indicator">${a+1}/${o}</span>
            <button class="llm-icon-btn" data-action="next-sibling" title="Next" ${a===o-1?"disabled":""}></button>
            <div class="llm-ui-sep"></div>
        `:"",d=e.data.metaInfo?.agentId;return`
            <div class="llm-ui-node__header">
                <div class="llm-ui-node__status-icon">
                    <div class="llm-ui-spinner"></div>
                    <div class="llm-ui-status-dot"></div>
                </div>
                ${e.executorType==="agent"&&d?`<div class="llm-ui-node__icon llm-ui-node__icon--clickable" title="Edit Agent" data-agent-id="${S(d)}">${s}</div>`:`<div class="llm-ui-node__icon">${s}</div>`}
                <div class="llm-ui-node__title">${S(e.name)}</div>
                
                <div class="llm-ui-header-preview">${S(t)}</div>
                
                <div class="llm-ui-node__meta">
                    <span class="llm-ui-time">${i}</span>
                    <span class="llm-ui-node__status">${e.status}</span>
                </div>

                <!--  margin-left: auto  actions  -->
                <div class="llm-ui-actions" style="margin-left: auto; display: flex; gap: 4px;">
                ${c}
                    <button class="llm-icon-btn" data-action="delete" title="Delete"></button>
                    <!--  Edit  () -->
                    <button class="llm-icon-btn" data-action="retry" title="Retry"></button>
                    <button class="llm-icon-btn" data-action="edit" title="Edit Result"></button>
                    <button class="llm-icon-btn" data-action="copy" title="Copy"></button>
                    <button class="llm-icon-btn" data-action="collapse" title="Toggle">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            ${n?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>'}
                        </svg>
                    </button>
                </div>
            </div>
        `}static renderThinking(e,t){return`
            <div class="llm-ui-thought" style="display: ${t?"block":"none"}">
                <div class="llm-ui-thought__label">Thinking Process</div>
                <div class="llm-ui-thought__content">${S(e).replace(/\n/g,"<br>")}</div>
            </div>
        `}static renderTool(e,t){const s=JSON.stringify(e.data.input||{},null,2),n=JSON.stringify(e.data.toolCall?.result||{},null,2);return`
            <div class="llm-ui-node__header">
                <div class="llm-ui-node__icon">${t}</div>
                <div class="llm-ui-node__title">${S(e.name)}</div>
                <div class="llm-ui-node__status">${e.status}</div>
                <div class="llm-ui-actions">
                    <button class="llm-icon-btn" data-action="collapse">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="llm-ui-node__body">
                <div class="llm-ui-code-block">Input: ${S(s)}</div>
                <div class="llm-ui-code-block llm-ui-node__result" style="display:${e.status==="success"?"block":"none"}">
                    Result: ${S(n)}
                </div>
            </div>
        `}}class $t{static getIcon(e){if(e.data.metaInfo?.agentIcon)return e.data.metaInfo.agentIcon;if(e.data.metaInfo?.agentId==="default")return"";switch(e.executorType){case"agent":return"";case"tool":return"";case"composite":return"";case"http":return"";case"script":return"";default:return""}}static getLayoutClass(e){return e.data.metaInfo?.executionMode==="concurrent"?"llm-ui-layout--grid":"llm-ui-layout--list"}}class Ua{static create(e){const t=document.createElement("div"),s=$t.getIcon(e),n=$t.getLayoutClass(e);t.className=`llm-ui-node llm-ui-node--${e.executorType} ${n}`,t.dataset.id=e.id,t.dataset.status=e.status;const i={};return e.executorType==="agent"||e.executorType==="composite"?this.renderAgent(t,e,i,s):e.executorType==="tool"?t.innerHTML=Pe.renderTool(e,s):this.renderAgent(t,e,i,s),{element:t,mountPoints:i}}static renderAgent(e,t,s,n){const i=!!(t.data.thought&&t.data.thought.length>0),a=t.data.output?t.data.output.substring(0,50).replace(/\n/g," "):"",o=t.status==="failed"&&t.data.error?`<div class="llm-ui-node__error-embed">
                  ${S(t.data.error)}
               </div>`:"";e.innerHTML=`
            ${Pe.renderAgentHeader(t,a,n)}

            <div class="llm-ui-node__body">
                ${Pe.renderThinking(t.data.thought||"",i)}
                ${o}

                <div class="llm-ui-node__output">
                    <div class="llm-ui-mount-point" id="mount-${t.id}"></div>
                </div>

                <div class="llm-ui-node__children"></div>
            </div>
        `,s.output=e.querySelector(`#mount-${t.id}`)}}class Rt{editor=null;container;currentContent="";isStreaming=!1;isReadOnly=!0;onChangeCallback;isStreamingInit=!1;options;isInitialized=!1;pendingChunks=[];readyPromise;readyResolve;readyReject;RENDER_INTERVAL=300;BATCH_SIZE_THRESHOLD=800;lastRenderTime=0;rafId=null;renderScheduled=!1;contentSnapshot="";pendingContentLength=0;constructor(e,t,s){this.container=e,this.currentContent=t,this.options=s||{},this.isReadOnly=s?.readOnly??!0,this.onChangeCallback=s?.onChange,this.isStreamingInit=s?.streaming??!1,this.readyPromise=new Promise((n,i)=>{this.readyResolve=n,this.readyReject=i}),this.init()}async waitUntilReady(){return this.readyPromise}async init(){try{this.editor=await mt(this.container,{initialContent:this.currentContent,initialMode:this.isReadOnly?"render":"edit",nodeId:this.options.nodeId,ownerNodeId:this.options.ownerNodeId,sessionEngine:this.options.sessionEngine,plugins:["editor:core","ui:formatting","mathjax","mermaid","codeblock-controls","task-list","media","svg","ui:toolbar"],defaultPluginOptions:{"codeblock-controls":{defaultCollapsed:!this.isStreamingInit,streamingMode:this.isStreamingInit}}}),this.editor.on("change",()=>{if(!this.isStreaming){const e=this.editor.getText();this.currentContent=e,this.onChangeCallback?.(e)}}),this.isInitialized=!0,console.log("[MDxController] init() completed"),this.pendingChunks.length>0&&(console.log("[MDxController] Applying pending chunks, count:",this.pendingChunks.length),this.pendingChunks=[],await this.editor.setStreamingText(this.currentContent)),this.readyResolve()}catch(e){console.error("[MDxController] init() failed:",e),this.readyReject(e)}}appendStream(e){if(this.isStreaming=!0,this.currentContent+=e,this.pendingContentLength+=e.length,!this.isInitialized||!this.editor){this.pendingChunks.push(e);return}const s=Date.now()-this.lastRenderTime,n=this.pendingContentLength>=this.BATCH_SIZE_THRESHOLD,i=s>=this.RENDER_INTERVAL,o=/[.!?\n]$/.test(e)&&s>=100;(n||i||o)&&this.scheduleRender()}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,this.rafId!==null&&cancelAnimationFrame(this.rafId),"requestIdleCallback"in window?window.requestIdleCallback(()=>this.doRender(),{timeout:this.RENDER_INTERVAL}):this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.doRender()}))}async doRender(){if(this.renderScheduled=!1,!(!this.editor||!this.isInitialized)&&this.currentContent!==this.contentSnapshot)try{await this.editor.setStreamingText(this.currentContent),this.contentSnapshot=this.currentContent,this.lastRenderTime=Date.now(),this.pendingContentLength=0}catch(e){console.error("[MDxController] Render failed:",e)}}finishStream(e=!1){this.isStreaming=!1,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.renderScheduled=!1,this.pendingContentLength=0,this.editor&&this.isInitialized&&this.currentContent!==this.contentSnapshot&&queueMicrotask(async()=>{try{await this.editor.setStreamingText(this.currentContent),this.contentSnapshot=this.currentContent}catch(t){console.error("[MDxController] Final render failed:",t)}}),e&&this.onChangeCallback?.(this.currentContent)}async toggleEdit(){if(!this.editor)return;this.isReadOnly=!this.isReadOnly;const e=this.isReadOnly?"render":"edit";await this.editor.switchToMode(e),this.isReadOnly||this.editor.focus()}get content(){return this.currentContent}setContent(e){this.currentContent=e,this.contentSnapshot=e,this.isInitialized&&this.editor&&this.editor.setText(e)}isEditing(){return!this.isReadOnly}async setMode(e){if(!this.editor)return;const t=e==="render";this.isReadOnly!==t&&(this.isReadOnly=t,await this.editor.switchToMode(e))}destroy(){this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.editor?.destroy(),this.editor=null,this.isInitialized=!1,this.pendingChunks=[],this.renderScheduled=!1,this.pendingContentLength=0}}const Ba={renderWorkspace:l=>`
        <div class="llm-workspace-titlebar">
            <div class="llm-workspace-titlebar__left">
                <button class="llm-workspace-titlebar__btn" id="llm-btn-sidebar" title="Toggle Sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                </button>
                
                <div class="llm-workspace-titlebar__sep"></div>
                
                <input type="text" class="llm-workspace-titlebar__input" id="llm-title-input" value="${S(l)}" placeholder="Untitled Chat" />
            </div>

            <div class="llm-workspace-titlebar__right">
                <button class="llm-workspace-titlebar__btn" id="llm-btn-collapse" title="Collapse/Expand All Messages">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline></svg>
                </button>

                <button class="llm-workspace-titlebar__btn" id="llm-btn-copy" title="Copy as Markdown">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>

                <button class="llm-workspace-titlebar__btn" id="llm-btn-print" title="Print">
                        <i class="fas fa-print"></i>
                </button>
            </div>
        </div>

        <div class="llm-ui-workspace__history" id="llm-ui-history"></div>
        <div class="llm-ui-workspace__input" id="llm-ui-input"></div>
    `,renderWelcome:()=>`
        <div class="llm-ui-welcome">
            <div class="llm-ui-welcome__icon"></div>
            <h2>Ready to chat</h2>
            <p>Send a message to start the conversation</p>
        </div>
    `,renderErrorBanner:l=>`
        <div class="llm-ui-banner llm-ui-banner--error">
            Error: ${S(l)}
        </div>
    `};class Ha{nodeMap=new Map;editorMap=new Map;container;shouldAutoScroll=!0;scrollThreshold=150;scrollFrameId=null;resizeObserver;isStreamingMode=!1;lastScrollHeight=0;scrollLockUntil=0;userIsScrolledUp=!1;previewUpdateTimers=new Map;onContentChange;onNodeAction;originalContentMap=new Map;editingNodes=new Set;renderedSessionIds=new Set;contextOptions;collapseStates={};onCollapseStateChange;eventQueue=[];eventProcessTimer=null;EVENT_BATCH_INTERVAL=50;scrollThrottleTimer=null;SCROLL_THROTTLE=100;thoughtScrollThrottled=!1;newContentIndicator=null;constructor(e,t,s,n){this.container=e,this.onContentChange=t,this.onNodeAction=s,this.contextOptions=n||{},n?.initialCollapseStates&&(this.collapseStates={...n.initialCollapseStates}),this.onCollapseStateChange=n?.onCollapseStateChange,this.container.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.scrollFrameId===null&&(this.scrollFrameId=requestAnimationFrame(()=>{this.scrollFrameId=null,this.handleResize()}))}),this.resizeObserver.observe(this.container)}getCollapseStates(){return{...this.collapseStates}}setCollapseStates(e){this.collapseStates={...e}}renderFull(e){if(this.clear(),e.length===0){this.renderWelcome();return}const t=Object.keys(this.collapseStates).length>0;let s=-1;if(!t){for(let n=e.length-1;n>=0;n--)if(e[n].role==="user"){s=n;break}s===-1&&e.length>0&&(s=e.length-1)}e.forEach((n,i)=>{let a;t&&this.collapseStates[n.id]!==void 0?a=this.collapseStates[n.id]:(a=i<s,this.collapseStates[n.id]=a),this.appendSessionGroup(n,a),n.executionRoot&&this.renderExecutionTree(n.executionRoot,a)}),this.scrollToBottom(!0)}renderWelcome(){this.container.innerHTML=Ba.renderWelcome()}renderError(e){const t=this.container.querySelector(".llm-ui-error-banner");t&&t.remove();const s=document.createElement("div");s.className="llm-ui-error-banner",s.innerHTML=`
            <div class="llm-ui-error-banner__content">
                <span class="llm-ui-error-banner__icon"></span>
                <span class="llm-ui-error-banner__message">${S(e.message)}</span>
                <button class="llm-ui-error-banner__close" title="Dismiss"></button>
            </div>
        `,s.querySelector(".llm-ui-error-banner__close")?.addEventListener("click",()=>{s.remove()}),e.message.includes("401")||e.message.includes("API key")||setTimeout(()=>s.remove(),5e3),this.container.insertBefore(s,this.container.firstChild),this.scrollToBottom(!0)}handleScroll(){const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.container,n=t-e-s;if(this.userIsScrolledUp=n>this.scrollThreshold,this.userIsScrolledUp||this.hideNewContentIndicator(),!this.isStreamingMode){if(Date.now()<this.scrollLockUntil)return;this.shouldAutoScroll=n<this.scrollThreshold}}handleResize(){!this.shouldAutoScroll&&!this.isStreamingMode||this.scrollThrottleTimer===null&&(this.scrollThrottleTimer=window.setTimeout(()=>{this.scrollThrottleTimer=null;const e=this.container.scrollHeight;e>this.lastScrollHeight&&(this.lastScrollHeight=e,this.instantScrollToBottom())},this.SCROLL_THROTTLE))}instantScrollToBottom(){this.scrollFrameId===null&&(this.scrollFrameId=requestAnimationFrame(()=>{this.scrollFrameId=null,this.container.scrollTop=this.container.scrollHeight}))}scrollToBottom(e=!1){!e&&!this.shouldAutoScroll||(this.scrollFrameId!==null&&cancelAnimationFrame(this.scrollFrameId),this.scrollFrameId=requestAnimationFrame(()=>{this.scrollFrameId=null,this.container.scrollTop=this.container.scrollHeight,this.lastScrollHeight=this.container.scrollHeight,this.scrollLockUntil=Date.now()+100}))}enterStreamingMode(){this.isStreamingMode||(this.isStreamingMode=!0,this.shouldAutoScroll=!0,this.lastScrollHeight=this.container.scrollHeight,this.container.classList.add("llm-ui-history--streaming"))}exitStreamingMode(){this.isStreamingMode&&(this.isStreamingMode=!1,this.container.classList.remove("llm-ui-history--streaming"),this.userIsScrolledUp?this.showNewContentIndicator():this.scrollToBottom(!0),this.container.querySelectorAll(".llm-ui-node--streaming").forEach(e=>{e.classList.remove("llm-ui-node--streaming")}),this.previewUpdateTimers.forEach(e=>clearTimeout(e)),this.previewUpdateTimers.clear(),this.editorMap.forEach((e,t)=>{const s=this.nodeMap.get(t);if(s){const n=s.querySelector(".llm-ui-header-preview");n&&(n.textContent=this.getPreviewText(e.content))}}))}showNewContentIndicator(){this.newContentIndicator||(this.newContentIndicator=document.createElement("div"),this.newContentIndicator.className="llm-ui-new-content-indicator",this.newContentIndicator.innerHTML=`
            <button class="llm-ui-new-content-btn">
                <span> New response available</span>
            </button>
        `,this.newContentIndicator.querySelector("button")?.addEventListener("click",()=>{this.scrollToBottom(!0),this.hideNewContentIndicator()}),this.container.appendChild(this.newContentIndicator))}hideNewContentIndicator(){this.newContentIndicator&&(this.newContentIndicator.remove(),this.newContentIndicator=null)}appendSessionGroup(e,t){if(this.renderedSessionIds.has(e.id)){console.warn(`[HistoryView] Duplicate session skipped: ${e.id}`);return}this.renderedSessionIds.add(e.id);const s=document.createElement("div");if(s.className=`llm-ui-session llm-ui-session--${e.role}`,s.dataset.sessionId=e.id,e.role==="user"){const n=this.getPreviewText(e.content||"");s.innerHTML=Pe.renderUserBubble(e,n,t),this.container.appendChild(s),this.initUserBubble(s,e)}else s.innerHTML=`
                <div class="llm-ui-avatar"></div>
                <div class="llm-ui-execution-root" id="container-${e.id}"></div>
            `,this.container.appendChild(s)}initUserBubble(e,t){const s=e.querySelector(`#user-mount-${t.id}`),n=new Rt(s,t.content||"",{readOnly:!0,onChange:i=>{this.onContentChange?.(t.id,i,"user");const a=e.querySelector(".llm-ui-header-preview");a&&(a.textContent=this.getPreviewText(i))},nodeId:this.contextOptions.nodeId,ownerNodeId:this.contextOptions.ownerNodeId,sessionEngine:this.contextOptions.sessionEngine});this.editorMap.set(t.id,n),this.bindUserBubbleEvents(e,t,n)}bindUserBubbleEvents(e,t,s){const n=e.querySelector(".llm-ui-bubble--user"),i=e.querySelector(".llm-ui-edit-actions");if(!n)return;e.querySelector('[data-action="resend"]')?.addEventListener("click",o=>{o.stopPropagation(),this.onNodeAction?.("resend",t.id)}),e.querySelector('[data-action="edit"]')?.addEventListener("click",o=>{o.stopPropagation(),this.toggleEditMode(t.id,s,i,e)}),e.querySelector('[data-action="copy"]')?.addEventListener("click",async o=>{o.stopPropagation(),await this.handleCopy(s.content,o.currentTarget)}),e.querySelector('[data-action="delete"]')?.addEventListener("click",async o=>{o.stopPropagation(),await this.handleDeleteConfirm(t.id,"user")});const a=e.querySelector('[data-action="collapse"]');a&&a.addEventListener("click",o=>{o.stopPropagation(),this.toggleCollapse(n,o.currentTarget,t.id)}),e.querySelector('[data-action="prev-sibling"]')?.addEventListener("click",o=>{o.stopPropagation(),this.onNodeAction?.("prev-sibling",t.id)}),e.querySelector('[data-action="next-sibling"]')?.addEventListener("click",o=>{o.stopPropagation(),this.onNodeAction?.("next-sibling",t.id)}),e.querySelector('[data-action="confirm-edit"]')?.addEventListener("click",o=>{o.stopPropagation(),this.confirmEdit(t.id,s,i,e,!0)}),e.querySelector('[data-action="save-only"]')?.addEventListener("click",o=>{o.stopPropagation(),this.confirmEdit(t.id,s,i,e,!1)}),e.querySelector('[data-action="cancel-edit"]')?.addEventListener("click",o=>{o.stopPropagation(),this.cancelEdit(t.id,s,i,e)})}toggleEditMode(e,t,s,n){if(this.editingNodes.has(e))this.confirmEdit(e,t,s,n,!1);else{this.originalContentMap.set(e,t.content),this.editingNodes.add(e),t.toggleEdit(),s.style.display="flex",n.querySelector('[data-action="edit"]')?.classList.add("active");const i=n.querySelector(".llm-ui-bubble--user");if(i&&i.classList.contains("is-collapsed")){const a=n.querySelector('[data-action="collapse"]');a&&a.click()}}}confirmEdit(e,t,s,n,i){const a=t.content;this.editingNodes.delete(e),this.originalContentMap.delete(e),t.toggleEdit(),s.style.display="none",n.querySelector('[data-action="edit"]')?.classList.remove("active"),this.onContentChange?.(e,a,"user"),i&&this.onNodeAction?.("edit-and-retry",e)}cancelEdit(e,t,s,n){const i=this.originalContentMap.get(e);i!==void 0&&t.setContent(i),this.editingNodes.delete(e),this.originalContentMap.delete(e),t.toggleEdit(),s.style.display="none",n.querySelector('[data-action="edit"]')?.classList.remove("active")}async handleCopy(e,t){try{await navigator.clipboard.writeText(e);const s=t.innerHTML;t.innerHTML="",setTimeout(()=>t.innerHTML=s,1500)}catch(s){console.error("Copy failed",s)}}async handleDeleteConfirm(e,t){let s="Delete this message?";if(t==="user"){const i=this.countAssociatedResponses(e);i>0&&(s=`Delete this message and ${i} response(s)?`)}await Zt(s)&&this.onNodeAction?.("delete",e)}countAssociatedResponses(e){const t=this.container.querySelectorAll(".llm-ui-session");let s=0,n=!1;return t.forEach(i=>{if(i.dataset.sessionId===e){n=!0;return}n&&(i.classList.contains("llm-ui-session--assistant")?s++:n=!1)}),s}toggleCollapse(e,t,s){e.classList.toggle("is-collapsed");const n=e.classList.contains("is-collapsed"),i=t.querySelector("svg");i&&(i.innerHTML=n?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>'),s&&(this.collapseStates[s]=n,this.isStreamingMode||this.onCollapseStateChange?.(this.collapseStates))}renderExecutionTree(e,t=!1){this.appendNode(e.parentId,e,t),e.children?.forEach(s=>this.renderExecutionTree(s,t))}appendNode(e,t,s){if(this.nodeMap.has(t.id)){console.warn(`[HistoryView] Duplicate node skipped: ${t.id}`);return}let n=null;if(e&&(n=this.nodeMap.get(e)?.querySelector(".llm-ui-node__children")||null),!n){const i=this.container.querySelectorAll(".llm-ui-execution-root");i.length>0&&(n=i[i.length-1])}if(n){const{element:i,mountPoints:a}=Ua.create(t);if(s){i.classList.add("is-collapsed");const o=i.querySelector('[data-action="collapse"] svg');o&&(o.innerHTML='<polyline points="6 9 12 15 18 9"></polyline>')}this.nodeMap.set(t.id,i),n.appendChild(i),this.bindNodeEvents(i,t,a)}}bindNodeEvents(e,t,s){const n=e.querySelector('[data-action="edit"]'),i=e.querySelector('[data-action="copy"]'),a=e.querySelector('[data-action="collapse"]'),o=e.querySelector('[data-action="retry"]'),r=e.querySelector('[data-action="delete"]'),c=()=>e.closest("[data-session-id]")?.dataset.sessionId||t.id,d=c(),h=e.querySelector(".llm-ui-node__icon--clickable");if(h&&h.addEventListener("click",u=>{u.stopPropagation();const g=u.currentTarget.dataset.agentId;g&&this.container.dispatchEvent(new CustomEvent("open-agent-config",{bubbles:!0,detail:{agentId:g}}))}),o?.addEventListener("click",u=>{u.stopPropagation(),this.onNodeAction?.("retry",d)}),r?.addEventListener("click",async u=>{u.stopPropagation(),await this.handleDeleteConfirm(d,"assistant")}),a?.addEventListener("click",u=>{u.stopPropagation(),this.toggleCollapse(e,u.target,d)}),e.querySelector('[data-action="prev-sibling"]')?.addEventListener("click",u=>{u.stopPropagation();const g=c();this.onNodeAction?.("prev-sibling",g)}),e.querySelector('[data-action="next-sibling"]')?.addEventListener("click",u=>{u.stopPropagation();const g=c();this.onNodeAction?.("next-sibling",g)}),s.output){const u=t.status==="running"||t.status==="queued",g=new Rt(s.output,t.data.output||"",{readOnly:!0,streaming:u,onChange:p=>{if(g.isEditing()&&this.onContentChange?.(d,p,"node"),!this.isStreamingMode){const f=e.querySelector(".llm-ui-header-preview");f&&(f.textContent=this.getPreviewText(p))}},nodeId:this.contextOptions.nodeId,ownerNodeId:this.contextOptions.ownerNodeId,sessionEngine:this.contextOptions.sessionEngine});this.editorMap.set(t.id,g),n?.addEventListener("click",async()=>{const p=g.isEditing();await g.toggleEdit(),n.classList.toggle("active"),p&&this.onContentChange?.(d,g.content,"node")}),i?.addEventListener("click",async()=>{await this.handleCopy(g.content,i)})}else n&&(n.style.display="none"),i&&(i.style.display="none")}updateNodeContent(e,t,s){const n=this.nodeMap.get(e);if(n){if(n.classList.contains("llm-ui-node--streaming")||n.classList.add("llm-ui-node--streaming"),s==="thought"){const i=n.querySelector(".llm-ui-thought"),a=n.querySelector(".llm-ui-thought__content");i&&i.style.display==="none"&&(i.style.display="block"),a&&(a.textContent=(a.textContent||"")+t,this.thoughtScrollThrottled||(this.thoughtScrollThrottled=!0,requestAnimationFrame(()=>{this.thoughtScrollThrottled=!1,i&&(i.scrollTop=i.scrollHeight)})))}else if(s==="output"){const i=this.editorMap.get(e);i&&i.appendStream(t)}}}updateNodeStatus(e,t,s){const n=this.nodeMap.get(e);if(n){n.classList.remove("llm-ui-node--streaming"),n.dataset.status=t,n.classList.remove("llm-ui-node--running","llm-ui-node--success","llm-ui-node--failed"),n.classList.add(`llm-ui-node--${t}`);const a=n.querySelector(".llm-ui-node__status");if(a&&(a.textContent=t,a.className=`llm-ui-node__status llm-ui-node__status--${t}`),s&&n.classList.contains("llm-ui-node--tool")){const d=n.querySelector(".llm-ui-node__result");d&&(d.style.display="block",d.textContent=typeof s=="string"?s:JSON.stringify(s))}const o=this.previewUpdateTimers.get(e);o&&(clearTimeout(o),this.previewUpdateTimers.delete(e));const r=this.editorMap.get(e),c=n.querySelector(".llm-ui-header-preview");r&&c&&(c.textContent=this.getPreviewText(r.content))}const i=this.editorMap.get(e);i&&(t==="success"||t==="failed")&&i.finishStream(!1)}removeMessages(e,t=!0){for(const n of e){this.renderedSessionIds.delete(n);const i=this.container.querySelector(`[data-session-id="${n}"]`);i&&this.removeElement(i,t);const a=this.nodeMap.get(n);a&&(this.removeElement(a,t),this.nodeMap.delete(n));const o=this.editorMap.get(n);o&&(o.destroy(),this.editorMap.delete(n));const r=this.previewUpdateTimers.get(n);r&&(clearTimeout(r),this.previewUpdateTimers.delete(n)),this.originalContentMap.delete(n),this.editingNodes.delete(n),delete this.collapseStates[n]}setTimeout(()=>this.checkEmpty(),t?350:0)}removeElement(e,t){t?(e.classList.add("llm-ui-session--deleting"),e.addEventListener("animationend",()=>e.remove(),{once:!0}),setTimeout(()=>{e.parentNode&&e.remove()},350)):e.remove()}checkEmpty(){this.container.querySelectorAll(".llm-ui-session:not(.llm-ui-session--deleting)").length===0&&this.renderWelcome()}handleMessagesDeleted(e){this.removeMessages(e,!0)}handleMessageEdited(e,t){const s=this.container.querySelector(`[data-session-id="${e}"]`);if(s){const n=s.querySelector(".llm-ui-header-preview");n&&(n.textContent=this.getPreviewText(t))}}handleSiblingSwitch(e){const t=this.container.querySelector(`[data-session-id="${e.sessionId}"]`);if(!t)return;const s=t.querySelector(".llm-ui-branch-indicator");s&&(s.textContent=`${e.newIndex+1}/${e.total}`);const n=t.querySelector('[data-action="prev-sibling"]'),i=t.querySelector('[data-action="next-sibling"]');n&&(n.disabled=e.newIndex===0),i&&(i.disabled=e.newIndex===e.total-1)}getPreviewText(e){if(!e)return"";let t=e.replace(/[\r\n]+/g," ");return t=t.replace(/[*#`_~[\]()]/g,""),t=t.trim(),t?t.length>60?t.substring(0,60)+"...":t:""}appendErrorBubble(e){this.exitStreamingMode();const t=document.createElement("div");t.className="llm-ui-session llm-ui-session--system";const s=e.message.includes("apiKey")||e.message.includes("401");let n="";s&&(n=`
                <button class="llm-ui-error-btn" data-action="open-settings"> </button>
            `),n+=`
            <button class="llm-ui-error-btn" data-action="retry-last"> </button>
        `,t.innerHTML=`
            <div class="llm-ui-bubble llm-ui-bubble--error">
                <strong> </strong>
                <div class="llm-ui-bubble--error__content">
                    ${S(e.message)}
                </div>
                <div class="llm-ui-bubble--error__actions">
                    ${n}
                </div>
            </div>
        `,this.container.appendChild(t),this.scrollToBottom(!0);const i=t.querySelector('[data-action="open-settings"]');i&&i.addEventListener("click",()=>{this.container.dispatchEvent(new CustomEvent("open-connection-settings",{bubbles:!0}))});const a=t.querySelector('[data-action="retry-last"]');a&&a.addEventListener("click",()=>{t.remove();const o=this.findLastRetryableId();o&&this.onNodeAction?.("retry",o)})}findLastRetryableId(){const e=Array.from(this.container.querySelectorAll("[data-session-id]"));return e.length>0&&e[e.length-1].dataset.sessionId||null}processEvent(e){if(e.type!=="node_update"){this.processEventImmediate(e);return}this.eventQueue.push(e),this.eventProcessTimer===null&&(this.eventProcessTimer=window.setTimeout(()=>{this.flushEventQueue()},this.EVENT_BATCH_INTERVAL))}flushEventQueue(){if(this.eventProcessTimer=null,this.eventQueue.length===0)return;const e=new Map;for(const t of this.eventQueue){if(t.type!=="node_update")continue;const{nodeId:s,chunk:n,field:i}=t.payload;if(!n||!i)continue;e.has(s)||e.set(s,{thought:"",output:""});const a=e.get(s);i==="thought"?a.thought+=n:i==="output"&&(a.output+=n)}this.eventQueue=[];for(const[t,s]of e)s.thought&&this.updateNodeContent(t,s.thought,"thought"),s.output&&this.updateNodeContent(t,s.output,"output");this.userIsScrolledUp||this.scrollToBottom(!1)}processEventImmediate(e){switch(e.type){case"session_start":this.enterStreamingMode(),this.appendSessionGroup(e.payload,!1),this.scrollToBottom(!0);break;case"node_start":this.appendNode(e.payload.parentId,e.payload.node,!1);break;case"node_status":this.updateNodeStatus(e.payload.nodeId,e.payload.status,e.payload.result);break;case"finished":this.eventProcessTimer!==null&&(clearTimeout(this.eventProcessTimer),this.flushEventQueue()),this.exitStreamingMode(),this.editorMap.forEach(n=>n.finishStream()),this.onCollapseStateChange?.(this.collapseStates);break;case"error":this.eventProcessTimer!==null&&(clearTimeout(this.eventProcessTimer),this.flushEventQueue()),this.exitStreamingMode();const t=e.payload.message||"Unknown error",s=e.payload.code;s===401?this.appendErrorBubble(new Error(` ${t}`)):s===429?this.appendErrorBubble(new Error(` ${t}`)):this.appendErrorBubble(new Error(t)),this.editorMap.forEach(n=>n.finishStream(!1));break;case"messages_deleted":this.handleMessagesDeleted(e.payload.deletedIds);break;case"message_edited":this.handleMessageEdited(e.payload.sessionId,e.payload.newContent);break;case"session_cleared":this.renderWelcome();break;case"sibling_switch":this.handleSiblingSwitch(e.payload);break;case"retry_started":this.enterStreamingMode();break}}clear(){this.scrollFrameId!==null&&(cancelAnimationFrame(this.scrollFrameId),this.scrollFrameId=null),this.previewUpdateTimers.forEach(e=>clearTimeout(e)),this.previewUpdateTimers.clear(),this.editorMap.forEach(e=>e.destroy()),this.editorMap.clear(),this.nodeMap.clear(),this.originalContentMap.clear(),this.editingNodes.clear(),this.renderedSessionIds.clear(),this.isStreamingMode=!1,this.shouldAutoScroll=!0,this.userIsScrolledUp=!1,this.lastScrollHeight=0,this.container.classList.remove("llm-ui-history--streaming"),this.container.innerHTML=""}destroy(){this.eventProcessTimer!==null&&(clearTimeout(this.eventProcessTimer),this.eventProcessTimer=null),this.scrollThrottleTimer!==null&&(clearTimeout(this.scrollThrottleTimer),this.scrollThrottleTimer=null),this.scrollFrameId!==null&&(cancelAnimationFrame(this.scrollFrameId),this.scrollFrameId=null),this.resizeObserver.disconnect(),this.previewUpdateTimers.forEach(e=>clearTimeout(e)),this.previewUpdateTimers.clear(),this.editorMap.forEach(e=>e.destroy()),this.editorMap.clear(),this.nodeMap.clear(),this.originalContentMap.clear(),this.editingNodes.clear(),this.eventQueue=[],this.collapseStates={},this.renderedSessionIds.clear(),this.isStreamingMode=!1,this.shouldAutoScroll=!0,this.userIsScrolledUp=!1,this.lastScrollHeight=0,this.container.classList.remove("llm-ui-history--streaming"),this.hideNewContentIndicator(),this.container.innerHTML=""}}class za{constructor(e,t){this.container=e,this.options=t,t.initialSettings&&(this.currentSettings={...this.currentSettings,...t.initialSettings}),t.initialModels&&(this.models=t.initialModels),this.render(),this.bindEvents(),this.options.initialAgents&&this.options.initialAgents.length>0?this.updateExecutors(this.options.initialAgents):this.updateExecutors([{id:"default",name:"Assistant",category:"System"}]),this.applyCurrentSettingsToUI()}textarea;sendBtn;stopBtn;attachBtn;settingsBtn;executorSelect;modelSelect;historySlider;historyValue;settingsPanel;fileInput;attachmentContainer;inputWrapper;loading=!1;files=[];settingsExpanded=!1;models=[];currentSettings={modelId:void 0,historyLength:-1,temperature:void 0};applyCurrentSettingsToUI(){this.currentSettings.modelId&&this.modelSelect&&(this.modelSelect.value=this.currentSettings.modelId),this.historySlider&&(this.historySlider.value=this.currentSettings.historyLength.toString(),this.updateHistoryDisplay(),this.updatePresetButtons()),this.updateActiveBadges()}render(){this.container.innerHTML=`
            <div class="llm-input">
                <!--   -->
                <div class="llm-input__settings-panel" style="display: none;">
                    <div class="llm-input__settings-header">
                        <span class="llm-input__settings-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            Chat Settings
                        </span>
                        <button class="llm-input__settings-close" title="Close settings">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="llm-input__settings-body">
                        <!-- Model Override -->
                        <div class="llm-input__setting-row">
                            <label class="llm-input__setting-label">
                                <span class="llm-input__setting-icon"></span>
                                Model Override
                            </label>
                            <select class="llm-input__model-select" title="Override model for this chat">
                                <option value="">Use Agent Default</option>
                            </select>
                            <span class="llm-input__setting-hint">Temporarily use a different model</span>
                        </div>

                        <!-- History Length -->
                        <div class="llm-input__setting-row">
                            <label class="llm-input__setting-label">
                                <span class="llm-input__setting-icon"></span>
                                History Context
                                <span class="llm-input__history-value">Unlimited</span>
                            </label>
                            <div class="llm-input__slider-wrapper">
                                <input type="range" 
                                       class="llm-input__history-slider" 
                                       min="-1" 
                                       max="50" 
                                       value="-1"
                                       title="Number of messages to include">
                                <div class="llm-input__slider-labels">
                                    <span>None</span>
                                    <span>Unlimited</span>
                                </div>
                            </div>
                            <span class="llm-input__setting-hint">How many previous messages to send</span>
                        </div>

                        <!-- Quick Presets -->
                        <div class="llm-input__setting-row llm-input__presets">
                            <span class="llm-input__setting-label">Quick presets:</span>
                            <div class="llm-input__preset-buttons">
                                <button class="llm-input__preset-btn" data-history="0" title="No history context">
                                    Fresh Start
                                </button>
                                <button class="llm-input__preset-btn" data-history="5" title="Last 5 messages">
                                    Short (5)
                                </button>
                                <button class="llm-input__preset-btn" data-history="20" title="Last 20 messages">
                                    Medium (20)
                                </button>
                                <button class="llm-input__preset-btn active" data-history="-1" title="All messages">
                                    Full
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!--  -->
                <div class="llm-input__main">
                    <!--  -->
                    <div class="llm-input__executor-wrapper">
                        <select class="llm-input__executor-select" title="Select Agent/Executor">
                            <option value="default"> Assistant</option>
                        </select>
                    </div>

                    <!--  +  -->
                    <div class="llm-input__field-wrapper">
                        <div class="llm-input__attachments" style="display:none"></div>
                        
                        <!--   -->
                        <div class="llm-input__active-settings" style="display:none">
                            <span class="llm-input__active-badge" data-type="model" style="display:none">
                                 <span class="llm-input__badge-text"></span>
                                <button class="llm-input__badge-clear" data-clear="model"></button>
                            </span>
                            <span class="llm-input__active-badge" data-type="history" style="display:none">
                                 <span class="llm-input__badge-text"></span>
                                <button class="llm-input__badge-clear" data-clear="history"></button>
                            </span>
                        </div>
                        
                        <textarea 
                            class="llm-input__textarea" 
                            placeholder="Message... (Paste images or Drag & Drop)" 
                            rows="1"
                        ></textarea>
                    </div>

                    <!--  -->
                    <div class="llm-input__actions">
                        <!--   -->
                        <button class="llm-input__btn llm-input__btn--settings" title="Chat Settings">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="4" y1="21" x2="4" y2="14"></line>
                                <line x1="4" y1="10" x2="4" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="3"></line>
                                <line x1="20" y1="21" x2="20" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="3"></line>
                                <line x1="1" y1="14" x2="7" y2="14"></line>
                                <line x1="9" y1="8" x2="15" y2="8"></line>
                                <line x1="17" y1="16" x2="23" y2="16"></line>
                            </svg>
                        </button>
                        
                        <button class="llm-input__btn llm-input__btn--attach" title="Attach File">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                        
                        <button class="llm-input__btn llm-input__btn--send" title="Send">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                        
                        <button class="llm-input__btn llm-input__btn--stop" title="Stop Generation" style="display:none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                        </button>
                    </div>
                </div>

                <input type="file" multiple style="display:none;" id="llm-ui-hidden-file-input">
            </div>
        `,this.textarea=this.container.querySelector(".llm-input__textarea"),this.sendBtn=this.container.querySelector(".llm-input__btn--send"),this.stopBtn=this.container.querySelector(".llm-input__btn--stop"),this.attachBtn=this.container.querySelector(".llm-input__btn--attach"),this.settingsBtn=this.container.querySelector(".llm-input__btn--settings"),this.executorSelect=this.container.querySelector(".llm-input__executor-select"),this.modelSelect=this.container.querySelector(".llm-input__model-select"),this.historySlider=this.container.querySelector(".llm-input__history-slider"),this.historyValue=this.container.querySelector(".llm-input__history-value"),this.settingsPanel=this.container.querySelector(".llm-input__settings-panel"),this.fileInput=this.container.querySelector("#llm-ui-hidden-file-input"),this.attachmentContainer=this.container.querySelector(".llm-input__attachments"),this.inputWrapper=this.container.querySelector(".llm-input__field-wrapper"),this.updateModelOptions(),this.updateHistoryDisplay()}bindEvents(){const e=()=>{this.textarea.style.height="auto";const t=Math.min(this.textarea.scrollHeight,200);this.textarea.style.height=`${t}px`};this.textarea.addEventListener("input",()=>{e(),this.options.onInputChange?.()}),this.textarea.addEventListener("change",e),this.textarea.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.triggerSend())}),this.textarea.addEventListener("paste",t=>this.handlePaste(t)),this.bindDragEvents(),this.sendBtn.addEventListener("click",()=>this.triggerSend()),this.stopBtn.addEventListener("click",()=>this.options.onStop()),this.attachBtn.addEventListener("click",()=>this.fileInput.click()),this.settingsBtn.addEventListener("click",()=>this.toggleSettings()),this.container.querySelector(".llm-input__settings-close")?.addEventListener("click",()=>{this.toggleSettings(!1)}),this.fileInput.addEventListener("change",()=>{this.fileInput.files&&(this.addFiles(Array.from(this.fileInput.files)),this.fileInput.value="")}),this.executorSelect.addEventListener("change",()=>{this.options.onExecutorChange?.(this.executorSelect.value)}),this.modelSelect.addEventListener("change",()=>{this.currentSettings.modelId=this.modelSelect.value||void 0,this.updateActiveBadges(),this.notifySettingsChange()}),this.historySlider.addEventListener("input",()=>{const t=parseInt(this.historySlider.value);this.currentSettings.historyLength=t,this.updateHistoryDisplay(),this.updatePresetButtons(),this.updateActiveBadges()}),this.historySlider.addEventListener("change",()=>{this.notifySettingsChange()}),this.container.querySelectorAll(".llm-input__preset-btn").forEach(t=>{t.addEventListener("click",s=>{const n=parseInt(s.currentTarget.dataset.history||"-1");this.historySlider.value=n.toString(),this.currentSettings.historyLength=n,this.updateHistoryDisplay(),this.updatePresetButtons(),this.updateActiveBadges(),this.notifySettingsChange()})}),this.container.querySelectorAll(".llm-input__badge-clear").forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation();const n=s.currentTarget.dataset.clear;n==="model"?(this.modelSelect.value="",this.currentSettings.modelId=void 0):n==="history"&&(this.historySlider.value="-1",this.currentSettings.historyLength=-1,this.updateHistoryDisplay(),this.updatePresetButtons()),this.updateActiveBadges(),this.notifySettingsChange()})}),document.addEventListener("click",t=>{if(this.settingsExpanded){const s=t.target,n=this.settingsPanel.contains(s),i=this.settingsBtn.contains(s);!n&&!i&&this.toggleSettings(!1)}})}toggleSettings(e){this.settingsExpanded=e??!this.settingsExpanded,this.settingsPanel.style.display=this.settingsExpanded?"block":"none",this.settingsBtn.classList.toggle("active",this.settingsExpanded),this.settingsExpanded&&(this.settingsPanel.classList.add("llm-input__settings-panel--entering"),requestAnimationFrame(()=>{this.settingsPanel.classList.remove("llm-input__settings-panel--entering")}))}updateHistoryDisplay(){const e=parseInt(this.historySlider.value);e===-1?this.historyValue.textContent="Unlimited":e===0?this.historyValue.textContent="None":this.historyValue.textContent=`${e} messages`}updatePresetButtons(){const e=parseInt(this.historySlider.value);this.container.querySelectorAll(".llm-input__preset-btn").forEach(t=>{const s=parseInt(t.dataset.history||"-1");t.classList.toggle("active",s===e)})}updateActiveBadges(){const e=this.container.querySelector(".llm-input__active-settings"),t=this.container.querySelector('.llm-input__active-badge[data-type="model"]'),s=this.container.querySelector('.llm-input__active-badge[data-type="history"]');let n=!1;if(this.currentSettings.modelId){const i=this.models.find(o=>o.id===this.currentSettings.modelId),a=t.querySelector(".llm-input__badge-text");a&&(a.textContent=i?.name||this.currentSettings.modelId),t.style.display="inline-flex",n=!0}else t.style.display="none";if(this.currentSettings.historyLength!==-1){const i=s.querySelector(".llm-input__badge-text");i&&(i.textContent=this.currentSettings.historyLength===0?"No history":`${this.currentSettings.historyLength} msgs`),s.style.display="inline-flex",n=!0}else s.style.display="none";e.style.display=n?"flex":"none",this.settingsBtn.classList.toggle("has-overrides",n)}notifySettingsChange(){this.options.onSettingsChange?.(this.currentSettings),this.options.onInputChange?.()}updateModels(e){const t=this.currentSettings.modelId;this.models=e,this.updateModelOptions(),t&&(e.some(n=>n.id===t)?this.modelSelect.value=t:(this.currentSettings.modelId=void 0,this.updateActiveBadges()))}updateModelOptions(){const e={},t=[];this.models.forEach(n=>{n.provider?(e[n.provider]||(e[n.provider]=[]),e[n.provider].push(n)):t.push(n)});let s='<option value="">Use Agent Default</option>';t.forEach(n=>{s+=`<option value="${n.id}">${n.name}</option>`}),Object.entries(e).forEach(([n,i])=>{s+=`<optgroup label="${n}">`,i.forEach(a=>{s+=`<option value="${a.id}">${a.name}</option>`}),s+="</optgroup>"}),this.modelSelect.innerHTML=s,this.currentSettings.modelId&&(this.modelSelect.value=this.currentSettings.modelId)}handlePaste(e){if(this.loading)return;const t=e.clipboardData?.items;if(!t)return;const s=[];for(let n=0;n<t.length;n++){const i=t[n];if(i.kind==="file"){const a=i.getAsFile();if(a){const o=this.renameFileIfNeeded(a);s.push(o)}}}s.length>0&&this.addFiles(s)}bindDragEvents(){const e=this.inputWrapper;e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),this.loading||e.classList.add("llm-input__field-wrapper--drag-active")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("llm-input__field-wrapper--drag-active")}),e.addEventListener("drop",t=>{if(t.preventDefault(),t.stopPropagation(),e.classList.remove("llm-input__field-wrapper--drag-active"),this.loading)return;const s=t.dataTransfer?.files;s&&s.length>0&&this.addFiles(Array.from(s))})}renameFileIfNeeded(e){if(e.name==="image.png"||e.name==="image.jpg"){const s=`paste_${new Date().toISOString().replace(/[:.]/g,"-")}.${e.name.split(".").pop()}`;return new File([e],s,{type:e.type})}return e}updateExecutors(e,t){const s={},n=[];e.forEach(a=>{a.category?(s[a.category]||(s[a.category]=[]),s[a.category].push(a)):n.push(a)});let i="";n.length>0&&(i+=n.map(a=>this.renderOption(a)).join("")),Object.entries(s).forEach(([a,o])=>{i+=`<optgroup label="${a}">`,i+=o.map(r=>this.renderOption(r)).join(""),i+="</optgroup>"}),this.executorSelect.innerHTML=i,t&&this.setExecutor(t)}renderOption(e){const t=e.icon?`${e.icon} `:"";return`<option value="${e.id}">${t}${e.name}</option>`}addFiles(e){this.files=[...this.files,...e],this.renderAttachments()}removeFile(e){this.files.splice(e,1),this.renderAttachments()}renderAttachments(){if(this.files.length===0){this.attachmentContainer.style.display="none";return}this.attachmentContainer.style.display="flex",this.attachmentContainer.innerHTML=this.files.map((e,t)=>`
            <div class="llm-input__attachment-tag">
                <span class="llm-input__file-icon">
                   ${e.type.startsWith("image/")?"":""}
                </span>
                <span class="llm-input__filename">${e.name}</span>
                <span class="llm-input__filesize">(${this.formatSize(e.size)})</span>
                <span class="llm-input__remove-btn" data-index="${t}" title="Remove"></span>
            </div>
        `).join(""),this.attachmentContainer.querySelectorAll(".llm-input__remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const s=parseInt(t.target.dataset.index);this.removeFile(s)})})}formatSize(e){if(e===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(1))+" "+s[n]}async triggerSend(){const e=this.textarea.value.trim();if(!e&&this.files.length===0||this.loading)return;const t=this.executorSelect.value,s=[...this.files],n={};this.currentSettings.modelId&&(n.modelId=this.currentSettings.modelId),this.currentSettings.historyLength!==-1&&(n.historyLength=this.currentSettings.historyLength),this.textarea.value="",this.textarea.style.height="auto",this.files=[],this.renderAttachments(),await this.options.onSend(e,s,t,n)}setLoading(e){this.loading=e,this.sendBtn.style.display=e?"none":"flex",this.stopBtn.style.display=e?"flex":"none",this.textarea.disabled=e,this.executorSelect.disabled=e,this.attachBtn.disabled=e,this.settingsBtn.disabled=e,e?(this.inputWrapper.classList.add("llm-input__field-wrapper--disabled"),this.toggleSettings(!1)):this.inputWrapper.classList.remove("llm-input__field-wrapper--disabled")}focus(){this.textarea?.focus()}destroy(){this.container.innerHTML="",this.files=[]}getSelectedExecutor(){return this.executorSelect?.value||"default"}setInput(e){this.textarea&&(this.textarea.value=e,this.textarea.dispatchEvent(new Event("input")))}setExecutor(e){if(!this.executorSelect)return;this.executorSelect.querySelector(`option[value="${e}"]`)?this.executorSelect.value=e:(console.warn(`[ChatInput] Agent ${e} not found, falling back to default.`),this.executorSelect.value="default")}getState(){return{text:this.textarea?.value||"",agentId:this.getSelectedExecutor(),settings:{...this.currentSettings}}}setState(e){e.text!==void 0&&this.textarea&&(this.textarea.value=e.text,this.textarea.dispatchEvent(new Event("input",{bubbles:!1}))),e.agentId&&this.setExecutor(e.agentId),e.settings&&this.setSettings(e.settings)}getSettings(){return{...this.currentSettings}}setSettings(e){this.currentSettings={...this.currentSettings,...e},e.modelId!==void 0&&this.modelSelect&&(Array.from(this.modelSelect.options).some(s=>s.value===e.modelId)||e.modelId===""?this.modelSelect.value=e.modelId||"":(console.warn(`[ChatInput] Model ${e.modelId} not found in options, keeping empty`),this.currentSettings.modelId=void 0,this.modelSelect.value="")),e.historyLength!==void 0&&this.historySlider&&(this.historySlider.value=e.historyLength.toString(),this.updateHistoryDisplay(),this.updatePresetButtons()),this.updateActiveBadges()}resetSettings(){this.currentSettings={modelId:void 0,historyLength:-1,temperature:void 0},this.modelSelect.value="",this.historySlider.value="-1",this.updateHistoryDisplay(),this.updatePresetButtons(),this.updateActiveBadges(),this.notifySettingsChange()}}var P=(l=>(l.NETWORK_ERROR="NETWORK_ERROR",l.TIMEOUT="TIMEOUT",l.SESSION_NOT_FOUND="SESSION_NOT_FOUND",l.SESSION_BUSY="SESSION_BUSY",l.SESSION_INVALID="SESSION_INVALID",l.EXECUTION_FAILED="EXECUTION_FAILED",l.EXECUTOR_NOT_FOUND="EXECUTOR_NOT_FOUND",l.QUOTA_EXCEEDED="QUOTA_EXCEEDED",l.CONTEXT_LIMIT="CONTEXT_LIMIT",l.ABORTED="ABORTED",l.UNKNOWN="UNKNOWN",l))(P||{});class C extends Error{constructor(e,t,s=!1,n){super(t),this.code=e,this.retryable=s,this.originalError=n,this.name="EngineError"}static from(e){if(e instanceof C)return e;const t=e?.message||"Unknown error";return e?.name==="AbortError"||t.includes("abort")?new C("ABORTED","Operation aborted",!1,e):t.includes("timeout")||e?.name==="TimeoutError"?new C("TIMEOUT","Request timed out",!0,e):t.includes("429")||t.includes("rate limit")||t.includes("quota")?new C("QUOTA_EXCEEDED","Rate limit exceeded",!0,e):t.includes("context")||t.includes("token limit")?new C("CONTEXT_LIMIT","Context limit exceeded",!1,e):t.includes("network")||t.includes("fetch")||e?.name==="TypeError"?new C("NETWORK_ERROR","Network error",!0,e):new C("UNKNOWN",t,!0,e)}get canRetry(){return this.retryable}}const ve={MAX_CONCURRENT:3,MAX_QUEUE_SIZE:10,SESSION_IDLE_TIMEOUT:30*60*1e3,RECOVERY_MAX_AGE:60*60*1e3,PERSIST_THROTTLE:500,CLEANUP_INTERVAL:5*60*1e3};class qa{constructor(e,t){this.nodeId=e,this.sessionId=t}sessions=[];getSessions(){return[...this.sessions]}getHistory(){return this.sessions.filter(e=>e.role==="user"||e.role==="assistant"&&e.executionRoot?.data.output).map(e=>({role:e.role,content:e.role==="user"?e.content||"":e.executionRoot?.data.output||""}))}findSessionById(e){return this.sessions.find(t=>t.id===e||t.persistedNodeId===e||t.executionRoot?.id===e)}findSessionIndex(e){return this.sessions.findIndex(t=>t.id===e||t.persistedNodeId===e||t.executionRoot?.id===e)}findUserMessageBefore(e){const t=this.findSessionIndex(e);if(!(t<=0)){for(let s=t-1;s>=0;s--)if(this.sessions[s].role==="user")return this.sessions[s]}}getLastSession(){return this.sessions[this.sessions.length-1]}addSession(e){this.sessions.push(e)}addUserMessage(e,t,s){const n={id:F(),timestamp:Date.now(),role:"user",content:e,files:t.map(i=>({name:i.name,type:i.type,path:i.path,size:i.size})),persistedNodeId:s};return this.sessions.push(n),n}createAssistantMessage(e,t,s){const n={id:F(),executorId:e.id,executorType:e.type||"agent",name:e.name||e.id,status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:{agentId:e.id,agentName:e.name,siblingIndex:s?.siblingIndex??0,siblingCount:s?.siblingCount??1}},children:[]},i={id:F(),timestamp:Date.now(),role:"assistant",executionRoot:n,persistedNodeId:t,siblingIndex:s?.siblingIndex,siblingCount:s?.siblingCount};return this.sessions.push(i),n}updateNodeOutput(e,t){for(const s of this.sessions){if(s.executionRoot?.id===e){s.executionRoot.data.output=t,s.executionRoot.status="success",s.executionRoot.endTime=Date.now();return}if(s.executionRoot&&this.findAndUpdateNode(s.executionRoot,e,t))return}}findAndUpdateNode(e,t,s){if(e.id===t)return e.data.output=s,e.status="success",e.endTime=Date.now(),!0;if(e.children){for(const n of e.children)if(this.findAndUpdateNode(n,t,s))return!0}return!1}updateNodeThinking(e,t){for(const s of this.sessions)if(s.executionRoot?.id===e){s.executionRoot.data.thought=t;return}}appendToNode(e,t,s){for(const n of this.sessions){const i=this.findNodeInTree(n.executionRoot,e);if(i){s==="output"?i.data.output=(i.data.output||"")+t:i.data.thought=(i.data.thought||"")+t;return}}}findNodeInTree(e,t){if(!e)return null;if(e.id===t)return e;if(e.children)for(const s of e.children){const n=this.findNodeInTree(s,t);if(n)return n}return null}updateNodeStatus(e,t){for(const s of this.sessions){const n=this.findNodeInTree(s.executionRoot,e);if(n){n.status=t,(t==="success"||t==="failed")&&(n.endTime=Date.now());return}}}updateMessageContent(e,t){const s=this.findSessionById(e);s&&(s.role==="user"?s.content=t:s.executionRoot&&(s.executionRoot.data.output=t))}updateNodeError(e,t){for(const s of this.sessions){const n=this.findNodeInTree(s.executionRoot,e);if(n){n.data.error=t;return}}}removeMessage(e){const t=this.findSessionIndex(e);t!==-1&&this.sessions.splice(t,1)}removeMessagesAfter(e){const t=this.findSessionIndex(e);t!==-1&&(this.sessions=this.sessions.slice(0,t+1))}loadFromChatNode(e){e.role==="user"?this.sessions.push({id:F(),timestamp:new Date(e.created_at).getTime(),role:"user",content:e.content,files:e.meta?.files||[],persistedNodeId:e.id}):e.role==="assistant"&&this.sessions.push({id:F(),timestamp:new Date(e.created_at).getTime(),role:"assistant",executionRoot:{id:F(),executorId:e.meta?.agentId||"unknown",executorType:"agent",name:e.meta?.agentName||"Assistant",status:"success",startTime:new Date(e.created_at).getTime(),endTime:new Date(e.created_at).getTime(),data:{output:e.content,thought:e.meta?.thinking||"",metaInfo:e.meta||{}},children:[]},persistedNodeId:e.id})}exportToMarkdown(){let e=`# Chat Export

`;e+=`> Exported at: ${new Date().toLocaleString()}

---

`;for(const t of this.sessions){const s=t.role==="user"?" User":" Assistant",n=new Date(t.timestamp).toLocaleTimeString();if(e+=`### ${s} (${n})

`,t.role==="user"){if(t.files&&t.files.length>0){const i=t.files.map(a=>`\`${a.name}\``).join(", ");e+=`> Attachments: ${i}

`}e+=`${t.content||"(Empty)"}

`}else t.executionRoot&&(t.executionRoot.data.thought&&(e+=`> **Thinking:**
`,e+=t.executionRoot.data.thought.split(`
`).map(i=>`> ${i}`).join(`
`),e+=`

`),e+=`${t.executionRoot.data.output||"(No output)"}

`);e+=`---

`}return e}clear(){this.sessions=[]}}class Va{handlers=new Map;scopes=new Map;emit(e){const t=this.handlers.get(e.type)||new Set,s=this.handlers.get("*")||new Set,n=[...t,...s].sort((i,a)=>(a.options.priority||0)-(i.options.priority||0));for(const{handler:i,options:a}of n)if(!(a.filter&&!a.filter(e))){try{i(e)}catch(o){console.error(`[EventBus] Handler error for ${e.type}:`,o)}a.once&&this.off(e.type,i)}}on(e,t,s={}){this.handlers.has(e)||this.handlers.set(e,new Set);const n={handler:t,options:s};return this.handlers.get(e).add(n),()=>{this.handlers.get(e)?.delete(n)}}once(e,t){return this.on(e,t,{once:!0})}off(e,t){const s=this.handlers.get(e);if(s){for(const n of s)if(n.handler===t){s.delete(n);break}}}createScope(e){if(this.scopes.has(e))return this.scopes.get(e);const t=new ja(e,this);return this.scopes.set(e,t),t}destroyScope(e){this.scopes.delete(e)}}class ja{constructor(e,t){this.executionId=e,this.parent=t}emit(e,t,s){this.parent.emit({type:e,executionId:this.executionId,nodeId:s,timestamp:Date.now(),payload:t})}on(e,t){return this.parent.on(e,t,{filter:s=>s.executionId===this.executionId})}}let Ge=null;function ft(){return Ge||(Ge=new Va),Ge}class Ga{data=new Map;parent;constructor(e){this.parent=e}get(e){return this.data.has(e)?this.data.get(e):this.parent?.get(e)}set(e,t){this.data.set(e,t)}has(e){return this.data.has(e)||(this.parent?.has(e)??!1)}toObject(){const e=this.parent?.toObject()||{},t=Object.fromEntries(this.data);return{...e,...t}}}class yt{constructor(e,t,s,n=0,i,a){this.executionId=e,this.events=t,this.parentId=s,this.depth=n,this.variables=new Ga(i),this.abortController=a||new AbortController}variables;results=new Map;abortController;currentNodeId;get signal(){return this.abortController.signal}createChild(e){return new yt(this.executionId,this.events,e,this.depth+1,this.variables,this.abortController)}setCurrentNode(e){this.currentNodeId=e}emitThinking(e){this.events.emit("stream:thinking",{delta:e},this.currentNodeId)}emitContent(e){this.events.emit("stream:content",{delta:e},this.currentNodeId)}emitNodeStatus(e){this.events.emit("node:update",{status:e},this.currentNodeId)}emitError(e){this.events.emit("execution:error",{code:e.code||"UNKNOWN",message:e.message,stack:e.stack},this.currentNodeId)}checkCancelled(){if(this.signal.aborted)throw new Wa("Execution cancelled")}}class Wa extends Error{constructor(e){super(e),this.name="CancellationError"}}class G extends Error{code;provider;statusCode;cause;retryable;retryAfter;constructor(e,t){super(e),this.name="LLMError",this.code=t.code,this.provider=t.provider,this.statusCode=t.statusCode,this.cause=t.cause,this.retryable=t.retryable,this.retryAfter=t.retryAfter}static fromResponse(e,t,s){const{code:n,message:i,retryable:a,retryAfter:o}=this.parseErrorResponse(t,s);return new G(i,{code:n,provider:e,statusCode:t,cause:s,retryable:a,retryAfter:o})}static fromException(e,t){return t.name==="AbortError"?new G("Request aborted",{code:"ABORTED",provider:e,cause:t,retryable:!1}):t.name==="TimeoutError"||t.message?.includes("timeout")?new G("Request timed out",{code:"TIMEOUT",provider:e,cause:t,retryable:!0}):t.name==="TypeError"&&t.message?.includes("fetch")?new G("Network error",{code:"NETWORK_ERROR",provider:e,cause:t,retryable:!0}):new G(t.message||"Unknown error",{code:"UNKNOWN",provider:e,cause:t,retryable:!0})}static parseErrorResponse(e,t){const s=t?.error?.message||t?.message||`HTTP ${e}`;switch(e){case 400:return{code:"INVALID_REQUEST",message:s,retryable:!1};case 401:return{code:"INVALID_API_KEY",message:"Invalid API key",retryable:!1};case 403:return{code:"UNAUTHORIZED",message:s,retryable:!1};case 404:return{code:"MODEL_NOT_FOUND",message:s,retryable:!1};case 429:return{code:"RATE_LIMIT",message:"Rate limit exceeded",retryable:!0,retryAfter:this.parseRetryAfter(t)};case 500:case 502:case 503:case 504:return{code:"SERVER_ERROR",message:s,retryable:!0};default:return{code:"UNKNOWN",message:s,retryable:e>=500}}}static parseRetryAfter(e){const t=e?.error?.retry_after||e?.retry_after;if(typeof t=="number")return t*1e3}}class vt{config;baseURL;defaultModel;constructor(e){this.config=e,this.baseURL=this.resolveBaseURL(e),this.defaultModel=e.model||""}resolveBaseURL(e){return e.apiBaseUrl?e.apiBaseUrl.replace(/\/+$/,""):""}buildHeaders(){return{"Content-Type":"application/json",...this.config.headers}}getModel(e){return e.model||this.defaultModel}async fetchJSON(e,t){const s=await fetch(e,t);if(!s.ok){let n;try{n=await s.json()}catch{n=await s.text()}throw G.fromResponse(this.name,s.status,n)}return s.json()}async fetchStream(e,t){const s=await fetch(e,t);if(!s.ok){let n;try{n=await s.json()}catch{n=await s.text()}throw G.fromResponse(this.name,s.status,n)}if(!s.body)throw new Error("Response body is null");return s.body}}async function*bt(l){const e=l.getReader(),t=new TextDecoder;let s="";try{for(;;){const{done:n,value:i}=await e.read();if(n)break;s+=t.decode(i,{stream:!0});const a=s.split(`
`);s=a.pop()||"";for(const o of a){const r=o.trim();if(!(!r||r.startsWith(":"))&&r.startsWith("data:")){const c=r.slice(5).trim();if(c==="[DONE]"){yield"[DONE]";continue}yield c}}}if(s.trim()){const n=s.trim();if(n.startsWith("data:")){const i=n.slice(5).trim();i&&i!=="[DONE]"&&(yield i)}}}finally{e.releaseLock()}}class X extends vt{name="openai";constructor(e){super(e),this.baseURL||(this.baseURL="https://api.openai.com/v1")}async create(e){const t=this.baseURL.endsWith("/chat/completions")?this.baseURL:`${this.baseURL}/chat/completions`,s=this.buildRequestBody(e),n=await this.fetchJSON(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});return this.normalizeResponse(n)}async*stream(e){const t=this.baseURL.endsWith("/chat/completions")?this.baseURL:`${this.baseURL}/chat/completions`,s=this.buildRequestBody({...e,stream:!0}),n=await this.fetchStream(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});for await(const i of bt(n)){if(i==="[DONE]")break;try{const a=JSON.parse(i);yield this.normalizeChunk(a)}catch{}}}buildHeaders(){const e=super.buildHeaders();return e.Authorization=`Bearer ${this.config.apiKey}`,this.config.requiresReferer&&(e["HTTP-Referer"]="https://itookit.com",e["X-Title"]="iTookit"),this.config.metadata?.organizationId&&(e["OpenAI-Organization"]=this.config.metadata.organizationId),e}buildRequestBody(e){const t={model:this.getModel(e),messages:this.convertMessages(e.messages),stream:e.stream||!1};return e.temperature!==void 0&&(t.temperature=e.temperature),e.maxTokens!==void 0&&(t.max_tokens=e.maxTokens),e.topP!==void 0&&(t.top_p=e.topP),e.stop!==void 0&&(t.stop=e.stop),e.frequencyPenalty!==void 0&&(t.frequency_penalty=e.frequencyPenalty),e.presencePenalty!==void 0&&(t.presence_penalty=e.presencePenalty),e.seed!==void 0&&(t.seed=e.seed),e.user!==void 0&&(t.user=e.user),e.responseFormat&&(t.response_format=e.responseFormat),e.tools&&e.tools.length>0&&(t.tools=e.tools,e.toolChoice&&(t.tool_choice=e.toolChoice)),e.thinking&&e.reasoningEffort&&(t.reasoning_effort=e.reasoningEffort),e.stream&&(t.stream_options={include_usage:!0}),t}convertMessages(e){return e.map(t=>{const s={role:t.role,content:t.content};return t.name&&(s.name=t.name),t.tool_call_id&&(s.tool_call_id=t.tool_call_id),s})}normalizeResponse(e){const t=e.choices?.[0],s=t?.message||{};let n;return s.reasoning_content&&(n=s.reasoning_content),{id:e.id,object:e.object,created:e.created,model:e.model,choices:[{index:t?.index||0,message:{role:"assistant",content:s.content||"",thinking:n,tool_calls:s.tool_calls},finish_reason:t?.finish_reason||"stop"}],usage:e.usage?{prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens}:void 0}}normalizeChunk(e){const t=e.choices?.[0],s=t?.delta||{};let n;return s.reasoning_content&&(n=s.reasoning_content),{id:e.id,object:e.object,created:e.created,model:e.model,choices:[{index:t?.index||0,delta:{role:s.role,content:s.content,thinking:n,tool_calls:s.tool_calls},finish_reason:t?.finish_reason}],usage:e.usage}}}class ks extends vt{name="anthropic";API_VERSION="2023-06-01";constructor(e){super(e),this.baseURL||(this.baseURL="https://api.anthropic.com")}async create(e){const t=`${this.baseURL}/v1/messages`,s=this.buildRequestBody(e),n=await this.fetchJSON(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});return this.normalizeResponse(n)}async*stream(e){const t=`${this.baseURL}/v1/messages`,s=this.buildRequestBody({...e,stream:!0}),n=await this.fetchStream(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});let i="",a="";for await(const o of bt(n))try{const r=JSON.parse(o),c=this.normalizeStreamEvent(r,i,a);c&&(c.choices[0]?.delta.thinking&&(i+=c.choices[0].delta.thinking),c.choices[0]?.delta.content&&(a+=c.choices[0].delta.content),yield c)}catch{}}buildHeaders(){return{...super.buildHeaders(),"x-api-key":this.config.apiKey,"anthropic-version":this.API_VERSION}}buildRequestBody(e){const{systemMessage:t,userMessages:s}=this.separateMessages(e.messages),n={model:this.getModel(e),messages:s,max_tokens:e.maxTokens||4096};if(t&&(n.system=t),e.temperature!==void 0&&(n.temperature=e.temperature),e.topP!==void 0&&(n.top_p=e.topP),e.stop!==void 0&&(n.stop_sequences=Array.isArray(e.stop)?e.stop:[e.stop]),e.stream&&(n.stream=!0),e.thinking){const i=e.thinkingBudget||this.config.metadata?.thinkingBudget||1e4;n.thinking={type:"enabled",budget_tokens:i}}return e.tools&&e.tools.length>0&&(n.tools=e.tools.map(i=>({name:i.function.name,description:i.function.description,input_schema:i.function.parameters})),e.toolChoice==="required"?n.tool_choice={type:"any"}:e.toolChoice==="none"?n.tool_choice={type:"none"}:typeof e.toolChoice=="object"&&(n.tool_choice={type:"tool",name:e.toolChoice.function.name})),n}separateMessages(e){let t=null;const s=[];for(const n of e)if(n.role==="system"){const i=typeof n.content=="string"?n.content:n.content.map(a=>a.type==="text"?a.text:"").join(`
`);t=t?`${t}

${i}`:i}else s.push({role:n.role==="assistant"?"assistant":"user",content:this.convertContent(n.content)});return{systemMessage:t,userMessages:s}}convertContent(e){return typeof e=="string"?e:e.map(t=>{if(t.type==="text")return{type:"text",text:t.text};if(t.type==="image_url"){const s=t.image_url.url;if(s.startsWith("data:")){const[n,i]=s.split(",");return{type:"image",source:{type:"base64",media_type:n.match(/data:(.*?);/)?.[1]||"image/jpeg",data:i}}}return{type:"image",source:{type:"url",url:s}}}return{type:"text",text:""}})}normalizeResponse(e){let t="",s="";const n=[];for(const i of e.content||[])i.type==="text"?t+=i.text:i.type==="thinking"?s+=i.thinking:i.type==="tool_use"&&n.push({id:i.id,type:"function",function:{name:i.name,arguments:JSON.stringify(i.input)}});return{id:e.id,model:e.model,choices:[{index:0,message:{role:"assistant",content:t,thinking:s||void 0,tool_calls:n.length>0?n:void 0},finish_reason:this.mapStopReason(e.stop_reason)}],usage:e.usage?{prompt_tokens:e.usage.input_tokens,completion_tokens:e.usage.output_tokens,total_tokens:e.usage.input_tokens+e.usage.output_tokens}:void 0}}normalizeStreamEvent(e,t,s){switch(e.type){case"message_start":return{id:e.message?.id,model:e.message?.model,choices:[{index:0,delta:{role:"assistant"},finish_reason:null}]};case"content_block_delta":const i=e.delta;return i?.type==="thinking_delta"?{choices:[{index:0,delta:{thinking:i.thinking},finish_reason:null}]}:i?.type==="text_delta"?{choices:[{index:0,delta:{content:i.text},finish_reason:null}]}:i?.type==="input_json_delta"?{choices:[{index:0,delta:{tool_calls:[{index:e.index||0,function:{arguments:i.partial_json}}]},finish_reason:null}]}:null;case"message_delta":return{choices:[{index:0,delta:{},finish_reason:this.mapStopReason(e.delta?.stop_reason)}],usage:e.usage?{prompt_tokens:0,completion_tokens:e.usage.output_tokens,total_tokens:e.usage.output_tokens}:void 0};case"message_stop":return{choices:[{index:0,delta:{},finish_reason:"stop"}]};default:return null}}mapStopReason(e){switch(e){case"end_turn":return"stop";case"max_tokens":return"length";case"tool_use":return"tool_calls";default:return null}}}class As extends vt{name="gemini";constructor(e){super(e),this.baseURL||(this.baseURL="https://generativelanguage.googleapis.com/v1beta")}async create(e){const t=this.getModel(e),s=`${this.baseURL}/models/${t}:generateContent?key=${this.config.apiKey}`,n=this.buildRequestBody(e),i=await this.fetchJSON(s,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(n),signal:e.signal});return this.normalizeResponse(i,t)}async*stream(e){const t=this.getModel(e),s=`${this.baseURL}/models/${t}:streamGenerateContent?alt=sse&key=${this.config.apiKey}`,n=this.buildRequestBody(e),i=await this.fetchStream(s,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(n),signal:e.signal});for await(const a of bt(i))try{const o=JSON.parse(a),r=this.normalizeChunk(o,t);r&&(yield r)}catch{}}buildHeaders(){return{"Content-Type":"application/json"}}buildRequestBody(e){const{systemInstruction:t,contents:s}=this.convertMessages(e.messages),n={contents:s};t&&(n.systemInstruction={parts:[{text:t}]});const i={};return e.temperature!==void 0&&(i.temperature=e.temperature),e.maxTokens!==void 0&&(i.maxOutputTokens=e.maxTokens),e.topP!==void 0&&(i.topP=e.topP),e.stop!==void 0&&(i.stopSequences=Array.isArray(e.stop)?e.stop:[e.stop]),Object.keys(i).length>0&&(n.generationConfig=i),e.thinking&&(n.generationConfig=n.generationConfig||{},n.generationConfig.thinkingConfig={thinkingBudget:e.thinkingBudget||8e3}),e.tools&&e.tools.length>0&&(n.tools=[{functionDeclarations:e.tools.map(a=>({name:a.function.name,description:a.function.description,parameters:a.function.parameters}))}]),n}convertMessages(e){let t=null;const s=[];for(const n of e)if(n.role==="system"){const i=typeof n.content=="string"?n.content:n.content.map(a=>a.type==="text"?a.text:"").join(`
`);t=t?`${t}

${i}`:i}else s.push({role:n.role==="assistant"?"model":"user",parts:this.convertParts(n.content)});return{systemInstruction:t,contents:s}}convertParts(e){return typeof e=="string"?[{text:e}]:e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){const s=t.image_url.url;if(s.startsWith("data:")){const[n,i]=s.split(",");return{inlineData:{mimeType:n.match(/data:(.*?);/)?.[1]||"image/jpeg",data:i}}}return{fileData:{fileUri:s}}}return{text:""}})}normalizeResponse(e,t){const s=e.candidates?.[0],n=s?.content?.parts||[];let i="",a="";const o=[];for(const r of n)r.text&&(i+=r.text),r.thought&&(a+=r.thought),r.functionCall&&o.push({id:`call_${Date.now()}_${o.length}`,type:"function",function:{name:r.functionCall.name,arguments:JSON.stringify(r.functionCall.args)}});return{id:`gemini-${Date.now()}`,model:t,choices:[{index:0,message:{role:"assistant",content:i,thinking:a||void 0,tool_calls:o.length>0?o:void 0},finish_reason:this.mapFinishReason(s?.finishReason)}],usage:e.usageMetadata?{prompt_tokens:e.usageMetadata.promptTokenCount||0,completion_tokens:e.usageMetadata.candidatesTokenCount||0,total_tokens:e.usageMetadata.totalTokenCount||0,thinking_tokens:e.usageMetadata.thoughtsTokenCount}:void 0}}normalizeChunk(e,t){const s=e.candidates?.[0];if(!s)return null;const n=s.content?.parts||[];let i="",a="";const o=[];for(const r of n)r.text&&(i+=r.text),r.thought&&(a+=r.thought),r.functionCall&&o.push({index:o.length,id:`call_${Date.now()}_${o.length}`,type:"function",function:{name:r.functionCall.name,arguments:JSON.stringify(r.functionCall.args)}});return!i&&!a&&o.length===0?null:{id:`gemini-${Date.now()}`,model:t,choices:[{index:0,delta:{content:i||void 0,thinking:a||void 0,tool_calls:o.length>0?o:void 0},finish_reason:this.mapFinishReason(s.finishReason)}],usage:e.usageMetadata?{prompt_tokens:e.usageMetadata.promptTokenCount||0,completion_tokens:e.usageMetadata.candidatesTokenCount||0,total_tokens:e.usageMetadata.totalTokenCount||0}:void 0}}mapFinishReason(e){switch(e){case"STOP":return"stop";case"MAX_TOKENS":return"length";case"TOOL_CODE":return"tool_calls";default:return null}}}const We=10,Ke="default",Ka="",Qa=6e4,Ja=3,Ya=1e3,W={rdsec:{name:"RDSec",implementation:"openai-compatible",baseURL:"https://api.rdsec.trendmicro.com/prod/aiendpoint/v1/chat/completions",icon:"",supportsThinking:!0,models:[{id:"claude-4.5-opus",name:"Claude 4.5 Opus",icon:""},{id:"gemini-3-pro",name:"Gemini 3 Pro",icon:""},{id:"gpt-5.2",name:"GPT-5.2",icon:""},{id:"claude-4.5-sonnet",name:"Claude 4.5 Sonnet",icon:""},{id:"gemini-3-flash",name:"Gemini 3 Flash",icon:""},{id:"claude-4.5-haiku",name:"Claude 4.5 Haiku",icon:""},{id:"gpt-4o",name:"GPT-4o (OpenAI)",icon:""},{id:"claude-4-sonnet",name:"Claude 4 Sonnet",icon:""},{id:"claude-4.5-haiku",name:"Claude 4.5 Haiku",icon:""},{id:"deepseek-r1",name:"DeepSeek R1",icon:"",supportsThinking:!0},{id:"deepseek-r1-0528",name:"DeepSeek R1 0528",icon:"",supportsThinking:!0},{id:"deepseek-r1-aws",name:"DeepSeek R1 AWS",icon:"",supportsThinking:!0},{id:"deepseek-v3.1",name:"DeepSeek v3.1",icon:""},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",icon:""},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",icon:""},{id:"gemini-3-flash",name:"Gemini 3 Flash",icon:""},{id:"gpt-4",name:"GPT-4",icon:""},{id:"gpt-4-32k",name:"GPT-4 32k",icon:""},{id:"gpt-4.1",name:"GPT-4.1",icon:""},{id:"gpt-4.1-mini",name:"GPT-4.1 Mini",icon:""},{id:"gpt-4.1-nano",name:"GPT-4.1 Nano",icon:""},{id:"gpt-4o-mini",name:"GPT-4o Mini",icon:""},{id:"gpt-5",name:"GPT-5",icon:""},{id:"gpt-5-chat",name:"GPT-5 Chat",icon:""},{id:"gpt-5-codex",name:"GPT-5 Codex",icon:""},{id:"gpt-5-mini",name:"GPT-5 Mini",icon:""},{id:"gpt-5-nano",name:"GPT-5 Nano",icon:""},{id:"gpt-5.1",name:"GPT-5.1",icon:""}]},anthropic:{name:"Anthropic",implementation:"anthropic",baseURL:"https://api.anthropic.com/v1/messages",icon:"",supportsThinking:!0,models:[{id:"claude-sonnet-4-5-20250929",name:"Claude Sonnet 4.5",icon:""},{id:"claude-opus-4-1-20250805",name:"Claude Opus 4.1",icon:""},{id:"claude-opus-4-20250514",name:"Claude Opus 4",icon:""},{id:"claude-sonnet-4-20250514",name:"Claude Sonnet 4",icon:""},{id:"claude-3-7-sonnet-latest",name:"Claude Sonnet 3.7 (Latest)",icon:""},{id:"claude-3-7-sonnet-20250219",name:"Claude Sonnet 3.7",icon:""}]},gemini:{name:"Google Gemini",implementation:"gemini",baseURL:"https://generativelanguage.googleapis.com/v1beta/models",icon:"",supportsThinking:!0,models:[{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",icon:""},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",icon:""},{id:"gemini-pro",name:"Gemini Pro",icon:""}]},deepseek:{name:"DeepSeek",implementation:"openai-compatible",baseURL:"https://api.deepseek.com/v1/chat/completions",icon:"",supportsThinking:!0,models:[{id:"deepseek-chat",name:"DeepSeek Chat",icon:""},{id:"deepseek-reasoner",name:"DeepSeek Reasoner",icon:"",supportsThinking:!0}]},"deepseek-Speciale":{name:"DeepSeek-Speciale",implementation:"openai-compatible",baseURL:"https://api.deepseek.com/v3.2_speciale_expires_on_20251215/v1/chat/completions",icon:"",supportsThinking:!0,models:[{id:"deepseek-reasoner",name:"DeepSeek Reasoner",icon:"",supportsThinking:!0}]},openrouter:{name:"OpenRouter",implementation:"openai-compatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",icon:"",requiresReferer:!0,supportsThinking:!0,models:[{id:"openrouter/auto",name:"Auto (Best Model)",icon:""},{id:"openai/gpt-5-pro",name:"OpenAI: GPT-5 Pro",icon:""},{id:"openai/gpt-5-codex",name:"OpenAI: GPT-5 Codex",icon:""},{id:"openai/gpt-5-mini",name:"OpenAI: GPT-5 Mini",icon:""},{id:"anthropic/claude-sonnet-4.5",name:"Anthropic: Claude Sonnet 4.5",icon:""},{id:"anthropic/claude-opus-4.1",name:"Anthropic: Claude Opus 4.1",icon:""},{id:"google/gemini-2.5-pro",name:"Google: Gemini 2.5 Pro",icon:""},{id:"google/gemini-2.5-flash",name:"Google: Gemini 2.5 Flash",icon:""},{id:"meta-llama/llama-4-maverick",name:"Meta: Llama 4 Maverick",icon:""},{id:"nousresearch/hermes-4-405b",name:"Nous: Hermes 4 405B",icon:""},{id:"mistralai/mistral-large-2411",name:"Mistral: Mistral Large 2411",icon:""},{id:"z-ai/glm-4.6",name:"Z.AI: GLM 4.6",icon:""},{id:"x-ai/grok-4",name:"xAI: Grok 4",icon:""}]},cloudapi:{name:"CloudAPI",implementation:"openai-compatible",baseURL:"https://chat.cloudapi.vip/v1/chat/completions",supportsThinking:!0,icon:"",models:[{id:"claude-opus-4-5-20251101",name:"Opus 4.5",icon:""},{id:"claude-sonnet-4-5-20250929-thinking",name:"Sonnet 4.5 Think",icon:"",supportsThinking:!0}]},openai:{name:"OpenAI",implementation:"openai-compatible",baseURL:"https://api.openai.com/v1/chat/completions",icon:"",supportsThinking:!0,models:[{id:"gpt-4o",name:"GPT-4o",icon:""},{id:"gpt-5-pro",name:"GPT-5 Pro",icon:""},{id:"gpt-5",name:"GPT-5",icon:""},{id:"gpt-5-mini",name:"GPT-5 Mini",icon:""},{id:"gpt-5-codex",name:"GPT-5 CodeX",icon:""}]},custom:{name:"Custom (OpenAI Compatible)",implementation:"openai-compatible",baseURL:"",icon:"",models:[]}},nt="/default",be="/default/providers",we=[{id:Ke,name:Ka,type:"agent",icon:"",description:"A helpful AI assistant",initPath:nt,initialTags:["system","default"],config:{connectionId:Ke,modelName:"",systemPrompt:"You are a helpful assistant."}},{id:"tmp-id",name:"",type:"agent",icon:"",description:"4",initialTags:["default"],initPath:nt,config:{connectionId:Ke,modelName:"",systemPrompt:"You are a helpful assistant. Answer the user's current prompt concisely and accurately, without referring to any past conversation history.",maxHistoryLength:4},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"deepseek",name:"DeepSeek",type:"agent",icon:"",description:" DeepSeek ",initialTags:["default","deepseek"],initPath:be,config:{connectionId:"conn-deepseek",modelName:"",systemPrompt:"You are a helpful assistant powered by DeepSeek.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"claude",name:"Claude",type:"agent",icon:"",description:" Claude ",initialTags:["default","claude"],initPath:be,config:{connectionId:"conn-anthropic",modelName:"",systemPrompt:"You are a helpful, harmless, and honest assistant.",maxHistoryLength:20},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"gemini",name:"Gemini",type:"agent",icon:"",description:" Gemini ",initialTags:["default","gemini"],initPath:be,config:{connectionId:"conn-gemini",modelName:"",systemPrompt:"You are a helpful assistant powered by Google Gemini.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"openrouter",name:"OpenRouter",type:"agent",icon:"",description:" OpenRouter ",initialTags:["default","router"],initPath:be,config:{connectionId:"conn-openrouter",modelName:"",systemPrompt:"You are a helpful assistant, routed through OpenRouter.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"cloudapi",name:"CloudAPI",type:"agent",icon:"",description:" CloudAPI ",initialTags:["default","cloudapi"],initPath:be,config:{connectionId:"conn-cloudapi",modelName:"",systemPrompt:"You are a helpful assistant, routed through CloudAPI.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}}],J=new Map;function Xa(){J.set("openai",X),J.set("deepseek",X),J.set("groq",X),J.set("openrouter",X),J.set("ollama",X),J.set("custom",X),J.set("anthropic",ks),J.set("gemini",As)}Xa();function Za(l,e){const{provider:t}=l,s=e?.[t]||W[t];let n;if(s){switch(s.implementation){case"openai-compatible":n=X;break;case"anthropic":n=ks;break;case"gemini":n=As;break}l={...l,supportsThinking:l.supportsThinking??s.supportsThinking,requiresReferer:l.requiresReferer??s.requiresReferer,apiBaseUrl:l.apiBaseUrl||s.baseURL}}return n||(n=J.get(t)),n||(console.warn(`[LLMDriver] Unknown provider "${t}", using OpenAI compatible mode`),n=X),new n(l)}class Ls{provider;config;constructor(e){const t=e.connection?.provider||e.provider,s=e.connection?.apiKey||e.apiKey,n=e.connection?.baseURL||e.apiBaseUrl,i=e.connection?.model||e.model;if(!t)throw new Error("LLMDriver requires provider (either directly or via connection)");if(!s)throw new Error("LLMDriver requires apiKey (either directly or via connection)");const a={provider:t,apiKey:s,apiBaseUrl:n,model:i,supportsThinking:e.supportsThinking,requiresReferer:e.requiresReferer,headers:e.headers,metadata:e.connection?.metadata};this.config={maxRetries:e.maxRetries??Ja,retryDelay:e.retryDelay??Ya,timeout:e.timeout??Qa,...e},this.provider=Za(a,e.customProviderDefaults)}get chat(){return{create:this.createChatCompletion.bind(this)}}get providerName(){return this.provider.name}get currentModel(){return this.config.model||this.config.connection?.model}async createChatCompletion(e){let t={...e};this.config.hooks?.beforeRequest&&(t=await this.config.hooks.beforeRequest(t));const s=new AbortController,n=setTimeout(()=>s.abort(),this.config.timeout);t.signal&&t.signal.addEventListener("abort",()=>s.abort()),t.signal=s.signal;try{if(t.stream){const i=this.provider.stream(t);return clearTimeout(n),this.wrapStreamWithTimeout(i,s,n)}else{const i=await this.executeWithRetry(()=>this.provider.create(t));return clearTimeout(n),this.config.hooks?.afterResponse?this.config.hooks.afterResponse(i):i}}catch(i){clearTimeout(n);const a=i instanceof G?i:G.fromException(this.providerName,i);throw this.config.hooks?.onError&&await this.config.hooks.onError(a,t),a}}async executeWithRetry(e,t=1){try{return await e()}catch(s){const n=s instanceof G?s:G.fromException(this.providerName,s);if(n.retryable&&t<this.config.maxRetries){const a=n.retryAfter||this.config.retryDelay*Math.pow(2,t-1);return console.log(`[LLMDriver] Retrying in ${a}ms (attempt ${t+1}/${this.config.maxRetries})`),await this.sleep(a),this.executeWithRetry(e,t+1)}throw n}}async*wrapStreamWithTimeout(e,t,s){try{for await(const n of e)clearTimeout(s),yield n}finally{clearTimeout(s)}}sleep(e){return new Promise(t=>setTimeout(t,e))}}async function eo(l){const{provider:e,apiKey:t,baseURL:s,model:n,timeout:i=15e3}=l;if(!e)return{success:!1,message:"Provider is required"};if(!t)return{success:!1,message:"API Key is required"};const a=n||W[e]?.models?.[0]?.id||"gpt-4o-mini",o=Date.now();try{const c=await new Ls({provider:e,apiKey:t,apiBaseUrl:s,model:a,timeout:i,maxRetries:1}).chat.create({messages:[{role:"user",content:"Hi"}],model:a,maxTokens:5,stream:!1}),d=Date.now()-o;return c.choices?.length>0?{success:!0,message:"Connection successful",latency:d,model:c.model||a}:{success:!1,message:"Response was empty",latency:d}}catch(r){const c=Date.now()-o;return r instanceof G?{success:!1,message:`${r.code}: ${r.message}`,latency:c}:r.name==="AbortError"?{success:!1,message:"Request timed out",latency:c}:{success:!1,message:r.message||"Unknown error",latency:c}}}class to{constructor(e,t,s){this.id=e,this.name=t,this.config=s,this.driver=new Ls({connection:s.connection,model:s.model})}type="agent";driver;async execute(e,t){const s=Date.now(),n=this.buildMessages(e,t);t.events.emit("node:start",{executorId:this.id,executorType:this.type,input:e});let i="",a="";try{const o=await this.driver.chat.create({messages:n,model:this.config.model,stream:!0,thinking:!0,signal:t.signal});for await(const r of o){t.checkCancelled();const c=r.choices[0]?.delta;c&&(c.thinking&&(a+=c.thinking,t.emitThinking(c.thinking)),c.content&&(i+=c.content,t.emitContent(c.content)),c.tool_calls&&await this.handleToolCalls(c.tool_calls,t))}return{status:"success",output:i,control:{action:"continue"},metadata:{executorId:this.id,executorType:this.type,startTime:s,endTime:Date.now(),duration:Date.now()-s,thinkingLength:a.length}}}catch(o){return console.error("[AgentExecutor] Error:",o),t.emitError(o),{status:"failed",output:null,control:{action:"end",reason:o.message},errors:[{code:o.code||"LLM_ERROR",message:o.message,recoverable:this.isRecoverable(o)}]}}}buildMessages(e,t){const s=[];this.config.systemPrompt&&s.push({role:"system",content:this.config.systemPrompt});const n=t.variables.get("history")||[];s.push(...n);const i=typeof e=="string"?e:JSON.stringify(e);return s.push({role:"user",content:i}),s}async handleToolCalls(e,t){for(const s of e){const n=this.config.tools?.find(i=>i.name===s.function.name);if(n?.handler){t.events.emit("stream:tool_call",{toolName:s.function.name,args:s.function.arguments,status:"running"});try{const i=JSON.parse(s.function.arguments),a=await n.handler(i,t);t.events.emit("stream:tool_call",{toolName:s.function.name,result:a,status:"success"})}catch(i){t.events.emit("stream:tool_call",{toolName:s.function.name,error:i.message,status:"failed"})}}}}isRecoverable(e){const t=e.statusCode||e.status;return t>=500||t===429}validate(e){return e==null?{valid:!1,errors:["Input cannot be empty"]}:{valid:!0}}}class so{constructor(e,t,s){this.id=e,this.name=t,this.config=s}type="http";async execute(e,t){const s=Date.now();t.events.emit("node:start",{executorId:this.id,executorType:this.type,url:this.config.url,method:this.config.method});try{const n=this.interpolate(this.config.url,e,t),i=this.buildBody(e,t),a=this.buildHeaders(t),o=await this.fetchWithRetry(n,{method:this.config.method,headers:a,body:i,signal:t.signal}),r=await this.parseResponse(o);return{status:"success",output:this.extractOutput(r),control:{action:"continue"},metadata:{executorId:this.id,executorType:this.type,startTime:s,endTime:Date.now(),statusCode:o.status,url:n}}}catch(n){return t.emitError(n),{status:"failed",output:null,control:{action:"end",reason:n.message},errors:[{code:"HTTP_ERROR",message:n.message,recoverable:!1}]}}}async fetchWithRetry(e,t,s=1){try{const n=await fetch(e,t);if(this.config.retryOn?.includes(n.status)&&s<(this.config.maxRetries||3))return await this.delay(this.config.retryDelay||1e3),this.fetchWithRetry(e,t,s+1);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n}catch(n){if(n.name==="AbortError")throw n;if(s<(this.config.maxRetries||3))return await this.delay(this.config.retryDelay||1e3),this.fetchWithRetry(e,t,s+1);throw n}}interpolate(e,t,s){let n=e;typeof t=="string"&&(n=n.replace(/\{\{input\}\}/g,encodeURIComponent(t)));const i=s.variables.toObject();return n=n.replace(/\{\{var\.(\w+)\}\}/g,(a,o)=>encodeURIComponent(String(i[o]||""))),n}buildBody(e,t){if(this.config.method!=="GET")return this.config.bodyTemplate?this.interpolate(this.config.bodyTemplate,e,t):e&&typeof e=="object"?JSON.stringify(e):typeof e=="string"?e:void 0}buildHeaders(e){return{"Content-Type":"application/json",...this.config.headers}}async parseResponse(e){switch(this.config.responseType){case"text":return e.text();case"blob":return e.blob();default:return e.json()}}extractOutput(e){if(!this.config.extractPath)return e;const t=this.config.extractPath.split(".");let s=e;for(const n of t){const i=n.match(/^(\w+)(?:\[(\d+)\])?$/);if(!i)break;s=s?.[i[1]],i[2]!==void 0&&(s=s?.[parseInt(i[2])])}return s}delay(e){return new Promise(t=>setTimeout(t,e))}}class wt{constructor(e,t,s,n){this.id=e,this.name=t,this.config=s,this.factory=n,this.initializeChildren()}type="composite";children=[];initializeChildren(){this.children=this.config.children.map(e=>this.factory.create(e))}async executeChild(e,t,s){const n=s.createChild(e.id);s.events.emit("node:start",{executorId:e.id,executorType:e.type,name:e.name},e.id);try{const i=await e.execute(t,n);return s.events.emit("node:complete",{executorId:e.id,status:i.status,output:i.output},e.id),s.results.set(e.id,i),i}catch(i){throw s.events.emit("node:error",{executorId:e.id,error:i.message},e.id),i}}mergeResults(e){const t=e.some(n=>n.status==="failed");return{status:e.every(n=>n.status==="success")?"success":t?"failed":"partial",output:e.map(n=>n.output),control:{action:"continue"},errors:e.flatMap(n=>n.errors||[])}}}class no extends wt{async execute(e,t){let s=e,n=null;t.events.emit("node:start",{executorId:this.id,mode:"serial",childCount:this.children.length});for(let i=0;i<this.children.length;i++){t.checkCancelled();const a=this.children[i];try{if(n=await this.executeChild(a,s,t),n.control.action==="end")break;if(n.control.action==="route"){const o=this.children.findIndex(r=>r.id===n.control.target);o!==-1&&(i=o-1)}s=n.output}catch(o){if(this.config.constraints?.maxRetries&&n?.errors?.[0]?.recoverable){t.events.emit("execution:progress",{action:"retry",childId:a.id}),i--;continue}throw o}}return n||{status:"success",output:s,control:{action:"end"}}}}class io extends wt{async execute(e,t){const s=this.config.modeConfig?.parallel,n=s?.maxConcurrency||this.children.length;t.events.emit("node:start",{executorId:this.id,mode:"parallel",childCount:this.children.length,maxConcurrency:n});const i=await this.executeWithConcurrencyLimit(this.children,e,t,n);return s?.mergeStrategy==="first"?i.find(o=>o.status==="success")||i[0]:this.mergeResults(i)}async executeWithConcurrencyLimit(e,t,s,n){const i=[],a=[];for(let o=0;o<e.length;o++){s.checkCancelled();const r=e[o],c=o,d=this.executeChild(r,t,s).then(h=>{i[c]=h}).catch(h=>{i[c]={status:"failed",output:null,control:{action:"end"},errors:[{code:"EXECUTION_ERROR",message:h.message,recoverable:!1}]}});if(a.push(d),a.length>=n){await Promise.race(a);const h=a.findIndex(u=>u.then(()=>!0).catch(()=>!0));h!==-1&&a.splice(h,1)}}return await Promise.all(a),i}}class ao extends wt{async execute(e,t){const s=this.config.modeConfig?.router;t.events.emit("node:start",{executorId:this.id,mode:"router",strategy:s?.strategy||"rule"});const n=await this.selectTarget(e,t);return n?(t.events.emit("execution:progress",{action:"route",selectedTarget:n.id}),this.executeChild(n,e,t)):{status:"failed",output:null,control:{action:"end",reason:"No matching route found"},errors:[{code:"NO_ROUTE",message:"No matching route found",recoverable:!1}]}}async selectTarget(e,t){const s=this.config.modeConfig?.router;return s?.strategy==="llm"?this.selectByLLM(e,t):this.selectByRules(e,t,s?.rules||[])}selectByRules(e,t,s){const n=typeof e=="string"?e:JSON.stringify(e),i=t.variables.toObject();for(const a of s)if(this.evaluateCondition(a.condition,n,i))return this.children.find(o=>o.id===a.target)||null;return this.children[0]||null}evaluateCondition(e,t,s){try{if(e.startsWith("contains:")){const n=e.slice(9).trim();return t.toLowerCase().includes(n.toLowerCase())}if(e.startsWith("startsWith:")){const n=e.slice(11).trim();return t.startsWith(n)}if(e.startsWith("equals:")){const n=e.slice(7).trim();return t===n}if(e.startsWith("regex:")){const n=e.slice(6).trim();return new RegExp(n,"i").test(t)}if(e.startsWith("var:")){const n=e.slice(4).trim();return!!s[n]}return!0}catch{return!1}}async selectByLLM(e,t){const s=this.children.find(r=>r.type==="agent");if(!s)return this.children[0]||null;const i=`
Based on the user input, select the most appropriate handler.

Available handlers:
${this.children.filter(r=>r.id!==s.id).map(r=>`- ${r.id}: ${r.name}`).join(`
`)}

User input: ${typeof e=="string"?e:JSON.stringify(e)}

Respond with only the handler ID.
        `.trim(),a=t.createChild(s.id),o=await s.execute(i,a);if(o.status==="success"&&typeof o.output=="string"){const r=o.output.trim();return this.children.find(c=>c.id===r)||this.children[0]}return this.children[0]||null}}class oo{executorCreators=new Map;orchestratorCreators=new Map;instances=new Map;constructor(){this.registerBuiltins()}registerBuiltins(){this.registerExecutor("agent",e=>{const t=e;return new to(e.id,e.name,t)}),this.registerExecutor("http",e=>{const t=e;return new so(e.id,e.name,t)}),this.registerOrchestrator("serial",(e,t)=>new no(e.id,e.name,e,t)),this.registerOrchestrator("parallel",(e,t)=>new io(e.id,e.name,e,t)),this.registerOrchestrator("router",(e,t)=>new ao(e.id,e.name,e,t))}registerExecutor(e,t){this.executorCreators.set(e,t)}registerOrchestrator(e,t){this.orchestratorCreators.set(e,t)}create(e){if(this.instances.has(e.id))return this.instances.get(e.id);let t;if(e.type==="composite"){const s=e,n=this.orchestratorCreators.get(s.mode);if(!n)throw new Error(`Unknown orchestration mode: ${s.mode}`);t=n(e,this)}else{const s=this.executorCreators.get(e.type);if(!s)throw new Error(`Unknown executor type: ${e.type}`);t=s(e,this)}return this.instances.set(e.id,t),t}supports(e){return this.executorCreators.has(e)||e==="composite"}getRegisteredTypes(){return{executors:Array.from(this.executorCreators.keys()),orchestrators:Array.from(this.orchestratorCreators.keys())}}clearCache(){this.instances.clear()}}let Qe=null;function Ns(){return Qe||(Qe=new oo),Qe}class ro{eventBus;factory;activeExecutions=new Map;constructor(e){this.eventBus=ft(),this.factory=e||Ns()}async execute(e,t,s={}){const n=s.executionId||s.variables?.sessionId||F(),i=new AbortController;s.signal&&s.signal.addEventListener("abort",()=>{i.abort()});let a;s.timeout&&(a=setTimeout(()=>{i.abort()},s.timeout)),this.activeExecutions.set(n,i);const o=this.eventBus.createScope(n),r=new yt(n,o,void 0,0,void 0,i);if(s.rootNodeId&&r.setCurrentNode(s.rootNodeId),s.variables)for(const[c,d]of Object.entries(s.variables))r.variables.set(c,d);try{o.emit("execution:start",{executionId:n,config:{id:e.id,name:e.name,type:e.type}});const d=await this.factory.create(e).execute(t,r);return o.emit("execution:complete",{executionId:n,status:d.status,output:d.output}),d}catch(c){return o.emit("execution:error",{executionId:n,error:c.message,code:c.code}),{status:"failed",output:null,control:{action:"end",reason:c.message},errors:[{code:c.code||"RUNTIME_ERROR",message:c.message,recoverable:!1}]}}finally{a&&clearTimeout(a),this.activeExecutions.delete(n),this.eventBus.destroyScope(n)}}cancel(e){const t=this.activeExecutions.get(e);return t?(t.abort(),!0):!1}cancelAll(){for(const e of this.activeExecutions.values())e.abort();this.activeExecutions.clear()}getActiveCount(){return this.activeExecutions.size}onEvent(e){return this.eventBus.on("*",e)}onExecutionEvent(e,t){return this.eventBus.on("*",t,{filter:s=>s.executionId===e})}}let Je=null;function Ds(){return Je||(Je=new ro),Je}class lo{plugins=new Map;registry;eventBus;config={};constructor(){this.registry=Ns(),this.eventBus=ft()}setConfig(e){this.config={...this.config,...e}}async register(e){const{id:t}=e.metadata;if(this.plugins.has(t))throw new Error(`Plugin ${t} is already registered`);await this.checkDependencies(e.metadata);const s=this.createPluginContext(e.metadata);await e.initialize(s),this.plugins.set(t,e),console.log(`[PluginManager] Registered plugin: ${t} v${e.metadata.version}`)}async unregister(e){const t=this.plugins.get(e);t&&(t.destroy&&await t.destroy(),this.plugins.delete(e),console.log(`[PluginManager] Unregistered plugin: ${e}`))}getPlugins(){return Array.from(this.plugins.values()).map(e=>e.metadata)}async checkDependencies(e){if(e.dependencies){for(const t of e.dependencies)if(!this.plugins.has(t))throw new Error(`Plugin ${e.id} requires ${t} which is not loaded`)}}createPluginContext(e){const t=`[Plugin:${e.id}]`;return{registerExecutor:(s,n)=>{this.registry.registerExecutor(s,n)},registerOrchestrator:(s,n)=>{this.registry.registerOrchestrator(s,n)},onEvent:(s,n)=>this.eventBus.on(s,n),getConfig:s=>this.config[s],log:{debug:(s,...n)=>console.debug(t,s,...n),info:(s,...n)=>console.info(t,s,...n),warn:(s,...n)=>console.warn(t,s,...n),error:(s,...n)=>console.error(t,s,...n)}}}}let Ye=null;function co(){return Ye||(Ye=new lo),Ye}async function ho(l={}){const e=Ds(),t=co();if(l.config&&t.setConfig(l.config),l.plugins)for(const s of l.plugins)await t.register(s);return console.log("[Kernel] Initialized"),{runtime:e,pluginManager:t}}class uo{nodeMap=new Map;bridge(e,t){const s=ft(),n=a=>{if(a.executionId!==e)return;const o=this.convertToUIEvent(a);o&&t(o)},i=[s.on("node:start",n),s.on("node:update",n),s.on("node:complete",n),s.on("node:error",n),s.on("stream:thinking",n),s.on("stream:content",n),s.on("stream:tool_call",n),s.on("execution:complete",n),s.on("execution:error",n)];return()=>{i.forEach(a=>a()),this.nodeMap.clear()}}convertToUIEvent(e){const{type:t,nodeId:s,payload:n,executionId:i}=e;switch(t){case"node:start":return this.handleNodeStart(s,n);case"stream:thinking":return{type:"node_update",payload:{nodeId:s||"",chunk:n.delta,field:"thought"}};case"stream:content":return{type:"node_update",payload:{nodeId:s||n?.nodeId||"",chunk:n.delta||n.content,field:"output"}};case"node:update":return n.status?{type:"node_status",payload:{nodeId:s||"",status:n.status}}:null;case"node:complete":return{type:"node_status",payload:{nodeId:s||"",status:n.status==="success"?"success":"failed",result:n.output}};case"node:error":return{type:"error",payload:{message:n.error||n.message||"Unknown error",error:new Error(n.error||n.message)}};case"execution:complete":return{type:"finished",payload:{sessionId:i}};case"execution:error":return{type:"error",payload:{message:n.message||"Execution failed",error:new Error(n.message)}};case"stream:tool_call":return{type:"node_update",payload:{nodeId:s||"",metaInfo:{toolCall:{name:n.toolName,args:n.args,result:n.result,status:n.status}}}};default:return null}}handleNodeStart(e,t){const s=e||F(),n={id:s,parentId:t.parentId,executorId:t.executorId||"unknown",executorType:t.executorType||"agent",name:t.name||t.executorId||"Node",status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:t.metaInfo||{}},children:[]};return this.nodeMap.set(s,n),{type:"node_start",payload:{node:n,parentId:t.parentId}}}getNode(e){return this.nodeMap.get(e)}clear(){this.nodeMap.clear()}}class go{runtime;uiAdapter;constructor(){this.runtime=Ds(),this.uiAdapter=new uo}async executeQuery(e,t,s){const{sessionId:n,history:i,files:a,onEvent:o,signal:r,rootNodeId:c}=s;let d;o&&(d=this.uiAdapter.bridge(n,h=>{o(h)}));try{return await this.runtime.execute(t,e,{variables:{history:i||[],files:a||[],sessionId:n},signal:r,executionId:n,rootNodeId:c})}finally{d?.()}}cancel(e){return this.runtime.cancel(e)}getRuntime(){return this.runtime}getActiveCount(){return this.runtime.getActiveCount()}}let Xe=null;function po(){return Xe||(Xe=new go),Xe}class mo{queue=Promise.resolve();pendingCount=0;enqueue(e){this.pendingCount++,this.queue=this.queue.then(e).catch(t=>console.error("[PersistQueue] Error:",t)).finally(()=>{this.pendingCount--})}async flush(){await this.queue}get isPending(){return this.pendingCount>0}}class fo{engine;persistQueue=new mo;constructor(e){this.engine=e}async appendMessage(e,t,s,n,i){return this.engine.appendMessage(e,t,s,n,i)}async updateMessage(e,t,s){return this.engine.updateNode(e,t,s)}async deleteMessage(e,t){return this.engine.deleteMessage(e,t)}async editMessage(e,t,s,n){return this.engine.editMessage(e,t,s,n)}async getSessionContext(e,t){return this.engine.getSessionContext(e,t)}async getManifest(e){return this.engine.getManifest(e)}async getNodeSiblings(e,t){return this.engine.getNodeSiblings(e,t)}async readAsset(e,t){return this.engine.readSessionAsset(e,t)}async switchToBranch(e,t,s){const n=await this.engine.getManifest(e);n.current_head=s,n.branches[n.current_branch]=s,n.updated_at=new Date().toISOString(),await this.engine.writeContent(e,JSON.stringify(n,null,2))}enqueuePersist(e){this.persistQueue.enqueue(e)}async flush(){await this.persistQueue.flush()}createThrottledPersist(e,t,s=1e3){const n={output:"",thinking:""};let i=Date.now();return{accumulator:n,persist:()=>{if(!n.output&&!n.thinking)return;const r=Date.now();if(r-i<s)return;i=r;const c=n.output,d=n.thinking;this.enqueuePersist(async()=>{try{await this.updateMessage(e,t,{content:c,meta:{thinking:d,status:"running"}})}catch(h){console.warn("[PersistenceAdapter] Persist failed:",h)}})},finalize:async()=>{await this.flush()}}}}class Pt{static chatNodeToSessionGroup(e){if(e.role==="user"){const t=(e.meta?.files||[]).map(s=>({name:s.name,type:s.type,path:s.path,size:s.size}));return{id:F(),timestamp:new Date(e.created_at).getTime(),role:"user",content:e.content,files:t,persistedNodeId:e.id}}return e.role==="assistant"?{id:F(),timestamp:new Date(e.created_at).getTime(),role:"assistant",executionRoot:{id:F(),executorId:e.meta?.agentId||"unknown",executorType:"agent",name:e.meta?.agentName||"Assistant",status:e.meta?.status||"success",startTime:new Date(e.created_at).getTime(),endTime:new Date(e.created_at).getTime(),data:{output:e.content,thought:e.meta?.thinking||"",metaInfo:e.meta||{},error:e.meta?.error},children:[]},persistedNodeId:e.id}:null}static sessionToMarkdown(e){const t=e.role==="user"?" User":" Assistant",s=new Date(e.timestamp).toLocaleTimeString();let n=`### ${t} <small>(${s})</small>

`;if(e.role==="user"){if(e.files&&e.files.length>0){const i=e.files.map(a=>a.path?`[${a.name}](${a.path})`:`\`[File: ${a.name}]\``).join(", ");n+=`> Attachments: ${i}

`}n+=`${e.content||"(Empty)"}

`}else if(e.role==="assistant"&&e.executionRoot){const i=e.executionRoot;i.data.thought&&(n+=`> **Thinking Process:**
> 
`,n+=i.data.thought.split(`
`).map(a=>`> ${a}`).join(`
`),n+=`

`),n+=`${i.data.output||"(No output)"}

`}return n+=`---

`,n}static createUserSession(e,t,s){return{id:F(),timestamp:Date.now(),role:"user",content:e,files:t,persistedNodeId:s}}static createAssistantSession(e,t){return{id:F(),timestamp:Date.now(),role:"assistant",executionRoot:e,persistedNodeId:t}}static createExecutionNode(e,t,s,n){return{id:e,executorId:e,executorType:s,name:t,status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:n||{}},children:[]}}static sessionsToMarkdown(e){let t=`# Chat Session Export

`;const s=new Date().toLocaleString();t+=`> Exported at: ${s}

---

`;for(const n of e)t+=this.sessionToMarkdown(n);return t}static sessionsToJSON(e){const t=e.map(s=>({id:s.id,timestamp:s.timestamp,role:s.role,content:s.role==="user"?s.content:s.executionRoot?.data.output,thinking:s.executionRoot?.data.thought,files:s.files,metadata:s.executionRoot?.data.metaInfo}));return JSON.stringify(t,null,2)}static sessionsToPlainText(e){let t="";for(const s of e){const n=s.role==="user"?"User":"Assistant",i=new Date(s.timestamp).toLocaleTimeString();t+=`[${n} - ${i}]
`,s.role==="user"?t+=`${s.content||"(Empty)"}
`:s.executionRoot&&(t+=`${s.executionRoot.data.output||"(No output)"}
`),t+=`
---

`}return t}}class de{static instance=null;sessions=new Map;sessionStates=new Map;activeSessionId=null;modelResolutionCache=new Map;taskQueue=[];runningTasks=new Map;maxConcurrent=ve.MAX_CONCURRENT;globalListeners=new Set;sessionListeners=new Map;kernelAdapter;persistence;agentService;initialized=!1;markdownAnalyzer=new Rn;constructor(){}static getInstance(){return de.instance||(de.instance=new de),de.instance}initialize(e,t,s){this.initialized||(this.kernelAdapter=po(),this.persistence=new fo(t),this.agentService=e,s?.maxConcurrent&&(this.maxConcurrent=s.maxConcurrent),this.agentService.onChange(()=>{this.modelResolutionCache.clear()}),this.initialized=!0,console.log("[SessionRegistry] Initialized"))}ensureInitialized(){if(!this.initialized)throw new C(P.SESSION_INVALID,"SessionRegistry not initialized. Call initialize() first.")}async registerSession(e,t){if(this.ensureInitialized(),this.sessions.has(t)){const i=this.sessions.get(t);return i.lastActiveTime=Date.now(),this.sessionListeners.has(t)||this.sessionListeners.set(t,new Set),i}const s={sessionId:t,nodeId:e,status:"idle",lastActiveTime:Date.now(),unreadCount:0},n=new qa(e,t);return await this.loadSessionData(n,e,t),this.sessions.set(t,s),this.sessionStates.set(t,n),this.sessionListeners.set(t,new Set),this.emitGlobal({type:"session_registered",payload:{sessionId:t}}),s}async unregisterSession(e,t){const s=this.sessions.get(e);if(s){if(s.status==="running"||s.status==="queued"){if(t?.keepInBackground){this.sessionListeners.get(e)?.clear();return}if(!t?.force)throw new C(P.SESSION_BUSY,"Session is still running. Use force=true or keepInBackground=true.");await this.abortSession(e)}this.sessions.delete(e),this.sessionStates.delete(e),this.sessionListeners.delete(e),this.activeSessionId===e&&(this.activeSessionId=null),this.emitGlobal({type:"session_unregistered",payload:{sessionId:e}})}}setActiveSession(e){if(this.activeSessionId=e,e){const t=this.sessions.get(e);t&&t.unreadCount>0&&(t.unreadCount=0,this.emitGlobal({type:"session_unread_updated",payload:{sessionId:e,count:0}}))}}getActiveSessionId(){return this.activeSessionId}async loadSessionData(e,t,s){try{const n=await this.persistence.getSessionContext(t,s);for(const i of n){const a=i.node;a.role!=="system"&&(a.role==="assistant"&&!a.content?.trim()||e.loadFromChatNode(a))}}catch(n){console.error(`[SessionRegistry] Failed to load session ${s}:`,n)}}async submitTask(e,t,s){this.ensureInitialized();const n=this.sessions.get(e);if(!n)throw new C(P.SESSION_NOT_FOUND,"Session not registered");if(n.status==="running"||n.status==="queued")throw new C(P.SESSION_BUSY,"Session already has active task");if(this.taskQueue.length>=ve.MAX_QUEUE_SIZE)throw new C(P.QUOTA_EXCEEDED,"Task queue is full. Please wait.");const i={id:`task-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,sessionId:e,nodeId:n.nodeId,input:t,options:{skipUserMessage:s?.skipUserMessage,parentUserNodeId:s?.parentUserNodeId,branchInfo:s?.branchInfo},priority:s?.priority??0,createdAt:Date.now(),abortController:new AbortController};return n.currentTaskId=i.id,this.updateStatus(e,"queued"),this.enqueueTask(i),this.processQueue(),i.id}async abortSession(e){const t=this.sessions.get(e);if(!t)return;const s=this.taskQueue.findIndex(n=>n.sessionId===e);if(s!==-1){this.taskQueue.splice(s,1),this.updateStatus(e,"aborted"),this.emitPoolStatus();return}if(t.currentTaskId){const n=this.runningTasks.get(t.currentTaskId);n&&(n.abortController.abort(),this.runningTasks.delete(t.currentTaskId)),this.updateStatus(e,"aborted")}this.emitPoolStatus(),this.processQueue()}enqueueTask(e){const t=this.taskQueue.findIndex(s=>s.priority<e.priority);t===-1?this.taskQueue.push(e):this.taskQueue.splice(t,0,e),this.emitPoolStatus()}processQueue(){for(;this.runningTasks.size<this.maxConcurrent&&this.taskQueue.length>0;){const e=this.taskQueue.shift();this.executeTask(e)}}async executeTask(e){const{sessionId:t,nodeId:s,input:n,options:i}=e,a=this.sessionStates.get(t),o=this.sessions.get(t);if(!a||!o){console.error(`[SessionRegistry] Session ${t} not found`);return}this.runningTasks.set(e.id,e),this.updateStatus(t,"running"),this.emitPoolStatus();let r=!1;try{const c=[],d=new Set,h=await this.markdownAnalyzer.analyze(n.text,{filePath:"message.md"});for(const y of h.references){if(d.has(y))continue;d.add(y);const _=n.files.find(E=>E.name===y);if(_)c.push(_);else try{const E=await this.persistence.readAsset(t,y);E?c.push({name:y,type:E.type||Ie(y),path:`./${y}`,size:E.size,fileRef:E}):console.warn(`[SessionRegistry] Asset not found in VFS: ${y}`)}catch(E){console.error(`[SessionRegistry] Failed to load asset: ${y}`,E)}}for(const y of n.files)d.has(y.name)||(c.push(y),d.add(y.name));let u=i.parentUserNodeId;if(!i.skipUserMessage){const y=c.map(E=>({name:E.name,type:E.type,path:E.path,size:E.size}));u=await this.persistence.appendMessage(s,t,"user",n.text,{files:y});const _=a.addUserMessage(n.text,c,u);this.emitSessionEvent(t,{type:"session_start",payload:_})}let g=await this.resolveExecutorConfig(n.executorId);n.overrides&&(n.overrides.modelId&&(g.model=n.overrides.modelId),n.overrides.temperature!==void 0&&(g.temperature=n.overrides.temperature));let p=a.getHistory();n.overrides?.historyLength!==void 0&&n.overrides.historyLength!==-1&&(p=p.slice(-n.overrides.historyLength));const f=i.branchInfo,v=await this.persistence.appendMessage(s,t,"assistant","",{agentId:g.id,agentName:g.name,status:"running",siblingIndex:f?.siblingIndex??0,siblingCount:f?.siblingCount??1,parentAssistantId:f?.parentAssistantId}),b=a.createAssistantMessage(g,v,f);this.emitSessionEvent(t,{type:"session_start",payload:a.getLastSession()}),this.emitSessionEvent(t,{type:"node_start",payload:{node:b}});const{accumulator:I,persist:U,finalize:q}=this.persistence.createThrottledPersist(t,v,ve.PERSIST_THROTTLE),B=y=>{if(y.type==="node_start"){const _=y.payload;if(!_.parentId&&!_.node?.parentId)return}(y.type==="node_update"||y.type==="node_status")&&!y.payload.nodeId&&(y.payload.nodeId=b.id),y.type==="error"&&(r=!0),y.type==="node_update"&&y.payload.chunk&&y.payload.nodeId===b.id&&(y.payload.field==="thought"?(I.thinking+=y.payload.chunk,a.appendToNode(b.id,y.payload.chunk,"thought")):y.payload.field==="output"&&(I.output+=y.payload.chunk,a.appendToNode(b.id,y.payload.chunk,"output")),U()),this.emitSessionEvent(t,y)},D=[];c.forEach(y=>{if(y.fileRef instanceof File)D.push(y.fileRef);else if(y.fileRef instanceof Blob){const _=new File([y.fileRef],y.name,{type:y.type});D.push(_)}});const H=await this.kernelAdapter.executeQuery(n.text,g,{sessionId:t,history:a.getHistory(),files:D,onEvent:B,signal:e.abortController.signal,rootNodeId:b.id});if(H.status==="failed"){const y=H.errors?.[0],_=new Error(y?.message||"Execution failed");throw _.status=y?.code,_}await q(),await this.persistence.updateMessage(t,v,{content:I.output,meta:{thinking:I.thinking,status:"success",endTime:Date.now()}}),a.updateNodeStatus(b.id,"success"),this.updateStatus(t,"completed"),this.emitSessionEvent(t,{type:"node_status",payload:{nodeId:b.id,status:"success"}}),this.emitSessionEvent(t,{type:"finished",payload:{sessionId:t}}),t!==this.activeSessionId&&(o.unreadCount++,this.emitGlobal({type:"session_unread_updated",payload:{sessionId:t,count:o.unreadCount}}))}catch(c){console.error("[SessionRegistry] Task execution failed:",c);const h=c.name==="AbortError"||e.abortController.signal.aborted?"aborted":"failed";this.updateStatus(t,h),o.error=c;const u=this.formatErrorMessage(c),g=a.getLastSession();if(g?.executionRoot){const p=g.executionRoot.id;a.updateNodeStatus(p,h),a.updateNodeError(p,u),r||this.emitSessionEvent(t,{type:"node_status",payload:{nodeId:p,status:h,result:u}}),g.persistedNodeId&&await this.persistence.updateMessage(t,g.persistedNodeId,{meta:{status:h,error:u,endTime:Date.now()}})}r||this.emitSessionEvent(t,{type:"error",payload:{message:u,error:c instanceof Error?c:new Error(String(c))}})}finally{this.runningTasks.delete(e.id),o.currentTaskId=void 0,this.emitPoolStatus(),this.processQueue()}}formatErrorMessage(e){const t=e.status||e.code;return t===401?"Authentication failed: Invalid API key or token expired. Please check your connection settings.":t===403?"Access denied: You do not have permission to use this API.":t===429?"Rate limit exceeded: Too many requests. Please wait and try again.":t===500||t===502||t===503?`Server error (${t}): The LLM service is temporarily unavailable.`:e.message?.includes("fetch")||e.message?.includes("network")?"Network error: Unable to connect to the LLM service. Please check your internet connection.":e.message||"An unknown error occurred"}async resolveExecutorConfig(e){try{const t=await this.agentService.getAgentConfig(e);if(t){const s=await this.agentService.getConnection(t.config.connectionId);if(!s)throw new C(P.EXECUTOR_NOT_FOUND,`Connection '${t.config.connectionId}' for agent '${t.name}' not found.`);const n=this.resolveModelIdWithCache(s,t.config.modelName);return{id:t.id,name:t.name,type:t.type==="agent"?"agent":"composite",connection:s,model:n,systemPrompt:t.config.systemPrompt}}}catch(t){console.warn(`[SessionRegistry] Failed to resolve executor ${e}, using fallback.`,t)}return this.getFallbackExecutorConfig()}async getFallbackExecutorConfig(){const e=await this.agentService.getDefaultConnection();if(!e)return console.error("[SessionRegistry] CRITICAL: No connections available. Cannot create a fallback executor."),{id:"default",name:"Error: No Connection",type:"agent",connection:null,model:""};const t=e.model||e.availableModels?.[0]?.id||"";return{id:"default",name:"Default Assistant",type:"agent",connection:e,model:t}}resolveModelIdWithCache(e,t){if(!t)return"";const s=`${e.id}:${t}`;if(this.modelResolutionCache.has(s))return this.modelResolutionCache.get(s);let n=t;if(e.availableModels&&Array.isArray(e.availableModels)){const i=e.availableModels.find(a=>a.name===t);if(i)n=i.id;else{const a=e.availableModels.find(o=>o.id===t);a&&(n=a.id)}}return this.modelResolutionCache.set(s,n),n}updateStatus(e,t){const s=this.sessions.get(e);if(!s)return;const n=s.status;s.status=t,s.lastActiveTime=Date.now(),t!=="failed"&&(s.error=void 0),this.emitGlobal({type:"session_status_changed",payload:{sessionId:e,status:t,prevStatus:n}})}async deleteMessage(e,t,s){const n=this.sessionStates.get(e);if(!n)throw new C(P.SESSION_NOT_FOUND,"Session not found");const i={deleteAssociatedResponses:!0,...s},a=n.findSessionById(t);if(!a){console.warn(`[SessionRegistry] Message ${t} not found`);return}const o=[t];if(i.deleteAssociatedResponses&&a.role==="user"){const c=n.getSessions(),d=c.findIndex(h=>h.id===t);if(d!==-1)for(let h=d+1;h<c.length;h++){const u=c[h];if(u.role==="assistant")o.push(u.id),u.executionRoot&&this.collectNodeIds(u.executionRoot,o);else break}}for(const c of o)n.removeMessage(c);const r=n.getSessions();for(const c of o){const d=r.find(h=>h.id===c)||a;if(d?.persistedNodeId)try{await this.persistence.deleteMessage(e,d.persistedNodeId)}catch(h){console.warn(`[SessionRegistry] Failed to persist delete for ${c}:`,h)}}this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:o}})}collectNodeIds(e,t){if(t.push(e.id),e.children)for(const s of e.children)this.collectNodeIds(s,t)}async editMessage(e,t,s,n=!1){const i=this.sessionStates.get(e),a=this.sessions.get(e);if(!i||!a)throw new C(P.SESSION_NOT_FOUND,"Session not found");i.updateMessageContent(t,s);const o=i.findSessionById(t);o?.persistedNodeId&&await this.persistence.updateMessage(e,o.persistedNodeId,{content:s}),this.emitSessionEvent(e,{type:"message_edited",payload:{sessionId:t,newContent:s}}),n&&o?.role==="user"&&(await this.deleteAssociatedResponses(e,t,i),await this.submitTask(e,{text:s,files:o.files||[],executorId:"default"},{skipUserMessage:!0,parentUserNodeId:o.persistedNodeId}))}async resendUserMessage(e,t,s){const n=this.sessionStates.get(e);if(!n)throw new C(P.SESSION_NOT_FOUND,"Session not found");const i=n.findSessionById(t);if(!i||i.role!=="user")throw new C(P.SESSION_INVALID,"Invalid user session");await this.deleteAssociatedResponses(e,t,n),this.emitSessionEvent(e,{type:"retry_started",payload:{originalId:t,newId:""}}),await this.submitTask(e,{text:i.content||"",files:i.files||[],executorId:s?.agentId||"default"},{skipUserMessage:!0,parentUserNodeId:i.persistedNodeId})}async deleteAssociatedResponses(e,t,s){const n=s.getSessions(),i=n.findIndex(o=>o.id===t);if(i===-1)return;const a=[];for(let o=i+1;o<n.length;o++){const r=n[o];if(r.role==="assistant")a.push(r.id);else break}for(const o of a){s.removeMessage(o);const r=n.find(c=>c.id===o);if(r?.persistedNodeId)try{await this.persistence.deleteMessage(e,r.persistedNodeId)}catch(c){console.warn(`[SessionRegistry] Failed to delete response ${o}:`,c)}}a.length>0&&this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:a}})}async retryGeneration(e,t,s){const n=this.sessionStates.get(e),i=this.sessions.get(e);if(!n||!i)throw new C(P.SESSION_NOT_FOUND,"Session not found");const a=n.findUserMessageBefore(t);if(!a)throw new C(P.SESSION_INVALID,"No user message found");const o=n.findSessionById(t);let r=1,c=0;o&&(r=(o.siblingCount||1)+1,c=r-1,s?.preserveCurrent&&(o.siblingCount=r,o.executionRoot&&(o.executionRoot.data.metaInfo={...o.executionRoot.data.metaInfo,siblingIndex:o.siblingIndex||0,siblingCount:r}),o.persistedNodeId&&await this.persistence.updateMessage(e,o.persistedNodeId,{meta:{siblingIndex:o.siblingIndex||0,siblingCount:r}}),this.emitSessionEvent(e,{type:"sibling_switch",payload:{sessionId:t,newIndex:o.siblingIndex||0,total:r}}))),s?.preserveCurrent||(n.removeMessage(t),o?.persistedNodeId&&await this.persistence.deleteMessage(e,o.persistedNodeId),this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:[t]}}),r=1,c=0),this.emitSessionEvent(e,{type:"retry_started",payload:{originalId:t,newId:"",siblingIndex:c,siblingCount:r}}),await this.submitTask(e,{text:a.content||"",files:a.files||[],executorId:s?.agentId||"default"},{skipUserMessage:!0,parentUserNodeId:a.persistedNodeId,branchInfo:{siblingIndex:c,siblingCount:r,parentAssistantId:s?.preserveCurrent?t:void 0}})}async getNodeSiblings(e,t){const s=this.sessionStates.get(e);if(!s)return[];const n=s.findSessionById(t);if(!n?.persistedNodeId)return n?[n]:[];try{const i=await this.persistence.getNodeSiblings(e,n.persistedNodeId);return i.map((a,o)=>{const r=Pt.chatNodeToSessionGroup(a);return r&&(r.siblingIndex=o,r.siblingCount=i.length),r}).filter(Boolean)}catch(i){return console.error("[SessionRegistry] getNodeSiblings failed:",i),n?[n]:[]}}async switchToSibling(e,t,s,n){const i=this.sessionStates.get(t);if(!i)throw new C(P.SESSION_NOT_FOUND,"Session not found");const a=i.findSessionById(s);if(!a?.persistedNodeId)throw new C(P.SESSION_INVALID,"Message not found");try{const o=await this.persistence.getNodeSiblings(t,a.persistedNodeId);if(n<0||n>=o.length)throw new C(P.SESSION_INVALID,"Invalid sibling index");const r=o[n];await this.persistence.switchToBranch(e,t,r.id),i.clear(),await this.loadSessionData(i,e,t),this.emitSessionEvent(t,{type:"sibling_switch",payload:{sessionId:s,newIndex:n,total:o.length}}),this.emitSessionEvent(t,{type:"session_cleared",payload:{}});for(const c of i.getSessions())this.emitSessionEvent(t,{type:"session_start",payload:c})}catch(o){throw console.error("[SessionRegistry] switchToSibling failed:",o),C.from(o)}}async getAvailableExecutors(){try{const t=(await this.agentService.getAgents()).map(s=>({id:s.id,name:s.name,icon:s.icon,category:s.type==="agent"?"Agents":"Workflows",description:s.description}));return t.unshift({id:"default",name:"Default Assistant",icon:"",category:"System",description:"Built-in default assistant"}),t}catch(e){return console.error("[SessionRegistry] getAvailableExecutors failed:",e),[{id:"default",name:"Default Assistant",icon:"",category:"System"}]}}onGlobalEvent(e){return this.globalListeners.add(e),()=>this.globalListeners.delete(e)}onSessionEvent(e,t){let s=this.sessionListeners.get(e);return s||(s=new Set,this.sessionListeners.set(e,s)),s.add(t),()=>s?.delete(t)}emitGlobal(e){this.globalListeners.forEach(t=>{try{t(e)}catch(s){console.error("[SessionRegistry] Global event handler error:",s)}})}emitSessionEvent(e,t){const s=this.sessionListeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(i){console.error("[SessionRegistry] Session event handler error:",i)}})}emitPoolStatus(){this.emitGlobal({type:"pool_status_changed",payload:{running:this.runningTasks.size,queued:this.taskQueue.length,maxConcurrent:this.maxConcurrent}})}getSessionRuntime(e){return this.sessions.get(e)}getSessionMessages(e){return this.sessionStates.get(e)?.getSessions()||[]}getSessionState(e){return this.sessionStates.get(e)}getAllSessions(){return Array.from(this.sessions.values())}getRunningSessions(){return this.getAllSessions().filter(e=>e.status==="running")}getFailedSessions(){return this.getAllSessions().filter(e=>e.status==="failed")}getUnreadSessions(){return this.getAllSessions().filter(e=>e.unreadCount>0)}getPoolStatus(){return{running:this.runningTasks.size,queued:this.taskQueue.length,maxConcurrent:this.maxConcurrent,available:this.maxConcurrent-this.runningTasks.size}}exportToMarkdown(e){const t=this.sessionStates.get(e);return t?Pt.sessionsToMarkdown(t.getSessions()):""}setMaxConcurrent(e){if(e<1)throw new Error("maxConcurrent must be at least 1");const t=this.maxConcurrent;this.maxConcurrent=e,console.log(`[SessionRegistry] maxConcurrent changed: ${t} -> ${e}`),this.emitPoolStatus(),e>t&&this.processQueue()}startAutoCleanup(e=ve.CLEANUP_INTERVAL){const t=setInterval(()=>{this.cleanupIdleSessions()},e);return()=>clearInterval(t)}cleanupIdleSessions(e=ve.SESSION_IDLE_TIMEOUT){const t=Date.now();let s=0;for(const[n,i]of this.sessions)n!==this.activeSessionId&&(i.status==="running"||i.status==="queued"||i.unreadCount>0||t-i.lastActiveTime>e&&(this.unregisterSession(n,{force:!0}).catch(console.error),s++));return s>0&&console.log(`[SessionRegistry] Cleaned up ${s} idle sessions`),s}getMemoryEstimate(){let e=0;for(const s of this.sessionStates.values())e+=s.getSessions().length;const t=e*10/1024;return{sessions:this.sessions.size,messages:e,estimatedMB:Math.round(t*100)/100}}getSessionSnapshot(e){const t=this.sessions.get(e),s=this.sessionStates.get(e),n=t?.status||"idle";return{runtime:t,sessions:s?.getSessions()||[],status:n,isRunning:n==="running"||n==="queued"}}async destroy(){for(const e of this.runningTasks.values())e.abortController.abort();this.runningTasks.clear(),this.taskQueue=[],this.sessions.clear(),this.sessionStates.clear(),this.sessionListeners.clear(),this.globalListeners.clear(),this.initialized=!1,console.log("[SessionRegistry] Destroyed")}debug(){console.group("[SessionRegistry] Debug Info"),console.log("Initialized:",this.initialized),console.log("Registered Sessions:",this.sessions.size),console.log("Active Session:",this.activeSessionId),console.log("Running Tasks:",this.runningTasks.size),console.log("Queued Tasks:",this.taskQueue.length),console.log("Max Concurrent:",this.maxConcurrent),console.group("Sessions:");for(const[e,t]of this.sessions){const s=this.sessionStates.get(e);console.log(`  ${e}: status=${t.status}, messages=${s?.getSessions().length||0}, unread=${t.unreadCount}`)}console.groupEnd(),console.groupEnd()}}function St(){return de.getInstance()}class yo{registry;sessionId=null;nodeId=null;eventUnsubscribe=null;bindingVersion=0;constructor(e={}){this.registry=St()}async bindSession(e,t){const s=++this.bindingVersion;this.unbindSession(),this.bindingVersion=s;try{if(await this.registry.registerSession(e,t),this.bindingVersion!==s)throw console.log("[SessionManager] Bind cancelled (stale version)"),this.registry.unregisterSession(t,{keepInBackground:!0}).catch(()=>{}),new C(P.ABORTED,"Bind cancelled");return this.nodeId=e,this.sessionId=t,this.registry.setActiveSession(t),console.log(`[SessionManager] Bound to session: ${t}`),this.getSnapshot()}catch(n){throw console.error("[SessionManager] Bind failed:",n),C.from(n)}}getSnapshot(){if(!this.sessionId||!this.nodeId)return{sessionId:"",nodeId:"",sessions:[],status:"idle",isRunning:!1};const t=this.registry.getSessionRuntime(this.sessionId)?.status||"idle";return{sessionId:this.sessionId,nodeId:this.nodeId,sessions:this.registry.getSessionMessages(this.sessionId),status:t,isRunning:t==="running"||t==="queued"}}unbindSession(){this.bindingVersion++,this.eventUnsubscribe&&(this.eventUnsubscribe(),this.eventUnsubscribe=null),this.sessionId=null,this.nodeId=null}async loadSession(e,t){await this.bindSession(e,t)}onEvent(e){return this.sessionId?(this.eventUnsubscribe&&this.eventUnsubscribe(),this.eventUnsubscribe=this.registry.onSessionEvent(this.sessionId,e),this.eventUnsubscribe):()=>{}}getSessions(){return this.sessionId?this.registry.getSessionMessages(this.sessionId):[]}getCurrentSessionId(){return this.sessionId}getCurrentNodeId(){return this.nodeId}getStatus(){return this.sessionId?this.registry.getSessionRuntime(this.sessionId)?.status||"idle":"unbound"}isGenerating(){if(!this.sessionId)return!1;const e=this.registry.getSessionRuntime(this.sessionId);return e?.status==="running"||e?.status==="queued"}hasUnsavedChanges(){return!1}async runUserQuery(e,t,s,n){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");await this.registry.submitTask(this.sessionId,{text:e,files:t,executorId:s,overrides:n})}abort(){this.sessionId&&this.registry.abortSession(this.sessionId).catch(console.error)}async deleteMessage(e,t){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");const s={mode:"soft",cascade:!1,deleteAssociatedResponses:!0,...t};await this.registry.deleteMessage(this.sessionId,e,s)}async updateContent(e,t,s){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");await this.registry.editMessage(this.sessionId,e,t,!1)}async editMessage(e,t,s=!1){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");await this.registry.editMessage(this.sessionId,e,t,s)}async retryGeneration(e,t){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");await this.registry.retryGeneration(this.sessionId,e,{agentId:t?.agentId,preserveCurrent:t?.preserveCurrent??!0})}async resendUserMessage(e){if(!this.sessionId)throw new C(P.SESSION_INVALID,"No session bound");await this.registry.resendUserMessage(this.sessionId,e)}canDeleteMessage(e){return this.isGenerating()?{allowed:!1,reason:"Cannot delete while generating"}:{allowed:!0}}canRetry(e){return this.isGenerating()?{allowed:!1,reason:"Already generating"}:{allowed:!0}}canEdit(e){return this.isGenerating()?{allowed:!1,reason:"Cannot edit while generating"}:{allowed:!0}}async getSiblings(e){return this.sessionId?await this.registry.getNodeSiblings(this.sessionId,e):[]}async switchToSibling(e,t){!this.sessionId||!this.nodeId||await this.registry.switchToSibling(this.nodeId,this.sessionId,e,t)}async getAvailableExecutors(){return this.registry.getAvailableExecutors()}exportToMarkdown(){return this.sessionId?this.registry.exportToMarkdown(this.sessionId):""}destroy(){this.unbindSession()}}class vo{locks=new Map;waitQueues=new Map;async acquire(e,t){for(;this.locks.has(e);)await new Promise(i=>{const a=this.waitQueues.get(e)||[];a.push(i),this.waitQueues.set(e,a)});let s;const n=new Promise(i=>{s=i});this.locks.set(e,n);try{return await t()}finally{this.locks.get(e)===n&&this.locks.delete(e);const i=this.waitQueues.get(e);if(i&&i.length>0){const a=i.shift();i.length===0&&this.waitQueues.delete(e),a?.()}s()}}}const bo=typeof process<"u"&&!1,ie=(...l)=>bo;class wo extends Kt{lockManager=new vo;constructor(e){super(es,{description:"Chat Sessions"},e)}async onLoad(){}getHiddenDir(e){return`/.${e}`}getNodePath(e,t){return`${this.getHiddenDir(e)}/.${t}.json`}async createSession(e,t="You are a helpful assistant."){const s=F(),n=new Date().toISOString();await this.engine.createDirectory(this.getHiddenDir(s),null);const i=`node-${Date.now()}-root`,a={id:i,type:"message",role:"system",content:t,created_at:n,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(s,i),a);const o={version:"1.0",id:s,title:e,created_at:n,updated_at:n,settings:{model:"gpt-4",temperature:.7},branches:{main:i},current_branch:"main",current_head:i,root_id:i};return await this.engine.createFile(`${e}.chat`,null,JSON.stringify(o,null,2),{title:e,icon:""}),this.notify(),s}async initializeExistingFile(e,t,s="You are a helpful assistant."){try{const n=await this.engine.readContent(e);if(n){const i=typeof n=="string"?n:new TextDecoder().decode(n);let a;try{a=JSON.parse(i)}catch(h){return ie("Manifest JSON parse failed, will reinitialize:",h),await this.createNewSessionStructure(e,t,s)}if(!this.isValidManifest(a))return ie("Invalid manifest structure, will reinitialize"),await this.createNewSessionStructure(e,t,s);const o=this.getHiddenDir(a.id);if(!await this.engine.resolvePath(o))return ie(`Hidden directory missing for session ${a.id}, rebuilding...`),await this.rebuildSessionStructure(e,a,s);const c=this.getNodePath(a.id,a.root_id);return await this.readJson(c)?(ie(`Existing valid session found: ${a.id}`),a.id):(ie("Root node missing, rebuilding session structure"),await this.rebuildSessionStructure(e,a,s))}}catch{}return await this.createNewSessionStructure(e,t,s)}isValidManifest(e){return e&&typeof e.id=="string"&&typeof e.root_id=="string"&&typeof e.current_branch=="string"&&typeof e.current_head=="string"&&e.branches&&typeof e.branches[e.current_branch]=="string"}async createNewSessionStructure(e,t,s){const n=F(),i=new Date().toISOString();await this.engine.createDirectory(this.getHiddenDir(n),null);const a=`node-${Date.now()}-root`,o={id:a,type:"message",role:"system",content:s,created_at:i,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(n,a),o);const r={version:"1.0",id:n,title:t,created_at:i,updated_at:i,settings:{model:"gpt-4",temperature:.7},branches:{main:a},current_branch:"main",current_head:a,root_id:a};return await this.engine.writeContent(e,JSON.stringify(r,null,2)),await this.engine.updateMetadata(e,{title:t,icon:"",sessionId:n}),this.notify(),n}async rebuildSessionStructure(e,t,s){const n=t.id,i=new Date().toISOString(),a=this.getHiddenDir(n);try{const d=await this.engine.resolvePath(a);d&&await this.engine.delete([d])}catch{}await this.engine.createDirectory(a,null);const o=`node-${Date.now()}-root`,r={id:o,type:"message",role:"system",content:s,created_at:i,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(n,o),r);const c={...t,root_id:o,branches:{main:o},current_branch:"main",current_head:o,updated_at:i};return await this.engine.writeContent(e,JSON.stringify(c,null,2)),this.notify(),n}async getSessionContext(e,t){const s=await this.getManifest(e);if(!s)throw new Error("Manifest missing");const n=[];let i=s.current_head;for(;i;){const a=await this.readJson(this.getNodePath(t,i));if(!a)break;n.push(a),i=a.parent_id}return n.reverse().filter(a=>a.status==="active").map((a,o)=>({node:a,depth:o}))}async getManifest(e){try{const t=await this.engine.readContent(e);if(!t)throw new Error("Empty file content");const s=typeof t=="string"?t:new TextDecoder().decode(t);return JSON.parse(s)}catch(t){throw console.error(`[LLMSessionEngine] Failed to read manifest from node ${e}`,t),new Error(`Manifest missing for node: ${e}`)}}async getUIState(e){try{return(await this.getManifest(e)).ui_state||null}catch(t){return console.warn("[LLMSessionEngine] getUIState failed:",t),null}}async updateUIState(e,t){return this.lockManager.acquire(`uistate:${e}`,async()=>{try{const s=await this.getManifest(e);s.ui_state={...s.ui_state,...t,collapse_states:{...s.ui_state?.collapse_states,...t.collapse_states}},s.updated_at=new Date().toISOString(),await this.engine.writeContent(e,JSON.stringify(s,null,2))}catch(s){if(s.message?.includes("not found")||s.message?.includes("Node not found")||s.message?.includes("Manifest missing")){console.log(`[LLMSessionEngine] Node ${e} no longer exists, UI state update skipped`);return}throw s}})}async appendMessage(e,t,s,n,i={}){return this.lockManager.acquire(`session:${t}`,async()=>{const a=await this.getManifest(e),o=a.current_head,r=F(),c=new Date().toISOString(),d={id:r,type:"message",role:s,content:n,created_at:c,parent_id:o,children_ids:[],meta:i,status:"active"};if(await this.writeJson(this.getNodePath(t,r),d),o){const h=await this.readJson(this.getNodePath(t,o));h&&(h.children_ids||(h.children_ids=[]),h.children_ids.push(r),await this.writeJson(this.getNodePath(t,o),h))}if(s==="user"){let h=!1;const u={};if((!a.summary||a.summary==="New conversation")&&(a.summary=n.substring(0,100).replace(/[\r\n]+/g," ").trim()),new Set(["New Chat","Untitled","New conversation"]).has(a.title)){let p=n.substring(0,30).replace(/[\r\n]+/g," ").trim();p.length===0&&(p="Chat"),a.title=p,u.title=p,h=!0}if(h)try{await this.engine.updateMetadata(e,u)}catch(p){console.warn(`[LLMSessionEngine] Failed to update metadata for ${e}`,p)}}return a.current_head=r,a.branches[a.current_branch]=r,a.updated_at=c,await this.engine.writeContent(e,JSON.stringify(a,null,2)),r})}async updateNode(e,t,s){return this.lockManager.acquire(`node:${e}:${t}`,async()=>{const n=this.getNodePath(e,t),i=await this.readJson(n);if(!i){console.warn(`[LLMSessionEngine] Node ${t} not found, skipping update`);return}let a=!1;s.content!==void 0&&s.content!==i.content&&(i.content=s.content,a=!0),s.status!==void 0&&s.status!==i.status&&(i.status=s.status,a=!0),s.meta&&(i.meta={...i.meta,...s.meta},a=!0),a&&await this.writeJson(n,i)})}async deleteMessage(e,t){const s=this.getNodePath(e,t),n=await this.readJson(s);n&&(n.status="deleted",await this.writeJson(s,n))}async editMessage(e,t,s,n){return this.lockManager.acquire(`session:${t}`,async()=>{const i=await this.getManifest(e),a=await this.readJson(this.getNodePath(t,s));if(!a)throw new Error("Original node not found");const o=F(),r=new Date().toISOString(),c={...a,id:o,content:n,created_at:r,children_ids:[]};if(await this.writeJson(this.getNodePath(t,o),c),c.parent_id){const d=await this.readJson(this.getNodePath(t,c.parent_id));d&&(d.children_ids.push(o),await this.writeJson(this.getNodePath(t,c.parent_id),d))}return i.current_head=o,i.branches[i.current_branch]=o,i.updated_at=r,await this.engine.writeContent(e,JSON.stringify(i,null,2)),o})}async switchBranch(e,t,s){return this.lockManager.acquire(`session:${t}`,async()=>{const n=await this.getManifest(e);if(!n.branches[s])throw new Error("Branch not found");n.current_branch=s,n.current_head=n.branches[s],n.updated_at=new Date().toISOString(),await this.engine.writeContent(e,JSON.stringify(n,null,2))})}async getNodeSiblings(e,t){const s=await this.readJson(this.getNodePath(e,t));if(!s||!s.parent_id)return s?[s]:[];const n=await this.readJson(this.getNodePath(e,s.parent_id));return n?(await Promise.all(n.children_ids.map(a=>this.readJson(this.getNodePath(e,a))))).filter(a=>a!==null&&a.status==="active"):[s]}async getSessionIdFromNodeId(e){try{return(await this.getManifest(e)).id||null}catch(t){return console.error("[LLMSessionEngine] getSessionIdFromNodeId failed:",t),null}}async loadTree(){return(await this.engine.loadTree()).filter(t=>t.name.startsWith(".")?!1:t.type==="file"?t.name.endsWith(".chat"):t.type==="directory")}async createDirectory(e,t){return this.engine.createDirectory(e,t)}async createFile(e,t,s){const n=(e||"New Chat").replace(/\.chat$/i,""),i=await this.findAvailableFileName(n,t),a=F(),o=new Date().toISOString();try{await this.engine.createDirectory(this.getHiddenDir(a),null)}catch(p){if(!p.message?.includes("exists"))throw p}const r=`node-${Date.now()}-root`,c={id:r,type:"message",role:"system",content:"You are a helpful assistant.",created_at:o,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(a,r),c);const h=JSON.stringify({version:"1.0",id:a,title:i,created_at:o,updated_at:o,settings:{model:"gpt-4",temperature:.7},branches:{main:r},current_branch:"main",current_head:r,root_id:r},null,2),u=`${i}.chat`,g=await this.engine.createFile(u,t,h,{title:i,icon:"",sessionId:a});return this.notify(),g}async findAvailableFileName(e,t){const n=new Set;try{let a;t?a=await this.engine.getChildren(t):a=(await this.engine.loadTree()).filter(r=>!r.parentId||r.parentId===null),a.forEach(o=>{o.name.endsWith(".chat")&&n.add(o.name.replace(/\.chat$/i,"").toLowerCase())})}catch{}if(!n.has(e.toLowerCase()))return e;for(let a=1;a<=100;a++){const o=`${e} (${a})`;if(!n.has(o.toLowerCase()))return o}return`${e}_${F().substring(0,8)}`}async rename(e,t){const s=await this.vfs.getNodeById(e);if(!s)throw new Error("Node not found");try{const n=await this.getManifest(e);n.title=t,n.updated_at=new Date().toISOString(),await this.engine.writeContent(e,JSON.stringify(n,null,2))}catch(n){console.warn("Failed to update manifest title",n)}await this.engine.updateMetadata(e,{...s.metadata,title:t})}async delete(e){const t=async s=>{const n=await this.vfs.getNodeById(s);if(!n)return;const i=n.type===w.DIRECTORY,a=n.type===w.FILE;if(i){const o=await this.engine.getChildren(s);for(const r of o)await t(r.id)}else if(a&&n.name.endsWith(".chat"))try{const o=await this.engine.readContent(s);if(o){const r=typeof o=="string"?o:new TextDecoder().decode(o),c=JSON.parse(r);if(c.id){const d=this.getHiddenDir(c.id),h=await this.engine.resolvePath(d);h&&(await this.engine.delete([h]),ie(`Cleaned up hidden data for session ${c.id}`))}}}catch(o){console.warn(`[LLMSessionEngine] Failed to cleanup data for ${n.name}`,o)}};for(const s of e)await t(s);await this.engine.delete(e),this.notify()}async search(e){return(await this.engine.search(e)).filter(s=>s.type==="file"&&s.name.endsWith(".chat"))}async createAsset(e,t,s){return this.engine.createAsset(e,t,s)}async getAssetDirectoryId(e){return this.engine.getAssetDirectoryId(e)}async getAssets(e){return this.engine.getAssets(e)}async readSessionAsset(e,t){const s=t.startsWith("./")?t.slice(2):t,n=`${this.getHiddenDir(e)}/${s}`;try{const i=await this.engine.resolvePath(n);if(!i)return null;const a=await this.engine.readContent(i);if(!a)return null;const o=Ie(s);return new Blob([a],{type:o})}catch(i){return console.warn(`[LLMSessionEngine] Failed to read asset: ${n}`,i),null}}async getChildren(e){return this.engine.getChildren(e)}async readContent(e){return this.engine.readContent(e)}async getNode(e){return this.engine.getNode(e)}async writeContent(e,t){return this.engine.writeContent(e,t)}async move(e,t){return this.engine.move(e,t)}async updateMetadata(e,t){return this.engine.updateMetadata(e,t)}async setTags(e,t){return this.engine.setTags(e,t)}async setTagsBatch(e){return this.engine.setTagsBatch(e)}async getAllTags(){return this.engine.getAllTags()}on(e,t){return this.engine.on(e,t)}}const Ot="/.defaults_version.json",Y="/.connections",ae="/.mcp";class So extends Kt{_connections=[];_mcpServers=[];_syncTimer=null;_eventUnsubscribers=[];constructor(e){super(dt,{description:"AI Agents Configuration"},e)}async onLoad(){await this.refreshData(),this.bindVFSEvents(),await this.ensureDefaults()}bindVFSEvents(){const e=[R.NODE_CREATED,R.NODE_UPDATED,R.NODE_DELETED],t=s=>{const n=s.path||"",i=`/${this.moduleName}`;if(!n.startsWith(i))return;const a=n.slice(i.length),o=a.startsWith(Y),r=a.startsWith(ae),c=a.endsWith(".agent");(o||r||c)&&(this._syncTimer&&clearTimeout(this._syncTimer),this._syncTimer=setTimeout(async()=>{await this.refreshData()},300))};e.forEach(s=>{const n=this.vfs.on(s,t);this._eventUnsubscribers.push(n)})}async refreshData(){try{this._connections=await this.loadJsonFiles(Y),this._mcpServers=await this.loadJsonFiles(ae),this.notify()}catch(e){console.error("[VFSAgentService] Failed to refresh data",e)}}async ensureDefaults(){try{const e=await this.readJson(Ot);if(e&&e.version>=We){console.log("[VFSAgentService] Defaults are up to date, skipping sync.");return}console.log(`[VFSAgentService] Syncing defaults from version ${e?.version||0} to ${We}...`),await this.syncDefaultConnections(),await this.syncDefaultAgents(),await this.writeJson(Ot,{version:We,updatedAt:Date.now()}),await this.refreshData(),console.log("[VFSAgentService] Defaults sync completed.")}catch(e){console.error("[VFSAgentService] ensureDefaults error:",e)}}async syncDefaultConnections(){await this.ensureDirectory(Y);const e=await this.loadJsonFiles(Y),t=new Map;for(const i of e)t.set(i.provider,i);const n=Object.keys(W)[0];for(const[i,a]of Object.entries(W)){const o=t.get(i);if(o){const r=JSON.parse(JSON.stringify(o));r.availableModels||(r.availableModels=[]);const c=new Set(r.availableModels.map(h=>h.id));let d=!1;for(const h of a.models)c.has(h.id)||(r.availableModels.push({...h}),d=!0,console.log(`[VFSAgentService] Added new model "${h.id}" to connection "${o.id}"`));d&&await this.saveConnection(r)}else{const r={id:i===n?"default":`conn-${i}`,name:a.name,provider:i,apiKey:"",baseURL:a.baseURL,model:a.models[0]?.id||"",availableModels:[...a.models],metadata:{isSystemDefault:!0}};await this.saveConnection(r),console.log(`[VFSAgentService] Created new connection: ${r.id} (${i})`)}}}async syncDefaultAgents(){const e=this.getDefaultConnectionId(),t=await this.getAgents(),s=new Set(t.map(n=>n.id));for(const n of we){if(s.has(n.id))continue;const i=`${n.id}.agent`,a=n.initPath||nt,o=`${a}/${i}`.replace(/\/+/g,"/");if(await this.engine.pathExists(o))continue;const{initPath:c,initialTags:d,...h}=n;h.config.connectionId||(h.config.connectionId=e);try{await this.ensureDirectory(a);const u=await this.engine.createFile(i,a,JSON.stringify(h,null,2),{icon:n.icon||"",title:n.name,description:n.description});d&&d.length>0&&u?.id&&await this.engine.setTags(u.id,d),console.log(`[VFSAgentService] Created default agent: ${n.id} at ${o}`)}catch(u){console.error(`[VFSAgentService] Failed to create agent ${n.id}:`,u)}}}getDefaultConnectionId(){return we&&we.length>0&&we[0].config.connectionId||"default"}async resolveModelName(e,t){const s=await this.getConnection(e);if(!s||!s.availableModels||s.availableModels.length===0)return t||"";const n=s.availableModels[0].id;return t&&s.availableModels.some(a=>a.id===t)?t:n}async getAgents(){const e=[];try{const t={text:".agent",type:"file"},n=(await this.engine.search(t)).map(async a=>{if(!a.name.endsWith(".agent"))return null;try{const o=await this.engine.readContent(a.id);if(!o)return null;const r=typeof o=="string"?o:new TextDecoder().decode(o),c=JSON.parse(r);if(c.config.modelId&&!c.config.modelName&&(c.config.modelName=c.config.modelId),c.id)return{...c,tags:a.tags}}catch{}return null});(await Promise.all(n)).forEach(a=>a&&e.push(a))}catch(t){console.error("[VFSAgentService] Failed to scan agents:",t)}return e}async getAgentConfig(e){let s=(await this.getAgents()).find(n=>n.id===e);if(!s&&e==="default"&&(s=this.createDefaultAgentDefinition()),s){s.config.connectionId||(s.config.connectionId=this.getDefaultConnectionId());const n=await this.resolveModelName(s.config.connectionId,s.config.modelName);return n!==s.config.modelName&&(s.config.modelName=n),s}return null}async saveAgent(e){e.config.connectionId||(e.config.connectionId=this.getDefaultConnectionId()),e.config.modelName=await this.resolveModelName(e.config.connectionId,e.config.modelName);const t=`${e.id}.agent`,s=JSON.stringify(e,null,2),n={icon:e.icon||"",title:e.name,description:e.description},i={text:t,type:"file"},o=(await this.engine.search(i)).find(r=>r.name===t);o?(await this.engine.writeContent(o.id,s),await this.engine.updateMetadata(o.id,n)):await this.engine.createFile(t,null,s,n),this.notify()}async deleteAgent(e){const t=`${e}.agent`,s={text:t,type:"file"},i=(await this.engine.search(s)).find(a=>a.name===t);i&&(await this.engine.delete([i.id]),this.notify())}async getConnections(){return[...this._connections]}async getConnection(e){return this._connections.find(t=>t.id===e)}async getDefaultConnection(){return this._connections.length===0?null:this._connections.find(t=>t.id==="default")||this._connections[0]}async saveConnection(e){const t=`${e.id}.json`,s=JSON.stringify(e,null,2),n=`${Y}/${t}`;await this.ensureDirectory(Y);const i=await this.engine.resolvePath(n);i?(await this.engine.writeContent(i,s),await this.engine.updateMetadata(i,{icon:"",title:e.name,type:"connection"})):await this.engine.createFile(t,Y,s,{icon:"",title:e.name,type:"connection"});const a=this._connections.findIndex(o=>o.id===e.id);a>=0?this._connections[a]=e:this._connections.push(e),this.notify()}async deleteConnection(e){if(e==="default")throw new Error("Cannot delete default connection");const t=`${Y}/${e}.json`,s=await this.engine.resolvePath(t);s&&await this.engine.delete([s]),this._connections=this._connections.filter(n=>n.id!==e),this.notify()}async getMCPServers(){return[...this._mcpServers]}async saveMCPServer(e){const t=`${e.id}.json`,s=JSON.stringify(e,null,2),n=`${ae}/${t}`;await this.ensureDirectory(ae);const i=await this.engine.resolvePath(n);i?(await this.engine.writeContent(i,s),await this.engine.updateMetadata(i,{icon:"",title:e.name,type:"mcp"})):await this.engine.createFile(t,ae,s,{icon:"",title:e.name,type:"mcp"});const a=this._mcpServers.findIndex(o=>o.id===e.id);a>=0?this._mcpServers[a]=e:this._mcpServers.push(e),this.notify()}async deleteMCPServer(e){const t=`${ae}/${e}.json`,s=await this.engine.resolvePath(t);s&&await this.engine.delete([s]),this._mcpServers=this._mcpServers.filter(n=>n.id!==e),this.notify()}async dispose(){this._eventUnsubscribers.forEach(e=>e()),this._eventUnsubscribers=[],this._syncTimer&&(clearTimeout(this._syncTimer),this._syncTimer=null),await super.dispose()}async loadJsonFiles(e){const t=[];try{const s=await this.engine.resolvePath(e);if(!s)return[];const n=await this.engine.getChildren(s);for(const i of n)if(i.type==="file"&&i.name.endsWith(".json"))try{const a=await this.engine.readContent(i.id),o=typeof a=="string"?a:new TextDecoder().decode(a);t.push(JSON.parse(o))}catch(a){console.warn(`[VFSAgentService] Failed to parse ${i.name}`,a)}}catch{}return t}createDefaultAgentDefinition(){return{id:"default",name:"Default Assistant",type:"agent",icon:"",description:"Built-in default assistant",config:{connectionId:this.getDefaultConnectionId(),modelName:"",systemPrompt:"You are a helpful assistant."}}}}const Eo=l=>{try{const e=JSON.parse(l);return{summary:e.summary||"",searchableText:`${e.title} ${e.summary||""} ${e.id}`.toLowerCase(),metadata:{...e.settings,type:"chat",updatedAt:e.updated_at,messageCount:Object.keys(e.branches||{}).length}}}catch(e){return console.warn("[chatFileParser] Parse failed:",e),{summary:"Parse error",metadata:{type:"chat"}}}};async function _o(l){await ho({plugins:l.plugins,config:l.config}),await l.agentService.init(),await l.sessionEngine.init();const e=St();return e.initialize(l.agentService,l.sessionEngine,{maxConcurrent:l.maxConcurrent}),console.log("[LLM Engine] Initialized"),{registry:e}}class xo{container;historyView;chatInput;printService=null;sessionManager;registry;listeners=new Map;globalEventUnsubscribe=null;sessionEventUnsubscribe=null;titleInput;statusIndicator;assetManagerUI=null;currentTitle="New Chat";isAllExpanded=!0;currentSessionId=null;options;initPromise=null;initResolve=null;initReject=null;collapseStatesCache={};isBeingDeleted=!1;uiStateSaveTimer=null;UI_STATE_SAVE_DEBOUNCE=2e3;inputStateSaveTimer=null;INPUT_STATE_SAVE_DEBOUNCE=1e3;floatingNav=null;globalShortcutHandler=null;get hostContext(){return this.options.hostContext}get engine(){return this.options.sessionEngine}constructor(e,t){this.options=t,this.registry=St(),this.sessionManager=new yo,t.title&&(this.currentTitle=t.title)}async init(e,t){this.container=e,this.container.classList.add("llm-ui-workspace"),this.initPromise=new Promise((s,n)=>{this.initResolve=s,this.initReject=n});try{this.renderLayout(),await this.initComponents(),this.bindTitleBarEvents(),this.bindGlobalEvents(),await this.loadSessionFromEngine(t),this.emit("ready"),this.initResolve?.()}catch(s){throw console.error("[LLMWorkspaceEditor] init failed:",s),this.initReject?.(s),s}}async initComponents(){const e=this.container.querySelector("#llm-ui-history"),t=this.container.querySelector("#llm-ui-input");this.historyView=new Ha(e,(a,o,r)=>this.handleContentChange(a,o,r),(a,o)=>this.handleNodeAction(a,o),{nodeId:this.options.nodeId,ownerNodeId:this.options.ownerNodeId||this.options.nodeId,sessionEngine:this.options.sessionEngine,onCollapseStateChange:a=>this.scheduleUIStateSave(a),initialCollapseStates:this.collapseStatesCache});let s;try{const a=await this.engine.getUIState(this.options.nodeId);a?.input_state?.settings&&!this.options.isNewSession&&(s=a.input_state.settings,a.collapse_states&&(this.collapseStatesCache=a.collapse_states))}catch(a){console.warn("[LLMWorkspaceEditor] Failed to pre-load UI state:",a)}let n=[];try{n=(await this.options.agentService.getAgents()).map(c=>({id:c.id,name:c.name,icon:c.icon,category:c.type==="agent"?"Agents":c.type==="workflow"?"Workflows":"Other",description:c.description})),n.some(c=>c.id==="default")||n.unshift({id:"default",name:"Default Assistant",icon:"",category:"System"});const r=new Set;n=n.filter(c=>r.has(c.id)?!1:(r.add(c.id),!0))}catch(a){console.warn("[LLMWorkspaceEditor] Failed to get initial agents:",a),n=[{id:"default",name:"Default Assistant",icon:"",category:"System"}]}const i=await this.loadAvailableModels();this.chatInput=new za(t,{onSend:(a,o,r,c)=>this.handleUserSend(a,o,r,c),onStop:()=>this.sessionManager.abort(),initialAgents:n,initialModels:i,initialSettings:s,onInputChange:()=>this.scheduleInputStateSave(),onExecutorChange:a=>{this.scheduleInputStateSave(),this.updateModelsForAgent(a)},onSettingsChange:a=>this.handleChatSettingsChange(a)}),this.bindNavigationEvents()}async loadAvailableModels(){const e=[];try{const t=await this.options.agentService.getConnections();for(const s of t)if(s.availableModels&&s.availableModels.length>0)for(const n of s.availableModels)e.push({id:n.id,name:n.name,provider:s.name,description:n.supportsThinking?"Supports extended thinking":void 0});console.log(`[LLMWorkspaceEditor] Loaded ${e.length} models from ${t.length} connections`)}catch(t){console.warn("[LLMWorkspaceEditor] Failed to load models:",t)}return e}async updateModelsForAgent(e){try{const t=await this.options.agentService.getAgentConfig(e);if(t?.config.connectionId){const s=await this.options.agentService.getConnection(t.config.connectionId);if(s?.availableModels){const n=s.availableModels.map(i=>({id:i.id,name:i.name,provider:s.name}));this.chatInput.updateModels(n)}}}catch(t){console.warn("[LLMWorkspaceEditor] Failed to update models for agent:",t)}}async handleChatSettingsChange(e){console.log("[LLMWorkspaceEditor] Chat settings changed:",e),this.scheduleInputStateSave()}bindNavigationEvents(){this.container.addEventListener("open-connection-settings",()=>{console.log("[LLMWorkspaceEditor] Requesting to open connection settings..."),this.hostContext?.navigate?this.hostContext.navigate({target:"settings",resourceId:"connections"}):console.warn("[LLMWorkspaceEditor] Host does not support navigation")}),this.container.addEventListener("open-agent-config",e=>{const t=e.detail?.agentId;t&&this.hostContext?.navigate&&this.hostContext.navigate({target:"agents",resourceId:t})})}async loadSessionFromEngine(e){if(!this.options.nodeId)throw new Error("[LLMWorkspaceEditor] nodeId is required.");let t=null;try{t=await this.options.sessionEngine.getSessionIdFromNodeId(this.options.nodeId)}catch(n){console.warn("[LLMWorkspaceEditor] Error reading manifest:",n)}t||(console.log("[LLMWorkspaceEditor] Initializing file structure..."),t=await this.options.sessionEngine.initializeExistingFile(this.options.nodeId,this.currentTitle)),this.currentSessionId=t,this.sessionEventUnsubscribe&&(this.sessionEventUnsubscribe(),this.sessionEventUnsubscribe=null);const s=await this.sessionManager.bindSession(this.options.nodeId,t);try{const n=await this.engine.getManifest(this.options.nodeId);n.title&&(this.currentTitle=n.title,this.titleInput.value=n.title)}catch(n){console.warn("[LLMWorkspaceEditor] Failed to load manifest:",n)}await this.restoreUIState(),s.sessions.length>0?this.historyView.renderFull(s.sessions):this.historyView.renderWelcome(),this.sessionEventUnsubscribe=this.sessionManager.onEvent(n=>this.handleSessionEvent(n)),this.updateStatusFromSnapshot(s),console.log(`[LLMWorkspaceEditor] Session loaded: ${t}, messages: ${s.sessions.length}, status: ${s.status}, collapseStates: ${Object.keys(this.collapseStatesCache).length}`)}async restoreUIState(){let e=null;try{e=await this.engine.getUIState(this.options.nodeId)}catch(t){console.warn("[LLMWorkspaceEditor] Failed to load UI state:",t)}e?.collapse_states&&Object.keys(this.collapseStatesCache).length===0&&(this.collapseStatesCache=e.collapse_states,this.historyView.setCollapseStates(this.collapseStatesCache),console.log("[LLMWorkspaceEditor] Restored collapse states from file")),this.restoreInputState(e?.input_state)}restoreInputState(e){if(!this.chatInput)return;if(this.options.initialInputState){this.chatInput.setState({text:this.options.initialInputState.text||"",agentId:this.options.initialInputState.agentId||"default"}),console.log("[LLMWorkspaceEditor] Applied options.initialInputState");return}const t=this.getAndClearCreateParams();if(t){this.chatInput.setState({text:t.text||"",agentId:t.agentId||"default"}),console.log("[LLMWorkspaceEditor] Applied sessionStorage create params",t);return}if(!this.options.isNewSession&&e){this.chatInput.setState({text:e.text,agentId:e.agentId}),console.log("[LLMWorkspaceEditor] Restored saved input state",e);return}console.log("[LLMWorkspaceEditor] Using default input state")}getAndClearCreateParams(){const e="app_create_params",t=sessionStorage.getItem(e);if(!t)return null;try{const s=JSON.parse(t),n=s.timestamp&&Date.now()-s.timestamp<5*60*1e3,i=!s.target||s.target==="chat"||s.target==="llm-workspace";return sessionStorage.removeItem(e),n&&i?{agentId:s.agentId,text:s.text}:null}catch{return sessionStorage.removeItem(e),null}}updateStatusFromSnapshot(e){this.updateStatusIndicatorFromStatus(e.status),e.isRunning&&(this.chatInput.setLoading(!0),this.historyView.enterStreamingMode())}updateStatusIndicatorFromStatus(e){if(!this.statusIndicator)return;const t=this.statusIndicator.querySelector(".llm-workspace-status__dot"),s=this.statusIndicator.querySelector(".llm-workspace-status__text");switch(t?.classList.remove("--running","--queued","--completed","--failed","--idle"),e){case"running":t?.classList.add("--running"),s.textContent="Generating...",this.chatInput.setLoading(!0);break;case"queued":t?.classList.add("--queued"),s.textContent="Queued",this.chatInput.setLoading(!0);break;case"completed":t?.classList.add("--completed"),s.textContent="Ready",this.chatInput.setLoading(!1);break;case"failed":t?.classList.add("--failed"),s.textContent="Error",this.chatInput.setLoading(!1);break;default:t?.classList.add("--idle"),s.textContent="Ready",this.chatInput.setLoading(!1)}}scheduleUIStateSave(e){this.collapseStatesCache=e,!this.sessionManager.isGenerating()&&(this.uiStateSaveTimer&&clearTimeout(this.uiStateSaveTimer),this.uiStateSaveTimer=setTimeout(async()=>{this.sessionManager.isGenerating()||await this.saveUIState()},this.UI_STATE_SAVE_DEBOUNCE))}scheduleInputStateSave(){this.sessionManager.isGenerating()||(this.inputStateSaveTimer&&clearTimeout(this.inputStateSaveTimer),this.inputStateSaveTimer=setTimeout(async()=>{this.sessionManager.isGenerating()||await this.saveUIState()},this.INPUT_STATE_SAVE_DEBOUNCE))}markAsDeleted(){this.isBeingDeleted=!0}async saveUIState(){if(this.isBeingDeleted||!this.options.nodeId)return;const e=this.chatInput?this.chatInput.getState():void 0;try{const t={collapse_states:this.collapseStatesCache,input_state:e};await this.engine.updateUIState(this.options.nodeId,t),console.log("[LLMWorkspaceEditor] UI state saved")}catch(t){if(t.message?.includes("not found")||t.message?.includes("Node not found")||t.message?.includes("Manifest missing"))return;console.warn("[LLMWorkspaceEditor] Failed to save UI state:",t)}}renderLayout(){this.container.innerHTML=`
            <div class="llm-workspace-titlebar">
                <div class="llm-workspace-titlebar__left">
                    <button class="llm-workspace-titlebar__btn" id="llm-btn-sidebar" title="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="llm-workspace-titlebar__sep"></div>
                    
                    <input type="text" class="llm-workspace-titlebar__input" id="llm-title-input" 
                           value="${S(this.currentTitle)}" placeholder="Untitled Chat" />
                    
                    <!--  -->
                    <div class="llm-workspace-status" id="llm-status-indicator">
                        <span class="llm-workspace-status__dot"></span>
                        <span class="llm-workspace-status__text">Ready</span>
                    </div>
                </div>

                <div class="llm-workspace-titlebar__right">
                    <!--  -->
                    <div class="llm-workspace-titlebar__bg-indicator" id="llm-bg-indicator" style="display:none;">
                        <span class="llm-bg-badge">2 running</span>
                    </div>
                    
                    <button class="llm-workspace-titlebar__btn" id="llm-btn-assets" title="">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-collapse" title="Collapse/Expand All">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="4 14 10 14 10 20"></polyline>
                            <polyline points="20 10 14 10 14 4"></polyline>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-copy" title="Copy as Markdown">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-navigator" title="Chat Navigator (Ctrl+G)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                            <circle cx="9" cy="12" r="2" fill="currentColor"></circle>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-print" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>

            <div class="llm-ui-workspace__history" id="llm-ui-history"></div>
            <div class="llm-ui-workspace__input" id="llm-ui-input"></div>
        `,this.titleInput=this.container.querySelector("#llm-title-input"),this.statusIndicator=this.container.querySelector("#llm-status-indicator")}getPrintService(){return this.printService||(this.printService=new gt(this.options.sessionEngine,this.options.nodeId)),this.printService}bindTitleBarEvents(){this.container.querySelector("#llm-btn-sidebar")?.addEventListener("click",()=>{this.hostContext?.toggleSidebar()}),this.titleInput.addEventListener("change",async()=>{if(this.currentTitle=this.titleInput.value,this.emit("change"),this.options.nodeId)try{await this.engine.rename(this.options.nodeId,this.currentTitle)}catch(e){console.error("[LLMWorkspaceEditor] Failed to rename:",e)}}),this.container.querySelector("#llm-btn-assets")?.addEventListener("click",async()=>{await this.handleOpenAssetManager()}),this.container.querySelector("#llm-btn-navigator")?.addEventListener("click",()=>{this.toggleNavigator()}),this.container.querySelector("#llm-btn-collapse")?.addEventListener("click",e=>{this.toggleAllBubbles(e.currentTarget)}),this.container.querySelector("#llm-btn-copy")?.addEventListener("click",async e=>{const t=e.currentTarget,s=this.sessionManager.exportToMarkdown();try{await navigator.clipboard.writeText(s),this.showButtonFeedback(t,"")}catch(n){console.error("Failed to copy",n)}}),this.container.querySelector("#llm-btn-print")?.addEventListener("click",async()=>{try{const e=this.sessionManager.exportToMarkdown();await this.getPrintService().print(e,{title:this.currentTitle||"Chat Conversation",showHeader:!0,headerMeta:{date:new Date().toLocaleString()}})}catch(e){console.error("[LLMWorkspaceEditor] Print failed:",e)}}),this.bindGlobalShortcuts()}bindGlobalEvents(){this.globalEventUnsubscribe=this.registry.onGlobalEvent(e=>{this.handleGlobalEvent(e)})}bindGlobalShortcuts(){this.globalShortcutHandler=e=>{(e.ctrlKey||e.metaKey)&&e.key==="g"&&(e.preventDefault(),this.toggleNavigator()),(e.ctrlKey||e.metaKey)&&e.shiftKey&&(e.key==="ArrowUp"?(e.preventDefault(),this.navigateToPrevUserChat()):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateToNextUserChat()))},document.addEventListener("keydown",this.globalShortcutHandler)}async handleOpenAssetManager(){const e=this.engine,t=this.options.ownerNodeId||this.options.nodeId;if(!e||!t){m.error("Engine not connected or no session");return}try{const s=await e.getAssetDirectoryId(t);if(!s){m.info("No attachments found in this chat");return}this.assetManagerUI&&this.assetManagerUI.close(),this.assetManagerUI=new Ts(e,null,{}),await this.assetManagerUI.show(s)}catch(s){console.error("[LLMWorkspaceEditor] Failed to open Asset Manager:",s),m.error("Failed to open Asset Manager")}}handleSessionEvent(e){this.historyView.processEvent(e),(e.type==="finished"||e.type==="session_start"||e.type==="error")&&console.log(`[LLMWorkspaceEditor] Session Event: ${e.type}`,e.payload),(e.type==="finished"||e.type==="session_start")&&this.emit("change"),e.type==="finished"?this.updateStatusIndicatorFromStatus("completed"):e.type==="error"&&this.updateStatusIndicatorFromStatus("failed")}handleGlobalEvent(e){switch(e.type){case"pool_status_changed":this.updateBackgroundIndicator(e.payload);break;case"session_status_changed":console.log(`[LLMWorkspaceEditor] Status Changed: ${e.payload.sessionId} -> ${e.payload.status}`),e.payload.sessionId===this.currentSessionId?this.updateStatusIndicatorFromStatus(e.payload.status):e.payload.status==="completed"&&this.showNotification("Background task completed");break}}async handleContentChange(e,t,s){try{await this.sessionManager.updateContent(e,t,s),this.emit("change")}catch(n){console.error("[LLMWorkspaceEditor] updateContent failed:",n)}}async handleNodeAction(e,t){try{switch(e){case"retry":await this.handleRetry(t);break;case"delete":await this.handleDelete(t);break;case"edit":break;case"edit-and-retry":await this.handleEditAndRetry(t);break;case"resend":await this.handleResend(t);break;case"prev-sibling":case"next-sibling":await this.handleSiblingSwitch(t,e==="prev-sibling"?"prev":"next");break}}catch(s){console.error("[LLMWorkspaceEditor] Action failed:",s),this.historyView.renderError(s)}}async handleRetry(e){const t=this.sessionManager.getSessions();let s=t.find(i=>i.id===e);if(s||(s=t.find(i=>i.executionRoot?.id===e||this.findNodeInTree(i.executionRoot,e))),!s){console.warn(`[LLMWorkspaceEditor] Cannot retry: session not found for ${e}`),this.historyView.renderError(new Error("Message not found"));return}const n=this.sessionManager.canRetry(s.id);if(!n.allowed){console.warn(`[LLMWorkspaceEditor] Cannot retry: ${n.reason}`);return}this.chatInput.setLoading(!0);try{s.role==="user"?await this.sessionManager.resendUserMessage(s.id):await this.sessionManager.retryGeneration(s.id,{preserveCurrent:!0,navigateToNew:!0})}catch(i){console.error("[LLMWorkspaceEditor] Retry failed:",i),this.historyView.renderError(i),this.chatInput.setLoading(!1)}}findNodeInTree(e,t){return e?e.id===t?!0:e.children?.some(s=>this.findNodeInTree(s,t))??!1:!1}async handleDelete(e){console.log(`[LLMWorkspaceEditor] Deleting: ${e}`);try{const t=this.sessionManager.getSessions(),s=this.collectDeletionIds(e,t);console.log("[LLMWorkspaceEditor] IDs to delete:",s),this.historyView.removeMessages(s,!0),await this.sessionManager.deleteMessage(e,{mode:"soft",cascade:!1,deleteAssociatedResponses:!0}),this.emit("change")}catch(t){console.error("[LLMWorkspaceEditor] Delete failed:",t);const s=this.sessionManager.getSessions();this.historyView.renderFull(s),this.historyView.renderError(t)}}collectDeletionIds(e,t){const s=[e],n=t.findIndex(a=>a.id===e);if(n===-1)return s;if(t[n].role==="user")for(let a=n+1;a<t.length;a++){const o=t[a];if(o.role==="assistant")s.push(o.id),o.executionRoot&&this.collectNodeIds(o.executionRoot,s);else break}return s}collectNodeIds(e,t){if(t.push(e.id),e.children)for(const s of e.children)this.collectNodeIds(s,t)}async handleEditAndRetry(e){const t=this.sessionManager.getSessions().find(s=>s.id===e);if(!(!t||t.role!=="user")){this.chatInput.setLoading(!0);try{await this.sessionManager.editMessage(e,t.content||"",!0)}catch(s){console.error("[LLMWorkspaceEditor] Edit and retry failed:",s),this.historyView.renderError(s),this.chatInput.setLoading(!1)}}}async handleResend(e){this.chatInput.setLoading(!0);try{await this.sessionManager.resendUserMessage(e)}catch(t){console.error("[LLMWorkspaceEditor] Resend failed:",t),this.historyView.renderError(t),this.chatInput.setLoading(!1)}}async handleSiblingSwitch(e,t){const n=this.sessionManager.getSessions().find(r=>r.id===e);if(!n)return;const i=n.siblingIndex??0,a=n.siblingCount??1;let o;if(t==="prev"?o=Math.max(0,i-1):o=Math.min(a-1,i+1),o!==i)try{await this.sessionManager.switchToSibling(e,o),this.emit("change")}catch(r){console.error("[LLMWorkspaceEditor] Sibling switch failed:",r),this.historyView.renderError(r)}}async handleUserSend(e,t,s,n){const i=this.options.ownerNodeId||this.options.nodeId;if(!i){console.error("[LLMWorkspaceEditor] No session loaded!");return}console.log("[LLMWorkspaceEditor] User sending message...",{agentId:s,overrides:n}),this.chatInput.setLoading(!0);try{let a=e||"";if(t.length>0){const o=this.options.sessionEngine;await Promise.all(t.map(async r=>{try{const c=await r.arrayBuffer();await o.createAsset(i,r.name,c),console.log(`[LLMWorkspaceEditor] Asset saved: ${r.name}`);const h=r.type.startsWith("image/")?`

![${r.name}](@asset/${r.name})`:`

[ ${r.name}](@asset/${r.name})`;a+=h}catch(c){console.error(`[LLMWorkspaceEditor] Failed to save asset ${r.name}:`,c),m.error(`Failed to upload ${r.name}`)}}))}if(!a.trim()){this.chatInput.setLoading(!1);return}await this.sessionManager.runUserQuery(a.trim(),t,s||"default",n)}catch(a){console.error("[LLMWorkspaceEditor] Send failed:",a),this.historyView.renderError(a),this.chatInput.setLoading(!1)}}toggleNavigator(){this.floatingNav||(this.floatingNav=new Fa(this.container,{onNavigate:n=>this.scrollToSession(n),onToggleFold:n=>this.toggleSessionFold(n),onCopy:n=>this.copySessionContent(n),onFoldAll:()=>this.foldAllSessions(),onUnfoldAll:()=>this.unfoldAllSessions(),onBatchDelete:n=>this.handleBatchDelete(n),onBatchCopy:n=>this.handleBatchCopy(n)}));const e=this.sessionManager.getSessions(),t=this.historyView.getCollapseStates();this.floatingNav.updateItems(e,t);const s=this.findCurrentVisibleSession();s&&this.floatingNav.setCurrentChat(s),this.floatingNav.toggle()}findCurrentVisibleSession(){const e=this.container.querySelector("#llm-ui-history");if(!e)return null;const t=e.getBoundingClientRect(),s=t.top+t.height/2,n=e.querySelectorAll("[data-session-id]");for(const i of n){const a=i.getBoundingClientRect();if(a.top<=s&&a.bottom>=s)return i.dataset.sessionId||null}for(const i of n){const a=i.getBoundingClientRect();if(a.bottom>t.top&&a.top<t.bottom)return i.dataset.sessionId||null}return null}scrollToSession(e){const s=this.container.querySelector("#llm-ui-history")?.querySelector(`[data-session-id="${e}"]`);s&&(s.scrollIntoView({behavior:"smooth",block:"start"}),s.classList.add("llm-ui-session--highlight"),setTimeout(()=>{s.classList.remove("llm-ui-session--highlight")},1500))}toggleSessionFold(e){const s=this.container.querySelector("#llm-ui-history")?.querySelector(`[data-session-id="${e}"]`);if(s){const n=s.querySelector('[data-action="collapse"]');n&&n.click()}}async copySessionContent(e){const s=this.sessionManager.getSessions().find(n=>n.id===e);if(s){let n=s.content||"";s.role==="assistant"&&s.executionRoot&&(n=this.extractExecutionOutput(s.executionRoot));try{await navigator.clipboard.writeText(n),m.success("Copied to clipboard")}catch(i){console.error("Copy failed:",i),m.error("Failed to copy")}}}extractExecutionOutput(e){let t=e.data.output||"";if(e.children&&e.children.length>0)for(const s of e.children){const n=this.extractExecutionOutput(s);n&&(t+=`

`+n)}return t.trim()}foldAllSessions(){const e=this.container.querySelector("#llm-btn-collapse");e&&this.isAllExpanded&&this.toggleAllBubbles(e)}unfoldAllSessions(){const e=this.container.querySelector("#llm-btn-collapse");e&&!this.isAllExpanded&&this.toggleAllBubbles(e)}navigateToPrevUserChat(){const e=this.sessionManager.getSessions(),t=this.findCurrentVisibleSession();if(!t)return;const s=e.findIndex(n=>n.id===t);for(let n=s-1;n>=0;n--)if(e[n].role==="user"){this.scrollToSession(e[n].id);break}}navigateToNextUserChat(){const e=this.sessionManager.getSessions(),t=this.findCurrentVisibleSession();if(!t)return;const s=e.findIndex(n=>n.id===t);for(let n=s+1;n<e.length;n++)if(e[n].role==="user"){this.scrollToSession(e[n].id);break}}async handleBatchDelete(e){if(!(e.length===0||!await Zt(`Are you sure you want to delete ${e.length} messages?`)))try{this.historyView.removeMessages(e,!0);for(const s of e)await this.sessionManager.deleteMessage(s,{mode:"soft",cascade:!1,deleteAssociatedResponses:!0});if(this.emit("change"),m.success(`Deleted ${e.length} messages`),this.floatingNav){const s=this.sessionManager.getSessions();this.floatingNav.updateItems(s,this.historyView.getCollapseStates())}}catch(s){console.error("Batch delete failed",s),m.error("Failed to delete messages");const n=this.sessionManager.getSessions();this.historyView.renderFull(n)}}async handleBatchCopy(e){const t=this.sessionManager.getSessions(),s=[],n=e.sort((i,a)=>{const o=t.find(c=>c.id===i),r=t.find(c=>c.id===a);return(o?.timestamp||0)-(r?.timestamp||0)});for(const i of n){const a=t.find(o=>o.id===i);if(a){let o=a.content||"";a.role==="assistant"&&a.executionRoot&&(o=this.extractExecutionOutput(a.executionRoot));const r=a.role==="user"?"User":"Assistant";s.push(`### ${r}:
${o}`)}}try{await navigator.clipboard.writeText(s.join(`

---

`)),m.success(`Copied ${e.length} messages`)}catch{m.error("Copy failed")}}updateBackgroundIndicator(e){const t=this.container.querySelector("#llm-bg-indicator");if(!t)return;const s=this.sessionManager.isGenerating()?Math.max(0,e.running-1):e.running;if(s>0||e.queued>0){t.style.display="flex";const n=t.querySelector(".llm-bg-badge");if(n){const i=s+e.queued;n.textContent=`${i} background task${i>1?"s":""}`}}else t.style.display="none"}showButtonFeedback(e,t){const s=e.innerHTML;e.innerHTML=`<span style="color:#2da44e">${t}</span>`,setTimeout(()=>e.innerHTML=s,2e3)}showNotification(e){console.log(`[Notification] ${e}`)}toggleAllBubbles(e){this.isAllExpanded=!this.isAllExpanded;const t=this.container.querySelector("#llm-ui-history");if(!t)return;t.querySelectorAll(".llm-ui-bubble--user, .llm-ui-node").forEach(i=>{this.isAllExpanded?i.classList.remove("is-collapsed"):i.classList.add("is-collapsed");const a=i.querySelector('[data-action="collapse"] svg');a&&(a.innerHTML=this.isAllExpanded?'<polyline points="18 15 12 9 6 15"></polyline>':'<polyline points="6 9 12 15 18 9"></polyline>')}),e.innerHTML=this.isAllExpanded?`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <polyline points="4 14 10 14 10 20"></polyline>
                 <polyline points="20 10 14 10 14 4"></polyline>
               </svg>`:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <polyline points="15 3 21 3 21 9"></polyline>
                 <polyline points="9 21 3 21 3 15"></polyline>
                 <line x1="21" y1="3" x2="14" y2="10"></line>
                 <line x1="3" y1="21" x2="10" y2="14"></line>
               </svg>`,e.setAttribute("title",this.isAllExpanded?"Collapse All":"Expand All"),this.sessionManager.getSessions().forEach(i=>{this.collapseStatesCache[i.id]=!this.isAllExpanded}),this.scheduleUIStateSave(this.collapseStatesCache)}async waitUntilReady(){return this.initPromise?this.initPromise:Promise.resolve()}getText(){return this.currentSessionId?JSON.stringify({sessionId:this.currentSessionId,title:this.currentTitle,messageCount:this.sessionManager.getSessions().length,status:this.sessionManager.getStatus()},null,2):JSON.stringify({error:"No session loaded"})}setText(e){this.loadSessionFromEngine(e).then(()=>this.emit("contentLoaded")).catch(t=>{console.error("[LLMWorkspaceEditor] setText failed:",t),this.historyView.renderError(t),this.emit("error",t)})}async setTextAsync(e){await this.loadSessionFromEngine(e)}isDirty(){return!1}setDirty(e){}focus(){this.chatInput?.focus()}async destroy(){this.uiStateSaveTimer&&(clearTimeout(this.uiStateSaveTimer),this.uiStateSaveTimer=null),this.inputStateSaveTimer&&(clearTimeout(this.inputStateSaveTimer),this.inputStateSaveTimer=null),!this.isBeingDeleted&&!this.sessionManager.isGenerating()&&this.saveUIState().catch(()=>{}),this.assetManagerUI&&(this.assetManagerUI.close(),this.assetManagerUI=null),this.sessionEventUnsubscribe&&(this.sessionEventUnsubscribe(),this.sessionEventUnsubscribe=null),this.globalEventUnsubscribe&&(this.globalEventUnsubscribe(),this.globalEventUnsubscribe=null),this.printService&&(this.printService.destroy?.(),this.printService=null),this.floatingNav&&(this.floatingNav.destroy(),this.floatingNav=null),this.globalShortcutHandler&&(document.removeEventListener("keydown",this.globalShortcutHandler),this.globalShortcutHandler=null),this.sessionManager.destroy(),this.historyView?.destroy(),this.chatInput?.destroy(),this.container.innerHTML="",this.listeners.clear()}getMode(){return"edit"}async switchToMode(){}setTitle(e){this.currentTitle=e,this.titleInput&&(this.titleInput.value=e)}setReadOnly(){}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return this.sessionManager.exportToMarkdown()}async getSummary(){return null}async navigateTo(){}async search(){return[]}gotoMatch(){}clearSearch(){}async pruneAssets(){return null}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(s=>s(t))}}class Co{constructor(e,t,s){this.service=s}container;content=null;_isDirty=!1;listeners=new Map;originalContent="";async init(e,t){this.container=e,this.container.classList.add("agent-config-editor"),this.originalContent=t||"{}",this.setText(this.originalContent),this.emit("ready")}getText(){return this.content?(this.syncModelFromUI(),JSON.stringify(this.content,null,2)):"{}"}setText(e){try{const t=JSON.parse(e),s=t.id&&t.id.trim()!==""?t.id:F(),n=this.normalizeAgentType(t.type);this.content={id:s,name:t.name||"New Agent",type:n,description:t.description||"",icon:t.icon||"",config:{connectionId:t.config?.connectionId||"",modelName:t.config?.modelName||"",systemPrompt:t.config?.systemPrompt||"You are a helpful assistant.",mcpServers:t.config?.mcpServers||[],maxHistoryLength:t.config?.maxHistoryLength??-1,temperature:t.config?.temperature},interface:t.interface||{inputs:[],outputs:[]}},this.render()}catch(t){this.renderError(t.message),this.content=null}}normalizeAgentType(e){switch(e){case"agent":return"agent";case"composite":case"orchestrator":return"composite";case"tool":return"tool";case"workflow":return"workflow";default:return"agent"}}isDirty(){return this._isDirty}setDirty(e){this._isDirty=e}async render(){if(!this.content)return;const e=this.content,t=e.config;let s=await this.service.getConnections();s.sort((r,c)=>{if(r.id==="default")return-1;if(c.id==="default")return 1;const d=!!(r.apiKey&&r.apiKey.trim().length>0),h=!!(c.apiKey&&c.apiKey.trim().length>0);return d&&!h?-1:!d&&h?1:(r.name||"").localeCompare(c.name||"")});let n=s.find(r=>r.id===t.connectionId);!n&&s.length>0&&(n=s[0],this.content&&this.content.config&&(this.content.config.connectionId=n.id));const i=n?.availableModels||[];let a=t.modelName;if(i.length>0&&!i.some(c=>c.id===a)){const c=this.findModelById(a,s);if(c){const d=i.find(h=>h.name===c.name);a=d?d.id:i[0].id}else a=i[0].id;this.content&&this.content.config&&(this.content.config.modelName=a)}const o=await this.service.getMCPServers();this.container.innerHTML=`
            <div class="agent-editor-container">
                <!-- Header with Icon & Name -->
                <div class="agent-header">
                    <div class="agent-header__icon-picker" id="icon-picker" title="">
                        ${e.icon||""}
                    </div>
                    <div class="agent-header__info">
                        <input type="text" 
                               class="agent-header__name-input" 
                               name="name" 
                               value="${this.escapeHtml(e.name)}" 
                               placeholder="Agent ">
                        <textarea class="agent-header__desc-input" 
                                  name="description" 
                                  placeholder=" Agent ..."
                                  rows="2">${this.escapeHtml(e.description||"")}</textarea>
                    </div>
                </div>

                <!-- Type Selection -->
                <div class="agent-section">
                    <div class="agent-section__header">
                        <span class="agent-section__icon"></span>
                        <span class="agent-section__title">Agent </span>
                        <span class="agent-section__toggle"></span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-type-selector">
                            <div class="agent-type-option ${e.type==="agent"?"selected":""}" data-type="agent">
                                <div class="agent-type-option__icon"></div>
                                <div class="agent-type-option__title">Agent</div>
                                <div class="agent-type-option__desc"> LLM </div>
                            </div>
                            <div class="agent-type-option ${e.type==="composite"?"selected":""}" data-type="composite">
                                <div class="agent-type-option__icon"></div>
                                <div class="agent-type-option__title">Composite</div>
                                <div class="agent-type-option__desc"> Agent </div>
                            </div>
                            <div class="agent-type-option ${e.type==="workflow"?"selected":""}" data-type="workflow">
                                <div class="agent-type-option__icon"></div>
                                <div class="agent-type-option__title">Workflow</div>
                                <div class="agent-type-option__desc"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Configuration -->
                <div class="agent-section" id="llm-config-section" style="${e.type!=="agent"?"display:none":""}">
                    <div class="agent-section__header">
                        <span class="agent-section__icon"></span>
                        <span class="agent-section__title">LLM </span>
                        <span class="agent-section__toggle"></span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                 <small> LLM </small>
                            </label>
                            <select class="agent-form-select" name="connectionId" id="connection-select">
                                <option value="">--  --</option>
                                ${s.map(r=>{const c=!!(r.apiKey&&r.apiKey.trim().length>0),d=r.id==="default";let h=this.escapeHtml(r.name);return d&&(h=` ${h}`),!c&&!d&&(h=`${h} ()`),`
                                    <option value="${r.id}" ${n?.id===r.id?"selected":""}>
                                        ${h} - ${r.provider}
                                    </option>
                                `}).join("")}
                            </select>
                            <p class="agent-form-help">
                                ${s.length===0?"  LLM ":" Agent  LLM "}
                            </p>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                 <small></small>
                            </label>
                            <!--  [Fix] name="modelName" -->
                            <select class="agent-form-select" name="modelName" id="model-select">
                                ${i.length>0?i.map(r=>`
                                        <option value="${r.id}" ${a===r.id?"selected":""}>
                                            ${r.name}
                                        </option>
                                    `).join(""):'<option value=""></option>'}
                            </select>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                System Prompt <small> Agent </small>
                            </label>
                            <textarea class="agent-form-textarea" 
                                      name="systemPrompt" 
                                      placeholder="You are a helpful assistant...">${this.escapeHtml(t.systemPrompt||"")}</textarea>
                            <p class="agent-form-help">
                                 System Prompt  Agent 
                            </p>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                 <small>-1 </small>
                            </label>
                            <input type="number" 
                                   class="agent-form-input" 
                                   name="maxHistoryLength" 
                                   value="${t.maxHistoryLength??-1}"
                                   min="-1"
                                   style="max-width: 150px;">
                        </div>
                    </div>
                </div>

                <!-- MCP Tools -->
                <div class="agent-section" id="mcp-section" style="${e.type!=="agent"?"display:none":""}">
                    <div class="agent-section__header">
                        <span class="agent-section__icon"></span>
                        <span class="agent-section__title"> (MCP)</span>
                        <span class="agent-section__toggle"></span>
                    </div>
                    <div class="agent-section__body">
                        ${o.length===0?`<div class="agent-empty-state">
                                    <div class="agent-empty-state__icon"></div>
                                    <p> MCP </p>
                                    <p style="font-size:0.8rem; margin-top:8px;">  MCP Servers </p>
                               </div>`:`<p class="agent-form-help" style="margin-bottom:12px;">
                                     Agent 
                               </p>
                               <div class="agent-mcp-list">
                                    ${o.map(r=>`
                                        <label class="agent-mcp-item">
                                            <input type="checkbox" 
                                                   name="mcpServers" 
                                                   value="${r.id}" 
                                                   ${(t.mcpServers||[]).includes(r.id)?"checked":""}>
                                            <div class="agent-mcp-item__info">
                                                <div class="agent-mcp-item__name">
                                                    ${r.icon||""} ${this.escapeHtml(r.name)}
                                                </div>
                                                <div class="agent-mcp-item__desc">
                                                    ${this.escapeHtml(r.description||"")}
                                                </div>
                                            </div>
                                            <span class="agent-mcp-item__status ${r.status==="connected"?"connected":""}">
                                                ${r.status==="connected"?"":""}
                                            </span>
                                        </label>
                                    `).join("")}
                               </div>`}
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="agent-section collapsed">
                    <div class="agent-section__header">
                        <span class="agent-section__icon"></span>
                        <span class="agent-section__title"></span>
                        <span class="agent-section__toggle"></span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-form-row">
                            <label class="agent-form-label">Agent ID</label>
                            <input type="text" 
                                   class="agent-form-input" 
                                   name="id" 
                                   value="${this.escapeHtml(e.id)}" 
                                   readonly 
                                   style="background: var(--st-bg-tertiary, #f3f4f6); cursor: not-allowed;">
                            <p class="agent-form-help"></p>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for icon -->
                <input type="hidden" name="icon" value="${e.icon||""}">
            </div>
        `,this.bindEvents()}findModelById(e,t){if(!e)return null;for(const s of t){const i=(s.availableModels||[]).find(a=>a.id===e);if(i)return i}return null}findModelByName(e,t){return e&&t.find(s=>s.name===e)||null}renderError(e){this.container.innerHTML=`
            <div class="agent-editor-container">
                <div style="padding: 40px; text-align: center; color: #ef4444;">
                    <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                    <h3 style="margin-bottom: 8px;"></h3>
                    <p style="color: #6b7280; font-size: 0.9rem;">${this.escapeHtml(e)}</p>
                    <pre style="margin-top: 16px; padding: 16px; background: #fef2f2; border-radius: 8px; text-align: left; overflow: auto; font-size: 0.8rem;">${this.escapeHtml(this.originalContent)}</pre>
                </div>
            </div>
        `}bindEvents(){const e=()=>{this._isDirty=!0,this.emit("interactiveChange")};this.container.querySelectorAll("input, select, textarea").forEach(i=>{i.addEventListener("input",e),i.addEventListener("change",e)}),this.container.querySelectorAll(".agent-section__header").forEach(i=>{i.addEventListener("click",()=>{i.closest(".agent-section")?.classList.toggle("collapsed")})}),this.container.querySelectorAll(".agent-type-option").forEach(i=>{i.addEventListener("click",()=>{const a=i.dataset.type;if(!a)return;this.container.querySelectorAll(".agent-type-option").forEach(d=>d.classList.remove("selected")),i.classList.add("selected");const o=this.container.querySelector("#llm-config-section"),r=this.container.querySelector("#mcp-section");a==="composite"||a==="workflow"?(o?.style.setProperty("display","none"),r?.style.setProperty("display","none")):(o?.style.setProperty("display","block"),r?.style.setProperty("display","block"));const c=this.normalizeAgentType(a);this.content&&(this.content.type=c),e()})});const t=this.container.querySelector("#connection-select"),s=this.container.querySelector("#model-select");t&&s&&t.addEventListener("change",async()=>{const i=t.value,a=await this.service.getConnections(),r=a.find(g=>g.id===i)?.availableModels||[],c=this.content?.config.modelName,h=this.findModelById(c||"",a)?.name;s.innerHTML=r.length>0?r.map(g=>`<option value="${g.id}">${g.name}</option>`).join(""):'<option value=""></option>';let u="";if(r.length>0){if(h){const g=this.findModelByName(h,r);u=g?g.id:r[0].id}else u=r[0].id;s.value=u}this.content&&this.content.config&&(this.content.config.connectionId=i,this.content.config.modelName=u),e()});const n=this.container.querySelector("#icon-picker");n&&n.addEventListener("click",()=>this.showIconPicker())}showIconPicker(){const e=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],t=document.createElement("div");t.className="icon-picker-overlay",t.innerHTML=`
            <div class="icon-picker-modal">
                <h3 style="margin: 0 0 16px 0; font-size: 1.1rem;"></h3>
                <div class="icon-picker-grid">
                    ${e.map(s=>`
                        <div class="icon-picker-item" data-icon="${s}">${s}</div>
                    `).join("")}
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button class="icon-picker-cancel" style="padding: 8px 16px; border: none; background: #e5e7eb; border-radius: 6px; cursor: pointer;"></button>
                </div>
            </div>
        `,t.querySelectorAll(".icon-picker-item").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.icon;if(n){const i=this.container.querySelector("#icon-picker");i&&(i.textContent=n);const a=this.container.querySelector('input[name="icon"]');a&&(a.value=n),this._isDirty=!0,this.emit("interactiveChange")}t.remove()})}),t.querySelector(".icon-picker-cancel")?.addEventListener("click",()=>{t.remove()}),t.addEventListener("click",s=>{s.target===t&&t.remove()}),document.body.appendChild(t)}syncModelFromUI(){if(!this.content)return;const e=i=>this.container.querySelector(`[name="${i}"]`)?.value||"",t=i=>Array.from(this.container.querySelectorAll(`input[name="${i}"]:checked`)).map(a=>a.value),s=this.container.querySelector(".agent-type-option.selected"),n=this.normalizeAgentType(s?.dataset.type);this.content.name=e("name"),this.content.icon=e("icon"),this.content.description=e("description"),this.content.type=n,n==="agent"&&(this.content.config={connectionId:e("connectionId"),modelName:e("modelName"),systemPrompt:e("systemPrompt"),maxHistoryLength:parseInt(e("maxHistoryLength"))||-1,mcpServers:t("mcpServers")})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async destroy(){this.container.innerHTML="",this.listeners.clear()}getMode(){return"edit"}async switchToMode(e){}setTitle(e){}setReadOnly(e){}focus(){this.container.querySelector(".agent-header__name-input")?.focus()}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return JSON.stringify(this.content||{})}async getSummary(){return this.content?.description||null}async navigateTo(){}async search(){return[]}gotoMatch(){}clearSearch(){}async pruneAssets(){return null}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(s=>s(t))}}class Io extends pe{testingConnections=new Set;async render(){let e=await this.service.getConnections();e.sort((t,s)=>{if(t.id==="default")return-1;if(s.id==="default")return 1;const n=!!(t.apiKey&&t.apiKey.trim().length>0),i=!!(s.apiKey&&s.apiKey.trim().length>0);return n&&!i?-1:!n&&i?1:(t.name||"").localeCompare(s.name||"")}),this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title">LLM </h2>
                        <p class="settings-page__description"> LLM </p>
                    </div>
                    <button id="btn-add-connection" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 
                    </button>
                </div>
                
                <div id="connections-list" class="settings-connection-grid">
                    ${e.map(t=>this.renderConnectionCard(t)).join("")}
                </div>
                
                ${e.length===0?`
                    <div class="settings-empty">
                        <div class="settings-empty__icon"></div>
                        <h3 class="settings-empty__title"></h3>
                        <p class="settings-empty__text">"" LLM </p>
                    </div>
                `:""}
            </div>
        `,this.bindEvents()}renderConnectionCard(e){const t=e.id==="default",s=!!(e.apiKey&&e.apiKey.trim().length>0),n=W[e.provider],a=(n?.models||[]).find(u=>u.id===e.model),o=a?a.name:e.model||"",r=s?"":"settings-connection-card--incomplete";let c="";t?c='<span class="settings-badge settings-badge--success"></span>':s||(c='<span class="settings-badge settings-badge--warning"></span>');const d=s?" ":" ",h=s?"settings-btn--secondary":"settings-btn--primary";return`
            <div class="settings-connection-card ${t?"settings-connection-card--default":""} ${r}" data-id="${e.id}">
                <div class="settings-connection-card__header">
                    <h3 class="settings-connection-card__title">${e.name}</h3>
                    ${c}
                </div>
                
                <div class="settings-connection-card__details">
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label"></span>
                        <span class="settings-detail-item__value">${n?.name||e.provider}</span>
                    </div>
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label"></span>
                        <span class="settings-detail-item__value">${o}</span>
                    </div>
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label">API Key</span>
                        <span class="settings-detail-item__value masked">
                            ${s?"":'<span style="color:var(--st-text-disabled)"></span>'}
                        </span>
                    </div>
                </div>
                
                <div class="settings-page__actions" style="margin-top:auto; width:100%">
                    <button class="settings-btn ${h} settings-btn--sm settings-btn-edit" style="flex:1">${d}</button>
                    <button class="settings-btn settings-btn--secondary settings-btn--sm settings-btn-test" style="flex:1" ${s?"":"disabled"}> </button>
                    ${t?"":'<button class="settings-btn settings-btn--danger settings-btn--sm settings-btn-delete" style="flex:1"> </button>'}
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.bindButton("#btn-add-connection",()=>this.showEditModal(null));const e=this.container.querySelector("#connections-list");e&&this.addEventListener(e,"click",async t=>{const s=t.target,n=s.closest(".settings-connection-card");if(!n)return;const i=n.dataset.id,a=(await this.service.getConnections()).find(o=>o.id===i);a&&(s.closest(".settings-btn-edit")?this.showEditModal(a):s.closest(".settings-btn-test")?await this.testConnection(n,a):s.closest(".settings-btn-delete")&&this.deleteConnection(i,a.name))})}showEditModal(e){const t=!e,s=Object.keys(W),n=e?.provider||s[0],i=W[n]?.models||[],a=`
            <form id="connection-form" class="settings-form">
                <div class="settings-form__group">
                    <label class="settings-form__label"> *</label>
                    <input type="text" class="settings-form__input" name="name" value="${e?.name||""}" required placeholder=":  OpenAI">
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label"> *</label>
                    <select class="settings-form__select" id="conn-provider" name="provider" required>
                        ${s.map(o=>`
                            <option value="${o}" ${e?.provider===o?"selected":""}>
                                ${W[o].name}
                            </option>
                        `).join("")}
                    </select>
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label"> *</label>
                    <select class="settings-form__select" id="conn-model" name="model" required>
                        ${i.length>0?i.map(o=>`
                                <option value="${o.id}" ${e?.model===o.id?"selected":""}>
                                    ${o.name}
                                </option>
                            `).join(""):'<option value="">--  --</option>'}
                    </select>
                    <small class="settings-form__help"></small>
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">API Key *</label>
                    <input type="password" class="settings-form__input" name="apiKey" value="${e?.apiKey||""}" required placeholder="sk-...">
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">Base URL</label>
                    <input type="text" class="settings-form__input" id="conn-baseurl" name="baseURL" value="${e?.baseURL||""}" placeholder="">
                </div>
            </form>
        `;new O(t?"":"",a,{confirmText:"",onConfirm:async()=>{const o=document.getElementById("connection-form");if(!o.checkValidity())return o.reportValidity(),!1;const r=new FormData(o),c=Object.fromEntries(r),d=W[c.provider],h={id:e?.id||`conn-${Ce()}`,name:c.name,provider:c.provider,apiKey:c.apiKey,model:c.model,baseURL:c.baseURL||d?.baseURL||"",availableModels:e?.availableModels||(d?[...d.models]:[]),metadata:e?.metadata};await this.service.saveConnection(h),m.success(t?"":""),this.render()}}).show(),setTimeout(()=>{const o=document.getElementById("conn-provider"),r=document.getElementById("conn-model"),c=document.getElementById("conn-baseurl");o&&o.addEventListener("change",d=>{const h=d.target.value,u=W[h],g=u?.models||[];r.innerHTML=g.length>0?g.map(v=>`<option value="${v.id}">${v.name}</option>`).join(""):'<option value="">--  --</option>';const p=e?.provider||s[0],f=W[p]?.baseURL||"";(!c.value||c.value===f)&&(c.value=u?.baseURL||"")})},100)}async testConnection(e,t){if(this.testingConnections.has(t.id))return;if(!t.apiKey){m.warning(" API Key");return}this.testingConnections.add(t.id);const s=e.querySelector(".settings-btn-test"),n=s.innerHTML;s.innerHTML=" ...",s.disabled=!0;try{const i=await eo({provider:t.provider,apiKey:t.apiKey,baseURL:t.baseURL,model:t.model});i.success?(m.success(i.message||""),s.innerHTML=" ",s.classList.remove("settings-btn--secondary"),s.classList.add("settings-btn--success")):(m.error(`: ${i.message}`),s.innerHTML=" ",s.classList.remove("settings-btn--secondary"),s.classList.add("settings-btn--danger"))}catch(i){console.error(i),m.error(`: ${i.message}`),s.innerHTML=" "}finally{setTimeout(()=>{s.innerHTML=n,s.disabled=!1,s.classList.remove("settings-btn--success","settings-btn--danger"),s.classList.add("settings-btn--secondary"),this.testingConnections.delete(t.id)},3e3)}}deleteConnection(e,t){O.confirm("",`"${t}"`,async()=>{await this.service.deleteConnection(e),m.success(""),this.render()})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}}class To extends pe{selectedId=null;async render(){const e=await this.service.getMCPServers();this.selectedId&&!e.find(s=>s.id===this.selectedId)&&(this.selectedId=null),!this.selectedId&&e.length>0&&(this.selectedId=e[0].id);const t=e.find(s=>s.id===this.selectedId);this.container.innerHTML=`
            <div class="settings-split">
                <div class="settings-split__sidebar">
                    <div class="settings-split__header">
                        <h3><i class="fas fa-plug"></i> MCP Servers</h3>
                        <div class="settings-page__actions">
                            <button id="btn-add-server" class="settings-btn-round" title=""><i class="fas fa-plus"></i></button>
                            <button id="btn-import-server" class="settings-btn-round" title=""><i class="fas fa-file-import"></i></button>
                            <button id="btn-export-all" class="settings-btn-round" title=""><i class="fas fa-file-export"></i></button>
                        </div>
                    </div>
                    <div class="settings-split__list">
                        ${e.length===0?this.renderEmptyList():e.map(s=>this.renderListItem(s)).join("")}
                    </div>
                </div>

                <div class="settings-split__content">
                    ${t?this.renderConfigPanel(t):this.renderEmptyState()}
                </div>
            </div>
        `,this.bindEvents()}renderEmptyList(){return`
            <div class="settings-empty settings-empty--mini">
                <p> MCP Server</p>
                <button class="settings-btn settings-btn--primary settings-btn--sm" id="btn-create-first"></button>
            </div>
        `}renderListItem(e){const t=e.id===this.selectedId,s=e.status==="connected"?"settings-badge--success":e.status==="error"?"settings-badge--danger":"",n=e.status==="connected"?"check-circle":e.status==="error"?"exclamation-circle":"circle";return`
            <div class="settings-list-item ${t?"selected":""}" data-id="${e.id}">
                <span class="settings-list-item__icon">${e.icon||""}</span>
                <div class="settings-list-item__info">
                    <p class="settings-list-item__title">${e.name}</p>
                    <p class="settings-list-item__desc">${e.transport}</p>
                </div>
                <span class="settings-badge ${s}"><i class="fas fa-${n}"></i></span>
            </div>
        `}renderConfigPanel(e){const t=e.tools||[],s=e.resources||[];return`
            <div class="settings-config-header">
                <div class="settings-config-header__title-area">
                    <span class="settings-config-header__icon">${e.icon||""}</span>
                    <div>
                        <h2 class="settings-config-header__title">${e.name}</h2>
                        <p class="settings-config-header__subtitle">${e.description||" MCP Server"}</p>
                    </div>
                </div>
                <div class="settings-config-header__actions">
                    <button class="settings-btn settings-btn--secondary settings-btn-test" ${e.transport?"":"disabled"}>
                        <i class="fas fa-vial"></i> 
                    </button>
                    <button class="settings-btn settings-btn--primary settings-btn-save"><i class="fas fa-save"></i> </button>
                    <button class="settings-btn settings-btn--danger settings-btn-delete"><i class="fas fa-trash"></i> </button>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title"></h3>
                <div class="settings-form__row"><label class="settings-form__label"></label><input type="text" class="settings-form__input" name="name" value="${e.name}"></div>
                <div class="settings-form__row"><label class="settings-form__label"></label><input type="text" class="settings-form__input" name="icon" value="${e.icon||""}"></div>
                <div class="settings-form__row"><label class="settings-form__label"></label><textarea class="settings-form__textarea" name="description">${e.description||""}</textarea></div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title"></h3>
                <div class="settings-form__row">
                    <label class="settings-form__label"></label>
                    <select class="settings-form__select" name="transport">
                        <option value="stdio" ${e.transport==="stdio"?"selected":""}>STDIO</option>
                        <option value="sse" ${e.transport==="sse"?"selected":""}>SSE</option>
                        <option value="http" ${e.transport==="http"?"selected":""}>HTTP</option>
                    </select>
                </div>
                <div id="transport-config-container">
                    ${this.renderTransportFields(e)}
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">
                     (Tools) <span class="settings-badge">${t.length}</span>
                </h3>
                ${t.length===0?'<div class="settings-empty settings-empty--mini"><p></p><button class="settings-btn settings-btn--sm" id="btn-add-tool"></button></div>':`<div class="settings-list-card-container">${t.map((n,i)=>this.renderToolItem(n,i)).join("")}</div>
                       <button class="settings-btn settings-btn--sm" id="btn-add-tool" style="margin-top:10px"></button>`}
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">
                     (Resources) <span class="settings-badge">${s.length}</span>
                </h3>
                ${s.length===0?'<div class="settings-empty settings-empty--mini"><p></p><button class="settings-btn settings-btn--sm" id="btn-add-resource"></button></div>':`<div class="settings-list-card-container">${s.map((n,i)=>this.renderResourceItem(n,i)).join("")}</div>
                       <button class="settings-btn settings-btn--sm" id="btn-add-resource" style="margin-top:10px"></button>`}
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title"></h3>
                <div class="settings-form__row">
                    <label class="settings-form__label"><input type="checkbox" name="autoConnect" ${e.autoConnect?"checked":""}> </label>
                </div>
                <div class="settings-form__row">
                    <label class="settings-form__label"> ()</label>
                    <input type="number" class="settings-form__input" name="timeout" value="${e.timeout||30}">
                </div>
            </div>
        `}renderTransportFields(e){return e.transport==="stdio"?`
                <div class="settings-form__row"><label class="settings-form__label">Command</label><input type="text" class="settings-form__input" name="command" value="${e.command||""}" placeholder="node"></div>
                <div class="settings-form__row"><label class="settings-form__label">Args</label><input type="text" class="settings-form__input" name="args" value="${e.args||""}" placeholder="server.js"></div>
                <div class="settings-form__row"><label class="settings-form__label">CWD</label><input type="text" class="settings-form__input" name="cwd" value="${e.cwd||""}" placeholder="/path/to/dir"></div>
            `:`
                <div class="settings-form__row"><label class="settings-form__label">Endpoint</label><input type="url" class="settings-form__input" name="endpoint" value="${e.endpoint||""}" placeholder="http://localhost:3000"></div>
                <div class="settings-form__row"><label class="settings-form__label">API Key</label><input type="password" class="settings-form__input" name="apiKey" value="${e.apiKey||""}"></div>
            `}renderToolItem(e,t){return`
            <div class="settings-list-card">
                <div class="settings-list-card__header">
                    <strong>${e.name}</strong>
                    <button class="settings-btn-icon-small settings-btn-delete-tool" data-index="${t}"><i class="fas fa-trash"></i></button>
                </div>
                <p class="settings-list-card__desc">${e.description||""}</p>
            </div>
        `}renderResourceItem(e,t){return`
            <div class="settings-list-card">
                <div class="settings-list-card__header">
                    <strong>${e.name||e.uri}</strong>
                    <button class="settings-btn-icon-small settings-btn-delete-resource" data-index="${t}"><i class="fas fa-trash"></i></button>
                </div>
                <p class="settings-list-card__desc"><code>${e.uri}</code></p>
            </div>
        `}renderEmptyState(){return'<div class="settings-empty"><h3> MCP Server</h3></div>'}bindEvents(){this.clearListeners();const e=this.container.querySelector(".settings-split__list");e&&this.addEventListener(e,"click",n=>{const i=n.target.closest(".settings-list-item");i&&(this.selectedId=i.dataset.id,this.render())}),this.bindButton("#btn-add-server",()=>this.addNewServer()),this.bindButton("#btn-create-first",()=>this.addNewServer()),this.bindButton("#btn-import-server",()=>this.showImportModal()),this.bindButton("#btn-export-all",()=>this.exportAll()),this.bindButton(".settings-btn-save",()=>this.saveCurrentServer()),this.bindButton(".settings-btn-delete",()=>this.deleteCurrentServer()),this.bindButton(".settings-btn-test",()=>this.testConnection());const t=this.container.querySelector('[name="transport"]');t&&this.addEventListener(t,"change",n=>{const i=n.target.value,a=document.getElementById("transport-config-container");if(a){const o={transport:i};a.innerHTML=this.renderTransportFields(o)}}),this.bindButton("#btn-add-tool",()=>this.showAddToolModal()),this.bindButton("#btn-add-resource",()=>this.showAddResourceModal());const s=this.container.querySelector(".settings-split__content");s&&this.addEventListener(s,"click",n=>{const i=n.target,a=i.closest(".settings-btn-delete-tool"),o=i.closest(".settings-btn-delete-resource");a&&this.deleteTool(parseInt(a.dataset.index)),o&&this.deleteResource(parseInt(o.dataset.index))})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}async addNewServer(){const e={id:`mcp-${Ce()}`,name:"New Server",transport:"stdio",status:"idle",tools:[],resources:[]};await this.service.saveMCPServer(e),this.selectedId=e.id}async saveCurrentServer(){if(!this.selectedId)return;const e=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);if(!e)return;const t=i=>this.container.querySelector(`[name="${i}"]`)?.value,s=i=>this.container.querySelector(`[name="${i}"]`)?.checked,n={...e,name:t("name"),icon:t("icon"),description:t("description"),transport:t("transport"),autoConnect:s("autoConnect"),timeout:parseInt(t("timeout")||"30"),command:t("command"),args:t("args"),cwd:t("cwd"),endpoint:t("endpoint"),apiKey:t("apiKey")};await this.service.saveMCPServer(n),m.success("")}deleteCurrentServer(){this.selectedId&&O.confirm(""," MCP Server ",async()=>{await this.service.deleteMCPServer(this.selectedId),this.selectedId=null,m.success("")})}async testConnection(){if(!this.selectedId)return;const e=this.container.querySelector(".btn-test"),t=e.innerHTML;e.innerHTML="...",e.disabled=!0;try{await new Promise(n=>setTimeout(n,1e3));const s=(await this.service.getMCPServers()).find(n=>n.id===this.selectedId);s&&(s.status="connected",s.tools?.length||(s.tools=[{name:"mock_tool",description:"Auto-discovered tool"}]),await this.service.saveMCPServer(s),m.success(""))}catch{m.error("")}finally{e.innerHTML=t,e.disabled=!1}}showAddToolModal(){const e=`
            <div class="settings-form__group"><label class="settings-form__label"></label><input class="settings-form__input" id="tool-name" type="text"></div>
            <div class="settings-form__group"><label class="settings-form__label"></label><textarea class="settings-form__textarea" id="tool-desc"></textarea></div>
        `;new O("",e,{onConfirm:async()=>{const t=document.getElementById("tool-name").value,s=document.getElementById("tool-desc").value;if(!t)return!1;const n=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);n&&(n.tools=[...n.tools||[],{name:t,description:s}],await this.service.saveMCPServer(n))}}).show()}async deleteTool(e){const t=(await this.service.getMCPServers()).find(s=>s.id===this.selectedId);t&&t.tools&&(t.tools.splice(e,1),this.service.saveMCPServer(t))}showAddResourceModal(){const e=`
            <div class="form-group"><label>URI</label><input id="res-uri" type="text"></div>
            <div class="form-group"><label></label><input id="res-name" type="text"></div>
        `;new O("",e,{onConfirm:async()=>{const t=document.getElementById("res-uri").value,s=document.getElementById("res-name").value;if(!t)return!1;const n=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);n&&(n.resources=[...n.resources||[],{uri:t,name:s}],await this.service.saveMCPServer(n))}}).show()}async deleteResource(e){const t=(await this.service.getMCPServers()).find(s=>s.id===this.selectedId);t&&t.resources&&(t.resources.splice(e,1),this.service.saveMCPServer(t))}showImportModal(){const e='<textarea id="import-json" style="width:100%;height:200px" placeholder="Paste JSON array..."></textarea>';new O("",e,{confirmText:"",onConfirm:async()=>{const t=document.getElementById("import-json").value;try{const s=JSON.parse(t),n=Array.isArray(s)?s:[s];for(const i of n)i.id=i.id||`mcp-${Ce()}`,await this.service.saveMCPServer(i);m.success(` ${n.length} `)}catch{return m.error("JSON "),!1}}}).show()}async exportAll(){const e=JSON.stringify(await this.service.getMCPServers(),null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="mcp-servers.json",n.click()}}const Mo=l=>async(e,t)=>{let s=t.nodeId;const n=t,i=n.sessionEngine;i||console.error("[LLMFactory] Critical: sessionEngine missing in options. Make sure MemoryManager is injecting it correctly.");let a=!1;!s&&i&&(s=(await i.createFile(t.title||"New Chat",null)).id,a=!0,console.log(`[LLMFactory] New file created: ${s}`));const o={...n,agentService:l,nodeId:s,sessionEngine:i,isNewSession:a},r=new xo(e,o);return await r.init(e,t.initialContent),console.log(`[LLMFactory] Editor created successfully, isNew: ${a}`),r},ko=l=>async(e,t)=>{const s=new Co(e,t,l);return await s.init(e,t.initialContent),s};class Ao extends pe{async init(e){await super.init(e),this.refreshData()}focus(){this.refreshData()}refreshData(){this.service.syncTags().then(()=>{})}render(){const e=this.service.getTags(),t=e.sort((a,o)=>(o.count||0)-(a.count||0)),s=e.length,n=e.reduce((a,o)=>a+(o.count||0),0),i=e.filter(a=>(a.count||0)===0).length;this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title"></h2>
                        <p class="settings-page__description"></p>
                    </div>
                    <button id="btn-add-tag" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 
                    </button>
                </div>

                <div class="settings-tags__stats">
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${s}</div>
                        <div class="settings-stat-card__label"></div>
                    </div>
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${n}</div>
                        <div class="settings-stat-card__label"></div>
                    </div>
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${i}</div>
                        <div class="settings-stat-card__label"></div>
                    </div>
                </div>

                <div class="settings-tags__grid">
                    ${t.map(a=>this.renderTagCard(a)).join("")}
                </div>

                ${e.length===0?`
                    <div class="settings-empty">
                        <div class="settings-empty__icon"></div>
                        <h3 class="settings-empty__title"></h3>
                        <p class="settings-empty__text"></p>
                    </div>
                `:""}
            </div>
        `,this.bindEvents()}renderTagCard(e){const t=e.color||"#3b82f6",s=e.count||0;return`
            <div class="settings-tag-card" style="--tag-color: ${t}" data-id="${e.id}">
                <div class="settings-tag-card__header">
                    <h3 class="settings-tag-card__name" style="color: ${t}">#${e.name}</h3>
                    <span class="settings-badge">${s} </span>
                </div>
                <p class="settings-tag-card__desc">${e.description||""}</p>
                <div class="settings-tag-card__meta">
                    <input type="color" value="${t}" class="settings-color-picker" title="">
                    <div class="settings-tag-card__actions">
                        <button class="settings-btn-icon-small settings-btn-edit" title=""></button>
                        <button class="settings-btn-icon-small settings-btn-delete" title=""></button>
                    </div>
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.addEventListener(this.container.querySelector("#btn-add-tag"),"click",()=>this.showEditModal(null));const e=this.container.querySelector(".settings-tags__grid");e&&(this.addEventListener(e,"click",t=>{const s=t.target,n=s.closest(".settings-tag-card");if(!n)return;const i=n.dataset.id,a=this.service.getTags().find(o=>o.id===i);a&&(s.closest(".settings-btn-edit")?this.showEditModal(a):s.closest(".settings-btn-delete")&&this.deleteTag(a))}),this.addEventListener(e,"change",t=>{const s=t.target;if(s.classList.contains("settings-color-picker")){const i=s.closest(".settings-tag-card").dataset.id,a=this.service.getTags().find(o=>o.id===i);a&&(this.service.saveTag({...a,color:s.value}),m.success(""))}}))}showEditModal(e){const t=!e,s=`
            <form id="tag-form" class="settings-form">
                <div class="settings-form__group">
                    <label class="settings-form__label"> *</label>
                    <input type="text" class="settings-form__input" name="name" value="${e?.name||""}" required placeholder=": , " ${t?"":"disabled"}>
                </div>
                <div class="settings-form__group">
                    <label class="settings-form__label"></label>
                    <input type="color" class="settings-form__input" name="color" value="${e?.color||"#3b82f6"}">
                </div>
                <div class="settings-form__group">
                    <label class="settings-form__label"></label>
                    <textarea class="settings-form__textarea" name="description" placeholder="...">${e?.description||""}</textarea>
                </div>
            </form>
        `;new O(t?"":"",s,{confirmText:"",onConfirm:async()=>{const n=document.getElementById("tag-form");if(!n.checkValidity())return n.reportValidity(),!1;const i=new FormData(n),a={id:e?.id||i.get("name"),name:i.get("name"),color:i.get("color"),description:i.get("description"),count:e?.count||0};await this.service.saveTag(a),m.success(t?"":"")}}).show()}deleteTag(e){const t=e.count||0,s=t>0?` "${e.name}"  ${t} 

`:` "${e.name}" `;O.confirm("",s,async()=>{await this.service.deleteTag(e.id),m.success("")})}}class Lo extends pe{searchTerm="";selectedGroup="all";render(){const e=this.service.getContacts(),t=e.filter(n=>{const i=this.selectedGroup==="all"||n.group===this.selectedGroup,a=!this.searchTerm||n.name.toLowerCase().includes(this.searchTerm.toLowerCase());return i&&a}),s=Array.from(new Set(e.map(n=>n.group).filter(Boolean)));this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title"></h2>
                        <p class="settings-page__description"></p>
                    </div>
                    <button id="btn-add-contact" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 
                    </button>
                </div>

                <div class="settings-contact-toolbar">
                    <div class="settings-search-box">
                        <span class="settings-search-box__icon"></span>
                        <input type="text" class="settings-search-box__input" id="contact-search" placeholder="..." value="${this.searchTerm}">
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="settings-btn settings-btn--sm ${this.selectedGroup==="all"?"settings-btn--primary":"settings-btn--secondary"} filter-btn" data-group="all"></button>
                        ${s.map(n=>`
                            <button class="settings-btn settings-btn--sm ${this.selectedGroup===n?"settings-btn--primary":"settings-btn--secondary"} filter-btn" data-group="${n}">${n}</button>
                        `).join("")}
                    </div>
                </div>

                <div class="settings-contact-list">
                    ${t.map(n=>this.renderContactCard(n)).join("")}
                </div>
            </div>
        `,this.bindEvents()}renderContactCard(e){return`
            <div class="settings-contact-card" data-id="${e.id}">
                <div class="settings-contact-card__avatar">${e.name.substring(0,2)}</div>
                <div class="settings-contact-card__info">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="margin:0; font-size:1.1rem;">${e.name}</h3>
                        ${e.group?`<span class="settings-badge">${e.group}</span>`:""}
                    </div>
                    <div style="margin:10px 0; color:var(--st-text-secondary); font-size:0.9rem;">
                        ${e.email?`<div> ${e.email}</div>`:""}
                        ${e.phone?`<div> ${e.phone}</div>`:""}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="settings-btn settings-btn--sm settings-btn--secondary settings-btn-edit"></button>
                        <button class="settings-btn settings-btn--sm settings-btn--danger settings-btn-delete"></button>
                    </div>
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.bindButton("#btn-add-contact",()=>this.showEditModal(null));const e=this.container.querySelector("#contact-search");e&&this.addEventListener(e,"input",s=>{this.searchTerm=s.target.value,this.render()}),this.container.querySelectorAll(".filter-btn").forEach(s=>{this.addEventListener(s,"click",n=>{this.selectedGroup=n.target.dataset.group||"all",this.render()})});const t=this.container.querySelector(".settings-contact-list");t&&this.addEventListener(t,"click",s=>{const n=s.target,i=n.closest(".settings-contact-card");if(!i)return;const a=this.service.getContacts().find(o=>o.id===i.dataset.id);a&&(n.closest(".settings-btn-edit")&&this.showEditModal(a),n.closest(".settings-btn-delete")&&this.deleteContact(a.id))})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}showEditModal(e){const t=!e,s=`
            <form id="contact-form" class="settings-form">
                <div class="settings-form__group"><label class="settings-form__label"></label><input class="settings-form__input" name="name" value="${e?.name||""}" required></div>
                <div class="settings-form__group"><label class="settings-form__label">Email</label><input class="settings-form__input" name="email" value="${e?.email||""}"></div>
                <div class="settings-form__group"><label class="settings-form__label"></label><input class="settings-form__input" name="group" value="${e?.group||""}"></div>
            </form>
        `;new O(t?"":"",s,{confirmText:"",onConfirm:async()=>{const n=document.getElementById("contact-form");if(!n.checkValidity())return!1;const i=new FormData(n),a={id:e?.id||`contact-${Ce()}`,name:i.get("name"),email:i.get("email"),group:i.get("group")};await this.service.saveContact(a),m.success("Saved")}}).show()}deleteContact(e){O.confirm("","",async()=>{await this.service.deleteContact(e),m.success("Deleted")})}}const $={formatSize(l){return(l/1024/1024).toFixed(2)},formatTime(l){const e=new Date(l),t=new Date,s=t.getTime()-l;return s<60*1e3?"":s<60*60*1e3?`${Math.floor(s/60/1e3)}`:e.toDateString()===t.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleString("zh-CN",{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})},formatLogTime(l){return new Date(l).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})},formatSpeed(l){return l<1024?`${l.toFixed(0)} B/s`:l<1024*1024?`${(l/1024).toFixed(1)} KB/s`:`${(l/1024/1024).toFixed(1)} MB/s`},truncatePath(l,e){if(l.length<=e)return l;const t=l.split("/");if(t.length<=2)return"..."+l.slice(-e+3);const s=t[t.length-1];return s.length>=e-6?".../"+s.slice(-e+6):".../"+t.slice(-2).join("/")},escapeHtml(l){const e=document.createElement("div");return e.textContent=l,e.innerHTML},downloadJson(l,e){const t=typeof l=="string"?l:JSON.stringify(l,null,2),s=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download=e,i.click(),URL.revokeObjectURL(n)}},ee="__config",oe="/sync_config.json";class No{vfs=null;plugin=null;settings=null;status={state:"idle",lastSyncTime:null};conflicts=[];logs=[];maxLogs=100;eventHandlers=new Map;unsubscribers=[];autoSyncTimer=null;constructor(){}async init(e){if(this.vfs=e,this.plugin=e.getPlugin("vfs-sync")??null,!this.plugin){console.warn("[SyncService] SyncPlugin not found"),this.updateStatus({state:"error",errorMessage:"Sync Plugin Missing"});return}await this.loadSettingsFromVFS(),this.bindPluginEvents(),this.settings?.autoSync&&this.startAutoSync(),this.log("info","")}syncFromPluginState(e){const t={idle:"idle",syncing:"syncing",paused:"paused",error:"error",offline:"offline"};this.updateStatus({state:t[e.status]||"idle",progress:e.progress,errorMessage:e.error?.message}),e.stats.lastSyncTime&&(this.status.lastSyncTime=e.stats.lastSyncTime)}async loadSettingsFromVFS(){if(this.vfs)try{if(await this.vfs.getNode(ee,oe)){const t=await this.vfs.read(ee,oe),s=typeof t=="string"?t:new TextDecoder().decode(t);this.settings=JSON.parse(s),this.plugin&&this.settings&&await this.plugin.reconfigure(this.mapToPluginConfig(this.settings))}}catch{this.settings=this.getDefaultSettings()}}getDefaultSettings(){return{serverUrl:"",username:"",token:"",strategy:"manual",autoSync:!1,conflictResolution:"server-wins",autoSyncInterval:15,transport:"auto",filters:{excludeBinary:!1,maxFileSize:100*1024*1024}}}async saveSettings(e){if(!this.vfs)throw new Error("VFS not initialized");this.settings=e;const t=JSON.stringify(e,null,2);try{await this.vfs.getNode(ee,oe)?await this.vfs.write(ee,oe,t):await this.vfs.createFile(ee,oe,t)}catch(s){if(s.message?.includes("not found"))try{await this.vfs.mount(ee,{description:"Configuration Storage"}),await this.vfs.createFile(ee,oe,t)}catch(n){throw console.error("[SyncService] Failed to create config module",n),n}else throw s}await this.applyConfigToPlugin(e),this.manageAutoSync(this.settings),this.log("info","")}async applyConfigToPlugin(e){if(!this.plugin)return;const t=this.mapToPluginConfig(e);try{await this.plugin.reconfigure(t),(e.transport==="websocket"||e.transport==="auto")&&await this.plugin.reconnect()}catch(s){throw console.error("[SyncService] Failed to apply config to plugin",s),s}}manageAutoSync(e){this.autoSyncTimer&&(clearInterval(this.autoSyncTimer),this.autoSyncTimer=null),e.autoSync&&e.autoSyncInterval&&e.autoSyncInterval>0&&this.startAutoSync()}startAutoSync(){if(!this.settings?.autoSyncInterval)return;const e=this.settings.autoSyncInterval*60*1e3;this.autoSyncTimer=setInterval(async()=>{if(this.status.state==="syncing"){console.log("[SyncService] Auto-sync skipped: already syncing");return}if(!this.settings?.serverUrl){console.log("[SyncService] Auto-sync skipped: no server configured");return}try{this.log("info","..."),await this.triggerSync("standard")}catch(t){this.log("error",`: ${t.message}`)}},e),console.log(`[SyncService] Auto-sync enabled, interval: ${this.settings.autoSyncInterval} minutes`)}getSettings(){return this.settings||this.getDefaultSettings()}getStatus(){return{...this.status}}updateStatus(e){this.status={...this.status,...e},this.emit("stateChange",{status:this.status})}getLogs(e=50){return this.logs.slice(0,e)}log(e,t,s){const n={timestamp:Date.now(),level:e,message:t,details:s};this.logs.unshift(n),this.logs.length>this.maxLogs&&this.logs.pop(),this.emit("log",{entry:n})}clearLogs(){this.logs=[],this.emit("log",{cleared:!0})}bindPluginEvents(){if(!this.vfs)return;const e=this.vfs.onAny((t,s)=>{const n=String(t);n.startsWith("sync:")&&this.handlePluginEvent(n,s)});this.unsubscribers.push(e)}async triggerSync(e="standard"){if(!this.plugin)throw new Error("Sync plugin not available");if(!this.settings?.serverUrl)throw new Error("");this.updateStatus({state:"syncing",progress:void 0}),this.log("info",`${this.getModeLabel(e)}...`);try{await this.plugin.triggerManualSync(e),this.updateStatus({state:"success",lastSyncTime:Date.now()}),this.log("success","")}catch(t){throw this.updateStatus({state:"error",errorMessage:t.message}),this.log("error",`: ${t.message}`),t}}getModeLabel(e){return{standard:"",force_push:"",force_pull:""}[e]||e}async testConnection(e,t,s){if(this.plugin)return this.plugin.testConnection(e,s);try{return(await fetch(`${e}/api/sync/ping`,{method:"GET",headers:{Authorization:`Bearer ${s}`}})).ok}catch(n){return console.error("[SyncService] Connection test failed",n),!1}}async reconnect(){if(!this.plugin)throw new Error("Sync plugin not available");this.log("info","..."),await this.plugin.reconnect()}async resolveConflict(e,t){if(!this.plugin)throw new Error("Sync plugin not available");await this.plugin.resolveConflict(e,t),await this.refreshConflicts();const s=t==="local"?"":"";this.log("success",`: ${s}`)}getConflicts(){return this.conflicts}async refreshConflicts(){this.plugin&&(this.conflicts=await this.plugin.getConflicts(),this.emit("conflict",{conflicts:this.conflicts}))}async resolveAllConflicts(e){const t=this.getConflicts();for(const s of t)try{await this.resolveConflict(s.conflictId,e)}catch(n){console.error(`[SyncService] Failed to resolve conflict ${s.conflictId}`,n)}}handlePluginEvent(e,t){switch(e){case"sync:state_changed":const s=t.data;this.syncFromPluginState(s);break;case"sync:progress":this.updateStatus({state:"syncing",progress:t.data}),this.emit("progress",t.data);break;case"sync:connected":this.updateStatus({connection:{type:"websocket",connected:!0}}),this.log("success",""),this.emit("connected",{});break;case"sync:disconnected":this.updateStatus({connection:{type:"websocket",connected:!1}}),this.log("warn",""),this.emit("disconnected",{});break;case"sync:conflict":this.refreshConflicts(),this.log("warn",`: ${t.path}`);break;case"sync:error":this.updateStatus({state:"error",errorMessage:t.data?.message||""}),this.log("error",t.data?.message||""),this.emit("error",{message:t.data?.message});break;case"sync:completed":this.updateStatus({state:"success",lastSyncTime:Date.now()}),this.log("success",""),this.emit("completed",{});break}}on(e,t){return this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(t),()=>this.eventHandlers.get(e)?.delete(t)}emit(e,t){const s={type:e,data:t,timestamp:Date.now()};this.eventHandlers.get(e)?.forEach(n=>n(s))}mapToPluginConfig(e){return{moduleId:"root",peerId:this.getOrCreatePeerId(),serverUrl:e.serverUrl,auth:{type:"jwt",token:e.token},transport:e.transport==="auto"?"websocket":e.transport,strategy:{direction:this.mapStrategyToDirection(e.strategy),conflictResolution:e.conflictResolution,batchSize:50,maxPacketSize:5*1024*1024,maxRetries:3,retryDelay:1e3,retryBackoff:"exponential",filters:e.filters?{content:{excludeBinary:e.filters.excludeBinary},sizeLimit:{maxFileSize:e.filters.maxFileSize},paths:{exclude:e.filters.excludePaths,include:e.filters.includePaths}}:void 0},chunking:{enabled:!0,chunkSize:1024*1024,threshold:5*1024*1024},compression:{enabled:!0,algorithm:"gzip",minSize:1024},realtime:{enabled:e.transport!=="http",heartbeatInterval:3e4,reconnectDelay:5e3,maxReconnectAttempts:10}}}mapStrategyToDirection(e){switch(e){case"push":return"push";case"pull":return"pull";case"bidirectional":return"bidirectional";default:return"bidirectional"}}getOrCreatePeerId(){const e="vfs_sync_peer_id";let t=localStorage.getItem(e);return t||(t=`browser_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,localStorage.setItem(e,t)),t}async dispose(){this.autoSyncTimer&&(clearInterval(this.autoSyncTimer),this.autoSyncTimer=null),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.eventHandlers.clear(),this.logs=[],this.vfs=null,this.plugin=null,console.log("[SyncService] Disposed")}}const k=new No;class Do{constructor(e){this.container=e}storageInfo=null;async init(){if(navigator.storage?.estimate)try{this.storageInfo=await navigator.storage.estimate()}catch(e){console.error("Failed to get storage estimate:",e)}this.render()}render(){const e=this.storageInfo?.usage||0,t=this.storageInfo?.quota||1,s=(e/t*100).toFixed(1),n=(e/1024/1024).toFixed(2),i=(t/1024/1024/1024).toFixed(1),a=k.getStatus().lastSyncTime;this.container.innerHTML=`
      <div class="settings-storage-overview">
        <div class="settings-storage-visual">
          <svg width="120" height="120" viewBox="0 0 36 36" class="settings-circular-chart">
            <path class="settings-chart-bg" 
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
            <path class="settings-chart-fill" 
              stroke-dasharray="${s}, 100" 
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
            <text x="18" y="20.35" class="settings-chart-text">${s}%</text>
          </svg>
          <div class="settings-storage-stats">
            <div class="settings-stat-item">
              <span class="settings-stat-item__label"></span>
              <span class="settings-stat-item__value">${n} MB</span>
            </div>
            <div class="settings-stat-item">
              <span class="settings-stat-item__label"></span>
              <span class="settings-stat-item__value">${i} GB</span>
            </div>
            ${a?`
              <div class="settings-stat-item">
                <span class="settings-stat-item__label"></span>
                <span class="settings-stat-item__value">${$.formatTime(a)}</span>
              </div>
            `:""}
          </div>
        </div>
      </div>
    `}}class $o{constructor(e){this.container=e,this.syncConfig=k.getSettings(),this.syncStatus=k.getStatus()}syncConfig;syncStatus;syncLogs=[];syncConflicts=[];uiState={showConfig:!1,showLogs:!1,showAdvanced:!1};unsubscribers=[];boundEventHandlers=new Map;async init(){this.syncLogs=k.getLogs(20),this.syncConflicts=k.getConflicts(),this.subscribeEvents(),this.render()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.boundEventHandlers.clear()}subscribeEvents(){this.unsubscribers.push(k.on("stateChange",e=>{e.data?.status&&(this.syncStatus=e.data.status,this.updateStatusUI())}),k.on("progress",e=>{e.data&&(this.syncStatus={...this.syncStatus,progress:e.data},this.updateProgressUI())}),k.on("log",e=>{e.data?.cleared?this.syncLogs=[]:this.syncLogs=k.getLogs(20),this.updateLogsUI()}),k.on("conflict",()=>{this.syncConflicts=k.getConflicts(),this.updateConflictsUI(),this.syncConflicts.length>0&&m.warning(` ${this.syncConflicts.length} `)}),k.on("connected",()=>{m.success(""),this.updateConnectionUI(!0)}),k.on("disconnected",()=>{this.syncConfig.autoSync&&m.warning("..."),this.updateConnectionUI(!1)}),k.on("error",e=>{const t=e.data?.message||"";m.error(t)}),k.on("completed",()=>{}))}render(){const e=this.getSyncStateInfo(),t=this.syncConflicts.length>0;this.container.innerHTML=`
      <div class="settings-section sync-section">
        <!--  -->
        <div class="sync-header">
          <div class="sync-header__info">
            <h3 class="settings-section__title" style="margin:0">
              <i class="fas fa-cloud"></i> 
            </h3>
            <div class="sync-status" id="sync-status-display">
              <span class="sync-status__dot sync-status__dot--${this.syncStatus.state}"></span>
              <span class="sync-status__label">${e.label}</span>
              ${this.syncStatus.lastSyncTime?`<span class="sync-status__time"> ${$.formatTime(this.syncStatus.lastSyncTime)}</span>`:""}
              ${t?`<span class="settings-badge settings-badge--warning">
                  ${this.syncConflicts.length} 
                </span>`:""}
            </div>
          </div>
          <div class="sync-header__actions">
            <button id="btn-sync-now" class="settings-btn settings-btn--primary" 
              ${this.syncStatus.state==="syncing"?"disabled":""}>
              <i class="fas fa-sync ${this.syncStatus.state==="syncing"?"fa-spin":""}"></i>
              <span>${this.syncStatus.state==="syncing"?"...":""}</span>
            </button>
            <button id="btn-toggle-sync-config" class="settings-btn settings-btn--secondary">
              <i class="fas fa-cog"></i>
              <span></span>
            </button>
          </div>
        </div>

        <!--  -->
        <div id="sync-progress-container">
          ${this.renderSyncProgress()}
        </div>

        <!--  -->
        <div id="sync-conflicts-container">
          ${this.renderConflicts()}
        </div>

        <!--  -->
        <div id="sync-config-panel" class="sync-config-panel ${this.uiState.showConfig?"":"sync-config-panel--hidden"}">
          ${this.renderSyncConfigForm()}
        </div>
      </div>
    `,this.bindEvents()}renderSyncProgress(){if(this.syncStatus.state!=="syncing"||!this.syncStatus.progress)return"";const{phase:e,current:t,total:s,currentFile:n,bytesTransferred:i,bytesTotal:a,speed:o}=this.syncStatus.progress,r=s>0?Math.round(t/s*100):0;return`
      <div class="sync-progress">
        <div class="sync-progress__header">
          <span class="sync-progress__label">${{preparing:"...",uploading:"...",downloading:"...",applying:"...",finalizing:"..."}[e]||e}</span>
          <span class="sync-progress__percentage">${r}%</span>
        </div>
        <div class="sync-progress__bar">
          <div class="sync-progress__fill" style="width: ${r}%"></div>
        </div>
        <div class="sync-progress__details">
          <span>${t} / ${s} </span>
          ${n?`<span class="sync-progress__file" title="${$.escapeHtml(n)}">
              ${$.truncatePath(n,30)}
            </span>`:""}
          ${o?`<span class="sync-progress__speed">${$.formatSpeed(o)}</span>`:""}
          ${i&&a?`<span class="sync-progress__bytes">
              ${$.formatSize(i)} / ${$.formatSize(a)}
            </span>`:""}
        </div>
      </div>
    `}renderConflicts(){return this.syncConflicts.length===0?"":`
      <div class="sync-conflicts">
        <div class="sync-conflicts__header">
          <h4>
            <i class="fas fa-exclamation-triangle" style="color: var(--st-color-warning)"></i>
             (${this.syncConflicts.length})
          </h4>
          ${this.syncConflicts.length>1?`
            <div class="sync-conflicts__batch-actions">
              <button class="settings-btn settings-btn--sm settings-btn--secondary" id="btn-resolve-all-local">
                
              </button>
              <button class="settings-btn settings-btn--sm settings-btn--primary" id="btn-resolve-all-remote">
                
              </button>
            </div>
          `:""}
        </div>
        <div class="sync-conflicts__list">
          ${this.syncConflicts.map(e=>this.renderConflictItem(e)).join("")}
        </div>
      </div>
    `}renderConflictItem(e){const t={content:"",delete:"",move:"",metadata:"",create:"",update:""};return`
      <div class="sync-conflict-item" data-conflict-id="${e.conflictId}">
        <div class="sync-conflict-item__icon">${t[e.type]||""}</div>
        <div class="sync-conflict-item__info">
          <div class="sync-conflict-item__path" title="${$.escapeHtml(e.path)}">
            ${$.truncatePath(e.path,40)}
          </div>
          <div class="sync-conflict-item__desc">
            ${this.getConflictDescription(e)}
          </div>
        </div>
        <div class="sync-conflict-item__actions">
          <button class="settings-btn settings-btn--sm settings-btn--secondary btn-resolve-conflict" 
            data-id="${e.conflictId}" data-resolution="local" title="">
            <i class="fas fa-laptop"></i> 
          </button>
          <button class="settings-btn settings-btn--sm settings-btn--primary btn-resolve-conflict"
            data-id="${e.conflictId}" data-resolution="remote" title="">
            <i class="fas fa-cloud"></i> 
          </button>
        </div>
      </div>
    `}getConflictDescription(e){const t={content:"",delete:"",move:"",metadata:"",create:"",update:""},s=$.formatTime(e.localChange.timestamp),n=$.formatTime(e.remoteChange.timestamp);let i="";return e.localChange.size!==void 0&&e.remoteChange.size!==void 0&&(i=` |  ${$.formatSize(e.localChange.size)},  ${$.formatSize(e.remoteChange.size)}`),`${t[e.type]||e.type}  : ${s}  : ${n}${i}`}renderSyncConfigForm(){return`
      <div class="sync-config-panel__header">
        <span class="sync-config-panel__title">
          <i class="fas fa-cog"></i> 
        </span>
        <button id="btn-close-sync-config" class="settings-btn-icon" title="">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="sync-config-panel__body">
        <!--  -->
        <div id="connection-status-container">
          ${this.renderConnectionStatus()}
        </div>

        <!--  -->
        <div class="settings-form-group">
          <label for="inp-sync-url">
            <i class="fas fa-server"></i> 
          </label>
          <input type="text" id="inp-sync-url" class="settings-input" 
            placeholder="https://sync.example.com" 
            value="${$.escapeHtml(this.syncConfig.serverUrl||"")}">
          <small class="settings-form-hint">
            
          </small>
        </div>

        <div class="settings-form-row">
          <div class="settings-form-group" style="flex: 1;">
            <label for="inp-sync-user">
              <i class="fas fa-user"></i> 
            </label>
            <input type="text" id="inp-sync-user" class="settings-input" 
              placeholder="username" 
              value="${$.escapeHtml(this.syncConfig.username||"")}">
          </div>
          <div class="settings-form-group" style="flex: 1;">
            <label for="inp-sync-token">
              <i class="fas fa-key"></i> Token / API Key
            </label>
            <div class="settings-input-group">
              <input type="password" id="inp-sync-token" class="settings-input" 
                placeholder="sk-..." 
                value="${$.escapeHtml(this.syncConfig.token||"")}">
              <button type="button" id="btn-toggle-token-visibility" class="settings-btn-icon" title="/">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
        </div>

        <!--  -->
        <div class="settings-form-row">
          <div class="settings-form-group" style="flex: 1;">
            <label for="sel-sync-strategy">
              <i class="fas fa-exchange-alt"></i> 
            </label>
            <select id="sel-sync-strategy" class="settings-select">
              <option value="manual" ${this.syncConfig.strategy==="manual"?"selected":""}>
                 (Manual)
              </option>
              <option value="bidirectional" ${this.syncConfig.strategy==="bidirectional"?"selected":""}>
                 (Bidirectional)
              </option>
              <option value="push" ${this.syncConfig.strategy==="push"?"selected":""}>
                 (Push Only)
              </option>
              <option value="pull" ${this.syncConfig.strategy==="pull"?"selected":""}>
                 (Pull Only)
              </option>
            </select>
          </div>
          <div class="settings-form-group" style="flex: 1;">
            <label for="sel-conflict-resolution">
              <i class="fas fa-code-branch"></i> 
            </label>
            <select id="sel-conflict-resolution" class="settings-select">
              <option value="newer-wins" ${this.syncConfig.conflictResolution==="newer-wins"?"selected":""}>
                 (Newer Wins)
              </option>
              <option value="server-wins" ${this.syncConfig.conflictResolution==="server-wins"?"selected":""}>
                 (Server Wins)
              </option>
              <option value="client-wins" ${this.syncConfig.conflictResolution==="client-wins"?"selected":""}>
                 (Client Wins)
              </option>
              <option value="manual" ${this.syncConfig.conflictResolution==="manual"?"selected":""}>
                 (Manual)
              </option>
            </select>
          </div>
        </div>

        <!--  -->
        <div class="settings-form-row" style="align-items: center;">
          <label class="settings-checkbox-row" style="flex: 1;">
            <input type="checkbox" id="chk-auto-sync" ${this.syncConfig.autoSync?"checked":""}>
            <span></span>
          </label>
          <div class="settings-form-group" style="flex: 1; margin-bottom: 0;">
            <label for="inp-sync-interval"></label>
            <input type="number" id="inp-sync-interval" class="settings-input" 
              min="1" max="1440" 
              value="${this.syncConfig.autoSyncInterval||15}"
              ${this.syncConfig.autoSync?"":"disabled"}>
          </div>
        </div>

        <!--  -->
        <div class="settings-form-group">
          <label><i class="fas fa-network-wired"></i> </label>
          <div class="settings-radio-group">
            <label class="settings-radio-row">
              <input type="radio" name="transport" value="auto" 
                ${this.syncConfig.transport==="auto"?"checked":""}>
              <span> ()</span>
            </label>
            <label class="settings-radio-row">
              <input type="radio" name="transport" value="websocket"
                ${this.syncConfig.transport==="websocket"?"checked":""}>
              <span>WebSocket ()</span>
            </label>
            <label class="settings-radio-row">
              <input type="radio" name="transport" value="http"
                ${this.syncConfig.transport==="http"?"checked":""}>
              <span>HTTP ()</span>
            </label>
          </div>
        </div>

        <!--  -->
        ${this.syncStatus.errorMessage?`
          <div class="sync-error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span>${$.escapeHtml(this.syncStatus.errorMessage)}</span>
          </div>
        `:""}

        <!--  -->
        <div class="sync-config-panel__actions">
          <button id="btn-toggle-advanced" class="settings-btn settings-btn--sm settings-btn--text">
            <i class="fas fa-chevron-${this.uiState.showAdvanced?"up":"down"}"></i>
            <span></span>
          </button>
          <div class="sync-config-panel__buttons">
            <button id="btn-test-conn" class="settings-btn settings-btn--sm settings-btn--secondary">
              <i class="fas fa-plug"></i> 
            </button>
            <button id="btn-save-sync" class="settings-btn settings-btn--sm settings-btn--primary">
              <i class="fas fa-save"></i> 
            </button>
          </div>
        </div>

        <!--  -->
        <div id="advanced-options-container" class="${this.uiState.showAdvanced?"":"hidden"}">
          ${this.renderAdvancedSyncOptions()}
        </div>

        <!--  -->
        <div id="sync-logs-section" class="${this.uiState.showLogs?"":"hidden"}">
          ${this.renderSyncLogs()}
        </div>
      </div>
    `}renderConnectionStatus(){const e=this.syncStatus.connection;if(!e)return"";const t=e.connected?"connected":"disconnected",s=e.connected?"":"",n=e.connected?"":"",i=e.type==="websocket"?"WebSocket":"HTTP";return`
      <div class="sync-connection-status sync-connection-status--${t}">
        <div class="sync-connection-status__indicator">
          <i class="fas fa-${s}"></i>
        </div>
        <div class="sync-connection-status__info">
          <span class="sync-connection-status__title">${n}</span>
          <span class="sync-connection-status__detail">
            ${i}${e.latency?`   ${e.latency}ms`:""}
          </span>
        </div>
        ${e.connected?"":`
          <button id="btn-reconnect" class="settings-btn settings-btn--sm settings-btn--secondary">
            <i class="fas fa-redo"></i> 
          </button>
        `}
      </div>
    `}renderAdvancedSyncOptions(){const e=this.syncConfig.filters||{},t=(e.maxFileSize||100*1024*1024)/1024/1024;return`
      <div class="sync-advanced-options">
        <div class="sync-advanced-options__section">
          <h5><i class="fas fa-filter"></i> </h5>
          
          <div class="settings-form-row">
            <label class="settings-checkbox-row">
              <input type="checkbox" id="chk-exclude-binary" 
                ${e.excludeBinary?"checked":""}>
              <span></span>
            </label>
          </div>
          
          <div class="settings-form-row">
            <div class="settings-form-group" style="flex: 1;">
              <label for="inp-max-file-size"> (MB)</label>
              <input type="number" id="inp-max-file-size" class="settings-input" 
                min="1" max="1024" step="1"
                value="${t}"
                style="width: 120px;">
            </div>
          </div>

          <div class="settings-form-group">
            <label for="inp-exclude-paths"> ()</label>
            <textarea id="inp-exclude-paths" class="settings-textarea" rows="3" 
              placeholder="/temp/**&#10;*.log&#10;/cache/**">${(e.excludePaths||[]).join(`
`)}</textarea>
          </div>
        </div>

        <div class="sync-advanced-options__section">
          <h5><i class="fas fa-tools"></i> </h5>
          
          <div class="sync-advanced-options__buttons">
            <button id="btn-force-push" class="settings-btn settings-btn--sm settings-btn--warning" 
              title="">
              <i class="fas fa-arrow-up"></i> 
            </button>
            <button id="btn-force-pull" class="settings-btn settings-btn--sm settings-btn--warning"
              title="">
              <i class="fas fa-arrow-down"></i> 
            </button>
            <button id="btn-toggle-logs" class="settings-btn settings-btn--sm settings-btn--secondary">
              <i class="fas fa-list"></i> ${this.uiState.showLogs?"":""}
            </button>
          </div>
          
          <div class="sync-advanced-options__warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span></span>
          </div>
        </div>
      </div>
    `}renderSyncLogs(){return`
      <div class="sync-logs">
        <div class="sync-logs__header">
          <h5><i class="fas fa-history"></i> </h5>
          <button id="btn-clear-logs" class="settings-btn settings-btn--sm settings-btn--text" 
            ${this.syncLogs.length===0?"disabled":""}>
            <i class="fas fa-trash"></i> 
          </button>
        </div>
        <div class="sync-logs__container" id="sync-logs-list">
          ${this.renderLogEntries()}
        </div>
      </div>
    `}renderLogEntries(){return this.syncLogs.length===0?'<div class="sync-logs__empty"></div>':this.syncLogs.map(e=>`
      <div class="sync-log-entry sync-log-entry--${e.level}">
        <span class="sync-log-entry__icon">${this.getLogIcon(e.level)}</span>
        <span class="sync-log-entry__time">${$.formatLogTime(e.timestamp)}</span>
        <span class="sync-log-entry__message">${$.escapeHtml(e.message)}</span>
      </div>
    `).join("")}getLogIcon(e){return{info:"",success:"",warn:"",error:""}[e]||""}bindEvents(){this.bindClick("#btn-sync-now",()=>this.handleSync("standard")),this.bindClick("#btn-toggle-sync-config",()=>this.toggleSyncConfig()),this.bindClick("#btn-close-sync-config",()=>this.toggleSyncConfig(!1)),this.bindClick("#btn-save-sync",()=>this.saveSyncConfig()),this.bindClick("#btn-test-conn",()=>this.testConnection()),this.bindClick("#btn-reconnect",()=>this.handleReconnect()),this.bindClick("#btn-toggle-advanced",()=>this.toggleAdvanced()),this.bindClick("#btn-toggle-logs",()=>this.toggleLogs()),this.bindClick("#btn-clear-logs",()=>this.clearLogs()),this.bindClick("#btn-force-push",()=>this.confirmForceSync("force_push")),this.bindClick("#btn-force-pull",()=>this.confirmForceSync("force_pull")),this.bindClick("#btn-toggle-token-visibility",()=>this.toggleTokenVisibility()),this.bindChange("#chk-auto-sync",e=>{const t=this.container.querySelector("#inp-sync-interval");t&&(t.disabled=!e)}),this.container.querySelectorAll(".btn-resolve-conflict").forEach(e=>{e.addEventListener("click",t=>{const s=t.currentTarget,n=s.dataset.id,i=s.dataset.resolution;this.resolveConflict(n,i)})}),this.bindClick("#btn-resolve-all-local",()=>this.resolveAllConflicts("local")),this.bindClick("#btn-resolve-all-remote",()=>this.resolveAllConflicts("remote"))}bindClick(e,t){const s=this.container.querySelector(e);s&&s.addEventListener("click",t)}bindChange(e,t){const s=this.container.querySelector(e);s&&s.addEventListener("change",()=>t(s.checked))}updateStatusUI(){const e=this.getSyncStateInfo(),t=this.container.querySelector("#sync-status-display");if(t){const n=this.syncConflicts.length>0;t.innerHTML=`
        <span class="sync-status__dot sync-status__dot--${this.syncStatus.state}"></span>
        <span class="sync-status__label">${e.label}</span>
        ${this.syncStatus.lastSyncTime?`<span class="sync-status__time"> ${$.formatTime(this.syncStatus.lastSyncTime)}</span>`:""}
        ${n?`<span class="settings-badge settings-badge--warning">
            ${this.syncConflicts.length} 
          </span>`:""}
      `}const s=this.container.querySelector("#btn-sync-now");if(s){s.disabled=this.syncStatus.state==="syncing";const n=s.querySelector("i"),i=s.querySelector("span");n&&(n.className=`fas fa-sync ${this.syncStatus.state==="syncing"?"fa-spin":""}`),i&&(i.textContent=this.syncStatus.state==="syncing"?"...":"")}this.updateErrorUI()}updateProgressUI(){const e=this.container.querySelector("#sync-progress-container");e&&(e.innerHTML=this.renderSyncProgress())}updateConflictsUI(){const e=this.container.querySelector("#sync-conflicts-container");e&&(e.innerHTML=this.renderConflicts(),e.querySelectorAll(".btn-resolve-conflict").forEach(t=>{t.addEventListener("click",s=>{const n=s.currentTarget,i=n.dataset.id,a=n.dataset.resolution;this.resolveConflict(i,a)})}),this.bindClick("#btn-resolve-all-local",()=>this.resolveAllConflicts("local")),this.bindClick("#btn-resolve-all-remote",()=>this.resolveAllConflicts("remote")))}updateLogsUI(){const e=this.container.querySelector("#sync-logs-list");e&&this.uiState.showLogs&&(e.innerHTML=this.renderLogEntries())}updateConnectionUI(e){const t=this.container.querySelector("#connection-status-container");t&&(this.syncStatus.connection={type:this.syncConfig.transport==="http"?"http":"websocket",connected:e},t.innerHTML=this.renderConnectionStatus(),this.bindClick("#btn-reconnect",()=>this.handleReconnect()))}updateErrorUI(){const e=this.container.querySelector(".sync-error-message"),t=this.container.querySelector(".sync-config-panel__body");if(this.syncStatus.errorMessage){const s=`
        <div class="sync-error-message">
          <i class="fas fa-exclamation-circle"></i>
          <span>${$.escapeHtml(this.syncStatus.errorMessage)}</span>
          <button class="sync-error-message__dismiss" title="">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;if(e)e.outerHTML=s;else if(t){const i=t.querySelector(".sync-config-panel__actions");i&&i.insertAdjacentHTML("beforebegin",s)}const n=this.container.querySelector(".sync-error-message__dismiss");n&&n.addEventListener("click",()=>{this.syncStatus.errorMessage=void 0,this.updateErrorUI()})}else e&&e.remove()}async handleSync(e){if(this.uiState.showConfig)try{await this.saveSyncConfigSilent()}catch(t){console.warn("[SyncSection] Config save failed before sync",t)}if(!this.syncConfig.serverUrl){m.warning(""),this.toggleSyncConfig(!0);return}try{await k.triggerSync(e),e==="standard"?m.success(""):m.success(`${e==="force_push"?"":""}`)}catch(t){let s="";t.message?.includes("Failed to fetch")?s+=": ":t.message?.includes("401")||t.message?.includes("Unauthorized")?s+=":  Token":t.message?.includes("timeout")?s+=": ":s+=": "+(t.message||""),m.error(s)}}confirmForceSync(e){const t=e==="force_push",s=t?" ":" ",n=`
      <div class="modal-content-warning">
        <p>${t?"<strong></strong>":""}</p>
        <p class="text-danger">
          <i class="fas fa-exclamation-triangle"></i>
          ${t?"<strong></strong>":"<strong></strong>"}
        </p>
        <p class="text-muted"></p>
      </div>
    `;O.confirm(s,n,async()=>{await this.handleSync(e)})}async testConnection(){const e=this.container.querySelector("#btn-test-conn");if(!e)return;const t=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i> ...',e.disabled=!0;try{const s=this.getInputValue("#inp-sync-url").trim().replace(/\/$/,""),n=this.getInputValue("#inp-sync-user").trim(),i=this.getInputValue("#inp-sync-token").trim();if(!s){m.warning("");return}await k.testConnection(s,n,i)?(m.success(""),this.updateConnectionUI(!0)):(m.error(" Token"),this.updateConnectionUI(!1))}catch(s){let n="";s.message?.includes("Failed to fetch")?n=": ":s.message?.includes("CORS")?n=": ":n=": "+s.message,m.error(n),this.updateConnectionUI(!1)}finally{e.innerHTML=t,e.disabled=!1}}async handleReconnect(){const e=this.container.querySelector("#btn-reconnect");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> ...');try{await k.reconnect(),m.success("")}catch(t){m.error(": "+t.message)}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-redo"></i> ')}}async saveSyncConfig(){const e=this.container.querySelector("#btn-save-sync");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> ...');try{await this.saveSyncConfigSilent(),m.success("")}catch(t){m.error(": "+t.message)}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> ')}}async saveSyncConfigSilent(){const e=this.getInputValue("#inp-sync-url").trim().replace(/\/$/,""),t=this.getInputValue("#inp-sync-user").trim(),s=this.getInputValue("#inp-sync-token").trim(),n=this.getSelectValue("#sel-sync-strategy"),i=this.getSelectValue("#sel-conflict-resolution"),a=this.getCheckboxValue("#chk-auto-sync"),o=parseInt(this.getInputValue("#inp-sync-interval")||"15",10),r=this.getRadioValue("transport"),c=this.getCheckboxValue("#chk-exclude-binary"),d=parseFloat(this.getInputValue("#inp-max-file-size")||"100")*1024*1024,u=this.getTextareaValue("#inp-exclude-paths").split(`
`).map(p=>p.trim()).filter(p=>p.length>0);if(!e)throw new Error("");try{new URL(e)}catch{throw new Error("")}const g={serverUrl:e,username:t,token:s,strategy:n,conflictResolution:i,autoSync:a,autoSyncInterval:Math.max(1,Math.min(1440,o)),transport:r,filters:{excludeBinary:c,maxFileSize:d,excludePaths:u.length>0?u:void 0}};await k.saveSettings(g),this.syncConfig=g}async resolveConflict(e,t){const s=this.container.querySelector(`[data-id="${e}"][data-resolution="${t}"]`);if(s){s.disabled=!0;const n=s.innerHTML;s.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{await k.resolveConflict(e,t),this.syncConflicts=k.getConflicts(),this.updateConflictsUI(),this.updateStatusUI(),m.success(`: ${t==="local"?"":""}`)}catch(i){m.error(": "+i.message),s.innerHTML=n,s.disabled=!1}}}async resolveAllConflicts(e){const t=e==="local"?"":"";O.confirm("",` ${this.syncConflicts.length} ${t}`,async()=>{try{await k.resolveAllConflicts(e),this.syncConflicts=k.getConflicts(),this.updateConflictsUI(),this.updateStatusUI(),m.success(`${t}`)}catch(s){m.error(": "+s.message)}})}clearLogs(){k.clearLogs(),this.syncLogs=[],this.updateLogsUI(),m.info("")}toggleSyncConfig(e){this.uiState.showConfig=e!==void 0?e:!this.uiState.showConfig;const t=this.container.querySelector("#sync-config-panel");t&&(this.uiState.showConfig?(t.classList.remove("sync-config-panel--hidden"),this.syncConfig=k.getSettings()):(t.classList.add("sync-config-panel--hidden"),this.saveSyncConfigSilent().catch(n=>{console.warn("[SyncSection] Auto-save on close failed",n)})));const s=this.container.querySelector("#btn-toggle-sync-config");s&&s.classList.toggle("active",this.uiState.showConfig)}toggleAdvanced(){this.uiState.showAdvanced=!this.uiState.showAdvanced;const e=this.container.querySelector("#advanced-options-container"),t=this.container.querySelector("#btn-toggle-advanced");if(e&&e.classList.toggle("hidden",!this.uiState.showAdvanced),t){const s=t.querySelector("i");s&&(s.className=`fas fa-chevron-${this.uiState.showAdvanced?"up":"down"}`)}}toggleLogs(){this.uiState.showLogs=!this.uiState.showLogs;const e=this.container.querySelector("#sync-logs-section"),t=this.container.querySelector("#btn-toggle-logs");if(e&&(e.classList.toggle("hidden",!this.uiState.showLogs),this.uiState.showLogs&&(this.syncLogs=k.getLogs(50),e.innerHTML=this.renderSyncLogs(),this.bindClick("#btn-clear-logs",()=>this.clearLogs()))),t){const s=t.querySelector("span")||t;s.textContent&&(s.textContent=this.uiState.showLogs?"":"")}}toggleTokenVisibility(){const e=this.container.querySelector("#inp-sync-token"),t=this.container.querySelector("#btn-toggle-token-visibility");if(e&&t){const s=e.type==="password";e.type=s?"text":"password";const n=t.querySelector("i");n&&(n.className=`fas fa-eye${s?"-slash":""}`)}}getSyncStateInfo(){return{idle:{label:"",color:"var(--st-color-text-secondary)"},connecting:{label:"...",color:"var(--st-color-primary)"},syncing:{label:"...",color:"var(--st-color-primary)"},success:{label:"",color:"var(--st-color-success)"},error:{label:"",color:"var(--st-color-danger)"},offline:{label:"",color:"var(--st-color-warning)"},paused:{label:"",color:"var(--st-color-text-secondary)"}}[this.syncStatus.state]||{label:"",color:"var(--st-color-text-secondary)"}}getInputValue(e){return this.container.querySelector(e)?.value||""}getSelectValue(e){return this.container.querySelector(e)?.value||""}getCheckboxValue(e){return this.container.querySelector(e)?.checked||!1}getRadioValue(e){return this.container.querySelector(`input[name="${e}"]:checked`)?.value||""}getTextareaValue(e){return this.container.querySelector(e)?.value||""}}class Ro{constructor(e,t){this.container=e,this.service=t}snapshots=[];async init(){await this.loadSnapshots()}async loadSnapshots(){try{this.snapshots=await this.service.listLocalSnapshots(),this.render()}catch(e){console.error("Failed to list snapshots:",e)}}render(){this.container.innerHTML=`
      <div class="settings-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div>
            <h3 class="settings-section__title" style="margin: 0"> </h3>
            <p class="settings-page__description" style="margin: 5px 0 0 0;">
              
            </p>
          </div>
          <button id="btn-create-snapshot" class="settings-btn settings-btn--secondary">
            <i class="fas fa-camera"></i> 
          </button>
        </div>

        <div class="settings-snapshot-list">
          ${this.snapshots.length===0?`
            <div class="settings-empty settings-empty--mini">
              <i class="fas fa-box-open"></i>
              <p></p>
            </div>
          `:this.snapshots.map(e=>`
            <div class="snapshot-item" data-name="${e.name}">
              <div class="snapshot-item__icon"></div>
              <div class="snapshot-item__info">
                <p class="snapshot-item__title">${$.escapeHtml(e.displayName)}</p>
                <p class="snapshot-item__meta">
                  ${new Date(e.createdAt).toLocaleString()} 
                   ${(e.size/1024/1024).toFixed(2)} MB
                  ${e.description?`  ${e.description}`:""}
                </p>
              </div>
              <div class="settings-snapshot-actions">
                <button class="settings-btn settings-btn--sm settings-btn--secondary btn-restore-snap" 
                  data-name="${e.name}" title="">
                  <i class="fas fa-undo"></i> 
                </button>
                <button class="settings-btn settings-btn--sm settings-btn--secondary btn-download-snap"
                  data-name="${e.name}" title="">
                  <i class="fas fa-download"></i>
                </button>
                <button class="settings-btn settings-btn--sm settings-btn--danger btn-del-snap" 
                  data-name="${e.name}" title="">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `,this.bindEvents()}bindEvents(){this.container.querySelector("#btn-create-snapshot")?.addEventListener("click",()=>this.createSnapshot()),this.container.addEventListener("click",e=>{const t=e.target,s=t.closest(".btn-restore"),n=t.closest(".btn-download"),i=t.closest(".btn-delete");s&&this.restoreSnapshot(s.dataset.name),n&&this.downloadSnapshot(n.dataset.name),i&&this.deleteSnapshot(i.dataset.name)})}async createSnapshot(){const e=this.container.querySelector("#btn-create-snapshot");if(!e)return;const t=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i> ...',e.disabled=!0;try{await this.service.createSnapshot(),m.success(""),await this.loadSnapshots()}catch(s){m.error(": "+s.message)}finally{e.innerHTML=t,e.disabled=!1}}restoreSnapshot(e){const t=this.snapshots.find(s=>s.name===e);t&&O.confirm(" ",`<div style="line-height: 1.6;">
        <p><b></b></p>
        <p> <b>${t.displayName}</b> </p>
        <p style="color: var(--st-text-secondary);">
          : ${new Date(t.createdAt).toLocaleString()}
        </p>
        <p></p>
      </div>`,async()=>{try{m.info("..."),await this.service.restoreSnapshot(e),m.success("..."),setTimeout(()=>window.location.reload(),1500)}catch(s){m.error(": "+s.message)}})}async downloadSnapshot(e){try{const t=await this.exportSnapshot(e),n=`snapshot-${this.snapshots.find(i=>i.name===e)?.displayName||e}-${new Date().toISOString().slice(0,10)}.json`;$.downloadJson(t,n),m.success("")}catch(t){m.error(": "+t.message)}}async deleteSnapshot(e){const t=this.snapshots.find(s=>s.name===e);t&&O.confirm("",` "<b>${t.displayName}</b>" `,async()=>{try{await this.service.deleteSnapshot(e),m.success(""),await this.loadSnapshots()}catch(s){m.error(": "+s.message)}})}async exportSnapshot(e){const t=await this.getSnapshotData(e);if(!t)throw new Error(`Snapshot not found: ${e}`);return{meta:{name:e,exportedAt:Date.now(),version:"1.0"},data:t}}async getSnapshotData(e){return(await this.openSnapshotDB()).get("snapshots",e)}async openSnapshotDB(){}}const Ft={connections:"  (Connections)",mcpServers:" MCP ",tags:"  (Tags)",contacts:" "};class Po{constructor(e,t){this.container=e,this.service=t}init(){this.render()}render(){this.container.innerHTML=`
      <div class="settings-section" style="border-top: 1px solid var(--st-border-color); padding-top: 20px;">
        <h3 class="settings-section__title"> </h3>
        <p class="settings-page__description" style="margin-bottom: 15px;">
          
        </p>
        
        <div class="settings-storage-actions">
          <div class="settings-action-card">
            <div class="settings-action-card__icon"></div>
            <div class="settings-action-card__content">
              <h3></h3>
              <p> JSON </p>
            </div>
            <button id="btn-export-mixed" class="settings-btn settings-btn--secondary">
              <i class="fas fa-file-export"></i> ...
            </button>
          </div>
          
          <div class="settings-action-card">
            <div class="settings-action-card__icon"></div>
            <div class="settings-action-card__content">
              <h3></h3>
              <p> JSON </p>
            </div>
            <button id="btn-import-mixed" class="settings-btn settings-btn--primary">
              <i class="fas fa-file-import"></i> ...
            </button>
          </div>
        </div>
      </div>
    `,this.bindEvents()}bindEvents(){this.container.querySelector("#btn-export-mixed")?.addEventListener("click",()=>this.openExportModal()),this.container.querySelector("#btn-import-mixed")?.addEventListener("click",()=>this.triggerImportFlow())}openExportModal(){const e=this.service.getAvailableSettingsKeys(),t=this.service.getAvailableWorkspaces(),s=e.map(a=>`
      <label class="settings-checkbox-row">
        <input type="checkbox" name="export-settings" value="${a}" checked>
        <span>${Ft[a]||a}</span>
      </label>
    `).join(""),n=t.length>0?t.map(a=>`
          <label class="settings-checkbox-row">
            <input type="checkbox" name="export-modules" value="${a.name}">
            <div style="display: flex; flex-direction: column;">
              <span> ${a.name}</span>
              <small style="color: var(--st-text-secondary); font-size: 0.8em;">
                ${a.description||""}
              </small>
            </div>
          </label>
        `).join(""):'<div style="padding: 10px; color: var(--st-text-secondary); font-style: italic;"></div>',i=`
      <div class="settings-export-modal-content" style="padding: 0 10px;">
        <div style="margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid var(--st-border-color); padding-bottom: 5px;">
             
          </h4>
          <div class="settings-checklist-grid">${s}</div>
        </div>
        <div>
          <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid var(--st-border-color); padding-bottom: 5px;">
             
          </h4>
          <div class="settings-checklist-grid">${n}</div>
        </div>
        <div style="margin-top: 15px; text-align: right;">
          <small class="settings-link-btn" onclick="document.querySelectorAll('.settings-checklist-grid input').forEach(c => c.checked = true)">
            
          </small>
          <small class="settings-link-btn" onclick="document.querySelectorAll('.settings-checklist-grid input').forEach(c => c.checked = false)">
            
          </small>
        </div>
      </div>
      <style>
        .settings-checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .settings-link-btn { cursor: pointer; color: var(--st-color-primary); margin-left: 10px; }
        .settings-link-btn:hover { text-decoration: underline; }
      </style>
    `;new O("",i,{confirmText:"",onConfirm:async()=>{const a=document.querySelectorAll('input[name="export-settings"]:checked'),o=document.querySelectorAll('input[name="export-modules"]:checked'),r=Array.from(a).map(d=>d.value),c=Array.from(o).map(d=>d.value);if(r.length===0&&c.length===0)return m.warning(""),!1;try{const d=await this.service.exportMixedData(r,c),h=new Date().toISOString().slice(0,10);$.downloadJson(d,`backup-${h}.json`),m.success(`: ${r.length} , ${c.length} `)}catch(d){m.error(": "+d.message)}return!0}}).show()}triggerImportFlow(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const s=t.target.files[0];if(!s)return;const n=new FileReader;n.onload=async i=>{try{const a=JSON.parse(i.target.result);this.showImportSelectionModal(a)}catch{m.error(" JSON ")}},n.readAsText(s)},e.click()}showImportSelectionModal(e){const t=this.service.getAvailableSettingsKeys().filter(o=>e.settings&&Array.isArray(e.settings[o])||Array.isArray(e[o]));let s=[];if(e.modules&&Array.isArray(e.modules)&&(s=e.modules.filter(o=>{const r=o.module?.name||"";return!["__vfs_meta__","__config"].includes(r)})),t.length===0&&s.length===0){m.error("");return}const n=s.map(o=>{const r=o.module?.name||"Unknown";return`
        <label class="settings-checkbox-row">
          <input type="checkbox" name="import-modules" value="${r}">
          <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
            <span> ${r}</span>
            <span class="settings-badge settings-badge--warning" 
              style="font-size: 0.7em;"></span>
          </div>
        </label>
      `}).join(""),i=t.map(o=>`
      <label class="settings-checkbox-row">
        <input type="checkbox" name="import-settings" value="${o}" checked>
        <span>${Ft[o]||o}</span>
      </label>
    `).join(""),a=`
      <div class="settings-export-modal-content" style="padding: 0 5px;">
        <!--  -->
        <div style="background: var(--st-bg-tertiary); padding: 12px; border-radius: 6px; 
          margin-bottom: 15px; border-left: 4px solid var(--st-color-primary);">
          <h4 style="margin: 0 0 8px 0;"></h4>
          <label class="settings-checkbox-row" style="margin: 0;">
            <input type="checkbox" id="chk-overwrite-mode">
            <div>
              <span style="font-weight: bold;"></span>
              <p style="margin: 4px 0 0 0; font-size: 0.8em; color: var(--st-text-secondary);">
                
              </p>
            </div>
          </label>
        </div>

        ${n?`
          <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <h4 style="margin: 0;"> </h4>
              <div>
                <small class="settings-link-btn" 
                  onclick="document.querySelectorAll('input[name=import-modules]').forEach(c=>c.checked=true)">
                  
                </small>
                <small class="settings-link-btn" 
                  onclick="document.querySelectorAll('input[name=import-modules]').forEach(c=>c.checked=false)">
                  
                </small>
              </div>
            </div>
            <div class="settings-checklist-grid">${n}</div>
          </div>
        `:""}

        ${i?`
          <div style="margin-top: 20px;">
            <h4 style="margin: 0 0 5px 0;"> </h4>
            <p style="font-size: 0.8em; color: var(--st-text-secondary); margin: 0 0 10px 0;">
              
            </p>
            <div class="settings-checklist-grid">${i}</div>
          </div>
        `:""}
      </div>
      <style>
        .settings-checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .settings-link-btn { cursor: pointer; color: var(--st-color-primary); margin-left: 10px; }
        .settings-link-btn:hover { text-decoration: underline; }
      </style>
    `;new O("",a,{confirmText:"",onConfirm:async()=>{const o=document.querySelectorAll('input[name="import-settings"]:checked'),r=document.querySelectorAll('input[name="import-modules"]:checked'),c=document.querySelector("#chk-overwrite-mode"),d=Array.from(o).map(g=>g.value),h=Array.from(r).map(g=>g.value),u=c?.checked||!1;if(d.length===0&&h.length===0)return m.warning(""),!1;try{m.info("..."),await this.service.importMixedData(e,d,h,{overwrite:u,mergeTags:!0}),m.success("..."),setTimeout(()=>window.location.reload(),1500)}catch(g){m.error(": "+g.message)}return!0}}).show()}}class Oo{constructor(e,t){this.container=e,this.service=t}init(){this.render()}render(){this.container.innerHTML=`
      <div class="settings-section" style="margin-top: 40px; border-top: 1px solid var(--st-border-color); padding-top: 20px;">
        <details>
          <summary style="cursor: pointer; color: var(--st-text-secondary); font-size: 0.9em; user-select: none;">
             
          </summary>
          <div class="settings-storage-actions" style="margin-top: 15px;">
            <div class="settings-action-card settings-action-card--danger">
              <div class="settings-action-card__icon"></div>
              <div class="settings-action-card__content">
                <h3></h3>
                <p></p>
              </div>
              <button id="btn-reset" class="settings-btn settings-btn--danger">
                <i class="fas fa-bomb"></i> 
              </button>
            </div>
            
            <div class="settings-action-card">
              <div class="settings-action-card__icon"></div>
              <div class="settings-action-card__content">
                <h3></h3>
                <p></p>
              </div>
              <button id="btn-clear-sync-cache" class="settings-btn settings-btn--secondary">
                <i class="fas fa-broom"></i> 
              </button>
            </div>
          </div>
        </details>
      </div>
    `,this.bindEvents()}bindEvents(){this.container.querySelector("#btn-reset")?.addEventListener("click",()=>this.confirmFactoryReset()),this.container.querySelector("#btn-clear-sync-cache")?.addEventListener("click",()=>this.clearSyncCache())}confirmFactoryReset(){O.confirm(" ",`<div style="line-height: 1.6;">
        <p style="color: var(--st-color-danger); font-weight: bold;">
          
        </p>
        <p></p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li></li>
          <li></li>
          <li></li>
          <li></li>
        </ul>
        <p><b></b></p>
      </div>`,async()=>{try{m.info("..."),await this.service.factoryReset(),m.success("..."),setTimeout(()=>window.location.reload(),1e3)}catch(e){m.error(": "+e.message)}})}clearSyncCache(){O.confirm("","",async()=>{try{k.clearLogs(),m.success("")}catch(e){m.error(": "+e.message)}})}}class Fo extends pe{sections=[];isStructureInitialized=!1;async init(e){await super.init(e)}async render(){if(this.isStructureInitialized)return;this.container.innerHTML=`
      <div class="settings-page">
        <div class="settings-page__header">
          <div>
            <h2 class="settings-page__title"></h2>
            <p class="settings-page__description"></p>
          </div>
        </div>

        <div id="section-overview"></div>
        <div id="section-sync"></div>
        <div id="section-snapshot"></div>
        <div id="section-migration"></div>
        <div id="section-danger"></div>
      </div>
    `;const e=this.container.querySelector("#section-overview"),t=this.container.querySelector("#section-sync"),s=this.container.querySelector("#section-snapshot"),n=this.container.querySelector("#section-migration"),i=this.container.querySelector("#section-danger"),a=new Do(e),o=new $o(t),r=new Ro(s,this.service),c=new Po(n,this.service),d=new Oo(i,this.service);this.sections=[a,o,r,c,d],await Promise.all(this.sections.map(h=>h.init())),this.isStructureInitialized=!0}async destroy(){this.sections.forEach(e=>e.destroy&&e.destroy()),this.sections=[],this.isStructureInitialized=!1,await super.destroy()}}class Uo extends pe{render(){this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-about__header">
                    <div class="settings-about__logo"></div>
                    <h1 class="settings-page__title">AI Workspace</h1>
                    <p class="settings-page__description">v1.0.0</p>
                </div>

                <div class="settings-about__grid">
                    <div class="settings-info-card">
                        <h3></h3>
                        <ul class="settings-feature-list">
                            <li>TypeScript</li>
                            <li>VFS Core (IndexedDB)</li>
                            <li>Memory Manager</li>
                        </ul>
                    </div>
                    <div class="settings-info-card">
                        <h3></h3>
                        <p class="settings-page__description">
                             AI 
                        </p>
                    </div>
                </div>
            </div>
        `}}const Bo=(l,e)=>async(t,s)=>{const n=s.nodeId;await l.init();let i=null;switch(n){case"storage":i=new Fo(t,l,s);break;case"tags":i=new Ao(t,l,s);break;case"contacts":i=new Lo(t,l,s);break;case"connections":i=new Io(t,e,s);break;case"mcp-servers":i=new To(t,e,s);break;case"about":i=new Uo(t,l,s);break;default:return t.innerHTML='<div style="padding:2rem;text-align:center;color:#666">Select a setting category</div>',{init:async()=>{},destroy:async()=>{},getText:()=>"",setText:()=>{},focus:()=>{},getMode:()=>"render",switchToMode:async()=>{},setTitle:()=>{},setReadOnly:()=>{},isDirty:()=>!1,setDirty:()=>{},commands:{},getHeadings:async()=>[],getSearchableText:async()=>"",getSummary:async()=>null,search:async()=>[],gotoMatch:()=>{},clearSearch:()=>{},on:()=>()=>{},navigateTo:async()=>{}}}return i&&await i.init(t),i};async function Ho(l,e){const t=new Pa(l);await t.init();const s=new Oa(t),n=Bo(t,e);return{service:t,engine:s,factory:n}}class $s{constructor(e){this.vfs=e}engineCache=new Map;getFactory(){return Aa}getEngine(e){if(!this.engineCache.has(e)){const t=new ot(e,this.vfs);this.engineCache.set(e,t)}return this.engineCache.get(e)}}class zo{constructor(e,t){this.factory=e,this.engine=t}getFactory(){return this.factory}getEngine(e){return this.engine}}class qo{constructor(e,t){this.factory=e,this.engine=t}getFactory(){return this.factory}getEngine(e){return this.engine}}class Vo extends $s{constructor(e){super(e)}}const jo=JSON.stringify(we,null,2),Go=JSON.stringify({version:1,sessions:[]},null,2),Wo=`###  (Cloze)

 \`cloze\` /
****:  **/**

- ****: ---- 
- ** ID**: [c1]---- 
- ****:  ""  --Bonjour--^^audio:Bonjour^^

**  (  ) **:
MDxEditor  \`\` 

**1. **:
-- ()--

**2. **:
( <i class="fas fa-compress-alt"></i> )

--Markdown  John Gruber XHTML ( HTML)Markdown "" Markdown  MDxEditor --

**  **:


|  |  () |  |
| :--- | :--- | :--- |
| **HTML** | -- (HyperText Markup Language)-- |  |
| **CSS** | -- (Cascading Style Sheets)-- |  |
| **JS** | --JavaScript-- |  |
`,Ko=`# Welcome to Your Prompt Library!

This is your personal space to create, manage, and reuse powerful prompts for Large Language Models (LLMs).

## What is a Prompt?

A prompt is a piece of text that you provide to an AI model to get a specific response. A well-crafted prompt can dramatically improve the quality of the output.

## How to Use This Space

*   **Create a New Prompt**: Click the '+' icon in the sidebar to create a new prompt file.
*   **Organize**: Use folders to group related prompts, such as 'Marketing', 'Coding', or 'Creative Writing'.
*   **Use Variables**: You can use placeholders like \`{{variable_name}}\` in your prompts, which you can replace later.

### Example Prompt

\`\`\`markdown
Translate the following English text to French:

"{{text_to_translate}}"
\`\`\`
`,Qo=`# Manage Your Projects

This workspace helps you organize all your project-related documents, notes, and plans.

## Recommended Structure

We suggest creating a folder for each project. Inside each project folder, you could have files like:

*   **Goals.md**: High-level objectives and desired outcomes.
*   **Tasks.md**: A checklist of tasks to be completed.
*   **Meeting Notes**: A folder to store notes from project meetings.
*   **Research.md**: Links, summaries, and important findings.

Start by creating your first project folder using the folder icon in the sidebar!
`,Jo=`# Email Drafts & Templates

Draft your important emails here before sending them. You can also create reusable templates to save time.

## Example Template: Follow-up Email

\`\`\`markdown
**Subject: Following up on our conversation**

Hi {{contact_name}},

It was great speaking with you earlier today about {{topic}}.

I've attached the [document/link] we discussed. Please let me know if you have any questions.

Best regards,

[Your Name]
\`\`\`
`,Yo=`# Your Private Notes

This is a secure and private space for your thoughts, ideas, and personal reminders.

Anything you write here is stored locally in your browser and is not sent to any server.

Feel free to jot down anything that comes to mind!
`,Ut={markdown:{id:"markdown",label:"Note",extension:".md",defaultFileName:"Untitled.md",defaultContent:"",editorType:"standard"},anki:{id:"anki",label:"Card",extension:".anki",defaultFileName:"New Card.anki",defaultContent:Wo,editorType:"standard"},agent:{id:"agent",label:"Agent",extension:".agent",icon:"",defaultFileName:"New Assistant.agent",defaultContent:jo,editorType:"agent"},chat:{id:"chat",label:"Chat",extension:".chat",icon:"",defaultFileName:"New Session.chat",defaultContent:Go,editorType:"chat"},prompt:{id:"prompt",label:"Prompt",extension:".prompt",defaultFileName:"New Prompt.md",defaultContent:Ko,editorType:"standard"},project:{id:"project",label:"Project",extension:".prj",defaultFileName:"New Project.md",defaultContent:Qo,editorType:"standard"},email:{id:"email",label:"Email",extension:".email",defaultFileName:"Draft.md",defaultContent:Jo,editorType:"standard"},private:{id:"private",label:"Note",extension:".private",defaultFileName:"My Private Note.md",defaultContent:Yo,editorType:"standard"}},it={chat:"llm-workspace",agents:"agent-workspace",settings:"settings-workspace",anki:"anki-workspace",prompts:"prompt-workspace",projects:"project-workspace",emails:"email-workspace",private:"private-workspace",home:"llm-workspace"},Xo=Object.entries(it).reduce((l,[e,t])=>(l[t]||(l[t]=e),l),{}),De=new Map;function at(l){if(it[l])return it[l];if(document.getElementById(l))return l;const e=Me.find(t=>t.moduleName===l);return e?e.elementId:(console.warn(`[Router] Unknown target: ${l}, falling back to chat`),"llm-workspace")}function Bt(){const l=location.hash.slice(2).split("/"),e=l[0]||"chat",t=l[1]?decodeURIComponent(l[1]):void 0;return{workspace:at(e),resource:t==="new"?void 0:t,isCreate:t==="new"}}function re(l,e,t="push"){const s=Xo[l]||"home",n=e?`#/${s}/${encodeURIComponent(e)}`:`#/${s}`;if(location.hash!==n){const i={workspaceId:l,resourceId:e};t==="push"?history.pushState(i,"",n):history.replaceState(i,"",n)}}async function Zo(){try{const l=await Ra(),e=new So(l),t=new wo(l);await _o({agentService:e,sessionEngine:t,maxConcurrent:4});const s=await Ho(l,e),n=Mo(e),i=ko(e),a={standard:new $s(l),agent:new Vo(l),settings:new zo(s.factory,s.engine),chat:new qo(n,t)},r={standard:a.standard.getFactory(),agent:i,chat:n},c=g=>{const p=Ut[g];if(!p)return console.warn(`File type definition not found for id: ${g}`),null;let f;p.editorType!=="standard"&&(f=r[p.editorType]);const v=p.id==="chat"?Eo:void 0;return{extensions:[p.extension],icon:p.icon,editorFactory:f,contentParser:v}},d=async g=>{if(De.has(g))return De.get(g);const p=document.getElementById(g),f=Me.find(A=>A.elementId===g);if(!p||!f)return;const v=f.type||"standard",b=a[v]||a.standard,{moduleName:I,plugins:U,mentionScope:q,aiEnabled:B,supportedFileTypes:D,...H}=f,y=(D||[]).map(A=>c(A)).filter(A=>!!A),_=D?.[0],E=_?Ut[_]:void 0,z={...H,createFileLabel:E?.label||"File",defaultFileName:E?.defaultFileName,defaultExtension:E?.extension,defaultFileContent:E?.defaultContent,contextMenu:{items:(A,j)=>H.readOnly?[]:j}},V=new Da({container:p,customEngine:b.getEngine?.(I),moduleName:I,editorFactory:b.getFactory(),scopeId:g,fileTypes:y,uiOptions:z,editorConfig:{plugins:U||[],readOnly:!1,mentionScope:q},aiConfig:{enabled:B??!0},onNavigate:async A=>{const j=at(A.target);A.params?.action==="create"?((A.params.agentId||A.params.text)&&sessionStorage.setItem("app_create_params",JSON.stringify({target:A.target,agentId:A.params.agentId,text:A.params.text,timestamp:Date.now()})),re(j,null,"push")):re(j,A.resourceId||null,"push"),await h(j,A.resourceId,A.params)},onSessionChange:A=>{re(g,A,"replace")}});return await V.start(),De.set(g,V),V},h=async(g,p,f)=>{console.log(`[Router] Navigating to: ${g}`,{resourceId:p,params:f}),document.querySelectorAll(".workspace-view").forEach(b=>{b.classList.toggle("active",b.id===g)}),document.querySelectorAll(".app-nav-btn").forEach(b=>{const I=b.dataset.target;b.classList.toggle("active",I===g)});const v=await d(g);if(!v){console.error(`[Router] Failed to load workspace: ${g}`);return}p&&setTimeout(()=>{v.openFile(p)},10)};window.addEventListener("popstate",g=>{const p=g.state;if(p)h(p.workspaceId,p.resourceId);else{const f=Bt();h(f.workspace,f.resource)}}),document.querySelectorAll(".app-nav-btn").forEach(g=>{g.addEventListener("click",p=>{p.preventDefault();const f=p.currentTarget.dataset.target;if(f){const b=De.get(f)?.getActiveSessionId()||null;re(f,b,"push"),h(f,b||void 0)}})}),document.addEventListener(Hn.NAVIGATE,g=>{const{target:p,resourceId:f,params:v}=g.detail||{};if(p){const b=at(p);re(b,f||null,"push"),h(b,f,v)}});const u=Bt();await h(u.workspace,u.resource),re(u.workspace,u.resource||null,"replace")}catch(l){console.error("Failed to bootstrap application:",l)}}Zo();
