import{e as ps,p as gs,M as St,C as rt,m as Et,E as Z,a as xt,s as ms,l as fs,h as ys,b as vs,c as bs,f as ws,d as Ss,g as Es,i as xs,j as _s,k as Is,n as Ts,o as Cs,r as ks,q as Ms,t as Ns,u as ee,v as Ls,w as As,x as Ds,y as $s,z as Rs,A as Ps,B as Me,D as Os,F as _t,T as Fs,G as Bs,H as Us}from"./vendor-BtkpvKMz.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const w={VNODES:"vnodes",CONTENTS:"vfs_contents",TAGS:"tags",NODE_TAGS:"node_tags",SRS_ITEMS:"srs_items"};var I=(l=>(l.FILE="file",l.DIRECTORY="directory",l))(I||{});const lt={create(l){return{parentId:null,moduleId:null,contentRef:null,size:0,createdAt:Date.now(),modifiedAt:Date.now(),metadata:{},tags:[],...l}},clone(l,e){return{...l,...e,metadata:{...l.metadata},tags:[...l.tags]}}};class Hs{constructor(e){this.tx=e}getStore(e){return this.tx.objectStore(e)}get done(){return new Promise((e,t)=>{this.tx.oncomplete=()=>e(),this.tx.onerror=()=>t(this.tx.error),this.tx.onabort=()=>t(new Error("Transaction aborted"))})}}class Q{constructor(e="vfs_database"){this.dbName=e}db=null;static VERSION=6;static promisify(e){return new Promise((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})}async connect(){this.db||(this.db=await new Promise((e,t)=>{const s=indexedDB.open(this.dbName,Q.VERSION);s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result),s.onupgradeneeded=n=>this.handleUpgrade(n)}))}handleUpgrade(e){const t=e.target.result,s=e.target.transaction,n=e.oldVersion,i=[{version:1,migrate:o=>this.createBaseStores(o)},{version:3,migrate:o=>this.createTagStores(o)},{version:4,migrate:(o,a)=>this.addSearchIndexes(o,a)},{version:5,migrate:(o,a)=>this.initTagRefCounts(a)},{version:6,migrate:o=>this.createSRSStore(o)}];for(const{version:o,migrate:a}of i)n<o&&a(t,s)}createBaseStores(e){if(!e.objectStoreNames.contains(w.VNODES)){const t=e.createObjectStore(w.VNODES,{keyPath:"nodeId"});t.createIndex("path","path",{unique:!0}),t.createIndex("parentId","parentId"),t.createIndex("moduleId","moduleId"),t.createIndex("type","type"),console.log("Created vnodes store with indexes")}e.objectStoreNames.contains(w.CONTENTS)||e.createObjectStore(w.CONTENTS,{keyPath:"contentRef"}).createIndex("nodeId","nodeId")}createTagStores(e){if(e.objectStoreNames.contains(w.TAGS)||(e.createObjectStore(w.TAGS,{keyPath:"name"}),console.log("Created tags store")),!e.objectStoreNames.contains(w.NODE_TAGS)){const t=e.createObjectStore(w.NODE_TAGS,{autoIncrement:!0});t.createIndex("nodeId","nodeId"),t.createIndex("tagName","tagName"),t.createIndex("nodeId_tagName",["nodeId","tagName"],{unique:!0}),console.log("Created node_tags store with indexes")}}addSearchIndexes(e,t){if(!t||!e.objectStoreNames.contains(w.VNODES))return;const s=t.objectStore(w.VNODES);s.indexNames.contains("name")||s.createIndex("name","name"),s.indexNames.contains("tags")||s.createIndex("tags","tags",{multiEntry:!0})}initTagRefCounts(e){const t=w.TAGS,s=w.NODE_TAGS;if(!e.objectStoreNames.contains(t)||!e.objectStoreNames.contains(s))return;const n=e.objectStore(t),i=e.objectStore(s),o=n.getAll();o.onsuccess=()=>{const a=o.result;if(!a.length)return;const r=new Map;a.forEach(d=>r.set(d.name,0));const c=i.openCursor();c.onsuccess=()=>{const d=c.result;if(d){const h=d.value,u=r.get(h.tagName)??0;r.set(h.tagName,u+1),d.continue()}else a.forEach(h=>{h.refCount=r.get(h.name)??0,n.put(h)}),console.log(`[Database] Initialized refCount for ${a.length} tags`)},c.onerror=()=>{console.error("[Database] Failed to count tag references:",c.error)}},o.onerror=()=>{console.error("[Database] Failed to load tags:",o.error)}}createSRSStore(e){if(!e.objectStoreNames.contains(w.SRS_ITEMS)){const t=e.createObjectStore(w.SRS_ITEMS,{keyPath:["nodeId","clozeId"]});t.createIndex("nodeId","nodeId"),t.createIndex("moduleId","moduleId"),t.createIndex("dueAt","dueAt"),t.createIndex("moduleId_dueAt",["moduleId","dueAt"])}}getTransaction(e,t="readonly"){if(!this.db)throw new Error("Database not connected");const s=Array.isArray(e)?e:[e];return new Hs(this.db.transaction(s,t))}disconnect(){this.db?.close(),this.db=null,console.log("Database disconnected")}async destroy(){return this.disconnect(),new Promise((e,t)=>{const s=indexedDB.deleteDatabase(this.dbName);s.onsuccess=()=>{console.log(`Database '${this.dbName}' deleted successfully`),e()},s.onerror=()=>{console.error("Failed to delete database:",s.error),t(s.error)},s.onblocked=()=>{console.warn("Delete database blocked. Please close other tabs of this app.")}})}}class ve{constructor(e,t){this.db=e,this.storeName=t}async execute(e,t,s){const n=s??this.db.getTransaction(this.storeName,e),i=n.getStore(this.storeName),o=await Q.promisify(t(i));return s||await n.done,o}async get(e,t){return this.execute("readonly",s=>s.get(e),t)}async put(e,t){await this.execute("readwrite",s=>s.put(e),t)}async delete(e,t){await this.execute("readwrite",s=>s.delete(e),t)}async getAll(e){return this.execute("readonly",t=>t.getAll(),e)}async getAllByIndex(e,t,s){return this.execute("readonly",n=>n.index(e).getAll(t),s)}async scanCursor(e,t,s,n=i=>i){return new Promise((i,o)=>{const a=[],r=e.openCursor(t);r.onsuccess=()=>{const c=r.result;c&&a.length<s?(a.push(n(c.value)),c.continue()):i(a)},r.onerror=()=>o(r.error)})}async deleteByIndex(e,t,s){const i=s.getStore(this.storeName).index(e),o=IDBKeyRange.only(t);return new Promise((a,r)=>{const c=i.openCursor(o);c.onsuccess=()=>{const d=c.result;d?(d.delete(),d.continue()):a()},c.onerror=()=>r(c.error)})}}class zs extends ve{constructor(e){super(e,w.VNODES)}async getByPath(e,t){return(await this.execute("readonly",n=>n.index("path").get(e),t))?.nodeId??null}async getChildren(e,t){return this.getAllByIndex("parentId",e,t)}async getByModule(e){return this.getAllByIndex("moduleId",e)}async getModuleRoot(e){return(await this.getByModule(e)).find(s=>s.parentId===null)??null}}class He extends ve{constructor(e){super(e,w.CONTENTS)}static createRef(e){return`content_${e}`}async getByNodeId(e){return(await this.getAllByIndex("nodeId",e))[0]??null}}class qs extends ve{constructor(e){super(e,w.TAGS)}async create(e,t){await this.execute("readwrite",s=>s.add({refCount:0,...e}),t)}async adjustRefCount(e,t,s){const n=s.getStore(this.storeName),i=await Q.promisify(n.get(e));i?(i.refCount=Math.max(0,(i.refCount||0)+t),await Q.promisify(n.put(i))):t>0&&await Q.promisify(n.add({name:e,refCount:t,createdAt:Date.now()}))}async deleteTag(e,t){if((await this.get(e,t))?.isProtected)throw new Error(`Tag '${e}' is protected`);await this.delete(e,t)}}class js extends ve{constructor(e){super(e,w.NODE_TAGS)}async add(e,t,s){const n=s??this.db.getTransaction(this.storeName,"readwrite"),i=n.getStore(this.storeName);return new Promise((o,a)=>{const r=i.add({nodeId:e,tagName:t});r.onsuccess=()=>o(!0),r.onerror=c=>{r.error?.name==="ConstraintError"?(c.preventDefault(),c.stopPropagation(),o(!1)):a(r.error)}}).finally(async()=>{s||await n.done})}async remove(e,t,s){const n=s??this.db.getTransaction(this.storeName,"readwrite"),i=n.getStore(this.storeName),o=i.index("nodeId_tagName"),a=await Q.promisify(o.getKey([e,t]));a&&await Q.promisify(i.delete(a)),s||await n.done}async getTagsForNode(e,t){return(await this.getAllByIndex("nodeId",e,t)).map(n=>n.tagName)}async getNodesForTag(e){return(await this.getAllByIndex("tagName",e)).map(s=>s.nodeId)}async removeAllForNode(e,t){await this.deleteByIndex("nodeId",e,t)}}class Vs extends ve{constructor(e){super(e,w.SRS_ITEMS)}async getItem(e,t,s){return this.get([e,t],s)}async getAllForNode(e){return this.getAllByIndex("nodeId",e)}async deleteForNode(e,t){await this.deleteByIndex("nodeId",e,t)}async updateModuleIdForNode(e,t,s){const i=s.getStore(this.storeName).index("nodeId"),o=IDBKeyRange.only(e);return new Promise((a,r)=>{const c=i.openCursor(o);c.onsuccess=()=>{const d=c.result;if(d){const h=d.value;h.moduleId!==t&&(h.moduleId=t,d.update(h)),d.continue()}else a()},c.onerror=()=>r(c.error)})}async getDueItems(e,t=50){const n=this.db.getTransaction(this.storeName,"readonly").getStore(this.storeName),i=Date.now();if(e){const r=n.index("moduleId_dueAt"),c=IDBKeyRange.bound([e,0],[e,i]);return this.scanCursor(r,c,t)}const o=n.index("dueAt"),a=IDBKeyRange.upperBound(i);return this.scanCursor(o,a,t)}}var x=(l=>(l.NOT_FOUND="NOT_FOUND",l.ALREADY_EXISTS="ALREADY_EXISTS",l.INVALID_PATH="INVALID_PATH",l.INVALID_OPERATION="INVALID_OPERATION",l.PERMISSION_DENIED="PERMISSION_DENIED",l.TRANSACTION_FAILED="TRANSACTION_FAILED",l))(x||{});class _ extends Error{constructor(e,t,s){super(t),this.code=e,this.details=s,this.name="VFSError"}}var M=(l=>(l.NODE_CREATED="node:created",l.NODE_UPDATED="node:updated",l.NODE_DELETED="node:deleted",l.NODE_MOVED="node:moved",l.NODE_COPIED="node:copied",l.NODES_BATCH_UPDATED="nodes:batch_updated",l.NODES_BATCH_MOVED="nodes:batch_moved",l.NODES_BATCH_DELETED="nodes:batch_deleted",l))(M||{});class Ws{constructor(e){this.getNodeIdByPath=e}normalize(e){if(!e||e===".")return"/";const t=e.split("/").filter(n=>n&&n!=="."),s=[];for(const n of t)n===".."?s.pop():s.push(n);return"/"+s.join("/")}isValid(e){return typeof e!="string"?!1:e==="/"?!0:!e.startsWith("/")||e.includes("//")?!1:!/[<>:"|?*\x00-\x1f]/.test(e)}toSystemPath(e,t){const s=this.normalize(t);return s==="/"?`/${e}`:`/${e}${s}`}toUserPath(e,t){const s=`/${t}`;return e.startsWith(s)?e.slice(s.length)||"/":(console.warn(`PathResolver: System path '${e}' does not belong to module '${t}'`),e)}basename(e){const t=this.normalize(e);return t==="/"?"":t.substring(t.lastIndexOf("/")+1)}dirname(e){const t=e.lastIndexOf("/");return t<=0?"/":e.substring(0,t)}join(...e){return this.normalize(e.join("/"))}async resolve(e,t){const s=this.normalize(t);if(!this.isValid(s))throw new _(x.INVALID_PATH,`Invalid path: ${t}`);return this.getNodeIdByPath(this.toSystemPath(e,s))}async resolveParent(e,t){const s=this.normalize(t);return s==="/"?null:this.resolve(e,this.dirname(s))}}class Gs{storage;pathResolver;middlewares;events;constructor(e,t,s){this.storage=e,this.middlewares=t,this.events=s,this.pathResolver=new Ws(n=>e.getNodeIdByPath(n))}async initialize(){await this.storage.connect()}destroy(){this.storage.disconnect(),this.events.clear()}async createNode(e){const{module:t,path:s,type:n,content:i,metadata:o={}}=e,a=this.pathResolver.normalize(s);if(!this.pathResolver.isValid(a))throw new _(x.INVALID_PATH,`Invalid path: ${s}`);const r=this.pathResolver.toSystemPath(t,a);if(await this.storage.getNodeIdByPath(r))throw new _(x.ALREADY_EXISTS,`Node exists: ${a}`);let c=null;a!=="/"&&(c=await this.ensureParentDirectory(t,this.pathResolver.dirname(a)));const d=this.generateId(),h=n===I.FILE?He.createRef(d):null,u=lt.create({nodeId:d,parentId:c,name:this.pathResolver.basename(a),type:n,path:r,moduleId:t,contentRef:h,metadata:o});n===I.FILE&&i!==void 0&&await this.middlewares.runValidation(u,i);const p=this.storage.beginTransaction();try{if(n===I.FILE){const m=i??"",{processedContent:g,derivedData:y}=await this.processWrite(u,m,p);u.metadata={...u.metadata,...y},u.size=this.getContentSize(g)}return await this.storage.inodeStore.put(u,p),await p.done,this.emitEvent(M.NODE_CREATED,u,{type:n,module:t}),u}catch(m){throw this.wrapError(m,"Failed to create node")}}async read(e){const t=await this.resolveNode(e);if(t.type!==I.FILE)throw new _(x.INVALID_OPERATION,`Cannot read directory: ${t.nodeId}`);return t.contentRef?(await this.storage.contentStore.get(t.contentRef))?.content??"":""}async write(e,t){const s=await this.resolveNode(e);if(s.type!==I.FILE)throw new _(x.INVALID_OPERATION,`Cannot write to directory: ${s.nodeId}`);await this.middlewares.runValidation(s,t);const n=this.storage.beginTransaction();try{const{processedContent:i,derivedData:o}=await this.processWrite(s,t,n);return s.metadata={...s.metadata,...o},s.size=this.getContentSize(i),s.modifiedAt=Date.now(),await this.storage.inodeStore.put(s,n),await n.done,this.emitEvent(M.NODE_UPDATED,s),s}catch(i){throw this.wrapError(i,"Failed to write content")}}async unlink(e,t={}){let s;try{s=await this.resolveNode(e)}catch(a){if(a instanceof _&&a.code===x.NOT_FOUND)return{removedNodeId:typeof e=="string"?e:e.nodeId,allRemovedIds:[]};throw a}const n=await this.collectDescendants(s);if(s.type===I.DIRECTORY&&n.length>1&&!t.recursive)throw new _(x.INVALID_OPERATION,`Directory not empty: ${s.nodeId}`);for(const a of n)if(a.metadata?.isProtected)throw new _(x.PERMISSION_DENIED,`Node '${a.name}' is protected`);const i=n.map(a=>a.nodeId),o=this.storage.beginTransaction([w.VNODES,w.CONTENTS,w.NODE_TAGS,w.TAGS,w.SRS_ITEMS]);try{for(const a of n)await this.middlewares.runBeforeDelete(a,o),a.contentRef&&await this.storage.contentStore.delete(a.contentRef,o),await this.storage.cleanupNodeTags(a.nodeId,o),await this.storage.srsStore.deleteForNode(a.nodeId,o),await this.storage.inodeStore.delete(a.nodeId,o),await this.middlewares.runAfterDelete(a,o);return await o.done,this.emitEvent(M.NODE_DELETED,s,{removedIds:i}),{removedNodeId:s.nodeId,allRemovedIds:i}}catch(a){throw this.wrapError(a,"Failed to delete node")}}async batchDelete(e){if(!e.length)return 0;const t=this.storage.beginTransaction([w.VNODES,w.CONTENTS,w.NODE_TAGS,w.TAGS,w.SRS_ITEMS]),s=new Set;try{for(const n of e){if(s.has(n))continue;const i=await this.storage.loadVNode(n,t);if(!i)continue;const o=await this.collectDescendants(i,t);for(const a of o){if(a.metadata?.isProtected)throw new _(x.PERMISSION_DENIED,`Node '${a.name}' is protected`);s.has(a.nodeId)||(await this.middlewares.runBeforeDelete(a,t),a.contentRef&&await this.storage.contentStore.delete(a.contentRef,t),await this.storage.cleanupNodeTags(a.nodeId,t),await this.storage.srsStore.deleteForNode(a.nodeId,t),await this.storage.inodeStore.delete(a.nodeId,t),await this.middlewares.runAfterDelete(a,t),s.add(a.nodeId))}}return await t.done,s.size>0&&this.events.emit({type:M.NODES_BATCH_DELETED,nodeId:null,path:null,timestamp:Date.now(),data:{removedNodeIds:Array.from(s)}}),s.size}catch(n){throw this.wrapError(n,"Failed to batch delete")}}async move(e,t){const s=await this.resolveNode(e),n=s.moduleId,i=this.pathResolver.normalize(t);if(!this.pathResolver.isValid(i))throw new _(x.INVALID_PATH,`Invalid path: ${t}`);const o=this.pathResolver.toSystemPath(n,i),a=await this.storage.getNodeIdByPath(o);if(a&&a!==s.nodeId)throw new _(x.ALREADY_EXISTS,`Node exists: ${i}`);const r=await this.pathResolver.resolveParent(n,i),c=s.path,d=this.storage.beginTransaction([w.VNODES,w.SRS_ITEMS,w.CONTENTS]);try{return s.parentId=r,s.name=this.pathResolver.basename(i),s.path=o,s.modifiedAt=Date.now(),await this.storage.inodeStore.put(s,d),s.type===I.DIRECTORY&&await this.updateDescendantPaths(s,c,o,n,d),await this.middlewares.runAfterMove(s,c,o,d),await d.done,this.emitEvent(M.NODE_MOVED,s,{oldPath:c,newPath:o}),s}catch(h){throw this.wrapError(h,"Failed to move node")}}async batchMove(e,t){if(!e.length)return;let s=null;if(t){if(s=await this.storage.loadVNode(t),!s)throw new _(x.NOT_FOUND,`Target parent not found: ${t}`);if(s.type!==I.DIRECTORY)throw new _(x.INVALID_OPERATION,"Cannot move into a file")}const n=this.storage.beginTransaction([w.VNODES,w.NODE_TAGS,w.SRS_ITEMS,w.CONTENTS]),i=[];try{for(const o of e){const a=await this.storage.loadVNode(o,n);if(!a)continue;if(t){if(o===t)throw new _(x.INVALID_OPERATION,"Cannot move into itself");let p=s;for(;p?.parentId;){if(p.parentId===o)throw new _(x.INVALID_OPERATION,"Cannot move into descendant");p=await this.storage.loadVNode(p.parentId,n)}}const r=a.moduleId,c=s?.moduleId??r,d=a.path,h=s?this.pathResolver.join(s.path,a.name):this.pathResolver.toSystemPath(c,"/"+a.name),u=await this.storage.getNodeIdByPath(h,n);if(u&&u!==o)throw new _(x.ALREADY_EXISTS,`Node exists: ${h}`);c!==r&&(a.moduleId=c,await this.storage.srsStore.updateModuleIdForNode(o,c,n)),a.parentId=t,a.path=h,a.modifiedAt=Date.now(),await this.storage.inodeStore.put(a,n),a.type===I.DIRECTORY&&await this.updateDescendantPaths(a,d,h,c,n),await this.middlewares.runAfterMove(a,d,h,n),i.push(o)}await n.done,i.length>0&&this.events.emit({type:M.NODES_BATCH_MOVED,nodeId:null,path:null,timestamp:Date.now(),data:{movedNodeIds:i,targetParentId:t}})}catch(o){throw this.wrapError(o,"Failed to batch move")}}async copy(e,t){const s=await this.resolveNode(e),n=s.moduleId,i=this.pathResolver.normalize(t);if(!this.pathResolver.isValid(i))throw new _(x.INVALID_PATH,`Invalid path: ${t}`);const o=this.pathResolver.toSystemPath(n,i);if(await this.storage.getNodeIdByPath(o))throw new _(x.ALREADY_EXISTS,`Node exists: ${i}`);const a=this.pathResolver.dirname(i);let r=await this.pathResolver.resolve(n,a);!r&&i!=="/"&&(r=await this.ensureParentDirectory(n,a));const c=await this.loadNodeTree(s),d=this.planCopyOperations(c,r,i,n),h=d.map(m=>m.newNode.nodeId),u=d[0]?.newNode.nodeId,p=this.storage.beginTransaction([w.VNODES,w.CONTENTS,w.NODE_TAGS]);try{for(const g of d){await this.storage.inodeStore.put(g.newNode,p),g.sourceContent&&g.newNode.contentRef&&await this.storage.contentStore.put({contentRef:g.newNode.contentRef,nodeId:g.newNode.nodeId,content:g.sourceContent.content,size:g.sourceContent.size,createdAt:Date.now()},p);for(const y of g.newNode.tags)await this.storage.nodeTagStore.add(g.newNode.nodeId,y,p)}const m=await this.storage.loadVNode(u,p);return s&&m&&await this.middlewares.runAfterCopy(s,m,p),await p.done,this.emitEvent(M.NODE_COPIED,{nodeId:u,path:o},{sourceId:e,copiedIds:h}),{sourceId:e,targetId:u,copiedIds:h}}catch(m){throw this.wrapError(m,"Failed to copy node")}}async readdir(e){const t=await this.resolveNode(e);if(t.type!==I.DIRECTORY)throw new _(x.INVALID_OPERATION,`Not a directory: ${t.nodeId}`);return this.storage.getChildren(t.nodeId)}async searchNodes(e,t){return this.storage.searchNodes(e,t)}async updateMetadata(e,t){const s=await this.resolveNode(e),n=this.storage.beginTransaction();try{return s.metadata=t,s.modifiedAt=Date.now(),await this.storage.inodeStore.put(s,n),await n.done,this.emitEvent(M.NODE_UPDATED,s,{metadataOnly:!0}),s}catch(i){throw this.wrapError(i,"Failed to update metadata")}}async setTags(e,t){const s=typeof e=="string"?e:e.nodeId;await this.batchSetTags([{nodeId:s,tags:t}])}async batchSetTags(e){if(!e.length)return;const t=this.storage.beginTransaction([w.VNODES,w.TAGS,w.NODE_TAGS]),s=[];try{for(const{nodeId:n,tags:i}of e){const o=await this.storage.loadVNode(n,t);if(!o)continue;const a=new Set(o.tags),r=new Set(i);let c=!1;for(const d of r)a.has(d)||(await this.storage.addTagToNode(n,d,t),c=!0);for(const d of a)r.has(d)||(await this.storage.removeTagFromNode(n,d,t),c=!0);c&&s.push(n)}await t.done,s.length>0&&this.events.emit({type:M.NODES_BATCH_UPDATED,nodeId:null,path:null,timestamp:Date.now(),data:{updatedNodeIds:s}})}catch(n){throw this.wrapError(n,"Failed to batch set tags")}}async addTag(e,t){const s=await this.resolveNode(e);await this.storage.addTagToNode(s.nodeId,t),this.emitEvent(M.NODE_UPDATED,s,{tagAdded:t})}async removeTag(e,t){const s=await this.resolveNode(e);await this.storage.removeTagFromNode(s.nodeId,t),this.emitEvent(M.NODE_UPDATED,s,{tagRemoved:t})}async getTags(e){return(await this.resolveNode(e)).tags}async findByTag(e){const t=await this.storage.nodeTagStore.getNodesForTag(e);if(!t.length)return[];const s=[];for(const n of t){const i=await this.storage.loadVNode(n);i&&s.push(i)}return s}async resolveNode(e){if(typeof e!="string")return e;const t=await this.storage.loadVNode(e);if(!t)throw new _(x.NOT_FOUND,`Node not found: ${e}`);return t}async ensureParentDirectory(e,t){const s=await this.pathResolver.resolve(e,t);if(s){if((await this.storage.loadVNode(s))?.type!==I.DIRECTORY)throw new _(x.INVALID_OPERATION,`Not a directory: ${t}`);return s}if(t==="/")throw new _(x.NOT_FOUND,`Root not found for module: ${e}`);return await this.ensureParentDirectory(e,this.pathResolver.dirname(t)),(await this.createNode({module:e,path:t,type:I.DIRECTORY,metadata:{createdBy:"system_recursive"}})).nodeId}async collectDescendants(e,t){const s=[e];if(e.type===I.DIRECTORY){const n=await this.storage.getChildren(e.nodeId,t);for(const i of n)s.push(...await this.collectDescendants(i,t))}return s}async updateDescendantPaths(e,t,s,n,i){const o=await this.storage.getChildren(e.nodeId,i);for(const a of o)a.path.startsWith(t)&&(a.path=s+a.path.substring(t.length)),a.moduleId!==n&&(a.moduleId=n,await this.storage.srsStore.updateModuleIdForNode(a.nodeId,n,i)),await this.storage.inodeStore.put(a,i),a.type===I.DIRECTORY&&await this.updateDescendantPaths(a,t,s,n,i)}async processWrite(e,t,s){const n=await this.middlewares.runBeforeWrite(e,t,s);e.contentRef&&await this.storage.contentStore.put({contentRef:e.contentRef,nodeId:e.nodeId,content:n,size:this.getContentSize(n),createdAt:Date.now()},s);const i=await this.middlewares.runAfterWrite(e,n,s);return{processedContent:n,derivedData:i}}async loadNodeTree(e){const t={node:e,content:null,children:[]};if(e.type===I.FILE&&e.contentRef)t.content=await this.storage.contentStore.get(e.contentRef)??null;else if(e.type===I.DIRECTORY){const s=await this.storage.getChildren(e.nodeId);t.children=await Promise.all(s.map(n=>this.loadNodeTree(n)))}return t}planCopyOperations(e,t,s,n){const i=[];return this.buildCopyOperations(e,t,s,n,i),i}buildCopyOperations(e,t,s,n,i){const{node:o,content:a,children:r}=e,c=this.generateId(),d=this.pathResolver.toSystemPath(n,s),h=o.type===I.FILE&&o.contentRef?He.createRef(c):null,u=lt.create({nodeId:c,parentId:t,name:this.pathResolver.basename(s),type:o.type,path:d,moduleId:n,contentRef:h,size:o.size,metadata:{...o.metadata},tags:[...o.tags]});i.push({newNode:u,sourceContent:a});for(const p of r){const m=this.pathResolver.join(s,p.node.name);this.buildCopyOperations(p,c,m,n,i)}return c}emitEvent(e,t,s){this.events.emit({type:e,nodeId:t.nodeId,path:t.path,moduleId:t.moduleId??void 0,timestamp:Date.now(),data:s})}wrapError(e,t){return e instanceof _?e:new _(x.TRANSACTION_FAILED,t,e)}generateId(){return`node_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}getContentSize(e){return typeof e=="string"?new Blob([e]).size:e.byteLength}}class Ne{db;connected=!1;inodeStore;contentStore;tagStore;nodeTagStore;srsStore;constructor(e="vfs_database"){this.db=new Q(e)}async connect(){if(this.connected){console.warn("VFSStorage already connected");return}await this.db.connect(),this.inodeStore=new zs(this.db),this.contentStore=new He(this.db),this.tagStore=new qs(this.db),this.nodeTagStore=new js(this.db),this.srsStore=new Vs(this.db),this.connected=!0}disconnect(){this.db.disconnect(),this.connected=!1}async destroyDatabase(){await this.db.destroy(),this.connected=!1}beginTransaction(e=Object.values(w),t="readwrite"){return this.ensureConnected(),this.db.getTransaction(e,t)}async loadVNode(e,t){this.ensureConnected();const s=await this.inodeStore.get(e,t);return s&&(s.tags=await this.nodeTagStore.getTagsForNode(e,t)),s??null}async getNodeIdByPath(e,t){return this.ensureConnected(),this.inodeStore.getByPath(e,t)}async getChildren(e,t){this.ensureConnected();const s=await this.inodeStore.getChildren(e,t);return await Promise.all(s.map(async n=>{n.tags=await this.nodeTagStore.getTagsForNode(n.nodeId,t)})),s}async addTagToNode(e,t,s){this.ensureConnected();const n=s??this.beginTransaction([w.VNODES,w.TAGS,w.NODE_TAGS]);try{await this.tagStore.get(t,n)||await this.tagStore.create({name:t,createdAt:Date.now()},n),await this.nodeTagStore.add(e,t,n)&&await this.tagStore.adjustRefCount(t,1,n);const a=await this.inodeStore.get(e,n);a&&!a.tags.includes(t)&&(a.tags.push(t),await this.inodeStore.put(a,n)),s||await n.done}catch(i){throw i}}async removeTagFromNode(e,t,s){this.ensureConnected();const n=s??this.beginTransaction([w.VNODES,w.TAGS,w.NODE_TAGS]);try{const i=await this.inodeStore.get(e,n);if(i?.tags.includes(t)){await this.nodeTagStore.remove(e,t,n),await this.tagStore.adjustRefCount(t,-1,n);const o=i.tags.indexOf(t);o>-1&&i.tags.splice(o,1),await this.inodeStore.put(i,n)}s||await n.done}catch(i){throw i}}async cleanupNodeTags(e,t){const s=await this.nodeTagStore.getTagsForNode(e,t);if(s.length>0){await this.nodeTagStore.removeAllForNode(e,t);for(const n of s)await this.tagStore.adjustRefCount(n,-1,t)}}async searchNodes(e,t){this.ensureConnected();const n=this.db.getTransaction(w.VNODES,"readonly").getStore(w.VNODES);let i;return t?i=n.index("moduleId").openCursor(IDBKeyRange.only(t)):e.type?i=n.index("type").openCursor(IDBKeyRange.only(e.type)):i=n.openCursor(),new Promise((o,a)=>{const r=[];i.onerror=()=>a(i.error),i.onsuccess=()=>{const c=i.result;if(!c)return o(r);const d=c.value;this.matchesQuery(d,e)&&r.push(d),e.limit&&r.length>=e.limit?o(r):c.continue()}})}matchesQuery(e,t){if(t.type&&e.type!==t.type||t.nameContains&&!e.name.toLowerCase().includes(t.nameContains.toLowerCase())||t.tags?.length&&!t.tags.every(s=>e.tags?.includes(s)))return!1;if(t.metadata){const s=e.metadata||{};if(!Object.entries(t.metadata).every(([n,i])=>s[n]===i))return!1}return!0}ensureConnected(){if(!this.connected)throw new Error("VFSStorage not connected")}}let Js=class{listeners=new Map;on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e){this.listeners.get(e.type)?.forEach(t=>{try{t(e)}catch(s){console.error(`Event handler error for ${e.type}:`,s)}})}clear(){this.listeners.clear()}};class Qs{middlewares=new Map;hooks=new Map;register(e){this.middlewares.set(e.name,e),this.triggerHook("registered",e.name)}async unregister(e){const t=this.middlewares.get(e);return t?(await t.cleanup?.(),this.middlewares.delete(e),this.triggerHook("unregistered",e),!0):!1}get(e){return this.middlewares.get(e)}getAll(){return Array.from(this.middlewares.values())}getForNode(e){return this.getAll().filter(t=>!t.canHandle||t.canHandle(e)).sort((t,s)=>(s.priority??0)-(t.priority??0))}async runValidation(e,t){for(const s of this.getForNode(e))await s.onValidate?.(e,t)}async runBeforeWrite(e,t,s){let n=t;for(const i of this.getForNode(e))i.onBeforeWrite&&(n=await i.onBeforeWrite(e,n,s));return n}async runAfterWrite(e,t,s){const n={};for(const i of this.getForNode(e))i.onAfterWrite&&Object.assign(n,await i.onAfterWrite(e,t,s));return n}async runBeforeDelete(e,t){for(const s of this.getForNode(e))await s.onBeforeDelete?.(e,t)}async runAfterDelete(e,t){for(const s of this.getForNode(e))await s.onAfterDelete?.(e,t)}async runAfterMove(e,t,s,n){for(const i of this.getForNode(e))await i.onAfterMove?.(e,t,s,n)}async runAfterCopy(e,t,s){for(const n of this.getForNode(t))await n.onAfterCopy?.(e,t,s)}onHook(e,t){return this.hooks.has(e)||this.hooks.set(e,new Set),this.hooks.get(e).add(t),()=>this.hooks.get(e)?.delete(t)}triggerHook(e,t){this.hooks.get(e)?.forEach(s=>{try{s(t)}catch(n){console.error(n)}})}async clear(){await Promise.all(this.getAll().map(e=>e.cleanup?.())),this.middlewares.clear(),this.hooks.clear()}}class z{static instance=null;vfs;eventBus;middlewareRegistry;modules=new Map;config;initialized=!1;constructor(e={}){this.config={dbName:e.dbName??"vfs_database",defaultModule:e.defaultModule??"default",middlewares:e.middlewares??[]}}static getInstance(e){return z.instance||(z.instance=new z(e)),z.instance}get dbName(){return this.config.dbName}async init(){if(this.initialized){console.warn("VFS already initialized");return}const e=new Ne(this.config.dbName);this.eventBus=new Js,this.middlewareRegistry=new Qs,this.vfs=new Gs(e,this.middlewareRegistry,this.eventBus),await this.vfs.initialize(),await this.loadModuleRegistry(),await this.registerMiddlewares(),await this.ensureDefaultModule(),this.initialized=!0}async shutdown(){this.initialized&&(await this.saveModuleRegistry(),await this.middlewareRegistry.clear(),this.vfs.destroy(),this.initialized=!1,z.instance=null)}async systemReset(){this.initialized&&await this.shutdown(),await new Ne(this.config.dbName).destroyDatabase(),console.log("System reset complete.")}async mount(e,t={}){if(this.ensureInit(),this.modules.has(e))throw new _(x.ALREADY_EXISTS,`Module '${e}' exists`);const s=typeof t=="string"?{description:t}:t,n=await this.vfs.createNode({module:e,path:"/",type:I.DIRECTORY}),i={name:e,rootNodeId:n.nodeId,description:s.description,isProtected:s.isProtected,createdAt:Date.now()};return this.modules.set(e,i),await this.saveModuleRegistry(),i}async unmount(e){this.ensureInit();const t=this.modules.get(e);if(!t)throw new _(x.NOT_FOUND,`Module '${e}' not found`);await this.vfs.unlink(t.rootNodeId,{recursive:!0}),this.modules.delete(e),await this.saveModuleRegistry()}getModule(e){return this.modules.get(e)}getAllModules(){return Array.from(this.modules.values())}async createFile(e,t,s="",n){this.ensureInit(),this.ensureModule(e);const i=s instanceof ArrayBuffer,o={...n,isBinary:i,mimeType:n?.mimeType??(i?"application/octet-stream":"text/plain")},a=await this.vfs.createNode({module:e,path:t,type:I.FILE,content:s,metadata:o});return this.toPublicNode(a)}async createDirectory(e,t,s){this.ensureInit(),this.ensureModule(e);const n=await this.vfs.createNode({module:e,path:t,type:I.DIRECTORY,metadata:s});return this.toPublicNode(n)}async read(e,t){this.ensureInit();const s=await this.resolvePath(e,t);return this.vfs.read(s)}async write(e,t,s){this.ensureInit();const n=await this.resolvePath(e,t),i=await this.vfs.write(n,s);return this.toPublicNode(i)}async delete(e,t,s=!1){this.ensureInit();const n=await this.vfs.pathResolver.resolve(e,t);n&&await this.vfs.unlink(n,{recursive:s})}async deleteNodes(e){return this.ensureInit(),this.vfs.batchDelete(e)}async rename(e,t){this.ensureInit();const s=await this.vfs.storage.loadVNode(e);if(!s)throw new _(x.NOT_FOUND,`Node not found: ${e}`);const n=this.vfs.pathResolver.dirname(s.path),i=n==="/"?`/${t}`:`${n}/${t}`,o=this.vfs.pathResolver.toUserPath(i,s.moduleId);await this.vfs.move(e,o)}async batchMoveNodes(e,t,s){this.ensureInit(),await this.vfs.batchMove(t,s)}async updateMetadata(e,t,s){this.ensureInit();const n=await this.resolvePath(e,t);await this.vfs.updateMetadata(n,s)}async updateNodeMetadata(e,t){this.ensureInit(),await this.vfs.updateMetadata(e,t)}async getTree(e,t="/"){this.ensureInit();const s=await this.resolvePath(e,t);return(await this.vfs.readdir(s)).map(i=>this.toPublicNode(i))}async setNodeTags(e,t,s){this.ensureInit();const n=await this.resolvePath(e,t);await this.vfs.setTags(n,s)}async setNodeTagsById(e,t){this.ensureInit(),await this.vfs.setTags(e,t)}async batchSetNodeTags(e){this.ensureInit(),await this.vfs.batchSetTags(e)}async addTag(e,t,s){this.ensureInit();const n=await this.resolvePath(e,t);await this.vfs.addTag(n,s.trim())}async removeTag(e,t,s){this.ensureInit();const n=await this.resolvePath(e,t);await this.vfs.removeTag(n,s.trim())}async getTags(e,t){this.ensureInit();const s=await this.resolvePath(e,t);return this.vfs.getTags(s)}async findByTag(e){return this.ensureInit(),(await this.vfs.findByTag(e.trim())).map(s=>this.toPublicNode(s))}async getAllTags(){return this.ensureInit(),this.vfs.storage.tagStore.getAll()}async updateTag(e,t){this.ensureInit();const s=await this.vfs.storage.tagStore.get(e);s?(t.color!==void 0&&(s.color=t.color),await this.vfs.storage.tagStore.put(s)):await this.vfs.storage.tagStore.create({name:e,color:t.color,createdAt:Date.now()})}async deleteTagDefinition(e){this.ensureInit(),await this.vfs.storage.tagStore.deleteTag(e)}async searchNodes(e,t,s){return this.ensureInit(),(await this.vfs.searchNodes(e,t)).filter(o=>o.moduleId===s?!0:!(o.moduleId&&this.modules.get(o.moduleId)?.isProtected)).map(o=>this.toPublicNode(o))}async updateSRSItem(e,t,s,n){this.ensureInit();const i=await this.resolvePath(e,t);await this.updateSRSItemById(i,s,n)}async updateSRSItemById(e,t,s){this.ensureInit();const n=this.vfs.storage.beginTransaction([w.SRS_ITEMS,w.VNODES]);try{const i=await this.vfs.storage.loadVNode(e,n);if(!i)throw new _(x.NOT_FOUND,"Node not found");const o=await this.vfs.storage.srsStore.getItem(e,t,n),a={nodeId:e,clozeId:t,moduleId:i.moduleId,dueAt:s.dueAt??Date.now(),interval:s.interval??0,ease:s.ease??2.5,reviewCount:(o?.reviewCount??0)+1,lastReviewedAt:Date.now(),...s};await this.vfs.storage.srsStore.put(a,n),await n.done}catch(i){throw new _(x.TRANSACTION_FAILED,"Failed to update SRS",i)}}async getSRSItemsForFile(e,t){this.ensureInit();const s=await this.vfs.pathResolver.resolve(e,t);return s?this.getSRSItemsByNodeId(s):{}}async getSRSItemsByNodeId(e){const t=await this.vfs.storage.srsStore.getAllForNode(e);return Object.fromEntries(t.map(s=>[s.clozeId,s]))}async getDueSRSItems(e,t=50){return this.ensureInit(),this.vfs.storage.srsStore.getDueItems(e,t)}async createSystemBackup(){this.ensureInit();const e={version:1,timestamp:Date.now(),modules:[]};for(const t of this.modules.values())try{e.modules.push(await this.exportModule(t.name))}catch(s){console.warn(`Skipping module ${t.name}:`,s)}return JSON.stringify(e,null,2)}async restoreSystemBackup(e){const t=this.parseBackup(e);await this.systemReset(),z.instance=null,await this.init();for(const s of t.modules??[])try{await this.importModule(s)}catch(n){console.error(`Failed to restore ${s?.module?.name}:`,n)}}async restoreSystemBackupIncrementally(e,t={}){this.ensureInit();const s=this.parseBackup(e);for(const n of s.modules??[]){const i=n.module.name;this.modules.has(i)||await this.mount(i,{description:n.module.description,isProtected:n.module.isProtected}),await this.mergeTree(i,"/",n.tree,t)}}async exportModule(e){this.ensureInit();const t=this.modules.get(e);if(!t)throw new _(x.NOT_FOUND,`Module not found: ${e}`);const s=await this.vfs.storage.loadVNode(t.rootNodeId);if(!s)throw new _(x.NOT_FOUND,"Root node not found");return{module:t,tree:await this.exportTree(s)}}async importModule(e){this.ensureInit();const t=e.module;if(this.modules.has(t.name))throw new _(x.ALREADY_EXISTS,`Module exists: ${t.name}`);await this.mount(t.name,t.description),await this.importTree(t.name,"/",e.tree)}getVFS(){return this.ensureInit(),this.vfs}getEventBus(){return this.ensureInit(),this.eventBus}getMiddlewareRegistry(){return this.ensureInit(),this.middlewareRegistry}ensureInit(){if(!this.initialized)throw new _(x.INVALID_OPERATION,"VFS not initialized")}ensureModule(e){if(!this.modules.has(e))throw new _(x.NOT_FOUND,`Module not found: ${e}`)}async resolvePath(e,t){const s=await this.vfs.pathResolver.resolve(e,t);if(!s)throw new _(x.NOT_FOUND,`Node not found: ${e}:${t}`);return s}toPublicNode(e){return e.moduleId?{...e,path:this.vfs.pathResolver.toUserPath(e.path,e.moduleId),metadata:{...e.metadata},tags:[...e.tags]}:e}async loadModuleRegistry(){if(await this.vfs.storage.getNodeIdByPath("/__vfs_meta__"))try{const s=await this.vfs.pathResolver.resolve("__vfs_meta__","/modules");if(s){const n=await this.vfs.read(s),i=JSON.parse(n);this.modules=new Map(Object.entries(i))}}catch(s){console.warn("Failed to load module registry:",s)}}async saveModuleRegistry(){this.modules.has("__vfs_meta__")||await this.mount("__vfs_meta__",{description:"VFS metadata",isProtected:!0});const e=Object.fromEntries(this.modules),t=JSON.stringify(e,null,2);try{const s=await this.vfs.pathResolver.resolve("__vfs_meta__","/modules");s?await this.vfs.write(s,t):await this.createFile("__vfs_meta__","/modules",t)}catch(s){console.error("Failed to save module registry:",s)}}async registerMiddlewares(){for(const e of this.config.middlewares){const t=new e;t.initialize?.(this.vfs.storage,this.eventBus),this.middlewareRegistry.register(t)}}async ensureDefaultModule(){this.modules.has(this.config.defaultModule)||await this.mount(this.config.defaultModule,"Default module")}parseBackup(e){try{return JSON.parse(e)}catch{throw new _(x.INVALID_OPERATION,"Invalid backup JSON")}}async exportTree(e){const t=this.toPublicNode(e),s=await this.getSRSItemsByNodeId(e.nodeId),n={name:t.name,type:t.type,metadata:t.metadata,tags:t.tags,srs:s};if(t.type===I.FILE)n.content=await this.vfs.read(t.nodeId);else{const i=await this.vfs.readdir(t.nodeId);n.children=await Promise.all(i.map(o=>this.exportTree(o)))}return n}async importTree(e,t,s){if(s.name==="/"||t==="/"&&s.name===e){for(const o of s.children??[])await this.importTree(e,"/",o);return}const n=t==="/"?`/${s.name}`:`${t}/${s.name}`;let i;if(s.type===I.FILE)i=await this.createFile(e,n,s.content,s.metadata);else{i=await this.createDirectory(e,n,s.metadata);for(const o of s.children??[])await this.importTree(e,n,o)}if(s.tags?.length)for(const o of s.tags)await this.vfs.addTag(i.nodeId,o)}async mergeTree(e,t,s,n){const{overwrite:i=!1,mergeTags:o=!0}=n;if(s.name==="/"||t==="/"&&s.name===e){for(const d of s.children??[])await this.mergeTree(e,"/",d,n);return}const a=t==="/"?`/${s.name}`:`${t}/${s.name}`,r=await this.vfs.pathResolver.resolve(e,a);let c=r;if(r){const d=await this.vfs.storage.loadVNode(r);if(d&&d.type===s.type){if(s.type===I.FILE&&i&&s.content!==void 0&&await this.write(e,a,s.content),s.metadata){const h=i?{...d.metadata,...s.metadata}:{...s.metadata,...d.metadata};await this.updateMetadata(e,a,h)}if(o&&s.tags?.length)for(const h of s.tags)d.tags.includes(h)||await this.addTag(e,a,h)}}else{let d;s.type===I.FILE?d=await this.createFile(e,a,s.content,s.metadata):d=await this.createDirectory(e,a,s.metadata),c=d.nodeId,s.tags?.length&&await this.vfs.setTags(c,s.tags)}if(c&&s.srs&&(!r||i))for(const[d,h]of Object.entries(s.srs))await this.updateSRSItemById(c,d,{...h,nodeId:c,moduleId:e});if(s.type===I.DIRECTORY&&s.children)for(const d of s.children)await this.mergeTree(e,a,d,n)}static async copyDatabase(e,t){console.log(`[VFSCore] Starting DB copy: ${e} -> ${t}`),await new Promise((a,r)=>{const c=indexedDB.deleteDatabase(t);c.onsuccess=()=>a(),c.onerror=()=>r(c.error)});const s=new Ne(t);await s.connect(),s.disconnect();const[n,i]=await Promise.all([ct(e),ct(t)]),o=Object.values(w);for(const a of o)n.objectStoreNames.contains(a)&&i.objectStoreNames.contains(a)&&await Ks(n,i,a);n.close(),i.close()}}function ct(l){return new Promise((e,t)=>{const s=indexedDB.open(l);s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}function Ks(l,e,t){return new Promise((s,n)=>{const i=l.transaction(t,"readonly"),o=e.transaction(t,"readwrite"),a=i.objectStore(t),r=o.objectStore(t),c=a.openCursor();c.onsuccess=()=>{const d=c.result;d&&(r.put(d.value),d.continue())},o.oncomplete=()=>s(),o.onerror=()=>n(o.error)})}async function Ys(l,e="default"){const t={dbName:l,defaultModule:e},s=z.getInstance(t);return await s.init(),s}class Ge{constructor(){if(this.constructor===Ge)throw new Error("IEditor is an interface and cannot be instantiated directly.")}async pruneAssets(){return null}async getHeadings(){return[]}async getSearchableText(){return this.getText().replace(/^#+\s/gm,"").replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/```[\s\S]*?```/g,"").replace(/`[^`]+`/g,"").trim()}async getSummary(){return null}}class Ie{constructor(){if(this.constructor===Ie)throw new Error("IAutocompleteSource is an interface and cannot be instantiated directly.")}}class Xs extends Ie{triggerChar="@";async getDataForProcess(e){return null}async handleClick(e){console.log(`[IMentionSource:${this.key}] Clicked:`,e.toString())}async getHoverPreview(e){return null}async getContentForTransclusion(e){return null}}class Je{constructor(){if(this.constructor===Je)throw new Error("ISessionUI is an interface and cannot be instantiated directly.")}}function T(l){if(!l)return"";const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return l.replace(/[&<>"']/g,t=>e[t]||t)}function $(){return"node-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}function me(){return Math.random().toString(36).substring(2,10)}function Zs(l,e){let t;const s=function(...n){clearTimeout(t);const i=this;t=setTimeout(()=>l.apply(i,n),e)};return s.cancel=()=>clearTimeout(t),s}function fe(l){const e=l.split(".").pop()?.toLowerCase();return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",bmp:"image/bmp",ico:"image/x-icon",pdf:"application/pdf",txt:"text/plain",md:"text/markdown",json:"application/json",xml:"application/xml",html:"text/html",css:"text/css",js:"application/javascript",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",mp3:"audio/mpeg",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed"}[e||""]||"application/octet-stream"}class en{id="markdown-analyzer";supportedExtensions;supportedMimeTypes=new Set(["text/markdown","text/plain"]);constructor(e=[".md",".markdown",".mdx",".txt"]){this.supportedExtensions=new Set(e.map(t=>t.startsWith(".")?t:`.${t}`))}supports(e){const t=e.filename.lastIndexOf(".");if(t!==-1){const s=e.filename.substring(t).toLowerCase();if(this.supportedExtensions.has(s))return!0}return!!(e.mimeType&&this.supportedMimeTypes.has(e.mimeType))}async analyze(e,t){const s=typeof e=="string"?e:new TextDecoder().decode(e),n=new Set;return this.extractAssetProtocolRefs(s,n),this.extractSidecarRefs(s,t.filePath,n),this.extractRelativePathRefs(s,n),{references:Array.from(n)}}extractAssetProtocolRefs(e,t){const s=/@asset\/([^\s)"']+)/g;let n;for(;(n=s.exec(e))!==null;){const i=this.extractFilename(n[1]);i&&t.add(i)}}extractSidecarRefs(e,t,s){const n=t.split("/").pop();if(!n)return;const o=`.${n}`.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=[new RegExp(`\\]\\(\\s*${o}\\/([^)\\s]+)`,"g"),new RegExp(`(?:src|href)=["']${o}\\/([^"']+)["']`,"g")];for(const r of a){let c;for(;(c=r.exec(e))!==null;)try{const d=decodeURIComponent(c[1]),h=this.extractFilename(d);h&&s.add(h)}catch{const d=this.extractFilename(c[1]);d&&s.add(d)}}}extractRelativePathRefs(e,t){const s=/\]\(\s*(?:\.\/)?([^)\s"']+)\s*(?:"[^"]*")?\s*\)/g;let n;for(;(n=s.exec(e))!==null;){const o=n[1];if(this.shouldSkipPath(o))continue;const a=this.extractFilename(o);a&&t.add(a)}const i=/(?:src|href)=["'](?:\.\/)?([^"']+)["']/g;for(;(n=i.exec(e))!==null;){const o=n[1];if(this.shouldSkipPath(o))continue;const a=this.extractFilename(o);a&&t.add(a)}}shouldSkipPath(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("javascript:")||e.startsWith("#")||e.startsWith("/")}extractFilename(e){if(!e)return null;const s=e.split("?")[0].split("#")[0].split("/").pop();return!s||s==="."||s===".."?null:s}}function It(l){return typeof l!="string"?"":l.toLowerCase().trim().replace(/[\s\-_]+/g,"-").replace(/[^\w\u4e00-\u9fa5-]/g,"").replace(/^-+|-+$/g,"")}function Te(l){if(!l)return null;const e=l.trim();if(!e.startsWith("{")&&!e.startsWith("[")||e.startsWith("{")&&!e.endsWith("}")||e.startsWith("[")&&!e.endsWith("]"))return null;try{return JSON.parse(e)}catch{return null}}function Ce(l){const e=l.split(`
`),t=[];let s=!1,n="",i=0;for(const a of e){const r=a.match(/^(`{3,}|~{3,})/);if(r){const c=r[1].charAt(0),d=r[1].length;s?c===n&&d>=i&&a.trim()===r[1]&&(s=!1,n="",i=0):(s=!0,n=c,i=d);continue}s||t.push(a)}const o=t.join(`
`).replace(/`[^`\n]+`/g,"");return{allLines:e,linesOutsideCode:t,textOutsideCode:o}}function Tt(l,e={}){const{nested:t=!1}=e,{linesOutsideCode:s}=Ce(l),n=[],i=new Map,o=[];for(const a of s){const r=a.match(/^(#{1,6})\s+(.+)/);if(!r)continue;const c=parseInt(r[1].length.toString()),d=r[2].trim();if(!d)continue;const u=`heading-${It(d)}`,p=i.get(u)||0;i.set(u,p+1);const m=p>0?`${u}-${p}`:u,g={level:c,text:d,id:m,children:[]};if(t){for(;o.length>0&&o[o.length-1].level>=c;)o.pop();o.length===0?n.push(g):o[o.length-1].children.push(g),o.push(g)}else n.push(g)}return n}function Ct(l,e={}){const{textOutsideCode:t}=Ce(l);let s=0,n=0;const i=/(?:^|[\s|])(?:[-+*]|\d+\.)?\s*\[([ xX])\]/gm,o=[...t.matchAll(i)];s+=o.length,n+=o.filter(c=>c[1].toLowerCase()==="x").length;const a=/<input[^>]+type=["']checkbox["'][^>]*>/gi,r=[...t.matchAll(a)];s+=r.length;for(const c of r)/\bchecked\b/i.test(c[0])&&n++;return{total:s,completed:n}}function kt(l,e=150){const t=Te(l);if(t&&typeof t=="object"){const n=t;if(typeof n.description=="string")return n.description;if(typeof n.summary=="string")return n.summary;if(Array.isArray(n.pairs)&&n.pairs.length>0){const i=n.pairs[0];if(typeof i.human=="string")return i.human}return null}const{linesOutsideCode:s}=Ce(l);for(const n of s){const i=n.trim();if(!i||/^#{1,6}\s/.test(i)||/^[-*_]{3,}$/.test(i)||i==="---")continue;const o=i.replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/!\[.*?\]\(.*?\)/g,"").replace(/[*_~`]/g,"").trim();if(o)return o.length>e?o.substring(0,e)+"…":o}return null}function Mt(l){const e=Te(l);if(e&&typeof e=="object"){const s=e,n=[];if(typeof s.name=="string"&&n.push(s.name),typeof s.title=="string"&&n.push(s.title),typeof s.description=="string"&&n.push(s.description),typeof s.summary=="string"&&n.push(s.summary),Array.isArray(s.pairs))for(const i of s.pairs)typeof i.human=="string"&&n.push(i.human),typeof i.ai=="string"&&n.push(i.ai);return n.join(`
`)}const{linesOutsideCode:t}=Ce(l);return t.join(`
`).replace(/^#{1,6}\s+/gm,"").replace(/\[(.*?)\]\(.*?\)/g,"$1").replace(/!\[.*?\]\(.*?\)/g,"").replace(/`[^`\n]+`/g,"").replace(/[*_~]+/g,"").replace(/^\s*[-+*]\s+/gm,"").replace(/^\s*\d+\.\s+/gm,"").replace(/^\s*>\s+/gm,"").replace(/\|/g," ").replace(/\s+/g," ").trim()}function tn(l){const e=l.match(/--/g)||[];return Math.floor(e.length/2)}function sn(l){return(l.match(/```mermaid/gi)||[]).length}const nn={extractHeadings:!0,extractSummary:!0,extractTasks:!0,extractSearchable:!0,summaryMaxLength:150,debug:!1};function on(l,e={}){const t={...nn,...e};if(!l||typeof l!="string")return{headings:[],summary:null,searchableText:"",taskCounts:null,clozeCount:0,mermaidCount:0};const s={headings:[],summary:null,searchableText:"",taskCounts:null,clozeCount:0,mermaidCount:0};if(t.extractHeadings&&(s.headings=Tt(l,{nested:!0})),t.extractSummary&&(s.summary=kt(l,t.summaryMaxLength)),t.extractSearchable&&(s.searchableText=Mt(l)),t.extractTasks){const n=Ct(l,{});n.total>0&&(s.taskCounts=n)}return s.clozeCount=tn(l),s.mermaidCount=sn(l),s}function an(l){if(Array.isArray(l))return`[List: ${l.length} items]`;if(typeof l!="object"||l===null)return String(l);const e=Object.keys(l),t=[],s=["title","name","description","desc","summary","type","id","status"],n=e.sort((i,o)=>{const a=s.indexOf(i),r=s.indexOf(o);return a>-1&&r>-1?a-r:a>-1?-1:r>-1?1:i.localeCompare(o)});for(const i of n){if(t.length>=4)break;const o=l[i];typeof o=="string"?t.push(`${i}: ${o.length>30?o.substring(0,30)+"...":o}`):typeof o=="number"||typeof o=="boolean"?t.push(`${i}: ${o}`):Array.isArray(o)?t.push(`${i}: [${o.length}]`):o===null&&t.push(`${i}: null`)}return t.length>0?t.join(" | "):"{ ... }"}class le{constructor(e,t,s){this.service=t,this.options=s,this.container=e}listeners=[];container;hostContext;async init(e,t){if(this.container=e,this.container.classList.add("settings-root"),this.options.hostContext&&(this.hostContext=this.options.hostContext),this.service&&typeof this.service.onChange=="function"){const s=this.service.onChange(()=>this.render()),n=this.destroy;this.destroy=async()=>{s(),await n.call(this)}}await this.render()}toggleSidebar(){this.hostContext?.toggleSidebar()}focus(){}addEventListener(e,t,s){e&&(e.addEventListener(t,s),this.listeners.push({el:e,type:t,handler:s}))}clearListeners(){this.listeners.forEach(e=>e.el.removeEventListener(e.type,e.handler)),this.listeners=[]}async destroy(){this.clearListeners(),this.container.innerHTML=""}getText(){return""}setText(e){}getMode(){return"render"}async switchToMode(e){}setTitle(e){}setReadOnly(e){}isDirty(){return!1}setDirty(e){}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return""}async getSummary(){return null}async navigateTo(e){}async search(e){return[]}gotoMatch(e){}clearSearch(){}async pruneAssets(){return null}on(e,t){return()=>{}}}class R{constructor(e,t,s={}){this.title=e,this.contentHTML=t,this.options=s,this.options={confirmText:"确认",cancelText:"取消",type:"default",...s}}element=null;show(){const e=document.createElement("div");e.className="settings-modal-overlay",e.innerHTML=`
            <div class="settings-modal">
                <div class="settings-modal__header">
                    <h3>${this.title}</h3>
                    <button class="settings-modal-close" aria-label="Close">&times;</button>
                </div>
                <div class="settings-modal__body">${this.contentHTML}</div>
                <div class="settings-modal__footer">
                    <button class="settings-btn settings-btn--secondary settings-modal-cancel">${this.options.cancelText}</button>
                    <button class="settings-btn ${this.options.type==="danger"?"settings-btn--danger":"settings-btn--primary"} settings-modal-confirm">${this.options.confirmText}</button>
                </div>
            </div>
        `,document.body.appendChild(e),this.element=e;const t=()=>this.hide();e.querySelector(".settings-modal-close")?.addEventListener("click",t),e.querySelector(".settings-modal-cancel")?.addEventListener("click",t),e.querySelector(".settings-modal-confirm")?.addEventListener("click",async()=>{this.options.onConfirm&&await this.options.onConfirm()===!1||this.hide()}),e.addEventListener("click",s=>{s.target===e&&t()}),requestAnimationFrame(()=>e.classList.add("show"))}hide(){this.element&&(this.element.classList.remove("show"),setTimeout(()=>{this.element?.remove(),this.options.onCancel?.()},300))}static confirm(e,t,s){new R(e,`<p>${t}</p>`,{type:"danger",confirmText:"确认",onConfirm:s}).show()}}class f{static show(e,t="info",s=3e3){const n=document.createElement("div");n.className=`settings-toast settings-toast--${t}`;const i={success:'<i class="fas fa-check-circle"></i>',error:'<i class="fas fa-times-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',info:'<i class="fas fa-info-circle"></i>'};n.innerHTML=`
            <span class="settings-toast__icon">${i[t]}</span>
            <span class="settings-toast__message">${e}</span>
        `;let o=document.querySelector(".settings-toast-container");o||(o=document.createElement("div"),o.className="settings-toast-container",document.body.appendChild(o)),o.appendChild(n),requestAnimationFrame(()=>n.classList.add("show")),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},s)}static success(e){this.show(e,"success")}static error(e){this.show(e,"error")}static warning(e){this.show(e,"warning")}static info(e){this.show(e,"info")}}const Nt="chats",Qe="agents";class Lt{constructor(e,t){this.moduleName=e,this.vfs=t??z.getInstance()}vfs;get core(){return this.vfs.getVFS()}async init(){this.moduleName&&!this.vfs.getModule(this.moduleName)&&await this.vfs.mount(this.moduleName,"Module")}async loadTree(){const e=this.vfs.getModule(this.moduleName);if(!e)throw new Error(`Module ${this.moduleName} not found`);const t=async n=>{const i=await this.core.storage.loadVNode(n);if(!i)throw new Error(`Node ${n} missing`);const o=this.toEngineNode(i);if(i.type===I.FILE)o.content=await this.core.read(n);else{const a=await this.core.readdir(n);o.children=await Promise.all(a.map(r=>t(r.nodeId)))}return o};return(await t(e.rootNodeId)).children??[]}async getChildren(e){return(await this.core.readdir(e)).map(s=>this.toEngineNode(s))}async readContent(e){return this.core.read(e)}async getNode(e){const t=await this.core.storage.loadVNode(e);return t?.moduleId!==this.moduleName?null:t?this.toEngineNode(t):null}async search(e){const t={limit:e.limit};e.type&&(t.type=e.type==="directory"?I.DIRECTORY:I.FILE),e.text&&(t.nameContains=e.text),e.tags&&(t.tags=e.tags);const s=e.scope?.includes("*")?void 0:e.scope?.[0]??this.moduleName;return(await this.vfs.searchNodes(t,s,this.moduleName)).map(i=>this.toEngineNode(i))}async getAllTags(){return(await this.vfs.getAllTags()).map(t=>({name:t.name,color:t.color}))}async createFile(e,t,s="",n){const i=await this.resolveParentPath(t),o=this.core.pathResolver.join(i,e),a=s instanceof ArrayBuffer,r={...n,mimeType:n?.mimeType??fe(e),isBinary:a},c=await this.vfs.createFile(this.moduleName,o,s,r),d=this.toEngineNode(c);return d.content=s,d}async createDirectory(e,t,s){const n=await this.resolveParentPath(t),i=this.core.pathResolver.join(n,e),o=await this.vfs.createDirectory(this.moduleName,i,s),a=this.toEngineNode(o);return a.children=[],a}async createAsset(e,t,s){const n=await this.core.storage.loadVNode(e);if(!n)throw new Error(`Owner node ${e} not found`);const i=this.getAssetDirPath(n),o=this.core.pathResolver.join(i,t),a=await this.vfs.createFile(this.moduleName,o,s,{isAsset:!0,ownerId:e,mimeType:fe(t)});return this.toEngineNode(a)}async getAssetDirectoryId(e){const t=await this.core.storage.loadVNode(e);if(!t)return null;const s=this.getAssetDirPath(t);return this.resolvePath(s)}async writeContent(e,t){await this.core.write(e,t)}async rename(e,t){await this.vfs.rename(e,t)}async move(e,t){await this.vfs.batchMoveNodes(this.moduleName,e,t)}async delete(e){await this.vfs.deleteNodes(e)}async updateMetadata(e,t){await this.vfs.updateNodeMetadata(e,t)}async setTags(e,t){await this.vfs.batchSetNodeTags([{nodeId:e,tags:t}])}async setTagsBatch(e){await this.vfs.batchSetNodeTags(e.map(t=>({nodeId:t.id,tags:t.tags})))}async getSRSStatus(e){return this.vfs.getSRSItemsByNodeId(e)}async updateSRSStatus(e,t,s){await this.vfs.updateSRSItemById(e,t,s)}async getDueCards(e=50){return this.vfs.getDueSRSItems(this.moduleName,e)}on(e,t){const s=this.vfs.getEventBus(),n=`/${this.moduleName}`,i=c=>{if(!c)return!0;if(!c.startsWith(n))return!1;const d=c.slice(n.length);return!d.startsWith("/.")&&!d.includes("/.")},o=c=>d=>{i(d.path)&&t({type:c,payload:d})},a={[M.NODE_CREATED]:o("node:created"),[M.NODE_UPDATED]:o("node:updated"),[M.NODE_DELETED]:o("node:deleted"),[M.NODE_MOVED]:o("node:moved"),[M.NODE_COPIED]:o("node:moved"),[M.NODES_BATCH_UPDATED]:c=>t({type:"node:batch_updated",payload:c.data}),[M.NODES_BATCH_MOVED]:c=>t({type:"node:batch_moved",payload:c.data}),[M.NODES_BATCH_DELETED]:c=>t({type:"node:batch_deleted",payload:{removedIds:c.data?.removedNodeIds||[]}})},r=Object.entries(a).map(([c,d])=>s.on(c,d));return()=>r.forEach(c=>c())}async resolvePath(e){let t=e;e.startsWith("/")&&!e.startsWith(`/${this.moduleName}/`)&&e!==`/${this.moduleName}`&&(t=`/${this.moduleName}${e}`);try{return await this.core.storage.getNodeIdByPath(t)}catch{return null}}async pathExists(e){return await this.resolvePath(e)!==null}toEngineNode(e){return{id:e.nodeId,parentId:e.parentId,name:e.name,type:e.type===I.DIRECTORY?"directory":"file",createdAt:e.createdAt,modifiedAt:e.modifiedAt,path:e.path,size:e.size,tags:e.tags,metadata:e.metadata,moduleId:e.moduleId??void 0,icon:e.metadata?.icon}}async resolveParentPath(e){if(!e)return"";if(e.startsWith("/"))return e;const t=await this.core.storage.loadVNode(e);if(!t)throw new Error(`Parent node '${e}' not found`);const s=`/${this.moduleName}`;let n=t.path;return n.startsWith(s)&&(n=n.substring(s.length)),n.startsWith("/")?n:"/"+n}getAssetDirPath(e){const t=this.core.pathResolver.toUserPath(e.path,this.moduleName);if(e.type===I.DIRECTORY)return this.core.pathResolver.join(t,".assets");const s=t.lastIndexOf("/"),n=s<=0?"/":t.substring(0,s);return this.core.pathResolver.join(n,`.${e.name}`)}}class At{constructor(e,t={},s){this.moduleName=e,this.mountOptions=t,this.vfs=s??z.getInstance(),this.moduleEngine=new Lt(e,this.vfs)}vfs;moduleEngine;initialized=!1;listeners=new Set;async init(){this.initialized||(await this.moduleEngine.init(),await this.onLoad(),this.initialized=!0,this.notify())}async readJson(e){try{const t=await this.vfs.read(this.moduleName,e),s=typeof t=="string"?t:new TextDecoder().decode(t);return JSON.parse(s)}catch(t){return t.code!==x.NOT_FOUND&&console.warn(`[${this.constructor.name}] Failed to read ${e}:`,t),null}}async writeJson(e,t){const s=JSON.stringify(t,null,2),n=await this.moduleEngine.resolvePath(e);if(n)await this.moduleEngine.writeContent(n,s);else{const i=e.lastIndexOf("/"),o=i>0?e.slice(0,i):null,a=e.slice(i+1);await this.moduleEngine.createFile(a,o,s)}}async deleteFile(e){try{await this.vfs.delete(this.moduleName,e)}catch(t){console.warn(`[${this.constructor.name}] Delete failed: ${e}`,t)}}onChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}class rn{channels=new Map;publish(e,t){this.channels.get(e)?.forEach(s=>{try{s({channel:e,data:t,timestamp:Date.now()})}catch(n){console.error(n)}})}subscribe(e,t){return this.channels.has(e)||this.channels.set(e,new Set),this.channels.get(e).add(t),()=>{const s=this.channels.get(e);s?.delete(t),s?.size||this.channels.delete(e)}}clearAll=()=>this.channels.clear()}const pe=l=>l.startsWith(".")||l.startsWith("__"),ln=l=>l.moduleId&&pe(l.moduleId)||l.path?.split("/").some(pe)||pe(l.name),cn=l=>{const e=l.lastIndexOf(".");return e>0?l.slice(0,e):l},ge=l=>{const e=l.lastIndexOf(".");return e>0?l.slice(e).toLowerCase():""},dn=l=>{if(!l)return"";try{const e=Math.floor((Date.now()-new Date(l).getTime())/1e3);return e<60?"刚刚":e<3600?`${Math.floor(e/60)}分钟前`:e<86400?`${Math.floor(e/3600)}小时前`:`${Math.floor(e/86400)}天前`}catch{return""}},re=(l,e)=>{for(const t of l){if(t.id===e)return t;const s=t.children&&re(t.children,e);if(s)return s}},Ke=(l,e)=>{l.forEach(t=>{e(t),t.children&&Ke(t.children,e)})},be=l=>l instanceof Set?l:new Set(Array.isArray(l)?l:[]),hn=l=>l instanceof Map?l:new Map(Array.isArray(l)?l:[]);ps();const we=l=>{const e=new Map;return Ke(l,t=>{t.metadata.tags?.forEach(s=>{e.has(s)||e.set(s,{name:s,color:null,itemIds:new Set}),e.get(s).itemIds.add(t.id)})}),e},un={sortBy:"title",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0},pn=(l={})=>({items:l.items||[],activeId:l.activeId??null,expandedFolderIds:be(l.expandedFolderIds),expandedOutlineIds:be(l.expandedOutlineIds),expandedOutlineH1Ids:be(l.expandedOutlineH1Ids),selectedItemIds:be(l.selectedItemIds),creatingItem:l.creatingItem||null,moveOperation:l.moveOperation||null,tags:hn(l.tags),searchQuery:l.searchQuery||"",uiSettings:{...un,...l.uiSettings},isSidebarCollapsed:l.isSidebarCollapsed??!1,readOnly:l.readOnly??!1,status:l.status||"idle",error:l.error||null,_forceUpdateTimestamp:l._forceUpdateTimestamp});class gn{state;listeners=new Set;constructor(e={}){this.state=pn(e)}dispatch(e){const t=this.state;this.state=this.reduce(this.state,e),t!==this.state&&this.listeners.forEach(s=>s(this.state))}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getState=()=>this.state;reduce=gs((e,{type:t,payload:s})=>{({STATE_LOAD_SUCCESS:()=>{Object.assign(e,{items:s.items,tags:s.tags,status:"success",error:null}),e.activeId&&(e._forceUpdateTimestamp=Date.now())},ITEMS_LOAD_START:()=>{e.status="loading",e.error=null},ITEMS_LOAD_ERROR:()=>{e.status="error",e.error=s.error},CREATE_ITEM_START:()=>{e.creatingItem=s,e.selectedItemIds.clear(),s.parentId&&e.expandedFolderIds.add(s.parentId)},CREATE_ITEM_END:()=>{e.creatingItem=null},ITEM_DELETE_SUCCESS:()=>this.handleDelete(e,new Set(s.itemIds)),ITEM_SELECTION_REPLACE:()=>{e.selectedItemIds=new Set(s.ids||[])},ITEM_SELECTION_UPDATE:()=>this.handleSelectionUpdate(e,s),ITEM_SELECTION_CLEAR:()=>{e.selectedItemIds.clear()},ITEM_METADATA_UPDATE:()=>this.updateNodeMeta(e.items,s.itemId,s.metadata),ITEM_UPDATE_SUCCESS:()=>{this.updateNode(e.items,s.itemId,s.updates),e.tags=we(e.items)},ITEMS_BATCH_UPDATE_SUCCESS:()=>{s.updates?.forEach(i=>this.updateNode(e.items,i.itemId,i.data)),e.tags=we(e.items)},SESSION_CREATE_SUCCESS:()=>this.handleCreate(e,s),FOLDER_CREATE_SUCCESS:()=>this.handleCreate(e,s),MOVE_OPERATION_START:()=>{e.moveOperation={isMoving:!0,itemIds:s.itemIds}},MOVE_OPERATION_END:()=>{e.moveOperation=null},FOLDER_TOGGLE:()=>this.toggleSet(e.expandedFolderIds,s.folderId),OUTLINE_TOGGLE:()=>this.toggleSet(e.expandedOutlineIds,s.itemId),OUTLINE_H1_TOGGLE:()=>this.toggleSet(e.expandedOutlineH1Ids,s.elementId),SESSION_SELECT:()=>this.handleSessionSelect(e,s.sessionId),SETTINGS_UPDATE:()=>{Object.assign(e.uiSettings,s.settings)},SIDEBAR_TOGGLE:()=>{e.isSidebarCollapsed=!e.isSidebarCollapsed},SEARCH_QUERY_UPDATE:()=>{e.searchQuery=s.query||""}})[t]?.()});toggleSet(e,t){e.has(t)?e.delete(t):e.add(t)}handleDelete(e,t){const s=n=>n.filter(i=>t.has(i.id)?!1:(i.children&&(i.children=s(i.children)),!0));e.items=s(e.items),t.forEach(n=>{e.activeId===n&&(e.activeId=null),e.selectedItemIds.delete(n)}),e.tags=we(e.items)}handleSelectionUpdate(e,{ids:t,mode:s}){t?.length&&(s==="toggle"?t.forEach(n=>e.selectedItemIds.has(n)?e.selectedItemIds.delete(n):e.selectedItemIds.add(n)):s==="replace"&&(e.selectedItemIds=new Set(t)))}handleCreate(e,t){const s=t.metadata.parentId,n=s?re(e.items,s):null;n?.type==="directory"?((n.children??=[]).unshift(t),e.expandedFolderIds.add(s)):e.items.unshift(t),t.type==="file"&&(e.activeId=t.id,e.selectedItemIds=new Set([t.id])),e.creatingItem=null,e.tags=we(e.items)}handleSessionSelect(e,t){if(t){if(re(e.items,t)?.type==="file"){const n=e.activeId;e.activeId=t,e.creatingItem=null,e.selectedItemIds=new Set([t]),n===t?e._forceUpdateTimestamp=Date.now():n&&e.expandedOutlineIds.delete(n)}}else e.activeId&&e.expandedOutlineIds.delete(e.activeId),e.activeId=null}updateNode(e,t,s){for(let n=0;n<e.length;n++){if(e[n].id===t)return e[n]=s,!0;if(e[n].children&&this.updateNode(e[n].children,t,s))return!0}return!1}updateNodeMeta(e,t,s){for(const n of e){if(n.id===t)return n.metadata={...n.metadata,...s},!0;if(n.children&&this.updateNodeMeta(n.children,t,s))return!0}return!1}}const mn=/\.[a-zA-Z0-9]{1,10}$/;class fn{engine;newFileContent;defaultExtension;constructor({engine:e,newFileContent:t="",defaultExtension:s=".md"}){if(console.log("VFSService option:",s),!e)throw new Error("VFSService requires an ISessionEngine.");this.engine=e,this.newFileContent=t,this.defaultExtension=s.startsWith(".")?s:`.${s}`}ensureExtension=e=>mn.test(e)?e:`${e}${this.defaultExtension}`;createFile=async({title:e="Untitled",parentId:t=null,content:s=this.newFileContent}={})=>this.engine.createFile(this.ensureExtension(e),t,s);createFiles=async({parentId:e=null,files:t})=>{if(!t?.length)return[];const s=t.map(n=>({...n,title:this.ensureExtension(n.title)}));return this.engine.createFiles?this.engine.createFiles(s,e):Promise.all(s.map(n=>this.engine.createFile(n.title,e,n.content)))};createDirectory=({title:e="New Directory",parentId:t=null}={})=>this.engine.createDirectory(e,t);renameItem=(e,t)=>this.engine.rename(e,t);deleteItems=e=>this.engine.delete(e);moveItems=({itemIds:e,targetId:t})=>this.engine.move(e,t);updateMultipleItemsTags=async({itemIds:e,tags:t})=>{this.engine.setTagsBatch?await this.engine.setTagsBatch(e.map(s=>({id:s,tags:t}))):await Promise.all(e.map(s=>this.engine.setTags(s,t)))};findItemById=e=>this.engine.getNode(e);updateItemMetadata=(e,t)=>this.engine.updateMetadata(e,t);getAllFolders=()=>this.engine.search({type:"directory"});getAllFiles=()=>this.engine.search({type:"file"})}const Le={".md":"📝",".txt":"📄",".js":"☕",".ts":"📘",".json":"📦",".html":"🌐",".css":"🎨",".png":"🖼️",".jpg":"🖼️",".jpeg":"🖼️",".gif":"🖼️",".svg":"📐",folder:"📁",default:"📄"};class yn{extensionMap=new Map;defaultFactory;customResolver;constructor(e,t){this.defaultFactory=e,this.customResolver=t}register(e){e.extensions.forEach(t=>{this.extensionMap.set(t.toLowerCase(),{...e})})}getIcon(e,t=!1){if(t)return Le.folder;const s=ge(e);return this.extensionMap.get(s)?.icon||Le[s]||Le.default}resolveEditorFactory(e){if(this.customResolver){const s=this.customResolver(e);if(s)return s}const t=(e.metadata.custom?._extension||ge(e.metadata.path||e.metadata.title||"")).toLowerCase();return this.extensionMap.get(t)?.editorFactory||this.defaultFactory}resolveContentParser(e){return this.extensionMap.get(ge(e))?.contentParser}}class vn extends Ie{constructor(e){super(),this.engine=e}async getSuggestions(e){if(!this.engine.getAllTags)return[];try{const t=await this.engine.getAllTags(),s=e.toLowerCase();return t.filter(n=>!e||n.name.toLowerCase().includes(s)).sort((n,i)=>(i.refCount||0)-(n.refCount||0)||n.name.localeCompare(i.name)).map(n=>({id:n.name,label:n.name,type:"tag",color:n.color,extra:{count:n.refCount}}))}catch(t){return console.error("Failed to fetch tags",t),[]}}}class bn{constructor(e,t){this.container=e,this.params=t,this.items=new Set(t.initialItems)}items;suggestions=[];activeIndex=-1;pillsEl;inputEl;suggestionsEl;init(){this.render(),this.bindEvents(),this.items.forEach(e=>this.addPill(e)),this.inputEl.focus()}bindEvents(){this.container.addEventListener("keydown",this.handleKeyDown),this.inputEl.addEventListener("input",this.handleInput),this.container.addEventListener("click",this.handleClick)}handleClick=e=>{const t=e.target;if(t.closest(".mdx-tag-editor__remove-btn")){e.stopPropagation();const i=t.closest(".mdx-tag-editor__pill");i?.dataset.item&&this.removeItem(i.dataset.item);return}const s=t.closest(".mdx-tag-editor__suggestion");if(s?.dataset.item){e.stopPropagation(),this.addItem(s.dataset.item),this.clearSuggestions(),this.inputEl.value="";return}const n=t.closest(".mdx-tag-editor__btn")?.dataset.action;n==="save"?this.params.onSave(this.getItems()):n==="cancel"&&this.params.onCancel()};handleInput=async()=>{const e=this.inputEl.value;this.suggestions=e?(await this.params.suggestionProvider.getSuggestions(e)).filter(t=>!this.items.has(t.label)):[],this.activeIndex=-1,this.renderSuggestions()};handleKeyDown=e=>{if(e.target!==this.inputEl)return;const t=this.suggestions.length;switch(e.key){case"Enter":case",":e.preventDefault(),t&&this.activeIndex>-1?this.addItem(this.suggestions[this.activeIndex].label):this.inputEl.value.trim()&&this.addItem(this.inputEl.value.trim()),this.inputEl.value="",this.clearSuggestions();break;case"Backspace":!this.inputEl.value&&this.items.size&&this.removeItem([...this.items].pop());break;case"ArrowDown":t&&(e.preventDefault(),this.activeIndex=(this.activeIndex+1)%t,this.renderSuggestions());break;case"ArrowUp":t&&(e.preventDefault(),this.activeIndex=(this.activeIndex-1+t)%t,this.renderSuggestions());break;case"Escape":e.preventDefault(),this.suggestions.length?this.clearSuggestions():this.params.onCancel();break}};addItem(e){const t=e.trim();if(!t||this.items.has(t)){this.inputEl.value="";return}this.items.add(t),this.addPill(t),this.inputEl.focus()}removeItem(e){this.items.delete(e),this.pillsEl.querySelector(`[data-item="${T(e)}"]`)?.remove(),this.inputEl.focus()}addPill(e){const t=document.createElement("li");t.className="mdx-tag-editor__pill",t.dataset.item=e,t.innerHTML=`<span>${T(e)}</span><button type="button" class="mdx-tag-editor__remove-btn">&times;</button>`,this.pillsEl.insertBefore(t,this.pillsEl.querySelector(".mdx-tag-editor__input-wrapper"))}clearSuggestions(){this.suggestions=[],this.activeIndex=-1,this.renderSuggestions()}renderSuggestions(){if(!this.suggestions.length){this.suggestionsEl.style.display="none";return}this.suggestionsEl.innerHTML=this.suggestions.map((e,t)=>`<li class="mdx-tag-editor__suggestion ${t===this.activeIndex?"is-active":""}" data-item="${T(e.label)}">${T(e.label)}</li>`).join(""),this.suggestionsEl.style.display="block"}render(){this.container.innerHTML=`
      <ul class="mdx-tag-editor__pills">
        <li class="mdx-tag-editor__input-wrapper">
          <input type="text" class="mdx-tag-editor__input" placeholder="Add tag..." autocomplete="off">
        </li>
      </ul>
      <ul class="mdx-tag-editor__suggestions"></ul>
      <div class="mdx-tag-editor__footer">
        <button type="button" class="mdx-tag-editor__btn mdx-tag-editor__btn--primary" data-action="save">Save</button>
        <button type="button" class="mdx-tag-editor__btn" data-action="cancel">Cancel</button>
      </div>`,this.pillsEl=this.container.querySelector(".mdx-tag-editor__pills"),this.inputEl=this.container.querySelector(".mdx-tag-editor__input"),this.suggestionsEl=this.container.querySelector(".mdx-tag-editor__suggestions")}getItems(){const e=this.inputEl?.value.trim();return e&&!this.items.has(e)&&this.items.add(e),[...this.items]}}class Ye{container;store;coordinator;state={};unsub=null;constructor({container:e,store:t,coordinator:s}){this.container=e,this.store=t,this.coordinator=s}init(){this.unsub=this.store.subscribe(this.update),this.update(this.store.getState()),this.bindEvents()}update=e=>{const t=this.transformState(e);Object.keys(t).some(n=>this.state[n]!==t[n])&&(this.state=t,this.render())};bindEvents(){}destroy(){this.unsub?.(),this.unsub=null,this.container.innerHTML=""}}class wn{constructor(e,t="File"){this.searchFilter=e,this.createFileLabel=t}transform(e){const{items:t,searchQuery:s,uiSettings:n,expandedFolderIds:i,expandedOutlineIds:o,selectedItemIds:a,activeId:r,creatingItem:c,status:d,readOnly:h}=e,u=this.parseSearchQuery(s),p=this.filterAndSortItems(t,u,n,h),m=this.getVisibleItemIds(p,new Set([...i,...t.map(y=>y.id)])),g=this.calculateSelectionStatus(a,m,h);return{items:p,textSearchQueries:u.textQueries,searchQuery:s,activeId:r,expandedFolderIds:i,expandedOutlineIds:o,uiSettings:n,status:d,selectedItemIds:a,creatingItem:c,selectionStatus:g,visibleItemIds:m,readOnly:h,createFileLabel:this.createFileLabel}}parseSearchQuery(e){const t=e.trim().toLowerCase();if(!t)return{textQueries:[],tagQueries:[],typeQueries:[]};const s=t.split(/\s+/).filter(Boolean),n=[],i=[],o=[];for(const a of s)if(a.startsWith("tag:"))i.push(a.substring(4));else if(a.startsWith("type:")){const r=a.substring(5);(r==="file"||r==="dir")&&o.push(r)}else n.push(a);return{textQueries:n,tagQueries:i,typeQueries:o}}filterAndSortItems(e,t,s,n){let i=JSON.parse(JSON.stringify(e));return(t.textQueries.length>0||t.tagQueries.length>0||t.typeQueries.length>0)&&(i=this.filterRecursively(i,t)),n||this.sortRecursively(i,s),i}filterRecursively(e,t){return e.map(s=>{if(s.type==="directory"){const n=this.filterRecursively(s.children||[],t);return this.itemMatches(s,t)||n.length>0?{...s,children:n}:null}return this.itemMatches(s,t)?s:null}).filter(s=>s!==null)}itemMatches(e,t){const{textQueries:s,tagQueries:n,typeQueries:i}=t;if(i.length>0){const o=e.type==="directory"?"dir":"file";if(!i.includes(o))return!1}if(n.length>0){const o=(e.metadata?.tags||[]).map(a=>a.toLowerCase());if(!n.every(a=>o.includes(a)))return!1}if(s.length>0)if(this.searchFilter){if(!this.searchFilter(e,s))return!1}else{const o=[e.metadata?.title||"",e.content?.summary||"",e.content?.searchableText||""].join(" ").toLowerCase();if(!s.every(a=>o.includes(a)))return!1}return!0}sortRecursively(e,t){if(e){e.sort((s,n)=>{const i=s.metadata?.custom?.isPinned||!1,o=n.metadata?.custom?.isPinned||!1;if(i!==o)return i?-1:1;if(t.sortBy==="title")return(s.metadata?.title||"").localeCompare(n.metadata?.title||"","zh-CN");const a=new Date(s.metadata?.lastModified||0).getTime();return new Date(n.metadata?.lastModified||0).getTime()-a});for(const s of e)s.type==="directory"&&s.children&&this.sortRecursively(s.children,t)}}getVisibleItemIds(e,t){const s=[],n=i=>{for(const o of i)s.push(o.id),o.type==="directory"&&o.children&&t.has(o.id)&&n(o.children)};return n(e),s}calculateSelectionStatus(e,t,s){const n=e.size;return s||n<=1||t.length===0?"none":t.every(o=>e.has(o))&&n===t.length?"all":"partial"}}class Sn{constructor(e){this.store=e}lastClickedItemId=null;handleItemSelection(e,t,s,n){if(n&&(t.metaKey||t.ctrlKey||t.shiftKey))return;let i="replace",o=[e];if(t.metaKey||t.ctrlKey)i="toggle";else if(t.shiftKey&&this.lastClickedItemId){const a=s.indexOf(this.lastClickedItemId),r=s.indexOf(e);a!==-1&&r!==-1&&(o=s.slice(Math.min(a,r),Math.max(a,r)+1))}this.store.dispatch({type:"ITEM_SELECTION_UPDATE",payload:{ids:o,mode:i}}),this.lastClickedItemId=e}handleSelectAllToggle(e,t){e==="all"?this.store.dispatch({type:"ITEM_SELECTION_CLEAR"}):this.store.dispatch({type:"ITEM_SELECTION_REPLACE",payload:{ids:t}})}toggleSelection(e){this.store.dispatch({type:"ITEM_SELECTION_UPDATE",payload:{ids:[e],mode:"toggle"}}),this.lastClickedItemId=e}clearSelection(){this.store.dispatch({type:"ITEM_SELECTION_CLEAR"})}getFolderSelectionState(e,t){const s=t.has(e.id),n=this.getDescendantIds(e);if(n.length===0)return s?"all":"none";const i=n.filter(o=>t.has(o)).length;return s&&i===n.length?"all":s||i>0?"partial":"none"}getDescendantIds(e){const t=[],s=n=>{if(n.type==="directory"&&n.children)for(const i of n.children)t.push(i.id),s(i)};return s(e),t}}class En{constructor(e,t,s,n,i){this.instanceId=e,this.coordinator=t,this.container=s,this.getExpandedFolderIds=n,this.getSelectedItemIds=i}folderExpandTimer=null;handleDragStart=e=>{const t=e.target.closest("[data-item-id]");if(!t||!e.dataTransfer)return;const s=t.dataset.itemId,n=this.getSelectedItemIds(),i=n.has(s)&&n.size>1?[...n]:[s],o={sourceInstanceId:this.instanceId,itemIds:i};e.dataTransfer.setData("application/json",JSON.stringify(o)),e.dataTransfer.effectAllowed="move",setTimeout(()=>{i.forEach(a=>{this.container.querySelector(`[data-item-id="${a}"]`)?.classList.add("is-dragging")})},0)};handleDragOver=e=>{e.preventDefault(),this.clearDropIndicators();const t=e.target.closest("[data-item-id]");if(!t||!e.dataTransfer)return;try{const n=e.dataTransfer.getData("application/json");if(n&&JSON.parse(n).itemIds?.includes(t.dataset.itemId))return}catch{}const s=t.getBoundingClientRect();if(t.dataset.itemType==="directory")t.classList.add("drop-target-folder");else{const n=e.clientY<s.top+s.height/2;t.classList.add(n?"drop-target-above":"drop-target-below")}this.scheduleAutoExpand(e.target)};handleDragLeave=e=>{this.cancelAutoExpand();const t=e.relatedTarget,s=e.currentTarget;(!t||!s.contains(t))&&this.clearDropIndicators()};handleDrop=e=>{e.preventDefault(),this.cancelAutoExpand();try{if(!e.dataTransfer)throw new Error("No dataTransfer object");const t=e.dataTransfer.getData("application/json"),s=JSON.parse(t);if(!s.sourceInstanceId||s.sourceInstanceId!==this.instanceId){console.warn("[DragDropHandler] Cross-instance drag-and-drop ignored"),this.clearDropIndicators();return}const n=this.container.querySelector(".drop-target-above, .drop-target-below, .drop-target-folder");if(n&&s.itemIds?.length>0&&n.dataset.itemId){const i=n.dataset.itemId;let o;n.classList.contains("drop-target-above")?o="before":n.classList.contains("drop-target-below")?o="after":o="into",this.coordinator.publish("ITEMS_MOVE_REQUESTED",{itemIds:s.itemIds,targetId:i,position:o})}}catch(t){console.error("[DragDropHandler] Failed to parse dragged data",t)}this.clearDropIndicators()};handleDragEnd=()=>{this.container.querySelectorAll(".is-dragging").forEach(e=>e.classList.remove("is-dragging")),this.clearDropIndicators()};scheduleAutoExpand(e){this.cancelAutoExpand();const t=e.closest(".vfs-directory-item");if(!t?.dataset.itemId)return;const s=t.dataset.itemId;this.getExpandedFolderIds().has(s)||(this.folderExpandTimer=window.setTimeout(()=>{this.coordinator.publish("FOLDER_TOGGLE_REQUESTED",{folderId:s})},750))}cancelAutoExpand(){this.folderExpandTimer&&(clearTimeout(this.folderExpandTimer),this.folderExpandTimer=null)}clearDropIndicators(){this.container.querySelectorAll(".drop-target-above, .drop-target-below, .drop-target-folder").forEach(e=>{e.classList.remove("drop-target-above","drop-target-below","drop-target-folder")})}destroy(){this.cancelAutoExpand()}}const xn=l=>{const e=l.type==="directory";return`
    <div class="vfs-node-list__item-creator" data-type="${l.type}">
      <span class="vfs-node-list__item-creator-icon">${e?"📁":"📄"}</span>
      <input type="text" class="vfs-node-list__item-creator-input" placeholder="${e?"新目录名称...":"新文件名称..."}" data-action="create-input" />
    </div>`},_n=l=>l?.length?`<div class="vfs-context-menu"><ul>${l.map(e=>e.type==="separator"?'<li class="vfs-context-menu__separator"></li>':`<li><button data-action="${T(e.id)}">${e.iconHTML||""}<span>${T(e.label)}</span></button></li>`).join("")}</ul></div>`:"",In=({selectionStatus:l,selectedCount:e,isReadOnly:t})=>t||e<=1?"":`
    <div class="vfs-node-list__bulk-bar">
      <div class="vfs-node-list__bulk-bar-info">
        ${`<input type="checkbox" class="vfs-node-list__footer-checkbox" data-action="toggle-select-all" 
    title="${l==="all"?"全部取消":"全选"}" ${l==="all"?"checked":""}>`}
        <span>已选择 ${e} 项</span>
        <button data-action="deselect-all" class="vfs-node-list__bulk-bar-btn--text" title="全部取消">取消</button>
      </div>
      <div class="vfs-node-list__bulk-bar-actions">
        <button class="vfs-node-list__bulk-bar-btn" data-action="bulk-move" title="移动..."><i class="fas fa-share-square"></i></button>
        <button class="vfs-node-list__bulk-bar-btn vfs-node-list__bulk-bar-btn--danger" data-action="bulk-delete" title="删除"><i class="fas fa-trash"></i></button>
      </div>
    </div>`,dt=l=>{const e=(s,n,i)=>`<button data-value="${n}" class="vfs-settings-popover__option-btn ${l[s]===n?"is-active":""}">${i}</button>`,t=(s,n)=>{const i=`show${s.charAt(0).toUpperCase()+s.slice(1)}`;return`<label class="vfs-settings-popover__checkbox-label"><input type="checkbox" data-key="${s}" ${l[i]?"checked":""}> ${n}</label>`};return`
    <div class="vfs-settings-popover">
      <div class="vfs-settings-popover__title">排序方式</div>
      <div class="vfs-settings-popover__group" data-setting="sortBy">${e("sortBy","lastModified","修改时间")}${e("sortBy","title","标题")}</div>
      <div class="vfs-settings-popover__title">显示密度</div>
      <div class="vfs-settings-popover__group" data-setting="density">${e("density","comfortable","舒适")}${e("density","compact","紧凑")}</div>
      <div class="vfs-settings-popover__title">显示内容</div>
      <div class="vfs-settings-popover__checkbox-group" data-setting="show">${t("summary","显示摘要")}${t("tags","显示标签")}${t("badges","显示元数据")}</div>
    </div>`};class Tn{constructor(e,t,s,n,i="File"){this.store=e,this.coordinator=t,this.contextMenuConfig=s,this.callbacks=n,this.createFileLabel=i}menuEl=null;show(e,t){e.preventDefault(),e.stopPropagation(),this.hide();const s=t.dataset.itemId,n=this.store.getState(),{selectedItemIds:i}=n,o=i.has(s);let a,r=null;if(i.size>1&&o)a=this.getBulkContextMenuItems(i.size);else{if(o||this.store.dispatch({type:"ITEM_SELECTION_REPLACE",payload:{ids:[s]}}),r=this.callbacks.findItemById(s),!r)return;a=this.buildContextMenuItems(r)}a?.length&&this.createMenu(a,e.clientX,e.clientY,r)}hide(){this.menuEl&&(this.menuEl.remove(),this.menuEl=null)}createMenu(e,t,s,n){const i=document.createElement("div");i.innerHTML=_n(e),this.menuEl=i.firstElementChild,this.menuEl.style.top=`${s}px`,this.menuEl.style.left=`${t}px`,this.menuEl.addEventListener("click",o=>{const a=o.target.closest("button[data-action]");if(!a)return;const r=a.dataset.action;this.handleAction(r,n,{x:t,y:s}),this.hide()}),document.body.appendChild(this.menuEl)}handleAction(e,t,s){const n=this.store.getState();if(e==="bulk-delete"){confirm(`确定要删除 ${n.selectedItemIds.size} 个项目吗?`)&&this.coordinator.publish("BULK_ACTION_REQUESTED",{action:"delete"});return}if(e==="bulk-move"){this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[...n.selectedItemIds]});return}if(e==="bulk-edit-tags"){const o=[...n.selectedItemIds],a=new Set;o.forEach(r=>{this.callbacks.findItemById(r)?.metadata.tags?.forEach(d=>a.add(d))}),this.callbacks.showTagEditor({initialTags:[...a],onSave:r=>{this.coordinator.publish("ITEM_TAGS_UPDATE_REQUESTED",{itemIds:o,tags:r})},onCancel:()=>{},position:s});return}if(!t)return;if(e==="edit-tags"){this.callbacks.showTagEditor({initialTags:t.metadata.tags||[],onSave:o=>{this.coordinator.publish("ITEM_TAGS_UPDATE_REQUESTED",{itemIds:[t.id],tags:o})},onCancel:()=>{},position:s});return}if(new Set(["rename","delete","moveTo","create-in-folder-session","create-in-folder-folder"]).has(e))if(e.startsWith("create-in-folder-")){const o=e.split("-")[3];this.coordinator.publish("CREATE_ITEM_REQUESTED",{type:o,parentId:t.id})}else e==="moveTo"?this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[t.id]}):this.coordinator.publish("ITEM_ACTION_REQUESTED",{action:e,itemId:t.id});else this.coordinator.publish("CUSTOM_MENU_ACTION_REQUESTED",{action:e,item:t})}getDefaultContextMenuItems(e){const t=[],s=this.createFileLabel;return e.type==="directory"&&t.push({id:"create-in-folder-session",label:`新建 ${T(s)}`,iconHTML:'<i class="fas fa-file-alt"></i>'},{id:"create-in-folder-folder",label:"新建目录",iconHTML:'<i class="fas fa-folder-plus"></i>'},{type:"separator"}),t.push({id:"rename",label:"重命名",iconHTML:'<i class="fas fa-pencil-alt"></i>'},{id:"edit-tags",label:"编辑标签...",iconHTML:'<i class="fas fa-tags"></i>'},{id:"moveTo",label:"移动到...",iconHTML:'<i class="fas fa-share-square"></i>'},{type:"separator"},{id:"delete",label:"删除",iconHTML:'<i class="fas fa-trash-alt"></i>'}),t}getBulkContextMenuItems(e){return[{id:"bulk-edit-tags",label:`编辑 ${e} 个项目的标签...`,iconHTML:'<i class="fas fa-tags"></i>'},{id:"bulk-move",label:`移动 ${e} 个项目...`,iconHTML:'<i class="fas fa-share-square"></i>'},{type:"separator"},{id:"bulk-delete",label:`删除 ${e} 个项目`,iconHTML:'<i class="fas fa-trash-alt"></i>'}]}buildContextMenuItems(e){const t=this.getDefaultContextMenuItems(e);if(this.contextMenuConfig?.items)try{return this.contextMenuConfig.items(e,t).filter(s=>s.type==="separator"?!0:!(s.hidden&&s.hidden(e)))}catch(s){console.error("Error executing custom contextMenu.items:",s)}return t}}class Cn{constructor(e,t){this.store=e,this.coordinator=t}confirmDeleteId=null;getConfirmDeleteId(){return this.confirmDeleteId}setConfirmDeleteId(e){this.confirmDeleteId=e}handleItemClick(e,t,s,n){const i=t.dataset.itemId,o=t.dataset.itemType,a=e.target.closest("[data-action]"),r=a?.dataset.action;if(this.confirmDeleteId&&r!=="delete-init"&&r!=="delete-direct"&&(this.confirmDeleteId=null,n()),r==="delete-init")return e.stopPropagation(),this.confirmDeleteId=i,n(),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="delete-direct")return e.stopPropagation(),this.confirmDeleteId=null,this.coordinator.publish("ITEM_ACTION_REQUESTED",{action:"delete-direct",itemId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(this.confirmDeleteId===i&&(this.confirmDeleteId=null,n()),r==="toggle-folder")return this.coordinator.publish("FOLDER_TOGGLE_REQUESTED",{folderId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="toggle-outline")return this.coordinator.publish("OUTLINE_TOGGLE_REQUESTED",{itemId:i}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="navigate-to-heading"&&a?.dataset.elementId)return e.preventDefault(),this.coordinator.publish("NAVIGATE_TO_HEADING_REQUESTED",{elementId:a.dataset.elementId}),{handled:!0,shouldSelect:!1,shouldNavigate:!1};if(r==="toggle-selection")return s?{handled:!0,shouldSelect:!1,shouldNavigate:!1}:(e.stopPropagation(),{handled:!1,shouldSelect:!0,shouldNavigate:!1});const c=e.metaKey||e.ctrlKey||e.shiftKey;return{handled:!1,shouldSelect:r!=="select-only"&&!s,shouldNavigate:r!=="select-only"&&!c&&(o==="file"||o==="directory")}}handleEmptyAreaClick(e,t,s){e||t>0&&(this.store.dispatch({type:"ITEM_SELECTION_CLEAR"}),this.confirmDeleteId&&(this.confirmDeleteId=null,s()))}getTargetParentId(e,t){if(e.size===0)return null;const s=e.values().next().value;if(!s)return null;const n=t(s);if(!n)return null;const o=(n.metadata?.path||"").split("/").some(c=>c.startsWith(".")),a=n.metadata?.title?.startsWith(".");if(o||a)return n.metadata?.parentId||null;const r=n.type==="directory"?n.id:n.metadata?.parentId||null;return r&&!t(r)?null:r}}class kn{constructor(e,t){this.coordinator=e,this.containerEl=t}element=null;toggle(e){this.element?this.hide():this.show(e)}show(e){if(this.element)return;const t=document.createElement("div");t.innerHTML=dt(e),this.element=t.firstElementChild,this.element.addEventListener("click",this.handleChange),this.element.addEventListener("change",this.handleChange),this.containerEl.appendChild(this.element)}hide(){this.element&&(this.element.removeEventListener("click",this.handleChange),this.element.removeEventListener("change",this.handleChange),this.element.remove(),this.element=null)}isVisible(){return this.element!==null}handleChange=e=>{const t=e.target,s=t.closest("[data-value]"),n=t.closest('input[type="checkbox"]'),i={};if(s){const o=s.closest("[data-setting]");if(o?.dataset.setting){const a=o.dataset.setting;i[a]=s.dataset.value}}else if(n?.dataset.key){const o=n.dataset.key,a=`show${o.charAt(0).toUpperCase()+o.slice(1)}`;i[a]=n.checked}else return;if(this.coordinator.publish("SETTINGS_CHANGE_REQUESTED",{settings:i}),this.element){const a={...this.getCurrentSettingsFromUI(),...i},r=document.createElement("div");r.innerHTML=dt(a);const c=r.firstElementChild;this.element.innerHTML=c.innerHTML}};getCurrentSettingsFromUI(){const e={sortBy:"lastModified",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0};if(this.element){const t=this.element.querySelector('[data-setting="sortBy"] .is-active');t&&(e.sortBy=t.dataset.value);const s=this.element.querySelector('[data-setting="density"] .is-active');s&&(e.density=s.dataset.value);const n=this.element.querySelector('[data-key="summary"]');n&&(e.showSummary=n.checked);const i=this.element.querySelector('[data-key="tags"]');i&&(e.showTags=i.checked);const o=this.element.querySelector('[data-key="badges"]');o&&(e.showBadges=o.checked)}return e}destroy(){this.hide()}}class Mn{constructor(e){this.tagEditorFactory=e}element=null;show(e){this.hide(),this.element=document.createElement("div"),this.element.className="vfs-tag-editor vfs-tag-editor--popover",document.body.appendChild(this.element),this.element.style.left=`${e.position.x}px`,this.element.style.top=`${e.position.y}px`;try{this.tagEditorFactory({container:this.element,initialTags:e.initialTags,onSave:t=>{e.onSave(t),this.hide()},onCancel:()=>{e.onCancel(),this.hide()}})}catch(t){console.error("[TagEditorPopover] Factory execution failed:",t),this.hide()}}hide(){this.element&&(this.element.remove(),this.element=null)}isVisible(){return this.element!==null}containsElement(e){return this.element?.contains(e)??!1}destroy(){this.hide()}}class Nn{constructor(e,t){this.element=e,this.callbacks=t,e.addEventListener("click",s=>{const n=s.target.closest("[data-action]")?.getAttribute("data-action");if(!n||s.target.disabled)return;({"toggle-select-all":this.callbacks.onSelectAllToggle,"bulk-delete":this.callbacks.onBulkDelete,"bulk-move":this.callbacks.onBulkMove,settings:this.callbacks.onSettingsClick,"deselect-all":this.callbacks.onDeselectAll})[n]?.()})}render(e){this.element.innerHTML=In(e);const t=this.element.querySelector(".vfs-node-list__footer-checkbox");t&&(t.indeterminate=e.selectionStatus==="partial")}}class Dt{element;item;isReadOnly;constructor(e,t){this.item=e,this.isReadOnly=t,this.element=document.createElement("div"),t||(this.element.draggable=!0)}updateItem(e){const t=this.shouldRerender(this.item,e);this.item=e,t&&this.render()}destroy(){this.element.remove()}replaceElement(e){const t=document.createElement("div");t.innerHTML=e;const s=t.firstElementChild;this.element.parentNode?.replaceChild(s,this.element),this.element=s}shouldRerender(e,t){return JSON.stringify(e.metadata.tags)!==JSON.stringify(t.metadata.tags)||e.metadata.title!==t.metadata.title||JSON.stringify(e.metadata.custom?.taskCount)!==JSON.stringify(t.metadata.custom?.taskCount)}}const ze=(l,e)=>{const t=e.map(n=>n.trim()).filter(Boolean);if(!t.length||!l)return T(l||"");const s=new RegExp(`(${t.map(n=>n.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")).join("|")})`,"gi");return T(l).replace(s,'<mark class="vfs-search-highlight">$1</mark>')},Ln=l=>{if(!l?.length)return"";const e=t=>t.map(s=>{const n=s.children.length>0;return`
    <li class="vfs-node-item__outline-item vfs-node-item__outline-item--level-${s.level}">
      <a href="javascript:void(0)" data-action="navigate-to-heading" data-element-id="${T(s.id)}">
        <span class="vfs-node-item__outline-text">${T(s.text)}</span>
      </a>
      ${n?`<ul class="vfs-node-item__outline-list">${e(s.children)}</ul>`:""}
    </li>`}).join("");return`<ul class="vfs-node-item__outline-list">${e(l)}</ul>`},An=(l,e,t=!1)=>{const{id:s,metadata:n,content:i,headings:o=[],icon:a}=l,{title:r,lastModified:c,tags:d=[],custom:h={}}=n,{isActive:u,isSelected:p,isOutlineExpanded:m,isSelectionMode:g,isConfirmingDelete:y,searchQueries:b,uiSettings:E}=e,{isPinned:k=!1,hasUnreadUpdate:F=!1}=h,B=i?.summary||"";let v="";t||(v=`<button class="${y?"vfs-node-item__action-btn vfs-node-item__delete-btn is-confirming":"vfs-node-item__action-btn vfs-node-item__delete-btn"}" data-action="${y?"delete-direct":"delete-init"}" title="${y?"点击立即删除":"移除"}">${y?'<i class="fas fa-trash"></i>':"×"}</button>`);const L=o?.length>0,S=L?`
    <button class="vfs-node-item__action-btn vfs-node-item__outline-toggle" data-action="toggle-outline" title="显示/隐藏大纲">
      <span class="vfs-node-item__outline-toggle-icon ${m?"is-expanded":""}"></span>
    </button>`:"",D=!t&&g?`<div class="vfs-node-item__checkbox-wrapper"><input type="checkbox" class="vfs-node-item__checkbox" data-item-id="${s}" ${p?"checked":""} data-action="toggle-selection"></div>`:"",P=E.showBadges&&h.taskCount&&h.taskCount.total>0?`<span class="vfs-badge">✅ ${h.taskCount.completed}/${h.taskCount.total}</span>`:"",U=E.showTags&&d.length>0?d.map(at=>`<span class="vfs-tag-pill">${T(at)}</span>`).join(""):"",q=E.showSummary&&B?`<span class="vfs-node-item__summary">${ze(B,b)}</span>`:"",K=L&&m?`<div class="vfs-node-item__outline is-expanded">${Ln(o)}</div>`:"";let j=a||"📄";k&&(j="📌");const V=v||S?`
    <div class="vfs-node-item__actions">
      ${v}
      ${S}
    </div>`:"";return`
    <div class="vfs-node-item" data-item-id="${s}" data-item-type="file">
      <div class="vfs-node-item__main-row ${g?"is-selection-mode":""}">
        ${D}
        <div class="vfs-node-item__content ${u?"is-active":""} ${p?"is-selected":""}" data-action="select-and-open">
          <span class="vfs-node-item__icon" data-action="select-only" title="仅选中">${j}</span>
          
          <div class="vfs-node-item__body">
            <div class="vfs-node-item__row-primary">
              <span class="vfs-node-item__title">${ze(r,b)}</span>
              ${F?'<span class="vfs-node-item__indicator"></span>':""}
            </div>
            
            <div class="vfs-node-item__row-secondary">
              <div class="vfs-node-item__secondary-left">
                ${q}
                ${U?`<div class="vfs-node-item__tags">${U}</div>`:""}
              </div>
              <div class="vfs-node-item__secondary-right">
                <span class="vfs-node-item__timestamp" title="${new Date(c).toLocaleString()}">${dn(c)}</span>
                ${P}
              </div>
            </div>
          </div>
          
          ${V}
        </div>
      </div>
      ${K}
    </div>`},Dn=(l,e,t=!1)=>{const{id:s,metadata:n,icon:i}=l,{title:o,tags:a=[]}=n,{isExpanded:r,dirSelectionState:c,isSelected:d,isSelectionMode:h,searchQueries:u}=e,p=!t&&h?`<div class="vfs-node-item__checkbox-wrapper"><input type="checkbox" class="vfs-node-item__checkbox" data-item-id="${s}" ${c==="all"?"checked":""} ${c==="partial"?'data-indeterminate="true"':""} data-action="toggle-selection"></div>`:"",m=a.length?`<div class="vfs-directory-item__tags">${a.map(g=>`<span class="vfs-tag-pill">${T(g)}</span>`).join("")}</div>`:"";return`
    <div class="vfs-node-item vfs-directory-item" data-item-id="${s}" data-item-type="directory">
      <div class="vfs-node-item__main-row ${h?"is-selection-mode":""}">
        ${p}
        <div class="vfs-directory-item__header ${d?"is-selected":""}" data-action="select-item">
          <span class="vfs-directory-item__toggle ${r?"is-expanded":""}" data-action="toggle-folder"></span>
          <span class="vfs-directory-item__icon">${i||"📁"}</span>
          <div class="vfs-directory-item__title-container">
            <span class="vfs-directory-item__title">${ze(o,u)}</span>
            ${m}
          </div>
        </div>
      </div>
      <div class="vfs-directory-item__children" style="${r?"":"display:none;"}"></div>
    </div>`};class $n extends Dt{props;constructor(e,t,s){super(e,t),this.props=s,this.render()}update(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props=e,this.render())}render(){this.replaceElement(An(this.item,this.props,this.isReadOnly))}}class Rn extends Dt{childrenContainer;props;constructor(e,t,s){super(e,t),this.props=s,this.render()}update(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props=e,this.render())}render(){const e=this.childrenContainer;if(this.replaceElement(Dn(this.item,this.props,this.isReadOnly)),this.childrenContainer=this.element.querySelector(".vfs-directory-item__children"),e)for(;e.firstChild;)this.childrenContainer.appendChild(e.firstChild)}}class Pn{constructor(e){this.selectionHandler=e}itemInstances=new Map;renderItems(e,t,s){const n=new Map,i=document.createDocumentFragment();this.traverseAndRender(t.items,i,null,t,s,n),e.innerHTML="",e.appendChild(i),this.itemInstances.forEach((o,a)=>{n.has(a)||o.destroy()}),this.itemInstances=n}traverseAndRender(e,t,s,n,i,o){if(!n.readOnly&&n.creatingItem?.parentId===s){const a=document.createElement("div");a.innerHTML=xn(n.creatingItem),t.appendChild(a.firstElementChild)}if(e.length===0&&s!==null){n.creatingItem?.parentId!==s&&(t.innerHTML='<div class="vfs-directory-item__empty-placeholder">(空)</div>');return}for(const a of e){let r=this.itemInstances.get(a.id);if(r)r.updateItem(a);else if(a.type==="file"){const c=this.getFileItemProps(a,n,i.confirmDeleteId);r=new $n(a,n.readOnly,c)}else{const c=this.getDirectoryItemProps(a,n);r=new Rn(a,n.readOnly,c)}if(a.type==="file"){const c=this.getFileItemProps(a,n,i.confirmDeleteId);r.update(c)}else{const c=this.getDirectoryItemProps(a,n);r.update(c)}if(t.appendChild(r.element),o.set(a.id,r),a.type==="directory"&&a.children&&(n.expandedFolderIds.has(a.id)||!!n.searchQuery)){const d=r.childrenContainer;d.innerHTML="",this.traverseAndRender(a.children,d,a.id,n,i,o)}}}getFileItemProps(e,t,s){return{isActive:e.id===t.activeId,isSelected:t.selectedItemIds.has(e.id),isSelectionMode:!t.readOnly&&t.selectedItemIds.size>1,isOutlineExpanded:t.expandedOutlineIds.has(e.id),searchQueries:t.textSearchQueries,uiSettings:t.uiSettings,isConfirmingDelete:s===e.id}}getDirectoryItemProps(e,t){return{isExpanded:t.expandedFolderIds.has(e.id)||!!t.searchQuery,dirSelectionState:this.selectionHandler.getFolderSelectionState(e,t.selectedItemIds),isSelected:t.selectedItemIds.has(e.id),isSelectionMode:!t.readOnly&&t.selectedItemIds.size>1,searchQueries:t.textSearchQueries}}destroy(){this.itemInstances.forEach(e=>e.destroy()),this.itemInstances.clear()}}class On extends Ye{stateTransformer;selectionHandler;dragDropHandler;contextMenuHandler;itemActionHandler;settingsPopover;tagEditorPopover;bodyEl;searchEl;mainContainerEl;titleEl;newControlsEl;footerEl;footer;renderer;currentCreateFileLabel;constructor(e){super(e),this.currentCreateFileLabel=e.createFileLabel||"File",this.stateTransformer=new wn(e.searchFilter,this.currentCreateFileLabel),this.buildInitialHTML(e),this.bodyEl=this.container.querySelector(".vfs-node-list__body"),this.searchEl=this.container.querySelector(".vfs-node-list__search"),this.mainContainerEl=this.container.querySelector(".vfs-node-list"),this.titleEl=this.container.querySelector('[data-ref="title"]'),this.newControlsEl=this.container.querySelector('[data-ref="new-controls"]'),this.footerEl=this.container.querySelector(".vfs-node-list__footer"),this.selectionHandler=new Sn(this.store),this.dragDropHandler=new En(e.instanceId,this.coordinator,this.bodyEl,()=>this.state.expandedFolderIds,()=>this.state.selectedItemIds),this.itemActionHandler=new Cn(this.store,this.coordinator),this.tagEditorPopover=new Mn(e.tagEditorFactory),this.contextMenuHandler=new Tn(this.store,this.coordinator,e.contextMenu,{showTagEditor:t=>this.tagEditorPopover.show(t),findItemById:t=>this.findItemById(t)},this.currentCreateFileLabel),this.settingsPopover=new kn(this.coordinator,this.mainContainerEl),this.footer=new Nn(this.footerEl,{onSelectAllToggle:()=>this.selectionHandler.handleSelectAllToggle(this.state.selectionStatus,this.state.visibleItemIds),onDeselectAll:()=>this.selectionHandler.clearSelection(),onBulkDelete:()=>this.handleBulkDelete(),onBulkMove:()=>this.coordinator.publish("MOVE_OPERATION_START_REQUESTED",{itemIds:[...this.state.selectedItemIds]}),onSettingsClick:()=>this.settingsPopover.toggle(this.state.uiSettings)}),this.renderer=new Pn(this.selectionHandler),e.title&&this.setTitle(e.title)}setTitle(e){this.titleEl&&(this.titleEl.textContent=e)}transformState(e){return this.stateTransformer.transform(e)}bindEvents(){this.searchEl.addEventListener("input",Zs(e=>{this.coordinator.publish("SEARCH_QUERY_CHANGED",{query:e.target.value})},300)),this.newControlsEl.addEventListener("click",this.handleNewControlsClick),document.addEventListener("click",this.handleGlobalClick,!0),this.bodyEl.addEventListener("click",this.handleItemClick),this.state.readOnly||(this.bodyEl.addEventListener("contextmenu",this.handleContextMenu),this.bodyEl.addEventListener("keydown",this.handleKeyDown),this.bodyEl.addEventListener("blur",this.handleBlur,!0),this.bodyEl.addEventListener("dragstart",this.dragDropHandler.handleDragStart),this.bodyEl.addEventListener("dragover",this.dragDropHandler.handleDragOver),this.bodyEl.addEventListener("dragleave",this.dragDropHandler.handleDragLeave),this.bodyEl.addEventListener("drop",this.dragDropHandler.handleDrop),this.bodyEl.addEventListener("dragend",this.dragDropHandler.handleDragEnd))}handleNewControlsClick=e=>{const s=e.target.closest("[data-action]");if(!s)return;const n=s.dataset.action,i=this.itemActionHandler.getTargetParentId(this.state.selectedItemIds,o=>this.findItemById(o));if(n==="import")this.coordinator.publish("PUBLIC_IMPORT_REQUESTED",{parentId:i});else if(n==="create-file"||n==="create-directory"){const o=n.split("-")[1];this.coordinator.publish("CREATE_ITEM_REQUESTED",{type:o,parentId:i})}};handleItemClick=e=>{const t=e.target,s=t.closest("[data-item-id]");if(!s){if(t.closest("input")||t.closest(".vfs-node-list__item-creator"))return;this.itemActionHandler.handleEmptyAreaClick(this.state.readOnly,this.state.selectedItemIds.size,()=>this.render());return}const n=s.dataset.itemId,i=s.dataset.itemType,o=this.itemActionHandler.handleItemClick(e,s,this.state.readOnly,()=>this.render());if(o.handled){o.shouldSelect&&this.selectionHandler.toggleSelection(n);return}o.shouldSelect&&this.selectionHandler.handleItemSelection(n,e,this.state.visibleItemIds,this.state.readOnly),o.shouldNavigate&&(i==="file"?this.coordinator.publish("SESSION_SELECT_REQUESTED",{sessionId:n}):i==="directory"&&this.coordinator.publish("SESSION_SELECT_REQUESTED",{sessionId:null}))};handleContextMenu=e=>{const s=e.target.closest("[data-item-id]");s&&(this.tagEditorPopover.hide(),this.contextMenuHandler.show(e,s))};handleKeyDown=e=>{const t=e.target;t.dataset.action==="create-input"&&(e.key==="Enter"?(e.preventDefault(),this.commitItemCreation(t)):e.key==="Escape"&&this.store.dispatch({type:"CREATE_ITEM_END"}))};handleBlur=e=>{const t=e.target;t.dataset.action==="create-input"&&this.commitItemCreation(t)};handleGlobalClick=e=>{const t=e.target;this.settingsPopover.isVisible()&&!t.closest('.vfs-settings-popover, [data-action="settings"]')&&this.settingsPopover.hide(),t.closest(".vfs-context-menu")||this.contextMenuHandler.hide(),this.tagEditorPopover.isVisible()&&!this.tagEditorPopover.containsElement(t)&&this.tagEditorPopover.hide();const s=this.itemActionHandler.getConfirmDeleteId();s&&!t.closest(`[data-item-id="${s}"]`)&&(this.itemActionHandler.setConfirmDeleteId(null),this.render())};handleBulkDelete(){this.coordinator.publish("BULK_ACTION_REQUESTED",{action:"delete"})}findItemById(e){const t=(s,n)=>{for(const i of s){if(i.id===n)return i;if(i.type==="directory"&&i.children){const o=t(i.children,n);if(o)return o}}return null};return t(this.state.items,e)}commitItemCreation(e){if(!this.state.creatingItem)return;const t=e.value.trim(),{type:s,parentId:n}=this.state.creatingItem;this.store.dispatch({type:"CREATE_ITEM_END"}),t&&this.coordinator.publish("CREATE_ITEM_CONFIRMED",{type:s,title:t,parentId:n})}buildInitialHTML(e){const t=e.searchPlaceholder||"搜索 (tag:xx type:file|dir)...";this.container.innerHTML=`
      <div class="vfs-node-list">
        <div class="vfs-node-list__title-bar">
          <h2 class="vfs-node-list__title" data-ref="title">${T(e.title||"文件列表")}</h2>
        </div>
        <div class="vfs-node-list__header">
          <input type="search" class="vfs-node-list__search" placeholder="${T(t)}" />
          <div class="vfs-node-list__new-controls" data-ref="new-controls">
            <button class="vfs-node-list__new-btn" data-action="create-file" title="新建 ${T(this.currentCreateFileLabel)}">
              <span>+</span><span class="btn-label">${T(this.currentCreateFileLabel)}</span>
            </button>
            <button class="vfs-node-list__new-btn vfs-node-list__new-btn--folder" data-action="create-directory" title="新建目录"><span>📁+</span></button>
            <button class="vfs-node-list__new-btn vfs-node-list__new-btn--icon" data-action="import" title="导入文件"><i class="fas fa-upload"></i></button>
          </div>
        </div>
        <div class="vfs-node-list__body"></div>
        <div class="vfs-node-list__footer"></div>
      </div>
    `}updateCreateFileButton(){const e=this.newControlsEl.querySelector('[data-action="create-file"] .btn-label'),t=this.newControlsEl.querySelector('[data-action="create-file"]');e&&(e.textContent=this.currentCreateFileLabel),t&&(t.title=`新建 ${this.currentCreateFileLabel}`)}render(){this.mainContainerEl.classList.toggle("vfs-node-list--density-compact",this.state.uiSettings.density==="compact");const e=!this.state.readOnly&&this.state.selectedItemIds.size>1;this.mainContainerEl.classList.toggle("vfs-node-list--bulk-mode",e),this.newControlsEl.style.display=this.state.readOnly?"none":"";const t=!this.state.readOnly&&this.state.selectedItemIds.size>1;this.footerEl.style.display=t?"":"none",this.state.createFileLabel!==this.currentCreateFileLabel&&(this.currentCreateFileLabel=this.state.createFileLabel,this.updateCreateFileButton()),this.footer.render({selectionStatus:this.state.selectionStatus,selectedCount:this.state.selectedItemIds.size,isReadOnly:this.state.readOnly}),this.state.status==="loading"?this.bodyEl.innerHTML='<div class="vfs-node-list__placeholder">正在加载...</div>':this.state.status==="error"?this.bodyEl.innerHTML='<div class="vfs-node-list__placeholder">加载失败！</div>':this.renderer.renderItems(this.bodyEl,this.state,{confirmDeleteId:this.itemActionHandler.getConfirmDeleteId(),findItemById:n=>this.findItemById(n)});const s=this.bodyEl.querySelector(".vfs-node-list__item-creator-input");s&&s.focus()}destroy(){super.destroy(),document.removeEventListener("click",this.handleGlobalClick,!0),this.dragDropHandler.destroy(),this.settingsPopover.destroy(),this.tagEditorPopover.destroy(),this.contextMenuHandler.hide(),this.renderer.destroy()}}class Fn extends Ye{constructor(e){super(e),this.container.classList.add("vfs-file-outline")}transformState(e){const{activeId:t,items:s,expandedOutlineH1Ids:n=new Set}=e;let i=[];if(t){const o=re(s,t);o?.type==="file"&&(i=o.headings||[])}return{headings:i,expandedH1Ids:n}}bindEvents(){this.container.addEventListener("click",e=>{const t=e.target.closest("[data-action]"),s=e.target.closest("li[data-element-id]");if(!t||!s)return;const n=s.dataset.elementId;if(!n)return;e.preventDefault();const i=t.dataset.action;i==="toggle-expand"?this.coordinator.publish("OUTLINE_H1_TOGGLE_REQUESTED",{elementId:n}):i==="navigate"&&this.coordinator.publish("NAVIGATE_TO_HEADING_REQUESTED",{elementId:n})})}render(){const{headings:e,expandedH1Ids:t}=this.state;if(!e?.length){this.container.innerHTML=`
        <h3 class="vfs-file-outline__title">大纲</h3>
        <div class="vfs-file-outline__placeholder">文档中暂无标题</div>`;return}const s=n=>{const i=(n.children?.length??0)>0,o=t.has(n.id),a=n.level===1&&i?`<span class="vfs-file-outline__toggle ${o?"is-expanded":""}" data-action="toggle-expand"></span>`:'<span class="vfs-file-outline__toggle is-placeholder"></span>',r=n.level===1&&i&&o?`<ul class="vfs-file-outline__list">${n.children.map(s).join("")}</ul>`:"";return`
        <li class="vfs-file-outline__item vfs-file-outline__item--level-${n.level}" data-element-id="${n.id}">
          <a href="#${n.id}" class="vfs-file-outline__link" data-action="navigate">
            ${a}
            <span class="vfs-file-outline__text">${n.text}</span>
          </a>
          ${r}
        </li>`};this.container.innerHTML=`
      <h3 class="vfs-file-outline__title">大纲</h3>
      <ul class="vfs-file-outline__list">${e.map(s).join("")}</ul>`}}class Bn extends Ye{selectedTargetId=null;constructor(e){super(e),this.container.classList.add("vfs-move-modal-overlay")}transformState(e){const t=s=>s.filter(n=>n.type==="directory").map(n=>({...n,children:n.children?t(n.children):[]}));return{operation:e.moveOperation,availableTargets:e.moveOperation?t(e.items):[]}}bindEvents(){this.container.addEventListener("click",e=>{const t=e.target,s=t.closest("[data-action]")?.dataset.action,n=t.closest("[data-folder-id]")?.dataset.folderId;s==="confirm-move"&&this.selectedTargetId&&this.state.operation?(this.coordinator.publish("ITEMS_MOVE_REQUESTED",{itemIds:this.state.operation.itemIds,targetId:this.selectedTargetId==="root"?null:this.selectedTargetId,position:"into"}),this.coordinator.publish("MOVE_OPERATION_END_REQUESTED",{})):s==="cancel-move"||t===this.container?this.coordinator.publish("MOVE_OPERATION_END_REQUESTED",{}):n&&(this.selectedTargetId=n,this.render())})}render(){if(!this.state.operation?.isMoving){this.container.style.display="none",this.selectedTargetId=null;return}this.container.style.display="flex";const e=(t,s=0)=>t.map(n=>`
        <div class="vfs-move-modal__folder-wrapper">
          <div class="vfs-move-modal__folder" style="--level:${s};" data-folder-id="${n.id}">
            <span class="vfs-move-modal__folder-toggle">${n.children?.length?"▶":""}</span>
            <span class="vfs-move-modal__folder-icon">📁</span>
            <span class="vfs-move-modal__folder-title ${n.id===this.selectedTargetId?"is-selected":""}">${n.metadata.title}</span>
          </div>
          ${n.children?.length?`<div class="vfs-move-modal__folder-children">${e(n.children,s+1)}</div>`:""}
        </div>`).join("");this.container.innerHTML=`
      <div class="vfs-move-modal">
        <div class="vfs-move-modal__header">移动 ${this.state.operation.itemIds.length} 个项目到...</div>
        <div class="vfs-move-modal__body">
          <div class="vfs-move-modal__folder" data-folder-id="root">
            <span class="vfs-move-modal__folder-icon">🗂️</span>
            <span class="vfs-move-modal__folder-title ${this.selectedTargetId==="root"?"is-selected":""}">根目录</span>
          </div>
          ${e(this.state.availableTargets)}
        </div>
        <div class="vfs-move-modal__footer">
          <button class="vfs-move-modal__btn" data-action="cancel-move">取消</button>
          <button class="vfs-move-modal__btn vfs-move-modal__btn--primary" data-action="confirm-move" ${this.selectedTargetId?"":"disabled"}>移动</button>
        </div>
      </div>`}}function qe(l){const e={summary:"",searchableText:"",headings:[],metadata:{}};if(typeof l!="string"||!l)return e;const t=Te(l);if(t)return{summary:an(t),searchableText:l,headings:[],metadata:{}};const s=on(l,{extractHeadings:!0,extractSummary:!0,extractSearchable:!0,extractTasks:!0}),n={};return s.taskCounts&&(n.taskCount=s.taskCounts),s.clozeCount>0&&(n.clozeCount=s.clozeCount),s.mermaidCount>0&&(n.mermaidCount=s.mermaidCount),{summary:s.summary||"",searchableText:s.searchableText,headings:s.headings,metadata:n}}const $t=(l,e,t)=>{const s=l.type==="directory";let n={summary:"",searchableText:"",headings:[],metadata:{}};if(!s&&l.content){const a=typeof l.content=="string"?l.content:"",r=t?.(l.name);n=r?{...qe(a),...r(a,ge(l.name))}:qe(a)}const i=l.metadata?.title||(s?l.name:cn(l.name)),o=l.icon||e?.(l.name,s)||(s?"📁":"📄");return{id:l.id,type:s?"directory":"file",version:"1.0",icon:o,metadata:{title:i,tags:l.tags||[],createdAt:new Date(l.createdAt).toISOString(),lastModified:new Date(l.modifiedAt).toISOString(),parentId:l.parentId,path:l.path,moduleId:l.moduleId,custom:{...l.metadata||{},...n.metadata,_originalName:l.name,_extension:!s&&l.name.includes(".")?ge(l.name):""}},content:s?void 0:{format:l.metadata?.contentType||"text/markdown",summary:n.summary,searchableText:n.searchableText,data:l.content},headings:n.headings,children:s&&l.children?Rt(l.children,e,t):void 0}},Rt=(l,e,t)=>l?.filter(s=>!pe(s.name)).map(s=>$t(s,e,t))||[],Un={sessionSelected:"PUBLIC_SESSION_SELECTED",navigateToHeading:"PUBLIC_NAVIGATE_TO_HEADING",importRequested:"PUBLIC_IMPORT_REQUESTED",sidebarStateChanged:"PUBLIC_SIDEBAR_STATE_CHANGED",menuItemClicked:"PUBLIC_MENU_ITEM_CLICKED",stateChanged:"PUBLIC_STATE_CHANGED"},Hn={sortBy:"title",density:"comfortable",showSummary:!0,showTags:!0,showBadges:!0};class zn extends Je{coordinator;store;fileTypeRegistry;instanceId;options;engine;_vfsService;nodeList;fileOutline;moveToModal;instanceModalContainer;engineUnsubscribe=null;lastActiveId=null;lastSidebarState=!1;lastForceTimestamp;lastSessionSelectWasUserAction=!1;queues={update:new Set,delete:new Set,create:new Set};timers={update:null,delete:null,create:null};constructor(e,t){if(super(),!e.sessionListContainer)throw new Error("VFSUIManager requires 'sessionListContainer'.");this.options=e,this.engine=t,this.instanceId=me(),this.fileTypeRegistry=new yn(e.defaultEditorFactory,e.customEditorResolver),e.fileTypes?.forEach(n=>this.fileTypeRegistry.register(n)),this.coordinator=new rn;const s=this.loadUiState();this.store=new gn({...e.initialState,...s,uiSettings:{...Hn,...e.defaultUiSettings,...s.uiSettings,...e.initialState?.uiSettings},isSidebarCollapsed:e.initialSidebarCollapsed,readOnly:e.readOnly||!1}),this.lastActiveId=this.store.getState().activeId,this.lastSidebarState=this.store.getState().isSidebarCollapsed,this._vfsService=new fn({engine:this.engine,defaultExtension:e.defaultExtension,newFileContent:e.newSessionContent}),this.initializeComponents(),this.connectUIEvents(),e.readOnly||this.connectEngineEvents(),this.store.subscribe(()=>this.saveUiState())}initializeComponents(){const e=new vn(this.engine),t=this.options.components?.tagEditor?n=>{const i=new this.options.components.tagEditor({container:n.container,initialItems:n.initialTags,suggestionProvider:e,onSave:n.onSave,onCancel:n.onCancel});return i.init?.(),i}:n=>{const i=new bn(n.container,{container:n.container,initialItems:n.initialTags,suggestionProvider:e,onSave:n.onSave,onCancel:n.onCancel});return i.init(),i};this.nodeList=new On({container:this.options.sessionListContainer,store:this.store,coordinator:this.coordinator,contextMenu:this.options.contextMenu,tagEditorFactory:t,searchPlaceholder:this.options.searchPlaceholder||"Search (tag:xx type:file|dir)...",createFileLabel:this.options.createFileLabel,title:this.options.title,searchFilter:this.options.searchFilter,instanceId:this.instanceId}),this.options.documentOutlineContainer&&(this.fileOutline=new Fn({container:this.options.documentOutlineContainer,store:this.store,coordinator:this.coordinator}));let s=document.getElementById("vfs-modal-container");s||(s=document.createElement("div"),s.id="vfs-modal-container",Object.assign(s.style,{position:"absolute",top:"0",left:"0",width:"0",height:"0",zIndex:"9999"}),document.body.appendChild(s)),this.instanceModalContainer=document.createElement("div"),this.instanceModalContainer.className=`vfs-modal-wrapper-${this.instanceId}`,s.appendChild(this.instanceModalContainer),this.moveToModal=new Bn({container:this.instanceModalContainer,store:this.store,coordinator:this.coordinator}),this.options.title&&this.nodeList.setTitle(this.options.title)}get sessionService(){return this._vfsService}resolveEditorFactory(e){return this.fileTypeRegistry.resolveEditorFactory(e)}async start(){if(this.nodeList.init(),this.fileOutline?.init(),this.moveToModal.init(),this.options.readOnly&&this.options.initialState?.items)return this.getActiveSession();if(await this.loadData(),!this.store.getState().items.length&&!this.options.readOnly&&this.options.defaultFileName)try{await this._vfsService.createFile({title:this.options.defaultFileName,content:this.options.defaultFileContent||`# Welcome

Select a file to start.`,parentId:null})}catch(s){console.error("[VFSUIManager] Failed to create default file:",s)}let t=this.getActiveSession();if(!t){const s=i=>{for(const o of i){if(o.type==="file")return o;const a=o.children&&s(o.children);if(a)return a}return null},n=s(this.store.getState().items);n&&(this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:n.id}}),t=this.getActiveSession())}return t}getActiveSession(){const{activeId:e,items:t}=this.store.getState();return e?re(t,e):void 0}updateSessionContent=(e,t)=>this.engine.writeContent(e,t);toggleSidebar(){this.store.dispatch({type:"SIDEBAR_TOGGLE"})}setTitle(e){this.nodeList.setTitle(e)}on(e,t){const s=Un[e];return s?this.coordinator.subscribe(s,n=>t(n.data)):()=>{}}destroy(){this.nodeList.destroy(),this.fileOutline?.destroy(),this.moveToModal.destroy(),this.instanceModalContainer?.remove(),this.coordinator.clearAll(),this.engineUnsubscribe?.()}get uiStorageKey(){return`vfs_ui_state_${this.options.scopeId||this.engine.moduleName||"default"}`}loadUiState(){try{const e=localStorage.getItem(this.uiStorageKey);return e?JSON.parse(e):{}}catch{return{}}}saveUiState(){const e=this.store.getState();try{localStorage.setItem(this.uiStorageKey,JSON.stringify({activeId:e.activeId,expandedFolderIds:[...e.expandedFolderIds],selectedItemIds:[...e.selectedItemIds],uiSettings:e.uiSettings,isSidebarCollapsed:e.isSidebarCollapsed}))}catch(t){console.error("Failed to save UI state:",t)}}async loadData(){try{this.store.dispatch({type:"ITEMS_LOAD_START"});const e=await this.engine.loadTree(),n=Rt(e,(o,a)=>this.fileTypeRegistry.getIcon(o,a),o=>this.fileTypeRegistry.resolveContentParser(o)),i=this.buildTagsMap(n);this.store.dispatch({type:"STATE_LOAD_SUCCESS",payload:{items:n,tags:i}})}catch(e){console.error("[VFSUIManager] Failed to load data:",e),this.store.dispatch({type:"ITEMS_LOAD_ERROR",payload:{error:e}})}}buildTagsMap(e){const t=new Map;return Ke(e,s=>{s.metadata.tags?.forEach(n=>{t.has(n)||t.set(n,{name:n,color:null,itemIds:new Set}),t.get(n).itemIds.add(s.id)})}),t}connectEngineEvents(){const e=(r,c)=>this.fileTypeRegistry.getIcon(r,c),t=r=>this.fileTypeRegistry.resolveContentParser(r),s=async(r,c)=>{if(!r.size)return;const d=[...r];if(r.clear(),this.timers[c]=null,c==="delete"){this.store.dispatch({type:"ITEM_DELETE_SUCCESS",payload:{itemIds:d}});return}const u=(await Promise.all(d.map(async p=>{try{const m=await this.engine.getNode(p);return!m||pe(m.name)?(c==="update"&&this.store.dispatch({type:"ITEM_DELETE_SUCCESS",payload:{itemIds:[p]}}),null):(m.type==="file"?m.content=await this.engine.readContent(p):m.children=[],$t(m,e,t))}catch{return null}}))).filter(Boolean);c==="update"?this.store.dispatch({type:"ITEMS_BATCH_UPDATE_SUCCESS",payload:{updates:u.map(p=>({itemId:p.id,data:p}))}}):u.forEach(p=>{this.store.dispatch({type:p.type==="directory"?"FOLDER_CREATE_SUCCESS":"SESSION_CREATE_SUCCESS",payload:p})})},n=(r,c,d)=>{this.timers[c]||(this.timers[c]=setTimeout(()=>s(r,c),d))},i=r=>{const{type:c,payload:d}=r;switch(c){case"node:created":this.queues.create.add(d.nodeId),n(this.queues.create,"create",50);break;case"node:deleted":(d.data?.removedIds||[d.nodeId]).filter(Boolean).forEach(p=>this.queues.delete.add(p)),n(this.queues.delete,"delete",20);break;case"node:batch_deleted":(d.removedIds||[]).forEach(p=>this.queues.delete.add(p)),n(this.queues.delete,"delete",20);break;case"node:updated":this.queues.update.add(d.nodeId),n(this.queues.update,"update",50);break;case"node:batch_updated":d.updatedNodeIds?.forEach(p=>this.queues.update.add(p)),n(this.queues.update,"update",50);break;case"node:moved":case"node:batch_moved":this.loadData(),this.store.dispatch({type:"MOVE_OPERATION_END"});break}},a=["node:created","node:updated","node:deleted","node:moved","node:batch_updated","node:batch_moved","node:batch_deleted"].map(r=>this.engine.on(r,i));this.engineUnsubscribe=()=>a.forEach(r=>r())}connectUIEvents(){this.store.subscribe(t=>{const s=this.getActiveSession(),n=t.activeId!==this.lastActiveId,i=t._forceUpdateTimestamp!==this.lastForceTimestamp;(n||this.lastSessionSelectWasUserAction||i)&&(this.lastActiveId=t.activeId,i&&(this.lastForceTimestamp=t._forceUpdateTimestamp),this.coordinator.publish("PUBLIC_SESSION_SELECTED",{item:s}),this.lastSessionSelectWasUserAction=!1),t.isSidebarCollapsed!==this.lastSidebarState&&(this.lastSidebarState=t.isSidebarCollapsed,this.coordinator.publish("PUBLIC_SIDEBAR_STATE_CHANGED",{isCollapsed:t.isSidebarCollapsed})),this.coordinator.publish("PUBLIC_STATE_CHANGED",{state:t})}),Object.entries({PUBLIC_IMPORT_REQUESTED:async({parentId:t})=>{const s=Object.assign(document.createElement("input"),{type:"file",multiple:!0,accept:"*/*",style:"display:none"});s.onchange=async n=>{const i=n.target.files;if(i?.length)try{const o=await Promise.all([...i].map(async r=>({title:r.name,content:await this.readFileContent(r)}))),a=await this._vfsService.createFiles({parentId:t,files:o});await this.loadData(),a.length&&a[0].type==="file"&&setTimeout(()=>this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:a[0].id}}),50)}catch(o){console.error("[VFSUIManager] Import failed:",o),alert("导入失败: "+o.message)}finally{s.remove()}},document.body.appendChild(s),s.click()},CREATE_ITEM_CONFIRMED:async({type:t,title:s,parentId:n})=>{try{t==="file"?await this._vfsService.createFile({title:s,parentId:n,content:this.options.newSessionContent||""}):await this._vfsService.createDirectory({title:s,parentId:n})}catch(i){console.error(`[VFSUIManager] Failed to create ${t}:`,i),alert(`创建失败: ${i.message}`),this.store.dispatch({type:"CREATE_ITEM_START",payload:{type:t,parentId:n}})}},ITEM_ACTION_REQUESTED:async({action:t,itemId:s})=>{const n=re(this.store.getState().items,s);if(t==="delete"||t==="delete-direct"){if(t==="delete"&&!confirm(`确定删除 "${n?.metadata.title||"this item"}"?`))return;await this._vfsService.deleteItems([s])}else if(t==="rename"){const i=n?.metadata.title||"",o=prompt("输入新名称:",i);if(o?.trim()&&o.trim()!==i){let a=o.trim();if(n?.type==="file"&&!/\.[a-zA-Z0-9]{1,10}$/.test(a)){const r=n.metadata.custom?._extension||"";r&&(a+=r)}try{await this._vfsService.renameItem(s,a)}catch(r){alert(`重命名失败: ${r.message}`)}}}},BULK_ACTION_REQUESTED:async({action:t})=>{const s=[...this.store.getState().selectedItemIds];t==="delete"&&confirm(`确定删除 ${s.length} 个项目?`)&&await this._vfsService.deleteItems(s)},ITEMS_MOVE_REQUESTED:t=>this._vfsService.moveItems(t),ITEM_TAGS_UPDATE_REQUESTED:t=>this._vfsService.updateMultipleItemsTags(t),SESSION_SELECT_REQUESTED:({sessionId:t})=>{this.lastSessionSelectWasUserAction=!0,this.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:t}})},CREATE_ITEM_REQUESTED:t=>this.store.dispatch({type:"CREATE_ITEM_START",payload:t}),MOVE_OPERATION_START_REQUESTED:t=>this.store.dispatch({type:"MOVE_OPERATION_START",payload:t}),MOVE_OPERATION_END_REQUESTED:()=>this.store.dispatch({type:"MOVE_OPERATION_END"}),FOLDER_TOGGLE_REQUESTED:({folderId:t})=>this.store.dispatch({type:"FOLDER_TOGGLE",payload:{folderId:t}}),SETTINGS_CHANGE_REQUESTED:({settings:t})=>this.store.dispatch({type:"SETTINGS_UPDATE",payload:{settings:t}}),OUTLINE_TOGGLE_REQUESTED:t=>this.store.dispatch({type:"OUTLINE_TOGGLE",payload:t}),OUTLINE_H1_TOGGLE_REQUESTED:t=>this.store.dispatch({type:"OUTLINE_H1_TOGGLE",payload:t}),SEARCH_QUERY_CHANGED:({query:t})=>this.store.dispatch({type:"SEARCH_QUERY_UPDATE",payload:{query:t}}),NAVIGATE_TO_HEADING_REQUESTED:t=>this.coordinator.publish("PUBLIC_NAVIGATE_TO_HEADING",t),CUSTOM_MENU_ACTION_REQUESTED:({action:t,item:s})=>this.coordinator.publish("PUBLIC_MENU_ITEM_CLICKED",{actionId:t,item:s})}).forEach(([t,s])=>{this.coordinator.subscribe(t,n=>s(n.data))})}async readFileContent(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>s(new Error(`读取失败: ${e.name}`));const i=[".md",".txt",".json",".html",".css",".js",".ts"];e.type.startsWith("text/")||i.some(a=>e.name.endsWith(a))?n.readAsText(e):n.readAsArrayBuffer(e)})}}class qn extends Xs{engine;searchScope;constructor({engine:e,scope:t=!0}){if(super(),!e)throw new Error(`${this.constructor.name} requires an ISessionEngine instance.`);this.engine=e,this.searchScope=Array.isArray(t)?t:t?["*"]:void 0}filterResults=e=>e.filter(t=>!ln(t));parseUri(e){if(!e)return null;try{return new URL(e).pathname?.substring(1)||null}catch{return null}}}class jn extends qn{key="file";triggerChar="@";async getSuggestions(e){try{const t=await this.engine.search({type:"file",text:e,limit:20,scope:this.searchScope});return this.filterResults(t).map(s=>({id:s.id,label:this.formatLabel(s),title:s.name,type:"file",path:s.path,module:s.moduleId}))}catch(t){return console.error("[FileMentionSource] Error:",t),[]}}formatLabel(e){const t=e.path.substring(0,e.path.lastIndexOf("/"))||"/",s=t==="/"?"":` ${t}`,n=e.moduleId?`[${e.moduleId}]`:"";return`${e.icon||"📄"} ${e.name} (${n}${s})`}async getHoverPreview(e){const t=this.parseUri(e);if(!t)return null;try{const[s,n]=await Promise.all([this.engine.getNode(t),this.engine.readContent(t)]);if(!s)return null;const i=typeof n=="string"?n:new TextDecoder().decode(n),o=i.substring(0,150).replace(/[\r\n]+/g," ").replace(/([#*`])/g,"")+(i.length>150?"...":""),a=new Date(s.modifiedAt).toLocaleDateString(),r=s.moduleId?`<span style="background:#eee;padding:2px 4px;border-radius:3px;font-size:0.8em;margin-right:5px;">${s.moduleId}</span>`:"";return{title:s.name,icon:s.icon||"📄",contentHTML:`
          <div class="vfs-hover-preview" style="font-size:0.9em;line-height:1.4;">
            <div style="margin-bottom:6px;color:#666;font-size:0.85em;display:flex;align-items:center;">
              ${r}<span style="font-family:monospace;">${s.path}</span>
            </div>
            <div style="margin-bottom:8px;color:#333;">${T(o)}</div>
            <div style="color:#999;font-size:0.8em;border-top:1px solid #eee;padding-top:4px;">Updated: ${a}</div>
          </div>`}}catch(s){return console.error("[FileMentionSource] getHoverPreview error:",s),null}}async getDataForProcess(e){const t=e?.pathname?.substring(1);if(!t)return null;try{const s=await this.engine.getNode(t);if(!s)return null;const n=await this.engine.readContent(t);return{id:s.id,title:s.name,content:n,tags:s.tags,module:s.moduleId,path:s.path,createdAt:new Date(s.createdAt),modifiedAt:new Date(s.modifiedAt),...s.metadata}}catch(s){return console.warn("[FileMentionSource] Process data fetch failed:",s),null}}}function Vn(l,e,t,s,n={}){const{onEditorCreated:i,saveDebounceMs:o=500,...a}=n;let r=null,c=null,d=[],h=null,u=0,p=null,m=!1;const g=(S,D)=>{l.store?.dispatch({type:"ITEM_METADATA_UPDATE",payload:{itemId:S,metadata:D}})},y=()=>{if(!r||!c)return;const S=Ct(r.getText()),D=p||c.metadata.custom.taskCount||{total:0,completed:0};(S.total!==D.total||S.completed!==D.completed)&&(p=S,m=!0,g(c.id,{custom:{...c.metadata.custom,taskCount:S}}))},b=async()=>{if(!(!r||!c)&&(h&&(clearTimeout(h),h=null),!(!r.isDirty?.()&&!m)))try{if(l.store?.getState()?.items.some(function P(U){return U.id===c.id||!!U.children?.some(P)})){const P=r.getText();await e.writeContent(c.id,P);const{metadata:U,summary:q}=qe(P);await e.updateMetadata(c.id,{taskCount:U.taskCount,clozeCount:U.clozeCount,mermaidCount:U.mermaidCount,_summary:q}),r.setDirty?.(!1),m=!1}}catch(S){console.error("[EditorConnector] Save failed:",S)}},E=()=>{h&&clearTimeout(h),h=setTimeout(b,o)},k=async()=>{u++,r&&(await b(),d.forEach(S=>S()),d=[],await r.destroy(),r=null,c=null,p=null,m=!1,i?.(null))},F=()=>{const S=a.hostContext;return{toggleSidebar:()=>l.toggleSidebar(),saveContent:(D,P)=>e.writeContent(D,P),navigate:async D=>{S?.navigate?await S.navigate(D):console.warn("[EditorConnector] No navigation handler.",D)}}},B=async({item:S})=>{await k();const D=u;if(t.innerHTML="",!S||S.type!=="file"){t.innerHTML='<div class="editor-placeholder">Select a file...</div>';return}setTimeout(async()=>{if(D===u)try{const P=l.resolveEditorFactory?.(S)||s;if(!P)throw new Error("No suitable editor factory found.");const U={...a,initialContent:S.content?.data||"",title:S.metadata.title,nodeId:S.id,language:S.metadata.custom?._extension||"",sessionEngine:e,hostContext:F()},q=await P(t,U);if(D!==u){q?.destroy();return}if(r=q,c=S,p=S.metadata.custom.taskCount||null,m=!1,r){const K=(j,O)=>{try{const V=r.on(j,O);typeof V=="function"&&d.push(V)}catch(V){console.warn(`[EditorConnector] Failed to bind event '${j}':`,V)}};K("blur",E),K("modeChanged",j=>j?.mode==="render"&&b()),K("interactiveChange",()=>{y(),E()}),K("optimisticUpdate",y)}i?.(r)}catch(P){D===u&&(console.error("[EditorConnector] Create failed:",P),t.innerHTML=`<div class="editor-placeholder editor-placeholder--error">Error: ${P.message}</div>`)}},0)},v=l.on("navigateToHeading",async({elementId:S})=>{r?.navigateTo({elementId:S})}),L=l.on("sessionSelected",B);return B({item:l.getActiveSession()}),()=>{L(),v(),k().catch(console.error)}}const Wn=(l,e)=>new zn(l,e);class Gn{services=new Map;provide(e,t){this.services.set(e,t)}inject(e){return this.services.get(e)}has(e){return this.services.has(e)}remove(e){this.services.delete(e)}clear(){this.services.clear()}}class Jn{constructor(e,t,s){this.engine=e,this.nodeId=t,this.pluginNamespace=s}getMetaKey(){return`_mdx_plugin_${this.pluginNamespace}`}async get(e){try{const t=await this.engine.getNode(this.nodeId);return t?t.metadata?.[this.getMetaKey()]?.[e]:void 0}catch(t){console.warn(`EngineMetadataStore: Failed to get key "${e}"`,t);return}}async set(e,t){try{const s=await this.engine.getNode(this.nodeId);if(!s)throw new Error(`Node ${this.nodeId} not found`);const n=this.getMetaKey(),i=s.metadata||{},o=i[n]||{};o[e]=t;const a={...i,[n]:o};await this.engine.updateMetadata(this.nodeId,a)}catch(s){throw console.error(`EngineMetadataStore: Failed to set key "${e}"`,s),s}}async remove(e){try{const t=await this.engine.getNode(this.nodeId);if(!t)return;const s=this.getMetaKey(),n=t.metadata||{},i=n[s];if(i&&e in i){delete i[e];const o={...n,[s]:i};await this.engine.updateMetadata(this.nodeId,o)}}catch(t){console.warn(`EngineMetadataStore: Failed to remove key "${e}"`,t)}}}class Qn{constructor(e,t){this.adapter=e,this.prefix=t}makeKey(e){return`${this.prefix}:${e}`}async get(e){return this.adapter.getItem(this.makeKey(e))}async set(e,t){return this.adapter.setItem(this.makeKey(e),t)}async remove(e){return this.adapter.removeItem(this.makeKey(e))}}class Kn{data=new Map;async get(e){return this.data.get(e)}async set(e,t){this.data.set(e,t)}async remove(e){this.data.delete(e)}async clear(){this.data.clear()}}let Yn=class{plugins=new Map;hooks=new Map;eventBus=new Map;serviceContainer;sessionEngine=null;currentNodeId=null;ownerNodeId=null;dataAdapter=null;coreInstance;instanceId;editorInstance=null;instanceStores=new Map;codemirrorExtensions=[];commands=new Map;toolbarButtons=[];titleBarButtons=[];constructor(e){this.coreInstance=e,this.serviceContainer=new Gn,this.instanceId=`mdx-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}setContext(e,t,s){e&&(this.currentNodeId=e),s&&(this.sessionEngine=s),this.ownerNodeId=t||e||null}setDataAdapter(e){this.dataAdapter=e}createContextFor(e){const t=new Map,s=new Map;return{pluginManager:this,registerSyntaxExtension:n=>{this.coreInstance.markedExtensions||(this.coreInstance.markedExtensions=[]),this.coreInstance.markedExtensions.push(n)},registerCodeMirrorExtension:n=>{Array.isArray(n)?this.codemirrorExtensions.push(...n):this.codemirrorExtensions.push(n)},registerCommand:(n,i)=>{this.commands.set(n,i)},registerToolbarButton:n=>{this.toolbarButtons.push(n)},registerTitleBarButton:n=>{this.titleBarButtons.push(n)},findAndSelectText:n=>{const i=this.editorInstance||this.coreInstance;i&&typeof i.findAndSelectText=="function"?i.findAndSelectText(n):console.warn("findAndSelectText is not available in this context")},switchToMode:n=>{const i=this.editorInstance||this.coreInstance;i&&typeof i.switchToMode=="function"?i.switchToMode(n):console.warn("switchToMode is not available in this context")},on:(n,i)=>{const o=Symbol(`${e.name}:${n}`);return this.hooks.has(n)||this.hooks.set(n,new Map),this.hooks.get(n).set(o,i),t.set(n,o),()=>{this.hooks.get(n)?.delete(o)}},provide:(n,i)=>{const o=typeof n=="symbol"?n:Symbol.for(`${this.instanceId}:${e.name}:${String(n)}`);this.serviceContainer.provide(o,i)},inject:n=>{const i=typeof n=="symbol"?n:Symbol.for(`${this.instanceId}:${e.name}:${String(n)}`);return this.serviceContainer.inject(i)},emit:(n,i)=>{this.emit(n,i)},listen:(n,i)=>{const o=Symbol(`${e.name}:${n}`);return this.eventBus.has(n)||this.eventBus.set(n,new Map),this.eventBus.get(n).set(o,i),s.set(n,o),()=>{this.eventBus.get(n)?.delete(o)}},getScopedStore:()=>this._createStore(e.name),getSessionEngine:()=>this.sessionEngine,getCurrentNodeId:()=>this.currentNodeId,getOwnerNodeId:()=>this.ownerNodeId,_cleanup:()=>{t.forEach((n,i)=>this.hooks.get(i)?.delete(n)),s.forEach((n,i)=>this.eventBus.get(i)?.delete(n)),t.clear(),s.clear()}}}_createStore(e){const t=`${this.instanceId}:${e}`;return this.sessionEngine&&this.currentNodeId?new Jn(this.sessionEngine,this.currentNodeId,e):this.dataAdapter?new Qn(this.dataAdapter,t):(this.instanceStores.has(e)||this.instanceStores.set(e,new Kn),this.instanceStores.get(e))}register(e){if(this.plugins.has(e.name))return;const t=this.createContextFor(e);this.plugins.set(e.name,{plugin:e,context:t}),e.install(t)}unregister(e){const t=this.plugins.get(e);if(!t)return;const{plugin:s,context:n}=t;s.destroy?.(),n._cleanup?.(),this.instanceStores.get(e)?.clear?.(),this.instanceStores.delete(e),this.plugins.delete(e)}executeTransformHook(e,t){const s=this.hooks.get(e);if(!s)return t;let n=t;for(const i of s.values()){const o=i(n);o!==void 0&&(n=o)}return n}executeActionHook(e,t){this.hooks.get(e)?.forEach(n=>n(t))}async executeHookAsync(e,t){const s=this.hooks.get(e);if(s)for(const n of s.values())await n(t)}emit(e,t){this.eventBus.get(e)?.forEach(n=>n(t))}listen(e,t){const s=Symbol(`external-listener:${e}`);return this.eventBus.has(e)||this.eventBus.set(e,new Map),this.eventBus.get(e).set(s,t),()=>{this.eventBus.get(e)?.delete(s)}}getCommand(e){return this.commands.get(e)}getCommands(){return this.commands}getToolbarButtons(){return this.toolbarButtons}getTitleBarButtons(){return this.titleBarButtons}setNodeId(e){this.ownerNodeId===this.currentNodeId&&(this.ownerNodeId=null),this.currentNodeId=e,this.ownerNodeId||(this.ownerNodeId=e)}setSessionEngine(e){this.sessionEngine=e}destroy(){Array.from(this.plugins.keys()).forEach(e=>this.unregister(e)),this.hooks.clear(),this.eventBus.clear(),this.serviceContainer.clear(),this.instanceStores.clear(),this.codemirrorExtensions=[],this.commands.clear(),this.toolbarButtons=[],this.titleBarButtons=[]}getInstanceId(){return this.instanceId}};class Pt{pluginManager;renderRoot=null;searchMarkClass;markedExtensions=[];instanceId;constructor(e={}){this.searchMarkClass=e.searchMarkClass||"mdx-editor-search-highlight",this.instanceId=`renderer-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,this.pluginManager=new Yn(this);const t=e.sessionEngine,s=e.nodeId,n=e.ownerNodeId??e.nodeId;this.pluginManager.setContext(s,n,t),e.persistenceAdapter&&this.pluginManager.setDataAdapter(e.persistenceAdapter)}use(e,...t){const s=new e(...t);return this.pluginManager.register(s),this}usePlugin(e){return this.pluginManager.register(e),this}getInstanceId(){return this.instanceId}setEditorInstance(e){this.pluginManager.editorInstance=e}configureMarked(e,t){const s={heading(n,i){const a=`heading-${It(n)}`;return`<h${i} id="${a}">${n}</h${i}>`}};e.use({renderer:s}),this.markedExtensions.length>0&&e.use(...this.markedExtensions),t.markedOptions&&e.use(t.markedOptions)}async render(e,t,s={}){this.renderRoot=e,e.classList.add("mdx-editor-renderer");const n=this.pluginManager.executeTransformHook("beforeParse",{markdown:t,options:s}),i=new St;this.configureMarked(i,s);let o=await i.parse(n.markdown);const a=this.pluginManager.executeTransformHook("afterRender",{html:o,options:s});e.innerHTML=a.html,await this.pluginManager.executeHookAsync("domUpdated",{element:e,options:s,renderer:this})}search(e){if(!this.renderRoot||!e)return[];this.clearSearch();const t=[],s=document.createTreeWalker(this.renderRoot,NodeFilter.SHOW_TEXT,null),n=new RegExp(e,"gi");let i;for(;i=s.nextNode();){const o=i,a=o.textContent||"";if(n.test(a)){const r=o.parentElement;if(!r)continue;const c=document.createElement("span");c.className=this.searchMarkClass,c.innerHTML=a.replace(n,d=>`<mark>${d}</mark>`),r.replaceChild(c,o),t.push(c)}}return t}gotoMatch(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add(`${this.searchMarkClass}--active`)}clearSearch(){if(!this.renderRoot)return;this.renderRoot.querySelectorAll(`.${this.searchMarkClass}`).forEach(t=>{const s=t.parentElement;s&&s.replaceChild(document.createTextNode(t.textContent||""),t)})}getPluginManager(){return this.pluginManager}destroy(){this.clearSearch(),this.pluginManager.destroy(),this.renderRoot&&this.renderRoot.classList.remove("mdx-editor-renderer"),this.renderRoot=null,this.markedExtensions=[]}}const Xn=`
/* ============================================
   ROOT & TYPOGRAPHY
   ============================================ */

.mdx-print {
    font-family: 
        -apple-system, 
        BlinkMacSystemFont, 
        "Segoe UI", 
        Roboto, 
        "Helvetica Neue", 
        Arial, 
        /* ✅ 添加中文字体支持 */
        "PingFang SC",           /* macOS 中文 */
        "Hiragino Sans GB",      /* macOS 中文备选 */
        "Microsoft YaHei",       /* Windows 中文 */
        "WenQuanYi Micro Hei",   /* Linux 中文 */
        "Noto Sans SC",          /* Google 中文字体 */
        sans-serif,
        "Apple Color Emoji", 
        "Segoe UI Emoji", 
        "Segoe UI Symbol";
    font-size: 14px;
    line-height: 1.8;  /* ✅ 中文适当增加行高 */
    color: #24292f;
    background: #ffffff;
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    
    /* ✅ 确保文本渲染正常 */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

.mdx-print * {
    box-sizing: border-box;
}

/* ============================================
   HEADER
   ============================================ */

.mdx-print-header {
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e0e0e0;
}

.mdx-print-header__title {
    margin: 0;
    font-size: 1.75em;
    font-weight: 600;
    color: #24292f;
}

.mdx-print-header__meta {
    margin: 8px 0 0;
    font-size: 0.875em;
    color: #656d76;
}

.mdx-print-header__meta-item {
    display: inline;
}

.mdx-print-header__meta-item:not(:last-child)::after {
    content: " · ";
    color: #d0d7de;
}

/* ============================================
   HEADINGS
   ============================================ */

.mdx-print h1,
.mdx-print h2,
.mdx-print h3,
.mdx-print h4,
.mdx-print h5,
.mdx-print h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}

.mdx-print h1 {
    font-size: 2em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #d8dee4;
}

.mdx-print h2 {
    font-size: 1.5em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #d8dee4;
}

.mdx-print h3 { font-size: 1.25em; }
.mdx-print h4 { font-size: 1em; }
.mdx-print h5 { font-size: 0.875em; }
.mdx-print h6 { font-size: 0.85em; color: #656d76; }

/* ============================================
   PARAGRAPHS & INLINE ELEMENTS
   ============================================ */

.mdx-print p { margin: 0 0 16px; }
.mdx-print strong { font-weight: 600; }
.mdx-print em { font-style: italic; }

.mdx-print a {
    color: #0969da;
    text-decoration: none;
}

.mdx-print mark {
    background-color: #fff8c5;
    padding: 0.1em 0.2em;
    border-radius: 2px;
}

.mdx-print del {
    text-decoration: line-through;
    color: #656d76;
}

/* ============================================
   LISTS
   ============================================ */

.mdx-print ul,
.mdx-print ol {
    margin: 0 0 16px;
    padding-left: 2em;
}

.mdx-print li { margin: 0.25em 0; }
.mdx-print li > p { margin: 0; }

/* ============================================
   CODE
   ============================================ */

.mdx-print code {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.875em;
    background-color: rgba(175, 184, 193, 0.2);
    border-radius: 6px;
    padding: 0.2em 0.4em;
}

.mdx-print pre {
    margin: 0 0 16px;
    padding: 16px;
    overflow-x: auto;
    font-size: 0.875em;
    line-height: 1.45;
    background-color: #f6f8fa;
    border: 1px solid #d0d7de;
    border-radius: 6px;
}

.mdx-print pre code {
    background: transparent;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
}

/* ============================================
   TABLE
   ============================================ */

.mdx-print table {
    border-collapse: collapse;
    width: 100%;
    margin: 0 0 16px;
}

.mdx-print th,
.mdx-print td {
    padding: 6px 13px;
    border: 1px solid #d0d7de;
    text-align: left;
}

.mdx-print th {
    font-weight: 600;
    background-color: #f6f8fa;
}

.mdx-print tr:nth-child(2n) {
    background-color: #f6f8fa;
}

/* ============================================
   BLOCKQUOTE
   ============================================ */

.mdx-print blockquote {
    margin: 0 0 16px;
    padding: 0 1em;
    color: #656d76;
    border-left: 0.25em solid #d0d7de;
}

/* ============================================
   HORIZONTAL RULE
   ============================================ */

.mdx-print hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #d0d7de;
    border: 0;
}

/* ============================================
   IMAGES
   ============================================ */

.mdx-print img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 16px 0;
}

/* ============================================
   CALLOUT / ADMONITION
   ============================================ */

.mdx-print-callout {
    margin: 16px 0;
    padding: 16px;
    border-radius: 6px;
    border-left: 4px solid;
}

.mdx-print-callout--note {
    border-left-color: #0969da;
    background-color: #ddf4ff;
}

.mdx-print-callout--warning {
    border-left-color: #9a6700;
    background-color: #fff8c5;
}

.mdx-print-callout--danger {
    border-left-color: #cf222e;
    background-color: #ffebe9;
}

.mdx-print-callout--tip {
    border-left-color: #1a7f37;
    background-color: #dafbe1;
}

/* ============================================
   LLM CONVERSATION - MESSAGE
   ============================================ */

.mdx-print-message {
    margin: 16px 0;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid;
}

.mdx-print-message__header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.mdx-print-message__avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    margin-right: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.mdx-print-message__role {
    font-size: 0.8125em;
    font-weight: 600;
    text-transform: uppercase;
}

.mdx-print-message--user {
    background-color: #ddf4ff;
    border-color: #54aeff;
    margin-left: 10%;
}

.mdx-print-message--user .mdx-print-message__avatar {
    background-color: #0969da;
    color: #ffffff;
}

.mdx-print-message--assistant {
    background-color: #f6f8fa;
    border-color: #d0d7de;
    margin-right: 10%;
}

.mdx-print-message--assistant .mdx-print-message__avatar {
    background-color: #8250df;
    color: #ffffff;
}

.mdx-print-message--system {
    background-color: #fff8c5;
    border-color: #d4a72c;
    font-style: italic;
}

/* ============================================
   LLM CONVERSATION - SESSION DIVIDER
   ============================================ */

.mdx-print-session {
    position: relative;
    margin: 32px 0;
    text-align: center;
}

.mdx-print-session__line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    border-top: 2px dashed #d0d7de;
}

.mdx-print-session__label {
    position: relative;
    display: inline-block;
    padding: 4px 16px;
    background-color: #ffffff;
    font-size: 0.75em;
    font-weight: 500;
    color: #656d76;
    text-transform: uppercase;
}

/* ============================================
   PRINT-SPECIFIC STYLES
   ============================================ */

@media print {
    .mdx-print {
        max-width: none;
        padding: 0;
        font-size: 12pt;
    }

    .mdx-print,
    .mdx-print * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .mdx-print a {
        color: inherit;
        text-decoration: underline;
    }

    .mdx-print a[href]::after {
        content: none !important;
    }

    .mdx-print h1,
    .mdx-print h2,
    .mdx-print h3 {
        page-break-after: avoid;
        break-after: avoid;
    }

    .mdx-print pre,
    .mdx-print blockquote,
    .mdx-print table,
    .mdx-print img,
    .mdx-print-message {
        page-break-inside: avoid;
        break-inside: avoid;
    }

    .mdx-print p,
    .mdx-print li {
        orphans: 3;
        widows: 3;
    }

    .mdx-print-message--user,
    .mdx-print-message--assistant {
        margin-left: 0;
        margin-right: 0;
    }
}

@page {
    margin: 20mm 15mm;
    size: A4;
}

/* ============================================
   UTILITY CLASSES
   ============================================ */

.mdx-print--compact {
    font-size: 12px;
    line-height: 1.5;
}

.mdx-print--no-header .mdx-print-header {
    display: none;
}
`;class Ot{renderer=null;sessionEngine;nodeId;constructor(e,t){this.sessionEngine=e,this.nodeId=t}getRenderer(){return this.renderer||(this.renderer=new Pt({sessionEngine:this.sessionEngine,nodeId:this.nodeId})),this.renderer}getStyles(e){let t=Xn;if(e.pageSize&&e.pageSize!=="A4"&&(t+=`
@page { size: ${e.pageSize}; }`),e.styles){const s=Array.isArray(e.styles)?e.styles.join(`
`):e.styles;t+=`
/* Custom Styles */
`+s}return t}buildHeader(e){if(!e.showHeader)return"";const t=e.title||"Untitled Document",s=e.headerMeta||{};let n="";return s.author&&(n+=`<span class="mdx-print-header__meta-item">${this.escapeHtml(s.author)}</span>`),s.date?n+=`<span class="mdx-print-header__meta-item">${this.escapeHtml(s.date)}</span>`:n+=`<span class="mdx-print-header__meta-item">${new Date().toLocaleDateString()}</span>`,s.version&&(n+=`<span class="mdx-print-header__meta-item">v${this.escapeHtml(s.version)}</span>`),`
            <header class="mdx-print-header">
                <h1 class="mdx-print-header__title">${this.escapeHtml(t)}</h1>
                ${n?`<div class="mdx-print-header__meta">${n}</div>`:""}
            </header>
        `}async renderForPrint(e,t={}){const s=this.getRenderer(),n=document.createElement("div");n.style.cssText="position:absolute;left:-9999px;visibility:hidden;",document.body.appendChild(n);try{await s.render(n,e);let i=n.innerHTML;return t.beforePrint&&(i=t.beforePrint(i)),i}finally{document.body.removeChild(n)}}async print(e,t={}){const s=await this.renderForPrint(e,t);await this.printFromHtml(s,t)}async printFromHtml(e,t={}){const s=t.title||"Print",n=this.getStyles(t),i=this.buildHeader(t),o=t.variant==="compact"?"mdx-print--compact":"",a=t.showHeader===!1?"mdx-print--no-header":"",r=window.open("","_blank");if(!r)throw new Error("Failed to open print window. Please check popup blocker settings.");const c=`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.escapeHtml(s)}</title>
    <style>${n}</style>
</head>
<body>
    <article class="mdx-print ${o} ${a}">
        ${i}
        <main class="mdx-print-content">
            ${e}
        </main>
    </article>
</body>
</html>`;r.document.write(c),r.document.close(),await this.waitForResources(r),r.focus(),r.print(),t.autoClose&&setTimeout(()=>r.close(),1e3)}waitForResources(e){return new Promise(t=>{e.document.readyState==="complete"?setTimeout(t,500):e.addEventListener("load",()=>setTimeout(t,500))})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){this.renderer&&(this.renderer.destroy(),this.renderer=null)}}class Xe extends Ot{static LLM_STYLES=`
        .mdx-print-message { page-break-inside: avoid; }
        .mdx-print-message + .mdx-print-message { margin-top: 12px; }
    `;async renderForPrint(e,t={}){const s=this.preprocessConversation(e);return super.renderForPrint(s,{...t,styles:[Xe.LLM_STYLES,...Array.isArray(t.styles)?t.styles:t.styles?[t.styles]:[]]})}preprocessConversation(e){const t=e.split(`
`),s=[];let n=null,i=[];const o=()=>{if(n&&i.length>0){const a=i.join(`
`).trim();if(a){const r=this.getRoleIcon(n),c=this.getRoleLabel(n);s.push(`<div class="mdx-print-message mdx-print-message--${n}">`),s.push('  <div class="mdx-print-message__header">'),s.push(`    <span class="mdx-print-message__avatar">${r}</span>`),s.push(`    <span class="mdx-print-message__role">${c}</span>`),s.push("  </div>"),s.push(`  <div class="mdx-print-message__content">

${a}

</div>`),s.push("</div>")}i=[]}};for(const a of t){const r=a.match(/^##\s*User\s*$/i)||a.match(/^>\s*\*\*User\*\*/i),c=a.match(/^##\s*Assistant\s*$/i)||a.match(/^>\s*\*\*Assistant\*\*/i),d=a.match(/^##\s*System\s*$/i)||a.match(/^>\s*\*\*System\*\*/i),h=a.match(/^---+$/);r?(o(),n="user"):c?(o(),n="assistant"):d?(o(),n="system"):h?(o(),n=null,s.push('<div class="mdx-print-session">'),s.push('  <div class="mdx-print-session__line"></div>'),s.push('  <span class="mdx-print-session__label">New Session</span>'),s.push("</div>")):n?i.push(a):s.push(a)}return o(),s.join(`
`)}getRoleIcon(e){switch(e){case"user":return"👤";case"assistant":return"🤖";case"system":return"⚙️";default:return"💬"}}getRoleLabel(e){switch(e){case"user":return"User";case"assistant":return"Assistant";case"system":return"System";default:return e}}}class Zn extends Ge{renderer;editorView=null;_container=null;editorContainer=null;renderContainer=null;currentMode;config;cleanupListeners=[];eventEmitter=new Map;readOnlyCompartment=new rt;searchCompartment=new rt;isDestroying=!1;_isDirty=!1;printService=null;currentSavePromise=null;renderPromise=Promise.resolve();constructor(e={}){super(),this.config=e,this.config.ownerNodeId=e.ownerNodeId??e.nodeId,this.currentMode=e.initialMode||"edit",this.renderer=new Pt({searchMarkClass:e.searchMarkClass,nodeId:e.nodeId,ownerNodeId:this.config.ownerNodeId,persistenceAdapter:e.persistenceAdapter,sessionEngine:e.sessionEngine}),this.renderer.setEditorInstance(this)}async init(e,t=""){this._container=e,this.createContainers(e),this._isDirty=!1,await new Promise(i=>setTimeout(i,10)),this.initCodeMirror(t);const s=this.config.initialMode||"edit";this.currentMode=s;const n=s==="edit";this._container.classList.toggle("is-edit-mode",n),this._container.classList.toggle("is-render-mode",!n),this.editorContainer.style.display=n?"flex":"none",this.renderContainer.style.display=n?"none":"block",n||await this.renderContent(),this.listenToPluginEvents(),this.renderer.getPluginManager().executeActionHook("editorPostInit",{editor:this,pluginManager:this.renderer.getPluginManager()}),this.config.title&&this.setTitle(this.config.title),this.emit("ready")}use(e){return this.renderer.usePlugin(e),this}getPrintService(){return this.printService||(this.printService=new Ot(this.config.sessionEngine,this.config.nodeId)),this.printService}async print(e){this.currentMode==="edit"&&this.renderContainer&&await this.renderContent();const t=this.renderContainer?.innerHTML||"";if(!t.trim()){console.warn("[MDxEditor] No content to print");return}await this.getPrintService().printFromHtml(t,{title:this.config.title,showHeader:!0,...e})}async getHtmlForPrint(e){const t=this.getText();return await this.getPrintService().renderForPrint(t,{title:this.config.title,...e})}createContainers(e){e.innerHTML="",e.className="mdx-editor-root-container mdx-editor-container",this.editorContainer=document.createElement("div"),this.editorContainer.className="mdx-editor-container__edit-mode",e.appendChild(this.editorContainer),this.renderContainer=document.createElement("div"),this.renderContainer.className="mdx-editor-container__render-mode",this.renderContainer.tabIndex=-1,e.appendChild(this.renderContainer)}initCodeMirror(e){if(!this.editorContainer)return;const t=[...this.renderer.getPluginManager().codemirrorExtensions,Et(),this.readOnlyCompartment.of(Z.editable.of(!0)),this.searchCompartment.of([]),Z.domEventHandlers({blur:(s,n)=>{this.emit("blur")},focus:(s,n)=>{this.emit("focus")}}),Z.updateListener.of(s=>{s.docChanged&&(this.emit("change"),s.transactions.some(n=>n.isUserEvent("input")||n.isUserEvent("delete")||n.isUserEvent("paste")||n.isUserEvent("drop"))&&(this.setDirty(!0),this.emit("interactiveChange")))})];this.editorView=new Z({state:xt.create({doc:e,extensions:t}),parent:this.editorContainer})}listenToPluginEvents(){const e=this.renderer.getPluginManager().listen("taskToggled",t=>{t.wasUpdated&&t.updatedMarkdown!==this.getText()&&(this.setText(t.updatedMarkdown),this.setDirty(!0),this.emit("interactiveChange"),this.emit("optimisticUpdate"))});this.cleanupListeners.push(e)}async switchToMode(e,t=!1){if(this.currentMode===e&&!t||!this._container||!this.editorContainer||!this.renderContainer)return;this.currentMode==="edit"&&e==="render"&&this.isDirty()&&await this.save(),this.currentMode=e;const s=e==="edit";this._container.classList.toggle("is-edit-mode",s),this._container.classList.toggle("is-render-mode",!s),this.editorContainer.style.display=s?"flex":"none",this.renderContainer.style.display=s?"none":"block",!s&&!t&&await this.renderContent(),this.renderer.getPluginManager().emit("modeChanged",{mode:e}),this.emit("modeChanged",{mode:e})}async renderContent(){this.renderContainer&&await this.renderer.render(this.renderContainer,this.getText())}get commands(){const e=this.renderer.getPluginManager().getCommands(),t={};return e.forEach((s,n)=>{t[n]=s}),Object.freeze(t)}getText(){return this.editorView?this.editorView.state.doc.toString():""}setText(e){this.editorView&&e!==this.getText()&&(this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e}}),this.setDirty(!1),this.currentMode==="render"&&this.renderContent().catch(console.error))}async setStreamingText(e){this.editorView&&e!==this.getText()&&(this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:e}}),this.setDirty(!1)),this.currentMode==="render"&&(this.renderPromise=this.renderPromise.then(async()=>{try{await this.renderContent()}catch(t){console.error("[MDxEditor] Streaming render failed:",t)}}),await this.renderPromise)}getMode(){return this.currentMode}isDirty(){return this._isDirty}setDirty(e){this._isDirty=e}async save(){const e=this.config.onSave;if(e){if(this.currentSavePromise)return this.currentSavePromise;if(this.isDirty())return this.currentSavePromise=(async()=>{try{const t=this.getText();await e(t),this.setDirty(!1),this.emit("saved")}catch(t){console.error("[MDxEditor] Save failed:",t),this.emit("saveError",t)}finally{this.currentSavePromise=null}})(),this.currentSavePromise}}async getHeadings(){const e=this.getText();return Te(e)?[]:Tt(e,{nested:!1})}async getSearchableText(){return Mt(this.getText())}async getSummary(){return kt(this.getText())}setTitle(e){this.renderer.getPluginManager().emit("setTitle",{title:e})}async navigateTo(e){if(this.currentMode==="render"&&this.renderContainer)try{const t=this.renderContainer.querySelector(`#${CSS.escape(e.elementId)}`);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-pulse"),setTimeout(()=>t.classList.remove("highlight-pulse"),1500)):console.warn(`[MDxEditor] Target element not found: #${e.elementId}`)}catch(t){console.error("[MDxEditor] Navigation error:",t)}else console.warn("Navigation is only supported in render mode.")}setReadOnly(e){this.editorView&&this.editorView.dispatch({effects:this.readOnlyCompartment.reconfigure(Z.editable.of(!e))})}focus(){this.currentMode==="edit"&&this.editorView?this.editorView.focus():this.renderContainer&&this.renderContainer.focus()}async search(e){if(this.clearSearch(),!e)return[];if(this.currentMode==="edit"&&this.editorView){this.editorView.dispatch({effects:this.searchCompartment.reconfigure(ms({top:!0}))});const t=[],s=this.editorView.state.doc.toString(),n=new RegExp(e,"gi");for(const i of s.matchAll(n)){const o=i.index,a=o+i[0].length;t.push({source:"editor",text:i[0],context:this.editorView.state.doc.lineAt(o).text,details:{from:o,to:a}})}return t}else return this.renderer.search(e).map(s=>({source:"renderer",text:s.textContent||"",context:s.parentElement?.textContent?.substring(0,100)||"",details:{element:s}}))}gotoMatch(e){e.source==="editor"&&this.editorView&&e.details.from!==void 0?(this.editorView.dispatch({selection:{anchor:e.details.from,head:e.details.to},scrollIntoView:!0}),this.editorView.focus()):e.source==="renderer"&&e.details.element&&this.renderer.gotoMatch(e.details.element)}clearSearch(){this.currentMode==="edit"&&this.editorView?this.editorView.dispatch({effects:this.searchCompartment.reconfigure([])}):this.renderer.clearSearch()}async pruneAssets(){const e=this.renderer.getPluginManager().getCommand("pruneAssets");if(e)try{return await e(this)}catch(t){return console.error("[MDxEditor] Prune assets failed:",t),0}return console.warn("[MDxEditor] Prune capability not available (AssetResolverPlugin missing?)"),null}on(e,t){return this.eventEmitter.has(e)||this.eventEmitter.set(e,new Set),this.eventEmitter.get(e).add(t),()=>{this.eventEmitter.get(e)?.delete(t)}}emit(e,t){this.eventEmitter.get(e)?.forEach(s=>s(t))}async destroy(){if(!this.isDestroying){if(this.isDestroying=!0,this.currentSavePromise)try{await this.currentSavePromise}catch(e){console.warn("[MDxEditor] Pending save failed during destroy:",e)}this._isDirty&&await this.save(),this.printService&&(this.printService.destroy?.(),this.printService=null),this.editorView?.destroy(),this.renderer.destroy(),this.cleanupListeners.forEach(e=>e()),this.cleanupListeners=[],this.eventEmitter.clear(),this._container&&(this._container.innerHTML=""),this._container=null,this.editorContainer=null,this.renderContainer=null,this.isDestroying=!1}}getRenderer(){return this.renderer}getEditorView(){return this.editorView}get container(){return this._container}getRenderContainer(){return this.renderContainer}}class Ft{name="editor:core";options;cleanupFns=[];constructor(e={}){this.options={enableLineNumbers:e.enableLineNumbers??!1,enableHistory:e.enableHistory??!0,enableFolding:e.enableFolding??!0,enableAutocompletion:e.enableAutocompletion??!0,enableBracketMatching:e.enableBracketMatching??!0,enableCloseBrackets:e.enableCloseBrackets??!0,enableMultipleSelections:e.enableMultipleSelections??!0,enableRectangularSelection:e.enableRectangularSelection??!0,enableSelectionMatches:e.enableSelectionMatches??!0,additionalExtensions:e.additionalExtensions??[]}}buildCoreExtensions(){const e=[];this.options.enableLineNumbers&&e.push(fs(),ys()),e.push(vs()),this.options.enableHistory&&e.push(bs()),this.options.enableFolding&&e.push(ws()),e.push(Ss()),e.push(Es()),e.push(xs()),this.options.enableMultipleSelections&&e.push(xt.allowMultipleSelections.of(!0)),e.push(_s()),e.push(Is(Os,{fallback:!0})),this.options.enableBracketMatching&&e.push(Ts()),this.options.enableCloseBrackets&&e.push(Cs()),this.options.enableRectangularSelection&&e.push(ks(),Ms()),this.options.enableSelectionMatches&&e.push(Ns());const t=[ee.of(Ls),ee.of(As)];return this.options.enableHistory&&t.push(ee.of(Ds)),this.options.enableFolding&&t.push(ee.of($s)),this.options.enableCloseBrackets&&t.push(ee.of(Rs)),t.push(ee.of(Ps)),e.push(...t),e.push(Et()),e.push(Z.baseTheme({})),this.options.additionalExtensions.length>0&&e.push(...this.options.additionalExtensions),e}install(e){const t=this.buildCoreExtensions();e.registerCodeMirrorExtension?.(t),this.options.enableAutocompletion&&setTimeout(()=>{const n=e.pluginManager;n?this.registerAutocompletion(e,n):e.registerCodeMirrorExtension?.(Me())},0);const s=e.on("editorPostInit",this.onEditorInitialized.bind(this));s&&this.cleanupFns.push(s)}onEditorInitialized(e){}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}registerAutocompletion(e,t){const s=t._autocompleteSources||[];if(s.length===0){e.registerCodeMirrorExtension?.(Me());return}const n=this.createUnifiedCompletionSource(s),i=Me({override:[n],activateOnTyping:!0,defaultKeymap:!0,optionClass:()=>"",activateOnTypingDelay:0});e.registerCodeMirrorExtension?.(i)}createUnifiedCompletionSource(e){return async t=>{const{state:s,pos:n}=t,i=s.sliceDoc(0,n);for(const o of e){const{triggerChar:a,provider:r,applyTemplate:c,minQueryLength:d=0}=o,h=this.matchTrigger(i,a);if(!h)continue;const{start:u,query:p}=h;if(p.length<d)continue;const m=await r.getSuggestions(p);if(m.length===0)continue;const g=m.map(y=>{const b={label:y.label,type:y.type,apply:(E,k,F,B)=>{const v=c(y);E.dispatch({changes:{from:u,to:B,insert:v},selection:{anchor:u+v.length}})}};return y.detail&&(b.detail=y.detail),y.info&&(b.info=y.info),b});return{from:u,options:g,validFor:this.createValidForRegex(a),filter:!1}}return null}}createValidForRegex(e){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`^${t}[\\w\\u4e00-\\u9fa5-]*$`)}matchTrigger(e,t){const s=e.lastIndexOf(t);if(s===-1)return null;const n=e[s-1];if(n&&!/\s/.test(n)&&s>0)return null;const i=e.slice(s+t.length);return/\s/.test(i)?null:{start:s,query:i}}}function ei(l){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return l.replace(/[&<>"']/g,t=>e[t])}class ti{name="feature:foldable";options;cleanupFns=[];contextStates=new WeakMap;constructor(e={}){this.options={defaultOpen:e.defaultOpen!==!1,className:e.className||"mdx-editor-foldable",enableTaskCheckbox:!1}}getContextState(e){return this.contextStates.has(e)||this.contextStates.set(e,{storedBlocks:new Map,placeholderId:0}),this.contextStates.get(e)}generatePlaceholder(e){return`<!-- FOLDABLE_BLOCK_${e.placeholderId++} -->`}dedentContent(e){return e.split(`
`).map(t=>t.replace(/^[ \t]{0,4}/,"")).join(`
`).trim()}createBeforeParseHook(e){return({markdown:t,options:s})=>{const n=this.getContextState(e);n.storedBlocks.clear(),n.placeholderId=0;const i=/^::>\s*(?:\[([ xX])]\s*)?(.*)\n?((?:^[ \t]{4,}.*\n?|^\s*\n)*)/gm;return{markdown:t.replace(i,(a,r,c,d)=>{const h=this.generatePlaceholder(n);return n.storedBlocks.set(h,{checkmark:r||void 0,label:c.trim(),rawContent:d}),`

${h}

`}),options:s}}}createAfterRenderHook(e){return({html:t,options:s})=>{const n=this.getContextState(e);if(n.storedBlocks.size===0)return{html:t,options:s};const i=new St;let o=t;for(const[a,r]of n.storedBlocks){const c=this.dedentContent(r.rawContent),d=i.parse(c);let h=ei(r.label);if(this.options.enableTaskCheckbox&&r.checkmark){const g=r.checkmark.toLowerCase()==="x";h=`${`<input type="checkbox" class="${this.options.className}__task-checkbox" ${g?"checked":""}>`} ${h}`}const u=`<details class="${this.options.className}" ${this.options.defaultOpen?"open":""}>
  <summary class="${this.options.className}__summary">${h}</summary>
  <div class="${this.options.className}__content">
    ${d}
  </div>
</details>`,p=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=new RegExp(`<p>${p}</p>|${p}`,"g");o=o.replace(m,u)}return{html:o,options:s}}}install(e){const t=e.on("beforeParse",this.createBeforeParseHook(e));t&&this.cleanupFns.push(t);const s=e.on("afterRender",this.createAfterRenderHook(e));s&&this.cleanupFns.push(s);const n=e.on("domUpdated",({element:i})=>{this.setupInteractions(i)});n&&this.cleanupFns.push(n)}setupInteractions(e){e.querySelectorAll(`.${this.options.className}__task-checkbox`).forEach(s=>{const n=s._foldableClickHandler;n&&s.removeEventListener("click",n);const i=o=>{o.stopPropagation()};s.addEventListener("click",i),s._foldableClickHandler=i})}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class ie{static instance=null;isLoaded=!1;loadPromise=null;config;cdnUrl="";instanceCount=0;renderQueue=new Set;renderTimer=null;constructor(){}static getInstance(){return ie.instance||(ie.instance=new ie),ie.instance}registerInstance(e,t){this.instanceCount++,this.instanceCount===1?(this.config=e,this.cdnUrl=t):JSON.stringify(this.config)!==JSON.stringify(e)&&console.warn("MathJax config differs between instances. Using first config.")}unregisterInstance(){this.instanceCount--,this.instanceCount===0&&this.cleanup()}async load(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=new Promise((e,t)=>{if(window.MathJax?.typesetPromise){this.isLoaded=!0,e();return}window.MathJax=this.config;const s=document.createElement("script");s.src=this.cdnUrl,s.async=!0,s.id="mathjax-script",s.onload=()=>{this.isLoaded=!0,e()},s.onerror=()=>{this.loadPromise=null,t(new Error("Failed to load MathJax"))},document.head.appendChild(s)}),this.loadPromise)}queueRender(e){this.renderQueue.add(e),this.renderTimer&&clearTimeout(this.renderTimer),this.renderTimer=window.setTimeout(()=>{this.flushRenderQueue()},50)}async flushRenderQueue(){if(this.renderQueue.size!==0)try{if(await this.load(),window.MathJax?.startup?.promise&&await window.MathJax.startup.promise,window.MathJax?.typesetPromise){const e=Array.from(this.renderQueue);await window.MathJax.typesetPromise(e)}}catch(e){console.error("MathJax render error:",e)}finally{this.renderQueue.clear(),this.renderTimer=null}}async renderNow(e){try{await this.load(),window.MathJax?.startup?.promise&&await window.MathJax.startup.promise,window.MathJax?.typesetPromise&&await window.MathJax.typesetPromise([e])}catch(t){console.error("MathJax render error:",t)}}cleanup(){this.renderTimer&&(clearTimeout(this.renderTimer),this.renderTimer=null),this.renderQueue.clear()}}class si{name="feature:mathjax";options;manager;cleanupFns=[];constructor(e={}){this.options={cdnUrl:e.cdnUrl||"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js",config:{tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},...e.config},autoLoad:e.autoLoad!==!1},this.manager=ie.getInstance(),this.manager.registerInstance(this.options.config,this.options.cdnUrl)}createSyntaxExtension(){return{extensions:[{name:"math-display",level:"block",start:e=>e.match(/^\$\$/)?.index,tokenizer:e=>{const t=e.match(/^\$\$([\s\S]+?)\$\$/);if(t)return{type:"math-display",raw:t[0],text:t[1].trim()}},renderer:e=>`\\[${e.text}\\]`},{name:"math-inline",level:"inline",start:e=>e.match(/\$/)?.index,tokenizer:e=>{const t=e.match(/^\$([^\$\n]+?)\$/);if(t)return{type:"math-inline",raw:t[0],text:t[1].trim()}},renderer:e=>`\\(${e.text}\\)`}]}}install(e){e.registerSyntaxExtension(this.createSyntaxExtension()),this.options.autoLoad&&this.manager.load().catch(s=>{console.error("MathJax load error:",s)});const t=e.on("domUpdated",({element:s})=>{this.manager.queueRender(s)});t&&this.cleanupFns.push(t)}async typeset(e){await this.manager.renderNow(e)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.manager.unregisterInstance()}}function Se(l){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return l.replace(/[&<>"']/g,t=>e[t])}class ni{name="feature:media";options;cleanupFns=[];constructor(e={}){this.options={videoClassName:e.videoClassName||"mdx-editor-video",fileClassName:e.fileClassName||"mdx-editor-file",embedClassName:e.embedClassName||"mdx-editor-embed",videoControls:e.videoControls!==!1,videoAutoplay:e.videoAutoplay===!0,fileIconClass:e.fileIconClass||"fas fa-paperclip"}}install(e){const t=e.on("afterRender",this.handleAfterRender.bind(this));t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}handleAfterRender({html:e,options:t}){let s=e;const n=/<img\s+[^>]*src="([^"]+)"[^>]*alt="((?:video|file)\[.*?\])"[^>]*\/?>/gi;s=s.replace(n,(o,a,r)=>{const c=r.match(/^(video|file)\[(.*?)\]$/);if(!c)return o;const d=c[1],h=this.decodeHTML(c[2]);return d==="video"?this.renderVideo(a,h):d==="file"?this.renderFile(a,h):o});const i=/<img\s+[^>]*src="([^"]+)"[^>]*alt="embed"[^>]*\/?>/gi;return s=s.replace(i,(o,a)=>this.renderEmbed(a)),{html:s,options:t}}renderVideo(e,t){const s=Se(e),n=Se(t),i=this.options.videoControls?"controls":"",o=this.options.videoAutoplay?"autoplay":"";return`
      <div class="${this.options.videoClassName}">
        <video class="${this.options.videoClassName}__player" src="${s}" title="${n}" ${i} ${o}>
          您的浏览器不支持 HTML5 视频。
        </video>
        ${n?`<div class="${this.options.videoClassName}__title">${n}</div>`:""}
      </div>`}renderFile(e,t){const s=Se(e),n=Se(t);return`
      <a href="${s}" download="${n}" class="${this.options.fileClassName}" title="下载 ${n}" target="_blank" rel="noopener noreferrer">
        <i class="${this.options.fileIconClass}"></i>
        <span class="${this.options.fileClassName}__name">${n}</span>
      </a>`}renderEmbed(e){let t="",s="";const n=e.toLowerCase();if(n.endsWith(".pdf"))return s="mdx-embed-pdf",`
        <div class="${this.options.embedClassName} ${s}">
          <iframe src="${e}" frameborder="0" title="PDF Preview">
            <p>您的浏览器不支持 PDF 预览，<a href="${e}" target="_blank">点击下载</a>。</p>
          </iframe>
        </div>`;if(/\.(doc|docx|xls|xlsx|ppt|pptx)$/.test(n)){const i=decodeURIComponent(e.split("/").pop()||"Document");return this.renderFile(e,i)}else e.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/)?t=`https://www.youtube.com/embed/${RegExp.$1}`:e.match(/bilibili\.com\/video\/(BV[\w]+)/)&&(t=`https://player.bilibili.com/player.html?bvid=${RegExp.$1}&high_quality=1`);return t?`
        <div class="${this.options.embedClassName} ${s}">
          <iframe src="${t}" frameborder="0" allowfullscreen scrolling="no"></iframe>
        </div>`:`
      <a href="${e}" target="_blank" class="${this.options.fileClassName} mdx-embed-fallback">
        <i class="fas fa-external-link-alt"></i>
        <span class="${this.options.fileClassName}__name">打开外部链接: ${e}</span>
      </a>`}decodeHTML(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}}class oe{static instance=null;isLoaded=!1;loadPromise=null;config;cdnUrl="";instanceCount=0;renderQueues=new Map;renderTimers=new Map;constructor(){}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}registerInstance(e,t){this.instanceCount++,this.instanceCount===1?(this.config=e,this.cdnUrl=t):JSON.stringify(this.config)!==JSON.stringify(e)&&console.warn("Mermaid config differs between instances. Using first config.")}unregisterInstance(){this.instanceCount--,this.instanceCount===0&&this.cleanup()}async load(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=new Promise(async(e,t)=>{if(window.mermaid?.run){this.isLoaded=!0,e();return}try{const s=await import(this.cdnUrl);s.default&&(window.mermaid=s.default),window.mermaid?(window.mermaid.initialize(this.config),this.isLoaded=!0,e()):t(new Error("Mermaid module failed to load"))}catch(s){this.loadPromise=null,t(s)}}),this.loadPromise)}queueRender(e,t){this.renderQueues.has(e)||this.renderQueues.set(e,new Set);const s=this.renderQueues.get(e);t.forEach(o=>s.add(o));const n=this.renderTimers.get(e);n&&clearTimeout(n);const i=window.setTimeout(()=>{this.flushRenderQueue(e)},100);this.renderTimers.set(e,i)}async flushRenderQueue(e){const t=this.renderQueues.get(e);if(!(!t||t.size===0))try{if(await this.load(),window.mermaid?.run){const s=Array.from(t),n=`data-mermaid-instance-${e}`;s.forEach((a,r)=>{a.setAttribute(n,String(r))});const i=s.map((a,r)=>`[${n}="${r}"]`).join(","),o=document.querySelectorAll(i);await window.mermaid.run({nodes:o}),s.forEach(a=>{a.removeAttribute(n)})}}catch(s){console.error(`Mermaid render error for instance ${e}:`,s)}finally{t.clear(),this.renderTimers.delete(e)}}cleanup(){this.renderTimers.forEach(e=>clearTimeout(e)),this.renderTimers.clear(),this.renderQueues.clear()}}class ii{name="feature:mermaid";options;manager;cleanupFns=[];instanceId;constructor(e={}){this.options={cdnUrl:e.cdnUrl||"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs",theme:e.theme||"default",mermaidConfig:{startOnLoad:!1,theme:e.theme||"default",...e.mermaidConfig},autoLoad:e.autoLoad!==!1},this.instanceId=`${Date.now()}-${Math.random().toString(36).substring(2,11)}`,this.manager=oe.getInstance(),this.manager.registerInstance(this.options.mermaidConfig,this.options.cdnUrl)}install(e){this.options.autoLoad&&this.manager.load().catch(s=>{console.error("Mermaid load error:",s)});const t=e.on("domUpdated",async({element:s})=>{try{const n=s.querySelectorAll("pre code.language-mermaid");n.length>0&&this.manager.queueRender(this.instanceId,n)}catch(n){console.error("Mermaid plugin error:",n)}});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.manager.unregisterInstance()}}const oi={note:"Note",abstract:"Abstract",info:"Info",todo:"Todo",tip:"Tip",success:"Success",question:"Question",warning:"Warning",failure:"Failure",danger:"Danger",bug:"Bug",example:"Example",quote:"Quote"};class ai{name="syntax:callout";constructor(){}install(e){e.registerSyntaxExtension(this.getMarkedExtension())}getMarkedExtension(){return{walkTokens:e=>{if(e.type!=="blockquote")return;const t=e.tokens?.[0];if(!t||t.type!=="paragraph")return;const n=(t.text||"").match(/^\[!(\w+)\]([^\n]*)/i);if(n){const i=n[1].toLowerCase(),o=n[2].trim()||oi[i]||i.charAt(0).toUpperCase()+i.slice(1);e.type="callout",e.calloutType=i,e.calloutTitle=o;const r=t.text.replace(/^\[!(\w+)\][^\n]*/i,"").trim();t.text=r,!r&&e.tokens.length>1?e.tokens.shift():r||(t.text="")}},extensions:[{name:"callout",level:"block",renderer(e){const t=`mdx-callout-${e.calloutType}`,s=this.parser.parse(e.tokens);return`
            <div class="mdx-callout ${t}">
              <div class="mdx-callout-title">
                <span class="mdx-callout-icon"></span>
                <span class="mdx-callout-text">${e.calloutTitle}</span>
              </div>
              <div class="mdx-callout-content">
                ${s}
              </div>
            </div>
          `}}]}}}class ri{name="feature:plantuml";options;cleanupFns=[];constructor(e={}){this.options={serverUrl:e.serverUrl?.replace(/\/$/,"")||"https://www.plantuml.com/plantuml",format:e.format||"svg"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processPlantUML(s)});this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processPlantUML(e){e.querySelectorAll("pre code.language-plantuml, pre code.language-puml").forEach(s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"";if(!i.trim())return;const o=this.encodePlantUML(i.trim()),a=`${this.options.serverUrl}/${this.options.format}/~h${o}`,r=document.createElement("div");r.className="mdx-plantuml-container";const c=document.createElement("img");c.src=a,c.alt="PlantUML Diagram",c.loading="lazy",c.onerror=()=>{r.innerHTML='<div class="mdx-plantuml-error">PlantUML load failed</div>',r.appendChild(n)},r.appendChild(c),n.replaceWith(r)})}encodePlantUML(e){let t="";const s=new TextEncoder().encode(e);for(let n=0;n<s.length;n++)t+=s[n].toString(16).padStart(2,"0");return t}}function ce(l,e){const{state:t,dispatch:s}=l,{from:n,to:i}=t.selection.main,o=t.sliceDoc(n,i),a=t.sliceDoc(Math.max(0,n-e.length),n),r=t.sliceDoc(i,Math.min(t.doc.length,i+e.length));return s(a===e&&r===e?{changes:[{from:n-e.length,to:n,insert:""},{from:i,to:i+e.length,insert:""}]}:{changes:{from:n,to:i,insert:`${e}${o}${e}`},selection:{anchor:n+e.length,head:i+e.length}}),l.focus(),!0}const Bt=l=>ce(l,"**"),Ut=l=>ce(l,"*"),Ht=l=>ce(l,"~~"),zt=l=>ce(l,"`"),qt=l=>ce(l,"==");function jt(l){const{from:e,to:t}=l.state.selection.main,s=l.state.doc,n=s.toString(),i=/--.*?--/gd;for(const h of n.matchAll(i)){const u=h.indices?.[0]?.[0],p=h.indices?.[0]?.[1];if(!(u===void 0||p===void 0)&&e>=u+2&&t<=p-2){const g=h[0].substring(2,h[0].length-2).replace(/(\s*\[[^\]]*\]\s*)?(\^\^.*?\^\^)?$/,"");return l.dispatch({changes:{from:u,to:p,insert:g},selection:{anchor:u,head:u+g.length}}),l.focus(),!0}}let o=e,a=t;for(const h of n.matchAll(i)){const u=h.indices?.[0]?.[0],p=h.indices?.[0]?.[1];if(u===void 0||p===void 0)continue;(o>=u&&o<=p||a>=u&&a<=p||o<=u&&a>=p||s.sliceString(p,o).trim()===""&&p<=o||s.sliceString(a,u).trim()===""&&a<=u)&&(o=Math.min(o,u),a=Math.max(a,p))}const r=s.sliceString(o,a).replace(/--/g,"");if(!r.trim())return l.focus(),!0;const d=`--[${`c${Date.now()}`}] ${r.trim()}--`;return l.dispatch({changes:{from:o,to:a,insert:d},selection:{anchor:o+2,head:o+d.length-2}}),l.focus(),!0}function Vt(l){const{state:e}=l,{from:t,to:s}=e.selection.main;if(t===s)return alert("请先选择要制作成 Cloze 的文本。"),!1;const n=e.doc.sliceString(t,s),i=prompt("请输入音频提示文本:",n);if(i===null)return!1;const o=`--${n}--^^audio:${i.trim()}^^`;return l.dispatch({changes:{from:t,to:s,insert:o}}),l.focus(),!0}function je(l){return l.dispatch({changes:{from:l.state.selection.main.from,insert:"¶"}}),l.focus(),!0}function ke(l,e){const{state:t}=l,{from:s,to:n}=t.selection.main,i=t.doc.lineAt(s),o=t.doc.lineAt(n);let a=[],r=!0;for(let c=i.number;c<=o.number;c++){const d=t.doc.line(c);if(d.length>0&&!d.text.trimStart().startsWith(e)){r=!1;break}}for(let c=i.number;c<=o.number;c++){const d=t.doc.line(c);r?d.text.includes(e)&&a.push({from:d.from+d.text.indexOf(e),to:d.from+d.text.indexOf(e)+e.length,insert:""}):d.length>0&&!d.text.trimStart().startsWith(e)&&a.push({from:d.from,insert:e})}return a.length>0&&l.dispatch({changes:a}),l.focus(),!0}const Wt=l=>ke(l,"- "),Gt=l=>ke(l,"1. "),Jt=l=>ke(l,"- [ ] "),Qt=l=>ke(l,"> "),Kt=l=>{const{from:e}=l.state.selection.main,t=l.state.doc.lineAt(e),s=t.text;let n;return s.startsWith("## ")?n={from:t.from,to:t.from+3,insert:"### "}:s.startsWith("### ")?n={from:t.from,to:t.from+4,insert:""}:n={from:t.from,insert:"## "},l.dispatch({changes:[n]}),l.focus(),!0};function Yt(l){const{from:e}=l.state.selection.main,t=l.state.doc.lineAt(e),s=t.to,n=t.length>0?`

---
`:`
---
`;return l.dispatch({changes:{from:s,insert:n},selection:_t.cursor(s+n.length)}),l.focus(),!0}function Xt(l){const e=prompt("行数：","3"),t=prompt("列数：","3");if(!e||!t)return!1;const s=parseInt(e,10),n=parseInt(t,10);if(isNaN(s)||isNaN(n)||s<1||n<1)return alert("请输入有效的行数和列数。"),!1;let i=`
| ${Array(n).fill("标题").join(" | ")} |
`;i+=`| ${Array(n).fill("---").join(" | ")} |
`;for(let o=0;o<s-1;o++)i+=`| ${Array(n).fill("单元格").join(" | ")} |
`;return l.dispatch({changes:{from:l.state.selection.main.from,insert:i}}),l.focus(),!0}function Zt(l){const e=prompt("编程语言 (可选):",""),{state:t}=l,{from:s,to:n}=t.selection.main,i=t.sliceDoc(s,n)||"代码",o=`\`\`\`${e||""}
${i}
\`\`\``;return l.dispatch({changes:{from:s,to:n,insert:o},selection:_t.cursor(s+4+(e?.length||0))}),l.focus(),!0}function es(l){const e=prompt("请输入链接 URL:","https://");if(!e)return!1;const{state:t}=l,{from:s,to:n}=t.selection.main,o=t.sliceDoc(s,n)||"链接文本",a=`[${o}](${e})`;return l.dispatch({changes:{from:s,to:n,insert:a},selection:{anchor:s+1,head:s+1+o.length}}),l.focus(),!0}function ts(l){const e=prompt("请输入图片 URL:","https://");if(!e)return!1;const{state:t}=l,{from:s,to:n}=t.selection.main,o=`![${t.sliceDoc(s,n)||"图片描述"}](${e})`;return l.dispatch({changes:{from:s,to:n,insert:o}}),l.focus(),!0}function li(l,e){if(typeof e!="function")return console.warn("AI callback is not a function."),!1;const{from:t,to:s}=l.state.selection.main,n=l.state.doc.sliceString(t,s),i=n.length>0?n:l.state.doc.toString();return e(i),l.focus(),!0}function ci(l,e){if(typeof e!="function")return console.warn("Save callback is not a function."),!1;const t=l.state.doc.toString();return e(t),l.focus(),!0}async function di(l){let e=document.getElementById("mdx-print-container");e||(e=document.createElement("div"),e.id="mdx-print-container",e.className="rich-content-area",document.body.appendChild(e));try{if(l.getMode()==="render"){const t=l.getRenderContainer();t&&(e.innerHTML=t.innerHTML)}else{const t=l.getText();await l.getRenderer().render(e,t,{areAllClozesVisible:!0})}document.body.classList.add("mdx-printing"),window.print()}catch(t){return console.error("Printing failed:",t),!1}finally{if(document.body.classList.remove("mdx-printing"),e&&(e.innerHTML=""),l.getMode()==="edit"){const t=l.getEditorView();t&&t.focus()}}return!0}const hi=Object.freeze(Object.defineProperty({__proto__:null,applyAudioCloze:Vt,applyBold:Bt,applyCloze:jt,applyCodeBlock:Zt,applyHighlight:qt,applyInlineCode:zt,applyItalic:Ut,applyLink:es,applyMarkdownFormatting:ce,applyStrikethrough:Ht,handleAIAction:li,handlePrintAction:di,handleSaveAction:ci,insertHorizontalRule:Yt,insertImage:ts,insertLinebreak:je,insertTable:Xt,toggleBlockquote:Qt,toggleHeading:Kt,toggleOrderedList:Gt,toggleTaskList:Jt,toggleUnorderedList:Wt},Symbol.toStringTag,{value:"Module"})),ss=Symbol("ClozeAPI");class ui{name="feature:cloze";options;cleanupFns=[];contextStates=new WeakMap;constructor(e={}){this.options={className:e.className||"mdx-cloze",audioIconClass:e.audioIconClass||"fas fa-volume-up"}}getContextState(e){return this.contextStates.has(e)||this.contextStates.set(e,{clozeCounter:0}),this.contextStates.get(e)}createBeforeParseHook(e){return t=>(this.getContextState(e).clozeCounter=0,t)}createSyntaxExtension(e){return{extensions:[{name:"cloze:cloze",level:"inline",start:t=>t.match(/--/)?.index,tokenizer:t=>{const s=this.getContextState(e),n=t.match(/^--(?:\[([^\]]+)\]\s*)?([\s\S]+?)--(?:\^\^audio:([^^]+)\^\^)?/);if(n)return{type:"cloze:cloze",raw:n[0],locator:n[1]||`auto-${s.clozeCounter++}`,content:n[2].trim(),audio:n[3]?.trim()}},renderer:t=>{const s=t.audio?`<span class="${this.options.className}__audio" data-audio-text="${this.escapeHtml(t.audio)}"><i class="${this.options.audioIconClass}"></i></span>`:"",n=this.escapeHtml(t.content),i=t.content.replace(/¶/g,"<br/>");return`<span class="${this.options.className} hidden" data-cloze-locator="${t.locator}" data-cloze-content="${n}">
              <span class="${this.options.className}__content">${i}</span><span class="${this.options.className}__placeholder">[...]</span>
              ${s}
            </span>`}}]}}escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}install(e){const t=e.on("beforeParse",this.createBeforeParseHook(e));if(t&&this.cleanupFns.push(t),e.registerSyntaxExtension(this.createSyntaxExtension(e)),e.provide(ss,()=>({toggleAll:(n,i)=>{(i||document).querySelectorAll(`.${this.options.className}`).forEach(r=>{n?r.classList.remove("hidden"):r.classList.add("hidden")})}})),!e.registerCommand||!e.registerToolbarButton)console.warn("ClozePlugin: Command registration is not available in this context.");else{const{registerCommand:n,registerToolbarButton:i}=e;i({id:`sep-cloze-${Date.now()}`,type:"separator"}),n("applyCloze",o=>o?jt(o):!1),i({id:"cloze",title:"挖空 (--text--)",icon:'<i class="fas fa-highlighter"></i>',command:"applyCloze"}),n("applyAudioCloze",o=>o?Vt(o):!1),i({id:"audioCloze",title:"音频挖空",icon:'<i class="fas fa-volume-up"></i>',command:"applyAudioCloze"}),n("insertLinebreak",o=>hi&&je?je(o):!1),i({id:"linebreak",title:"挖空内换行 (¶)",icon:'<i class="fas fa-paragraph"></i>',command:"insertLinebreak"})}const s=e.on("domUpdated",({element:n})=>{this.attachEventListeners(n,e)});s&&this.cleanupFns.push(s)}attachEventListeners(e,t){e.querySelectorAll(`.${this.options.className}`).forEach(n=>{const i=n._clozeClickHandler;i&&n.removeEventListener("click",i);const o=a=>{const r=a.target;if(r.closest(`.${this.options.className}__audio`)){const h=r.closest(`.${this.options.className}__audio`).getAttribute("data-audio-text");if(h&&"speechSynthesis"in window){a.stopPropagation();const u=new SpeechSynthesisUtterance(h);speechSynthesis.speak(u)}return}a.stopPropagation();const c=n.classList.contains("hidden");n.classList.toggle("hidden"),c&&t.emit("clozeRevealed",{element:n,clozeId:n.dataset.clozeLocator,content:n.dataset.clozeContent,hide:()=>{n.classList.add("hidden")},show:()=>{n.classList.remove("hidden")}})};n.addEventListener("click",o),n._clozeClickHandler=o})}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class pi{name="cloze:cloze-controls";options;cleanupFns=[];panel=null;container=null;currentIndex=0;isAllOpen=!1;isExpanded=!0;manuallyOpenedClozes=new Set;constructor(e={}){this.options={className:e.className||"mdx-cloze-controls"}}install(e){const t=e.inject(ss);if(!t){console.warn("ClozeControlsPlugin requires ClozePlugin to be installed.");return}const s=e.listen("clozeRevealed",i=>{const o=i.element.getAttribute("data-cloze-locator");o&&this.manuallyOpenedClozes.add(o)});s&&this.cleanupFns.push(s);const n=e.on("domUpdated",({element:i})=>{this.container=i,this.createPanel(e,t),this.updateAllClozeContent(),this.restoreOpenStates(t,e)});n&&this.cleanupFns.push(n)}restoreOpenStates(e,t){this.container&&(this.isAllOpen?(this.container.classList.add("is-global-override"),e().toggleAll(!0,this.container),setTimeout(()=>{t.emit("clozeBatchGradeToggle",{container:this.container})},50)):this.container.querySelectorAll(".mdx-cloze").forEach(n=>{const i=n.getAttribute("data-cloze-locator");i&&this.manuallyOpenedClozes.has(i)&&n.classList.remove("hidden")}))}createPanel(e,t){if(this.panel&&this.container&&!this.container.contains(this.panel)&&(this.panel.remove(),this.panel=null),this.panel)return;this.panel=document.createElement("div"),this.panel.className=this.options.className;const s=this.isAllOpen?"fa-eye-slash":"fa-eye",n=this.isExpanded?"fa-compress-alt":"fa-expand-alt";this.panel.innerHTML=`
      <div class="${this.options.className}__menu">
        <button class="${this.options.className}__btn" data-action="prev" title="上一个"><i class="fas fa-arrow-up"></i></button>
        <button class="${this.options.className}__btn" data-action="next" title="下一个"><i class="fas fa-arrow-down"></i></button>
        <button class="${this.options.className}__btn" data-action="toggle-expand" title="摘要/完整"><i class="fas ${n}"></i></button>
        <button class="${this.options.className}__btn" data-action="reverse" title="反转显示"><i class="fas fa-retweet"></i></button>
        <button class="${this.options.className}__btn" data-action="toggle-visible" title="全显/全隐"><i class="fas ${s}"></i></button>
      </div>
      <div class="${this.options.className}__toggle"><i class="fas fa-tools"></i></div>
    `,this.panel.addEventListener("click",i=>{const o=i.target.closest("button");if(!o||!this.container)return;const a=o.getAttribute("data-action"),r=o.querySelector("i");switch(a){case"prev":this.navigate(-1);break;case"next":this.navigate(1);break;case"toggle-expand":this.isExpanded=!this.isExpanded,r&&(r.className=this.isExpanded?"fas fa-compress-alt":"fas fa-expand-alt"),this.updateAllClozeContent();break;case"toggle-visible":this.isAllOpen=!this.isAllOpen,this.isAllOpen?(this.container.classList.add("is-global-override"),t().toggleAll(!0,this.container),e.emit("clozeBatchGradeToggle",{container:this.container})):(this.container.classList.remove("is-global-override"),t().toggleAll(!1,this.container),this.manuallyOpenedClozes.clear()),r&&(r.className=this.isAllOpen?"fas fa-eye-slash":"fas fa-eye");break;case"reverse":this.container.classList.add("is-global-override"),this.container.querySelectorAll(".mdx-cloze").forEach(d=>{const h=d.classList.contains("hidden");d.classList.toggle("hidden");const u=d.getAttribute("data-cloze-locator");u&&(h?this.manuallyOpenedClozes.add(u):this.manuallyOpenedClozes.delete(u))}),e.emit("clozeBatchGradeToggle",{container:this.container});break}}),this.container?.appendChild(this.panel)}updateAllClozeContent(){if(!this.container)return;this.container.querySelectorAll(".mdx-cloze__content").forEach(t=>{const s=t.parentElement;if(!s)return;const n=s.getAttribute("data-cloze-content")||"";if(this.isExpanded)t.innerHTML=n.replace(/¶/g,"<br/>");else{let i=n.replace(/¶/g," ");i.length>100&&(i=i.substring(0,100)+"..."),t.innerText=i}})}navigate(e){if(!this.container)return;const t=Array.from(this.container.querySelectorAll(".mdx-cloze.hidden"));if(t.length===0)return;this.currentIndex=(this.currentIndex+e+t.length)%t.length;const s=t[this.currentIndex];s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("mdx-cloze--highlight"),setTimeout(()=>s.classList.remove("mdx-cloze--highlight"),1e3)}destroy(){this.panel&&this.panel.remove(),this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.panel=null,this.container=null,this.manuallyOpenedClozes.clear()}}class gi{name="cloze:memory";options;cleanupFns=[];clozeStatesCache=new WeakMap;storeRef=null;constructor(e={}){this.options={gradingTimeout:e.gradingTimeout||3e5,className:e.className||"mdx-memory",coolingPeriod:e.coolingPeriod||6e4,dangerThresholdDays:e.dangerThresholdDays||7,debug:e.debug??!1,hideBeforeDueHours:e.hideBeforeDueHours??12}}log(e,...t){this.options.debug}getCache(e){return this.clozeStatesCache.has(e)||this.clozeStatesCache.set(e,new Map),this.clozeStatesCache.get(e)}install(e){this.storeRef=e.getScopedStore();const t=e.listen("clozeRevealed",i=>{if(i.element.dataset.stateClass==="is-cooling"){this.log("Card is cooling, skip grading panel",i.clozeId);return}const r=i.element.closest(".is-global-override")?0:this.options.gradingTimeout;this.showGradingPanel(i.element,e,r)});t&&this.cleanupFns.push(t);const s=e.listen("clozeBatchGradeToggle",i=>{this.showBatchGrading(e,i.container)});s&&this.cleanupFns.push(s);const n=e.on("domUpdated",async({element:i})=>{this.log("DOM updated, starting sync..."),await this.syncWithStore(e),this.applyVisualsAndState(i,e)});n&&this.cleanupFns.push(n)}async syncWithStore(e){const t=e.getSessionEngine?.(),s=e.getCurrentNodeId(),n=this.getCache(e);if(n.clear(),this.log(`Syncing store. FileID: ${s||"N/A"}, Engine Available: ${!!t}`),t&&t.getSRSStatus&&s)try{const i=await t.getSRSStatus(s),o=Object.keys(i).length;this.log(`Loaded ${o} items from Engine VFS.`);for(const[a,r]of Object.entries(i))n.set(a,{dueAt:new Date(r.dueAt).toISOString(),lastReviewedAt:new Date(r.lastReviewedAt).toISOString(),lastGrade:0,reviewCount:r.reviewCount,interval:r.interval,easeFactor:r.ease});return}catch(i){console.warn("[MemoryPlugin] Failed to sync from Engine, falling back to Metadata store.",i)}else this.log("Skipping Engine sync (Conditions not met). Fallback to metadata?");if(this.storeRef)try{const i=await this.storeRef.get("_mdx_srs")||{},o=Object.keys(i).length;this.log(`Loaded ${o} items from Metadata Store (Fallback).`);for(const[a,r]of Object.entries(i))n.set(a,r)}catch(i){console.warn("[MemoryPlugin] Metadata sync error:",i)}}async saveCardState(e,t,s){const n=e.getSessionEngine?.(),i=e.getCurrentNodeId();if(this.log(`Saving card ${t} to FileID: ${i}`),n&&n.updateSRSStatus&&i)try{await n.updateSRSStatus(i,t,{dueAt:s.dueAt?new Date(s.dueAt).getTime():Date.now(),lastReviewedAt:s.lastReviewedAt?new Date(s.lastReviewedAt).getTime():Date.now(),interval:s.interval,ease:s.easeFactor,reviewCount:s.reviewCount}),this.log("Saved successfully to Engine VFS.");return}catch(o){console.error("[MemoryPlugin] Failed to save to Engine:",o)}if(this.storeRef)try{const o=this.getCache(e),a={};o.forEach((r,c)=>{a[c]=r}),await this.storeRef.set("_mdx_srs",a),this.log("Saved successfully to Metadata Store (Fallback).")}catch(o){console.error("[MemoryPlugin] Metadata save error:",o)}}determineStateClass(e){if(!e||e.reviewCount===0)return"is-new";const t=new Date,s=e.dueAt?new Date(e.dueAt):t,n=e.lastReviewedAt?new Date(e.lastReviewedAt):null;if(e.interval*24*60*60*1e3<this.options.coolingPeriod*2&&n&&s>t&&t.getTime()-n.getTime()<this.options.coolingPeriod)return"is-cooling";const i=s.getTime()-t.getTime(),o=this.options.hideBeforeDueHours*60*60*1e3;return i>o?"is-cleared":e.interval<1?"is-learning":-i/(24*60*60*1e3)>=this.options.dangerThresholdDays?"is-danger":"is-due"}applyVisualsAndState(e,t){const s=e.classList.contains("is-global-override")||!!e.closest(".is-global-override"),n=this.getCache(t),i=e.querySelectorAll(".mdx-cloze");let o=0;i.forEach(a=>{const r=a.getAttribute("data-cloze-locator");if(!r)return;const c=n.get(r);c&&o++;const d=this.determineStateClass(c);a.classList.remove("is-new","is-cooling","is-learning","is-due","is-danger","is-cleared"),a.classList.add(d),a.dataset.stateClass=d,s||(d==="is-cleared"||d==="is-cooling"?a.classList.remove("hidden"):a.classList.add("hidden"))}),this.log(`Applied visuals. Found ${i.length} clozes in DOM. Matched ${o} from Store.`)}showGradingPanel(e,t,s=0){const n=e.querySelector(`.${this.options.className}__panel`);n&&n.remove();const i=document.createElement("div");i.className=`${this.options.className}__panel`,i.addEventListener("click",a=>a.stopPropagation()),i.innerHTML=`
      <button data-grade="1" title="忘记 (1分钟后重试)">Again</button>
      <button data-grade="2" title="困难 (10分钟后)">Hard</button>
      <button data-grade="3" title="一般 (明天)">Good</button>
      <button data-grade="4" title="简单 (4天后)">Easy</button>
    `;let o=null;s>0&&(o=setTimeout(()=>i.remove(),s)),i.addEventListener("click",async a=>{const r=a.target.closest("button");if(!r)return;o&&clearTimeout(o);const c=parseInt(r.getAttribute("data-grade")||"3",10);i.remove(),await this.gradeCard(e,c,t)}),e.appendChild(i)}showBatchGrading(e,t){(t||document).querySelectorAll(".mdx-cloze:not(.hidden):not(.is-cooling)").forEach(i=>{this.showGradingPanel(i,e,0)})}calculateNextReview(e,t){const s=new Date,n=e?{...e}:{dueAt:null,lastReviewedAt:null,lastGrade:null,reviewCount:0,interval:0,easeFactor:2.5},i=1/1440,o=10/1440;let a;if(t===1)n.easeFactor=Math.max(1.3,n.easeFactor-.2),a=i;else if(n.interval<1)switch(t){case 2:a=i*5;break;case 3:a=n.interval>=o*.9?1:o;break;case 4:a=4;break;default:a=i}else switch(t){case 2:n.easeFactor=Math.max(1.3,n.easeFactor-.15),a=n.interval*1.2;break;case 3:a=n.interval*n.easeFactor;break;case 4:n.easeFactor+=.15,a=n.interval*n.easeFactor*1.3;break;default:a=1}return n.lastReviewedAt=s.toISOString(),n.lastGrade=t,n.reviewCount++,n.interval=a,n.dueAt=new Date(s.getTime()+a*24*60*60*1e3).toISOString(),n}async gradeCard(e,t,s){const n=e.getAttribute("data-cloze-locator");if(n)try{const i=this.getCache(s),o=i.get(n),a=this.calculateNextReview(o,t);i.set(n,a),await this.saveCardState(s,n,a),e.classList.remove("is-new","is-cooling","is-learning","is-due","is-danger","is-cleared");const r=this.determineStateClass(a);e.classList.add(r),e.dataset.stateClass=r,(r==="is-cleared"||r==="is-cooling")&&e.classList.remove("hidden"),this.log(`Graded "${n}" with ${t}. State: ${r}`)}catch(i){console.error("[MemoryPlugin] grading error:",i)}}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.storeRef=null}}class mi{name="interaction:clipboard";options;turndownService;constructor(e={}){this.options={enableHtmlToMarkdown:e.enableHtmlToMarkdown??!0,enableImagePaste:e.enableImagePaste??!0,turndownOptions:e.turndownOptions??{}},this.turndownService=new Fs({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-",...this.options.turndownOptions}),this.turndownService.use(Bs),this.turndownService.addRule("images",{filter:"img",replacement:(t,s)=>{const n=s,i=n.alt||"",o=n.src||"",a=n.title?` "${n.title}"`:"";return o.startsWith("data:")?`![${i}](${o})<!-- base64-image -->`:o.startsWith("http")?`![${i}](${o}${a})`:`![${i}](${o}${a})`}})}install(e){const t=Z.domEventHandlers({paste:(s,n)=>this.handlePaste(s,n)});e.registerCodeMirrorExtension?.(t)}handlePaste(e,t){const s=e.clipboardData;if(!s||this.options.enableImagePaste&&s.files.length>0&&Array.from(s.files).filter(i=>i.type.startsWith("image/")).length>0)return!1;if(this.options.enableHtmlToMarkdown){const n=s.getData("text/html");if(n&&this.isRichContent(n)){e.preventDefault();const i=this.convertHtmlToMarkdown(n);return this.insertText(t,i),!0}}return!1}isRichContent(e){const n=new DOMParser().parseFromString(e,"text/html").body,i=["h1","h2","h3","h4","h5","h6","p","br","strong","b","em","i","u","s","del","a","img","ul","ol","li","table","thead","tbody","tr","th","td","pre","code","blockquote","hr"];for(const r of i)if(n.querySelector(r))return!0;return(n.textContent||"").includes(`
`)||n.querySelectorAll("div, span").length>1}convertHtmlToMarkdown(e){try{const t=this.preprocessHtml(e);let s=this.turndownService.turndown(t);return s=this.postprocessMarkdown(s),s}catch(t){return console.error("[ClipboardPlugin] HTML to Markdown conversion failed:",t),new DOMParser().parseFromString(e,"text/html").body.textContent||""}}preprocessHtml(e){const s=new DOMParser().parseFromString(e,"text/html");return s.querySelectorAll("script, style, meta, link").forEach(n=>n.remove()),s.querySelectorAll("[style]").forEach(n=>n.removeAttribute("style")),s.body.innerHTML}postprocessMarkdown(e){return e.replace(/\n{3,}/g,`

`).replace(/[ \t]+$/gm,"").replace(/([^\n])\n```/g,"$1\n\n```").replace(/```\n([^\n])/g,"```\n\n$1").trim()}insertText(e,t){const{from:s,to:n}=e.state.selection.main;e.dispatch({changes:{from:s,to:n,insert:t},selection:{anchor:s+t.length}})}destroy(){}}const ht={maxSize:10*1024*1024,accept:["image/*","application/pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".md",".json",".svg"]};function fi(l,e){if(l.startsWith(".")||e?.excludePattern&&e.excludePattern.test(l))return!1;if(e?.extensions&&e.extensions.length>0){const t="."+l.split(".").pop()?.toLowerCase();return e.extensions.includes(t)}return!0}function ns(l){return`@asset/${l}`}function xe(l){let e=l;return e.startsWith("@asset/")?e=e.slice(7):e.startsWith("./")&&(e=e.slice(2)),e.split("?")[0].split("#")[0].split("/").pop()||e}function yi(l){return{maxSize:l.uploadLimit?.maxSize??ht.maxSize,accept:l.uploadLimit?.accept??[...ht.accept]}}function vi(l,e){if(l.size>e.maxSize)return{valid:!1,error:`文件大小超过限制 (${(e.maxSize/1048576).toFixed(1)}MB)`};const t=l.name.toLowerCase(),s=l.type.toLowerCase();return!e.accept||e.accept.length===0?{valid:!0}:e.accept.some(i=>{const o=i.toLowerCase().trim();if(o.startsWith("."))return t.endsWith(o);if(o.endsWith("/*")){const a=o.slice(0,-2);return s.startsWith(a)}else return s===o})?{valid:!0}:{valid:!1,error:"不支持的文件类型"}}class bi{name="interaction:upload";context;uploadLimits;fileInput=null;currentEditor=null;constructor(e={}){this.uploadLimits=yi(e)}install(e){this.context=e,this.initHiddenInput(),e.registerToolbarButton?.({id:"upload-action",title:"上传附件",icon:`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>`,onClick:({editor:s})=>{this.currentEditor=s,this.fileInput?.click()}});const t=Z.domEventHandlers({paste:(s,n)=>{const i=s.clipboardData?.files;return i&&i.length>0?(s.preventDefault(),this.processFiles(i,n).catch(o=>console.error(o)),!0):!1},drop:(s,n)=>{const i=s.dataTransfer?.files;return i&&i.length>0?(s.preventDefault(),this.processFiles(i,n).catch(o=>console.error(o)),!0):!1}});e.registerCodeMirrorExtension?.(t)}initHiddenInput(){this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.multiple=!0,this.fileInput.style.display="none",this.uploadLimits.accept.length>0&&(this.fileInput.accept=this.uploadLimits.accept.join(",")),document.body.appendChild(this.fileInput),this.fileInput.addEventListener("change",async()=>{const e=this.fileInput?.files;if(!e||e.length===0)return;const t=this.currentEditor?.getEditorView();t?(t.focus(),await this.processFiles(e,t)):f.error("无法获取编辑器实例"),this.fileInput&&(this.fileInput.value="")})}async processFiles(e,t){const s=this.context.getSessionEngine?.(),n=this.context.getOwnerNodeId?.();if(!s){console.warn("[UploadPlugin] No engine available."),f.error("上传服务不可用");return}if(!n){console.warn("[UploadPlugin] No ownerNodeId defined."),f.error("无法确定资产归属，上传失败");return}const i=`upload-${Date.now().toString(36)}`,o=`![Uploading ${e.length} files... #${i}]()`,{from:a}=t.state.selection.main;t.dispatch({changes:{from:a,insert:o}});try{const r=[],c=[];for(let u=0;u<e.length;u++){const p=e[u],m=vi(p,this.uploadLimits);if(!m.valid){const k=`文件 ${p.name}: ${m.error}`;c.push(k),console.warn(k);continue}const g=this.generateSafeFilename(p.name),y=await p.arrayBuffer(),b=await s.createAsset(n,g,y),E=ns(b.name);r.push(this.generateMarkdown(p,E))}c.length>0&&f.error(`部分文件上传失败:
${c.slice(0,3).join(`
`)}${c.length>3?"...":""}`);const h=t.state.doc.toString().indexOf(o);if(h>=0){const u=r.length>0?`
`+r.join(`
`)+`
`:"";t.dispatch({changes:{from:h,to:h+o.length,insert:u},selection:{anchor:h+u.length}}),r.length>0&&f.success(`成功上传 ${r.length} 个文件`)}}catch(r){console.error("[UploadPlugin] Upload failed:",r),f.error("上传过程中发生错误");const d=t.state.doc.toString().indexOf(o);d>=0&&t.dispatch({changes:{from:d,to:d+o.length,insert:""}})}}generateSafeFilename(e){return e.replace(/[^a-zA-Z0-9._-]/g,"_")}generateMarkdown(e,t){return e.type.startsWith("image/")?`![${e.name}](${t})`:e.type==="application/pdf"?`![${e.name}](${t})`:`[${e.name}](${t})`}destroy(){this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.fileInput=null,this.currentEditor=null}}class wi{name="interaction:table";options;cleanupFns=[];tableStateMap=new WeakMap;constructor(e={}){this.options={enableSorting:e.enableSorting??!0,enableFiltering:e.enableFiltering??!1,containerClass:e.containerClass??"mdx-table-container"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processTables(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processTables(e){e.querySelectorAll("table").forEach(s=>{if(!s.parentElement?.classList.contains(this.options.containerClass)){const a=document.createElement("div");a.className=this.options.containerClass,s.parentNode?.insertBefore(a,s),a.appendChild(s)}const n=s.querySelector("tbody");if(!n)return;const i=Array.from(n.querySelectorAll("tr"));this.tableStateMap.set(s,{originalRows:i,currentSort:null});const o=s.querySelector("thead");o&&(this.options.enableSorting&&this.initSorting(s,o,n),this.options.enableFiltering&&this.initFiltering(s,o,n))})}initSorting(e,t,s){const n=t.querySelectorAll("th");n.forEach((i,o)=>{i.classList.add("mdx-sortable-header"),i.setAttribute("title","Click to sort");const a=()=>{this.handleSort(e,s,i,o,n)};i.addEventListener("click",a)})}handleSort(e,t,s,n,i){const o=this.tableStateMap.get(e);if(!o)return;let a="asc";if(o.currentSort?.colIndex===n&&o.currentSort.direction==="asc"?a="desc":o.currentSort?.colIndex===n&&o.currentSort.direction==="desc"&&(a="none"),i.forEach(r=>{r.classList.remove("sort-asc","sort-desc"),r.removeAttribute("data-sort")}),a==="none")o.currentSort=null,this.renderRows(t,o.originalRows);else{s.classList.add(`sort-${a}`),s.setAttribute("data-sort",a),o.currentSort={colIndex:n,direction:a};const r=Array.from(t.querySelectorAll("tr"));r.sort((c,d)=>{const h=c.children[n]?.textContent?.trim()||"",u=d.children[n]?.textContent?.trim()||"";return this.compareCells(h,u,a)}),this.renderRows(t,r)}}compareCells(e,t,s){const n=parseFloat(e.replace(/[^0-9.-]/g,"")),i=parseFloat(t.replace(/[^0-9.-]/g,""));let o=0;const a=!isNaN(n)&&/^\d/.test(e),r=!isNaN(i)&&/^\d/.test(t);return a&&r?o=n-i:o=e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"}),s==="asc"?o:-o}initFiltering(e,t,s){const n=document.createElement("tr");n.className="mdx-table-filter-row";const i=t.rows[0].cells.length;for(let o=0;o<i;o++){const a=document.createElement("th"),r=document.createElement("input");r.type="text",r.placeholder="Filter...",r.className="mdx-table-filter-input",r.addEventListener("input",()=>{this.handleFilter(e,s,n)}),r.addEventListener("click",c=>c.stopPropagation()),a.appendChild(r),n.appendChild(a)}t.appendChild(n)}handleFilter(e,t,s){const n=this.tableStateMap.get(e);if(!n)return;const o=Array.from(s.querySelectorAll("input")).map(r=>r.value.toLowerCase());if(!o.some(r=>r!=="")){n.originalRows.forEach(r=>r.style.display="");return}n.originalRows.forEach(r=>{let c=!0;const d=r.cells;for(let h=0;h<o.length;h++){const u=o[h];if(!u)continue;if(!(d[h]?.textContent?.toLowerCase()||"").includes(u)){c=!1;break}}r.style.display=c?"":"none"})}renderRows(e,t){const s=document.createDocumentFragment();t.forEach(n=>s.appendChild(n)),e.appendChild(s)}}class Si{name="interaction:task-list";options;cleanupFns=[];store=null;currentMarkdown="";taskLocations=[];renderTaskCounter=0;constructor(e={}){this.options={checkboxSelector:e.checkboxSelector||'input[type="checkbox"].mdx-task-item',autoUpdateMarkdown:e.autoUpdateMarkdown!==!1,beforeTaskToggle:e.beforeTaskToggle||(()=>!0),onTaskToggled:e.onTaskToggled||(()=>{})}}createMarkedExtension(){const e=this;return{hooks:{preprocess(t){return e.renderTaskCounter=0,t}},renderer:{listitem(t){const s=/^\[([ xX])\]/,n=t.match(s);if(n){const i=n[1]!==" ",o=e.renderTaskCounter++,a=`<input type="checkbox" class="mdx-task-item" ${i?"checked":""} data-task-index="${o}">`,r=t.substring(n[0].length);return`<li class="task-list-item">${a}${r}</li>
`}if(t.startsWith("<input")){const o=`<input class="mdx-task-item" data-task-index="${e.renderTaskCounter++}"`;return`<li class="task-list-item">${t.replace("<input",o)}</li>
`}return`<li>${t}</li>
`},tablecell(t,s){const n=s.header?"th":"td",i=s.align?`<${n} align="${s.align}">`:`<${n}>`,o=t.replace(/\[([ xX])\]/gi,(a,r)=>{const c=r.toLowerCase()==="x",d=e.renderTaskCounter++;return`<input type="checkbox" class="mdx-task-item mdx-table-task" ${c?"checked":""} data-task-index="${d}">`});return`${i}${o}</${n}>
`}}}}parseTaskLocations(e){this.taskLocations=[],e.split(`
`).forEach((s,n)=>{const i=n+1;if(/^\s*[-*+]\s+\[[ xX]\]/.test(s))this.taskLocations.push({lineNumber:i,indexInLine:0,isTableTask:!1});else if(s.includes("|")&&/\[[ xX]\]/.test(s)){const o=s.match(/\[[ xX]\]/g);o&&o.forEach((a,r)=>{this.taskLocations.push({lineNumber:i,indexInLine:r,isTableTask:!0})})}})}createClickHandler(e){return async t=>{const s=t.target;if(!s.matches(this.options.checkboxSelector)){s.tagName==="INPUT"&&s.type==="checkbox"&&console.warn("[TaskListPlugin] Checkbox clicked but selector mismatch.",{expected:this.options.checkboxSelector,actualClass:s.className});return}const n=s,i=n.getAttribute("data-task-index");if(i===null){console.error("[TaskListPlugin] Checkbox missing data-task-index attribute.");return}const o=parseInt(i,10),a=this.taskLocations[o];if(!a){console.error("[TaskListPlugin] Task location NOT found for index:",o,"Total locations:",this.taskLocations.length);return}let r="";a.isTableTask?r=n.parentElement?.textContent?.trim()||"":r=n.closest(".task-list-item")?.textContent?.trim()||"";const c={taskText:r,isChecked:n.checked,element:n,lineNumber:a.lineNumber,isTableTask:a.isTableTask};if(!await this.options.beforeTaskToggle(c)){t.preventDefault(),n.checked=!n.checked;return}const h={...c,originalMarkdown:this.currentMarkdown,updatedMarkdown:this.currentMarkdown,wasUpdated:!1};if(this.options.autoUpdateMarkdown){const u=this.updateMarkdown(a,c.isChecked);u?(h.updatedMarkdown=u,h.wasUpdated=!0,this.currentMarkdown=u,await this.store?.set("currentMarkdown",u)):console.warn("[TaskListPlugin] updateMarkdown returned null.")}e.emit("taskToggled",h),await this.options.onTaskToggled(h)}}updateMarkdown(e,t){const s=this.currentMarkdown.split(`
`),n=e.lineNumber-1;if(n<0||n>=s.length)return console.warn("[TaskListPlugin] Line number out of bounds:",n),null;let i=s[n];const o=t?"[x]":"[ ]";if(e.isTableTask){let a=0;i=i.replace(/\[[ xX]\]/gi,r=>a===e.indexInLine?(a++,o):(a++,r))}else i=i.replace(/^(\s*[-*+]\s+)\[[ xX]\]/,`$1${o}`);return s[n]=i,s.join(`
`)}install(e){e.registerSyntaxExtension(this.createMarkedExtension()),this.store=e.getScopedStore(),this.store.get("currentMarkdown").then(n=>{n&&(this.currentMarkdown=n)});const t=e.on("beforeParse",({markdown:n})=>(this.currentMarkdown=n,this.parseTaskLocations(n),{markdown:n}));t&&this.cleanupFns.push(t);const s=e.on("domUpdated",({element:n})=>{const i=n._taskListClickHandler;i&&n.removeEventListener("click",i);const o=this.createClickHandler(e);n.addEventListener("click",o),n._taskListClickHandler=o});s&&this.cleanupFns.push(s)}setMarkdown(e){this.currentMarkdown=e,this.parseTaskLocations(e),this.store?.set("currentMarkdown",e)}getMarkdown(){return this.currentMarkdown}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class Ei{name="interaction:codeblock-controls";options;cleanupFns=[];constructor(e={}){this.options={collapseThreshold:e.collapseThreshold??250,collapsedHeight:e.collapsedHeight??250,classPrefix:e.classPrefix||"mdx-code-block",enableCopy:e.enableCopy!==!1,enableDownload:e.enableDownload!==!1,enableCollapse:e.enableCollapse!==!1,defaultCollapsed:e.defaultCollapsed!==!1,expandText:e.expandText||"点击展开查看完整代码",icons:{copy:e.icons?.copy||"📋",copied:e.icons?.copied||"✓",download:e.icons?.download||"💾",collapse:e.icons?.collapse||"▼",expand:e.icons?.expand||"▲"}}}_createButton(e,t,s,n){const i=document.createElement("button");i.className=`${this.options.classPrefix}-controls__button`,i.setAttribute("aria-label",t),i.title=t,i.innerHTML=e,i.type="button";const o=a=>{a.preventDefault(),s(i,n)};return i.addEventListener("click",o),this.cleanupFns.push(()=>i.removeEventListener("click",o)),i}_createCopyButton(e){return this._createButton(this.options.icons.copy,"Copy code",async t=>{const s=e.textContent||"";try{await navigator.clipboard.writeText(s);const n=t.innerHTML,i=t.title;t.innerHTML=this.options.icons.copied,t.title="Copied!",t.classList.add(`${this.options.classPrefix}-controls__button--success`),setTimeout(()=>{t.innerHTML=n,t.title=i,t.classList.remove(`${this.options.classPrefix}-controls__button--success`)},1500)}catch(n){console.error("Failed to copy code:",n),t.innerHTML="✗",t.title="Copy failed",this._fallbackCopy(s)}},e)}_fallbackCopy(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(s){console.error("Fallback copy failed:",s)}finally{document.body.removeChild(t)}}_createDownloadButton(e){return this._createButton(this.options.icons.download,"Download code",()=>{const t=e.textContent||"",s=e.querySelector("code"),n=s?Array.from(s.classList).find(d=>d.startsWith("language-")):null,o=`code.${n?n.replace("language-",""):"txt"}`,a=new Blob([t],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download=o,c.style.display="none",document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),URL.revokeObjectURL(r)},100)},e)}_createCollapseButton(e,t){if(t.scrollHeight<=this.options.collapseThreshold)return null;const n=this._createButton("","",a=>{this._toggleCollapse(e,a,t)},t);n.classList.add(`${this.options.classPrefix}-controls__button--collapse`);const i=document.createElement("div");i.className=`${this.options.classPrefix}-expand-trigger`,i.innerHTML=`<span>${this.options.icons.expand} ${this.options.expandText}</span>`;const o=()=>{this._toggleCollapse(e,n,t)};return i.addEventListener("click",o),this.cleanupFns.push(()=>i.removeEventListener("click",o)),this.options.defaultCollapsed?(e.classList.add(`${this.options.classPrefix}-wrapper--collapsed`),this._updateState(e,n,t,!1)):this._updateState(e,n,t,!0),{button:n,trigger:i}}_updateState(e,t,s,n){t.innerHTML=n?this.options.icons.collapse:this.options.icons.expand,t.title=n?"Collapse code":"Expand code",t.setAttribute("aria-expanded",String(n)),n?s.style.maxHeight=`${s.scrollHeight+50}px`:s.style.maxHeight=`${this.options.collapsedHeight}px`}_toggleCollapse(e,t,s){const n=!e.classList.toggle(`${this.options.classPrefix}-wrapper--collapsed`);this._updateState(e,t,s,n)}enhanceCodeBlock(e){if(e.hasAttribute("data-enhanced"))return;e.setAttribute("data-enhanced","true");const t=document.createElement("div");t.className=`${this.options.classPrefix}-wrapper`,e.parentNode?.insertBefore(t,e),t.appendChild(e);const s=document.createElement("div");s.className=`${this.options.classPrefix}-controls`;const n=document.createElement("div");if(n.className=`${this.options.classPrefix}-controls__right`,this.options.enableDownload&&n.appendChild(this._createDownloadButton(e)),this.options.enableCopy&&n.appendChild(this._createCopyButton(e)),this.options.enableCollapse){const i=this._createCollapseButton(t,e);i&&(n.appendChild(i.button),t.appendChild(i.trigger))}n.children.length>0&&(s.appendChild(n),t.prepend(s))}enhanceCodeBlocks(e){e.querySelectorAll("pre:not([data-enhanced])").forEach(s=>this.enhanceCodeBlock(s))}install(e){const t=e.on("domUpdated",({element:s})=>{this.enhanceCodeBlocks(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class xi{name="ui:toolbar";options;toolbarElement=null;cleanupFns=[];constructor(e={}){this.options={className:e.className||"mdx-editor-toolbar"}}install(e){const t=e.on("editorPostInit",s=>{this.buildToolbar(e,s)});t&&this.cleanupFns.push(t)}buildToolbar(e,t){const{editor:s,pluginManager:n}=t,i=s.container;if(!i){console.warn("ToolbarPlugin: MDxEditor container not found. Cannot build toolbar.");return}let o=i.querySelector(`.${this.options.className}`);o||(o=document.createElement("div"),o.className=this.options.className,i.insertBefore(o,i.firstChild)),this.toolbarElement=o;const a=n.getToolbarButtons();o.innerHTML="";const r=a.filter(h=>!h.location||h.location==="main"),c=a.filter(h=>h.location==="mode-switcher"),d=document.createElement("div");if(d.className=`${this.options.className}__main`,o.appendChild(d),r.forEach(h=>{const u=this.createButton(h,e,s,n);d.appendChild(u)}),c.length>0){const h=document.createElement("div");h.className=`${this.options.className}__mode-switcher`,o.appendChild(h),c.forEach(u=>{const p=this.createButton(u,e,s,n);h.appendChild(p)})}}createButton(e,t,s,n){if(e.type==="separator"){const o=document.createElement("div");return o.className=`${this.options.className}__separator`,o}const i=document.createElement("button");return i.className=`${this.options.className}__button`,i.title=e.title||e.id,i.setAttribute("data-command",e.id),typeof e.icon=="string"?i.innerHTML=e.icon:e.icon instanceof HTMLElement&&i.appendChild(e.icon.cloneNode(!0)),i.onclick=()=>{if(e.onClick)e.onClick({editor:s,context:t,pluginManager:n});else if(e.command){const o=n.getCommand(e.command),a=s.getEditorView();o&&a?o(a):console.warn(`Command "${e.command}" not found or editor view is not available.`)}},i}destroy(){this.toolbarElement&&this.toolbarElement.remove(),this.toolbarElement=null,this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class _i{name="ui:formatting";options;constructor(e={}){this.options={enabledFormats:e.enabledFormats||"all",customIcons:e.customIcons||{}}}install(e){if(!e.registerCommand||!e.registerToolbarButton){console.warn("FormattingPlugin requires editor context with command registration support");return}const{registerCommand:t,registerToolbarButton:s}=e;this.getEnabledFormats().forEach(i=>{if(i==="separator"){s({id:`sep-${Date.now()}-${Math.random()}`,type:"separator"});return}const o=this.getCommandDefinition(i);o&&t(o.name,r=>o.fn(r));const a=this.getButtonConfig(i);a&&s(a)})}getEnabledFormats(){return this.options.enabledFormats==="all"?["heading","bold","italic","strikethrough","highlight","inlineCode","separator","unorderedList","orderedList","taskList","separator","blockquote","codeBlock","horizontalRule","separator","link","image","table"]:this.options.enabledFormats||[]}getCommandDefinition(e){return{bold:{name:"applyBold",fn:Bt},italic:{name:"applyItalic",fn:Ut},strikethrough:{name:"applyStrikethrough",fn:Ht},inlineCode:{name:"applyInlineCode",fn:zt},highlight:{name:"applyHighlight",fn:qt},heading:{name:"toggleHeading",fn:Kt},unorderedList:{name:"toggleUnorderedList",fn:Wt},orderedList:{name:"toggleOrderedList",fn:Gt},taskList:{name:"toggleTaskList",fn:Jt},blockquote:{name:"toggleBlockquote",fn:Qt},codeBlock:{name:"applyCodeBlock",fn:Zt},link:{name:"applyLink",fn:es},image:{name:"insertImage",fn:ts},table:{name:"insertTable",fn:Xt},horizontalRule:{name:"insertHorizontalRule",fn:Yt}}[e]||null}getButtonConfig(e){const t={bold:"<strong>B</strong>",italic:"<em>I</em>",strikethrough:"<s>S</s>",inlineCode:"<code>`</code>",highlight:"<mark>H</mark>",heading:"<span>H#</span>",unorderedList:"<span>•</span>",orderedList:"<span>1.</span>",taskList:"<span>☐</span>",blockquote:"<span>❝</span>",codeBlock:"<span>{ }</span>",link:"<span>🔗</span>",image:"<span>🖼</span>",table:"<span>⊞</span>",horizontalRule:"<span>―</span>"},s={bold:"applyBold",italic:"applyItalic",strikethrough:"applyStrikethrough",inlineCode:"applyInlineCode",highlight:"applyHighlight",heading:"toggleHeading",unorderedList:"toggleUnorderedList",orderedList:"toggleOrderedList",taskList:"toggleTaskList",blockquote:"toggleBlockquote",codeBlock:"applyCodeBlock",link:"applyLink",image:"insertImage",table:"insertTable"},n={bold:"加粗",italic:"斜体",strikethrough:"删除线",inlineCode:"行内代码",highlight:"高亮",heading:"标题",unorderedList:"无序列表",orderedList:"有序列表",taskList:"任务列表",blockquote:"引用",codeBlock:"代码块",link:"链接",image:"图片",table:"表格"},i=this.options.customIcons?.[e]||t[e],o=s[e],a=n[e];return!i||!o?null:{id:`format-${e}`,title:a,icon:i,command:o,location:"main"}}destroy(){}}class Ii{name="core:titlebar";options;cleanupFns=[];toggleModeBtn=null;titleEl=null;constructor(e={}){this.options=e}install(e){const t=e.listen("setTitle",({title:o})=>{this.titleEl&&(this.titleEl.textContent=o)});t&&this.cleanupFns.push(t);const s=e.on("editorPostInit",o=>{this.registerButtons(e,o)});s&&this.cleanupFns.push(s);const n=e.on("editorPostInit",o=>{this.renderTitleBar(e,o)});n&&this.cleanupFns.push(n);const i=e.on("modeChanged",({mode:o})=>{this.updateModeButton(o)});i&&this.cleanupFns.push(i)}registerButtons(e,t){const{editor:s}=t;this.options.onSidebarToggle&&e.registerTitleBarButton?.({id:"toggle-sidebar",title:"切换侧边栏",icon:'<i class="fas fa-bars"></i>',location:"left",onClick:()=>this.options.onSidebarToggle?.(s)}),this.options.enableToggleEditMode&&(e.registerCommand?.("toggleEditMode",i=>{const a=i.getMode()==="edit"?"render":"edit";i.switchToMode(a)}),e.registerTitleBarButton?.({id:"toggle-edit-mode",title:"切换到阅读模式",icon:'<i class="fas fa-book-open"></i>',command:"toggleEditMode",location:"left"})),this.options.aiCallback&&(e.registerCommand?.("triggerAI",async i=>{await this.options.aiCallback?.(i)}),e.registerTitleBarButton?.({id:"ai-action",title:"AI 助手",icon:'<i class="fas fa-magic"></i>',command:"triggerAI",location:"right"})),this.options.saveCallback&&(e.registerCommand?.("triggerSave",async i=>{await this.options.saveCallback?.(i)}),e.registerTitleBarButton?.({id:"save-action",title:"保存",icon:'<i class="fas fa-save"></i>',command:"triggerSave",location:"right"}));const n=this.options.printCallback||this.defaultPrintHandler;e.registerCommand?.("handlePrintAction",n),e.registerTitleBarButton?.({id:"print-action",title:"打印",icon:'<i class="fas fa-print"></i>',command:"handlePrintAction",location:"right"})}renderTitleBar(e,t){const{editor:s,pluginManager:n}=t,i=s.container;if(!i)return;let o=i.querySelector(".mdx-editor-titlebar");o||(o=document.createElement("div"),o.className="mdx-editor-titlebar",i.insertBefore(o,i.firstChild));const a=document.createElement("div");a.className="mdx-editor-titlebar__left";const r=document.createElement("div");r.className="mdx-editor-titlebar__center",this.titleEl=document.createElement("span"),this.titleEl.className="mdx-editor-titlebar__title",this.titleEl.textContent=s.config.title||"",r.appendChild(this.titleEl);const c=document.createElement("div");c.className="mdx-editor-titlebar__right",o.innerHTML="",o.appendChild(a),o.appendChild(r),o.appendChild(c);const d=n.getTitleBarButtons();d.forEach(h=>{const u=document.createElement("button");u.className="mdx-editor-titlebar__button",u.title=h.title||h.id,u.setAttribute("data-button-id",h.id),typeof h.icon=="string"?u.innerHTML=h.icon:h.icon instanceof HTMLElement&&u.appendChild(h.icon.cloneNode(!0)),u.onclick=()=>{if(h.onClick)h.onClick({editor:s,context:e,pluginManager:n});else if(h.command){const m=n.getCommand(h.command);m&&m(s)}},(h.location==="right"?c:a).appendChild(u),h.id==="toggle-edit-mode"&&(this.toggleModeBtn=u)}),d.length===0&&!this.titleEl.textContent?o.style.display="none":o.style.display=""}updateModeButton(e){this.toggleModeBtn&&(e==="edit"?(this.toggleModeBtn.title="切换到阅读模式",this.toggleModeBtn.innerHTML='<i class="fas fa-book-open"></i>'):(this.toggleModeBtn.title="切换到编辑模式",this.toggleModeBtn.innerHTML='<i class="fas fa-edit"></i>'))}defaultPrintHandler(e){e.print({title:e.config.title||"Document",showHeader:!0,headerMeta:{date:new Date().toLocaleDateString()}}).catch(t=>{console.error("[TitleBarPlugin] Print failed:",t)})}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.toggleModeBtn=null,this.titleEl=null}}class is{constructor(e,t,s={}){this.engine=e,this.editor=t,this.options=s}objectUrls=[];overlay=null;listContainer;statsEl;cleanBtn;currentAssetDirId="";async show(e){this.currentAssetDirId=e,this.createModalStructure(),this.overlay&&document.body.appendChild(this.overlay);try{await this.refreshAssetList()}catch(t){console.error("[AssetManager] Load failed:",t),f.error("加载附件列表失败"),this.close()}}close(){this.overlay?.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.objectUrls.forEach(e=>URL.revokeObjectURL(e)),this.objectUrls=[]}async refreshAssetList(){if(!this.listContainer)return;this.listContainer.innerHTML='<div class="mdx-empty-state">加载中...</div>';let e=[];try{e=await this.engine.getChildren(this.currentAssetDirId)}catch(a){console.error("[AssetManager] Failed to get children:",a),this.listContainer.innerHTML='<div class="mdx-empty-state">读取目录失败</div>';return}const t=e.filter(a=>a.type!=="file"?!1:fi(a.name,this.options.viewFilter));if(t.length===0){this.listContainer.innerHTML='<div class="mdx-empty-state">暂无附件</div>',this.updateToolbar(0,0,()=>{});return}const s=this.editor.getText(),n=this.extractReferencedFilenames(s),i=t.map(a=>({node:a,isUsed:n.has(a.name)}));await this.loadPreviews(i),this.renderList(i);const o=i.filter(a=>!a.isUsed).length;this.updateToolbar(i.length,o,()=>{this.handleBatchDelete(i.filter(a=>!a.isUsed))})}extractReferencedFilenames(e){const t=new Set,s=/@asset\/([^\s)"']+)/g;let n;for(;(n=s.exec(e))!==null;){const a=xe(n[1]);a&&t.add(a)}const i=/\]\(\s*([^)\s]+)\s*(?:"[^"]*")?\s*\)/g;for(;(n=i.exec(e))!==null;){const a=n[1];if(this.shouldSkipPath(a))continue;const r=xe(a);r&&!r.startsWith("#")&&t.add(r)}const o=/(?:src|href)=["']([^"']+)["']/g;for(;(n=o.exec(e))!==null;){const a=n[1];if(this.shouldSkipPath(a))continue;const r=xe(a);r&&t.add(r)}return t}shouldSkipPath(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("mailto:")||e.startsWith("tel:")||e.startsWith("javascript:")||e.startsWith("#")}async loadPreviews(e){const t=e.map(async s=>{if(this.isPreviewableImage(s.node.name))try{const n=await this.engine.readContent(s.node.id);if(!n)return;const i=this.getMimeType(s.node.name),o=new Blob([n],{type:i}),a=URL.createObjectURL(o);this.objectUrls.push(a),s.url=a}catch{console.warn("[AssetManager] Preview load failed:",s.node.name)}});await Promise.all(t)}updateToolbar(e,t,s){!this.statsEl||!this.cleanBtn||(this.statsEl.textContent=`共 ${e} 个附件，${t} 个未引用`,t>0?(this.cleanBtn.style.display="inline-block",this.cleanBtn.textContent=`清理 ${t} 个未引用`,this.cleanBtn.onclick=s):this.cleanBtn.style.display="none")}renderList(e){if(!this.listContainer)return;this.listContainer.innerHTML="",e.sort((s,n)=>s.isUsed!==n.isUsed?s.isUsed?1:-1:n.node.createdAt-s.node.createdAt);const t=document.createDocumentFragment();e.forEach(s=>{const n=this.createAssetItem(s);t.appendChild(n)}),this.listContainer.appendChild(t)}createAssetItem(e){const t=document.createElement("li");t.className="mdx-asset-item";const s=document.createElement("img");s.className="mdx-asset-thumb",s.src=e.url||this.getFileIcon(e.node.name),s.alt=e.node.name;const n=document.createElement("div");n.className="mdx-asset-info";const i=new Date(e.node.createdAt).toLocaleDateString(),o=this.formatFileSize(e.node.size||0);n.innerHTML=`
            <div class="mdx-asset-name" title="${e.node.name}">${e.node.name}</div>
            <div class="mdx-asset-meta">
                <span class="mdx-asset-badge ${e.isUsed?"used":"unused"}">
                    ${e.isUsed?"已引用":"未引用"}
                </span>
                <span>${o}</span>
                <span>${i}</span>
            </div>
        `;const a=this.createActionButtons(e);return t.append(s,n,a),t}createActionButtons(e){const t=document.createElement("div");t.className="mdx-asset-actions";const s=this.createButton("插入","primary",()=>{const o=ns(e.node.name),a=this.isPreviewableImage(e.node.name)?`![${e.node.name}](${o})`:`[${e.node.name}](${o})`;this.insertText(a),this.close()}),n=this.createButton("下载","default",()=>{this.handleDownload(e.node)}),i=this.createButton("删除","danger",async()=>{if(!(e.isUsed&&!confirm(`文件 "${e.node.name}" 正在被引用，删除将导致文档内容缺失。

确定要删除吗？`)))try{await this.engine.delete([e.node.id]),f.success("删除成功"),await this.refreshAssetList()}catch(o){console.error("[AssetManager] Delete failed:",o),f.error("删除失败")}});return t.append(s,n,i),t}createButton(e,t,s){const n=document.createElement("button");return n.className=`mdx-btn mdx-btn--${t}`,n.textContent=e,n.onclick=s,n}async handleDownload(e){try{const t=await this.engine.readContent(e.id);if(!t){f.error("文件内容为空");return}const s=this.getMimeType(e.name),n=new Blob([t],{type:s}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e.name,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),f.success("下载已开始")}catch(t){console.error("[AssetManager] Download failed:",t),f.error("下载失败")}}async handleBatchDelete(e){if(!(e.length===0||!confirm(`确定要永久删除这 ${e.length} 个未引用的文件吗？`)))try{await this.engine.delete(e.map(s=>s.node.id)),f.success(`已清理 ${e.length} 个文件`),await this.refreshAssetList()}catch(s){console.error("[AssetManager] Batch delete failed:",s),f.error("批量删除失败")}}insertText(e){const t=this.editor.getEditorView();if(!t)return;const s=t.state.selection.main;t.dispatch({changes:{from:s.from,to:s.to,insert:e}}),this.editor.focus(),f.success("已插入链接")}createModalStructure(){const e=document.createElement("div");e.className="mdx-asset-modal-overlay";const t=document.createElement("div");t.className="mdx-asset-modal",t.innerHTML=`
            <div class="mdx-asset-header">
                <h3>附件管理</h3>
                <button class="mdx-asset-close" aria-label="关闭">&times;</button>
            </div>
            <div class="mdx-asset-toolbar">
                <span class="mdx-stats"></span>
                <button class="mdx-btn mdx-btn--danger mdx-clean-btn" style="display:none"></button>
            </div>
            <ul class="mdx-asset-list"></ul>
        `,e.appendChild(t),this.overlay=e,this.listContainer=t.querySelector(".mdx-asset-list"),this.statsEl=t.querySelector(".mdx-stats"),this.cleanBtn=t.querySelector(".mdx-clean-btn"),t.querySelector(".mdx-asset-close").addEventListener("click",()=>this.close()),e.addEventListener("click",i=>{i.target===e&&this.close()});const n=i=>{i.key==="Escape"&&(this.close(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n)}isPreviewableImage(e){return/\.(png|jpg|jpeg|gif|webp|svg|bmp|ico)$/i.test(e)}getMimeType(e){const t=e.split(".").pop()?.toLowerCase();return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",bmp:"image/bmp",ico:"image/x-icon",pdf:"application/pdf",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",mp4:"video/mp4",webm:"video/webm",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",zip:"application/zip",rar:"application/x-rar-compressed",txt:"text/plain",json:"application/json",xml:"application/xml",html:"text/html",css:"text/css",js:"application/javascript"}[t||""]||"application/octet-stream"}getFileIcon(e){const t=e.split(".").pop()?.toLowerCase()||"";return{pdf:this.createSvgIcon("📄","#e74c3c"),doc:this.createSvgIcon("📝","#2980b9"),docx:this.createSvgIcon("📝","#2980b9"),xls:this.createSvgIcon("📊","#27ae60"),xlsx:this.createSvgIcon("📊","#27ae60"),ppt:this.createSvgIcon("📽️","#e67e22"),pptx:this.createSvgIcon("📽️","#e67e22"),zip:this.createSvgIcon("📦","#9b59b6"),rar:this.createSvgIcon("📦","#9b59b6"),mp4:this.createSvgIcon("🎬","#1abc9c"),webm:this.createSvgIcon("🎬","#1abc9c"),mp3:this.createSvgIcon("🎵","#e91e63"),wav:this.createSvgIcon("🎵","#e91e63")}[t]||this.createSvgIcon("📎","#95a5a6")}createSvgIcon(e,t){const s=`
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
                <rect width="48" height="48" fill="#f5f5f5" rx="4"/>
                <text x="24" y="32" font-size="24" text-anchor="middle">${e}</text>
            </svg>
        `;return`data:image/svg+xml;base64,${btoa(s)}`}formatFileSize(e){if(e===0)return"0 B";const t=["B","KB","MB","GB"],s=1024,n=Math.floor(Math.log(e)/Math.log(s));return`${(e/Math.pow(s,n)).toFixed(n>0?1:0)} ${t[n]}`}}class Ti{name="ui:asset-manager";options;currentUI=null;constructor(e={}){this.options=e}install(e){e.registerTitleBarButton?.({id:"asset-manager",title:"附件管理",icon:`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
            </svg>`,location:"right",onClick:async({editor:t})=>{await this.openAssetManager(e,t)}}),e.registerCommand?.("openAssetManager",async()=>{const s=e.pluginManager.editorInstance;s&&await this.openAssetManager(e,s)})}async openAssetManager(e,t){const s=e.getSessionEngine?.(),n=e.getOwnerNodeId?.();if(!s){f.error("未连接到引擎");return}if(!n){f.info("未找到归属文档");return}const i=await s.getAssetDirectoryId(n);if(!i){f.info("暂无附件");return}this.currentUI&&this.currentUI.close(),this.currentUI=new is(s,t,this.options),await this.currentUI.show(i)}destroy(){this.currentUI?.close(),this.currentUI=null}}class Ci{name="interaction:source-sync";cleanupFns=[];install(e){const t=e.on("domUpdated",({element:s})=>{this.attachDoubleClickHandler(s,e)});t&&this.cleanupFns.push(t)}attachDoubleClickHandler(e,t){const s=e._sourceSyncHandler;s&&e.removeEventListener("dblclick",s);const n=i=>{if(!(navigator.platform.toUpperCase().indexOf("MAC")>=0?i.metaKey:i.ctrlKey))return;const r=i.target,c=this.extractText(r);c&&t.findAndSelectText&&t.switchToMode&&(t.findAndSelectText(c),t.switchToMode("edit"))};e.addEventListener("dblclick",n),e._sourceSyncHandler=n}extractText(e){const t=e.closest(".cloze");if(t){const o=t.getAttribute("data-cloze-content");if(o)return o}const n=window.getSelection()?.toString().trim();if(n)return n;const i=this.findBlockParent(e);return i&&i.textContent?.trim()||null}findBlockParent(e){const t=["P","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE","PRE","DIV"];let s=e;for(;s&&s!==document.body;){if(t.includes(s.tagName))return s;s=s.parentElement}return null}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}class os{name="autocomplete:core";options;constructor(e){this.options=e}install(e){const t=e.pluginManager;if(!t){console.warn("AutocompletePlugin: PluginManager not available");return}t._autocompleteSources||(t._autocompleteSources=[]),t._autocompleteSources.push(...this.options.sources)}}class ki{getTags;constructor(e){this.getTags=e.getTags}async getSuggestions(e){return(await this.getTags()).filter(n=>n.toLowerCase().includes(e.toLowerCase())).map(n=>({label:n,type:"keyword",detail:"tag"}))}}class Mi{name="autocomplete:tag";autocompletePlugin;constructor(e){const t=e.triggerChar||"#",s=new ki({getTags:e.getTags});this.autocompletePlugin=new os({sources:[{triggerChar:t,provider:s,applyTemplate:n=>`${t}${n.label} `}]})}install(e){this.autocompletePlugin.install(e)}}class Ni{name="autocomplete:mention";options;autocompletePlugin;hoverCard=null;cleanupFns=[];constructor(e){this.options={providers:e.providers||[],enableHoverPreview:e.enableHoverPreview!==!1,enableClickHandler:e.enableClickHandler!==!1,enableTransclusion:e.enableTransclusion!==!1,onMentionClick:e.onMentionClick||(()=>{})};const t=new Map;this.options.providers&&this.options.providers.length>0&&this.options.providers.forEach(n=>{t.has(n.triggerChar)||t.set(n.triggerChar,[]),t.get(n.triggerChar).push(n)});const s=Array.from(t.entries()).map(([n,i])=>({triggerChar:n,provider:{getSuggestions:async o=>{const a=i.map(async c=>{try{return(await c.getSuggestions(o)).map(h=>({...h,_providerKey:c.key,detail:h.type?this.formatType(h.type):this.formatType(c.key),section:this.getSectionName(h.type||c.key)}))}catch(d){return console.warn(`[MentionPlugin] Provider ${c.key} failed:`,d),[]}});return(await Promise.all(a)).flat()},getHoverPreview:async o=>{const a=o,r=a._providerKey,c=i.find(d=>d.key===r);if(c&&c.getHoverPreview){const d=`mdx://${r}/${a.id}`;return c.getHoverPreview(d)}return Promise.resolve(null)}},applyTemplate:o=>{const a=o,r=a._providerKey||i[0].key;return`[${a.title||a.label}](mdx://${r}/${a.id}) `}}));this.autocompletePlugin=new os({sources:s})}formatType(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}getSectionName(e){const t=e.toLowerCase();return t.includes("dir")||t.includes("folder")?"Folders":t.includes("file")||t.includes("doc")?"Files":t.includes("user")||t.includes("contact")?"People":"Others"}createMarkedExtension(){return{extensions:[{name:"mdxLink",level:"inline",start:e=>e.indexOf("]("),tokenizer:e=>{const t=e.match(/^\[([^\]]+)\]\(mdx:\/\/([^/]+)\/([^)]+)\)/);if(t)return{type:"mdxLink",raw:t[0],text:t[1],provider:t[2],id:t[3]}},renderer:e=>{const t=`mdx://${e.provider}/${e.id}`;return`<a href="${t}" class="mdx-mention" data-mdx-uri="${t}" data-provider="${e.provider}" data-id="${e.id}">${e.text}</a>`}},this.options.enableTransclusion?{name:"mdxTransclusion",level:"block",start:e=>e.match(/!@/)?.index,tokenizer(e){const s=/^!@(\w+):(\S+)(?:\n|$)/.exec(e);if(s){const[n,i,o]=s;return{type:"mdxTransclusion",raw:n,providerKey:i,id:o}}},renderer(e){return`<div class="mdx-transclusion" data-provider-key="${e.providerKey}" data-id="${e.id}">Loading...</div>`}}:void 0].filter(Boolean)}}createHoverCard(){const e=document.createElement("div");return e.className="mdx-mention-hover-card",e.style.cssText=`
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 320px;
      display: none;
      overflow: hidden;
      font-family: sans-serif;
    `,document.body.appendChild(e),e}async showHoverPreview(e,t,s){if(!(!this.options.enableHoverPreview||!t.getHoverPreview))try{const n=`mdx://${t.key}/${s}`,i=await t.getHoverPreview(n);if(!i)return;this.hoverCard||(this.hoverCard=this.createHoverCard()),this.hoverCard.innerHTML=`
        <div class="mdx-mention-hover-card__header" style="padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #eee; font-weight: 600;">
            ${i.icon||""} ${i.title}
        </div>
        <div class="mdx-mention-hover-card__content" style="padding: 12px;">
            ${i.contentHTML}
        </div>
      `;const o=e.getBoundingClientRect();let a=o.bottom+5;a+200>window.innerHeight&&(a=o.top-this.hoverCard.offsetHeight-5),this.hoverCard.style.left=`${o.left}px`,this.hoverCard.style.top=`${a}px`,this.hoverCard.style.display="block"}catch(n){console.error("[MentionPlugin] Failed to load hover preview:",n)}}hideHoverPreview(){this.hoverCard&&(this.hoverCard.style.display="none")}async processTransclusions(e){if(!this.options.enableTransclusion)return;const t=e.querySelectorAll(".mdx-transclusion:not([data-transclusion-processed])");for(const s of Array.from(t)){s.setAttribute("data-transclusion-processed","true");const n=s.dataset.providerKey,i=s.dataset.id;if(!n||!i)continue;const o=this.options.providers.find(a=>a.key===n);if(o?.getFullContent)try{const a=await o.getFullContent(i);s.innerHTML=a,s.classList.add("mdx-transclusion--loaded"),this.bindMentionInteractions(s),await this.processTransclusions(s)}catch(a){console.error(`[MentionPlugin] Failed to process transclusion for ${n}:${i}:`,a),s.textContent="Failed to load content",s.classList.add("mdx-transclusion--error")}}}bindMentionInteractions(e){this.options.enableHoverPreview&&e.querySelectorAll(".mdx-mention").forEach(s=>{if(s.dataset.eventsBound)return;s.dataset.eventsBound="true";const n=s.dataset.provider,i=s.dataset.id,o=this.options.providers.find(a=>a.key===n);o&&i&&(s.addEventListener("mouseenter",()=>{this.showHoverPreview(s,o,i)}),s.addEventListener("mouseleave",()=>{this.hideHoverPreview()}))}),this.options.enableClickHandler&&!e.dataset.clickListenerBound&&(e.dataset.clickListenerBound="true",e.addEventListener("click",t=>{const s=t.target.closest(".mdx-mention");if(!s)return;t.preventDefault();const n=s.dataset.provider,i=s.dataset.id;n&&i&&this.options.onMentionClick(n,i)}))}install(e){this.autocompletePlugin.install(e),e.registerSyntaxExtension(this.createMarkedExtension());const t=e.on("domUpdated",async({element:s})=>{this.bindMentionInteractions(s),await this.processTransclusions(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[],this.hoverCard&&(this.hoverCard.remove(),this.hoverCard=null)}}class Li{name="feature:svg";options;cleanupFns=[];constructor(e={}){this.options={sanitize:e.sanitize??!0,containerClass:e.containerClass??"mdx-svg-container"}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processSvgCodeBlocks(s)});t&&this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}processSvgCodeBlocks(e){e.querySelectorAll("pre code.language-svg").forEach(s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"",o=this.options.sanitize?this.sanitizeSvg(i):i,a=document.createElement("div");a.className=this.options.containerClass,a.style.display="inline-block",a.style.maxWidth="100%",this.isValidSvg(o)?(a.innerHTML=o,n.replaceWith(a)):console.warn("[SvgPlugin] Invalid or unsafe SVG content detected.")})}sanitizeSvg(e){let t=e;return t=t.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim,""),t=t.replace(/\s(on\w+)="[^"]*"/gim,""),t=t.replace(/\s(on\w+)='[^']*'/gim,""),t=t.replace(/href=["']javascript:[^"']*["']/gim,'href="#"'),t}isValidSvg(e){const t=e.trim();return t.startsWith("<svg")&&t.endsWith("</svg>")}}class Ai{name="feature:vega";options;cleanupFns=[];isLoaded=!1;loadPromise=null;constructor(e={}){this.options={embedCdnUrl:e.embedCdnUrl||"https://cdn.jsdelivr.net/npm/vega-embed@6",vegaCdnUrl:e.vegaCdnUrl||"https://cdn.jsdelivr.net/npm/vega@5",vegaLiteCdnUrl:e.vegaLiteCdnUrl||"https://cdn.jsdelivr.net/npm/vega-lite@5",theme:e.theme||"quartz",actions:e.actions??!1}}install(e){const t=e.on("domUpdated",({element:s})=>{this.processVegaBlocks(s)});this.cleanupFns.push(t)}destroy(){this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}async loadDependencies(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=(async()=>{window.vega||await import(this.options.vegaCdnUrl),window.vegaLite||await import(this.options.vegaLiteCdnUrl),window.vegaEmbed||await import(this.options.embedCdnUrl),this.isLoaded=!0})(),this.loadPromise)}async processVegaBlocks(e){const t=e.querySelectorAll("pre code.language-vega, pre code.language-vega-lite");if(t.length!==0){try{await this.loadDependencies()}catch(s){console.error("[VegaPlugin] Failed to load dependencies",s);return}await Promise.all(Array.from(t).map(async s=>{const n=s.parentElement;if(!n)return;const i=s.textContent||"",o=s.classList.contains("language-vega-lite"),a=document.createElement("div");a.className="mdx-vega-container";try{const r=JSON.parse(i);n.replaceWith(a),window.vegaEmbed&&await window.vegaEmbed(a,r,{mode:o?"vega-lite":"vega",theme:this.options.theme,actions:this.options.actions,renderer:"svg"})}catch(r){console.warn("[VegaPlugin] Render error:",r),a.innerHTML=`
          <div class="mdx-vega-error">
            <strong>Vega JSON Error:</strong> ${r.message}
          </div>
        `,a.appendChild(n.cloneNode(!0)),n.replaceWith(a)}}))}}}class Di{name="core:asset-resolver";priority=95;createdUrls=new Set;assetCache=null;CACHE_TTL=5e3;constructor(e={}){}install(e){e.on("domUpdated",async t=>{await this.resolveAssets(t.element,e)}),e.registerCommand?.("pruneAssets",async()=>await this.pruneUnusedAssets(e))}async resolveAssets(e,t){const s=t.getSessionEngine?.(),n=t.getOwnerNodeId?.();if(!s||!n)return;let i=null;try{i=await s.getAssetDirectoryId(n)}catch(c){console.debug("[AssetResolver] Failed to get asset dir ID:",c);return}if(!i)return;const o=await this.getAssetsMap(s,i);if(o.size===0)return;const a=e.querySelectorAll("[src], [href]"),r=[];for(const c of a){const d=c.hasAttribute("src")?"src":"href",h=c.getAttribute(d);if(!h||c.hasAttribute("data-original-src")||!h.startsWith("@asset/"))continue;const u=xe(h),p=o.get(u);p&&r.push(this.resolveElement(c,d,h,p,s))}await Promise.all(r)}async resolveElement(e,t,s,n,i){try{const o=await i.readContent(n.id);if(!o)return;const a=fe(n.name),r=new Blob([o],{type:a}),c=URL.createObjectURL(r);this.createdUrls.add(c),e.setAttribute(t,c),e.setAttribute("data-original-src",s),e.setAttribute("data-asset-id",n.id),e.tagName==="IMG"&&e.removeAttribute("srcset")}catch{console.warn("[AssetResolver] Resolve error:",n.name)}}async getAssetsMap(e,t){const s=Date.now();if(this.assetCache&&this.assetCache.dirId===t&&s-this.assetCache.timestamp<this.CACHE_TTL)return this.assetCache.assets;try{const n=await e.getChildren(t),i=new Map;for(const o of n)o.type==="file"&&i.set(o.name,o);return this.assetCache={dirId:t,assets:i,timestamp:s},i}catch{return new Map}}async pruneUnusedAssets(e){const t=e.getSessionEngine?.(),s=e.getOwnerNodeId?.();if(!t||!s)return 0;const n=await t.getAssetDirectoryId(s);if(!n)return 0;const o=e.pluginManager.editorInstance;if(!o)return 0;const a=o.getText(),r=new Set,c=/@asset\/([^\s)"']+)/g;let d;for(;(d=c.exec(a))!==null;)r.add(d[1]);const h=await this.getAssetsMap(t,n),u=[];for(const[p,m]of h)r.has(p)||u.push(m.id);return u.length>0&&(await t.delete(u),this.assetCache=null),u.length}destroy(){this.createdUrls.forEach(e=>URL.revokeObjectURL(e)),this.createdUrls.clear(),this.assetCache=null}}class $i{name="interaction:auto-save";options;timer=null;cleanupFns=[];constructor(e={}){this.options={delay:e.delay??2e3,saveOnBlur:e.saveOnBlur??!0}}install(e){const t=e.on("editorPostInit",({editor:s})=>{this.setupListeners(s,e)});t&&this.cleanupFns.push(t)}setupListeners(e,t){const s=e.on("interactiveChange",()=>{this.triggerDebouncedSave(e)});if(this.cleanupFns.push(s),this.options.saveOnBlur){const o=e.on("blur",()=>{this.triggerImmediateSave(e)});this.cleanupFns.push(o)}const n=()=>{document.visibilityState==="hidden"&&this.triggerImmediateSave(e)};document.addEventListener("visibilitychange",n),this.cleanupFns.push(()=>document.removeEventListener("visibilitychange",n));const i=()=>{e.isDirty()&&this.triggerImmediateSave(e)};window.addEventListener("beforeunload",i),this.cleanupFns.push(()=>window.removeEventListener("beforeunload",i)),t.registerCommand?.("save",()=>this.triggerImmediateSave(e))}triggerDebouncedSave(e){this.options.delay<=0||(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{e.save()},this.options.delay))}triggerImmediateSave(e){this.timer&&clearTimeout(this.timer),e.save()}destroy(){this.timer&&clearTimeout(this.timer),this.cleanupFns.forEach(e=>e()),this.cleanupFns=[]}}const ye=new Map;function N(l,e,t={}){ye.has(l),ye.set(l,{constructor:e,priority:t.priority??100,dependencies:t.dependencies??[]})}N("editor:core",Ft,{priority:1});N("core:titlebar",Ii,{priority:2});N("interaction:source-sync",Ci,{priority:60});N("ui:toolbar",xi,{priority:2});N("ui:formatting",_i,{priority:3,dependencies:["ui:toolbar"]});N("callout",ai,{priority:4});N("mathjax",si,{priority:5});N("folder",ti,{priority:6});N("media",ni,{priority:7});N("mermaid",ii,{priority:8});N("svg",Li,{priority:9});N("cloze:cloze",ui,{priority:10});N("cloze:cloze-controls",pi,{priority:20,dependencies:["cloze:cloze"]});N("cloze:memory",gi,{priority:20,dependencies:["cloze:cloze"]});N("interaction:table",wi,{priority:50});N("task-list",Si,{priority:51});N("codeblock-controls",Ei,{priority:52});N("autocomplete:tag",Mi,{priority:53});N("autocomplete:mention",Ni,{priority:54});N("interaction:clipboard",mi,{priority:55});N("interaction:upload",bi,{priority:60});N("plantuml",ri,{priority:70});N("vega",Ai,{priority:71});N("interaction:auto-save",$i,{priority:90});N("ui:asset-manager",Ti,{priority:90,dependencies:["core:titlebar"]});N("core:asset-resolver",Di,{priority:95});const ut=["core:asset-resolver","interaction:auto-save","interaction:clipboard","interaction:upload","ui:toolbar","ui:formatting","interaction:source-sync","interaction:table","folder","mathjax","media","callout","mermaid","svg","codeblock-controls","task-list"],Ri="-all";function Ae(l){return typeof l=="string"?l:Array.isArray(l)?l[0]:typeof l=="object"&&"name"in l&&!("install"in l)||typeof l=="object"&&"install"in l?l.name:""}function Pi(l){const e=[],t=new Map,s=new Map;for(const o of l)t.set(o,0),s.set(o,[]);for(const o of l){const a=ye.get(o);if(a)for(const r of a.dependencies)l.includes(r)?(s.get(r).push(o),t.set(o,(t.get(o)||0)+1)):console.warn(`Plugin "${o}" has a dependency "${r}" which is not in the current loading list. This dependency will be ignored.`)}const n=[];for(const o of l)t.get(o)===0&&n.push(o);const i=o=>ye.get(o)?.priority??100;for(;n.length>0;){n.sort((a,r)=>i(a)-i(r));const o=n.shift();e.push(o);for(const a of s.get(o)||[]){const r=(t.get(a)||1)-1;t.set(a,r),r===0&&n.push(a)}}if(e.length!==l.length){const o=l.filter(a=>!e.includes(a));console.warn(`Circular or missing dependency for: ${o.join(", ")}`),e.push(...o)}return e}async function Ze(l,e={}){const t=e.plugins||[],s=e.defaultPluginOptions?.["core:titlebar"]||{},i=(t.includes("core:titlebar")||ut.includes("core:titlebar"))&&s.enableAssetManager!==!1,o=t.some(b=>Ae(b)==="ui:asset-manager");i&&!o&&t.push("ui:asset-manager"),e.plugins=t;let a=e.onSave;if(!a&&e.hostContext&&e.nodeId&&(a=async b=>{await e.hostContext.saveContent(e.nodeId,b)}),e.onSave=a,e.defaultPluginOptions=e.defaultPluginOptions||{},e.hostContext){const b=e.defaultPluginOptions["core:titlebar"]||{};e.defaultPluginOptions["core:titlebar"]={...b,onSidebarToggle:b.onSidebarToggle||(E=>e.hostContext?.toggleSidebar()),saveCallback:async E=>{await E.save()}}}const r=new Zn(e),c=e.defaultPluginOptions?.["editor:core"]||{},d=new Ft(c);r.use(d);let h=ut;t.length>0&&Ae(t[0])===Ri&&(h=[],t.shift());const u=[...h,...t],p=new Map,m=new Set;for(const b of u){const E=Ae(b);if(!E){console.warn("Invalid plugin configuration encountered:",b);continue}if(E.startsWith("-")){m.add(E.substring(1));continue}p.set(E,b),E==="cloze:cloze"&&(p.has("cloze:cloze-controls")||p.set("cloze:cloze-controls","cloze:cloze-controls"),p.has("cloze:memory")||p.set("cloze:memory","cloze:memory"))}for(const b of m)p.delete(b);const g=Array.from(p.keys()),y=Pi(g);for(const b of y){const E=p.get(b);try{let k=null;if(typeof E=="object"&&"install"in E)k=E;else{const F=ye.get(b);if(!F){console.warn(`Plugin with name "${b}" not found in registry.`);continue}const B=F.constructor;let v={};if(typeof E=="string")v=e.defaultPluginOptions?.[b]||{};else if(Array.isArray(E)){const[,L]=E;v={...e.defaultPluginOptions?.[b]||{},...L}}else if(typeof E=="object"&&"name"in E){const{options:L={}}=E;v={...e.defaultPluginOptions?.[b]||{},...L}}k=new B(v)}k&&r.use(k)}catch(k){console.error(`Failed to instantiate plugin "${b}" with config:`,E,k)}}return await r.init(l,e.initialContent||""),r}const Oi=async(l,e)=>{const t={...e,plugins:["core:titlebar","interaction:auto-save",...e.plugins||[]],initialMode:"render",defaultPluginOptions:{...e.defaultPluginOptions,"core:titlebar":{title:e.title||"Untitled",enableToggleEditMode:!0,...e.defaultPluginOptions?.["core:titlebar"]||{}}}};return await Ze(l,t)};class Fi{providerRegistry=new Map;constructor(e=[]){e.forEach(t=>this.register(t))}register(e){if(!e||!e.key){const t=e?e.constructor.name:"undefined";throw new Error(`[MDxProcessor] Mention provider instance (${t}) is invalid or missing the required 'key' property.`)}this.providerRegistry.set(e.key,e)}async process(e,t){let s={},n=e;try{if(e.trimStart().startsWith("---")){const r=Us(e);s=r.attributes,n=r.body}}catch{n=e}const i={...s},o=this._findAllMentions(n);await this._resolveMentionData(o);const a=this._applyTransformations(n,o,t,i);return{originalContent:e,transformedContent:a,mentions:o.sort((r,c)=>r.index-c.index),metadata:i}}_findAllMentions(e){const t=/@(\w+):(\S+)|\[[^\]]+\]\(mdx:\/\/(\w+)\/([^)]+)\)/g;return Array.from(e.matchAll(t)).map(s=>{const n=!!s[1],i=n?s[1]:s[3],o=n?s[2]:s[4];return{raw:s[0],type:i,id:o,uri:`mdx://${i}/${o}`,index:s.index,data:null}})}async _resolveMentionData(e){await Promise.all(e.map(async t=>{const s=this.providerRegistry.get(t.type);if(s?.getDataForProcess)try{t.data=await s.getDataForProcess(new URL(t.uri))}catch(n){console.error(`[MDxProcessor] Provider "${t.type}" failed to get data for "${t.uri}":`,n),t.data=null}}))}_applyTransformations(e,t,s,n){let i=e;const o=[...t].sort((a,r)=>r.index-a.index);for(const a of o){const r=s.rules[a.type]||s.rules["*"];if(!r)continue;r.collectMetadata&&a.id&&(n[a.type]||(n[a.type]=[]),n[a.type].includes(a.id)||n[a.type].push(a.id));let c="";switch(r.action){case"replace":c=r.getReplacementContent?r.getReplacementContent(a.data,a):a.raw;break;case"keep":c=a.raw;break}const d=a.index,h=d+a.raw.length;i=i.slice(0,d)+c+i.slice(h)}return i.trim()}}class Bi{constructor(e,t=["*"]){this.engine=e;const s=new jn({engine:this.engine});this.processor=new Fi([s])}processor;isProcessing=!1;debounceTimers=new Map;unsubscribe=null;start(){console.log("🧠 [BackgroundBrain] Started."),this.unsubscribe=this.engine.on("node:updated",this.handleNodeUpdate)}stop(){this.unsubscribe?.(),this.debounceTimers.forEach(clearTimeout),this.debounceTimers.clear(),console.log("🧠 [BackgroundBrain] Stopped.")}handleNodeUpdate=e=>{if(e.payload.data?.metadataOnly)return;const t=e.payload.nodeId;this.debounceTimers.has(t)&&clearTimeout(this.debounceTimers.get(t)),this.debounceTimers.set(t,setTimeout(async()=>{this.debounceTimers.delete(t),await this.processNode(t)},2e3))};async processNode(e){if(!this.isProcessing)try{const t=await this.engine.getNode(e);if(!t||t.type!=="file")return;const s=t.metadata?._ai_last_scan,n=new Date(t.modifiedAt).getTime();if(s&&s>=n)return;this.isProcessing=!0;const i=await this.engine.readContent(e);if(typeof i!="string")return;const o=await this.processor.process(i,{rules:{user:{action:"keep",collectMetadata:!0},tag:{action:"keep",collectMetadata:!0},file:{action:"keep",collectMetadata:!0},"*":{action:"keep"}}}),a={...t.metadata||{},...o.metadata,_ai_last_scan:Date.now(),_ai_processed:!0};await this.engine.updateMetadata(e,a),console.log(`🧠 [BackgroundBrain] Processed ${e}`)}catch(t){console.error("[BackgroundBrain] Error:",t)}finally{this.isProcessing=!1}}}class Ui{constructor(e){this.container=e,this.container.innerHTML="",this.container.classList.add("mm-layout"),this.sidebarContainer=document.createElement("div"),this.sidebarContainer.className="mm-sidebar",this.editorContainer=document.createElement("div"),this.editorContainer.className="mm-editor-area",this.container.appendChild(this.sidebarContainer),this.container.appendChild(this.editorContainer)}sidebarContainer;editorContainer;toggleSidebar(e){e?this.sidebarContainer.classList.add("is-collapsed"):this.sidebarContainer.classList.remove("is-collapsed"),setTimeout(()=>{window.dispatchEvent(new Event("resize"))},310)}destroy(){this.container.innerHTML="",this.container.classList.remove("mm-layout")}}class Hi{constructor(e){if(this.config=e,this.layout=new Ui(e.container),e.customEngine)this.engine=e.customEngine;else if(e.moduleName)this.engine=new Lt(e.moduleName);else throw new Error("Missing engine configuration");this.baseEditorFactory=e.editorFactory||Ze;const t=e.scopeId||e.moduleName||"default";this.vfsUI=Wn({...e.uiOptions,scopeId:t,sessionListContainer:this.layout.sidebarContainer,defaultFileName:e.defaultContentConfig?.fileName,defaultFileContent:e.defaultContentConfig?.content,defaultEditorFactory:this.enhancedEditorFactory,fileTypes:e.fileTypes,customEditorResolver:e.customEditorResolver},this.engine),e.aiConfig?.enabled&&(this.brain=new Bi(this.engine,e.aiConfig.activeRules),this.brain.start());const s={toggleSidebar:n=>{this.vfsUI.toggleSidebar()},saveContent:async(n,i)=>{await this.engine.writeContent(n,i)},navigate:async n=>{console.log(`[MemoryManager:${this.config.scopeId}] Handling navigation:`,n),this.config.onNavigate?await this.config.onNavigate(n):console.warn("[MemoryManager] onNavigate callback is missing in config.")}};this.lifecycleUnsubscribe=Vn(this.vfsUI,this.engine,this.layout.editorContainer,this.enhancedEditorFactory,{hostContext:s,...e.editorConfig}),this.bindLayoutEvents(),this.bindInternalEvents()}vfsUI;engine;brain;layout;lifecycleUnsubscribe;baseEditorFactory;enhancedEditorFactory=async(e,t)=>{const{editorConfig:s}=this.config,n={...s,...t,plugins:[...s?.plugins||[],...t?.plugins||[]],defaultPluginOptions:{...s?.defaultPluginOptions||{},...t?.defaultPluginOptions||{}},sessionEngine:this.engine};return this.baseEditorFactory(e,n)};bindLayoutEvents(){const e=this.vfsUI.on("sidebarStateChanged",({isCollapsed:s})=>{this.layout.toggleSidebar(s)}),t=this.destroy;this.destroy=()=>{e(),t.call(this)}}bindInternalEvents(){this.vfsUI.on("sessionSelected",e=>{const t=e.item?e.item.id:null;this.config.onSessionChange&&this.config.onSessionChange(t)})}async start(){await this.engine.init(),await this.vfsUI.start(),this.config.moduleName}async openFile(e){await this.vfsUI.store.dispatch({type:"SESSION_SELECT",payload:{sessionId:e}})}getActiveSessionId(){const e=this.vfsUI.getActiveSession();return e?e.id:null}destroy(){this.lifecycleUnsubscribe(),this.vfsUI.destroy(),this.brain?.stop(),this.layout.destroy()}}const as=[{elementId:"settings-workspace",moduleName:"settings_root",type:"settings",title:"Settings",supportedFileTypes:[],readOnly:!0,aiEnabled:!1,initialSidebarCollapsed:!1},{elementId:"agent-workspace",moduleName:Qe,type:"agent",title:"Agents",supportedFileTypes:["agent"],plugins:["core:titlebar"],mentionScope:["agents","prompts","projects"],aiEnabled:!1},{elementId:"anki-workspace",moduleName:"anki",type:"standard",title:"Anki Memory Cards",supportedFileTypes:["anki","markdown"],plugins:["cloze:cloze","cloze:cloze-controls","autocomplete:mention","autocomplete:tag"],mentionScope:["*"],aiEnabled:!0},{elementId:"prompt-workspace",moduleName:"prompts",type:"standard",title:"Prompt Library",supportedFileTypes:["prompt"],aiEnabled:!0},{elementId:"project-workspace",moduleName:"projects",type:"standard",title:"Projects",supportedFileTypes:["project"],aiEnabled:!0},{elementId:"email-workspace",moduleName:"emails",type:"standard",title:"Email Drafts",supportedFileTypes:["email"],aiEnabled:!0},{elementId:"private-workspace",moduleName:"private",isProtected:!0,type:"standard",title:"Private Notes",supportedFileTypes:["private"],mentionScope:[],aiEnabled:!0},{elementId:"llm-workspace",moduleName:Nt,type:"chat",title:"AI Sessions",supportedFileTypes:["chat"],mentionScope:["*"],plugins:[],aiEnabled:!1}];let te=null;async function zi(){if(te)return te;console.log("Initializing VFS..."),te=await Ys("MindOS");for(const l of as)if(!te.getModule(l.moduleName))try{await te.mount(l.moduleName,{description:l.title,isProtected:l.isProtected}),console.log(`Mounted module: ${l.moduleName} (Protected: ${!!l.isProtected})`)}catch(t){console.error(`Failed to mount ${l.moduleName}`,t)}return te}const G="__config",pt=["__config","__vfs_meta__","settings_ui",Qe],gt="snapshot_",se={tags:"/tags.json",contacts:"/contacts.json",sync:"/sync_config.json"};class qi{vfs;state={tags:[],contacts:[]};syncConfig={serverUrl:"",username:"",strategy:"manual",autoSync:!1};syncStatus={state:"idle",lastSyncTime:null};listeners=new Set;initialized=!1;syncTimer=null;constructor(e){this.vfs=e}async init(){if(!this.initialized){if(!this.vfs.getModule(G))try{await this.vfs.mount(G,"Settings Persistence")}catch(e){if(e.code!==x.ALREADY_EXISTS)throw e}await Promise.all([this.loadEntity("contacts"),this.syncTags(),this.loadSyncConfig()]),this.bindVFSEvents(),this.initialized=!0,this.notify()}}bindVFSEvents(){const e=this.vfs.getEventBus(),t=s=>{s.path&&s.path.startsWith(`/${G}`)||(this.syncTimer&&clearTimeout(this.syncTimer),this.syncTimer=setTimeout(()=>{this.syncTags().then(()=>this.notify()),this.syncConfig.autoSync&&this.syncStatus.state!=="syncing"&&this.syncConfig.serverUrl&&(console.log("[AutoSync] Triggered"),this.triggerSync().catch(n=>console.error("AutoSync failed",n)))},2e3))};[M.NODE_CREATED,M.NODE_UPDATED,M.NODE_DELETED].forEach(s=>e.on(s,t))}async loadEntity(e){const t=se[e];try{const s=await this.vfs.read(G,t),n=typeof s=="string"?s:new TextDecoder().decode(s);this.state[e]=JSON.parse(n)}catch(s){s.code===x.NOT_FOUND?this.state[e]=[]:console.error(`Failed to load ${e}`,s)}}async saveEntity(e){const t=se[e],s=JSON.stringify(this.state[e],null,2);try{await this.vfs.write(G,t,s)}catch(n){if(n.code===x.NOT_FOUND)await this.vfs.createFile(G,t,s);else throw n}e!=="tags"&&this.notify()}getContacts(){return[...this.state.contacts]}async saveContact(e){this.updateOrAdd(this.state.contacts,e),await this.saveEntity("contacts")}async deleteContact(e){this.state.contacts=this.state.contacts.filter(t=>t.id!==e),await this.saveEntity("contacts"),this.notify()}getTags(){return[...this.state.tags]}async syncTags(){try{let e=[];try{const o=await this.vfs.read(G,se.tags),a=typeof o=="string"?o:new TextDecoder().decode(o);e=JSON.parse(a)}catch{}const s=(await this.vfs.getAllTags()).map(o=>{const a=e.find(r=>r.name===o.name);return{id:o.name,name:o.name,color:o.color||a?.color||"#3b82f6",description:a?.description||"",count:o.refCount||0}}),n=JSON.stringify(this.state.tags);this.state.tags=s;const i=JSON.stringify(this.state.tags);this.saveEntity("tags").catch(o=>console.error("Failed to save merged tags",o)),n!==i&&this.initialized&&this.notify()}catch(e){console.error("[SettingsService] Failed to sync tags:",e)}}async saveTag(e){await this.vfs.updateTag(e.name,{color:e.color}),this.updateOrAdd(this.state.tags,e),await this.saveEntity("tags")}async deleteTag(e){const t=this.state.tags.find(s=>s.id===e);t&&(await this.vfs.deleteTagDefinition(t.name),this.state.tags=this.state.tags.filter(s=>s.id!==e),await this.saveEntity("tags"),this.notify())}async getSyncConfig(){return{...this.syncConfig}}async getSyncStatus(){return{...this.syncStatus}}async loadSyncConfig(){try{const e=await this.vfs.read(G,se.sync),t=typeof e=="string"?e:new TextDecoder().decode(e),s=JSON.parse(t);this.syncConfig={...this.syncConfig,...s}}catch{}}async saveSyncConfig(e){this.syncConfig=e;try{await this.vfs.write(G,se.sync,JSON.stringify(e,null,2))}catch(t){t.code===x.NOT_FOUND&&await this.vfs.createFile(G,se.sync,JSON.stringify(e,null,2))}}async testConnection(e,t,s){try{return(await fetch(`${e}/api/sync/check`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify([])})).ok}catch(n){return console.error(n),!1}}async triggerSync(e="standard"){if(!this.syncConfig.serverUrl)throw new Error("No server URL");const t=this.syncConfig.token;if(!t)throw new Error("No Access Token configured");try{this.syncStatus={state:"syncing",lastSyncTime:this.syncStatus.lastSyncTime},this.notify();const s=await this.indexAllLocalFiles();let n=[],i=[];if(e==="force_push")console.log("[Sync] Force Push Mode: Uploading all local files..."),n=s.map(o=>o.path),i=[];else if(e==="force_pull"){console.log("[Sync] Force Pull Mode: Downloading all server files...");const o=await this.checkDiff([],t);n=[],i=o.files_to_download}else{console.log("[Sync] Standard Mode: Checking diff...");const o=await this.checkDiff(s,t);this.syncConfig.strategy!=="pull"&&(n=o.files_to_upload),this.syncConfig.strategy!=="push"&&(i=o.files_to_download)}console.log(`[Sync] Plan: Upload ${n.length}, Download ${i.length}`);for(const o of n)await this.uploadFile(o,t);for(const o of i)await this.downloadFile(o,t);this.syncStatus={state:"success",lastSyncTime:Date.now()}}catch(s){throw console.error("Sync Error",s),this.syncStatus={state:"error",lastSyncTime:this.syncStatus.lastSyncTime,errorMessage:s.message},s}finally{this.notify()}}async checkDiff(e,t){const s=await fetch(`${this.syncConfig.serverUrl}/api/sync/check`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(!s.ok)throw new Error("Sync check failed (Invalid Token or Server Error)");return await s.json()}async indexAllLocalFiles(){const e=[],t=this.vfs.getAllModules().filter(n=>!pt.includes(n.name)),s=this.vfs.getVFS();for(const n of t){const i=this.vfs.getModule(n.name);if(i&&i.rootNodeId){const o=await s.storage.loadVNode(i.rootNodeId);o&&await this._traverseAndIndex(s,n.name,o,e)}}return e}async _traverseAndIndex(e,t,s,n){if(s.type===I.FILE){const i=await e.read(s.nodeId);let o;typeof i=="string"?o=new TextEncoder().encode(i).buffer:o=i;const a=await this.computeSHA256(o);n.push({path:s.path,hash:a,mtime:s.modifiedAt,is_deleted:!1})}else if(s.type===I.DIRECTORY){const i=await e.readdir(s.nodeId);for(const o of i)await this._traverseAndIndex(e,t,o,n)}}async uploadFile(e,t){try{const s=this.vfs.getVFS(),n=await s.storage.getNodeIdByPath(e);if(n){const i=await s.read(n),o=new Blob([i]),a=new FormData;a.append(e,o),await fetch(`${this.syncConfig.serverUrl}/api/sync/upload`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:a})}}catch(s){console.warn(`Failed to upload ${e}`,s)}}async downloadFile(e,t){try{const s=await fetch(`${this.syncConfig.serverUrl}/api/sync/download`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({path:e.path})});if(!s.ok)throw new Error("Download failed");const n=await s.arrayBuffer(),i=e.path.split("/"),o=i[1],a=`/${i.slice(2).join("/")}`;this.vfs.getModule(o)&&(await this.vfs.write(o,a,n),await this.vfs.getVFS().pathResolver.resolve(o,a)&&await this.vfs.updateMetadata(o,a,{syncedAt:e.mtime}))}catch(s){console.error(`Failed to download ${e.path}`,s)}}async computeSHA256(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(n=>n.toString(16).padStart(2,"0")).join("")}async exportMixedData(e,t){const s={version:2,timestamp:Date.now(),type:"mixed_backup",settings:{},modules:[]};e.includes("tags")&&(s.settings.tags=this.state.tags),e.includes("contacts")&&(s.settings.contacts=this.state.contacts);for(const n of t)try{const i=await this.vfs.exportModule(n);s.modules.push(i)}catch(i){console.warn(`Failed to export module ${n}`,i)}return s}async importMixedData(e,t,s,n={}){const i=[];e.settings&&(t.includes("tags")&&e.settings.tags&&(this.state.tags=e.settings.tags,i.push(this.saveEntity("tags"))),t.includes("contacts")&&e.settings.contacts&&(this.state.contacts=e.settings.contacts,i.push(this.saveEntity("contacts"))));const o=e.modules||[];if(Array.isArray(o)){const a=o.filter(r=>r.module&&s.includes(r.module.name));if(a.length>0){const r={version:e.version,timestamp:e.timestamp,modules:a};await this.vfs.restoreSystemBackupIncrementally(JSON.stringify(r),n)}}i.length>0&&await Promise.all(i),await this.syncTags(),this.notify()}async listLocalSnapshots(){if(!window.indexedDB.databases)return[];const e=await window.indexedDB.databases(),t=[];for(const s of e)if(s.name&&s.name.startsWith(gt)){const n=s.name.split("_"),i=parseInt(n[1]);isNaN(i)||t.push({name:s.name,displayName:new Date(i).toLocaleString(),createdAt:i,size:0})}return t.sort((s,n)=>n.createdAt-s.createdAt)}async createSnapshot(){const e=this.vfs.dbName,t=`${gt}${Date.now()}`;await z.copyDatabase(e,t)}async restoreSnapshot(e){const t=this.vfs.dbName;await this.vfs.shutdown(),await z.copyDatabase(e,t)}async deleteSnapshot(e){return new Promise((t,s)=>{const n=window.indexedDB.deleteDatabase(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error),n.onblocked=()=>console.warn(`Delete ${e} blocked`)})}async createFullBackup(){return this.vfs.createSystemBackup()}async restoreFullBackup(e){await this.vfs.restoreSystemBackup(e),this.initialized=!1,await this.init()}async factoryReset(){await this.vfs.systemReset()}updateOrAdd(e,t){const s=e.findIndex(n=>n.id===t.id);s>=0?e[s]=t:e.push(t),this.notify()}onChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}getAvailableSettingsKeys(){return["tags","contacts"]}getAvailableWorkspaces(){return this.vfs.getAllModules().filter(e=>!pt.includes(e.name)).map(e=>({name:e.name,description:e.description}))}}const De={storage:{name:"Storage",icon:"💾"},tags:{name:"Tags",icon:"🏷️"},contacts:{name:"Contacts",icon:"📒"},connections:{name:"Connections",icon:"🔗"},"mcp-servers":{name:"MCP Servers",icon:"🔌"},about:{name:"About",icon:"ℹ️"}};class ji{constructor(e){this.service=e}moduleName="settings_root";listeners=new Map;async init(){}async loadTree(){return await this.service.init(),Object.entries(De).map(([e,t])=>({id:e,parentId:null,name:t.name,type:"file",icon:t.icon,content:"",size:0,createdAt:Date.now(),modifiedAt:Date.now(),path:`/${t.name}`,moduleId:"settings_ui"}))}async getChildren(e){return[]}async readContent(e){return e}async search(e){if(!e.text)return[];const t=e.text.toLowerCase();return Object.entries(De).filter(([s,n])=>n.name.toLowerCase().includes(t)).map(([s,n])=>({id:s,parentId:null,name:n.name,type:"file",path:`/${n.name}`,size:0,createdAt:Date.now(),modifiedAt:Date.now()}))}async getNode(e){const t=De[e];return t?{id:e,parentId:null,name:t.name,type:"file",icon:t.icon,path:`/${t.name}`,size:0,createdAt:Date.now(),modifiedAt:Date.now()}:null}async writeContent(e,t){console.warn("Direct write to SettingsEngine ignored. Use SettingsService.")}async updateMetadata(e,t){}async createFile(e,t,s){throw new Error("Cannot create new settings pages.")}async createDirectory(e,t){throw new Error("Cannot create directories in settings.")}async createAsset(e,t,s){throw new Error("Assets are not supported in settings engine.")}async getAssetDirectoryId(e){return null}async rename(e,t){throw new Error("Cannot rename settings.")}async move(e,t){throw new Error("Cannot move settings.")}async delete(e){throw new Error("Cannot delete settings.")}async setTags(e,t){}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e).delete(t)}}class _e{static formatTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}static renderUserBubble(e,t,s=!1){const n=s?"is-collapsed":"",i=this.formatTime(e.timestamp),o=e.siblingIndex??0,a=e.siblingCount??1,c=a>1?`
            <button class="llm-icon-btn" data-action="prev-sibling" title="Previous" ${o===0?"disabled":""}>←</button>
            <span class="llm-ui-branch-indicator">${o+1}/${a}</span>
            <button class="llm-icon-btn" data-action="next-sibling" title="Next" ${o===a-1?"disabled":""}>→</button>
            <div class="llm-ui-sep" style="width:1px;background:rgba(255,255,255,0.2);margin:0 4px;"></div>
        `:"";return`
            <div class="llm-ui-bubble llm-ui-bubble--user ${n}">
                <div class="llm-ui-bubble__header">
                    <div class="llm-ui-avatar">👤</div>
                    
                    <div class="llm-ui-header-preview">${T(t)}</div>
                    <div class="llm-ui-time">${i}</div>

                    <!-- 使用 margin-left: auto 将 actions 推到右边 -->
                    <div class="llm-ui-actions" style="margin-left: auto; display: flex; gap: 4px;">
                         ${c}
                         
                         <button class="llm-icon-btn" data-action="delete" title="Delete">🗑️</button>
                         <button class="llm-icon-btn" data-action="resend" title="Resend">↻</button>
                         <button class="llm-icon-btn" data-action="edit" title="Edit">✎</button>
                         <button class="llm-icon-btn" data-action="copy" title="Copy">📋</button>
                         <button class="llm-icon-btn" data-action="collapse" title="Toggle">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                ${s?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>'}
                            </svg>
                         </button>
                    </div>
                </div>
                <div class="llm-ui-bubble__content">
                    <!-- ✨ [移除] 移除了 <div class="llm-ui-files">...</div> -->
                    
                    <div class="llm-ui-mount-point" id="user-mount-${e.id}"></div>
                    
                    <div class="llm-ui-edit-actions" style="display:none;">
                        <button class="llm-btn llm-btn--primary" data-action="confirm-edit">Save & Run</button>
                        <button class="llm-btn" data-action="save-only">Save Only</button>
                        <button class="llm-btn" data-action="cancel-edit">Cancel</button>
                    </div>
                </div>
            </div>
        `}static renderAgentHeader(e,t,s,n=!1){const i=this.formatTime(e.startTime),o=e.data.metaInfo?.siblingIndex??0,a=e.data.metaInfo?.siblingCount??1,c=a>1?`
            <button class="llm-icon-btn" data-action="prev-sibling" title="Previous" ${o===0?"disabled":""}>←</button>
            <span class="llm-ui-branch-indicator">${o+1}/${a}</span>
            <button class="llm-icon-btn" data-action="next-sibling" title="Next" ${o===a-1?"disabled":""}>→</button>
            <div class="llm-ui-sep"></div>
        `:"",d=e.data.metaInfo?.agentId;return`
            <div class="llm-ui-node__header">
                <div class="llm-ui-node__status-icon">
                    <div class="llm-ui-spinner"></div>
                    <div class="llm-ui-status-dot"></div>
                </div>
                ${e.executorType==="agent"&&d?`<div class="llm-ui-node__icon llm-ui-node__icon--clickable" title="Edit Agent" data-agent-id="${T(d)}">${s}</div>`:`<div class="llm-ui-node__icon">${s}</div>`}
                <div class="llm-ui-node__title">${T(e.name)}</div>
                
                <div class="llm-ui-header-preview">${T(t)}</div>
                
                <div class="llm-ui-node__meta">
                    <span class="llm-ui-time">${i}</span>
                    <span class="llm-ui-node__status">${e.status}</span>
                </div>

                <!-- 使用 margin-left: auto 将 actions 推到右边 -->
                <div class="llm-ui-actions" style="margin-left: auto; display: flex; gap: 4px;">
                ${c}
                    <button class="llm-icon-btn" data-action="delete" title="Delete">🗑️</button>
                    <!-- 新增 Edit 按钮 (用于修改输出结果) -->
                    <button class="llm-icon-btn" data-action="retry" title="Retry">↻</button>
                    <button class="llm-icon-btn" data-action="edit" title="Edit Result">✎</button>
                    <button class="llm-icon-btn" data-action="copy" title="Copy">📋</button>
                    <button class="llm-icon-btn" data-action="collapse" title="Toggle">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            ${n?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>'}
                        </svg>
                    </button>
                </div>
            </div>
        `}static renderThinking(e,t){return`
            <div class="llm-ui-thought" style="display: ${t?"block":"none"}">
                <div class="llm-ui-thought__label">Thinking Process</div>
                <div class="llm-ui-thought__content">${T(e).replace(/\n/g,"<br>")}</div>
            </div>
        `}static renderTool(e,t){const s=JSON.stringify(e.data.input||{},null,2),n=JSON.stringify(e.data.toolCall?.result||{},null,2);return`
            <div class="llm-ui-node__header">
                <div class="llm-ui-node__icon">${t}</div>
                <div class="llm-ui-node__title">${T(e.name)}</div>
                <div class="llm-ui-node__status">${e.status}</div>
                <div class="llm-ui-actions">
                    <button class="llm-icon-btn" data-action="collapse">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="llm-ui-node__body">
                <div class="llm-ui-code-block">Input: ${T(s)}</div>
                <div class="llm-ui-code-block llm-ui-node__result" style="display:${e.status==="success"?"block":"none"}">
                    Result: ${T(n)}
                </div>
            </div>
        `}}class mt{static getIcon(e){if(e.data.metaInfo?.agentIcon)return e.data.metaInfo.agentIcon;if(e.data.metaInfo?.agentId==="default")return"🤖";switch(e.executorType){case"agent":return"🤖";case"tool":return"🔧";case"composite":return"🔀";case"http":return"🌐";case"script":return"📜";default:return"📄"}}static getLayoutClass(e){return e.data.metaInfo?.executionMode==="concurrent"?"llm-ui-layout--grid":"llm-ui-layout--list"}}class Vi{static create(e){const t=document.createElement("div"),s=mt.getIcon(e),n=mt.getLayoutClass(e);t.className=`llm-ui-node llm-ui-node--${e.executorType} ${n}`,t.dataset.id=e.id,t.dataset.status=e.status;const i={};return e.executorType==="agent"||e.executorType==="composite"?this.renderAgent(t,e,i,s):e.executorType==="tool"?t.innerHTML=_e.renderTool(e,s):this.renderAgent(t,e,i,s),{element:t,mountPoints:i}}static renderAgent(e,t,s,n){const i=!!(t.data.thought&&t.data.thought.length>0),o=t.data.output?t.data.output.substring(0,50).replace(/\n/g," "):"",a=t.status==="failed"&&t.data.error?`<div class="llm-ui-node__error-embed">
                 ⚠️ ${T(t.data.error)}
               </div>`:"";e.innerHTML=`
            ${_e.renderAgentHeader(t,o,n)}

            <div class="llm-ui-node__body">
                ${_e.renderThinking(t.data.thought||"",i)}
                ${a}

                <div class="llm-ui-node__output">
                    <div class="llm-ui-mount-point" id="mount-${t.id}"></div>
                </div>

                <div class="llm-ui-node__children"></div>
            </div>
        `,s.output=e.querySelector(`#mount-${t.id}`)}}class ft{editor=null;container;currentContent="";isStreaming=!1;isReadOnly=!0;onChangeCallback;isStreamingInit=!1;options;isInitialized=!1;pendingChunks=[];readyPromise;readyResolve;readyReject;RENDER_INTERVAL=150;lastRenderTime=0;rafId=null;renderScheduled=!1;contentSnapshot="";constructor(e,t,s){this.container=e,this.currentContent=t,this.options=s||{},this.isReadOnly=s?.readOnly??!0,this.onChangeCallback=s?.onChange,this.isStreamingInit=s?.streaming??!1,this.readyPromise=new Promise((n,i)=>{this.readyResolve=n,this.readyReject=i}),this.init()}async waitUntilReady(){return this.readyPromise}async init(){try{this.editor=await Ze(this.container,{initialContent:this.currentContent,initialMode:this.isReadOnly?"render":"edit",nodeId:this.options.nodeId,ownerNodeId:this.options.ownerNodeId,sessionEngine:this.options.sessionEngine,plugins:["editor:core","ui:formatting","mathjax","mermaid","codeblock-controls","task-list","media","svg","ui:toolbar"],defaultPluginOptions:{"codeblock-controls":{defaultCollapsed:!this.isStreamingInit}}}),this.editor.on("change",()=>{if(!this.isStreaming){const e=this.editor.getText();this.currentContent=e,this.onChangeCallback?.(e)}}),this.isInitialized=!0,console.log("[MDxController] init() completed"),this.pendingChunks.length>0&&(console.log("[MDxController] Applying pending chunks, count:",this.pendingChunks.length),this.pendingChunks=[],await this.editor.setStreamingText(this.currentContent)),this.readyResolve()}catch(e){console.error("[MDxController] init() failed:",e),this.readyReject(e)}}appendStream(e){if(this.isStreaming=!0,this.currentContent+=e,!this.isInitialized||!this.editor){this.pendingChunks.push(e);return}this.scheduleRender()}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.rafId=null;const t=Date.now()-this.lastRenderTime;if(t>=this.RENDER_INTERVAL)this.doRender();else{const s=this.RENDER_INTERVAL-t;setTimeout(()=>this.doRender(),s)}}))}async doRender(){if(this.renderScheduled=!1,!(!this.editor||!this.isInitialized)&&this.currentContent!==this.contentSnapshot)try{this.container.style.contain="content",await this.editor.setStreamingText(this.currentContent),this.contentSnapshot=this.currentContent,this.lastRenderTime=Date.now()}catch(e){console.error("[MDxController] Render failed:",e)}finally{this.container.style.contain=""}}finishStream(e=!1){this.isStreaming=!1,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.renderScheduled=!1,this.editor&&this.isInitialized&&this.editor.setStreamingText(this.currentContent).catch(console.error),e&&this.onChangeCallback?.(this.currentContent)}async toggleEdit(){if(!this.editor)return;this.isReadOnly=!this.isReadOnly;const e=this.isReadOnly?"render":"edit";await this.editor.switchToMode(e),this.isReadOnly||this.editor.focus()}get content(){return this.currentContent}setContent(e){this.currentContent=e,this.contentSnapshot=e,this.isInitialized&&this.editor&&this.editor.setText(e)}isEditing(){return!this.isReadOnly}async setMode(e){if(!this.editor)return;const t=e==="render";this.isReadOnly!==t&&(this.isReadOnly=t,await this.editor.switchToMode(e))}destroy(){this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.editor?.destroy(),this.editor=null,this.isInitialized=!1,this.pendingChunks=[],this.renderScheduled=!1}}const Wi={renderWorkspace:l=>`
        <div class="llm-workspace-titlebar">
            <div class="llm-workspace-titlebar__left">
                <button class="llm-workspace-titlebar__btn" id="llm-btn-sidebar" title="Toggle Sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                </button>
                
                <div class="llm-workspace-titlebar__sep"></div>
                
                <input type="text" class="llm-workspace-titlebar__input" id="llm-title-input" value="${T(l)}" placeholder="Untitled Chat" />
            </div>

            <div class="llm-workspace-titlebar__right">
                <button class="llm-workspace-titlebar__btn" id="llm-btn-collapse" title="Collapse/Expand All Messages">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline></svg>
                </button>

                <button class="llm-workspace-titlebar__btn" id="llm-btn-copy" title="Copy as Markdown">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>

                <button class="llm-workspace-titlebar__btn" id="llm-btn-print" title="Print">
                        <i class="fas fa-print"></i>
                </button>
            </div>
        </div>

        <div class="llm-ui-workspace__history" id="llm-ui-history"></div>
        <div class="llm-ui-workspace__input" id="llm-ui-input"></div>
    `,renderWelcome:()=>`
        <div class="llm-ui-welcome">
            <div class="llm-ui-welcome__icon">👋</div>
            <h2>Ready to chat</h2>
            <p>Send a message to start the conversation</p>
        </div>
    `,renderErrorBanner:l=>`
        <div class="llm-ui-banner llm-ui-banner--error">
            Error: ${T(l)}
        </div>
    `};async function Gi(l){return new Promise(e=>{let t=!1;new R("Confirmation",`<p>${T(l)}</p>`,{type:"danger",confirmText:"Delete",cancelText:"Cancel",onConfirm:()=>(t||(t=!0,e(!0)),!0),onCancel:()=>(t||(t=!0,e(!1)),!0)}).show()})}class Ji{nodeMap=new Map;editorMap=new Map;container;shouldAutoScroll=!0;scrollThreshold=150;scrollFrameId=null;resizeObserver;isStreamingMode=!1;lastScrollHeight=0;scrollLockUntil=0;previewUpdateTimers=new Map;PREVIEW_UPDATE_INTERVAL=200;onContentChange;onNodeAction;originalContentMap=new Map;editingNodes=new Set;renderedSessionIds=new Set;contextOptions;constructor(e,t,s,n){this.container=e,this.onContentChange=t,this.onNodeAction=s,this.contextOptions=n||{},this.container.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.scrollFrameId===null&&(this.scrollFrameId=requestAnimationFrame(()=>{this.scrollFrameId=null,this.handleResize()}))}),this.resizeObserver.observe(this.container)}renderFull(e){if(this.clear(),e.length===0){this.renderWelcome();return}let t=-1;for(let s=e.length-1;s>=0;s--)if(e[s].role==="user"){t=s;break}t===-1&&e.length>0&&(t=e.length-1),e.forEach((s,n)=>{const i=n<t;this.appendSessionGroup(s,i),s.executionRoot&&this.renderExecutionTree(s.executionRoot,i)}),this.scrollToBottom(!0)}renderWelcome(){this.container.innerHTML=Wi.renderWelcome()}renderError(e){const t=this.container.querySelector(".llm-ui-error-banner");t&&t.remove();const s=document.createElement("div");s.className="llm-ui-error-banner",s.innerHTML=`
        <div class="llm-ui-error-banner__content">
            <span class="llm-ui-error-banner__icon">⚠️</span>
            <span class="llm-ui-error-banner__message">${T(e.message)}</span>
            <button class="llm-ui-error-banner__close" title="Dismiss">×</button>
        </div>
    `,s.querySelector(".llm-ui-error-banner__close")?.addEventListener("click",()=>{s.remove()}),e.message.includes("401")||e.message.includes("API key")||setTimeout(()=>s.remove(),5e3),this.container.insertBefore(s,this.container.firstChild),this.scrollToBottom(!0)}handleScroll(){if(this.isStreamingMode||Date.now()<this.scrollLockUntil)return;const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.container,n=t-e-s;this.shouldAutoScroll=n<this.scrollThreshold}handleResize(){if(!this.shouldAutoScroll&&!this.isStreamingMode)return;const e=this.container.scrollHeight;e>this.lastScrollHeight&&(this.lastScrollHeight=e,this.instantScrollToBottom())}instantScrollToBottom(){this.container.scrollTop=this.container.scrollHeight}scrollToBottom(e=!1){!e&&!this.shouldAutoScroll||(this.scrollFrameId!==null&&cancelAnimationFrame(this.scrollFrameId),this.scrollFrameId=requestAnimationFrame(()=>{this.scrollFrameId=null,this.container.scrollTop=this.container.scrollHeight,this.lastScrollHeight=this.container.scrollHeight,this.scrollLockUntil=Date.now()+100}))}enterStreamingMode(){this.isStreamingMode||(this.isStreamingMode=!0,this.shouldAutoScroll=!0,this.lastScrollHeight=this.container.scrollHeight,this.container.classList.add("llm-ui-history--streaming"))}exitStreamingMode(){this.isStreamingMode&&(this.isStreamingMode=!1,this.container.classList.remove("llm-ui-history--streaming"),this.scrollToBottom(!0),this.container.querySelectorAll(".llm-ui-node--streaming").forEach(e=>{e.classList.remove("llm-ui-node--streaming")}),this.previewUpdateTimers.forEach(e=>clearTimeout(e)),this.previewUpdateTimers.clear())}appendSessionGroup(e,t){if(this.renderedSessionIds.has(e.id)){console.warn(`[HistoryView] Duplicate session skipped: ${e.id}`);return}this.renderedSessionIds.add(e.id);const s=document.createElement("div");if(s.className=`llm-ui-session llm-ui-session--${e.role}`,s.dataset.sessionId=e.id,e.role==="user"){const n=this.getPreviewText(e.content||"");s.innerHTML=_e.renderUserBubble(e,n,t),this.container.appendChild(s),this.initUserBubble(s,e)}else s.innerHTML=`
                <div class="llm-ui-avatar">🤖</div>
                <div class="llm-ui-execution-root" id="container-${e.id}"></div>
            `,this.container.appendChild(s)}initUserBubble(e,t){const s=e.querySelector(`#user-mount-${t.id}`),n=new ft(s,t.content||"",{readOnly:!0,onChange:i=>{this.onContentChange?.(t.id,i,"user");const o=e.querySelector(".llm-ui-header-preview");o&&(o.textContent=this.getPreviewText(i))},nodeId:this.contextOptions.nodeId,ownerNodeId:this.contextOptions.ownerNodeId,sessionEngine:this.contextOptions.sessionEngine});this.editorMap.set(t.id,n),this.bindUserBubbleEvents(e,t,n)}bindUserBubbleEvents(e,t,s){const n=e.querySelector(".llm-ui-bubble--user"),i=e.querySelector(".llm-ui-edit-actions");if(!n)return;e.querySelector('[data-action="resend"]')?.addEventListener("click",a=>{a.stopPropagation(),this.onNodeAction?.("resend",t.id)}),e.querySelector('[data-action="edit"]')?.addEventListener("click",a=>{a.stopPropagation(),this.toggleEditMode(t.id,s,i,e)}),e.querySelector('[data-action="copy"]')?.addEventListener("click",async a=>{a.stopPropagation(),await this.handleCopy(s.content,a.currentTarget)}),e.querySelector('[data-action="delete"]')?.addEventListener("click",async a=>{a.stopPropagation(),await this.handleDeleteConfirm(t.id,"user")});const o=e.querySelector('[data-action="collapse"]');o&&o.addEventListener("click",a=>{a.stopPropagation(),this.toggleCollapse(n,a.currentTarget)}),e.querySelector('[data-action="prev-sibling"]')?.addEventListener("click",a=>{a.stopPropagation(),this.onNodeAction?.("prev-sibling",t.id)}),e.querySelector('[data-action="next-sibling"]')?.addEventListener("click",a=>{a.stopPropagation(),this.onNodeAction?.("next-sibling",t.id)}),e.querySelector('[data-action="confirm-edit"]')?.addEventListener("click",a=>{a.stopPropagation(),this.confirmEdit(t.id,s,i,e,!0)}),e.querySelector('[data-action="save-only"]')?.addEventListener("click",a=>{a.stopPropagation(),this.confirmEdit(t.id,s,i,e,!1)}),e.querySelector('[data-action="cancel-edit"]')?.addEventListener("click",a=>{a.stopPropagation(),this.cancelEdit(t.id,s,i,e)})}toggleEditMode(e,t,s,n){if(this.editingNodes.has(e))this.confirmEdit(e,t,s,n,!1);else{this.originalContentMap.set(e,t.content),this.editingNodes.add(e),t.toggleEdit(),s.style.display="flex",n.querySelector('[data-action="edit"]')?.classList.add("active");const i=n.querySelector(".llm-ui-bubble--user");if(i&&i.classList.contains("is-collapsed")){const o=n.querySelector('[data-action="collapse"]');o&&o.click()}}}confirmEdit(e,t,s,n,i){const o=t.content;this.editingNodes.delete(e),this.originalContentMap.delete(e),t.toggleEdit(),s.style.display="none",n.querySelector('[data-action="edit"]')?.classList.remove("active"),this.onContentChange?.(e,o,"user"),i&&this.onNodeAction?.("edit-and-retry",e)}cancelEdit(e,t,s,n){const i=this.originalContentMap.get(e);i!==void 0&&(t.currentContent=i,t.finishStream()),this.editingNodes.delete(e),this.originalContentMap.delete(e),t.toggleEdit(),s.style.display="none",n.querySelector('[data-action="edit"]')?.classList.remove("active")}async handleCopy(e,t){try{await navigator.clipboard.writeText(e);const s=t.innerHTML;t.innerHTML="✓",setTimeout(()=>t.innerHTML=s,1500)}catch(s){console.error("Copy failed",s)}}async handleDeleteConfirm(e,t){let s="Delete this message?";if(t==="user"){const i=this.countAssociatedResponses(e);i>0&&(s=`Delete this message and ${i} response(s)?`)}await Gi(s)&&this.onNodeAction?.("delete",e)}countAssociatedResponses(e){const t=this.container.querySelectorAll(".llm-ui-session");let s=0,n=!1;return t.forEach(i=>{if(i.dataset.sessionId===e){n=!0;return}n&&(i.classList.contains("llm-ui-session--assistant")?s++:n=!1)}),s}toggleCollapse(e,t){e.classList.toggle("is-collapsed");const s=e.classList.contains("is-collapsed"),n=t.querySelector("svg");n&&(n.innerHTML=s?'<polyline points="6 9 12 15 18 9"></polyline>':'<polyline points="18 15 12 9 6 15"></polyline>')}renderExecutionTree(e,t=!1){this.appendNode(e.parentId,e,t),e.children?.forEach(s=>this.renderExecutionTree(s,t))}appendNode(e,t,s){if(this.nodeMap.has(t.id)){console.warn(`[HistoryView] Duplicate node skipped: ${t.id}`);return}let n=null;if(e&&(n=this.nodeMap.get(e)?.querySelector(".llm-ui-node__children")||null),!n){const i=this.container.querySelectorAll(".llm-ui-execution-root");i.length>0&&(n=i[i.length-1])}if(n){const{element:i,mountPoints:o}=Vi.create(t);if(s){i.classList.add("is-collapsed");const a=i.querySelector('[data-action="collapse"] svg');a&&(a.innerHTML='<polyline points="6 9 12 15 18 9"></polyline>')}this.nodeMap.set(t.id,i),n.appendChild(i),this.bindNodeEvents(i,t,o)}}bindNodeEvents(e,t,s){const n=e.querySelector('[data-action="edit"]'),i=e.querySelector('[data-action="copy"]'),o=e.querySelector('[data-action="collapse"]'),a=e.querySelector('[data-action="retry"]'),r=e.querySelector('[data-action="delete"]'),c=()=>e.closest("[data-session-id]")?.dataset.sessionId||t.id,d=c(),h=e.querySelector(".llm-ui-node__icon--clickable");if(h&&h.addEventListener("click",u=>{u.stopPropagation();const p=u.currentTarget.dataset.agentId;p&&(console.log(`[HistoryView] Clicked agent: ${p}`),this.container.dispatchEvent(new CustomEvent("open-agent-config",{bubbles:!0,detail:{agentId:p}})))}),a?.addEventListener("click",u=>{u.stopPropagation(),this.onNodeAction?.("retry",d)}),r?.addEventListener("click",async u=>{u.stopPropagation(),await this.handleDeleteConfirm(d,"assistant")}),o?.addEventListener("click",u=>{u.stopPropagation(),this.toggleCollapse(e,u.target)}),e.querySelector('[data-action="prev-sibling"]')?.addEventListener("click",u=>{u.stopPropagation();const p=c();this.onNodeAction?.("prev-sibling",p)}),e.querySelector('[data-action="next-sibling"]')?.addEventListener("click",u=>{u.stopPropagation();const p=c();this.onNodeAction?.("next-sibling",p)}),s.output){const u=t.status==="running"||t.status==="queued",p=new ft(s.output,t.data.output||"",{readOnly:!0,streaming:u,onChange:m=>{p.isEditing()&&this.onContentChange?.(d,m,"node");const g=e.querySelector(".llm-ui-header-preview");g&&(g.textContent=this.getPreviewText(m))},nodeId:this.contextOptions.nodeId,ownerNodeId:this.contextOptions.ownerNodeId,sessionEngine:this.contextOptions.sessionEngine});this.editorMap.set(t.id,p),n?.addEventListener("click",async()=>{const m=p.isEditing();await p.toggleEdit(),n.classList.toggle("active"),m&&this.onContentChange?.(d,p.content,"node")}),i?.addEventListener("click",async()=>{await this.handleCopy(p.content,i)})}else n&&(n.style.display="none"),i&&(i.style.display="none")}updateNodeContent(e,t,s){const n=this.nodeMap.get(e);if(n){if(n.classList.contains("llm-ui-node--streaming")||n.classList.add("llm-ui-node--streaming"),s==="thought"){const i=n.querySelector(".llm-ui-thought"),o=n.querySelector(".llm-ui-thought__content");i&&i.style.display==="none"&&(i.style.display="block"),o&&(o.insertAdjacentText("beforeend",t),i&&(i.scrollTop=i.scrollHeight))}else if(s==="output"){const i=this.editorMap.get(e);i&&(i.appendStream(t),this.schedulePreviewUpdate(e,n,i))}}}schedulePreviewUpdate(e,t,s){if(this.previewUpdateTimers.has(e))return;const n=window.setTimeout(()=>{this.previewUpdateTimers.delete(e);const i=t.querySelector(".llm-ui-header-preview");i&&(i.textContent=this.getPreviewText(s.content))},this.PREVIEW_UPDATE_INTERVAL);this.previewUpdateTimers.set(e,n)}updateNodeStatus(e,t,s){const n=this.nodeMap.get(e);if(n){n.classList.remove("llm-ui-node--streaming"),n.dataset.status=t,n.classList.remove("llm-ui-node--running","llm-ui-node--success","llm-ui-node--failed"),n.classList.add(`llm-ui-node--${t}`);const o=n.querySelector(".llm-ui-node__status");if(o&&(o.textContent=t,o.className=`llm-ui-node__status llm-ui-node__status--${t}`),s&&n.classList.contains("llm-ui-node--tool")){const d=n.querySelector(".llm-ui-node__result");d&&(d.style.display="block",d.textContent=typeof s=="string"?s:JSON.stringify(s))}const a=this.previewUpdateTimers.get(e);a&&(clearTimeout(a),this.previewUpdateTimers.delete(e));const r=this.editorMap.get(e),c=n.querySelector(".llm-ui-header-preview");r&&c&&(c.textContent=this.getPreviewText(r.content))}const i=this.editorMap.get(e);i&&(t==="success"||t==="failed")&&i.finishStream(!1)}removeMessages(e,t=!0){for(const n of e){this.renderedSessionIds.delete(n);const i=this.container.querySelector(`[data-session-id="${n}"]`);i&&this.removeElement(i,t);const o=this.nodeMap.get(n);o&&(this.removeElement(o,t),this.nodeMap.delete(n));const a=this.editorMap.get(n);a&&(a.destroy(),this.editorMap.delete(n));const r=this.previewUpdateTimers.get(n);r&&(clearTimeout(r),this.previewUpdateTimers.delete(n)),this.originalContentMap.delete(n),this.editingNodes.delete(n)}setTimeout(()=>this.checkEmpty(),t?350:0)}removeElement(e,t){t?(e.classList.add("llm-ui-session--deleting"),e.addEventListener("animationend",()=>e.remove(),{once:!0}),setTimeout(()=>{e.parentNode&&e.remove()},350)):e.remove()}checkEmpty(){this.container.querySelectorAll(".llm-ui-session:not(.llm-ui-session--deleting)").length===0&&this.renderWelcome()}handleMessagesDeleted(e){this.removeMessages(e,!0)}handleMessageEdited(e,t){const s=this.container.querySelector(`[data-session-id="${e}"]`);if(s){const n=s.querySelector(".llm-ui-header-preview");n&&(n.textContent=this.getPreviewText(t))}}handleSiblingSwitch(e){const t=this.container.querySelector(`[data-session-id="${e.sessionId}"]`);if(!t)return;const s=t.querySelector(".llm-ui-branch-indicator");s&&(s.textContent=`${e.newIndex+1}/${e.total}`);const n=t.querySelector('[data-action="prev-sibling"]'),i=t.querySelector('[data-action="next-sibling"]');n&&(n.disabled=e.newIndex===0),i&&(i.disabled=e.newIndex===e.total-1)}getPreviewText(e){if(!e)return"";let t=e.replace(/[\r\n]+/g," ");return t=t.replace(/[*#`_~[\]()]/g,""),t=t.trim(),t?t.length>60?t.substring(0,60)+"...":t:""}appendErrorBubble(e){this.exitStreamingMode();const t=document.createElement("div");t.className="llm-ui-session llm-ui-session--system";const s=e.message.includes("apiKey")||e.message.includes("401");let n="";s&&(n=`
                <button class="llm-ui-error-btn" data-action="open-settings">⚙️ 配置连接</button>
            `),n+=`
            <button class="llm-ui-error-btn" data-action="retry-last">↻ 重试</button>
        `,t.innerHTML=`
            <div class="llm-ui-bubble llm-ui-bubble--error">
                <strong>⚠️ 执行失败</strong>
                <div class="llm-ui-bubble--error__content">
                    ${T(e.message)}
                </div>
                <div class="llm-ui-bubble--error__actions">
                    ${n}
                </div>
            </div>
        `,this.container.appendChild(t),this.scrollToBottom(!0);const i=t.querySelector('[data-action="open-settings"]');i&&i.addEventListener("click",()=>{this.container.dispatchEvent(new CustomEvent("open-connection-settings",{bubbles:!0}))});const o=t.querySelector('[data-action="retry-last"]');o&&o.addEventListener("click",()=>{t.remove();const a=this.findLastRetryableId();a&&this.onNodeAction?.("retry",a)})}findLastRetryableId(){const e=Array.from(this.container.querySelectorAll("[data-session-id]"));return e.length>0&&e[e.length-1].dataset.sessionId||null}processEvent(e){switch(e.type){case"session_start":this.enterStreamingMode(),this.appendSessionGroup(e.payload,!1),this.scrollToBottom(!0);break;case"node_start":this.appendNode(e.payload.parentId,e.payload.node,!1);break;case"node_update":e.payload.chunk!==void 0&&e.payload.field!==void 0&&this.updateNodeContent(e.payload.nodeId,e.payload.chunk,e.payload.field);break;case"node_status":this.updateNodeStatus(e.payload.nodeId,e.payload.status,e.payload.result);break;case"finished":this.exitStreamingMode(),this.editorMap.forEach(n=>n.finishStream());break;case"error":this.exitStreamingMode();const t=e.payload.message||"Unknown error",s=e.payload.code;s===401?this.appendErrorBubble(new Error(`🔐 ${t}`)):s===429?this.appendErrorBubble(new Error(`⏳ ${t}`)):this.appendErrorBubble(new Error(t)),this.editorMap.forEach(n=>n.finishStream(!1));break;case"messages_deleted":this.handleMessagesDeleted(e.payload.deletedIds);break;case"message_edited":this.handleMessageEdited(e.payload.sessionId,e.payload.newContent);break;case"session_cleared":this.renderWelcome();break;case"sibling_switch":this.handleSiblingSwitch(e.payload);break;case"retry_started":this.enterStreamingMode();break}}clear(){this.scrollFrameId!==null&&(cancelAnimationFrame(this.scrollFrameId),this.scrollFrameId=null),this.previewUpdateTimers.forEach(e=>clearTimeout(e)),this.previewUpdateTimers.clear(),this.editorMap.forEach(e=>e.destroy()),this.editorMap.clear(),this.nodeMap.clear(),this.originalContentMap.clear(),this.editingNodes.clear(),this.isStreamingMode=!1,this.shouldAutoScroll=!0,this.lastScrollHeight=0,this.container.classList.remove("llm-ui-history--streaming"),this.container.innerHTML=""}destroy(){this.scrollFrameId!==null&&cancelAnimationFrame(this.scrollFrameId),this.resizeObserver.disconnect(),this.clear()}}class Qi{constructor(e,t){this.container=e,this.options=t,this.render(),this.bindEvents(),this.options.initialAgents&&this.options.initialAgents.length>0?this.updateExecutors(this.options.initialAgents):this.updateExecutors([{id:"default",name:"Assistant",category:"System"}])}textarea;sendBtn;stopBtn;attachBtn;executorSelect;fileInput;attachmentContainer;inputWrapper;loading=!1;files=[];render(){this.container.innerHTML=`
            <div class="llm-input">
                <!-- 左侧：执行器选择 -->
                <div class="llm-input__executor-wrapper">
                    <select class="llm-input__executor-select" title="Select Agent/Executor">
                        <option value="default">🤖 Assistant</option>
                    </select>
                </div>

                <!-- 中间：输入区域 + 附件预览 -->
                <div class="llm-input__field-wrapper">
                    <!--div class="llm-input__drag-overlay">Drop files here</div--> <!-- 新增：拖拽提示遮罩 -->
                    <div class="llm-input__attachments" style="display:none"></div>
                    <textarea 
                        class="llm-input__textarea" 
                        placeholder="Message... (Paste images or Drag & Drop)" 
                        rows="1"
                    ></textarea>
                </div>

                <!-- 右侧：操作按钮 -->
                <div class="llm-input__actions">
                    <button class="llm-input__btn llm-input__btn--attach" title="Attach File">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    
                    <button class="llm-input__btn llm-input__btn--send" title="Send">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                    
                    <button class="llm-input__btn llm-input__btn--stop" title="Stop Generation" style="display:none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    </button>
                </div>

                <input type="file" multiple style="display:none;" id="llm-ui-hidden-file-input">
            </div>
        `,this.textarea=this.container.querySelector(".llm-input__textarea"),this.sendBtn=this.container.querySelector(".llm-input__btn--send"),this.stopBtn=this.container.querySelector(".llm-input__btn--stop"),this.attachBtn=this.container.querySelector(".llm-input__btn--attach"),this.executorSelect=this.container.querySelector(".llm-input__executor-select"),this.fileInput=this.container.querySelector("#llm-ui-hidden-file-input"),this.attachmentContainer=this.container.querySelector(".llm-input__attachments"),this.inputWrapper=this.container.querySelector(".llm-input__field-wrapper")}bindEvents(){const e=()=>{this.textarea.style.height="auto";const t=Math.min(this.textarea.scrollHeight,200);this.textarea.style.height=`${t}px`};this.textarea.addEventListener("input",e),this.textarea.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.triggerSend())}),this.textarea.addEventListener("paste",t=>this.handlePaste(t)),this.bindDragEvents(),this.sendBtn.addEventListener("click",()=>this.triggerSend()),this.stopBtn.addEventListener("click",()=>this.options.onStop()),this.attachBtn.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",()=>{this.fileInput.files&&(this.addFiles(Array.from(this.fileInput.files)),this.fileInput.value="")}),this.executorSelect.addEventListener("change",()=>{this.options.onExecutorChange?.(this.executorSelect.value)})}handlePaste(e){if(this.loading)return;const t=e.clipboardData?.items;if(!t)return;const s=[];for(let n=0;n<t.length;n++){const i=t[n];if(i.kind==="file"){const o=i.getAsFile();if(o){const a=this.renameFileIfNeeded(o);s.push(a)}}}s.length>0&&this.addFiles(s)}bindDragEvents(){const e=this.inputWrapper;e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),this.loading||e.classList.add("llm-input__field-wrapper--drag-active")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("llm-input__field-wrapper--drag-active")}),e.addEventListener("drop",t=>{if(t.preventDefault(),t.stopPropagation(),e.classList.remove("llm-input__field-wrapper--drag-active"),this.loading)return;const s=t.dataTransfer?.files;s&&s.length>0&&this.addFiles(Array.from(s))})}renameFileIfNeeded(e){if(e.name==="image.png"||e.name==="image.jpg"){const s=`paste_${new Date().toISOString().replace(/[:.]/g,"-")}.${e.name.split(".").pop()}`;return new File([e],s,{type:e.type})}return e}updateExecutors(e,t){const s={},n=[];e.forEach(o=>{o.category?(s[o.category]||(s[o.category]=[]),s[o.category].push(o)):n.push(o)});let i="";n.length>0&&(i+=n.map(o=>this.renderOption(o)).join("")),Object.entries(s).forEach(([o,a])=>{i+=`<optgroup label="${o}">`,i+=a.map(r=>this.renderOption(r)).join(""),i+="</optgroup>"}),this.executorSelect.innerHTML=i,t&&(this.executorSelect.value=t)}renderOption(e){const t=e.icon?`${e.icon} `:"";return`<option value="${e.id}">${t}${e.name}</option>`}addFiles(e){this.files=[...this.files,...e],this.renderAttachments()}removeFile(e){this.files.splice(e,1),this.renderAttachments()}renderAttachments(){if(this.files.length===0){this.attachmentContainer.style.display="none";return}this.attachmentContainer.style.display="flex",this.attachmentContainer.innerHTML=this.files.map((e,t)=>`
            <div class="llm-input__attachment-tag">
                <span class="llm-input__file-icon">
                   ${e.type.startsWith("image/")?"🖼️":"📄"}
                </span>
                <span class="llm-input__filename">${e.name}</span>
                <span class="llm-input__filesize">(${this.formatSize(e.size)})</span>
                <span class="llm-input__remove-btn" data-index="${t}" title="Remove">×</span>
            </div>
        `).join(""),this.attachmentContainer.querySelectorAll(".llm-input__remove-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const s=parseInt(t.target.dataset.index);this.removeFile(s)})})}formatSize(e){if(e===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(1))+" "+s[n]}async triggerSend(){const e=this.textarea.value.trim();if(!e&&this.files.length===0||this.loading)return;const t=this.executorSelect.value,s=[...this.files];this.textarea.value="",this.textarea.style.height="auto",this.files=[],this.renderAttachments(),await this.options.onSend(e,s,t)}setLoading(e){this.loading=e,this.sendBtn.style.display=e?"none":"flex",this.stopBtn.style.display=e?"flex":"none",this.textarea.disabled=e,this.executorSelect.disabled=e,this.attachBtn.disabled=e,e?this.inputWrapper.classList.add("llm-input__field-wrapper--disabled"):this.inputWrapper.classList.remove("llm-input__field-wrapper--disabled")}focus(){this.textarea?.focus()}destroy(){this.container.innerHTML="",this.files=[]}getSelectedExecutor(){return this.executorSelect?.value||"default"}setInput(e){this.textarea&&(this.textarea.value=e,this.textarea.dispatchEvent(new Event("input")))}}var A=(l=>(l.NETWORK_ERROR="NETWORK_ERROR",l.TIMEOUT="TIMEOUT",l.SESSION_NOT_FOUND="SESSION_NOT_FOUND",l.SESSION_BUSY="SESSION_BUSY",l.SESSION_INVALID="SESSION_INVALID",l.EXECUTION_FAILED="EXECUTION_FAILED",l.EXECUTOR_NOT_FOUND="EXECUTOR_NOT_FOUND",l.QUOTA_EXCEEDED="QUOTA_EXCEEDED",l.CONTEXT_LIMIT="CONTEXT_LIMIT",l.ABORTED="ABORTED",l.UNKNOWN="UNKNOWN",l))(A||{});class C extends Error{constructor(e,t,s=!1,n){super(t),this.code=e,this.retryable=s,this.originalError=n,this.name="EngineError"}static from(e){if(e instanceof C)return e;const t=e?.message||"Unknown error";return e?.name==="AbortError"||t.includes("abort")?new C("ABORTED","Operation aborted",!1,e):t.includes("timeout")||e?.name==="TimeoutError"?new C("TIMEOUT","Request timed out",!0,e):t.includes("429")||t.includes("rate limit")||t.includes("quota")?new C("QUOTA_EXCEEDED","Rate limit exceeded",!0,e):t.includes("context")||t.includes("token limit")?new C("CONTEXT_LIMIT","Context limit exceeded",!1,e):t.includes("network")||t.includes("fetch")||e?.name==="TypeError"?new C("NETWORK_ERROR","Network error",!0,e):new C("UNKNOWN",t,!0,e)}get canRetry(){return this.retryable}}const de={MAX_CONCURRENT:3,MAX_QUEUE_SIZE:10,SESSION_IDLE_TIMEOUT:30*60*1e3,RECOVERY_MAX_AGE:60*60*1e3,PERSIST_THROTTLE:500,CLEANUP_INTERVAL:5*60*1e3};class Ki{constructor(e,t){this.nodeId=e,this.sessionId=t}sessions=[];getSessions(){return[...this.sessions]}getHistory(){return this.sessions.filter(e=>e.role==="user"||e.role==="assistant"&&e.executionRoot?.data.output).map(e=>({role:e.role,content:e.role==="user"?e.content||"":e.executionRoot?.data.output||""}))}findSessionById(e){return this.sessions.find(t=>t.id===e||t.persistedNodeId===e||t.executionRoot?.id===e)}findSessionIndex(e){return this.sessions.findIndex(t=>t.id===e||t.persistedNodeId===e||t.executionRoot?.id===e)}findUserMessageBefore(e){const t=this.findSessionIndex(e);if(!(t<=0)){for(let s=t-1;s>=0;s--)if(this.sessions[s].role==="user")return this.sessions[s]}}getLastSession(){return this.sessions[this.sessions.length-1]}addSession(e){this.sessions.push(e)}addUserMessage(e,t,s){const n={id:$(),timestamp:Date.now(),role:"user",content:e,files:t.map(i=>({name:i.name,type:i.type,path:i.path,size:i.size})),persistedNodeId:s};return this.sessions.push(n),n}createAssistantMessage(e,t,s){const n={id:$(),executorId:e.id,executorType:e.type||"agent",name:e.name||e.id,status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:{agentId:e.id,agentName:e.name,siblingIndex:s?.siblingIndex??0,siblingCount:s?.siblingCount??1}},children:[]},i={id:$(),timestamp:Date.now(),role:"assistant",executionRoot:n,persistedNodeId:t,siblingIndex:s?.siblingIndex,siblingCount:s?.siblingCount};return this.sessions.push(i),n}updateNodeOutput(e,t){for(const s of this.sessions){if(s.executionRoot?.id===e){s.executionRoot.data.output=t,s.executionRoot.status="success",s.executionRoot.endTime=Date.now();return}if(s.executionRoot&&this.findAndUpdateNode(s.executionRoot,e,t))return}}findAndUpdateNode(e,t,s){if(e.id===t)return e.data.output=s,e.status="success",e.endTime=Date.now(),!0;if(e.children){for(const n of e.children)if(this.findAndUpdateNode(n,t,s))return!0}return!1}updateNodeThinking(e,t){for(const s of this.sessions)if(s.executionRoot?.id===e){s.executionRoot.data.thought=t;return}}appendToNode(e,t,s){for(const n of this.sessions){const i=this.findNodeInTree(n.executionRoot,e);if(i){s==="output"?i.data.output=(i.data.output||"")+t:i.data.thought=(i.data.thought||"")+t;return}}}findNodeInTree(e,t){if(!e)return null;if(e.id===t)return e;if(e.children)for(const s of e.children){const n=this.findNodeInTree(s,t);if(n)return n}return null}updateNodeStatus(e,t){for(const s of this.sessions){const n=this.findNodeInTree(s.executionRoot,e);if(n){n.status=t,(t==="success"||t==="failed")&&(n.endTime=Date.now());return}}}updateMessageContent(e,t){const s=this.findSessionById(e);s&&(s.role==="user"?s.content=t:s.executionRoot&&(s.executionRoot.data.output=t))}updateNodeError(e,t){for(const s of this.sessions){const n=this.findNodeInTree(s.executionRoot,e);if(n){n.data.error=t;return}}}removeMessage(e){const t=this.findSessionIndex(e);t!==-1&&this.sessions.splice(t,1)}removeMessagesAfter(e){const t=this.findSessionIndex(e);t!==-1&&(this.sessions=this.sessions.slice(0,t+1))}loadFromChatNode(e){e.role==="user"?this.sessions.push({id:$(),timestamp:new Date(e.created_at).getTime(),role:"user",content:e.content,files:e.meta?.files||[],persistedNodeId:e.id}):e.role==="assistant"&&this.sessions.push({id:$(),timestamp:new Date(e.created_at).getTime(),role:"assistant",executionRoot:{id:$(),executorId:e.meta?.agentId||"unknown",executorType:"agent",name:e.meta?.agentName||"Assistant",status:"success",startTime:new Date(e.created_at).getTime(),endTime:new Date(e.created_at).getTime(),data:{output:e.content,thought:e.meta?.thinking||"",metaInfo:e.meta||{}},children:[]},persistedNodeId:e.id})}exportToMarkdown(){let e=`# Chat Export

`;e+=`> Exported at: ${new Date().toLocaleString()}

---

`;for(const t of this.sessions){const s=t.role==="user"?"👤 User":"🤖 Assistant",n=new Date(t.timestamp).toLocaleTimeString();if(e+=`### ${s} (${n})

`,t.role==="user"){if(t.files&&t.files.length>0){const i=t.files.map(o=>`\`${o.name}\``).join(", ");e+=`> Attachments: ${i}

`}e+=`${t.content||"(Empty)"}

`}else t.executionRoot&&(t.executionRoot.data.thought&&(e+=`> **Thinking:**
`,e+=t.executionRoot.data.thought.split(`
`).map(i=>`> ${i}`).join(`
`),e+=`

`),e+=`${t.executionRoot.data.output||"(No output)"}

`);e+=`---

`}return e}clear(){this.sessions=[]}}class Yi{handlers=new Map;scopes=new Map;emit(e){const t=this.handlers.get(e.type)||new Set,s=this.handlers.get("*")||new Set,n=[...t,...s].sort((i,o)=>(o.options.priority||0)-(i.options.priority||0));for(const{handler:i,options:o}of n)if(!(o.filter&&!o.filter(e))){try{i(e)}catch(a){console.error(`[EventBus] Handler error for ${e.type}:`,a)}o.once&&this.off(e.type,i)}}on(e,t,s={}){this.handlers.has(e)||this.handlers.set(e,new Set);const n={handler:t,options:s};return this.handlers.get(e).add(n),()=>{this.handlers.get(e)?.delete(n)}}once(e,t){return this.on(e,t,{once:!0})}off(e,t){const s=this.handlers.get(e);if(s){for(const n of s)if(n.handler===t){s.delete(n);break}}}createScope(e){if(this.scopes.has(e))return this.scopes.get(e);const t=new Xi(e,this);return this.scopes.set(e,t),t}destroyScope(e){this.scopes.delete(e)}}class Xi{constructor(e,t){this.executionId=e,this.parent=t}emit(e,t,s){this.parent.emit({type:e,executionId:this.executionId,nodeId:s,timestamp:Date.now(),payload:t})}on(e,t){return this.parent.on(e,t,{filter:s=>s.executionId===this.executionId})}}let $e=null;function et(){return $e||($e=new Yi),$e}class Zi{data=new Map;parent;constructor(e){this.parent=e}get(e){return this.data.has(e)?this.data.get(e):this.parent?.get(e)}set(e,t){this.data.set(e,t)}has(e){return this.data.has(e)||(this.parent?.has(e)??!1)}toObject(){const e=this.parent?.toObject()||{},t=Object.fromEntries(this.data);return{...e,...t}}}class tt{constructor(e,t,s,n=0,i,o){this.executionId=e,this.events=t,this.parentId=s,this.depth=n,this.variables=new Zi(i),this.abortController=o||new AbortController}variables;results=new Map;abortController;currentNodeId;get signal(){return this.abortController.signal}createChild(e){return new tt(this.executionId,this.events,e,this.depth+1,this.variables,this.abortController)}setCurrentNode(e){this.currentNodeId=e}emitThinking(e){this.events.emit("stream:thinking",{delta:e},this.currentNodeId)}emitContent(e){this.events.emit("stream:content",{delta:e},this.currentNodeId)}emitNodeStatus(e){this.events.emit("node:update",{status:e},this.currentNodeId)}emitError(e){this.events.emit("execution:error",{code:e.code||"UNKNOWN",message:e.message,stack:e.stack},this.currentNodeId)}checkCancelled(){if(this.signal.aborted)throw new eo("Execution cancelled")}}class eo extends Error{constructor(e){super(e),this.name="CancellationError"}}class H extends Error{code;provider;statusCode;cause;retryable;retryAfter;constructor(e,t){super(e),this.name="LLMError",this.code=t.code,this.provider=t.provider,this.statusCode=t.statusCode,this.cause=t.cause,this.retryable=t.retryable,this.retryAfter=t.retryAfter}static fromResponse(e,t,s){const{code:n,message:i,retryable:o,retryAfter:a}=this.parseErrorResponse(t,s);return new H(i,{code:n,provider:e,statusCode:t,cause:s,retryable:o,retryAfter:a})}static fromException(e,t){return t.name==="AbortError"?new H("Request aborted",{code:"ABORTED",provider:e,cause:t,retryable:!1}):t.name==="TimeoutError"||t.message?.includes("timeout")?new H("Request timed out",{code:"TIMEOUT",provider:e,cause:t,retryable:!0}):t.name==="TypeError"&&t.message?.includes("fetch")?new H("Network error",{code:"NETWORK_ERROR",provider:e,cause:t,retryable:!0}):new H(t.message||"Unknown error",{code:"UNKNOWN",provider:e,cause:t,retryable:!0})}static parseErrorResponse(e,t){const s=t?.error?.message||t?.message||`HTTP ${e}`;switch(e){case 400:return{code:"INVALID_REQUEST",message:s,retryable:!1};case 401:return{code:"INVALID_API_KEY",message:"Invalid API key",retryable:!1};case 403:return{code:"UNAUTHORIZED",message:s,retryable:!1};case 404:return{code:"MODEL_NOT_FOUND",message:s,retryable:!1};case 429:return{code:"RATE_LIMIT",message:"Rate limit exceeded",retryable:!0,retryAfter:this.parseRetryAfter(t)};case 500:case 502:case 503:case 504:return{code:"SERVER_ERROR",message:s,retryable:!0};default:return{code:"UNKNOWN",message:s,retryable:e>=500}}}static parseRetryAfter(e){const t=e?.error?.retry_after||e?.retry_after;if(typeof t=="number")return t*1e3}}class st{config;baseURL;defaultModel;constructor(e){this.config=e,this.baseURL=this.resolveBaseURL(e),this.defaultModel=e.model||""}resolveBaseURL(e){return e.apiBaseUrl?e.apiBaseUrl.replace(/\/+$/,""):""}buildHeaders(){return{"Content-Type":"application/json",...this.config.headers}}getModel(e){return e.model||this.defaultModel}async fetchJSON(e,t){const s=await fetch(e,t);if(!s.ok){let n;try{n=await s.json()}catch{n=await s.text()}throw H.fromResponse(this.name,s.status,n)}return s.json()}async fetchStream(e,t){const s=await fetch(e,t);if(!s.ok){let n;try{n=await s.json()}catch{n=await s.text()}throw H.fromResponse(this.name,s.status,n)}if(!s.body)throw new Error("Response body is null");return s.body}}async function*nt(l){const e=l.getReader(),t=new TextDecoder;let s="";try{for(;;){const{done:n,value:i}=await e.read();if(n)break;s+=t.decode(i,{stream:!0});const o=s.split(`
`);s=o.pop()||"";for(const a of o){const r=a.trim();if(!(!r||r.startsWith(":"))&&r.startsWith("data:")){const c=r.slice(5).trim();if(c==="[DONE]"){yield"[DONE]";continue}yield c}}}if(s.trim()){const n=s.trim();if(n.startsWith("data:")){const i=n.slice(5).trim();i&&i!=="[DONE]"&&(yield i)}}}finally{e.releaseLock()}}class X extends st{name="openai";constructor(e){super(e),this.baseURL||(this.baseURL="https://api.openai.com/v1")}async create(e){const t=this.baseURL.endsWith("/chat/completions")?this.baseURL:`${this.baseURL}/chat/completions`,s=this.buildRequestBody(e),n=await this.fetchJSON(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});return this.normalizeResponse(n)}async*stream(e){const t=this.baseURL.endsWith("/chat/completions")?this.baseURL:`${this.baseURL}/chat/completions`,s=this.buildRequestBody({...e,stream:!0}),n=await this.fetchStream(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});for await(const i of nt(n)){if(i==="[DONE]")break;try{const o=JSON.parse(i);yield this.normalizeChunk(o)}catch{}}}buildHeaders(){const e=super.buildHeaders();return e.Authorization=`Bearer ${this.config.apiKey}`,this.config.requiresReferer&&(e["HTTP-Referer"]="https://itookit.com",e["X-Title"]="iTookit"),this.config.metadata?.organizationId&&(e["OpenAI-Organization"]=this.config.metadata.organizationId),e}buildRequestBody(e){const t={model:this.getModel(e),messages:this.convertMessages(e.messages),stream:e.stream||!1};return e.temperature!==void 0&&(t.temperature=e.temperature),e.maxTokens!==void 0&&(t.max_tokens=e.maxTokens),e.topP!==void 0&&(t.top_p=e.topP),e.stop!==void 0&&(t.stop=e.stop),e.frequencyPenalty!==void 0&&(t.frequency_penalty=e.frequencyPenalty),e.presencePenalty!==void 0&&(t.presence_penalty=e.presencePenalty),e.seed!==void 0&&(t.seed=e.seed),e.user!==void 0&&(t.user=e.user),e.responseFormat&&(t.response_format=e.responseFormat),e.tools&&e.tools.length>0&&(t.tools=e.tools,e.toolChoice&&(t.tool_choice=e.toolChoice)),e.thinking&&e.reasoningEffort&&(t.reasoning_effort=e.reasoningEffort),e.stream&&(t.stream_options={include_usage:!0}),t}convertMessages(e){return e.map(t=>{const s={role:t.role,content:t.content};return t.name&&(s.name=t.name),t.tool_call_id&&(s.tool_call_id=t.tool_call_id),s})}normalizeResponse(e){const t=e.choices?.[0],s=t?.message||{};let n;return s.reasoning_content&&(n=s.reasoning_content),{id:e.id,object:e.object,created:e.created,model:e.model,choices:[{index:t?.index||0,message:{role:"assistant",content:s.content||"",thinking:n,tool_calls:s.tool_calls},finish_reason:t?.finish_reason||"stop"}],usage:e.usage?{prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens}:void 0}}normalizeChunk(e){const t=e.choices?.[0],s=t?.delta||{};let n;return s.reasoning_content&&(n=s.reasoning_content),{id:e.id,object:e.object,created:e.created,model:e.model,choices:[{index:t?.index||0,delta:{role:s.role,content:s.content,thinking:n,tool_calls:s.tool_calls},finish_reason:t?.finish_reason}],usage:e.usage}}}class rs extends st{name="anthropic";API_VERSION="2023-06-01";constructor(e){super(e),this.baseURL||(this.baseURL="https://api.anthropic.com")}async create(e){const t=`${this.baseURL}/v1/messages`,s=this.buildRequestBody(e),n=await this.fetchJSON(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});return this.normalizeResponse(n)}async*stream(e){const t=`${this.baseURL}/v1/messages`,s=this.buildRequestBody({...e,stream:!0}),n=await this.fetchStream(t,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(s),signal:e.signal});let i="",o="";for await(const a of nt(n))try{const r=JSON.parse(a),c=this.normalizeStreamEvent(r,i,o);c&&(c.choices[0]?.delta.thinking&&(i+=c.choices[0].delta.thinking),c.choices[0]?.delta.content&&(o+=c.choices[0].delta.content),yield c)}catch{}}buildHeaders(){return{...super.buildHeaders(),"x-api-key":this.config.apiKey,"anthropic-version":this.API_VERSION}}buildRequestBody(e){const{systemMessage:t,userMessages:s}=this.separateMessages(e.messages),n={model:this.getModel(e),messages:s,max_tokens:e.maxTokens||4096};if(t&&(n.system=t),e.temperature!==void 0&&(n.temperature=e.temperature),e.topP!==void 0&&(n.top_p=e.topP),e.stop!==void 0&&(n.stop_sequences=Array.isArray(e.stop)?e.stop:[e.stop]),e.stream&&(n.stream=!0),e.thinking){const i=e.thinkingBudget||this.config.metadata?.thinkingBudget||1e4;n.thinking={type:"enabled",budget_tokens:i}}return e.tools&&e.tools.length>0&&(n.tools=e.tools.map(i=>({name:i.function.name,description:i.function.description,input_schema:i.function.parameters})),e.toolChoice==="required"?n.tool_choice={type:"any"}:e.toolChoice==="none"?n.tool_choice={type:"none"}:typeof e.toolChoice=="object"&&(n.tool_choice={type:"tool",name:e.toolChoice.function.name})),n}separateMessages(e){let t=null;const s=[];for(const n of e)if(n.role==="system"){const i=typeof n.content=="string"?n.content:n.content.map(o=>o.type==="text"?o.text:"").join(`
`);t=t?`${t}

${i}`:i}else s.push({role:n.role==="assistant"?"assistant":"user",content:this.convertContent(n.content)});return{systemMessage:t,userMessages:s}}convertContent(e){return typeof e=="string"?e:e.map(t=>{if(t.type==="text")return{type:"text",text:t.text};if(t.type==="image_url"){const s=t.image_url.url;if(s.startsWith("data:")){const[n,i]=s.split(",");return{type:"image",source:{type:"base64",media_type:n.match(/data:(.*?);/)?.[1]||"image/jpeg",data:i}}}return{type:"image",source:{type:"url",url:s}}}return{type:"text",text:""}})}normalizeResponse(e){let t="",s="";const n=[];for(const i of e.content||[])i.type==="text"?t+=i.text:i.type==="thinking"?s+=i.thinking:i.type==="tool_use"&&n.push({id:i.id,type:"function",function:{name:i.name,arguments:JSON.stringify(i.input)}});return{id:e.id,model:e.model,choices:[{index:0,message:{role:"assistant",content:t,thinking:s||void 0,tool_calls:n.length>0?n:void 0},finish_reason:this.mapStopReason(e.stop_reason)}],usage:e.usage?{prompt_tokens:e.usage.input_tokens,completion_tokens:e.usage.output_tokens,total_tokens:e.usage.input_tokens+e.usage.output_tokens}:void 0}}normalizeStreamEvent(e,t,s){switch(e.type){case"message_start":return{id:e.message?.id,model:e.message?.model,choices:[{index:0,delta:{role:"assistant"},finish_reason:null}]};case"content_block_delta":const i=e.delta;return i?.type==="thinking_delta"?{choices:[{index:0,delta:{thinking:i.thinking},finish_reason:null}]}:i?.type==="text_delta"?{choices:[{index:0,delta:{content:i.text},finish_reason:null}]}:i?.type==="input_json_delta"?{choices:[{index:0,delta:{tool_calls:[{index:e.index||0,function:{arguments:i.partial_json}}]},finish_reason:null}]}:null;case"message_delta":return{choices:[{index:0,delta:{},finish_reason:this.mapStopReason(e.delta?.stop_reason)}],usage:e.usage?{prompt_tokens:0,completion_tokens:e.usage.output_tokens,total_tokens:e.usage.output_tokens}:void 0};case"message_stop":return{choices:[{index:0,delta:{},finish_reason:"stop"}]};default:return null}}mapStopReason(e){switch(e){case"end_turn":return"stop";case"max_tokens":return"length";case"tool_use":return"tool_calls";default:return null}}}class ls extends st{name="gemini";constructor(e){super(e),this.baseURL||(this.baseURL="https://generativelanguage.googleapis.com/v1beta")}async create(e){const t=this.getModel(e),s=`${this.baseURL}/models/${t}:generateContent?key=${this.config.apiKey}`,n=this.buildRequestBody(e),i=await this.fetchJSON(s,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(n),signal:e.signal});return this.normalizeResponse(i,t)}async*stream(e){const t=this.getModel(e),s=`${this.baseURL}/models/${t}:streamGenerateContent?alt=sse&key=${this.config.apiKey}`,n=this.buildRequestBody(e),i=await this.fetchStream(s,{method:"POST",headers:this.buildHeaders(),body:JSON.stringify(n),signal:e.signal});for await(const o of nt(i))try{const a=JSON.parse(o),r=this.normalizeChunk(a,t);r&&(yield r)}catch{}}buildHeaders(){return{"Content-Type":"application/json"}}buildRequestBody(e){const{systemInstruction:t,contents:s}=this.convertMessages(e.messages),n={contents:s};t&&(n.systemInstruction={parts:[{text:t}]});const i={};return e.temperature!==void 0&&(i.temperature=e.temperature),e.maxTokens!==void 0&&(i.maxOutputTokens=e.maxTokens),e.topP!==void 0&&(i.topP=e.topP),e.stop!==void 0&&(i.stopSequences=Array.isArray(e.stop)?e.stop:[e.stop]),Object.keys(i).length>0&&(n.generationConfig=i),e.thinking&&(n.generationConfig=n.generationConfig||{},n.generationConfig.thinkingConfig={thinkingBudget:e.thinkingBudget||8e3}),e.tools&&e.tools.length>0&&(n.tools=[{functionDeclarations:e.tools.map(o=>({name:o.function.name,description:o.function.description,parameters:o.function.parameters}))}]),n}convertMessages(e){let t=null;const s=[];for(const n of e)if(n.role==="system"){const i=typeof n.content=="string"?n.content:n.content.map(o=>o.type==="text"?o.text:"").join(`
`);t=t?`${t}

${i}`:i}else s.push({role:n.role==="assistant"?"model":"user",parts:this.convertParts(n.content)});return{systemInstruction:t,contents:s}}convertParts(e){return typeof e=="string"?[{text:e}]:e.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){const s=t.image_url.url;if(s.startsWith("data:")){const[n,i]=s.split(",");return{inlineData:{mimeType:n.match(/data:(.*?);/)?.[1]||"image/jpeg",data:i}}}return{fileData:{fileUri:s}}}return{text:""}})}normalizeResponse(e,t){const s=e.candidates?.[0],n=s?.content?.parts||[];let i="",o="";const a=[];for(const r of n)r.text&&(i+=r.text),r.thought&&(o+=r.thought),r.functionCall&&a.push({id:`call_${Date.now()}_${a.length}`,type:"function",function:{name:r.functionCall.name,arguments:JSON.stringify(r.functionCall.args)}});return{id:`gemini-${Date.now()}`,model:t,choices:[{index:0,message:{role:"assistant",content:i,thinking:o||void 0,tool_calls:a.length>0?a:void 0},finish_reason:this.mapFinishReason(s?.finishReason)}],usage:e.usageMetadata?{prompt_tokens:e.usageMetadata.promptTokenCount||0,completion_tokens:e.usageMetadata.candidatesTokenCount||0,total_tokens:e.usageMetadata.totalTokenCount||0,thinking_tokens:e.usageMetadata.thoughtsTokenCount}:void 0}}normalizeChunk(e,t){const s=e.candidates?.[0];if(!s)return null;const n=s.content?.parts||[];let i="",o="";const a=[];for(const r of n)r.text&&(i+=r.text),r.thought&&(o+=r.thought),r.functionCall&&a.push({index:a.length,id:`call_${Date.now()}_${a.length}`,type:"function",function:{name:r.functionCall.name,arguments:JSON.stringify(r.functionCall.args)}});return!i&&!o&&a.length===0?null:{id:`gemini-${Date.now()}`,model:t,choices:[{index:0,delta:{content:i||void 0,thinking:o||void 0,tool_calls:a.length>0?a:void 0},finish_reason:this.mapFinishReason(s.finishReason)}],usage:e.usageMetadata?{prompt_tokens:e.usageMetadata.promptTokenCount||0,completion_tokens:e.usageMetadata.candidatesTokenCount||0,total_tokens:e.usageMetadata.totalTokenCount||0}:void 0}}mapFinishReason(e){switch(e){case"STOP":return"stop";case"MAX_TOKENS":return"length";case"TOOL_CODE":return"tool_calls";default:return null}}}const Re=10,Pe="default",to="默认",so=6e4,no=3,io=1e3,W={rdsec:{name:"RDSec",implementation:"openai-compatible",baseURL:"https://api.rdsec.trendmicro.com/prod/aiendpoint/v1/chat/completions",icon:"🛡️",supportsThinking:!0,models:[{id:"claude-4.5-opus",name:"Claude 4.5 Opus",icon:"👑"},{id:"gemini-3-pro",name:"Gemini 3 Pro",icon:"💫"},{id:"gpt-5.2",name:"GPT-5.2",icon:"✨"},{id:"claude-4.5-sonnet",name:"Claude 4.5 Sonnet",icon:"🎭"},{id:"gemini-3-flash",name:"Gemini 3 Flash",icon:"⚡"},{id:"claude-4.5-haiku",name:"Claude 4.5 Haiku",icon:"🍃"},{id:"gpt-4o",name:"GPT-4o (OpenAI)",icon:"🤖"},{id:"claude-4-sonnet",name:"Claude 4 Sonnet",icon:"🏺"},{id:"claude-4.5-haiku",name:"Claude 4.5 Haiku",icon:"🍃"},{id:"deepseek-r1",name:"DeepSeek R1",icon:"🧠",supportsThinking:!0},{id:"deepseek-r1-0528",name:"DeepSeek R1 0528",icon:"🧠",supportsThinking:!0},{id:"deepseek-r1-aws",name:"DeepSeek R1 AWS",icon:"☁️",supportsThinking:!0},{id:"deepseek-v3.1",name:"DeepSeek v3.1",icon:"🐋"},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",icon:"✨"},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",icon:"🌟"},{id:"gemini-3-flash",name:"Gemini 3 Flash",icon:"⚡"},{id:"gpt-4",name:"GPT-4",icon:"🧱"},{id:"gpt-4-32k",name:"GPT-4 32k",icon:"📦"},{id:"gpt-4.1",name:"GPT-4.1",icon:"🔧"},{id:"gpt-4.1-mini",name:"GPT-4.1 Mini",icon:"🍃"},{id:"gpt-4.1-nano",name:"GPT-4.1 Nano",icon:"🧬"},{id:"gpt-4o-mini",name:"GPT-4o Mini",icon:"⚡"},{id:"gpt-5",name:"GPT-5",icon:"🚀"},{id:"gpt-5-chat",name:"GPT-5 Chat",icon:"💬"},{id:"gpt-5-codex",name:"GPT-5 Codex",icon:"💻"},{id:"gpt-5-mini",name:"GPT-5 Mini",icon:"🍃"},{id:"gpt-5-nano",name:"GPT-5 Nano",icon:"🧬"},{id:"gpt-5.1",name:"GPT-5.1",icon:"🎯"}]},anthropic:{name:"Anthropic",implementation:"anthropic",baseURL:"https://api.anthropic.com/v1/messages",icon:"🏺",supportsThinking:!0,models:[{id:"claude-sonnet-4-5-20250929",name:"Claude Sonnet 4.5",icon:"🎭"},{id:"claude-opus-4-1-20250805",name:"Claude Opus 4.1",icon:"👑"},{id:"claude-opus-4-20250514",name:"Claude Opus 4",icon:"💎"},{id:"claude-sonnet-4-20250514",name:"Claude Sonnet 4",icon:"🎨"},{id:"claude-3-7-sonnet-latest",name:"Claude Sonnet 3.7 (Latest)",icon:"🔥"},{id:"claude-3-7-sonnet-20250219",name:"Claude Sonnet 3.7",icon:"⚡"}]},gemini:{name:"Google Gemini",implementation:"gemini",baseURL:"https://generativelanguage.googleapis.com/v1beta/models",icon:"💎",supportsThinking:!0,models:[{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",icon:"🌟"},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",icon:"⚡"},{id:"gemini-pro",name:"Gemini Pro",icon:"🌌"}]},deepseek:{name:"DeepSeek",implementation:"openai-compatible",baseURL:"https://api.deepseek.com/v1/chat/completions",icon:"🐋",supportsThinking:!0,models:[{id:"deepseek-chat",name:"DeepSeek Chat",icon:"💬"},{id:"deepseek-reasoner",name:"DeepSeek Reasoner",icon:"🧠",supportsThinking:!0}]},"deepseek-Speciale":{name:"DeepSeek-Speciale",implementation:"openai-compatible",baseURL:"https://api.deepseek.com/v3.2_speciale_expires_on_20251215/v1/chat/completions",icon:"✨",supportsThinking:!0,models:[{id:"deepseek-reasoner",name:"DeepSeek Reasoner",icon:"🧠",supportsThinking:!0}]},openrouter:{name:"OpenRouter",implementation:"openai-compatible",baseURL:"https://openrouter.ai/api/v1/chat/completions",icon:"🌐",requiresReferer:!0,supportsThinking:!0,models:[{id:"openrouter/auto",name:"Auto (Best Model)",icon:"🪄"},{id:"openai/gpt-5-pro",name:"OpenAI: GPT-5 Pro",icon:"👑"},{id:"openai/gpt-5-codex",name:"OpenAI: GPT-5 Codex",icon:"💻"},{id:"openai/gpt-5-mini",name:"OpenAI: GPT-5 Mini",icon:"🍃"},{id:"anthropic/claude-sonnet-4.5",name:"Anthropic: Claude Sonnet 4.5",icon:"🎭"},{id:"anthropic/claude-opus-4.1",name:"Anthropic: Claude Opus 4.1",icon:"👑"},{id:"google/gemini-2.5-pro",name:"Google: Gemini 2.5 Pro",icon:"🌟"},{id:"google/gemini-2.5-flash",name:"Google: Gemini 2.5 Flash",icon:"⚡"},{id:"meta-llama/llama-4-maverick",name:"Meta: Llama 4 Maverick",icon:"🦙"},{id:"nousresearch/hermes-4-405b",name:"Nous: Hermes 4 405B",icon:"🧪"},{id:"mistralai/mistral-large-2411",name:"Mistral: Mistral Large 2411",icon:"⛵"},{id:"z-ai/glm-4.6",name:"Z.AI: GLM 4.6",icon:"🌏"},{id:"x-ai/grok-4",name:"xAI: Grok 4",icon:"🏴‍☠️"}]},cloudapi:{name:"CloudAPI",implementation:"openai-compatible",baseURL:"https://chat.cloudapi.vip/v1/chat/completions",supportsThinking:!0,icon:"☁️",models:[{id:"claude-opus-4-5-20251101",name:"Opus 4.5",icon:"👑"},{id:"claude-sonnet-4-5-20250929-thinking",name:"Sonnet 4.5 Think",icon:"🧠",supportsThinking:!0}]},openai:{name:"OpenAI",implementation:"openai-compatible",baseURL:"https://api.openai.com/v1/chat/completions",icon:"🤖",supportsThinking:!0,models:[{id:"gpt-4o",name:"GPT-4o",icon:"⚡"},{id:"gpt-5-pro",name:"GPT-5 Pro",icon:"👑"},{id:"gpt-5",name:"GPT-5",icon:"🚀"},{id:"gpt-5-mini",name:"GPT-5 Mini",icon:"🍃"},{id:"gpt-5-codex",name:"GPT-5 CodeX",icon:"💻"}]},custom:{name:"Custom (OpenAI Compatible)",implementation:"openai-compatible",baseURL:"",icon:"🛠️",models:[]}},Ve="/default",he="/default/providers",ue=[{id:Pe,name:to,type:"agent",icon:"🤖",description:"A helpful AI assistant",initPath:Ve,initialTags:["system","default"],config:{connectionId:Pe,modelName:"",systemPrompt:"You are a helpful assistant."}},{id:"tmp-id",name:"临时",type:"agent",icon:"⚡️",description:"一次性问答，保留4次对话历史",initialTags:["default"],initPath:Ve,config:{connectionId:Pe,modelName:"",systemPrompt:"You are a helpful assistant. Answer the user's current prompt concisely and accurately, without referring to any past conversation history.",maxHistoryLength:4},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"deepseek",name:"DeepSeek",type:"agent",icon:"🌊",description:"使用 DeepSeek 模型的智能体",initialTags:["default","deepseek"],initPath:he,config:{connectionId:"conn-deepseek",modelName:"",systemPrompt:"You are a helpful assistant powered by DeepSeek.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"claude",name:"Claude",type:"agent",icon:"📚",description:"使用 Claude 模型的智能体",initialTags:["default","claude"],initPath:he,config:{connectionId:"conn-anthropic",modelName:"",systemPrompt:"You are a helpful, harmless, and honest assistant.",maxHistoryLength:20},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"gemini",name:"Gemini",type:"agent",icon:"💎",description:"使用 Gemini 模型的智能体",initialTags:["default","gemini"],initPath:he,config:{connectionId:"conn-gemini",modelName:"",systemPrompt:"You are a helpful assistant powered by Google Gemini.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"openrouter",name:"OpenRouter",type:"agent",icon:"🔀",description:"使用 OpenRouter 自动选择最佳模型的智能体",initialTags:["default","router"],initPath:he,config:{connectionId:"conn-openrouter",modelName:"",systemPrompt:"You are a helpful assistant, routed through OpenRouter.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}},{id:"cloudapi",name:"CloudAPI",type:"agent",icon:"☁️",description:"使用 CloudAPI 模型的智能体",initialTags:["default","cloudapi"],initPath:he,config:{connectionId:"conn-cloudapi",modelName:"",systemPrompt:"You are a helpful assistant, routed through CloudAPI.",maxHistoryLength:-1},interface:{inputs:[{name:"prompt",type:"string"}],outputs:[{name:"response",type:"string"}]}}],J=new Map;function oo(){J.set("openai",X),J.set("deepseek",X),J.set("groq",X),J.set("openrouter",X),J.set("ollama",X),J.set("custom",X),J.set("anthropic",rs),J.set("gemini",ls)}oo();function ao(l,e){const{provider:t}=l,s=e?.[t]||W[t];let n;if(s){switch(s.implementation){case"openai-compatible":n=X;break;case"anthropic":n=rs;break;case"gemini":n=ls;break}l={...l,supportsThinking:l.supportsThinking??s.supportsThinking,requiresReferer:l.requiresReferer??s.requiresReferer,apiBaseUrl:l.apiBaseUrl||s.baseURL}}return n||(n=J.get(t)),n||(console.warn(`[LLMDriver] Unknown provider "${t}", using OpenAI compatible mode`),n=X),new n(l)}class cs{provider;config;constructor(e){const t=e.connection?.provider||e.provider,s=e.connection?.apiKey||e.apiKey,n=e.connection?.baseURL||e.apiBaseUrl,i=e.connection?.model||e.model;if(!t)throw new Error("LLMDriver requires provider (either directly or via connection)");if(!s)throw new Error("LLMDriver requires apiKey (either directly or via connection)");const o={provider:t,apiKey:s,apiBaseUrl:n,model:i,supportsThinking:e.supportsThinking,requiresReferer:e.requiresReferer,headers:e.headers,metadata:e.connection?.metadata};this.config={maxRetries:e.maxRetries??no,retryDelay:e.retryDelay??io,timeout:e.timeout??so,...e},this.provider=ao(o,e.customProviderDefaults)}get chat(){return{create:this.createChatCompletion.bind(this)}}get providerName(){return this.provider.name}get currentModel(){return this.config.model||this.config.connection?.model}async createChatCompletion(e){let t={...e};this.config.hooks?.beforeRequest&&(t=await this.config.hooks.beforeRequest(t));const s=new AbortController,n=setTimeout(()=>s.abort(),this.config.timeout);t.signal&&t.signal.addEventListener("abort",()=>s.abort()),t.signal=s.signal;try{if(t.stream){const i=this.provider.stream(t);return clearTimeout(n),this.wrapStreamWithTimeout(i,s,n)}else{const i=await this.executeWithRetry(()=>this.provider.create(t));return clearTimeout(n),this.config.hooks?.afterResponse?this.config.hooks.afterResponse(i):i}}catch(i){clearTimeout(n);const o=i instanceof H?i:H.fromException(this.providerName,i);throw this.config.hooks?.onError&&await this.config.hooks.onError(o,t),o}}async executeWithRetry(e,t=1){try{return await e()}catch(s){const n=s instanceof H?s:H.fromException(this.providerName,s);if(n.retryable&&t<this.config.maxRetries){const o=n.retryAfter||this.config.retryDelay*Math.pow(2,t-1);return console.log(`[LLMDriver] Retrying in ${o}ms (attempt ${t+1}/${this.config.maxRetries})`),await this.sleep(o),this.executeWithRetry(e,t+1)}throw n}}async*wrapStreamWithTimeout(e,t,s){try{for await(const n of e)clearTimeout(s),yield n}finally{clearTimeout(s)}}sleep(e){return new Promise(t=>setTimeout(t,e))}}async function ro(l){const{provider:e,apiKey:t,baseURL:s,model:n,timeout:i=15e3}=l;if(!e)return{success:!1,message:"Provider is required"};if(!t)return{success:!1,message:"API Key is required"};const o=n||W[e]?.models?.[0]?.id||"gpt-4o-mini",a=Date.now();try{const c=await new cs({provider:e,apiKey:t,apiBaseUrl:s,model:o,timeout:i,maxRetries:1}).chat.create({messages:[{role:"user",content:"Hi"}],model:o,maxTokens:5,stream:!1}),d=Date.now()-a;return c.choices?.length>0?{success:!0,message:"Connection successful",latency:d,model:c.model||o}:{success:!1,message:"Response was empty",latency:d}}catch(r){const c=Date.now()-a;return r instanceof H?{success:!1,message:`${r.code}: ${r.message}`,latency:c}:r.name==="AbortError"?{success:!1,message:"Request timed out",latency:c}:{success:!1,message:r.message||"Unknown error",latency:c}}}class lo{constructor(e,t,s){this.id=e,this.name=t,this.config=s,this.driver=new cs({connection:s.connection,model:s.model})}type="agent";driver;async execute(e,t){const s=Date.now(),n=this.buildMessages(e,t);t.events.emit("node:start",{executorId:this.id,executorType:this.type,input:e});let i="",o="";try{const a=await this.driver.chat.create({messages:n,model:this.config.model,stream:!0,thinking:!0,signal:t.signal});for await(const r of a){t.checkCancelled();const c=r.choices[0]?.delta;c&&(c.thinking&&(o+=c.thinking,t.emitThinking(c.thinking)),c.content&&(i+=c.content,t.emitContent(c.content)),c.tool_calls&&await this.handleToolCalls(c.tool_calls,t))}return{status:"success",output:i,control:{action:"continue"},metadata:{executorId:this.id,executorType:this.type,startTime:s,endTime:Date.now(),duration:Date.now()-s,thinkingLength:o.length}}}catch(a){return console.error("[AgentExecutor] Error:",a),t.emitError(a),{status:"failed",output:null,control:{action:"end",reason:a.message},errors:[{code:a.code||"LLM_ERROR",message:a.message,recoverable:this.isRecoverable(a)}]}}}buildMessages(e,t){const s=[];this.config.systemPrompt&&s.push({role:"system",content:this.config.systemPrompt});const n=t.variables.get("history")||[];s.push(...n);const i=typeof e=="string"?e:JSON.stringify(e);return s.push({role:"user",content:i}),s}async handleToolCalls(e,t){for(const s of e){const n=this.config.tools?.find(i=>i.name===s.function.name);if(n?.handler){t.events.emit("stream:tool_call",{toolName:s.function.name,args:s.function.arguments,status:"running"});try{const i=JSON.parse(s.function.arguments),o=await n.handler(i,t);t.events.emit("stream:tool_call",{toolName:s.function.name,result:o,status:"success"})}catch(i){t.events.emit("stream:tool_call",{toolName:s.function.name,error:i.message,status:"failed"})}}}}isRecoverable(e){const t=e.statusCode||e.status;return t>=500||t===429}validate(e){return e==null?{valid:!1,errors:["Input cannot be empty"]}:{valid:!0}}}class co{constructor(e,t,s){this.id=e,this.name=t,this.config=s}type="http";async execute(e,t){const s=Date.now();t.events.emit("node:start",{executorId:this.id,executorType:this.type,url:this.config.url,method:this.config.method});try{const n=this.interpolate(this.config.url,e,t),i=this.buildBody(e,t),o=this.buildHeaders(t),a=await this.fetchWithRetry(n,{method:this.config.method,headers:o,body:i,signal:t.signal}),r=await this.parseResponse(a);return{status:"success",output:this.extractOutput(r),control:{action:"continue"},metadata:{executorId:this.id,executorType:this.type,startTime:s,endTime:Date.now(),statusCode:a.status,url:n}}}catch(n){return t.emitError(n),{status:"failed",output:null,control:{action:"end",reason:n.message},errors:[{code:"HTTP_ERROR",message:n.message,recoverable:!1}]}}}async fetchWithRetry(e,t,s=1){try{const n=await fetch(e,t);if(this.config.retryOn?.includes(n.status)&&s<(this.config.maxRetries||3))return await this.delay(this.config.retryDelay||1e3),this.fetchWithRetry(e,t,s+1);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n}catch(n){if(n.name==="AbortError")throw n;if(s<(this.config.maxRetries||3))return await this.delay(this.config.retryDelay||1e3),this.fetchWithRetry(e,t,s+1);throw n}}interpolate(e,t,s){let n=e;typeof t=="string"&&(n=n.replace(/\{\{input\}\}/g,encodeURIComponent(t)));const i=s.variables.toObject();return n=n.replace(/\{\{var\.(\w+)\}\}/g,(o,a)=>encodeURIComponent(String(i[a]||""))),n}buildBody(e,t){if(this.config.method!=="GET")return this.config.bodyTemplate?this.interpolate(this.config.bodyTemplate,e,t):e&&typeof e=="object"?JSON.stringify(e):typeof e=="string"?e:void 0}buildHeaders(e){return{"Content-Type":"application/json",...this.config.headers}}async parseResponse(e){switch(this.config.responseType){case"text":return e.text();case"blob":return e.blob();default:return e.json()}}extractOutput(e){if(!this.config.extractPath)return e;const t=this.config.extractPath.split(".");let s=e;for(const n of t){const i=n.match(/^(\w+)(?:\[(\d+)\])?$/);if(!i)break;s=s?.[i[1]],i[2]!==void 0&&(s=s?.[parseInt(i[2])])}return s}delay(e){return new Promise(t=>setTimeout(t,e))}}class it{constructor(e,t,s,n){this.id=e,this.name=t,this.config=s,this.factory=n,this.initializeChildren()}type="composite";children=[];initializeChildren(){this.children=this.config.children.map(e=>this.factory.create(e))}async executeChild(e,t,s){const n=s.createChild(e.id);s.events.emit("node:start",{executorId:e.id,executorType:e.type,name:e.name},e.id);try{const i=await e.execute(t,n);return s.events.emit("node:complete",{executorId:e.id,status:i.status,output:i.output},e.id),s.results.set(e.id,i),i}catch(i){throw s.events.emit("node:error",{executorId:e.id,error:i.message},e.id),i}}mergeResults(e){const t=e.some(n=>n.status==="failed");return{status:e.every(n=>n.status==="success")?"success":t?"failed":"partial",output:e.map(n=>n.output),control:{action:"continue"},errors:e.flatMap(n=>n.errors||[])}}}class ho extends it{async execute(e,t){let s=e,n=null;t.events.emit("node:start",{executorId:this.id,mode:"serial",childCount:this.children.length});for(let i=0;i<this.children.length;i++){t.checkCancelled();const o=this.children[i];try{if(n=await this.executeChild(o,s,t),n.control.action==="end")break;if(n.control.action==="route"){const a=this.children.findIndex(r=>r.id===n.control.target);a!==-1&&(i=a-1)}s=n.output}catch(a){if(this.config.constraints?.maxRetries&&n?.errors?.[0]?.recoverable){t.events.emit("execution:progress",{action:"retry",childId:o.id}),i--;continue}throw a}}return n||{status:"success",output:s,control:{action:"end"}}}}class uo extends it{async execute(e,t){const s=this.config.modeConfig?.parallel,n=s?.maxConcurrency||this.children.length;t.events.emit("node:start",{executorId:this.id,mode:"parallel",childCount:this.children.length,maxConcurrency:n});const i=await this.executeWithConcurrencyLimit(this.children,e,t,n);return s?.mergeStrategy==="first"?i.find(a=>a.status==="success")||i[0]:this.mergeResults(i)}async executeWithConcurrencyLimit(e,t,s,n){const i=[],o=[];for(let a=0;a<e.length;a++){s.checkCancelled();const r=e[a],c=a,d=this.executeChild(r,t,s).then(h=>{i[c]=h}).catch(h=>{i[c]={status:"failed",output:null,control:{action:"end"},errors:[{code:"EXECUTION_ERROR",message:h.message,recoverable:!1}]}});if(o.push(d),o.length>=n){await Promise.race(o);const h=o.findIndex(u=>u.then(()=>!0).catch(()=>!0));h!==-1&&o.splice(h,1)}}return await Promise.all(o),i}}class po extends it{async execute(e,t){const s=this.config.modeConfig?.router;t.events.emit("node:start",{executorId:this.id,mode:"router",strategy:s?.strategy||"rule"});const n=await this.selectTarget(e,t);return n?(t.events.emit("execution:progress",{action:"route",selectedTarget:n.id}),this.executeChild(n,e,t)):{status:"failed",output:null,control:{action:"end",reason:"No matching route found"},errors:[{code:"NO_ROUTE",message:"No matching route found",recoverable:!1}]}}async selectTarget(e,t){const s=this.config.modeConfig?.router;return s?.strategy==="llm"?this.selectByLLM(e,t):this.selectByRules(e,t,s?.rules||[])}selectByRules(e,t,s){const n=typeof e=="string"?e:JSON.stringify(e),i=t.variables.toObject();for(const o of s)if(this.evaluateCondition(o.condition,n,i))return this.children.find(a=>a.id===o.target)||null;return this.children[0]||null}evaluateCondition(e,t,s){try{if(e.startsWith("contains:")){const n=e.slice(9).trim();return t.toLowerCase().includes(n.toLowerCase())}if(e.startsWith("startsWith:")){const n=e.slice(11).trim();return t.startsWith(n)}if(e.startsWith("equals:")){const n=e.slice(7).trim();return t===n}if(e.startsWith("regex:")){const n=e.slice(6).trim();return new RegExp(n,"i").test(t)}if(e.startsWith("var:")){const n=e.slice(4).trim();return!!s[n]}return!0}catch{return!1}}async selectByLLM(e,t){const s=this.children.find(r=>r.type==="agent");if(!s)return this.children[0]||null;const i=`
Based on the user input, select the most appropriate handler.

Available handlers:
${this.children.filter(r=>r.id!==s.id).map(r=>`- ${r.id}: ${r.name}`).join(`
`)}

User input: ${typeof e=="string"?e:JSON.stringify(e)}

Respond with only the handler ID.
        `.trim(),o=t.createChild(s.id),a=await s.execute(i,o);if(a.status==="success"&&typeof a.output=="string"){const r=a.output.trim();return this.children.find(c=>c.id===r)||this.children[0]}return this.children[0]||null}}class go{executorCreators=new Map;orchestratorCreators=new Map;instances=new Map;constructor(){this.registerBuiltins()}registerBuiltins(){this.registerExecutor("agent",e=>{const t=e;return new lo(e.id,e.name,t)}),this.registerExecutor("http",e=>{const t=e;return new co(e.id,e.name,t)}),this.registerOrchestrator("serial",(e,t)=>new ho(e.id,e.name,e,t)),this.registerOrchestrator("parallel",(e,t)=>new uo(e.id,e.name,e,t)),this.registerOrchestrator("router",(e,t)=>new po(e.id,e.name,e,t))}registerExecutor(e,t){this.executorCreators.set(e,t)}registerOrchestrator(e,t){this.orchestratorCreators.set(e,t)}create(e){if(this.instances.has(e.id))return this.instances.get(e.id);let t;if(e.type==="composite"){const s=e,n=this.orchestratorCreators.get(s.mode);if(!n)throw new Error(`Unknown orchestration mode: ${s.mode}`);t=n(e,this)}else{const s=this.executorCreators.get(e.type);if(!s)throw new Error(`Unknown executor type: ${e.type}`);t=s(e,this)}return this.instances.set(e.id,t),t}supports(e){return this.executorCreators.has(e)||e==="composite"}getRegisteredTypes(){return{executors:Array.from(this.executorCreators.keys()),orchestrators:Array.from(this.orchestratorCreators.keys())}}clearCache(){this.instances.clear()}}let Oe=null;function ds(){return Oe||(Oe=new go),Oe}class mo{eventBus;factory;activeExecutions=new Map;constructor(e){this.eventBus=et(),this.factory=e||ds()}async execute(e,t,s={}){const n=s.executionId||s.variables?.sessionId||$(),i=new AbortController;s.signal&&s.signal.addEventListener("abort",()=>{i.abort()});let o;s.timeout&&(o=setTimeout(()=>{i.abort()},s.timeout)),this.activeExecutions.set(n,i);const a=this.eventBus.createScope(n),r=new tt(n,a,void 0,0,void 0,i);if(s.rootNodeId&&r.setCurrentNode(s.rootNodeId),s.variables)for(const[c,d]of Object.entries(s.variables))r.variables.set(c,d);try{a.emit("execution:start",{executionId:n,config:{id:e.id,name:e.name,type:e.type}});const d=await this.factory.create(e).execute(t,r);return a.emit("execution:complete",{executionId:n,status:d.status,output:d.output}),d}catch(c){return a.emit("execution:error",{executionId:n,error:c.message,code:c.code}),{status:"failed",output:null,control:{action:"end",reason:c.message},errors:[{code:c.code||"RUNTIME_ERROR",message:c.message,recoverable:!1}]}}finally{o&&clearTimeout(o),this.activeExecutions.delete(n),this.eventBus.destroyScope(n)}}cancel(e){const t=this.activeExecutions.get(e);return t?(t.abort(),!0):!1}cancelAll(){for(const e of this.activeExecutions.values())e.abort();this.activeExecutions.clear()}getActiveCount(){return this.activeExecutions.size}onEvent(e){return this.eventBus.on("*",e)}onExecutionEvent(e,t){return this.eventBus.on("*",t,{filter:s=>s.executionId===e})}}let Fe=null;function hs(){return Fe||(Fe=new mo),Fe}class fo{plugins=new Map;registry;eventBus;config={};constructor(){this.registry=ds(),this.eventBus=et()}setConfig(e){this.config={...this.config,...e}}async register(e){const{id:t}=e.metadata;if(this.plugins.has(t))throw new Error(`Plugin ${t} is already registered`);await this.checkDependencies(e.metadata);const s=this.createPluginContext(e.metadata);await e.initialize(s),this.plugins.set(t,e),console.log(`[PluginManager] Registered plugin: ${t} v${e.metadata.version}`)}async unregister(e){const t=this.plugins.get(e);t&&(t.destroy&&await t.destroy(),this.plugins.delete(e),console.log(`[PluginManager] Unregistered plugin: ${e}`))}getPlugins(){return Array.from(this.plugins.values()).map(e=>e.metadata)}async checkDependencies(e){if(e.dependencies){for(const t of e.dependencies)if(!this.plugins.has(t))throw new Error(`Plugin ${e.id} requires ${t} which is not loaded`)}}createPluginContext(e){const t=`[Plugin:${e.id}]`;return{registerExecutor:(s,n)=>{this.registry.registerExecutor(s,n)},registerOrchestrator:(s,n)=>{this.registry.registerOrchestrator(s,n)},onEvent:(s,n)=>this.eventBus.on(s,n),getConfig:s=>this.config[s],log:{debug:(s,...n)=>console.debug(t,s,...n),info:(s,...n)=>console.info(t,s,...n),warn:(s,...n)=>console.warn(t,s,...n),error:(s,...n)=>console.error(t,s,...n)}}}}let Be=null;function yo(){return Be||(Be=new fo),Be}async function vo(l={}){const e=hs(),t=yo();if(l.config&&t.setConfig(l.config),l.plugins)for(const s of l.plugins)await t.register(s);return console.log("[Kernel] Initialized"),{runtime:e,pluginManager:t}}class bo{nodeMap=new Map;bridge(e,t){const s=et(),n=o=>{if(o.executionId!==e)return;const a=this.convertToUIEvent(o);a&&t(a)},i=[s.on("node:start",n),s.on("node:update",n),s.on("node:complete",n),s.on("node:error",n),s.on("stream:thinking",n),s.on("stream:content",n),s.on("stream:tool_call",n),s.on("execution:complete",n),s.on("execution:error",n)];return()=>{i.forEach(o=>o()),this.nodeMap.clear()}}convertToUIEvent(e){const{type:t,nodeId:s,payload:n,executionId:i}=e;switch(t){case"node:start":return this.handleNodeStart(s,n);case"stream:thinking":return{type:"node_update",payload:{nodeId:s||"",chunk:n.delta,field:"thought"}};case"stream:content":return{type:"node_update",payload:{nodeId:s||n?.nodeId||"",chunk:n.delta||n.content,field:"output"}};case"node:update":return n.status?{type:"node_status",payload:{nodeId:s||"",status:n.status}}:null;case"node:complete":return{type:"node_status",payload:{nodeId:s||"",status:n.status==="success"?"success":"failed",result:n.output}};case"node:error":return{type:"error",payload:{message:n.error||n.message||"Unknown error",error:new Error(n.error||n.message)}};case"execution:complete":return{type:"finished",payload:{sessionId:i}};case"execution:error":return{type:"error",payload:{message:n.message||"Execution failed",error:new Error(n.message)}};case"stream:tool_call":return{type:"node_update",payload:{nodeId:s||"",metaInfo:{toolCall:{name:n.toolName,args:n.args,result:n.result,status:n.status}}}};default:return null}}handleNodeStart(e,t){const s=e||$(),n={id:s,parentId:t.parentId,executorId:t.executorId||"unknown",executorType:t.executorType||"agent",name:t.name||t.executorId||"Node",status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:t.metaInfo||{}},children:[]};return this.nodeMap.set(s,n),{type:"node_start",payload:{node:n,parentId:t.parentId}}}getNode(e){return this.nodeMap.get(e)}clear(){this.nodeMap.clear()}}class wo{runtime;uiAdapter;constructor(){this.runtime=hs(),this.uiAdapter=new bo}async executeQuery(e,t,s){const{sessionId:n,history:i,files:o,onEvent:a,signal:r,rootNodeId:c}=s;let d;a&&(d=this.uiAdapter.bridge(n,h=>{a(h)}));try{return await this.runtime.execute(t,e,{variables:{history:i||[],files:o||[],sessionId:n},signal:r,executionId:n,rootNodeId:c})}finally{d?.()}}cancel(e){return this.runtime.cancel(e)}getRuntime(){return this.runtime}getActiveCount(){return this.runtime.getActiveCount()}}let Ue=null;function So(){return Ue||(Ue=new wo),Ue}class Eo{queue=Promise.resolve();pendingCount=0;enqueue(e){this.pendingCount++,this.queue=this.queue.then(e).catch(t=>console.error("[PersistQueue] Error:",t)).finally(()=>{this.pendingCount--})}async flush(){await this.queue}get isPending(){return this.pendingCount>0}}class xo{engine;persistQueue=new Eo;constructor(e){this.engine=e}async appendMessage(e,t,s,n,i){return this.engine.appendMessage(e,t,s,n,i)}async updateMessage(e,t,s){return this.engine.updateNode(e,t,s)}async deleteMessage(e,t){return this.engine.deleteMessage(e,t)}async editMessage(e,t,s,n){return this.engine.editMessage(e,t,s,n)}async getSessionContext(e,t){return this.engine.getSessionContext(e,t)}async getManifest(e){return this.engine.getManifest(e)}async getNodeSiblings(e,t){return this.engine.getNodeSiblings(e,t)}async readAsset(e,t){return this.engine.readSessionAsset(e,t)}async switchToBranch(e,t,s){const n=await this.engine.getManifest(e);n.current_head=s,n.branches[n.current_branch]=s,n.updated_at=new Date().toISOString(),await this.engine.writeContent(e,JSON.stringify(n,null,2))}enqueuePersist(e){this.persistQueue.enqueue(e)}async flush(){await this.persistQueue.flush()}createThrottledPersist(e,t,s=500){const n={output:"",thinking:""};let i=Date.now();return{accumulator:n,persist:()=>{if(!n.output&&!n.thinking)return;const r=Date.now();if(r-i<s)return;i=r;const c=n.output,d=n.thinking;this.enqueuePersist(async()=>{try{await this.updateMessage(e,t,{content:c,meta:{thinking:d,status:"running"}})}catch(h){console.warn("[PersistenceAdapter] Persist failed:",h)}})},finalize:async()=>{await this.flush()}}}}class yt{static chatNodeToSessionGroup(e){if(e.role==="user"){const t=(e.meta?.files||[]).map(s=>({name:s.name,type:s.type,path:s.path,size:s.size}));return{id:$(),timestamp:new Date(e.created_at).getTime(),role:"user",content:e.content,files:t,persistedNodeId:e.id}}return e.role==="assistant"?{id:$(),timestamp:new Date(e.created_at).getTime(),role:"assistant",executionRoot:{id:$(),executorId:e.meta?.agentId||"unknown",executorType:"agent",name:e.meta?.agentName||"Assistant",status:e.meta?.status||"success",startTime:new Date(e.created_at).getTime(),endTime:new Date(e.created_at).getTime(),data:{output:e.content,thought:e.meta?.thinking||"",metaInfo:e.meta||{},error:e.meta?.error},children:[]},persistedNodeId:e.id}:null}static sessionToMarkdown(e){const t=e.role==="user"?"👤 User":"🤖 Assistant",s=new Date(e.timestamp).toLocaleTimeString();let n=`### ${t} <small>(${s})</small>

`;if(e.role==="user"){if(e.files&&e.files.length>0){const i=e.files.map(o=>o.path?`[${o.name}](${o.path})`:`\`[File: ${o.name}]\``).join(", ");n+=`> Attachments: ${i}

`}n+=`${e.content||"(Empty)"}

`}else if(e.role==="assistant"&&e.executionRoot){const i=e.executionRoot;i.data.thought&&(n+=`> **Thinking Process:**
> 
`,n+=i.data.thought.split(`
`).map(o=>`> ${o}`).join(`
`),n+=`

`),n+=`${i.data.output||"(No output)"}

`}return n+=`---

`,n}static createUserSession(e,t,s){return{id:$(),timestamp:Date.now(),role:"user",content:e,files:t,persistedNodeId:s}}static createAssistantSession(e,t){return{id:$(),timestamp:Date.now(),role:"assistant",executionRoot:e,persistedNodeId:t}}static createExecutionNode(e,t,s,n){return{id:e,executorId:e,executorType:s,name:t,status:"running",startTime:Date.now(),data:{output:"",thought:"",metaInfo:n||{}},children:[]}}static sessionsToMarkdown(e){let t=`# Chat Session Export

`;const s=new Date().toLocaleString();t+=`> Exported at: ${s}

---

`;for(const n of e)t+=this.sessionToMarkdown(n);return t}static sessionsToJSON(e){const t=e.map(s=>({id:s.id,timestamp:s.timestamp,role:s.role,content:s.role==="user"?s.content:s.executionRoot?.data.output,thinking:s.executionRoot?.data.thought,files:s.files,metadata:s.executionRoot?.data.metaInfo}));return JSON.stringify(t,null,2)}static sessionsToPlainText(e){let t="";for(const s of e){const n=s.role==="user"?"User":"Assistant",i=new Date(s.timestamp).toLocaleTimeString();t+=`[${n} - ${i}]
`,s.role==="user"?t+=`${s.content||"(Empty)"}
`:s.executionRoot&&(t+=`${s.executionRoot.data.output||"(No output)"}
`),t+=`
---

`}return t}}class ae{static instance=null;sessions=new Map;sessionStates=new Map;activeSessionId=null;modelResolutionCache=new Map;taskQueue=[];runningTasks=new Map;maxConcurrent=de.MAX_CONCURRENT;globalListeners=new Set;sessionListeners=new Map;kernelAdapter;persistence;agentService;initialized=!1;markdownAnalyzer=new en;constructor(){}static getInstance(){return ae.instance||(ae.instance=new ae),ae.instance}initialize(e,t,s){this.initialized||(this.kernelAdapter=So(),this.persistence=new xo(t),this.agentService=e,s?.maxConcurrent&&(this.maxConcurrent=s.maxConcurrent),this.agentService.onChange(()=>{this.modelResolutionCache.clear()}),this.initialized=!0,console.log("[SessionRegistry] Initialized"))}ensureInitialized(){if(!this.initialized)throw new C(A.SESSION_INVALID,"SessionRegistry not initialized. Call initialize() first.")}async registerSession(e,t){if(this.ensureInitialized(),this.sessions.has(t)){const i=this.sessions.get(t);return i.lastActiveTime=Date.now(),this.sessionListeners.has(t)||this.sessionListeners.set(t,new Set),i}const s={sessionId:t,nodeId:e,status:"idle",lastActiveTime:Date.now(),unreadCount:0},n=new Ki(e,t);return await this.loadSessionData(n,e,t),this.sessions.set(t,s),this.sessionStates.set(t,n),this.sessionListeners.set(t,new Set),this.emitGlobal({type:"session_registered",payload:{sessionId:t}}),s}async unregisterSession(e,t){const s=this.sessions.get(e);if(s){if(s.status==="running"||s.status==="queued"){if(t?.keepInBackground){this.sessionListeners.get(e)?.clear();return}if(!t?.force)throw new C(A.SESSION_BUSY,"Session is still running. Use force=true or keepInBackground=true.");await this.abortSession(e)}this.sessions.delete(e),this.sessionStates.delete(e),this.sessionListeners.delete(e),this.activeSessionId===e&&(this.activeSessionId=null),this.emitGlobal({type:"session_unregistered",payload:{sessionId:e}})}}setActiveSession(e){if(this.activeSessionId=e,e){const t=this.sessions.get(e);t&&t.unreadCount>0&&(t.unreadCount=0,this.emitGlobal({type:"session_unread_updated",payload:{sessionId:e,count:0}}))}}getActiveSessionId(){return this.activeSessionId}async loadSessionData(e,t,s){try{const n=await this.persistence.getSessionContext(t,s);for(const i of n){const o=i.node;o.role!=="system"&&(o.role==="assistant"&&!o.content?.trim()||e.loadFromChatNode(o))}}catch(n){console.error(`[SessionRegistry] Failed to load session ${s}:`,n)}}async submitTask(e,t,s){this.ensureInitialized();const n=this.sessions.get(e);if(!n)throw new C(A.SESSION_NOT_FOUND,"Session not registered");if(n.status==="running"||n.status==="queued")throw new C(A.SESSION_BUSY,"Session already has active task");if(this.taskQueue.length>=de.MAX_QUEUE_SIZE)throw new C(A.QUOTA_EXCEEDED,"Task queue is full. Please wait.");const i={id:`task-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,sessionId:e,nodeId:n.nodeId,input:t,options:{skipUserMessage:s?.skipUserMessage,parentUserNodeId:s?.parentUserNodeId,branchInfo:s?.branchInfo},priority:s?.priority??0,createdAt:Date.now(),abortController:new AbortController};return n.currentTaskId=i.id,this.updateStatus(e,"queued"),this.enqueueTask(i),this.processQueue(),i.id}async abortSession(e){const t=this.sessions.get(e);if(!t)return;const s=this.taskQueue.findIndex(n=>n.sessionId===e);if(s!==-1){this.taskQueue.splice(s,1),this.updateStatus(e,"aborted"),this.emitPoolStatus();return}if(t.currentTaskId){const n=this.runningTasks.get(t.currentTaskId);n&&(n.abortController.abort(),this.runningTasks.delete(t.currentTaskId)),this.updateStatus(e,"aborted")}this.emitPoolStatus(),this.processQueue()}enqueueTask(e){const t=this.taskQueue.findIndex(s=>s.priority<e.priority);t===-1?this.taskQueue.push(e):this.taskQueue.splice(t,0,e),this.emitPoolStatus()}processQueue(){for(;this.runningTasks.size<this.maxConcurrent&&this.taskQueue.length>0;){const e=this.taskQueue.shift();this.executeTask(e)}}async executeTask(e){const{sessionId:t,nodeId:s,input:n,options:i}=e,o=this.sessionStates.get(t),a=this.sessions.get(t);if(!o||!a){console.error(`[SessionRegistry] Session ${t} not found`);return}this.runningTasks.set(e.id,e),this.updateStatus(t,"running"),this.emitPoolStatus();try{const r=[],c=new Set,d=await this.markdownAnalyzer.analyze(n.text,{filePath:"message.md"});for(const v of d.references){if(c.has(v))continue;c.add(v);const L=n.files.find(S=>S.name===v);if(L)r.push(L);else try{const S=await this.persistence.readAsset(t,v);S?r.push({name:v,type:S.type||fe(v),path:`./${v}`,size:S.size,fileRef:S}):console.warn(`[SessionRegistry] Asset not found in VFS: ${v}`)}catch(S){console.error(`[SessionRegistry] Failed to load asset: ${v}`,S)}}for(const v of n.files)c.has(v.name)||(r.push(v),c.add(v.name));let h=i.parentUserNodeId;if(!i.skipUserMessage){const v=r.map(S=>({name:S.name,type:S.type,path:S.path,size:S.size}));h=await this.persistence.appendMessage(s,t,"user",n.text,{files:v});const L=o.addUserMessage(n.text,r,h);this.emitSessionEvent(t,{type:"session_start",payload:L})}const u=await this.resolveExecutorConfig(n.executorId),p=i.branchInfo,m=await this.persistence.appendMessage(s,t,"assistant","",{agentId:u.id,agentName:u.name,status:"running",siblingIndex:p?.siblingIndex??0,siblingCount:p?.siblingCount??1,parentAssistantId:p?.parentAssistantId}),g=o.createAssistantMessage(u,m,p);this.emitSessionEvent(t,{type:"session_start",payload:o.getLastSession()}),this.emitSessionEvent(t,{type:"node_start",payload:{node:g}});const{accumulator:y,persist:b,finalize:E}=this.persistence.createThrottledPersist(t,m,de.PERSIST_THROTTLE),k=v=>{if(v.type==="node_start"){const L=v.payload;if(!L.parentId&&!L.node?.parentId)return}(v.type==="node_update"||v.type==="node_status")&&!v.payload.nodeId&&(v.payload.nodeId=g.id),v.type==="node_update"&&v.payload.chunk&&v.payload.nodeId===g.id&&(v.payload.field==="thought"?(y.thinking+=v.payload.chunk,o.appendToNode(g.id,v.payload.chunk,"thought")):v.payload.field==="output"&&(y.output+=v.payload.chunk,o.appendToNode(g.id,v.payload.chunk,"output")),b()),this.emitSessionEvent(t,v)},F=[];r.forEach(v=>{if(v.fileRef instanceof File)F.push(v.fileRef);else if(v.fileRef instanceof Blob){const L=new File([v.fileRef],v.name,{type:v.type});F.push(L)}});const B=await this.kernelAdapter.executeQuery(n.text,u,{sessionId:t,history:o.getHistory(),files:F,onEvent:k,signal:e.abortController.signal,rootNodeId:g.id});if(B.status==="failed"){const v=B.errors?.[0],L=new Error(v?.message||"Execution failed");throw L.status=v?.code,L}await E(),await this.persistence.updateMessage(t,m,{content:y.output,meta:{thinking:y.thinking,status:"success",endTime:Date.now()}}),o.updateNodeStatus(g.id,"success"),this.updateStatus(t,"completed"),this.emitSessionEvent(t,{type:"node_status",payload:{nodeId:g.id,status:"success"}}),this.emitSessionEvent(t,{type:"finished",payload:{sessionId:t}}),t!==this.activeSessionId&&(a.unreadCount++,this.emitGlobal({type:"session_unread_updated",payload:{sessionId:t,count:a.unreadCount}}))}catch(r){console.error("[SessionRegistry] Task execution failed:",r);const d=r.name==="AbortError"||e.abortController.signal.aborted?"aborted":"failed";this.updateStatus(t,d),a.error=r;const h=this.formatErrorMessage(r),u=o.getLastSession();if(u?.executionRoot){const p=u.executionRoot.id;o.updateNodeStatus(p,"failed"),o.updateNodeError(p,h),this.emitSessionEvent(t,{type:"node_status",payload:{nodeId:p,status:"failed",result:h}}),u.persistedNodeId&&await this.persistence.updateMessage(t,u.persistedNodeId,{meta:{status:"failed",error:h,endTime:Date.now()}})}this.emitSessionEvent(t,{type:"error",payload:{message:h,error:r instanceof Error?r:new Error(String(r))}})}finally{this.runningTasks.delete(e.id),a.currentTaskId=void 0,this.emitPoolStatus(),this.processQueue()}}formatErrorMessage(e){const t=e.status||e.code;return t===401?"Authentication failed: Invalid API key or token expired. Please check your connection settings.":t===403?"Access denied: You do not have permission to use this API.":t===429?"Rate limit exceeded: Too many requests. Please wait and try again.":t===500||t===502||t===503?`Server error (${t}): The LLM service is temporarily unavailable.`:e.message?.includes("fetch")||e.message?.includes("network")?"Network error: Unable to connect to the LLM service. Please check your internet connection.":e.message||"An unknown error occurred"}async resolveExecutorConfig(e){try{const t=await this.agentService.getAgentConfig(e);if(t){const s=await this.agentService.getConnection(t.config.connectionId);if(!s)throw new C(A.EXECUTOR_NOT_FOUND,`Connection '${t.config.connectionId}' for agent '${t.name}' not found.`);const n=this.resolveModelIdWithCache(s,t.config.modelName);return{id:t.id,name:t.name,type:t.type==="agent"?"agent":"composite",connection:s,model:n,systemPrompt:t.config.systemPrompt}}}catch(t){console.warn(`[SessionRegistry] Failed to resolve executor ${e}, using fallback.`,t)}return this.getFallbackExecutorConfig()}async getFallbackExecutorConfig(){const e=await this.agentService.getDefaultConnection();if(!e)return console.error("[SessionRegistry] CRITICAL: No connections available. Cannot create a fallback executor."),{id:"default",name:"Error: No Connection",type:"agent",connection:null,model:""};const t=e.model||e.availableModels?.[0]?.id||"";return{id:"default",name:"Default Assistant",type:"agent",connection:e,model:t}}resolveModelIdWithCache(e,t){if(!t)return"";const s=`${e.id}:${t}`;if(this.modelResolutionCache.has(s))return this.modelResolutionCache.get(s);let n=t;if(e.availableModels&&Array.isArray(e.availableModels)){const i=e.availableModels.find(o=>o.name===t);if(i)n=i.id;else{const o=e.availableModels.find(a=>a.id===t);o&&(n=o.id)}}return this.modelResolutionCache.set(s,n),n}updateStatus(e,t){const s=this.sessions.get(e);if(!s)return;const n=s.status;s.status=t,s.lastActiveTime=Date.now(),t!=="failed"&&(s.error=void 0),this.emitGlobal({type:"session_status_changed",payload:{sessionId:e,status:t,prevStatus:n}})}async deleteMessage(e,t,s){const n=this.sessionStates.get(e);if(!n)throw new C(A.SESSION_NOT_FOUND,"Session not found");const i={deleteAssociatedResponses:!0,...s},o=n.findSessionById(t);if(!o){console.warn(`[SessionRegistry] Message ${t} not found`);return}const a=[t];if(i.deleteAssociatedResponses&&o.role==="user"){const c=n.getSessions(),d=c.findIndex(h=>h.id===t);if(d!==-1)for(let h=d+1;h<c.length;h++){const u=c[h];if(u.role==="assistant")a.push(u.id),u.executionRoot&&this.collectNodeIds(u.executionRoot,a);else break}}for(const c of a)n.removeMessage(c);const r=n.getSessions();for(const c of a){const d=r.find(h=>h.id===c)||o;if(d?.persistedNodeId)try{await this.persistence.deleteMessage(e,d.persistedNodeId)}catch(h){console.warn(`[SessionRegistry] Failed to persist delete for ${c}:`,h)}}this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:a}})}collectNodeIds(e,t){if(t.push(e.id),e.children)for(const s of e.children)this.collectNodeIds(s,t)}async editMessage(e,t,s,n=!1){const i=this.sessionStates.get(e),o=this.sessions.get(e);if(!i||!o)throw new C(A.SESSION_NOT_FOUND,"Session not found");i.updateMessageContent(t,s);const a=i.findSessionById(t);a?.persistedNodeId&&await this.persistence.updateMessage(e,a.persistedNodeId,{content:s}),this.emitSessionEvent(e,{type:"message_edited",payload:{sessionId:t,newContent:s}}),n&&a?.role==="user"&&(await this.deleteAssociatedResponses(e,t,i),await this.submitTask(e,{text:s,files:a.files||[],executorId:"default"},{skipUserMessage:!0,parentUserNodeId:a.persistedNodeId}))}async resendUserMessage(e,t,s){const n=this.sessionStates.get(e);if(!n)throw new C(A.SESSION_NOT_FOUND,"Session not found");const i=n.findSessionById(t);if(!i||i.role!=="user")throw new C(A.SESSION_INVALID,"Invalid user session");await this.deleteAssociatedResponses(e,t,n),this.emitSessionEvent(e,{type:"retry_started",payload:{originalId:t,newId:""}}),await this.submitTask(e,{text:i.content||"",files:i.files||[],executorId:s?.agentId||"default"},{skipUserMessage:!0,parentUserNodeId:i.persistedNodeId})}async deleteAssociatedResponses(e,t,s){const n=s.getSessions(),i=n.findIndex(a=>a.id===t);if(i===-1)return;const o=[];for(let a=i+1;a<n.length;a++){const r=n[a];if(r.role==="assistant")o.push(r.id);else break}for(const a of o){s.removeMessage(a);const r=n.find(c=>c.id===a);if(r?.persistedNodeId)try{await this.persistence.deleteMessage(e,r.persistedNodeId)}catch(c){console.warn(`[SessionRegistry] Failed to delete response ${a}:`,c)}}o.length>0&&this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:o}})}async retryGeneration(e,t,s){const n=this.sessionStates.get(e),i=this.sessions.get(e);if(!n||!i)throw new C(A.SESSION_NOT_FOUND,"Session not found");const o=n.findUserMessageBefore(t);if(!o)throw new C(A.SESSION_INVALID,"No user message found");const a=n.findSessionById(t);let r=1,c=0;a&&(r=(a.siblingCount||1)+1,c=r-1,s?.preserveCurrent&&(a.siblingCount=r,a.executionRoot&&(a.executionRoot.data.metaInfo={...a.executionRoot.data.metaInfo,siblingIndex:a.siblingIndex||0,siblingCount:r}),a.persistedNodeId&&await this.persistence.updateMessage(e,a.persistedNodeId,{meta:{siblingIndex:a.siblingIndex||0,siblingCount:r}}),this.emitSessionEvent(e,{type:"sibling_switch",payload:{sessionId:t,newIndex:a.siblingIndex||0,total:r}}))),s?.preserveCurrent||(n.removeMessage(t),a?.persistedNodeId&&await this.persistence.deleteMessage(e,a.persistedNodeId),this.emitSessionEvent(e,{type:"messages_deleted",payload:{deletedIds:[t]}}),r=1,c=0),this.emitSessionEvent(e,{type:"retry_started",payload:{originalId:t,newId:"",siblingIndex:c,siblingCount:r}}),await this.submitTask(e,{text:o.content||"",files:o.files||[],executorId:s?.agentId||"default"},{skipUserMessage:!0,parentUserNodeId:o.persistedNodeId,branchInfo:{siblingIndex:c,siblingCount:r,parentAssistantId:s?.preserveCurrent?t:void 0}})}async getNodeSiblings(e,t){const s=this.sessionStates.get(e);if(!s)return[];const n=s.findSessionById(t);if(!n?.persistedNodeId)return n?[n]:[];try{const i=await this.persistence.getNodeSiblings(e,n.persistedNodeId);return i.map((o,a)=>{const r=yt.chatNodeToSessionGroup(o);return r&&(r.siblingIndex=a,r.siblingCount=i.length),r}).filter(Boolean)}catch(i){return console.error("[SessionRegistry] getNodeSiblings failed:",i),n?[n]:[]}}async switchToSibling(e,t,s,n){const i=this.sessionStates.get(t);if(!i)throw new C(A.SESSION_NOT_FOUND,"Session not found");const o=i.findSessionById(s);if(!o?.persistedNodeId)throw new C(A.SESSION_INVALID,"Message not found");try{const a=await this.persistence.getNodeSiblings(t,o.persistedNodeId);if(n<0||n>=a.length)throw new C(A.SESSION_INVALID,"Invalid sibling index");const r=a[n];await this.persistence.switchToBranch(e,t,r.id),i.clear(),await this.loadSessionData(i,e,t),this.emitSessionEvent(t,{type:"sibling_switch",payload:{sessionId:s,newIndex:n,total:a.length}}),this.emitSessionEvent(t,{type:"session_cleared",payload:{}});for(const c of i.getSessions())this.emitSessionEvent(t,{type:"session_start",payload:c})}catch(a){throw console.error("[SessionRegistry] switchToSibling failed:",a),C.from(a)}}async getAvailableExecutors(){try{const t=(await this.agentService.getAgents()).map(s=>({id:s.id,name:s.name,icon:s.icon,category:s.type==="agent"?"Agents":"Workflows",description:s.description}));return t.unshift({id:"default",name:"Default Assistant",icon:"🤖",category:"System",description:"Built-in default assistant"}),t}catch(e){return console.error("[SessionRegistry] getAvailableExecutors failed:",e),[{id:"default",name:"Default Assistant",icon:"🤖",category:"System"}]}}onGlobalEvent(e){return this.globalListeners.add(e),()=>this.globalListeners.delete(e)}onSessionEvent(e,t){let s=this.sessionListeners.get(e);return s||(s=new Set,this.sessionListeners.set(e,s)),s.add(t),()=>s?.delete(t)}emitGlobal(e){this.globalListeners.forEach(t=>{try{t(e)}catch(s){console.error("[SessionRegistry] Global event handler error:",s)}})}emitSessionEvent(e,t){const s=this.sessionListeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(i){console.error("[SessionRegistry] Session event handler error:",i)}})}emitPoolStatus(){this.emitGlobal({type:"pool_status_changed",payload:{running:this.runningTasks.size,queued:this.taskQueue.length,maxConcurrent:this.maxConcurrent}})}getSessionRuntime(e){return this.sessions.get(e)}getSessionMessages(e){return this.sessionStates.get(e)?.getSessions()||[]}getSessionState(e){return this.sessionStates.get(e)}getAllSessions(){return Array.from(this.sessions.values())}getRunningSessions(){return this.getAllSessions().filter(e=>e.status==="running")}getFailedSessions(){return this.getAllSessions().filter(e=>e.status==="failed")}getUnreadSessions(){return this.getAllSessions().filter(e=>e.unreadCount>0)}getPoolStatus(){return{running:this.runningTasks.size,queued:this.taskQueue.length,maxConcurrent:this.maxConcurrent,available:this.maxConcurrent-this.runningTasks.size}}exportToMarkdown(e){const t=this.sessionStates.get(e);return t?yt.sessionsToMarkdown(t.getSessions()):""}setMaxConcurrent(e){if(e<1)throw new Error("maxConcurrent must be at least 1");const t=this.maxConcurrent;this.maxConcurrent=e,console.log(`[SessionRegistry] maxConcurrent changed: ${t} -> ${e}`),this.emitPoolStatus(),e>t&&this.processQueue()}startAutoCleanup(e=de.CLEANUP_INTERVAL){const t=setInterval(()=>{this.cleanupIdleSessions()},e);return()=>clearInterval(t)}cleanupIdleSessions(e=de.SESSION_IDLE_TIMEOUT){const t=Date.now();let s=0;for(const[n,i]of this.sessions)n!==this.activeSessionId&&(i.status==="running"||i.status==="queued"||i.unreadCount>0||t-i.lastActiveTime>e&&(this.unregisterSession(n,{force:!0}).catch(console.error),s++));return s>0&&console.log(`[SessionRegistry] Cleaned up ${s} idle sessions`),s}getMemoryEstimate(){let e=0;for(const s of this.sessionStates.values())e+=s.getSessions().length;const t=e*10/1024;return{sessions:this.sessions.size,messages:e,estimatedMB:Math.round(t*100)/100}}getSessionSnapshot(e){const t=this.sessions.get(e),s=this.sessionStates.get(e),n=t?.status||"idle";return{runtime:t,sessions:s?.getSessions()||[],status:n,isRunning:n==="running"||n==="queued"}}async destroy(){for(const e of this.runningTasks.values())e.abortController.abort();this.runningTasks.clear(),this.taskQueue=[],this.sessions.clear(),this.sessionStates.clear(),this.sessionListeners.clear(),this.globalListeners.clear(),this.initialized=!1,console.log("[SessionRegistry] Destroyed")}debug(){console.group("[SessionRegistry] Debug Info"),console.log("Initialized:",this.initialized),console.log("Registered Sessions:",this.sessions.size),console.log("Active Session:",this.activeSessionId),console.log("Running Tasks:",this.runningTasks.size),console.log("Queued Tasks:",this.taskQueue.length),console.log("Max Concurrent:",this.maxConcurrent),console.group("Sessions:");for(const[e,t]of this.sessions){const s=this.sessionStates.get(e);console.log(`  ${e}: status=${t.status}, messages=${s?.getSessions().length||0}, unread=${t.unreadCount}`)}console.groupEnd(),console.groupEnd()}}function ot(){return ae.getInstance()}class _o{registry;sessionId=null;nodeId=null;eventUnsubscribe=null;bindingVersion=0;constructor(e={}){this.registry=ot()}async bindSession(e,t){const s=++this.bindingVersion;this.unbindSession(),this.bindingVersion=s;try{if(await this.registry.registerSession(e,t),this.bindingVersion!==s)throw console.log("[SessionManager] Bind cancelled (stale version)"),this.registry.unregisterSession(t,{keepInBackground:!0}).catch(()=>{}),new C(A.ABORTED,"Bind cancelled");return this.nodeId=e,this.sessionId=t,this.registry.setActiveSession(t),console.log(`[SessionManager] Bound to session: ${t}`),this.getSnapshot()}catch(n){throw console.error("[SessionManager] Bind failed:",n),C.from(n)}}getSnapshot(){if(!this.sessionId||!this.nodeId)return{sessionId:"",nodeId:"",sessions:[],status:"idle",isRunning:!1};const t=this.registry.getSessionRuntime(this.sessionId)?.status||"idle";return{sessionId:this.sessionId,nodeId:this.nodeId,sessions:this.registry.getSessionMessages(this.sessionId),status:t,isRunning:t==="running"||t==="queued"}}unbindSession(){this.bindingVersion++,this.eventUnsubscribe&&(this.eventUnsubscribe(),this.eventUnsubscribe=null),this.sessionId=null,this.nodeId=null}async loadSession(e,t){await this.bindSession(e,t)}onEvent(e){return this.sessionId?(this.eventUnsubscribe&&this.eventUnsubscribe(),this.eventUnsubscribe=this.registry.onSessionEvent(this.sessionId,e),this.eventUnsubscribe):()=>{}}getSessions(){return this.sessionId?this.registry.getSessionMessages(this.sessionId):[]}getCurrentSessionId(){return this.sessionId}getCurrentNodeId(){return this.nodeId}getStatus(){return this.sessionId?this.registry.getSessionRuntime(this.sessionId)?.status||"idle":"unbound"}isGenerating(){if(!this.sessionId)return!1;const e=this.registry.getSessionRuntime(this.sessionId);return e?.status==="running"||e?.status==="queued"}hasUnsavedChanges(){return!1}async runUserQuery(e,t,s){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");await this.registry.submitTask(this.sessionId,{text:e,files:t,executorId:s})}abort(){this.sessionId&&this.registry.abortSession(this.sessionId).catch(console.error)}async deleteMessage(e,t){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");const s={mode:"soft",cascade:!1,deleteAssociatedResponses:!0,...t};await this.registry.deleteMessage(this.sessionId,e,s)}async updateContent(e,t,s){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");await this.registry.editMessage(this.sessionId,e,t,!1)}async editMessage(e,t,s=!1){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");await this.registry.editMessage(this.sessionId,e,t,s)}async retryGeneration(e,t){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");await this.registry.retryGeneration(this.sessionId,e,{agentId:t?.agentId,preserveCurrent:t?.preserveCurrent??!0})}async resendUserMessage(e){if(!this.sessionId)throw new C(A.SESSION_INVALID,"No session bound");await this.registry.resendUserMessage(this.sessionId,e)}canDeleteMessage(e){return this.isGenerating()?{allowed:!1,reason:"Cannot delete while generating"}:{allowed:!0}}canRetry(e){return this.isGenerating()?{allowed:!1,reason:"Already generating"}:{allowed:!0}}canEdit(e){return this.isGenerating()?{allowed:!1,reason:"Cannot edit while generating"}:{allowed:!0}}async getSiblings(e){return this.sessionId?await this.registry.getNodeSiblings(this.sessionId,e):[]}async switchToSibling(e,t){!this.sessionId||!this.nodeId||await this.registry.switchToSibling(this.nodeId,this.sessionId,e,t)}async getAvailableExecutors(){return this.registry.getAvailableExecutors()}exportToMarkdown(){return this.sessionId?this.registry.exportToMarkdown(this.sessionId):""}destroy(){this.unbindSession()}}const Io=typeof process<"u"&&!1;class To{locks=new Map;waitQueues=new Map;async acquire(e,t){for(;this.locks.has(e);)await new Promise(i=>{const o=this.waitQueues.get(e)||[];o.push(i),this.waitQueues.set(e,o)});let s;const n=new Promise(i=>{s=i});this.locks.set(e,n);try{return await t()}finally{this.locks.get(e)===n&&this.locks.delete(e);const i=this.waitQueues.get(e);if(i&&i.length>0){const o=i.shift();i.length===0&&this.waitQueues.delete(e),o?.()}s()}}}class Co extends At{lockManager=new To;constructor(e){super(Nt,{description:"Chat Sessions"},e)}async onLoad(){}getHiddenDir(e){return`/.${e}`}getNodePath(e,t){return`${this.getHiddenDir(e)}/.${t}.json`}async createSession(e,t="You are a helpful assistant."){const s=$(),n=new Date().toISOString();await this.moduleEngine.createDirectory(this.getHiddenDir(s),null);const i=`node-${Date.now()}-root`,o={id:i,type:"message",role:"system",content:t,created_at:n,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(s,i),o);const a={version:"1.0",id:s,title:e,created_at:n,updated_at:n,settings:{model:"gpt-4",temperature:.7},branches:{main:i},current_branch:"main",current_head:i,root_id:i};return await this.moduleEngine.createFile(`${e}.chat`,null,JSON.stringify(a,null,2),{title:e,icon:"💬"}),this.notify(),s}async initializeExistingFile(e,t,s="You are a helpful assistant."){const n=$(),i=new Date().toISOString();try{await this.moduleEngine.createDirectory(this.getHiddenDir(n),null)}catch(c){if(!c.message?.includes("exists"))throw c}const o=`node-${Date.now()}-root`,a={id:o,type:"message",role:"system",content:s,created_at:i,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(n,o),a);const r={version:"1.0",id:n,title:t,created_at:i,updated_at:i,settings:{model:"gpt-4",temperature:.7},branches:{main:o},current_branch:"main",current_head:o,root_id:o};return await this.moduleEngine.writeContent(e,JSON.stringify(r,null,2)),await this.moduleEngine.updateMetadata(e,{title:t,icon:"💬",sessionId:n}),this.notify(),n}async getSessionContext(e,t){const s=await this.getManifest(e);if(!s)throw new Error("Manifest missing");const n=[];let i=s.current_head;for(;i;){const o=await this.readJson(this.getNodePath(t,i));if(!o)break;n.push(o),i=o.parent_id}return n.reverse().filter(o=>o.status==="active").map((o,a)=>({node:o,depth:a}))}async getManifest(e){try{const t=await this.moduleEngine.readContent(e);if(!t)throw new Error("Empty file content");const s=typeof t=="string"?t:new TextDecoder().decode(t);return JSON.parse(s)}catch(t){throw console.error(`[LLMSessionEngine] Failed to read manifest from node ${e}`,t),new Error(`Manifest missing for node: ${e}`)}}async appendMessage(e,t,s,n,i={}){return this.lockManager.acquire(`session:${t}`,async()=>{const o=await this.getManifest(e),a=o.current_head,r=$(),c=new Date().toISOString(),d={id:r,type:"message",role:s,content:n,created_at:c,parent_id:a,children_ids:[],meta:i,status:"active"};if(await this.writeJson(this.getNodePath(t,r),d),a){const h=await this.readJson(this.getNodePath(t,a));h&&(h.children_ids||(h.children_ids=[]),h.children_ids.push(r),await this.writeJson(this.getNodePath(t,a),h))}if(s==="user"){let h=!1;const u={};if((!o.summary||o.summary==="New conversation")&&(o.summary=n.substring(0,100).replace(/[\r\n]+/g," ").trim()),new Set(["New Chat","Untitled","New conversation"]).has(o.title)){let m=n.substring(0,30).replace(/[\r\n]+/g," ").trim();m.length===0&&(m="Chat"),o.title=m,u.title=m,h=!0}if(h)try{await this.moduleEngine.updateMetadata(e,u)}catch(m){console.warn(`[LLMSessionEngine] Failed to update metadata for ${e}`,m)}}return o.current_head=r,o.branches[o.current_branch]=r,o.updated_at=c,await this.moduleEngine.writeContent(e,JSON.stringify(o,null,2)),r})}async updateNode(e,t,s){return this.lockManager.acquire(`node:${e}:${t}`,async()=>{const n=this.getNodePath(e,t),i=await this.readJson(n);if(!i){console.warn(`[LLMSessionEngine] Node ${t} not found, skipping update`);return}let o=!1;s.content!==void 0&&s.content!==i.content&&(i.content=s.content,o=!0),s.status!==void 0&&s.status!==i.status&&(i.status=s.status,o=!0),s.meta&&(i.meta={...i.meta,...s.meta},o=!0),o&&await this.writeJson(n,i)})}async deleteMessage(e,t){const s=this.getNodePath(e,t),n=await this.readJson(s);n&&(n.status="deleted",await this.writeJson(s,n))}async editMessage(e,t,s,n){return this.lockManager.acquire(`session:${t}`,async()=>{const i=await this.getManifest(e),o=await this.readJson(this.getNodePath(t,s));if(!o)throw new Error("Original node not found");const a=$(),r=new Date().toISOString(),c={...o,id:a,content:n,created_at:r,children_ids:[]};if(await this.writeJson(this.getNodePath(t,a),c),c.parent_id){const d=await this.readJson(this.getNodePath(t,c.parent_id));d&&(d.children_ids.push(a),await this.writeJson(this.getNodePath(t,c.parent_id),d))}return i.current_head=a,i.branches[i.current_branch]=a,i.updated_at=r,await this.moduleEngine.writeContent(e,JSON.stringify(i,null,2)),a})}async switchBranch(e,t,s){return this.lockManager.acquire(`session:${t}`,async()=>{const n=await this.getManifest(e);if(!n.branches[s])throw new Error("Branch not found");n.current_branch=s,n.current_head=n.branches[s],n.updated_at=new Date().toISOString(),await this.moduleEngine.writeContent(e,JSON.stringify(n,null,2))})}async getNodeSiblings(e,t){const s=await this.readJson(this.getNodePath(e,t));if(!s||!s.parent_id)return s?[s]:[];const n=await this.readJson(this.getNodePath(e,s.parent_id));return n?(await Promise.all(n.children_ids.map(o=>this.readJson(this.getNodePath(e,o))))).filter(o=>o!==null&&o.status==="active"):[s]}async getSessionIdFromNodeId(e){try{return(await this.getManifest(e)).id||null}catch(t){return console.error("[LLMSessionEngine] getSessionIdFromNodeId failed:",t),null}}async loadTree(){return(await this.moduleEngine.loadTree()).filter(t=>t.name.startsWith(".")?!1:t.type==="file"?t.name.endsWith(".chat"):t.type==="directory")}async createDirectory(e,t){return this.moduleEngine.createDirectory(e,t)}async createFile(e,t,s){const n=(e||"New Chat").replace(/\.chat$/i,""),i=$(),o=new Date().toISOString();await this.moduleEngine.createDirectory(this.getHiddenDir(i),null);const a=`node-${Date.now()}-root`,r={id:a,type:"message",role:"system",content:"You are a helpful assistant.",created_at:o,parent_id:null,children_ids:[],status:"active"};await this.writeJson(this.getNodePath(i,a),r);const d=JSON.stringify({version:"1.0",id:i,title:n,created_at:o,updated_at:o,settings:{model:"gpt-4",temperature:.7},branches:{main:a},current_branch:"main",current_head:a,root_id:a},null,2),h=e.endsWith(".chat")?e:`${e}.chat`,u=await this.moduleEngine.createFile(h,t,d,{title:n,icon:"💬",sessionId:i});return this.notify(),u}async rename(e,t){const n=await this.vfs.getVFS().storage.loadVNode(e);if(!n)throw new Error("Node not found");try{const i=await this.getManifest(e);i.title=t,i.updated_at=new Date().toISOString(),await this.moduleEngine.writeContent(e,JSON.stringify(i,null,2))}catch(i){console.warn("Failed to update manifest title",i)}await this.moduleEngine.updateMetadata(e,{...n.metadata,title:t})}async delete(e){const t=this.vfs.getVFS(),s=async n=>{const i=await t.storage.loadVNode(n);if(!i)return;const o=String(i.type)==="directory",a=String(i.type)==="file";if(o){const r=await this.moduleEngine.getChildren(n);for(const c of r)await s(c.id)}else if(a&&i.name.endsWith(".chat"))try{const r=await this.moduleEngine.readContent(i.nodeId);if(r){const c=typeof r=="string"?r:new TextDecoder().decode(r),d=JSON.parse(c);if(d.id){const h=this.getHiddenDir(d.id),u=await this.moduleEngine.resolvePath(h);u&&await this.moduleEngine.delete([u])}}}catch(r){console.warn(`[LLMSessionEngine] Failed to cleanup data for ${i.name}`,r)}};for(const n of e)await s(n);await this.moduleEngine.delete(e),this.notify()}async search(e){return(await this.moduleEngine.search(e)).filter(s=>s.type==="file"&&s.name.endsWith(".chat"))}async getChildren(e){return this.moduleEngine.getChildren(e)}async createAsset(e,t,s){return this.moduleEngine.createAsset(e,t,s)}async getAssetDirectoryId(e){return this.moduleEngine.getAssetDirectoryId?this.moduleEngine.getAssetDirectoryId(e):null}async readSessionAsset(e,t){const s=t.startsWith("./")?t.slice(2):t,n=`${this.getHiddenDir(e)}/${s}`;try{const i=await this.moduleEngine.resolvePath(n);if(!i)return null;const o=await this.moduleEngine.readContent(i);if(!o)return null;const a=fe(s);return new Blob([o],{type:a})}catch(i){return console.warn(`[LLMSessionEngine] Failed to read asset: ${n}`,i),null}}async readContent(e){return this.moduleEngine.readContent(e)}async getNode(e){return this.moduleEngine.getNode(e)}async writeContent(e,t){return this.moduleEngine.writeContent(e,t)}async move(e,t){return this.moduleEngine.move(e,t)}async updateMetadata(e,t){return this.moduleEngine.updateMetadata(e,t)}async setTags(e,t){return this.moduleEngine.setTags(e,t)}async setTagsBatch(e){if(this.moduleEngine.setTagsBatch)return this.moduleEngine.setTagsBatch(e);await Promise.all(e.map(t=>this.moduleEngine.setTags(t.id,t.tags)))}async getAllTags(){return this.moduleEngine.getAllTags?this.moduleEngine.getAllTags():[]}on(e,t){return this.moduleEngine.on(e,t)}}const vt="/.defaults_version.json",Y="/.connections",ne="/.mcp";class ko extends At{_connections=[];_mcpServers=[];_listeners=new Set;_syncTimer=null;_eventUnsubscribers=[];constructor(e){super(Qe,{description:"AI Agents Configuration"},e)}async onLoad(){await this.refreshData(),this.bindVFSEvents(),await this.ensureDefaults()}get coreVfs(){return this.vfs.getVFS()}bindVFSEvents(){const e=this.vfs.getEventBus(),t=[M.NODE_CREATED,M.NODE_UPDATED,M.NODE_DELETED],s=n=>{if(n.moduleId&&n.moduleId!==this.moduleName)return;const i=n.path||"",o=i.startsWith(Y),a=i.startsWith(ne),r=i.endsWith(".agent");(o||a||r)&&(this._syncTimer&&clearTimeout(this._syncTimer),this._syncTimer=setTimeout(async()=>{await this.refreshData()},300))};t.forEach(n=>{const i=e.on(n,s);this._eventUnsubscribers.push(i)})}async refreshData(){try{this._connections=await this.loadJsonFiles(Y),this._mcpServers=await this.loadJsonFiles(ne),this.notifyListeners()}catch(e){console.error("[VFSAgentService] Failed to refresh data",e)}}async ensureDefaults(){try{const e=await this.readJson(vt);if(e&&e.version>=Re){console.log("[VFSAgentService] Defaults are up to date, skipping sync.");return}console.log(`[VFSAgentService] Syncing defaults from version ${e?.version||0} to ${Re}...`),await this.syncDefaultConnections(),await this.syncDefaultAgents(),await this.writeJson(vt,{version:Re,updatedAt:Date.now()}),await this.refreshData(),console.log("[VFSAgentService] Defaults sync completed.")}catch(e){console.error("[VFSAgentService] ensureDefaults error:",e)}}async syncDefaultConnections(){await this.ensureDirectory(Y);const e=await this.loadJsonFiles(Y),t=new Map;for(const i of e)t.set(i.provider,i);const n=Object.keys(W)[0];for(const[i,o]of Object.entries(W)){const a=t.get(i);if(a){const r=JSON.parse(JSON.stringify(a));r.availableModels||(r.availableModels=[]);const c=new Set(r.availableModels.map(h=>h.id));let d=!1;for(const h of o.models)c.has(h.id)||(r.availableModels.push({...h}),d=!0,console.log(`[VFSAgentService] Added new model "${h.id}" to connection "${a.id}"`));d&&await this.saveConnection(r)}else{const r={id:i===n?"default":`conn-${i}`,name:o.name,provider:i,apiKey:"",baseURL:o.baseURL,model:o.models[0]?.id||"",availableModels:[...o.models],metadata:{isSystemDefault:!0}};await this.saveConnection(r),console.log(`[VFSAgentService] Created new connection: ${r.id} (${i})`)}}}async syncDefaultAgents(){const e=this.getDefaultConnectionId(),t=await this.getAgents(),s=new Set(t.map(n=>n.id));for(const n of ue){if(s.has(n.id))continue;const i=`${n.id}.agent`,o=n.initPath||Ve,a=`${o}/${i}`.replace(/\/+/g,"/");if(await this.fileExists(a))continue;const{initPath:c,initialTags:d,...h}=n;h.config.connectionId||(h.config.connectionId=e);try{await this.ensureDirectory(o);const u=await this.moduleEngine.createFile(i,o,JSON.stringify(h,null,2),{icon:n.icon||"🤖",title:n.name,description:n.description});d&&d.length>0&&u?.id&&await this.moduleEngine.setTags(u.id,d),console.log(`[VFSAgentService] Created default agent: ${n.id} at ${a}`)}catch(u){console.error(`[VFSAgentService] Failed to create agent ${n.id}:`,u)}}}getDefaultConnectionId(){return ue&&ue.length>0&&ue[0].config.connectionId||"default"}async resolveModelName(e,t){const s=await this.getConnection(e);if(!s||!s.availableModels||s.availableModels.length===0)return t||"";const n=s.availableModels[0].id;return t&&s.availableModels.some(o=>o.id===t)?t:n}async getAgents(){const e=[];try{const s=(await this.moduleEngine.search({text:".agent",type:"file"})).map(async i=>{if(!i.name.endsWith(".agent"))return null;try{const o=await this.moduleEngine.readContent(i.id);if(!o)return null;const a=typeof o=="string"?o:new TextDecoder().decode(o),r=JSON.parse(a);if(r.config.modelId&&!r.config.modelName&&(r.config.modelName=r.config.modelId),r.id)return{...r,tags:i.tags}}catch{}return null});(await Promise.all(s)).forEach(i=>i&&e.push(i))}catch(t){console.error("[VFSAgentService] Failed to scan agents:",t)}return e}async getAgentConfig(e){let s=(await this.getAgents()).find(n=>n.id===e);if(!s&&e==="default"&&(s=this.createDefaultAgentDefinition()),s){s.config.connectionId||(s.config.connectionId=this.getDefaultConnectionId());const n=await this.resolveModelName(s.config.connectionId,s.config.modelName);return n!==s.config.modelName&&(s.config.modelName=n),s}return null}async saveAgent(e){e.config.connectionId||(e.config.connectionId=this.getDefaultConnectionId()),e.config.modelName=await this.resolveModelName(e.config.connectionId,e.config.modelName);const t=`${e.id}.agent`,s=JSON.stringify(e,null,2),n={icon:e.icon||"🤖",title:e.name,description:e.description},o=(await this.moduleEngine.search({text:t,type:"file"})).find(a=>a.name===t);o?(await this.moduleEngine.writeContent(o.id,s),await this.moduleEngine.updateMetadata(o.id,n)):await this.moduleEngine.createFile(t,null,s,n),this.notifyListeners()}async deleteAgent(e){const t=`${e}.agent`,n=(await this.moduleEngine.search({text:t,type:"file"})).find(i=>i.name===t);n&&(await this.moduleEngine.delete([n.id]),this.notifyListeners())}async getConnections(){return[...this._connections]}async getConnection(e){return this._connections.find(t=>t.id===e)}async getDefaultConnection(){return this._connections.length===0?null:this._connections.find(t=>t.id==="default")||this._connections[0]}async saveConnection(e){const t=`${e.id}.json`,s=JSON.stringify(e,null,2),n=`${Y}/${t}`;await this.ensureDirectory(Y);const i=await this.resolvePath(n);i?(await this.moduleEngine.writeContent(i,s),await this.moduleEngine.updateMetadata(i,{icon:"🔌",title:e.name,type:"connection"})):await this.moduleEngine.createFile(t,Y,s,{icon:"🔌",title:e.name,type:"connection"});const o=this._connections.findIndex(a=>a.id===e.id);o>=0?this._connections[o]=e:this._connections.push(e),this.notifyListeners()}async deleteConnection(e){if(e==="default")throw new Error("Cannot delete default connection");const t=`${Y}/${e}.json`,s=await this.resolvePath(t);s&&await this.moduleEngine.delete([s]),this._connections=this._connections.filter(n=>n.id!==e),this.notifyListeners()}async getMCPServers(){return[...this._mcpServers]}async saveMCPServer(e){const t=`${e.id}.json`,s=JSON.stringify(e,null,2),n=`${ne}/${t}`;await this.ensureDirectory(ne);const i=await this.resolvePath(n);i?(await this.moduleEngine.writeContent(i,s),await this.moduleEngine.updateMetadata(i,{icon:"🔌",title:e.name,type:"mcp"})):await this.moduleEngine.createFile(t,ne,s,{icon:"🔌",title:e.name,type:"mcp"});const o=this._mcpServers.findIndex(a=>a.id===e.id);o>=0?this._mcpServers[o]=e:this._mcpServers.push(e),this.notifyListeners()}async deleteMCPServer(e){const t=`${ne}/${e}.json`,s=await this.resolvePath(t);s&&await this.moduleEngine.delete([s]),this._mcpServers=this._mcpServers.filter(n=>n.id!==e),this.notifyListeners()}onChange(e){return this._listeners.add(e),()=>this._listeners.delete(e)}notifyListeners(){this._listeners.forEach(e=>{try{e()}catch(t){console.error("[VFSAgentService] Listener error:",t)}})}destroy(){this._eventUnsubscribers.forEach(e=>e()),this._eventUnsubscribers=[],this._syncTimer&&(clearTimeout(this._syncTimer),this._syncTimer=null),this._listeners.clear()}async loadJsonFiles(e){const t=[];try{const s=await this.resolvePath(e);if(!s)return[];const n=await this.coreVfs.storage.getChildren(s);for(const i of n)if(i.type==="file"&&i.name.endsWith(".json"))try{const o=await this.moduleEngine.readContent(i.nodeId),a=typeof o=="string"?o:new TextDecoder().decode(o);t.push(JSON.parse(a))}catch(o){console.warn(`Failed to parse ${i.name}`,o)}}catch{}return t}async fileExists(e){return await this.resolvePath(e)!==null}async resolvePath(e){try{return await this.moduleEngine.resolvePath(e)}catch{return null}}async ensureDirectory(e){const t=e.split("/").filter(Boolean);let s="";for(const n of t)if(s+="/"+n,!await this.resolvePath(s)){const o=s.substring(0,s.lastIndexOf("/"))||null;try{await this.moduleEngine.createDirectory(n,o)}catch(a){if(!a.message?.includes("exists"))throw a}}}createDefaultAgentDefinition(){return{id:"default",name:"Default Assistant",type:"agent",icon:"🤖",description:"Built-in default assistant",config:{connectionId:this.getDefaultConnectionId(),modelName:"",systemPrompt:"You are a helpful assistant."}}}}const Mo=l=>{try{const e=JSON.parse(l);return{summary:e.summary||"",searchableText:`${e.title} ${e.summary||""} ${e.id}`.toLowerCase(),metadata:{...e.settings,type:"chat",updatedAt:e.updated_at,messageCount:Object.keys(e.branches||{}).length}}}catch(e){return console.warn("[chatFileParser] Parse failed:",e),{summary:"Parse error",metadata:{type:"chat"}}}};async function No(l){await vo({plugins:l.plugins,config:l.config}),await l.agentService.init(),await l.sessionEngine.init();const e=ot();return e.initialize(l.agentService,l.sessionEngine,{maxConcurrent:l.maxConcurrent}),console.log("[LLM Engine] Initialized"),{registry:e}}class Lo{container;historyView;chatInput;printService=null;sessionManager;registry;listeners=new Map;globalEventUnsubscribe=null;sessionEventUnsubscribe=null;titleInput;statusIndicator;assetManagerUI=null;currentTitle="New Chat";isAllExpanded=!0;currentSessionId=null;options;initPromise=null;initResolve=null;initReject=null;get hostContext(){return this.options.hostContext}get engine(){return this.options.sessionEngine}constructor(e,t){this.options=t,this.registry=ot(),this.sessionManager=new _o,t.title&&(this.currentTitle=t.title)}async init(e,t){this.container=e,this.container.classList.add("llm-ui-workspace"),this.initPromise=new Promise((s,n)=>{this.initResolve=s,this.initReject=n});try{this.renderLayout(),await this.initComponents(),this.bindTitleBarEvents(),this.bindGlobalEvents(),await this.loadSessionFromEngine(t),this.emit("ready"),this.initResolve?.()}catch(s){throw console.error("[LLMWorkspaceEditor] init failed:",s),this.initReject?.(s),s}}async initComponents(){const e=this.container.querySelector("#llm-ui-history"),t=this.container.querySelector("#llm-ui-input");this.historyView=new Ji(e,(n,i,o)=>this.handleContentChange(n,i,o),(n,i)=>this.handleNodeAction(n,i),{nodeId:this.options.nodeId,ownerNodeId:this.options.ownerNodeId||this.options.nodeId,sessionEngine:this.options.sessionEngine});let s=[];try{s=(await this.options.agentService.getAgents()).map(a=>({id:a.id,name:a.name,icon:a.icon,category:a.type==="agent"?"Agents":a.type==="workflow"?"Workflows":"Other",description:a.description})),s.some(a=>a.id==="default")||s.unshift({id:"default",name:"Default Assistant",icon:"🤖",category:"System"});const o=new Set;s=s.filter(a=>o.has(a.id)?!1:(o.add(a.id),!0))}catch(n){console.warn("[LLMWorkspaceEditor] Failed to get initial agents:",n),s=[{id:"default",name:"Default Assistant",icon:"🤖",category:"System"}]}this.chatInput=new Qi(t,{onSend:(n,i,o)=>this.handleUserSend(n,i,o),onStop:()=>this.sessionManager.abort(),initialAgents:s}),this.container.addEventListener("open-connection-settings",()=>{console.log("[LLMWorkspaceEditor] Requesting to open connection settings..."),this.hostContext?.navigate?this.hostContext.navigate({target:"settings",resourceId:"connections"}):console.warn("[LLMWorkspaceEditor] Host does not support navigation")}),this.container.addEventListener("open-agent-config",n=>{const i=n.detail?.agentId;console.log(`[LLMWorkspaceEditor] Requesting to open agent config: ${i}`),i&&this.hostContext?.navigate&&this.hostContext.navigate({target:"agents",resourceId:i})})}async loadSessionFromEngine(e){if(!this.options.nodeId)throw new Error("[LLMWorkspaceEditor] nodeId is required.");let t=null;try{t=await this.options.sessionEngine.getSessionIdFromNodeId(this.options.nodeId)}catch(n){console.warn("[LLMWorkspaceEditor] Error reading manifest:",n)}t||(console.log("[LLMWorkspaceEditor] Initializing file structure..."),t=await this.options.sessionEngine.initializeExistingFile(this.options.nodeId,this.currentTitle)),this.currentSessionId=t,this.sessionEventUnsubscribe&&(this.sessionEventUnsubscribe(),this.sessionEventUnsubscribe=null);const s=await this.sessionManager.bindSession(this.options.nodeId,t);try{const n=await this.engine.getManifest(this.options.nodeId);n.title&&(this.currentTitle=n.title,this.titleInput.value=n.title)}catch(n){console.warn("[LLMWorkspaceEditor] Failed to load manifest:",n)}s.sessions.length>0?this.historyView.renderFull(s.sessions):this.historyView.renderWelcome(),this.sessionEventUnsubscribe=this.sessionManager.onEvent(n=>this.handleSessionEvent(n)),this.updateStatusFromSnapshot(s),console.log(`[LLMWorkspaceEditor] Session loaded: ${t}, messages: ${s.sessions.length}, status: ${s.status}`)}updateStatusFromSnapshot(e){this.updateStatusIndicatorFromStatus(e.status),e.isRunning&&(this.chatInput.setLoading(!0),this.historyView.enterStreamingMode())}updateStatusIndicatorFromStatus(e){if(!this.statusIndicator)return;const t=this.statusIndicator.querySelector(".llm-workspace-status__dot"),s=this.statusIndicator.querySelector(".llm-workspace-status__text");switch(t?.classList.remove("--running","--queued","--completed","--failed","--idle"),e){case"running":t?.classList.add("--running"),s.textContent="Generating...",this.chatInput.setLoading(!0);break;case"queued":t?.classList.add("--queued"),s.textContent="Queued",this.chatInput.setLoading(!0);break;case"completed":t?.classList.add("--completed"),s.textContent="Ready",this.chatInput.setLoading(!1);break;case"failed":t?.classList.add("--failed"),s.textContent="Error",this.chatInput.setLoading(!1);break;default:t?.classList.add("--idle"),s.textContent="Ready",this.chatInput.setLoading(!1)}}renderLayout(){this.container.innerHTML=`
            <div class="llm-workspace-titlebar">
                <div class="llm-workspace-titlebar__left">
                    <button class="llm-workspace-titlebar__btn" id="llm-btn-sidebar" title="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="llm-workspace-titlebar__sep"></div>
                    
                    <input type="text" class="llm-workspace-titlebar__input" id="llm-title-input" 
                           value="${T(this.currentTitle)}" placeholder="Untitled Chat" />
                    
                    <!-- 状态指示器 -->
                    <div class="llm-workspace-status" id="llm-status-indicator">
                        <span class="llm-workspace-status__dot"></span>
                        <span class="llm-workspace-status__text">Ready</span>
                    </div>
                </div>

                <div class="llm-workspace-titlebar__right">
                    <!-- 后台运行指示器 -->
                    <div class="llm-workspace-titlebar__bg-indicator" id="llm-bg-indicator" style="display:none;">
                        <span class="llm-bg-badge">2 running</span>
                    </div>
                    
                    <button class="llm-workspace-titlebar__btn" id="llm-btn-assets" title="附件管理">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-collapse" title="Collapse/Expand All">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="4 14 10 14 10 20"></polyline>
                            <polyline points="20 10 14 10 14 4"></polyline>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-copy" title="Copy as Markdown">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>

                    <button class="llm-workspace-titlebar__btn" id="llm-btn-print" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>

            <div class="llm-ui-workspace__history" id="llm-ui-history"></div>
            <div class="llm-ui-workspace__input" id="llm-ui-input"></div>
        `,this.titleInput=this.container.querySelector("#llm-title-input"),this.statusIndicator=this.container.querySelector("#llm-status-indicator")}getPrintService(){return this.printService||(this.printService=new Xe(this.options.sessionEngine,this.options.nodeId)),this.printService}bindTitleBarEvents(){this.container.querySelector("#llm-btn-sidebar")?.addEventListener("click",()=>{this.hostContext?.toggleSidebar()}),this.titleInput.addEventListener("change",async()=>{if(this.currentTitle=this.titleInput.value,this.emit("change"),this.options.nodeId)try{await this.engine.rename(this.options.nodeId,this.currentTitle)}catch(e){console.error("[LLMWorkspaceEditor] Failed to rename:",e)}}),this.container.querySelector("#llm-btn-assets")?.addEventListener("click",async()=>{await this.handleOpenAssetManager()}),this.container.querySelector("#llm-btn-collapse")?.addEventListener("click",e=>{this.toggleAllBubbles(e.currentTarget)}),this.container.querySelector("#llm-btn-copy")?.addEventListener("click",async e=>{const t=e.currentTarget,s=this.sessionManager.exportToMarkdown();try{await navigator.clipboard.writeText(s),this.showButtonFeedback(t,"✓")}catch(n){console.error("Failed to copy",n)}}),this.container.querySelector("#llm-btn-print")?.addEventListener("click",async()=>{try{const e=this.sessionManager.exportToMarkdown();await this.getPrintService().print(e,{title:this.currentTitle||"Chat Conversation",showHeader:!0,headerMeta:{date:new Date().toLocaleString()}})}catch(e){console.error("[LLMWorkspaceEditor] Print failed:",e)}})}bindGlobalEvents(){console.log("[LLMWorkspaceEditor] Binding global events"),this.globalEventUnsubscribe=this.registry.onGlobalEvent(e=>{this.handleGlobalEvent(e)})}async handleOpenAssetManager(){const e=this.engine,t=this.options.ownerNodeId||this.options.nodeId;if(!e||!t){f.error("Engine not connected or no session");return}try{const s=await e.getAssetDirectoryId(t);if(!s){f.info("No attachments found in this chat");return}this.assetManagerUI&&this.assetManagerUI.close(),this.assetManagerUI=new is(e,null,{}),await this.assetManagerUI.show(s)}catch(s){console.error("[LLMWorkspaceEditor] Failed to open Asset Manager:",s),f.error("Failed to open Asset Manager")}}handleSessionEvent(e){this.historyView.processEvent(e),(e.type==="finished"||e.type==="session_start"||e.type==="error")&&console.log(`[LLMWorkspaceEditor] Session Event: ${e.type}`,e.payload),(e.type==="finished"||e.type==="session_start")&&this.emit("change"),e.type==="finished"?this.updateStatusIndicatorFromStatus("completed"):e.type==="error"&&this.updateStatusIndicatorFromStatus("failed")}handleGlobalEvent(e){switch(e.type){case"pool_status_changed":this.updateBackgroundIndicator(e.payload);break;case"session_status_changed":console.log(`[LLMWorkspaceEditor] Status Changed: ${e.payload.sessionId} -> ${e.payload.status}`),e.payload.sessionId===this.currentSessionId?this.updateStatusIndicatorFromStatus(e.payload.status):e.payload.status==="completed"&&this.showNotification("Background task completed");break}}async handleContentChange(e,t,s){try{await this.sessionManager.updateContent(e,t,s),this.emit("change")}catch(n){console.error("[LLMWorkspaceEditor] updateContent failed:",n)}}async handleNodeAction(e,t){try{switch(e){case"retry":await this.handleRetry(t);break;case"delete":await this.handleDelete(t);break;case"edit":break;case"edit-and-retry":await this.handleEditAndRetry(t);break;case"resend":await this.handleResend(t);break;case"prev-sibling":case"next-sibling":await this.handleSiblingSwitch(t,e==="prev-sibling"?"prev":"next");break}}catch(s){console.error("[LLMWorkspaceEditor] Action failed:",s),this.historyView.renderError(s)}}async handleRetry(e){const t=this.sessionManager.getSessions();let s=t.find(i=>i.id===e);if(s||(s=t.find(i=>i.executionRoot?.id===e||this.findNodeInTree(i.executionRoot,e)),s&&console.log(`[LLMWorkspaceEditor] Found session via execution node: ${s.id}`)),!s){console.warn(`[LLMWorkspaceEditor] Cannot retry: session not found for ${e}`),this.historyView.renderError(new Error("Message not found"));return}const n=this.sessionManager.canRetry(s.id);if(!n.allowed){console.warn(`[LLMWorkspaceEditor] Cannot retry: ${n.reason}`);return}this.chatInput.setLoading(!0);try{s.role==="user"?await this.sessionManager.resendUserMessage(s.id):await this.sessionManager.retryGeneration(s.id,{preserveCurrent:!0,navigateToNew:!0})}catch(i){console.error("[LLMWorkspaceEditor] Retry failed:",i),this.historyView.renderError(i),this.chatInput.setLoading(!1)}}findNodeInTree(e,t){return e?e.id===t?!0:e.children?.some(s=>this.findNodeInTree(s,t))??!1:!1}async handleDelete(e){console.log(`[LLMWorkspaceEditor] Deleting: ${e}`);try{const t=this.sessionManager.getSessions(),s=this.collectDeletionIds(e,t);console.log("[LLMWorkspaceEditor] IDs to delete:",s),this.historyView.removeMessages(s,!0),await this.sessionManager.deleteMessage(e,{mode:"soft",cascade:!1,deleteAssociatedResponses:!0}),this.emit("change")}catch(t){console.error("[LLMWorkspaceEditor] Delete failed:",t);const s=this.sessionManager.getSessions();this.historyView.renderFull(s),this.historyView.renderError(t)}}collectDeletionIds(e,t){const s=[e],n=t.findIndex(o=>o.id===e);if(n===-1)return s;if(t[n].role==="user")for(let o=n+1;o<t.length;o++){const a=t[o];if(a.role==="assistant")s.push(a.id),a.executionRoot&&this.collectNodeIds(a.executionRoot,s);else break}return s}collectNodeIds(e,t){if(t.push(e.id),e.children)for(const s of e.children)this.collectNodeIds(s,t)}async handleEditAndRetry(e){const t=this.sessionManager.getSessions().find(s=>s.id===e);if(!(!t||t.role!=="user")){this.chatInput.setLoading(!0);try{await this.sessionManager.editMessage(e,t.content||"",!0)}catch(s){console.error("[LLMWorkspaceEditor] Edit and retry failed:",s),this.historyView.renderError(s),this.chatInput.setLoading(!1)}}}async handleResend(e){this.chatInput.setLoading(!0);try{await this.sessionManager.resendUserMessage(e)}catch(t){console.error("[LLMWorkspaceEditor] Resend failed:",t),this.historyView.renderError(t),this.chatInput.setLoading(!1)}}async handleSiblingSwitch(e,t){const n=this.sessionManager.getSessions().find(r=>r.id===e);if(!n)return;const i=n.siblingIndex??0,o=n.siblingCount??1;let a;if(t==="prev"?a=Math.max(0,i-1):a=Math.min(o-1,i+1),a!==i)try{await this.sessionManager.switchToSibling(e,a),this.emit("change")}catch(r){console.error("[LLMWorkspaceEditor] Sibling switch failed:",r),this.historyView.renderError(r)}}async handleUserSend(e,t,s){const n=this.options.ownerNodeId||this.options.nodeId;if(!n){console.error("[LLMWorkspaceEditor] No session loaded!");return}console.log("[LLMWorkspaceEditor] User sending message..."),this.chatInput.setLoading(!0);try{let i=e||"";if(t.length>0){const o=this.options.sessionEngine;await Promise.all(t.map(async a=>{try{const r=await a.arrayBuffer();await o.createAsset(n,a.name,r),console.log(`[LLMWorkspaceEditor] Asset saved: ${a.name}`);const d=a.type.startsWith("image/")?`

![${a.name}](@asset/${a.name})`:`

[📄 ${a.name}](@asset/${a.name})`;i+=d}catch(r){console.error(`[LLMWorkspaceEditor] Failed to save asset ${a.name}:`,r),f.error(`Failed to upload ${a.name}`)}}))}if(!i.trim()){this.chatInput.setLoading(!1);return}await this.sessionManager.runUserQuery(i.trim(),t,s||"default")}catch(i){console.error("[LLMWorkspaceEditor] Send failed:",i),this.historyView.renderError(i),this.chatInput.setLoading(!1)}}updateBackgroundIndicator(e){const t=this.container.querySelector("#llm-bg-indicator");if(!t)return;const s=this.sessionManager.isGenerating()?Math.max(0,e.running-1):e.running;if(s>0||e.queued>0){t.style.display="flex";const n=t.querySelector(".llm-bg-badge");if(n){const i=s+e.queued;n.textContent=`${i} background task${i>1?"s":""}`}}else t.style.display="none"}showButtonFeedback(e,t){const s=e.innerHTML;e.innerHTML=`<span style="color:#2da44e">${t}</span>`,setTimeout(()=>e.innerHTML=s,2e3)}showNotification(e){console.log(`[Notification] ${e}`)}toggleAllBubbles(e){this.isAllExpanded=!this.isAllExpanded;const t=this.container.querySelector("#llm-ui-history");if(!t)return;t.querySelectorAll(".llm-ui-bubble--user, .llm-ui-node").forEach(n=>{this.isAllExpanded?n.classList.remove("is-collapsed"):n.classList.add("is-collapsed");const i=n.querySelector('[data-action="collapse"] svg');i&&(i.innerHTML=this.isAllExpanded?'<polyline points="18 15 12 9 6 15"></polyline>':'<polyline points="6 9 12 15 18 9"></polyline>')}),e.innerHTML=this.isAllExpanded?`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <polyline points="4 14 10 14 10 20"></polyline>
                 <polyline points="20 10 14 10 14 4"></polyline>
               </svg>`:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <polyline points="15 3 21 3 21 9"></polyline>
                 <polyline points="9 21 3 21 3 15"></polyline>
                 <line x1="21" y1="3" x2="14" y2="10"></line>
                 <line x1="3" y1="21" x2="10" y2="14"></line>
               </svg>`,e.setAttribute("title",this.isAllExpanded?"Collapse All":"Expand All")}async waitUntilReady(){return this.initPromise?this.initPromise:Promise.resolve()}getText(){return this.currentSessionId?JSON.stringify({sessionId:this.currentSessionId,title:this.currentTitle,messageCount:this.sessionManager.getSessions().length,status:this.sessionManager.getStatus()},null,2):JSON.stringify({error:"No session loaded"})}setText(e){this.loadSessionFromEngine(e).then(()=>this.emit("contentLoaded")).catch(t=>{console.error("[LLMWorkspaceEditor] setText failed:",t),this.historyView.renderError(t),this.emit("error",t)})}async setTextAsync(e){await this.loadSessionFromEngine(e)}isDirty(){return!1}setDirty(e){}focus(){this.chatInput?.focus()}async destroy(){this.assetManagerUI&&(this.assetManagerUI.close(),this.assetManagerUI=null),this.sessionEventUnsubscribe&&(this.sessionEventUnsubscribe(),this.sessionEventUnsubscribe=null),this.globalEventUnsubscribe&&(this.globalEventUnsubscribe(),this.globalEventUnsubscribe=null),this.printService&&(this.printService.destroy?.(),this.printService=null),this.sessionManager.destroy(),this.historyView?.destroy(),this.chatInput?.destroy(),this.container.innerHTML="",this.listeners.clear()}getMode(){return"edit"}async switchToMode(){}setTitle(e){this.currentTitle=e,this.titleInput&&(this.titleInput.value=e)}setReadOnly(){}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return this.sessionManager.exportToMarkdown()}async getSummary(){return null}async navigateTo(){}async search(){return[]}gotoMatch(){}clearSearch(){}async pruneAssets(){return null}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(s=>s(t))}}class Ao{constructor(e,t,s){this.service=s}container;content=null;_isDirty=!1;listeners=new Map;originalContent="";async init(e,t){this.container=e,this.container.classList.add("agent-config-editor"),this.originalContent=t||"{}",this.setText(this.originalContent),this.emit("ready")}getText(){return this.content?(this.syncModelFromUI(),JSON.stringify(this.content,null,2)):"{}"}setText(e){try{const t=JSON.parse(e),s=t.id&&t.id.trim()!==""?t.id:$(),n=this.normalizeAgentType(t.type);this.content={id:s,name:t.name||"New Agent",type:n,description:t.description||"",icon:t.icon||"🤖",config:{connectionId:t.config?.connectionId||"",modelName:t.config?.modelName||"",systemPrompt:t.config?.systemPrompt||"You are a helpful assistant.",mcpServers:t.config?.mcpServers||[],maxHistoryLength:t.config?.maxHistoryLength??-1,temperature:t.config?.temperature},interface:t.interface||{inputs:[],outputs:[]}},this.render()}catch(t){this.renderError(t.message),this.content=null}}normalizeAgentType(e){switch(e){case"agent":return"agent";case"composite":case"orchestrator":return"composite";case"tool":return"tool";case"workflow":return"workflow";default:return"agent"}}isDirty(){return this._isDirty}setDirty(e){this._isDirty=e}async render(){if(!this.content)return;const e=this.content,t=e.config;let s=await this.service.getConnections();s.sort((r,c)=>{if(r.id==="default")return-1;if(c.id==="default")return 1;const d=!!(r.apiKey&&r.apiKey.trim().length>0),h=!!(c.apiKey&&c.apiKey.trim().length>0);return d&&!h?-1:!d&&h?1:(r.name||"").localeCompare(c.name||"")});let n=s.find(r=>r.id===t.connectionId);!n&&s.length>0&&(n=s[0],this.content&&this.content.config&&(this.content.config.connectionId=n.id));const i=n?.availableModels||[];let o=t.modelName;if(i.length>0&&!i.some(c=>c.id===o)){const c=this.findModelById(o,s);if(c){const d=i.find(h=>h.name===c.name);o=d?d.id:i[0].id}else o=i[0].id;this.content&&this.content.config&&(this.content.config.modelName=o)}const a=await this.service.getMCPServers();this.container.innerHTML=`
            <div class="agent-editor-container">
                <!-- Header with Icon & Name -->
                <div class="agent-header">
                    <div class="agent-header__icon-picker" id="icon-picker" title="点击更换图标">
                        ${e.icon||"🤖"}
                    </div>
                    <div class="agent-header__info">
                        <input type="text" 
                               class="agent-header__name-input" 
                               name="name" 
                               value="${this.escapeHtml(e.name)}" 
                               placeholder="Agent 名称">
                        <textarea class="agent-header__desc-input" 
                                  name="description" 
                                  placeholder="描述这个 Agent 的用途..."
                                  rows="2">${this.escapeHtml(e.description||"")}</textarea>
                    </div>
                </div>

                <!-- Type Selection -->
                <div class="agent-section">
                    <div class="agent-section__header">
                        <span class="agent-section__icon">🎯</span>
                        <span class="agent-section__title">Agent 类型</span>
                        <span class="agent-section__toggle">▼</span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-type-selector">
                            <div class="agent-type-option ${e.type==="agent"?"selected":""}" data-type="agent">
                                <div class="agent-type-option__icon">🤖</div>
                                <div class="agent-type-option__title">Agent</div>
                                <div class="agent-type-option__desc">单一 LLM 驱动的智能体</div>
                            </div>
                            <div class="agent-type-option ${e.type==="composite"?"selected":""}" data-type="composite">
                                <div class="agent-type-option__icon">🕸️</div>
                                <div class="agent-type-option__title">Composite</div>
                                <div class="agent-type-option__desc">协调多个 Agent 协作</div>
                            </div>
                            <div class="agent-type-option ${e.type==="workflow"?"selected":""}" data-type="workflow">
                                <div class="agent-type-option__icon">📋</div>
                                <div class="agent-type-option__title">Workflow</div>
                                <div class="agent-type-option__desc">预定义的工作流程</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Configuration -->
                <div class="agent-section" id="llm-config-section" style="${e.type!=="agent"?"display:none":""}">
                    <div class="agent-section__header">
                        <span class="agent-section__icon">🧠</span>
                        <span class="agent-section__title">LLM 配置</span>
                        <span class="agent-section__toggle">▼</span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                连接 <small>选择已配置的 LLM 服务</small>
                            </label>
                            <select class="agent-form-select" name="connectionId" id="connection-select">
                                <option value="">-- 选择连接 --</option>
                                ${s.map(r=>{const c=!!(r.apiKey&&r.apiKey.trim().length>0),d=r.id==="default";let h=this.escapeHtml(r.name);return d&&(h=`⭐ ${h}`),!c&&!d&&(h=`${h} (需配置)`),`
                                    <option value="${r.id}" ${n?.id===r.id?"selected":""}>
                                        ${h} - ${r.provider}
                                    </option>
                                `}).join("")}
                            </select>
                            <p class="agent-form-help">
                                ${s.length===0?"⚠️ 请先在设置中添加 LLM 连接":"选择此 Agent 使用的 LLM 服务"}
                            </p>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                模型 <small>选择具体的模型</small>
                            </label>
                            <!-- ✅ [Fix] name="modelName" -->
                            <select class="agent-form-select" name="modelName" id="model-select">
                                ${i.length>0?i.map(r=>`
                                        <option value="${r.id}" ${o===r.id?"selected":""}>
                                            ${r.name}
                                        </option>
                                    `).join(""):'<option value="">请先选择连接</option>'}
                            </select>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                System Prompt <small>定义 Agent 的行为和角色</small>
                            </label>
                            <textarea class="agent-form-textarea" 
                                      name="systemPrompt" 
                                      placeholder="You are a helpful assistant...">${this.escapeHtml(t.systemPrompt||"")}</textarea>
                            <p class="agent-form-help">
                                提示：好的 System Prompt 应该清晰定义 Agent 的角色、能力边界和输出格式
                            </p>
                        </div>

                        <div class="agent-form-row">
                            <label class="agent-form-label">
                                历史消息数量 <small>-1 表示不限制</small>
                            </label>
                            <input type="number" 
                                   class="agent-form-input" 
                                   name="maxHistoryLength" 
                                   value="${t.maxHistoryLength??-1}"
                                   min="-1"
                                   style="max-width: 150px;">
                        </div>
                    </div>
                </div>

                <!-- MCP Tools -->
                <div class="agent-section" id="mcp-section" style="${e.type!=="agent"?"display:none":""}">
                    <div class="agent-section__header">
                        <span class="agent-section__icon">🔧</span>
                        <span class="agent-section__title">工具能力 (MCP)</span>
                        <span class="agent-section__toggle">▼</span>
                    </div>
                    <div class="agent-section__body">
                        ${a.length===0?`<div class="agent-empty-state">
                                    <div class="agent-empty-state__icon">🔌</div>
                                    <p>暂无可用的 MCP 服务器</p>
                                    <p style="font-size:0.8rem; margin-top:8px;">请在设置 → MCP Servers 中添加</p>
                               </div>`:`<p class="agent-form-help" style="margin-bottom:12px;">
                                    选择此 Agent 可以调用的工具服务
                               </p>
                               <div class="agent-mcp-list">
                                    ${a.map(r=>`
                                        <label class="agent-mcp-item">
                                            <input type="checkbox" 
                                                   name="mcpServers" 
                                                   value="${r.id}" 
                                                   ${(t.mcpServers||[]).includes(r.id)?"checked":""}>
                                            <div class="agent-mcp-item__info">
                                                <div class="agent-mcp-item__name">
                                                    ${r.icon||"🔌"} ${this.escapeHtml(r.name)}
                                                </div>
                                                <div class="agent-mcp-item__desc">
                                                    ${this.escapeHtml(r.description||"无描述")}
                                                </div>
                                            </div>
                                            <span class="agent-mcp-item__status ${r.status==="connected"?"connected":""}">
                                                ${r.status==="connected"?"已连接":"未连接"}
                                            </span>
                                        </label>
                                    `).join("")}
                               </div>`}
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="agent-section collapsed">
                    <div class="agent-section__header">
                        <span class="agent-section__icon">⚙️</span>
                        <span class="agent-section__title">高级设置</span>
                        <span class="agent-section__toggle">▼</span>
                    </div>
                    <div class="agent-section__body">
                        <div class="agent-form-row">
                            <label class="agent-form-label">Agent ID</label>
                            <input type="text" 
                                   class="agent-form-input" 
                                   name="id" 
                                   value="${this.escapeHtml(e.id)}" 
                                   readonly 
                                   style="background: var(--st-bg-tertiary, #f3f4f6); cursor: not-allowed;">
                            <p class="agent-form-help">系统生成的唯一标识符，不可修改</p>
                        </div>
                    </div>
                </div>

                <!-- Hidden field for icon -->
                <input type="hidden" name="icon" value="${e.icon||"🤖"}">
            </div>
        `,this.bindEvents()}findModelById(e,t){if(!e)return null;for(const s of t){const i=(s.availableModels||[]).find(o=>o.id===e);if(i)return i}return null}findModelByName(e,t){return e&&t.find(s=>s.name===e)||null}renderError(e){this.container.innerHTML=`
            <div class="agent-editor-container">
                <div style="padding: 40px; text-align: center; color: #ef4444;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">⚠️</div>
                    <h3 style="margin-bottom: 8px;">配置解析失败</h3>
                    <p style="color: #6b7280; font-size: 0.9rem;">${this.escapeHtml(e)}</p>
                    <pre style="margin-top: 16px; padding: 16px; background: #fef2f2; border-radius: 8px; text-align: left; overflow: auto; font-size: 0.8rem;">${this.escapeHtml(this.originalContent)}</pre>
                </div>
            </div>
        `}bindEvents(){const e=()=>{this._isDirty=!0,this.emit("interactiveChange")};this.container.querySelectorAll("input, select, textarea").forEach(i=>{i.addEventListener("input",e),i.addEventListener("change",e)}),this.container.querySelectorAll(".agent-section__header").forEach(i=>{i.addEventListener("click",()=>{i.closest(".agent-section")?.classList.toggle("collapsed")})}),this.container.querySelectorAll(".agent-type-option").forEach(i=>{i.addEventListener("click",()=>{const o=i.dataset.type;if(!o)return;this.container.querySelectorAll(".agent-type-option").forEach(d=>d.classList.remove("selected")),i.classList.add("selected");const a=this.container.querySelector("#llm-config-section"),r=this.container.querySelector("#mcp-section");o==="composite"||o==="workflow"?(a?.style.setProperty("display","none"),r?.style.setProperty("display","none")):(a?.style.setProperty("display","block"),r?.style.setProperty("display","block"));const c=this.normalizeAgentType(o);this.content&&(this.content.type=c),e()})});const t=this.container.querySelector("#connection-select"),s=this.container.querySelector("#model-select");t&&s&&t.addEventListener("change",async()=>{const i=t.value,o=await this.service.getConnections(),r=o.find(p=>p.id===i)?.availableModels||[],c=this.content?.config.modelName,h=this.findModelById(c||"",o)?.name;s.innerHTML=r.length>0?r.map(p=>`<option value="${p.id}">${p.name}</option>`).join(""):'<option value="">请先选择连接</option>';let u="";if(r.length>0){if(h){const p=this.findModelByName(h,r);u=p?p.id:r[0].id}else u=r[0].id;s.value=u}this.content&&this.content.config&&(this.content.config.connectionId=i,this.content.config.modelName=u),e()});const n=this.container.querySelector("#icon-picker");n&&n.addEventListener("click",()=>this.showIconPicker())}showIconPicker(){const e=["🤖","🧠","💡","🎯","🚀","⚡","🔥","✨","🎨","📝","📊","📈","🔍","🔧","⚙️","🛠️","💻","🖥️","📱","🌐","☁️","🔒","🔑","📡","🎭","🎪","🎬","🎮","🎲","🃏","🎵","🎸","📚","📖","✏️","🖊️","📌","📎","🗂️","📁","💬","💭","🗨️","👤","👥","🤝","👋","✋","🌟","⭐","🌙","☀️","🌈","🍀","🌸","🌺","🦾","🦿","🕸️","🔮","💎","🏆","🎖️","🥇"],t=document.createElement("div");t.className="icon-picker-overlay",t.innerHTML=`
            <div class="icon-picker-modal">
                <h3 style="margin: 0 0 16px 0; font-size: 1.1rem;">选择图标</h3>
                <div class="icon-picker-grid">
                    ${e.map(s=>`
                        <div class="icon-picker-item" data-icon="${s}">${s}</div>
                    `).join("")}
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button class="icon-picker-cancel" style="padding: 8px 16px; border: none; background: #e5e7eb; border-radius: 6px; cursor: pointer;">取消</button>
                </div>
            </div>
        `,t.querySelectorAll(".icon-picker-item").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.icon;if(n){const i=this.container.querySelector("#icon-picker");i&&(i.textContent=n);const o=this.container.querySelector('input[name="icon"]');o&&(o.value=n),this._isDirty=!0,this.emit("interactiveChange")}t.remove()})}),t.querySelector(".icon-picker-cancel")?.addEventListener("click",()=>{t.remove()}),t.addEventListener("click",s=>{s.target===t&&t.remove()}),document.body.appendChild(t)}syncModelFromUI(){if(!this.content)return;const e=i=>this.container.querySelector(`[name="${i}"]`)?.value||"",t=i=>Array.from(this.container.querySelectorAll(`input[name="${i}"]:checked`)).map(o=>o.value),s=this.container.querySelector(".agent-type-option.selected"),n=this.normalizeAgentType(s?.dataset.type);this.content.name=e("name"),this.content.icon=e("icon"),this.content.description=e("description"),this.content.type=n,n==="agent"&&(this.content.config={connectionId:e("connectionId"),modelName:e("modelName"),systemPrompt:e("systemPrompt"),maxHistoryLength:parseInt(e("maxHistoryLength"))||-1,mcpServers:t("mcpServers")})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async destroy(){this.container.innerHTML="",this.listeners.clear()}getMode(){return"edit"}async switchToMode(e){}setTitle(e){}setReadOnly(e){}focus(){this.container.querySelector(".agent-header__name-input")?.focus()}get commands(){return{}}async getHeadings(){return[]}async getSearchableText(){return JSON.stringify(this.content||{})}async getSummary(){return this.content?.description||null}async navigateTo(){}async search(){return[]}gotoMatch(){}clearSearch(){}async pruneAssets(){return null}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(s=>s(t))}}class Do extends le{testingConnections=new Set;async render(){let e=await this.service.getConnections();e.sort((t,s)=>{if(t.id==="default")return-1;if(s.id==="default")return 1;const n=!!(t.apiKey&&t.apiKey.trim().length>0),i=!!(s.apiKey&&s.apiKey.trim().length>0);return n&&!i?-1:!n&&i?1:(t.name||"").localeCompare(s.name||"")}),this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title">LLM 连接配置</h2>
                        <p class="settings-page__description">管理第三方 LLM 服务的连接凭据</p>
                    </div>
                    <button id="btn-add-connection" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 添加连接
                    </button>
                </div>
                
                <div id="connections-list" class="settings-connection-grid">
                    ${e.map(t=>this.renderConnectionCard(t)).join("")}
                </div>
                
                ${e.length===0?`
                    <div class="settings-empty">
                        <div class="settings-empty__icon">🔌</div>
                        <h3 class="settings-empty__title">还没有配置连接</h3>
                        <p class="settings-empty__text">点击"添加连接"按钮来配置您的第一个 LLM 服务连接</p>
                    </div>
                `:""}
            </div>
        `,this.bindEvents()}renderConnectionCard(e){const t=e.id==="default",s=!!(e.apiKey&&e.apiKey.trim().length>0),n=W[e.provider],o=(n?.models||[]).find(u=>u.id===e.model),a=o?o.name:e.model||"未设置",r=s?"":"settings-connection-card--incomplete";let c="";t?c='<span class="settings-badge settings-badge--success">默认</span>':s||(c='<span class="settings-badge settings-badge--warning">需配置</span>');const d=s?"✏️ 编辑":"⚙️ 去配置",h=s?"settings-btn--secondary":"settings-btn--primary";return`
            <div class="settings-connection-card ${t?"settings-connection-card--default":""} ${r}" data-id="${e.id}">
                <div class="settings-connection-card__header">
                    <h3 class="settings-connection-card__title">${e.name}</h3>
                    ${c}
                </div>
                
                <div class="settings-connection-card__details">
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label">提供商</span>
                        <span class="settings-detail-item__value">${n?.name||e.provider}</span>
                    </div>
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label">模型</span>
                        <span class="settings-detail-item__value">${a}</span>
                    </div>
                    <div class="settings-detail-item">
                        <span class="settings-detail-item__label">API Key</span>
                        <span class="settings-detail-item__value masked">
                            ${s?"••••••••":'<span style="color:var(--st-text-disabled)">未设置</span>'}
                        </span>
                    </div>
                </div>
                
                <div class="settings-page__actions" style="margin-top:auto; width:100%">
                    <button class="settings-btn ${h} settings-btn--sm settings-btn-edit" style="flex:1">${d}</button>
                    <button class="settings-btn settings-btn--secondary settings-btn--sm settings-btn-test" style="flex:1" ${s?"":"disabled"}>🔍 测试</button>
                    ${t?"":'<button class="settings-btn settings-btn--danger settings-btn--sm settings-btn-delete" style="flex:1">🗑️ 删除</button>'}
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.bindButton("#btn-add-connection",()=>this.showEditModal(null));const e=this.container.querySelector("#connections-list");e&&this.addEventListener(e,"click",async t=>{const s=t.target,n=s.closest(".settings-connection-card");if(!n)return;const i=n.dataset.id,o=(await this.service.getConnections()).find(a=>a.id===i);o&&(s.closest(".settings-btn-edit")?this.showEditModal(o):s.closest(".settings-btn-test")?await this.testConnection(n,o):s.closest(".settings-btn-delete")&&this.deleteConnection(i,o.name))})}showEditModal(e){const t=!e,s=Object.keys(W),n=e?.provider||s[0],i=W[n]?.models||[],o=`
            <form id="connection-form" class="settings-form">
                <div class="settings-form__group">
                    <label class="settings-form__label">连接名称 *</label>
                    <input type="text" class="settings-form__input" name="name" value="${e?.name||""}" required placeholder="例如: 我的 OpenAI">
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">提供商 *</label>
                    <select class="settings-form__select" id="conn-provider" name="provider" required>
                        ${s.map(a=>`
                            <option value="${a}" ${e?.provider===a?"selected":""}>
                                ${W[a].name}
                            </option>
                        `).join("")}
                    </select>
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">默认模型 *</label>
                    <select class="settings-form__select" id="conn-model" name="model" required>
                        ${i.length>0?i.map(a=>`
                                <option value="${a.id}" ${e?.model===a.id?"selected":""}>
                                    ${a.name}
                                </option>
                            `).join(""):'<option value="">-- 请先选择提供商 --</option>'}
                    </select>
                    <small class="settings-form__help">切换提供商后会自动更新模型列表</small>
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">API Key *</label>
                    <input type="password" class="settings-form__input" name="apiKey" value="${e?.apiKey||""}" required placeholder="sk-...">
                </div>
                
                <div class="settings-form__group">
                    <label class="settings-form__label">Base URL（可选）</label>
                    <input type="text" class="settings-form__input" id="conn-baseurl" name="baseURL" value="${e?.baseURL||""}" placeholder="留空使用默认">
                </div>
            </form>
        `;new R(t?"添加新连接":"编辑连接",o,{confirmText:"保存",onConfirm:async()=>{const a=document.getElementById("connection-form");if(!a.checkValidity())return a.reportValidity(),!1;const r=new FormData(a),c=Object.fromEntries(r),d=W[c.provider],h={id:e?.id||`conn-${me()}`,name:c.name,provider:c.provider,apiKey:c.apiKey,model:c.model,baseURL:c.baseURL||d?.baseURL||"",availableModels:e?.availableModels||(d?[...d.models]:[]),metadata:e?.metadata};await this.service.saveConnection(h),f.success(t?"连接已创建！":"连接已更新！"),this.render()}}).show(),setTimeout(()=>{const a=document.getElementById("conn-provider"),r=document.getElementById("conn-model"),c=document.getElementById("conn-baseurl");a&&a.addEventListener("change",d=>{const h=d.target.value,u=W[h],p=u?.models||[];r.innerHTML=p.length>0?p.map(y=>`<option value="${y.id}">${y.name}</option>`).join(""):'<option value="">-- 该提供商无可用模型 --</option>';const m=e?.provider||s[0],g=W[m]?.baseURL||"";(!c.value||c.value===g)&&(c.value=u?.baseURL||"")})},100)}async testConnection(e,t){if(this.testingConnections.has(t.id))return;if(!t.apiKey){f.warning("请先配置 API Key");return}this.testingConnections.add(t.id);const s=e.querySelector(".settings-btn-test"),n=s.innerHTML;s.innerHTML="⏳ 测试中...",s.disabled=!0;try{const i=await ro({provider:t.provider,apiKey:t.apiKey,baseURL:t.baseURL,model:t.model});i.success?(f.success(i.message||"连接测试成功！"),s.innerHTML="✅ 成功",s.classList.remove("settings-btn--secondary"),s.classList.add("settings-btn--success")):(f.error(`测试失败: ${i.message}`),s.innerHTML="❌ 失败",s.classList.remove("settings-btn--secondary"),s.classList.add("settings-btn--danger"))}catch(i){console.error(i),f.error(`测试出错: ${i.message}`),s.innerHTML="❌ 出错"}finally{setTimeout(()=>{s.innerHTML=n,s.disabled=!1,s.classList.remove("settings-btn--success","settings-btn--danger"),s.classList.add("settings-btn--secondary"),this.testingConnections.delete(t.id)},3e3)}}deleteConnection(e,t){R.confirm("确认删除",`确定要删除连接"${t}"吗？此操作无法撤销。`,async()=>{await this.service.deleteConnection(e),f.success("连接已删除"),this.render()})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}}class $o extends le{selectedId=null;async render(){const e=await this.service.getMCPServers();this.selectedId&&!e.find(s=>s.id===this.selectedId)&&(this.selectedId=null),!this.selectedId&&e.length>0&&(this.selectedId=e[0].id);const t=e.find(s=>s.id===this.selectedId);this.container.innerHTML=`
            <div class="settings-split">
                <div class="settings-split__sidebar">
                    <div class="settings-split__header">
                        <h3><i class="fas fa-plug"></i> MCP Servers</h3>
                        <div class="settings-page__actions">
                            <button id="btn-add-server" class="settings-btn-round" title="添加"><i class="fas fa-plus"></i></button>
                            <button id="btn-import-server" class="settings-btn-round" title="导入"><i class="fas fa-file-import"></i></button>
                            <button id="btn-export-all" class="settings-btn-round" title="导出"><i class="fas fa-file-export"></i></button>
                        </div>
                    </div>
                    <div class="settings-split__list">
                        ${e.length===0?this.renderEmptyList():e.map(s=>this.renderListItem(s)).join("")}
                    </div>
                </div>

                <div class="settings-split__content">
                    ${t?this.renderConfigPanel(t):this.renderEmptyState()}
                </div>
            </div>
        `,this.bindEvents()}renderEmptyList(){return`
            <div class="settings-empty settings-empty--mini">
                <p>暂无 MCP Server</p>
                <button class="settings-btn settings-btn--primary settings-btn--sm" id="btn-create-first">创建第一个</button>
            </div>
        `}renderListItem(e){const t=e.id===this.selectedId,s=e.status==="connected"?"settings-badge--success":e.status==="error"?"settings-badge--danger":"",n=e.status==="connected"?"check-circle":e.status==="error"?"exclamation-circle":"circle";return`
            <div class="settings-list-item ${t?"selected":""}" data-id="${e.id}">
                <span class="settings-list-item__icon">${e.icon||"🔌"}</span>
                <div class="settings-list-item__info">
                    <p class="settings-list-item__title">${e.name}</p>
                    <p class="settings-list-item__desc">${e.transport}</p>
                </div>
                <span class="settings-badge ${s}"><i class="fas fa-${n}"></i></span>
            </div>
        `}renderConfigPanel(e){const t=e.tools||[],s=e.resources||[];return`
            <div class="settings-config-header">
                <div class="settings-config-header__title-area">
                    <span class="settings-config-header__icon">${e.icon||"🔌"}</span>
                    <div>
                        <h2 class="settings-config-header__title">${e.name}</h2>
                        <p class="settings-config-header__subtitle">${e.description||"配置此 MCP Server"}</p>
                    </div>
                </div>
                <div class="settings-config-header__actions">
                    <button class="settings-btn settings-btn--secondary settings-btn-test" ${e.transport?"":"disabled"}>
                        <i class="fas fa-vial"></i> 测试连接
                    </button>
                    <button class="settings-btn settings-btn--primary settings-btn-save"><i class="fas fa-save"></i> 保存</button>
                    <button class="settings-btn settings-btn--danger settings-btn-delete"><i class="fas fa-trash"></i> 删除</button>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">基础信息</h3>
                <div class="settings-form__row"><label class="settings-form__label">名称</label><input type="text" class="settings-form__input" name="name" value="${e.name}"></div>
                <div class="settings-form__row"><label class="settings-form__label">图标</label><input type="text" class="settings-form__input" name="icon" value="${e.icon||""}"></div>
                <div class="settings-form__row"><label class="settings-form__label">描述</label><textarea class="settings-form__textarea" name="description">${e.description||""}</textarea></div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">连接配置</h3>
                <div class="settings-form__row">
                    <label class="settings-form__label">传输方式</label>
                    <select class="settings-form__select" name="transport">
                        <option value="stdio" ${e.transport==="stdio"?"selected":""}>STDIO</option>
                        <option value="sse" ${e.transport==="sse"?"selected":""}>SSE</option>
                        <option value="http" ${e.transport==="http"?"selected":""}>HTTP</option>
                    </select>
                </div>
                <div id="transport-config-container">
                    ${this.renderTransportFields(e)}
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">
                    工具列表 (Tools) <span class="settings-badge">${t.length}</span>
                </h3>
                ${t.length===0?'<div class="settings-empty settings-empty--mini"><p>暂无工具</p><button class="settings-btn settings-btn--sm" id="btn-add-tool">手动添加</button></div>':`<div class="settings-list-card-container">${t.map((n,i)=>this.renderToolItem(n,i)).join("")}</div>
                       <button class="settings-btn settings-btn--sm" id="btn-add-tool" style="margin-top:10px">添加工具</button>`}
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">
                    资源列表 (Resources) <span class="settings-badge">${s.length}</span>
                </h3>
                ${s.length===0?'<div class="settings-empty settings-empty--mini"><p>暂无资源</p><button class="settings-btn settings-btn--sm" id="btn-add-resource">手动添加</button></div>':`<div class="settings-list-card-container">${s.map((n,i)=>this.renderResourceItem(n,i)).join("")}</div>
                       <button class="settings-btn settings-btn--sm" id="btn-add-resource" style="margin-top:10px">添加资源</button>`}
            </div>

            <div class="settings-section">
                <h3 class="settings-section__title">高级选项</h3>
                <div class="settings-form__row">
                    <label class="settings-form__label"><input type="checkbox" name="autoConnect" ${e.autoConnect?"checked":""}> 启动时自动连接</label>
                </div>
                <div class="settings-form__row">
                    <label class="settings-form__label">超时时间 (秒)</label>
                    <input type="number" class="settings-form__input" name="timeout" value="${e.timeout||30}">
                </div>
            </div>
        `}renderTransportFields(e){return e.transport==="stdio"?`
                <div class="settings-form__row"><label class="settings-form__label">Command</label><input type="text" class="settings-form__input" name="command" value="${e.command||""}" placeholder="node"></div>
                <div class="settings-form__row"><label class="settings-form__label">Args</label><input type="text" class="settings-form__input" name="args" value="${e.args||""}" placeholder="server.js"></div>
                <div class="settings-form__row"><label class="settings-form__label">CWD</label><input type="text" class="settings-form__input" name="cwd" value="${e.cwd||""}" placeholder="/path/to/dir"></div>
            `:`
                <div class="settings-form__row"><label class="settings-form__label">Endpoint</label><input type="url" class="settings-form__input" name="endpoint" value="${e.endpoint||""}" placeholder="http://localhost:3000"></div>
                <div class="settings-form__row"><label class="settings-form__label">API Key</label><input type="password" class="settings-form__input" name="apiKey" value="${e.apiKey||""}"></div>
            `}renderToolItem(e,t){return`
            <div class="settings-list-card">
                <div class="settings-list-card__header">
                    <strong>${e.name}</strong>
                    <button class="settings-btn-icon-small settings-btn-delete-tool" data-index="${t}"><i class="fas fa-trash"></i></button>
                </div>
                <p class="settings-list-card__desc">${e.description||"无描述"}</p>
            </div>
        `}renderResourceItem(e,t){return`
            <div class="settings-list-card">
                <div class="settings-list-card__header">
                    <strong>${e.name||e.uri}</strong>
                    <button class="settings-btn-icon-small settings-btn-delete-resource" data-index="${t}"><i class="fas fa-trash"></i></button>
                </div>
                <p class="settings-list-card__desc"><code>${e.uri}</code></p>
            </div>
        `}renderEmptyState(){return'<div class="settings-empty"><h3>请选择或创建一个 MCP Server</h3></div>'}bindEvents(){this.clearListeners();const e=this.container.querySelector(".settings-split__list");e&&this.addEventListener(e,"click",n=>{const i=n.target.closest(".settings-list-item");i&&(this.selectedId=i.dataset.id,this.render())}),this.bindButton("#btn-add-server",()=>this.addNewServer()),this.bindButton("#btn-create-first",()=>this.addNewServer()),this.bindButton("#btn-import-server",()=>this.showImportModal()),this.bindButton("#btn-export-all",()=>this.exportAll()),this.bindButton(".settings-btn-save",()=>this.saveCurrentServer()),this.bindButton(".settings-btn-delete",()=>this.deleteCurrentServer()),this.bindButton(".settings-btn-test",()=>this.testConnection());const t=this.container.querySelector('[name="transport"]');t&&this.addEventListener(t,"change",n=>{const i=n.target.value,o=document.getElementById("transport-config-container");if(o){const a={transport:i};o.innerHTML=this.renderTransportFields(a)}}),this.bindButton("#btn-add-tool",()=>this.showAddToolModal()),this.bindButton("#btn-add-resource",()=>this.showAddResourceModal());const s=this.container.querySelector(".settings-split__content");s&&this.addEventListener(s,"click",n=>{const i=n.target,o=i.closest(".settings-btn-delete-tool"),a=i.closest(".settings-btn-delete-resource");o&&this.deleteTool(parseInt(o.dataset.index)),a&&this.deleteResource(parseInt(a.dataset.index))})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}async addNewServer(){const e={id:`mcp-${me()}`,name:"New Server",transport:"stdio",status:"idle",tools:[],resources:[]};await this.service.saveMCPServer(e),this.selectedId=e.id}async saveCurrentServer(){if(!this.selectedId)return;const e=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);if(!e)return;const t=i=>this.container.querySelector(`[name="${i}"]`)?.value,s=i=>this.container.querySelector(`[name="${i}"]`)?.checked,n={...e,name:t("name"),icon:t("icon"),description:t("description"),transport:t("transport"),autoConnect:s("autoConnect"),timeout:parseInt(t("timeout")||"30"),command:t("command"),args:t("args"),cwd:t("cwd"),endpoint:t("endpoint"),apiKey:t("apiKey")};await this.service.saveMCPServer(n),f.success("已保存")}deleteCurrentServer(){this.selectedId&&R.confirm("确认删除","确定要删除此 MCP Server 吗？",async()=>{await this.service.deleteMCPServer(this.selectedId),this.selectedId=null,f.success("已删除")})}async testConnection(){if(!this.selectedId)return;const e=this.container.querySelector(".btn-test"),t=e.innerHTML;e.innerHTML="测试中...",e.disabled=!0;try{await new Promise(n=>setTimeout(n,1e3));const s=(await this.service.getMCPServers()).find(n=>n.id===this.selectedId);s&&(s.status="connected",s.tools?.length||(s.tools=[{name:"mock_tool",description:"Auto-discovered tool"}]),await this.service.saveMCPServer(s),f.success("连接测试成功"))}catch{f.error("连接失败")}finally{e.innerHTML=t,e.disabled=!1}}showAddToolModal(){const e=`
            <div class="settings-form__group"><label class="settings-form__label">名称</label><input class="settings-form__input" id="tool-name" type="text"></div>
            <div class="settings-form__group"><label class="settings-form__label">描述</label><textarea class="settings-form__textarea" id="tool-desc"></textarea></div>
        `;new R("添加工具",e,{onConfirm:async()=>{const t=document.getElementById("tool-name").value,s=document.getElementById("tool-desc").value;if(!t)return!1;const n=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);n&&(n.tools=[...n.tools||[],{name:t,description:s}],await this.service.saveMCPServer(n))}}).show()}async deleteTool(e){const t=(await this.service.getMCPServers()).find(s=>s.id===this.selectedId);t&&t.tools&&(t.tools.splice(e,1),this.service.saveMCPServer(t))}showAddResourceModal(){const e=`
            <div class="form-group"><label>URI</label><input id="res-uri" type="text"></div>
            <div class="form-group"><label>名称</label><input id="res-name" type="text"></div>
        `;new R("添加资源",e,{onConfirm:async()=>{const t=document.getElementById("res-uri").value,s=document.getElementById("res-name").value;if(!t)return!1;const n=(await this.service.getMCPServers()).find(i=>i.id===this.selectedId);n&&(n.resources=[...n.resources||[],{uri:t,name:s}],await this.service.saveMCPServer(n))}}).show()}async deleteResource(e){const t=(await this.service.getMCPServers()).find(s=>s.id===this.selectedId);t&&t.resources&&(t.resources.splice(e,1),this.service.saveMCPServer(t))}showImportModal(){const e='<textarea id="import-json" style="width:100%;height:200px" placeholder="Paste JSON array..."></textarea>';new R("导入配置",e,{confirmText:"导入",onConfirm:async()=>{const t=document.getElementById("import-json").value;try{const s=JSON.parse(t),n=Array.isArray(s)?s:[s];for(const i of n)i.id=i.id||`mcp-${me()}`,await this.service.saveMCPServer(i);f.success(`导入 ${n.length} 个配置`)}catch{return f.error("JSON 格式错误"),!1}}}).show()}async exportAll(){const e=JSON.stringify(await this.service.getMCPServers(),null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download="mcp-servers.json",n.click()}}const Ro=l=>async(e,t)=>{let s=t.nodeId;const n=t,i=n.sessionEngine;i||console.error("[LLMFactory] Critical: sessionEngine missing in options. Make sure MemoryManager is injecting it correctly."),!s&&i&&(s=(await i.createFile(t.title||"New Chat",null)).id,console.log(`[LLMFactory] New file created: ${s}`));const o={...n,agentService:l,nodeId:s,sessionEngine:i},a=new Lo(e,o);return await a.init(e,t.initialContent),console.log("[LLMFactory] Editor created successfully"),a},Po=l=>async(e,t)=>{const s=new Ao(e,t,l);return await s.init(e,t.initialContent),s};class Oo extends le{async init(e){await super.init(e),this.refreshData()}focus(){this.refreshData()}refreshData(){this.service.syncTags().then(()=>{})}render(){const e=this.service.getTags(),t=e.sort((o,a)=>(a.count||0)-(o.count||0)),s=e.length,n=e.reduce((o,a)=>o+(a.count||0),0),i=e.filter(o=>(o.count||0)===0).length;this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title">标签管理</h2>
                        <p class="settings-page__description">管理和组织您的内容标签</p>
                    </div>
                    <button id="btn-add-tag" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 添加标签
                    </button>
                </div>

                <div class="settings-tags__stats">
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${s}</div>
                        <div class="settings-stat-card__label">总标签数</div>
                    </div>
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${n}</div>
                        <div class="settings-stat-card__label">标签引用次数</div>
                    </div>
                    <div class="settings-stat-card">
                        <div class="settings-stat-card__value">${i}</div>
                        <div class="settings-stat-card__label">未使用标签</div>
                    </div>
                </div>

                <div class="settings-tags__grid">
                    ${t.map(o=>this.renderTagCard(o)).join("")}
                </div>

                ${e.length===0?`
                    <div class="settings-empty">
                        <div class="settings-empty__icon">🏷️</div>
                        <h3 class="settings-empty__title">还没有创建标签</h3>
                        <p class="settings-empty__text">创建标签来组织和分类您的内容</p>
                    </div>
                `:""}
            </div>
        `,this.bindEvents()}renderTagCard(e){const t=e.color||"#3b82f6",s=e.count||0;return`
            <div class="settings-tag-card" style="--tag-color: ${t}" data-id="${e.id}">
                <div class="settings-tag-card__header">
                    <h3 class="settings-tag-card__name" style="color: ${t}">#${e.name}</h3>
                    <span class="settings-badge">${s} 引用</span>
                </div>
                <p class="settings-tag-card__desc">${e.description||"暂无描述"}</p>
                <div class="settings-tag-card__meta">
                    <input type="color" value="${t}" class="settings-color-picker" title="更改颜色">
                    <div class="settings-tag-card__actions">
                        <button class="settings-btn-icon-small settings-btn-edit" title="编辑">✏️</button>
                        <button class="settings-btn-icon-small settings-btn-delete" title="删除">🗑️</button>
                    </div>
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.addEventListener(this.container.querySelector("#btn-add-tag"),"click",()=>this.showEditModal(null));const e=this.container.querySelector(".settings-tags__grid");e&&(this.addEventListener(e,"click",t=>{const s=t.target,n=s.closest(".settings-tag-card");if(!n)return;const i=n.dataset.id,o=this.service.getTags().find(a=>a.id===i);o&&(s.closest(".settings-btn-edit")?this.showEditModal(o):s.closest(".settings-btn-delete")&&this.deleteTag(o))}),this.addEventListener(e,"change",t=>{const s=t.target;if(s.classList.contains("settings-color-picker")){const i=s.closest(".settings-tag-card").dataset.id,o=this.service.getTags().find(a=>a.id===i);o&&(this.service.saveTag({...o,color:s.value}),f.success("颜色已更新"))}}))}showEditModal(e){const t=!e,s=`
            <form id="tag-form" class="settings-form">
                <div class="settings-form__group">
                    <label class="settings-form__label">标签名称 *</label>
                    <input type="text" class="settings-form__input" name="name" value="${e?.name||""}" required placeholder="例如: 重要, 待办" ${t?"":"disabled"}>
                </div>
                <div class="settings-form__group">
                    <label class="settings-form__label">颜色</label>
                    <input type="color" class="settings-form__input" name="color" value="${e?.color||"#3b82f6"}">
                </div>
                <div class="settings-form__group">
                    <label class="settings-form__label">描述</label>
                    <textarea class="settings-form__textarea" name="description" placeholder="描述这个标签的用途...">${e?.description||""}</textarea>
                </div>
            </form>
        `;new R(t?"添加标签":"编辑标签",s,{confirmText:"保存",onConfirm:async()=>{const n=document.getElementById("tag-form");if(!n.checkValidity())return n.reportValidity(),!1;const i=new FormData(n),o={id:e?.id||i.get("name"),name:i.get("name"),color:i.get("color"),description:i.get("description"),count:e?.count||0};await this.service.saveTag(o),f.success(t?"标签已创建":"标签已更新")}}).show()}deleteTag(e){const t=e.count||0,s=t>0?`标签 "${e.name}" 被引用了 ${t} 次。

注意：此操作仅删除标签定义，不会从文件中移除标签，但可能会影响颜色显示和自动补全。确定继续吗？`:`确定要删除标签 "${e.name}" 吗？`;R.confirm("确认删除",s,async()=>{await this.service.deleteTag(e.id),f.success("标签已删除")})}}class Fo extends le{searchTerm="";selectedGroup="all";render(){const e=this.service.getContacts(),t=e.filter(n=>{const i=this.selectedGroup==="all"||n.group===this.selectedGroup,o=!this.searchTerm||n.name.toLowerCase().includes(this.searchTerm.toLowerCase());return i&&o}),s=Array.from(new Set(e.map(n=>n.group).filter(Boolean)));this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <div>
                        <h2 class="settings-page__title">通讯录</h2>
                        <p class="settings-page__description">管理您的联系人信息</p>
                    </div>
                    <button id="btn-add-contact" class="settings-btn settings-btn--primary">
                        <span class="settings-btn__icon">+</span> 添加联系人
                    </button>
                </div>

                <div class="settings-contact-toolbar">
                    <div class="settings-search-box">
                        <span class="settings-search-box__icon">🔍</span>
                        <input type="text" class="settings-search-box__input" id="contact-search" placeholder="搜索..." value="${this.searchTerm}">
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="settings-btn settings-btn--sm ${this.selectedGroup==="all"?"settings-btn--primary":"settings-btn--secondary"} filter-btn" data-group="all">全部</button>
                        ${s.map(n=>`
                            <button class="settings-btn settings-btn--sm ${this.selectedGroup===n?"settings-btn--primary":"settings-btn--secondary"} filter-btn" data-group="${n}">${n}</button>
                        `).join("")}
                    </div>
                </div>

                <div class="settings-contact-list">
                    ${t.map(n=>this.renderContactCard(n)).join("")}
                </div>
            </div>
        `,this.bindEvents()}renderContactCard(e){return`
            <div class="settings-contact-card" data-id="${e.id}">
                <div class="settings-contact-card__avatar">${e.name.substring(0,2)}</div>
                <div class="settings-contact-card__info">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="margin:0; font-size:1.1rem;">${e.name}</h3>
                        ${e.group?`<span class="settings-badge">${e.group}</span>`:""}
                    </div>
                    <div style="margin:10px 0; color:var(--st-text-secondary); font-size:0.9rem;">
                        ${e.email?`<div>📧 ${e.email}</div>`:""}
                        ${e.phone?`<div>📱 ${e.phone}</div>`:""}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="settings-btn settings-btn--sm settings-btn--secondary settings-btn-edit">编辑</button>
                        <button class="settings-btn settings-btn--sm settings-btn--danger settings-btn-delete">删除</button>
                    </div>
                </div>
            </div>
        `}bindEvents(){this.clearListeners(),this.bindButton("#btn-add-contact",()=>this.showEditModal(null));const e=this.container.querySelector("#contact-search");e&&this.addEventListener(e,"input",s=>{this.searchTerm=s.target.value,this.render()}),this.container.querySelectorAll(".filter-btn").forEach(s=>{this.addEventListener(s,"click",n=>{this.selectedGroup=n.target.dataset.group||"all",this.render()})});const t=this.container.querySelector(".settings-contact-list");t&&this.addEventListener(t,"click",s=>{const n=s.target,i=n.closest(".settings-contact-card");if(!i)return;const o=this.service.getContacts().find(a=>a.id===i.dataset.id);o&&(n.closest(".settings-btn-edit")&&this.showEditModal(o),n.closest(".settings-btn-delete")&&this.deleteContact(o.id))})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}showEditModal(e){const t=!e,s=`
            <form id="contact-form" class="settings-form">
                <div class="settings-form__group"><label class="settings-form__label">姓名</label><input class="settings-form__input" name="name" value="${e?.name||""}" required></div>
                <div class="settings-form__group"><label class="settings-form__label">Email</label><input class="settings-form__input" name="email" value="${e?.email||""}"></div>
                <div class="settings-form__group"><label class="settings-form__label">分组</label><input class="settings-form__input" name="group" value="${e?.group||""}"></div>
            </form>
        `;new R(t?"添加":"编辑",s,{confirmText:"保存",onConfirm:async()=>{const n=document.getElementById("contact-form");if(!n.checkValidity())return!1;const i=new FormData(n),o={id:e?.id||`contact-${me()}`,name:i.get("name"),email:i.get("email"),group:i.get("group")};await this.service.saveContact(o),f.success("Saved")}}).show()}deleteContact(e){R.confirm("删除","确定删除吗？",async()=>{await this.service.deleteContact(e),f.success("Deleted")})}}const bt={connections:"🤖 连接 (Connections)",mcpServers:"🔌 MCP 服务器",tags:"🏷️ 标签 (Tags)",contacts:"📒 通讯录"};class Bo extends le{storageInfo=null;snapshots=[];syncConfig={serverUrl:"",username:"",token:"",strategy:"manual",autoSync:!1};syncStatus={state:"idle",lastSyncTime:null};async init(e){await super.init(e),await Promise.all([this.loadStorageInfo(),this.loadSnapshots(),this.loadSyncConfig()])}async loadStorageInfo(){if(navigator.storage&&navigator.storage.estimate)try{this.storageInfo=await navigator.storage.estimate(),this.render()}catch(e){console.error(e)}}async loadSnapshots(){try{this.snapshots=await this.service.listLocalSnapshots(),this.render()}catch(e){console.error("Failed to list snapshots",e)}}async loadSyncConfig(){try{this.syncConfig=await this.service.getSyncConfig(),this.syncStatus=await this.service.getSyncStatus(),this.render()}catch(e){console.error("Failed to load sync config",e)}}render(){const e=this.storageInfo?.usage||0,t=this.storageInfo?.quota||1,s=(e/t*100).toFixed(1),n=(e/1024/1024).toFixed(2),i=this.snapshots||[],o={idle:"#aaa",syncing:"var(--st-color-primary)",error:"var(--st-color-danger)",success:"var(--st-color-success)"},r={idle:"就绪",syncing:"同步中...",error:"错误",success:"同步成功"}[this.syncStatus.state]||"未知",c=`
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--st-border-color);">
                <div style="font-size:0.85em; color:var(--st-text-secondary); margin-bottom:10px;">🛡️ 数据修复与强制同步</div>
                <div style="display:flex; gap:10px;">
                    <button id="btn-force-push" class="settings-btn settings-btn--sm settings-btn--secondary" title="将本地所有文件覆盖到服务器">
                        <i class="fas fa-arrow-up"></i> 强制上传 (Local ➔ Server)
                    </button>
                    <button id="btn-force-pull" class="settings-btn settings-btn--sm settings-btn--secondary" title="下载服务器所有文件覆盖本地">
                        <i class="fas fa-arrow-down"></i> 强制下载 (Server ➔ Local)
                    </button>
                </div>
                <small style="display:block; margin-top:5px; color:#999; font-size:0.75em;">
                    注意：强制操作会忽略版本冲突，直接覆盖目标端的数据。
                </small>
            </div>
        `;this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-page__header">
                    <h2 class="settings-page__title">存储与数据</h2>
                </div>

                <div class="settings-storage-overview">
                    <div class="settings-storage-visual">
                        <svg width="100" height="100" viewBox="0 0 36 36" class="settings-circular-chart">
                            <path class="settings-chart-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="settings-chart-fill" stroke-dasharray="${s}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="20.35" class="settings-chart-text">${s}%</text>
                        </svg>
                        <div style="margin-left: 20px;">
                            <div class="settings-stat-item">
                                <span class="settings-detail-item__label">本地占用</span>
                                <span class="settings-detail-item__value" style="font-size:1.5em; font-weight:bold;">${n} MB</span>
                            </div>
                            <div style="font-size:0.85em; color:var(--st-text-secondary); margin-top:5px;">
                                浏览器配额: ${(t/1024/1024/1024).toFixed(1)} GB
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 远程同步 (Remote Sync) -->
                <div class="settings-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                            <h3 class="settings-section__title" style="margin:0">☁️ 远程同步</h3>
                            <div style="display:flex; align-items:center; gap:8px; margin-top:5px; font-size:0.85em; color:var(--st-text-secondary);">
                                <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:${o[this.syncStatus.state]}"></span>
                                <span>${r}</span>
                                ${this.syncStatus.lastSyncTime?`<span>• 上次同步: ${new Date(this.syncStatus.lastSyncTime).toLocaleTimeString()}</span>`:""}
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="btn-sync-now" class="settings-btn settings-btn--primary" ${this.syncStatus.state==="syncing"?"disabled":""}>
                                <i class="fas fa-sync ${this.syncStatus.state==="syncing"?"fa-spin":""}"></i> 同步
                            </button>
                            <button id="btn-toggle-sync-config" class="settings-btn settings-btn--secondary">配置</button>
                        </div>
                    </div>

                    <!-- 同步配置表单 -->
                    <div id="sync-config-panel" style="display:none; background:var(--st-bg-tertiary); padding:15px; border-radius:8px; margin-bottom:15px;">
                        <div class="settings-form-group">
                            <label>服务器地址 (Endpoint)</label>
                            <input type="text" id="inp-sync-url" class="settings-input" placeholder="https://127.0.0.1:3443" value="${this.syncConfig.serverUrl||""}">
                            <small style="color:var(--st-text-secondary); font-size:0.75em;">若是本地自签名证书，请先在浏览器访问一次该地址并接受证书。</small>
                        </div>
                        
                        <div class="settings-form-row">
                            <div class="settings-form-group" style="flex:1;">
                                <label>用户名</label>
                                <input type="text" id="inp-sync-user" class="settings-input" placeholder="username" value="${this.syncConfig.username||""}">
                            </div>
                            <div class="settings-form-group" style="flex:1;">
                                <label>Token / API Key</label>
                                <input type="password" id="inp-sync-token" class="settings-input" placeholder="sk-..." value="${this.syncConfig.token||""}">
                            </div>
                        </div>

                        <div class="settings-form-row">
                            <div class="settings-form-group" style="flex:1">
                                <label>常规同步策略</label>
                                <select id="sel-sync-strategy" class="settings-select">
                                    <option value="manual" ${this.syncConfig.strategy==="manual"?"selected":""}>手动同步 (Manual)</option>
                                    <option value="bidirectional" ${this.syncConfig.strategy==="bidirectional"?"selected":""}>双向智能 (Smart)</option>
                                    <option value="push" ${this.syncConfig.strategy==="push"?"selected":""}>仅上传 (Push)</option>
                                    <option value="pull" ${this.syncConfig.strategy==="pull"?"selected":""}>仅下载 (Pull)</option>
                                </select>
                            </div>
                            <div class="settings-form-group" style="flex:0 0 auto; display:flex; align-items:flex-end;">
                                <label class="settings-checkbox-row" style="margin-bottom:10px;">
                                    <input type="checkbox" id="chk-auto-sync" ${this.syncConfig.autoSync?"checked":""}>
                                    <span>自动同步</span>
                                </label>
                            </div>
                        </div>

                        ${this.syncStatus.errorMessage?`<div style="color:var(--st-color-danger); font-size:0.85em; margin-top:10px;">❌ ${this.syncStatus.errorMessage}</div>`:""}

                        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px; padding-top:10px; border-top:1px solid var(--st-border-color);">
                            <button id="btn-test-conn" class="settings-btn settings-btn--sm settings-btn--secondary">测试连接</button>
                            <button id="btn-save-sync" class="settings-btn settings-btn--sm settings-btn--primary">保存配置</button>
                        </div>

                        ${c}
                    </div>
                </div>

                <!-- 3. 本地快照 -->
                <div class="settings-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div>
                            <h3 class="settings-section__title" style="margin:0">📦 本地快照</h3>
                            <p class="settings-page__description" style="margin:5px 0 0 0">浏览器内的秒级数据库备份，用于快速回滚。</p>
                        </div>
                        <button id="btn-create-snapshot" class="settings-btn settings-btn--secondary"><i class="fas fa-camera"></i> 新建快照</button>
                    </div>
                    
                    <div class="settings-snapshot-list">
                        ${i.length===0?'<div class="settings-empty settings-empty--mini">暂无快照</div>':i.map(d=>`
                                <div class="settings-list-item snapshot-item">
                                    <div class="settings-list-item__icon">🕰️</div>
                                    <div class="settings-list-item__info">
                                        <p class="settings-list-item__title">${d.displayName}</p>
                                        <p class="settings-list-item__desc">
                                            ${new Date(d.createdAt).toLocaleString()} • ${(d.size/1024/1024).toFixed(2)} MB
                                        </p>
                                    </div>
                                    <div class="settings-snapshot-actions">
                                        <button class="settings-btn settings-btn--sm settings-btn--secondary btn-restore-snap" data-name="${d.name}" title="回滚到此状态">恢复</button>
                                        <button class="settings-btn settings-btn--sm settings-btn--danger btn-del-snap" data-name="${d.name}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `).join("")}
                    </div>
                </div>

                <!-- 4. 导入/导出 -->
                <div class="settings-section" style="border-top: 1px solid var(--st-border-color); padding-top: 20px;">
                    <h3 class="settings-section__title">数据迁移 (JSON)</h3>
                    <div class="settings-storage-actions">
                        <div class="settings-action-card">
                            <div class="settings-action-card__icon">📤</div>
                            <div style="flex:1;">
                                <h3 style="margin:0 0 5px 0; font-size:1em;">导出备份</h3>
                                <p style="margin:0; font-size:0.8em; color:var(--st-text-secondary);">导出系统配置和文档为 JSON 文件</p>
                            </div>
                            <button id="btn-export-mixed" class="settings-btn settings-btn--secondary">选择内容...</button>
                        </div>
                        <div class="settings-action-card">
                            <div class="settings-action-card__icon">📥</div>
                            <div style="flex:1;">
                                <h3 style="margin:0 0 5px 0; font-size:1em;">恢复/导入</h3>
                                <p style="margin:0; font-size:0.8em; color:var(--st-text-secondary);">支持增量合并或全量覆盖</p>
                            </div>
                            <button id="btn-import-mixed" class="settings-btn settings-btn--primary">导入文件...</button>
                        </div>
                    </div>
                </div>

                <!-- 5. 危险区 -->
                <div class="settings-section" style="margin-top: 40px; border-top: 1px solid var(--st-border-color); padding-top: 20px;">
                    <details>
                        <summary style="cursor:pointer; color:var(--st-text-secondary); font-size:0.9em;">高级选项 / 危险操作</summary>
                        <div class="settings-storage-actions" style="margin-top:15px;">
                            <div class="settings-action-card settings-action-card--danger">
                                <div class="settings-action-card__icon">💣</div>
                                <div style="flex:1">
                                    <h3>工厂重置</h3>
                                    <p style="font-size:0.8em; color:#666;">抹除所有数据并重置为初始状态</p>
                                </div>
                                <button id="btn-reset" class="settings-btn settings-btn--danger">清空所有数据</button>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            <style>
                .settings-storage-visual { display: flex; align-items: center; padding: 20px; background: var(--st-bg-secondary); border-radius: 12px; }
                .settings-circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
                .settings-chart-bg { fill: none; stroke: var(--st-border-color); stroke-width: 3.8; }
                .settings-chart-fill { fill: none; stroke: var(--st-color-primary); stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.5s ease; }
                .settings-chart-text { fill: var(--st-text-primary); font-family: sans-serif; font-weight: bold; font-size: 0.5em; text-anchor: middle; }
                
                .settings-snapshot-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
                .snapshot-item { display: flex; align-items: center; padding: 10px; background: var(--st-bg-tertiary); border-radius: 8px; border: 1px solid transparent; }
                .snapshot-item:hover { border-color: var(--st-border-color); }
                .settings-snapshot-actions { display: flex; gap: 8px; margin-left: auto; }
                
                .settings-form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
                .settings-action-card { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--st-bg-tertiary); border-radius: 8px; margin-bottom: 10px; }
                .settings-action-card--danger { background: #fee2e2; border: 1px solid #fca5a5; }
                .settings-action-card--danger h3 { color: #991b1b; }
            </style>
        `,this.bindEvents()}bindEvents(){this.clearListeners(),this.bindButton("#btn-export-mixed",()=>this.openExportModal()),this.bindButton("#btn-import-mixed",()=>this.triggerImportFlow()),this.bindButton("#btn-reset",()=>this.resetApp()),this.bindButton("#btn-create-snapshot",()=>this.createSnapshot());const e=this.container.querySelector(".settings-snapshot-list");e&&this.addEventListener(e,"click",t=>{const s=t.target,n=s.closest(".btn-restore-snap"),i=s.closest(".btn-del-snap");n&&this.restoreSnapshot(n.dataset.name),i&&this.deleteSnapshot(i.dataset.name)}),this.bindButton("#btn-toggle-sync-config",async()=>{const t=this.container.querySelector("#sync-config-panel");if(t.style.display==="none")t.style.display="block";else try{await this.saveConfigFromUI(),f.success("配置已自动保存"),t.style.display="none"}catch(n){console.warn("Auto-save skipped:",n.message),t.style.display="none"}}),this.bindButton("#btn-save-sync",async()=>{try{await this.saveConfigFromUI(),f.success("配置已保存")}catch{f.error("保存失败")}}),this.bindButton("#btn-test-conn",async()=>{const t=this.container.querySelector("#btn-test-conn"),s=t.innerText;t.innerText="连接中...",t.disabled=!0;let n=this.getVal("#inp-sync-url").trim();n.endsWith("/")&&(n=n.slice(0,-1));try{const i=this.getVal("#inp-sync-user").trim(),o=this.getVal("#inp-sync-token").trim();await this.service.testConnection(n,i,o)?f.success("连接成功"):f.error("认证失败 (Token 无效或网络错误)")}catch(i){i.message.includes("Failed to fetch")?f.error("连接失败: 请先在浏览器中访问 "+n+" 并接受证书"):f.error("连接错误: "+i.message)}finally{t.innerText=s,t.disabled=!1}}),this.bindButton("#btn-sync-now",()=>this.handleSyncAction("standard")),this.bindButton("#btn-force-push",()=>this.confirmForceSync("force_push")),this.bindButton("#btn-force-pull",()=>this.confirmForceSync("force_pull"))}async saveConfigFromUI(){let e=this.getVal("#inp-sync-url").trim();e.endsWith("/")&&(e=e.slice(0,-1));const t=this.getVal("#inp-sync-user").trim(),s=this.getVal("#inp-sync-token").trim(),n=this.container.querySelector("#sel-sync-strategy").value,i=this.container.querySelector("#chk-auto-sync").checked;if(!e||!t)throw new Error("Required fields missing");await this.service.saveSyncConfig({serverUrl:e,username:t,token:s,strategy:n,autoSync:i}),await this.loadSyncConfig()}async handleSyncAction(e){try{const t=this.container.querySelector("#sync-config-panel");if(t&&t.style.display!=="none"&&await this.saveConfigFromUI().catch(()=>{}),!this.syncConfig.serverUrl){f.warning("请先填写服务器地址"),t&&(t.style.display="block");return}this.syncStatus.state="syncing",this.render(),await this.service.triggerSync(e),f.success(e==="standard"?"同步完成":"强制同步完成")}catch(t){console.error(t);let s="同步失败";t.message.includes("Failed to fetch")?s+=": 网络错误或证书未信任":s+=": "+t.message,f.error(s)}finally{await this.loadSyncConfig()}}confirmForceSync(e){const t=e==="force_push",s=t?"⚠️ 确认强制上传？":"⚠️ 确认强制下载？",n=t?"此操作将把<b>本地的所有文件</b>上传到服务器。<br>服务器上已存在的同名文件将被<b>直接覆盖</b>。":"此操作将从服务器下载所有文件。<br>本地已存在的同名文件将被<b>直接覆盖</b>。";R.confirm(s,n,async()=>{await this.handleSyncAction(e)})}bindButton(e,t){const s=this.container.querySelector(e);s&&this.addEventListener(s,"click",t)}getVal(e){return this.container.querySelector(e)?.value||""}async createSnapshot(){const e=this.container.querySelector("#btn-create-snapshot");e.disabled=!0,e.innerHTML="创建中...";try{await this.service.createSnapshot(),f.success("快照创建成功"),await this.loadSnapshots()}catch(t){f.error("创建失败"),console.error(t)}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-camera"></i> 创建快照'}}restoreSnapshot(e){R.confirm("确认恢复","<b>警告：此操作将覆盖当前所有数据！</b><br>系统将回滚到快照点的状态。建议先创建一个当前状态的快照。",async()=>{try{f.info("正在恢复..."),await this.service.restoreSnapshot(e),f.success("恢复成功，正在刷新..."),setTimeout(()=>window.location.reload(),1e3)}catch(t){f.error("恢复失败"),console.error(t)}})}async deleteSnapshot(e){if(confirm("确定删除此快照吗？"))try{await this.service.deleteSnapshot(e),f.success("已删除"),await this.loadSnapshots()}catch{f.error("删除失败")}}openExportModal(){const e=this.service.getAvailableSettingsKeys(),t=this.service.getAvailableWorkspaces(),s=e.map(o=>`
            <label class="settings-checkbox-row">
                <input type="checkbox" name="export-settings" value="${o}" checked>
                <span>${bt[o]||o}</span>
            </label>
        `).join(""),n=t.length>0?t.map(o=>`
                <label class="settings-checkbox-row">
                    <input type="checkbox" name="export-modules" value="${o.name}">
                    <div style="display:flex; flex-direction:column;">
                        <span>📂 ${o.name}</span>
                        <small style="color:#999; font-size:0.8em;">${o.description||"用户工作区"}</small>
                    </div>
                </label>
            `).join(""):'<div style="padding:10px; color:#999; font-style:italic;">无可用工作区</div>',i=`
            <div class="settings-export-modal-content" style="padding: 0 10px;">
                <div style="margin-bottom: 20px;">
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid var(--st-border-color); padding-bottom:5px;">⚙️ 系统配置</h4>
                    <div class="settings-checklist-grid">${s}</div>
                </div>
                <div>
                    <h4 style="margin:0 0 10px 0; border-bottom:1px solid var(--st-border-color); padding-bottom:5px;">📚 文档工作区</h4>
                    <div class="settings-checklist-grid">${n}</div>
                </div>
                <div style="margin-top:15px; text-align:right;">
                    <small class="settings-link-btn" onclick="document.querySelectorAll('.settings-checklist-grid input').forEach(c => c.checked = true)">全选</small>
                    <small class="settings-link-btn" onclick="document.querySelectorAll('.settings-checklist-grid input').forEach(c => c.checked = false)">全不选</small>
                </div>
            </div>
            <style>
                .settings-checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                .settings-checkbox-row { display: flex; align-items: center; gap: 8px; padding: 5px; cursor: pointer; border-radius: 4px; }
                .settings-checkbox-row:hover { background: var(--st-bg-tertiary); }
                .settings-link-btn { cursor: pointer; color: var(--st-color-primary); margin-left: 10px; }
                .settings-link-btn:hover { text-decoration: underline; }
            </style>
        `;new R("选择导出内容",i,{confirmText:"导出",onConfirm:async()=>{const o=document.querySelectorAll('input[name="export-settings"]:checked'),a=document.querySelectorAll('input[name="export-modules"]:checked'),r=Array.from(o).map(d=>d.value),c=Array.from(a).map(d=>d.value);if(r.length===0&&c.length===0)return f.warning("请至少选择一项内容"),!1;try{const d=await this.service.exportMixedData(r,c),h=new Date().toISOString().slice(0,10);this.downloadJson(d,`mindos-backup-${h}.json`),f.success(`导出完成: ${r.length} 项配置, ${c.length} 个工作区`)}catch(d){console.error(d),f.error("导出失败")}return!0}}).show()}triggerImportFlow(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const s=t.target.files[0];if(!s)return;const n=new FileReader;n.onload=async i=>{try{const o=JSON.parse(i.target.result);this.showImportSelectionModal(o)}catch{f.error("无法解析 JSON 文件")}},n.readAsText(s)},e.click()}showImportSelectionModal(e){const t=this.service.getAvailableSettingsKeys().filter(a=>e.settings&&Array.isArray(e.settings[a])||Array.isArray(e[a]));let s=[];if(e.modules&&Array.isArray(e.modules)&&(s=e.modules),t.length===0&&s.length===0){f.error("文件中未发现可识别的备份数据");return}const n=s.map(a=>{const r=a.module?.name||"Unknown";return["__vfs_meta__","__config"].includes(r)?"":`
            <label class="settings-checkbox-row">
                <input type="checkbox" name="import-modules" value="${r}">
                <div style="flex:1; display:flex; justify-content:space-between;">
                    <span>📂 ${r}</span>
                    <span class="settings-badge settings-badge--warning" style="font-size:0.7em; background:#fee2e2; color:#991b1b;">覆盖</span>
                </div>
            </label>`}).join(""),o=`
            <div class="settings-export-modal-content" style="padding: 0 5px;">
                
            <div style="background:var(--st-bg-tertiary); padding:10px; border-radius:6px; margin-bottom:15px; border-left:4px solid var(--st-color-primary);">
                <h4 style="margin:0 0 8px 0;">合并策略</h4>
                <label class="settings-checkbox-row" style="margin:0;">
                    <input type="checkbox" id="chk-overwrite-mode">
                    <div>
                        <span style="font-weight:bold;">覆盖现有文件 (Overwrite)</span>
                        <p style="margin:0; font-size:0.8em; color:var(--st-text-secondary);">
                            默认：仅添加新文件，合并元数据和标签。<br>
                            勾选：如果文件路径相同，强制用导入文件的内容覆盖本地内容。
                        </p>
                    </div>
                </label>
            </div>
        
                
                ${n?`
                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <h4 style="margin:0;">📚 选择要导入的模块</h4>
                        <div>
                            <small class="settings-link-btn" onclick="document.querySelectorAll('input[name=import-modules]').forEach(c=>c.checked=true)">全选</small>
                            <small class="settings-link-btn" onclick="document.querySelectorAll('input[name=import-modules]').forEach(c=>c.checked=false)">清空</small>
                        </div>
                    </div>
                    <div class="settings-checklist-grid">${n}</div>
                </div>`:""}

                ${t.length>0?`
                <div style="margin-top:20px;">
                    <h4 style="margin:0 0 5px 0;">⚙️ 系统配置</h4>
                    <p style="font-size:0.8em; color:var(--st-text-secondary);">配置项将始终合并/覆盖</p>
                    <div class="settings-checklist-grid">
                        ${t.map(a=>`<label class="settings-checkbox-row"><input type="checkbox" name="import-settings" value="${a}" checked><span>${bt[a]||a}</span></label>`).join("")}
                    </div>
                </div>`:""}
            </div>
            <style>.settings-checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }</style>
        `;new R("导入数据",o,{confirmText:"开始导入",onConfirm:async()=>{const a=document.querySelectorAll('input[name="import-settings"]:checked'),r=document.querySelectorAll('input[name="import-modules"]:checked'),c=document.querySelector("#chk-overwrite-mode"),d=Array.from(a).map(p=>p.value),h=Array.from(r).map(p=>p.value),u=c?c.checked:!1;if(d.length===0&&h.length===0)return f.warning("未选择任何内容"),!1;try{await this.service.importMixedData(e,d,h,{overwrite:u,mergeTags:!0}),f.success("导入成功，应用正在刷新..."),setTimeout(()=>window.location.reload(),1500)}catch(p){console.error(p),f.error("导入错误")}return!0}}).show()}resetApp(){R.confirm("⚠️ 恢复出厂设置","此操作将永久删除所有数据。",async()=>{try{await this.service.factoryReset(),f.success("数据已清除，正在重启..."),setTimeout(()=>window.location.reload(),1e3)}catch(e){console.error(e),f.error("重置失败")}})}downloadJson(e,t){const s=typeof e=="string"?e:JSON.stringify(e,null,2),n=new Blob([s],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=t,o.click(),URL.revokeObjectURL(i)}}class Uo extends le{render(){this.container.innerHTML=`
            <div class="settings-page">
                <div class="settings-about__header">
                    <div class="settings-about__logo">🤖</div>
                    <h1 class="settings-page__title">AI Workspace</h1>
                    <p class="settings-page__description">v1.0.0</p>
                </div>

                <div class="settings-about__grid">
                    <div class="settings-info-card">
                        <h3>技术栈</h3>
                        <ul class="settings-feature-list">
                            <li>TypeScript</li>
                            <li>VFS Core (IndexedDB)</li>
                            <li>Memory Manager</li>
                        </ul>
                    </div>
                    <div class="settings-info-card">
                        <h3>关于</h3>
                        <p class="settings-page__description">
                            这是一个完全本地化的 AI 工作区，所有数据存储在浏览器中。
                        </p>
                    </div>
                </div>
            </div>
        `}}const Ho=(l,e)=>async(t,s)=>{const n=s.nodeId;await l.init();let i=null;switch(n){case"storage":i=new Bo(t,l,s);break;case"tags":i=new Oo(t,l,s);break;case"contacts":i=new Fo(t,l,s);break;case"connections":i=new Do(t,e,s);break;case"mcp-servers":i=new $o(t,e,s);break;case"about":i=new Uo(t,l,s);break;default:return t.innerHTML='<div style="padding:2rem;text-align:center;color:#666">Select a setting category</div>',{init:async()=>{},destroy:async()=>{},getText:()=>"",setText:()=>{},focus:()=>{},getMode:()=>"render",switchToMode:async()=>{},setTitle:()=>{},setReadOnly:()=>{},isDirty:()=>!1,setDirty:()=>{},commands:{},getHeadings:async()=>[],getSearchableText:async()=>"",getSummary:async()=>null,search:async()=>[],gotoMatch:()=>{},clearSearch:()=>{},on:()=>()=>{},navigateTo:async()=>{}}}return i&&await i.init(t),i};async function zo(l,e){const t=new qi(l);await t.init();const s=new ji(t),n=Ho(t,e);return{service:t,engine:s,factory:n}}class us{getFactory(){return Oi}}class qo{constructor(e,t){this.factory=e,this.engine=t}getFactory(){return this.factory}getEngine(){return this.engine}}class jo{constructor(e,t){this.factory=e,this.engine=t}getEngine(){return this.engine}getFactory(){return this.factory}}class Vo extends us{}const Wo=JSON.stringify(ue,null,2),Go=JSON.stringify({version:1,sessions:[]},null,2),Jo=`### 挖空填词 (Cloze)

这是通过 \`cloze\` 插件启用的功能。在预览模式下，点击挖空部分即可显示/隐藏答案。
**控制面板**: 请留意屏幕右下角的浮动控制面板，支持 **切换摘要/详细视图**。

- **基本用法**: --太阳-- 是太阳系的中心。
- **带 ID**: [c1]--地球-- 是我们居住的行星。
- **带音频**: 法语单词 "你好" 的发音是 --Bonjour--^^audio:Bonjour^^。

** 多行与长文本支持 (使用 ¶ 换行) **:
MDxEditor 识别 \`¶\` 字符作为挖空内部的换行符。

**1. 短多行示例**:
--第一行内容¶第二行内容 (点击查看完整布局)--

**2. 长文本自动摘要示例**:
(在控制面板点击 <i class="fas fa-compress-alt"></i> 按钮可切换视图)

--Markdown 是一种轻量级标记语言，创始人为 John Gruber。¶它允许人们使用易读易写的纯文本格式编写文档，然后将其转换成有效的 XHTML (或者 HTML)。¶Markdown 的目标是实现"易读易写"。¶这份演示文档本身就是用 Markdown 编写的，展示了 MDxEditor 的强大渲染能力。--

** 表格内的挖空 **:
挖空功能完美集成在表格中，不破坏表格结构，且支持排序。

| 概念 | 定义 (点击查看) | 备注 |
| :--- | :--- | :--- |
| **HTML** | --超文本标记语言 (HyperText Markup Language)-- | 网页的基础结构 |
| **CSS** | --层叠样式表 (Cascading Style Sheets)-- | 用于样式设计 |
| **JS** | --JavaScript-- | 用于交互逻辑 |
`,Qo=`# Welcome to Your Prompt Library!

This is your personal space to create, manage, and reuse powerful prompts for Large Language Models (LLMs).

## What is a Prompt?

A prompt is a piece of text that you provide to an AI model to get a specific response. A well-crafted prompt can dramatically improve the quality of the output.

## How to Use This Space

*   **Create a New Prompt**: Click the '+' icon in the sidebar to create a new prompt file.
*   **Organize**: Use folders to group related prompts, such as 'Marketing', 'Coding', or 'Creative Writing'.
*   **Use Variables**: You can use placeholders like \`{{variable_name}}\` in your prompts, which you can replace later.

### Example Prompt

\`\`\`markdown
Translate the following English text to French:

"{{text_to_translate}}"
\`\`\`
`,Ko=`# Manage Your Projects

This workspace helps you organize all your project-related documents, notes, and plans.

## Recommended Structure

We suggest creating a folder for each project. Inside each project folder, you could have files like:

*   **Goals.md**: High-level objectives and desired outcomes.
*   **Tasks.md**: A checklist of tasks to be completed.
*   **Meeting Notes**: A folder to store notes from project meetings.
*   **Research.md**: Links, summaries, and important findings.

Start by creating your first project folder using the folder icon in the sidebar!
`,Yo=`# Email Drafts & Templates

Draft your important emails here before sending them. You can also create reusable templates to save time.

## Example Template: Follow-up Email

\`\`\`markdown
**Subject: Following up on our conversation**

Hi {{contact_name}},

It was great speaking with you earlier today about {{topic}}.

I've attached the [document/link] we discussed. Please let me know if you have any questions.

Best regards,

[Your Name]
\`\`\`
`,Xo=`# Your Private Notes

This is a secure and private space for your thoughts, ideas, and personal reminders.

Anything you write here is stored locally in your browser and is not sent to any server.

Feel free to jot down anything that comes to mind!
`,wt={markdown:{id:"markdown",label:"Note",extension:".md",defaultFileName:"Untitled.md",defaultContent:"",editorType:"standard"},anki:{id:"anki",label:"Card",extension:".anki",defaultFileName:"New Card.anki",defaultContent:Jo,editorType:"standard"},agent:{id:"agent",label:"Agent",extension:".agent",icon:"🤖",defaultFileName:"New Assistant.agent",defaultContent:Wo,editorType:"agent"},chat:{id:"chat",label:"Chat",extension:".chat",icon:"💬",defaultFileName:"New Session.chat",defaultContent:Go,editorType:"chat"},prompt:{id:"prompt",label:"Prompt",extension:".prompt",defaultFileName:"New Prompt.md",defaultContent:Qo,editorType:"standard"},project:{id:"project",label:"Project",extension:".prj",defaultFileName:"New Project.md",defaultContent:Ko,editorType:"standard"},email:{id:"email",label:"Email",extension:".email",defaultFileName:"Draft.md",defaultContent:Yo,editorType:"standard"},private:{id:"private",label:"Note",extension:".private",defaultFileName:"My Private Note.md",defaultContent:Xo,editorType:"standard"}},We={chat:"llm-workspace",settings:"settings-workspace",agents:"agent-workspace"},Zo=Object.entries(We).reduce((l,[e,t])=>(l[t]=e,l),{}),Ee=new Map;async function ea(){try{const l=await zi(),e=new ko(l),t=new Co(l);await No({agentService:e,sessionEngine:t,maxConcurrent:4});const s=await zo(l,e),n=Ro(e),i=Po(e),o={standard:new us,agent:new Vo,settings:new qo(s.factory,s.engine),chat:new jo(n,t)},r={standard:o.standard.getFactory(),agent:i,chat:n},c=g=>{const y=wt[g];if(!y)return console.warn(`File type definition not found for id: ${g}`),null;let b;y.editorType!=="standard"&&(b=r[y.editorType]);const E=y.id==="chat"?Mo:void 0;return{extensions:[y.extension],icon:y.icon,editorFactory:b,contentParser:E}},d=(g,y,b="push")=>{const E=Zo[g]||"home",k=y?`#/${E}/${y}`:`#/${E}`;location.hash!==k&&(b==="push"?history.pushState({workspaceId:g,resourceId:y},"",k):history.replaceState({workspaceId:g,resourceId:y},"",k))},h=()=>{const g=location.hash.slice(2).split("/"),y=g[0]||"chat",b=g[1]?decodeURIComponent(g[1]):void 0;return{workspace:We[y]||"llm-workspace",resource:b}},u=async g=>{if(Ee.has(g))return Ee.get(g);const y=document.getElementById(g),b=as.find(O=>O.elementId===g);if(!y||!b)return;const E=b.type||"standard",k=o[E]||o.standard,{moduleName:F,plugins:B,mentionScope:v,aiEnabled:L,supportedFileTypes:S,...D}=b,P=(S||[]).map(O=>c(O)).filter(O=>!!O),U=S?.[0],q=U?wt[U]:void 0,K={...D,createFileLabel:q?.label||"File",defaultFileName:q?.defaultFileName,defaultExtension:q?.extension,defaultFileContent:q?.defaultContent,contextMenu:{items:(O,V)=>D.readOnly?[]:V}},j=new Hi({container:y,customEngine:k.getEngine?.(F),moduleName:F,editorFactory:k.getFactory(),scopeId:g,fileTypes:P,uiOptions:K,editorConfig:{plugins:B||[],readOnly:!1,mentionScope:v},aiConfig:{enabled:L??!0},onNavigate:async O=>{const V=We[O.target]||O.target;d(V,O.resourceId||null,"push"),await p(V,O.resourceId)},onSessionChange:O=>{d(g,O,"replace")}});return await j.start(),Ee.set(g,j),j},p=async(g,y)=>{console.log(`[Router] Navigating to: ${g} -> ${y||"(root)"}`),document.querySelectorAll(".workspace-view").forEach(E=>{E.classList.toggle("active",E.id===g)}),document.querySelectorAll(".app-nav-btn").forEach(E=>{const k=E.dataset.target;E.classList.toggle("active",k===g)});const b=await u(g);b&&y&&setTimeout(()=>{b.openFile(y)},10)};window.addEventListener("popstate",g=>{const y=g.state;if(y)p(y.workspaceId,y.resourceId);else{const b=h();p(b.workspace,b.resource)}}),document.querySelectorAll(".app-nav-btn").forEach(g=>{g.addEventListener("click",y=>{y.preventDefault();const b=y.currentTarget.dataset.target;if(b){const k=Ee.get(b)?.getActiveSessionId()||null;d(b,k,"push"),p(b,k||void 0)}})});const m=h();await p(m.workspace,m.resource),d(m.workspace,m.resource||null,"replace")}catch(l){console.error("Failed to bootstrap application:",l)}}ea();
